     process</a>. All the <a href=#concept-appcache-master id=appcache:concept-appcache-master>master entries</a> have the
     <a href=#same-origin id=appcache:same-origin>same origin</a> as the manifest.</p>


     <dt><dfn id=concept-appcache-explicit>Explicit entries</dfn>

     <dd><p class=note>These are the resources that were listed in the cache's <a href=#concept-appcache-manifest id=appcache:concept-appcache-manifest>manifest</a> in an <a href=#concept-appcache-manifest-explicit id=appcache:concept-appcache-manifest-explicit>explicit section</a>.</p>


     <dt><dfn id=concept-appcache-fallback>Fallback entries</dfn>

     <dd><p class=note>These are the resources that were listed in the cache's <a href=#concept-appcache-manifest id=appcache:concept-appcache-manifest-2>manifest</a> in a <a href=#concept-appcache-manifest-fallback id=appcache:concept-appcache-manifest-fallback>fallback section</a>.</p>


    </dl>

    <p><a href=#concept-appcache-explicit id=appcache:concept-appcache-explicit>Explicit entries</a> and <a href=#concept-appcache-fallback id=appcache:concept-appcache-fallback>Fallback entries</a> can be marked as <dfn id=concept-appcache-foreign>foreign</dfn>, which means that they have a <code id=appcache:attr-html-manifest-3><a href=#attr-html-manifest>manifest</a></code> attribute but that it doesn't point at this cache's
    <a href=#concept-appcache-manifest id=appcache:concept-appcache-manifest-3>manifest</a>.</p>

    <p class=note>A URL in the list can be flagged with multiple different types, and thus an
    entry can end up being categorized as multiple entries. For example, an entry can be a manifest
    entry and an explicit entry at the same time, if the manifest is listed within the manifest.</p>

   <li>

    <p>Zero or more <dfn id=concept-appcache-fallback-ns>fallback namespaces</dfn>, each of
    which is mapped to a <a href=#concept-appcache-fallback id=appcache:concept-appcache-fallback-2>fallback entry</a>.</p>

    <p class=note>These are URLs used as <a href=#concept-appcache-matches-fallback id=appcache:concept-appcache-matches-fallback>prefix
    match patterns</a> for resources that are to be fetched from the network if possible, or to
    be replaced by the corresponding <a href=#concept-appcache-fallback id=appcache:concept-appcache-fallback-3>fallback entry</a>
    if not. Each namespace URL has the <a href=#same-origin id=appcache:same-origin-2>same origin</a> as <a href=#concept-appcache-manifest id=appcache:concept-appcache-manifest-4>the manifest</a>.</p>

   <li>

    <p>Zero or more URLs that form the <dfn id=concept-appcache-onlinesafelist>online
    safelist namespaces</dfn>.</p>

    <p class=note>These are used as prefix match patterns, and declare URLs for which the user
    agent will ignore the application cache, instead fetching them normally (i.e. from the network
    or local HTTP cache as appropriate).</p>

   <li>

    <p>An <dfn id=concept-appcache-onlinesafelist-wildcard>online safelist wildcard
    flag</dfn>, which is either <i>open</i> or <i>blocking</i>.</p>

    <p class=note>The <i>open</i> state indicates that any URL not listed as cached is to
    be implicitly treated as being in the <a href=#concept-appcache-onlinesafelist id=appcache:concept-appcache-onlinesafelist>online
    safelist namespaces</a>; the <i>blocking</i> state indicates that URLs not listed
    explicitly in the manifest are to be treated as unavailable.</p>

   <li>

    <p>A <dfn id=concept-appcache-mode>cache mode flag</dfn>, which is either in the <dfn id=concept-appcache-mode-fast><i>fast</i></dfn> state or the <dfn id=concept-appcache-mode-prefer-online><i>prefer-online</i></dfn> state.</p>

   </ul>

  <p>Each <a href=#application-cache id=appcache:application-cache>application cache</a> has a <dfn id=concept-appcache-completeness>completeness flag</dfn>, which is either <i>complete</i> or
  <i>incomplete</i>.</p>

  <hr>

  <p>An <dfn id=application-cache-group>application cache group</dfn> is a group of <a href=#application-cache id=appcache:application-cache-2>application
  caches</a>, identified by the <a id=appcache:absolute-url href=https://url.spec.whatwg.org/#syntax-url-absolute data-x-internal=absolute-url>absolute URL</a> of a resource <a href=#concept-appcache-manifest id=appcache:concept-appcache-manifest-5>manifest</a> which is used to populate the caches in the
  group.</p>

  <p>An <a href=#application-cache id=appcache:application-cache-3>application cache</a> is <dfn id=concept-appcache-newer>newer</dfn> than
  another if it was created after the other (in other words, <a href=#application-cache id=appcache:application-cache-4>application caches</a> in an <a href=#application-cache-group id=appcache:application-cache-group>application cache group</a> have a chronological
  order).</p>

  <p>Only the newest <a href=#application-cache id=appcache:application-cache-5>application cache</a> in an <a href=#application-cache-group id=appcache:application-cache-group-2>application cache group</a> can
  have its <a href=#concept-appcache-completeness id=appcache:concept-appcache-completeness>completeness flag</a> set to
  <i>incomplete</i>; the others are always all <i>complete</i>.</p>

  <p>Each <a href=#application-cache-group id=appcache:application-cache-group-3>application cache group</a> has an <dfn id=concept-appcache-status>update
  status</dfn>, which is one of the following: <i>idle</i>, <i>checking</i>, <i>downloading</i>.</p>

  <p>A <dfn id=relevant-application-cache>relevant application cache</dfn> is an <a href=#application-cache id=appcache:application-cache-6>application cache</a> that is the <a href=#concept-appcache-newer id=appcache:concept-appcache-newer>newest</a> in its <a href=#application-cache-group id=appcache:application-cache-group-4>group</a> to be <i>complete</i>.</p>

  <p>Each <a href=#application-cache-group id=appcache:application-cache-group-5>application cache group</a> has a <dfn id=concept-appcache-pending-masters>list of pending master entries</dfn>. Each entry in this
  list consists of a resource and a corresponding <code id=appcache:document><a href=#document>Document</a></code> object. It is used during
  the <a href=#application-cache-download-process id=appcache:application-cache-download-process-2>application cache download process</a> to ensure that new master entries are cached
  even if the <a href=#application-cache-download-process id=appcache:application-cache-download-process-3>application cache download process</a> was already running for their
  <a href=#application-cache-group id=appcache:application-cache-group-6>application cache group</a> when they were loaded.</p>

  <p>An <a href=#application-cache-group id=appcache:application-cache-group-7>application cache group</a> can be marked as <dfn id=concept-appcache-obsolete>obsolete</dfn>, meaning that it must be ignored when looking at
  what <a href=#application-cache-group id=appcache:application-cache-group-8>application cache groups</a> exist.</p>

  <hr>

  <p>A <dfn id=cache-host>cache host</dfn> is a <code id=appcache:document-2><a href=#document>Document</a></code> or a <code id=appcache:sharedworkerglobalscope><a href=#sharedworkerglobalscope>SharedWorkerGlobalScope</a></code>
  object. A <a href=#cache-host id=appcache:cache-host>cache host</a> can be associated with an <a href=#application-cache id=appcache:application-cache-7>application cache</a>.</p>

  <p>A <code id=appcache:document-3><a href=#document>Document</a></code> initially is not associated with an <a href=#application-cache id=appcache:application-cache-8>application cache</a>, but
  can become associated with one early during the page load process, when steps <a href=#parser-appcache>in the parser</a> and in the <a href=#navigate id=appcache:navigate-2>navigation</a>
  sections cause <a href=#concept-appcache-init id=appcache:concept-appcache-init>cache selection</a> to occur.</p>

  <p>A <code id=appcache:sharedworkerglobalscope-2><a href=#sharedworkerglobalscope>SharedWorkerGlobalScope</a></code> can be associated with an <a href=#application-cache id=appcache:application-cache-9>application cache</a>
  when it is created.</p>

  <p>Each <a href=#cache-host id=appcache:cache-host-2>cache host</a> has an associated <code id=appcache:applicationcache><a href=#applicationcache>ApplicationCache</a></code> object.</p>

  <hr>

  <p>Multiple <a href=#application-cache id=appcache:application-cache-10>application caches</a> in different <a href=#application-cache-group id=appcache:application-cache-group-9>application cache groups</a> can contain the same resource,
  e.g. if the manifests all reference that resource. If the user agent is to <dfn id=concept-appcache-selection>select an application cache</dfn> from a list of <a href=#relevant-application-cache id=appcache:relevant-application-cache>relevant application caches</a> that contain a resource, the
  user agent must use the application cache that the user most likely wants to see the resource
  from, taking into account the following:</p>

  <ul><li>which application cache was most recently updated,

   <li>which application cache was being used to display the resource from which the user decided to
   look at the new resource, and

   <li>which application cache the user prefers.

  </ul>

  <hr>

  <p>A URL <dfn id=concept-appcache-matches-fallback>matches a fallback namespace</dfn> if
  there exists a <a href=#relevant-application-cache id=appcache:relevant-application-cache-2>relevant application cache</a> whose <a href=#concept-appcache-manifest id=appcache:concept-appcache-manifest-6>manifest</a>'s URL has the <a href=#same-origin id=appcache:same-origin-3>same origin</a> as the
  URL in question, and that has a <a href=#concept-appcache-fallback-ns id=appcache:concept-appcache-fallback-ns>fallback
  namespace</a> that is a <a href=#prefix-match id=appcache:prefix-match>prefix match</a> for the URL being examined. If multiple
  fallback namespaces match the same URL, the longest one is the one that matches. A URL looking for
  a fallback namespace can match more than one application cache at a time, but only matches one
  namespace in each cache.</p>

  <div class=example>

   <p>If a manifest <code>https://example.com/app1/manifest</code> declares that <code>https://example.com/resources/images</code> is a fallback namespace, and the user
   navigates to <code>https://example.com:80/resources/images/cat.png</code>, then the user
   agent will decide that the application cache identified by <code>https://example.com/app1/manifest</code> contains a namespace with a match for that
   URL.</p>

   

  </div>

  



  <h4 id=manifests>7.9.3 The cache manifest syntax<a href=#manifests class=self-link></a></h4>


  <h5 id=some-sample-manifests>7.9.3.1 Some sample manifests<a href=#some-sample-manifests class=self-link></a></h5>

  <p><i>This section is non-normative.</i></p>

  <div class=example>

   <p>This example manifest requires two images and a style sheet to be cached and safelists a CGI
   script.</p>

   <pre>CACHE MANIFEST
# the above line is required

# this is a comment
# there can be as many of these anywhere in the file
# they are all ignored
  # comments can have spaces before them
  # but must be alone on the line

# blank lines are ignored too

# these are files that need to be cached they can either be listed
# first, or a "CACHE:" header could be put before them, as is done
# lower down.
images/sound-icon.png
images/background.png
# note that each file has to be put on its own line

# here is a file for the online safelist -- it isn't cached, and
# references to this file will bypass the cache, always hitting the
# network (or trying to, if the user is offline).
NETWORK:
comm.cgi

# here is another set of files to cache, this time just the CSS file.
CACHE:
style/default.css</pre>

   <p>It could equally well be written as follows:</p>

   <pre>CACHE MANIFEST
NETWORK:
comm.cgi
CACHE:
style/default.css
images/sound-icon.png
images/background.png</pre>

  </div>

  <div class=example>

   <p>Offline application cache manifests can use absolute paths or even absolute URLs:</p>

   <pre>CACHE MANIFEST

/main/home
/main/app.js
/settings/home
/settings/app.js
https://img.example.com/logo.png
https://img.example.com/check.png
https://img.example.com/cross.png</pre>

  </div>

  <div class=example>

   <p>The following manifest defines a catch-all error page that is displayed for any page on the
   site while the user is offline. It also specifies that the <a href=#concept-appcache-onlinesafelist-wildcard id=some-sample-manifests:concept-appcache-onlinesafelist-wildcard>online safelist wildcard flag</a> is <i>open</i>, meaning that accesses to resources on other sites will not be blocked.
   (Resources on the same site are already not blocked because of the catch-all fallback
   namespace.)</p>

   <p>So long as all pages on the site reference this manifest, they will get cached locally as they
   are fetched, so that subsequent hits to the same page will load the page immediately from the
   cache. Until the manifest is changed, those pages will not be fetched from the server again. When
   the manifest changes, then all the files will be redownloaded.</p>

   <p>Subresources, such as style sheets, images, etc, would only be cached using the regular HTTP
   caching semantics, however.</p>

   <pre>CACHE MANIFEST
FALLBACK:
/ /offline.html
NETWORK:
*</pre>

  </div>



  <h5 id=writing-cache-manifests>7.9.3.2 Writing cache manifests<a href=#writing-cache-manifests class=self-link></a></h5>

  <p>Manifests must be served using the <code id=writing-cache-manifests:text/cache-manifest><a href=#text/cache-manifest>text/cache-manifest</a></code> <a id=writing-cache-manifests:mime-type href=https://mimesniff.spec.whatwg.org/#mime-type data-x-internal=mime-type>MIME type</a>. All
  resources served using the <code id=writing-cache-manifests:text/cache-manifest-2><a href=#text/cache-manifest>text/cache-manifest</a></code> <a id=writing-cache-manifests:mime-type-2 href=https://mimesniff.spec.whatwg.org/#mime-type data-x-internal=mime-type>MIME type</a> must follow the
  syntax of application cache manifests, as described in this section.</p>

  <p>An application cache manifest is a text file, whose text is encoded using UTF-8. Data in
  application cache manifests is line-based. Newlines must be represented by U+000A LINE FEED (LF)
  characters, U+000D CARRIAGE RETURN (CR) characters, or U+000D CARRIAGE RETURN (CR) U+000A LINE
  FEED (LF) pairs. <a href=#refsENCODING>[ENCODING]</a></p>

  <p class=note>This is a <a href=#willful-violation id=writing-cache-manifests:willful-violation>willful violation</a> of RFC 2046, which requires all <code>text/*</code> types to only allow CRLF line breaks. This requirement, however, is
  outdated; the use of CR, LF, and CRLF line breaks is commonly supported and indeed sometimes CRLF
  is <em>not</em> supported by text editors. <a href=#refsRFC2046>[RFC2046]</a></p>

  <p>The first line of an application cache manifest must consist of the string "CACHE", a single
  U+0020 SPACE character, the string "MANIFEST", and either a U+0020 SPACE character, a U+0009
  CHARACTER TABULATION (tab) character, a U+000A LINE FEED (LF) character, or a U+000D CARRIAGE
  RETURN (CR) character. The first line may optionally be preceded by a U+FEFF BYTE ORDER MARK (BOM)
  character. If any other text is found on the first line, it is ignored.</p>

  <p>Subsequent lines, if any, must all be one of the following:</p>

  <dl><dt>A blank line
   <dd>
    <p>Blank lines must consist of zero or more U+0020 SPACE and
    U+0009 CHARACTER TABULATION (tab) characters only.</p>

   <dt>A comment
   <dd>
    <p>Comment lines must consist of zero or more U+0020 SPACE and U+0009 CHARACTER TABULATION (tab)
    characters, followed by a single U+0023 NUMBER SIGN character (#), followed by zero or more
    characters other than U+000A LINE FEED (LF) and U+000D CARRIAGE RETURN (CR) characters.</p>

    <p class=note>Comments must be on a line on their own. If they were to be included on a line
    with a URL, the "#" would be mistaken for part of a <a href=https://url.spec.whatwg.org/#concept-url-fragment id=writing-cache-manifests:concept-url-fragment data-x-internal=concept-url-fragment>fragment</a>.</p>

   <dt>A section header
   <dd>

    <p>Section headers change the current section. There are four possible section headers:

    <dl><dt><code>CACHE:</code>
     <dd>Switches to the <dfn id=concept-appcache-manifest-explicit>explicit section</dfn>.

     <dt><code>FALLBACK:</code>
     <dd>Switches to the <dfn id=concept-appcache-manifest-fallback>fallback section</dfn>.

     <dt><code>NETWORK:</code>
     <dd>Switches to the <dfn id=concept-appcache-manifest-network>online safelist section</dfn>.

     <dt><code>SETTINGS:</code>
     <dd>Switches to the <dfn id=concept-appcache-manifest-settings>settings section</dfn>.

    </dl>

    <p>Section header lines must consist of zero or more U+0020 SPACE and U+0009 CHARACTER
    TABULATION (tab) characters, followed by one of the names above (including the U+003A COLON
    character (:)) followed by zero or more U+0020 SPACE and U+0009 CHARACTER TABULATION (tab)
    characters.</p>

    <p>Ironically, by default, the current section is the <a href=#concept-appcache-manifest-explicit id=writing-cache-manifests:concept-appcache-manifest-explicit>explicit section</a>.</p>

   <dt>Data for the current section
   <dd>

    <p>The format that data lines must take depends on the current section.</p>

    <p>When the current section is the <a href=#concept-appcache-manifest-explicit id=writing-cache-manifests:concept-appcache-manifest-explicit-2>explicit
    section</a>, data lines must consist of zero or more U+0020 SPACE and U+0009 CHARACTER
    TABULATION (tab) characters, a <a href=#valid-url id=writing-cache-manifests:valid-url>valid URL</a> identifying a resource other than the
    manifest itself, and then zero or more U+0020 SPACE and U+0009 CHARACTER TABULATION (tab)
    characters.</p>

    <p>When the current section is the <a href=#concept-appcache-manifest-fallback id=writing-cache-manifests:concept-appcache-manifest-fallback>fallback
    section</a>, data lines must consist of zero or more U+0020 SPACE and U+0009 CHARACTER
    TABULATION (tab) characters, a <a href=#valid-url id=writing-cache-manifests:valid-url-2>valid URL</a> identifying a resource other than the
    manifest itself, one or more U+0020 SPACE and U+0009 CHARACTER TABULATION (tab) characters,
    another <a href=#valid-url id=writing-cache-manifests:valid-url-3>valid URL</a> identifying a resource other than the manifest itself, and then
    zero or more U+0020 SPACE and U+0009 CHARACTER TABULATION (tab) characters.</p>

    <p>When the current section is the <a href=#concept-appcache-manifest-network id=writing-cache-manifests:concept-appcache-manifest-network>online
    safelist section</a>, data lines must consist of zero or more U+0020 SPACE and U+0009
    CHARACTER TABULATION (tab) characters, either a single U+002A ASTERISK character (*)  or a <a href=#valid-url id=writing-cache-manifests:valid-url-4>valid URL</a> identifying a resource
    other than the manifest itself, and then zero or more U+0020 SPACE and U+0009 CHARACTER
    TABULATION (tab) characters.</p>

    <p>When the current section is the <a href=#concept-appcache-manifest-settings id=writing-cache-manifests:concept-appcache-manifest-settings>settings
    section</a>, data lines must consist of zero or more U+0020 SPACE and U+0009 CHARACTER
    TABULATION (tab) characters, a <a href=#concept-appcache-manifest-setting id=writing-cache-manifests:concept-appcache-manifest-setting>setting</a>,
    and then zero or more U+0020 SPACE and U+0009 CHARACTER TABULATION (tab) characters.</p>

    <p>Currently only one <dfn id=concept-appcache-manifest-setting>setting</dfn> is
    defined:</p>

    <dl><dt>The cache mode setting<dd>This consists of the string "<code>prefer-online</code>". It sets the <a href=#concept-appcache-mode id=writing-cache-manifests:concept-appcache-mode>cache mode</a> to <a href=#concept-appcache-mode-prefer-online id=writing-cache-manifests:concept-appcache-mode-prefer-online>prefer-online</a>. (The <a href=#concept-appcache-mode id=writing-cache-manifests:concept-appcache-mode-2>cache mode</a> defaults to <a href=#concept-appcache-mode-fast id=writing-cache-manifests:concept-appcache-mode-fast>fast</a>.)</dl>

    <p>Within a <a href=#concept-appcache-manifest-settings id=writing-cache-manifests:concept-appcache-manifest-settings-2>settings section</a>, each <a href=#concept-appcache-manifest-setting id=writing-cache-manifests:concept-appcache-manifest-setting-2>setting</a> must occur no more than once.</p>



  </dl>

  <p>Manifests may contain sections more than once. Sections may be empty.</p>

  <p>URLs that are to be fallback pages associated with <a href=#concept-appcache-fallback-ns id=writing-cache-manifests:concept-appcache-fallback-ns>fallback namespaces</a>, and those namespaces themselves,
  must be given in <a href=#concept-appcache-manifest-fallback id=writing-cache-manifests:concept-appcache-manifest-fallback-2>fallback sections</a>, with
  the namespace being the first URL of the data line, and the corresponding fallback page being the
  second URL. All the other pages to be cached must be listed in <a href=#concept-appcache-manifest-explicit id=writing-cache-manifests:concept-appcache-manifest-explicit-3>explicit sections</a>.</p>

  <p><a href=#concept-appcache-fallback-ns id=writing-cache-manifests:concept-appcache-fallback-ns-2>Fallback namespaces</a> and <a href=#concept-appcache-fallback id=writing-cache-manifests:concept-appcache-fallback>fallback entries</a> must have the <a href=#same-origin id=writing-cache-manifests:same-origin>same origin</a>
  as the manifest itself. <a href=#concept-appcache-fallback-ns id=writing-cache-manifests:concept-appcache-fallback-ns-3>Fallback namespaces</a>
  must also be in the same path as the manifest's URL.</p>

  <p>A <a href=#concept-appcache-fallback-ns id=writing-cache-manifests:concept-appcache-fallback-ns-4>fallback namespace</a> must not be listed more
  than once.</p>

  <p>Namespaces that the user agent is to put into the <a href=#concept-appcache-onlinesafelist id=writing-cache-manifests:concept-appcache-onlinesafelist>online safelist</a> must all be specified in <a href=#concept-appcache-manifest-network id=writing-cache-manifests:concept-appcache-manifest-network-2>online safelist sections</a>. (This is needed for
  any URL that the page is intending to use to communicate back to the server.) To specify that all
  URLs are automatically safelisted in this way, a U+002A ASTERISK character (*) may be specified
  as one of the URLs. </p>

  <p>Authors should not include namespaces in the <a href=#concept-appcache-onlinesafelist id=writing-cache-manifests:concept-appcache-onlinesafelist-2>online safelist</a> for which another namespace in
  the <a href=#concept-appcache-onlinesafelist id=writing-cache-manifests:concept-appcache-onlinesafelist-3>online safelist</a> is a <a href=#prefix-match id=writing-cache-manifests:prefix-match>prefix
  match</a>.</p>

  <p><a href=https://url.spec.whatwg.org/#syntax-url-relative id=writing-cache-manifests:relative-url data-x-internal=relative-url>Relative URLs</a> must be given relative to the manifest's own
  URL. All URLs in the manifest must have the same <a href=https://url.spec.whatwg.org/#concept-url-scheme id=writing-cache-manifests:concept-url-scheme data-x-internal=concept-url-scheme>scheme</a> as
  the manifest itself (either explicitly or implicitly, through the use of <a href=https://url.spec.whatwg.org/#syntax-url-relative id=writing-cache-manifests:relative-url-2 data-x-internal=relative-url>relative URLs</a>). <a href=#refsURL>[URL]</a></p>

  <p>URLs in manifests must not have <a href=https://url.spec.whatwg.org/#concept-url-fragment id=writing-cache-manifests:concept-url-fragment-2 data-x-internal=concept-url-fragment>fragments</a> (i.e. the
  U+0023 NUMBER SIGN character isn't allowed in URLs in manifests).</p>

  <p><a href=#concept-appcache-fallback-ns id=writing-cache-manifests:concept-appcache-fallback-ns-5>Fallback namespaces</a> and namespaces in the
  <a href=#concept-appcache-onlinesafelist id=writing-cache-manifests:concept-appcache-onlinesafelist-4>online safelist</a> are matched by <a href=#prefix-match id=writing-cache-manifests:prefix-match-2>prefix
  match</a>.</p>


  

  <h5 id=parsing-cache-manifests>7.9.3.3 Parsing cache manifests<a href=#parsing-cache-manifests class=self-link></a></h5>

  <p>When a user agent is to <dfn id=parse-a-manifest>parse a manifest</dfn>, it means that the user agent must run the
  following steps:</p>

  <ol><li>

    <p><a id=parsing-cache-manifests:utf-8-decode href=https://encoding.spec.whatwg.org/#utf-8-decode data-x-internal=utf-8-decode>UTF-8 decode</a> the byte stream corresponding with the manifest to be parsed.</p>

    <p class=note>The <a id=parsing-cache-manifests:utf-8-decode-2 href=https://encoding.spec.whatwg.org/#utf-8-decode data-x-internal=utf-8-decode>UTF-8 decode</a> algorithm strips a leading BOM, if any.</p>

    

   <li><p>Let <var>base URL</var> be the <a id=parsing-cache-manifests:absolute-url href=https://url.spec.whatwg.org/#syntax-url-absolute data-x-internal=absolute-url>absolute URL</a> representing the
   manifest.<li><p>Apply the <a id=parsing-cache-manifests:url-parser href=https://url.spec.whatwg.org/#concept-url-parser data-x-internal=url-parser>URL parser</a> to <var>base URL</var>, and let <var>manifest path</var>
   be the <a href=https://url.spec.whatwg.org/#concept-url-path id=parsing-cache-manifests:concept-url-path data-x-internal=concept-url-path>path</a> component thus obtained.<li><p>Remove all the characters in <var>manifest path</var> after the last U+002F SOLIDUS
   character (/), if any. (The first character and the last character in <var>manifest path</var>
   after this step will both be slashes, the URL path separator character.)<li><p>Apply the <a id=parsing-cache-manifests:url-parser-2 href=https://url.spec.whatwg.org/#concept-url-parser data-x-internal=url-parser>URL parser</a> steps to the <var>base URL</var>, so that the
   components from its <a id=parsing-cache-manifests:url-record href=https://url.spec.whatwg.org/#concept-url data-x-internal=url-record>URL record</a> can be used by the subsequent steps of this
   algorithm.<li><p>Let <var>explicit URLs</var> be an initially empty list of <a href=https://url.spec.whatwg.org/#syntax-url-absolute id=parsing-cache-manifests:absolute-url-2 data-x-internal=absolute-url>absolute URLs</a> for <a href=#concept-appcache-explicit id=parsing-cache-manifests:concept-appcache-explicit>explicit
   entries</a>.<li><p>Let <var>fallback URLs</var> be an initially empty mapping of <a href=#concept-appcache-fallback-ns id=parsing-cache-manifests:concept-appcache-fallback-ns>fallback namespaces</a> to <a href=https://url.spec.whatwg.org/#syntax-url-absolute id=parsing-cache-manifests:absolute-url-3 data-x-internal=absolute-url>absolute URLs</a> for <a href=#concept-appcache-fallback id=parsing-cache-manifests:concept-appcache-fallback>fallback
   entries</a>.<li><p>Let <var>online safelist namespaces</var> be an initially empty list of <a href=https://url.spec.whatwg.org/#syntax-url-absolute id=parsing-cache-manifests:absolute-url-4 data-x-internal=absolute-url>absolute URLs</a> for an <a href=#concept-appcache-onlinesafelist id=parsing-cache-manifests:concept-appcache-onlinesafelist>online safelist</a>.<li><p>Let <var>online safelist wildcard flag</var> be <i>blocking</i>. <li><p>Let <var>cache mode flag</var> be <i>fast</i>. <li><p>Let <var>input</var> be the decoded text of the manifest's byte stream.<li><p>Let <var>position</var> be a pointer into <var>input</var>, initially
   pointing at the first character.<li><p>If the characters starting from <var>position</var> are "CACHE", followed by a
   U+0020 SPACE character, followed by "MANIFEST", then advance <var>position</var> to the
   next character after those. Otherwise, this isn't a cache manifest; abort this algorithm with a
   failure while checking for the magic signature.<li><p>If the character at <var>position</var> is neither a U+0020 SPACE character, a
   U+0009 CHARACTER TABULATION (tab) character, U+000A LINE FEED (LF) character, nor a U+000D
   CARRIAGE RETURN (CR) character, then this isn't a cache manifest; abort this algorithm with a
   failure while checking for the magic signature.<li><p>This is a cache manifest. The algorithm cannot fail beyond
   this point (though bogus lines can get ignored).<li><p><a href=#collect-a-sequence-of-characters id=parsing-cache-manifests:collect-a-sequence-of-characters>Collect a sequence of characters</a> that are <em>not</em> U+000A LINE FEED (LF)
   or U+000D CARRIAGE RETURN (CR) characters, and ignore those characters. (Extra text on the first
   line, after the signature, is ignored.)<li><p>Let <var>mode</var> be "explicit".<li><p><i>Start of line</i>: If <var>position</var> is past the end of <var>input</var>, then jump to the last step. Otherwise, <a href=#collect-a-sequence-of-characters id=parsing-cache-manifests:collect-a-sequence-of-characters-2>collect a sequence of
   characters</a> that are U+000A LINE FEED (LF), U+000D CARRIAGE RETURN (CR), U+0020 SPACE, or
   U+0009 CHARACTER TABULATION (tab) characters.<li><p>Now, <a href=#collect-a-sequence-of-characters id=parsing-cache-manifests:collect-a-sequence-of-characters-3>collect a sequence of characters</a> that are <em>not</em> U+000A LINE FEED
   (LF) or U+000D CARRIAGE RETURN (CR) characters, and let the result be <var>line</var>.<li><p>Drop any trailing U+0020 SPACE and U+0009 CHARACTER TABULATION (tab) characters at the end
   of <var>line</var>.<li><p>If <var>line</var> is the empty string, then jump back to the step labeled <i>start
   of line</i>.<li><p>If the first character in <var>line</var> is a U+0023 NUMBER SIGN character (#),
   then jump back to the step labeled <i>start of line</i>.<li><p>If <var>line</var> equals "CACHE:" (the word "CACHE" followed by a U+003A COLON
   character (:)), then set <var>mode</var> to "explicit" and jump back to the step labeled
   <i>start of line</i>.<li><p>If <var>line</var> equals "FALLBACK:" (the word "FALLBACK" followed by a U+003A
   COLON character (:)), then set <var>mode</var> to "fallback" and jump back to the step
   labeled <i>start of line</i>.<li><p>If <var>line</var> equals "NETWORK:" (the word "NETWORK" followed by a U+003A
   COLON character (:)), then set <var>mode</var> to "online safelist" and jump back to
   the step labeled <i>start of line</i>.<li><p>If <var>line</var> equals "SETTINGS:" (the word "SETTINGS" followed by a U+003A
   COLON character (:)), then set <var>mode</var> to "settings" and jump back to the step
   labeled <i>start of line</i>.<li><p>If <var>line</var> ends with a U+003A COLON character (:), then set <var>mode</var> to "unknown" and jump back to the step labeled <i>start of line</i>.<li><p>This is either a data line or it is syntactically incorrect.<li><p>Let <var>position</var> be a pointer into <var>line</var>, initially
   pointing at the start of the string.<li><p>Let <var>tokens</var> be a list of strings, initially empty.<li>

    <p>While <var>position</var> doesn't point past the end of <var>line</var>:</p>

    <ol><li><p>Let <var>current token</var> be an empty string.<li><p>While <var>position</var> doesn't point past the end of <var>line</var> and the character at <var>position</var> is neither a U+0020 SPACE
     nor a U+0009 CHARACTER TABULATION (tab) character, add the character at <var>position</var> to <var>current token</var> and advance <var>position</var> to the next character in <var>input</var>.<li><p>Add <var>current token</var> to the <var>tokens</var> list.<li><p>While <var>position</var> doesn't point past the end of <var>line</var> and the character at <var>position</var> is either a U+0020 SPACE
     or a U+0009 CHARACTER TABULATION (tab) character, advance <var>position</var> to the
     next character in <var>input</var>.</ol>

   <li>

    <p>Process <var>tokens</var> as follows:</p>

    <dl class=switch><dt>If <var>mode</var> is "explicit"<dd>

      <p>Let <var>urlRecord</var> be the result of <a href=https://url.spec.whatwg.org/#concept-url-parser id=parsing-cache-manifests:url-parser-3 data-x-internal=url-parser>parsing</a> the
      first item in <var>tokens</var> with <var>base URL</var>; ignore the rest.</p>

      <p>If <var>urlRecord</var> is failure, then jump back to the step labeled <i>start of
      line</i>.</p>

      <p>If <var>urlRecord</var> has a different <a href=https://url.spec.whatwg.org/#concept-url-scheme id=parsing-cache-manifests:concept-url-scheme data-x-internal=concept-url-scheme>scheme</a>
      component than <var>base URL</var> (the manifest's URL), then jump back to the step labeled
      <i>start of line</i>.</p>

      <p>Let <var>new URL</var> be the result of applying the <a href=https://url.spec.whatwg.org/#concept-url-serializer id=parsing-cache-manifests:concept-url-serializer data-x-internal=concept-url-serializer>URL serializer</a> algorithm to <var>urlRecord</var>, with
      the <i>exclude fragment flag</i> set.</p>

      <p>Add <var>new URL</var> to the <var>explicit URLs</var>.</p>

     <dt>If <var>mode</var> is "fallback"<dd>

      <p>Let <var>part one</var> be the first token in <var>tokens</var>, and let
      <var>part two</var> be the second token in <var>tokens</var>.</p>

      <p>Let <var>urlRecordOne</var> be the result of <a href=https://url.spec.whatwg.org/#concept-url-parser id=parsing-cache-manifests:url-parser-4 data-x-internal=url-parser>parsing</a>
      <var>part one</var> with <var>base URL</var>.</p>

      <p>Let <var>urlRecordTwo</var> be the result of <a href=https://url.spec.whatwg.org/#concept-url-parser id=parsing-cache-manifests:url-parser-5 data-x-internal=url-parser>parsing</a>
      <var>part two</var> with <var>base URL</var>.</p>

      <p>If either <var>urlRecordOne</var> or <var>urlRecordTwo</var> are failure, then jump back to
      the step labeled <i>start of line</i>.</p>

      <p>If the <a href=https://url.spec.whatwg.org/#concept-url-origin id=parsing-cache-manifests:concept-url-origin data-x-internal=concept-url-origin>origin</a> of either <var>urlRecordOne</var> or
      <var>urlRecordTwo</var> is not <a href=#same-origin id=parsing-cache-manifests:same-origin>same origin</a> with the manifest's URL <a href=https://url.spec.whatwg.org/#concept-url-origin id=parsing-cache-manifests:concept-url-origin-2 data-x-internal=concept-url-origin>origin</a>, then jump back to the step labeled <i>start of
      line</i>.</p>

      <p>Let <var>part one path</var> be the <a href=https://url.spec.whatwg.org/#concept-url-path id=parsing-cache-manifests:concept-url-path-2 data-x-internal=concept-url-path>path</a> component
      of <var>urlRecordOne</var>.</p>

      <p>If <var>manifest path</var> is not a <a href=#prefix-match id=parsing-cache-manifests:prefix-match>prefix match</a> for <var>part one
      path</var>, then jump back to the step labeled <i>start of line</i>.</p> 


      <p>Let <var>part one</var> be the result of applying the <a href=https://url.spec.whatwg.org/#concept-url-serializer id=parsing-cache-manifests:concept-url-serializer-2 data-x-internal=concept-url-serializer>URL serializer</a> algorithm to <var>urlRecordOne</var>,
      with the <i>exclude fragment flag</i> set.</p>

      <p>Let <var>part two</var> be the result of applying the <a href=https://url.spec.whatwg.org/#concept-url-serializer id=parsing-cache-manifests:concept-url-serializer-3 data-x-internal=concept-url-serializer>URL serializer</a> algorithm to <var>urlRecordTwo</var>,
      with the <i>exclude fragment flag</i> set.</p>

      <p>If <var>part one</var> is already in the <var>fallback URLs</var> mapping
      as a <a href=#concept-appcache-fallback-ns id=parsing-cache-manifests:concept-appcache-fallback-ns-2>fallback namespace</a>, then jump back to
      the step labeled <i>start of line</i>.</p>

      <p>Otherwise, add <var>part one</var> to the <var>fallback URLs</var>
      mapping as a <a href=#concept-appcache-fallback-ns id=parsing-cache-manifests:concept-appcache-fallback-ns-3>fallback namespace</a>, mapped to
      <var>part two</var> as the <a href=#concept-appcache-fallback id=parsing-cache-manifests:concept-appcache-fallback-2>fallback
      entry</a>.</p>

     <dt>If <var>mode</var> is "online safelist"<dd>

      <p>If the first item in <var>tokens</var> is a U+002A ASTERISK character (*), then
      set <var>online safelist wildcard flag</var> to <i>open</i> and jump back
      to the step labeled <i>start of line</i>.</p>

      <p>Otherwise, let <var>urlRecord</var> be the result of <a href=https://url.spec.whatwg.org/#concept-url-parser id=parsing-cache-manifests:url-parser-6 data-x-internal=url-parser>parsing</a> the first item in <var>tokens</var> with <var>base URL</var>.</p>

      <p>If <var>urlRecord</var> is failure, then jump back to the step labeled <i>start of
      line</i>.</p>

      <p>If <var>urlRecord</var> has a different <a href=https://url.spec.whatwg.org/#concept-url-scheme id=parsing-cache-manifests:concept-url-scheme-2 data-x-internal=concept-url-scheme>scheme</a>
      component than <var>base URL</var> (the manifest's URL), then jump back to the step labeled
      <i>start of line</i>.</p>

      <p>Let <var>new URL</var> be the result of applying the <a href=https://url.spec.whatwg.org/#concept-url-serializer id=parsing-cache-manifests:concept-url-serializer-4 data-x-internal=concept-url-serializer>URL serializer</a> algorithm to <var>urlRecord</var>, with
      the <i>exclude fragment flag</i> set.</p>

      <p>Add <var>new URL</var> to the <var>online safelist namespaces</var>.</p>

     <dt>If <var>mode</var> is "settings"<dd>

      <p>If <var>tokens</var> contains a single token, and that token is a
      <a href=#case-sensitive id=parsing-cache-manifests:case-sensitive>case-sensitive</a> match for the string "<code>prefer-online</code>", then
      set <var>cache mode flag</var> to <i>prefer-online</i> and jump back to the
      step labeled <i>start of line</i>.</p>

      <p>Otherwise, the line is an unsupported setting: do nothing; the line is ignored.</p>

     <dt>If <var>mode</var> is "unknown"<dd>

      <p>Do nothing. The line is ignored.</p>

     </dl>

   <li><p>Jump back to the step labeled <i>start of line</i>. (That step jumps to the next, and last,
   step when the end of the file is reached.)<li><p>Return the <var>explicit URLs</var> list, the <var>fallback URLs</var>
   mapping, the <var>online safelist namespaces</var>, the <var>online safelist
   wildcard flag</var>, and the <var>cache mode flag</var>.</ol>

  <div class=note>

   <p>The resource that declares the manifest (with the <code id=parsing-cache-manifests:attr-html-manifest><a href=#attr-html-manifest>manifest</a></code> attribute) will always get taken from the cache,
   whether it is listed in the cache or not, even if it is listed in an <a href=#concept-appcache-onlinesafelist id=parsing-cache-manifests:concept-appcache-onlinesafelist-2>online safelist namespace</a>.</p>

   <p>If a resource is listed in the <a href=#concept-appcache-manifest-explicit id=parsing-cache-manifests:concept-appcache-manifest-explicit>explicit
   section</a> or as a <a href=#concept-appcache-fallback id=parsing-cache-manifests:concept-appcache-fallback-3>fallback entry</a> in the <a href=#concept-appcache-manifest-fallback id=parsing-cache-manifests:concept-appcache-manifest-fallback>fallback section</a>, the resource will always be
   taken from the cache, regardless of any other matching entries in the <a href=#concept-appcache-fallback-ns id=parsing-cache-manifests:concept-appcache-fallback-ns-4>fallback namespaces</a> or <a href=#concept-appcache-onlinesafelist id=parsing-cache-manifests:concept-appcache-onlinesafelist-3>online safelist namespaces</a>.</p>

   <p>When a <a href=#concept-appcache-fallback-ns id=parsing-cache-manifests:concept-appcache-fallback-ns-5>fallback namespace</a> and an <a href=#concept-appcache-onlinesafelist id=parsing-cache-manifests:concept-appcache-onlinesafelist-4>online safelist namespace</a> overlap, the <a href=#concept-appcache-onlinesafelist id=parsing-cache-manifests:concept-appcache-onlinesafelist-5>online safelist namespace</a> has priority.</p>

   <p>The <a href=#concept-appcache-onlinesafelist-wildcard id=parsing-cache-manifests:concept-appcache-onlinesafelist-wildcard>online safelist wildcard
   flag</a> is applied last, only for URLs that match neither the <a href=#concept-appcache-onlinesafelist id=parsing-cache-manifests:concept-appcache-onlinesafelist-6>online safelist namespace</a> nor the <a href=#concept-appcache-fallback-ns id=parsing-cache-manifests:concept-appcache-fallback-ns-6>fallback namespace</a> and that are not listed in the
   <a href=#concept-appcache-manifest-explicit id=parsing-cache-manifests:concept-appcache-manifest-explicit-2>explicit section</a>.</p>

  </div>


  <h4 id=downloading-or-updating-an-application-cache>7.9.4 Downloading or updating an application cache<a href=#downloading-or-updating-an-application-cache class=self-link></a></h4>

  <p>When the user agent is required (by other parts of this specification) to start the
  <dfn id=application-cache-download-process>application cache download process</dfn> for an <a id=downloading-or-updating-an-application-cache:absolute-url href=https://url.spec.whatwg.org/#syntax-url-absolute data-x-internal=absolute-url>absolute URL</a> purported to
  identify a <a href=#concept-appcache-manifest id=downloading-or-updating-an-application-cache:concept-appcache-manifest>manifest</a>, or for an <a href=#application-cache-group id=downloading-or-updating-an-application-cache:application-cache-group>application
  cache group</a>, potentially given a particular <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host>cache host</a>, and potentially given
  a <a href=#concept-appcache-master id=downloading-or-updating-an-application-cache:concept-appcache-master>master</a> resource, the user agent must run the steps
  below. These steps are always run <a href=#in-parallel id=downloading-or-updating-an-application-cache:in-parallel>in parallel</a> with the <a href=#event-loop id=downloading-or-updating-an-application-cache:event-loop>event loop</a>
  <a href=#concept-task id=downloading-or-updating-an-application-cache:concept-task>tasks</a>.</p>

  <p>Some of these steps have requirements that only apply if the user agent <dfn id=shows-caching-progress>shows caching
  progress</dfn>. Support for this is optional. Caching progress UI could consist of a progress bar
  or message panel in the user agent's interface, or an overlay, or something else. Certain events
  fired during the <a href=#application-cache-download-process id=downloading-or-updating-an-application-cache:application-cache-download-process>application cache download process</a> allow the script to override the
  display of such an interface. (Such events are delayed until after the <code id=downloading-or-updating-an-application-cache:event-load><a href=#event-load>load</a></code> event has fired.)

  The goal of this is to allow Web applications to provide more
  seamless update mechanisms, hiding from the user the mechanics of the application cache mechanism.
  User agents may display user interfaces independent of this, but are encouraged to not show
  prominent update progress notifications for applications that cancel the relevant events.</p>

  <p>The <a href=#application-cache-download-process id=downloading-or-updating-an-application-cache:application-cache-download-process-2>application cache download process</a> steps are as follows:

  <ol><li><p>Optionally, wait until the permission to start the <a href=#application-cache-download-process id=downloading-or-updating-an-application-cache:application-cache-download-process-3>application cache download
   process</a> has been obtained from the user and until the user agent is confident that the
   network is available. This could include doing nothing until the user explicitly opts-in to
   caching the site, or could involve prompting the user for permission. The algorithm might never
   get past this point. (This step is particularly intended to be used by user agents running on
   severely space-constrained devices or in highly privacy-sensitive environments).<li>

    <p>Atomically, so as to avoid race conditions, perform the following substeps:</p>

    <ol><li>

      <p>Pick the appropriate substeps:</p>

      <dl class=switch><dt>If these steps were invoked with an <a id=downloading-or-updating-an-application-cache:absolute-url-2 href=https://url.spec.whatwg.org/#syntax-url-absolute data-x-internal=absolute-url>absolute URL</a> purported to identify a
       <a href=#concept-appcache-manifest id=downloading-or-updating-an-application-cache:concept-appcache-manifest-2>manifest</a><dd>

        <p>Let <var>manifest URL</var> be that <a id=downloading-or-updating-an-application-cache:absolute-url-3 href=https://url.spec.whatwg.org/#syntax-url-absolute data-x-internal=absolute-url>absolute URL</a>.</p>

        <p>If there is no <a href=#application-cache-group id=downloading-or-updating-an-application-cache:application-cache-group-2>application cache group</a> identified by <var>manifest
        URL</var>, then create a new <a href=#application-cache-group id=downloading-or-updating-an-application-cache:application-cache-group-3>application cache group</a> identified by <var>manifest URL</var>. Initially, it has no <a href=#application-cache id=downloading-or-updating-an-application-cache:application-cache>application caches</a>. One will be created later in this algorithm.</p>

       <dt>If these steps were invoked with an <a href=#application-cache-group id=downloading-or-updating-an-application-cache:application-cache-group-4>application cache group</a><dd>

        <p>Let <var>manifest URL</var> be the <a id=downloading-or-updating-an-application-cache:absolute-url-4 href=https://url.spec.whatwg.org/#syntax-url-absolute data-x-internal=absolute-url>absolute URL</a> of the <a href=#concept-appcache-manifest id=downloading-or-updating-an-application-cache:concept-appcache-manifest-3>manifest</a> used to identify the <a href=#application-cache-group id=downloading-or-updating-an-application-cache:application-cache-group-5>application
        cache group</a> to be updated.</p>

        <p>If that <a href=#application-cache-group id=downloading-or-updating-an-application-cache:application-cache-group-6>application cache group</a> is <a href=#concept-appcache-obsolete id=downloading-or-updating-an-application-cache:concept-appcache-obsolete>obsolete</a>, then abort this instance of the
        <a href=#application-cache-download-process id=downloading-or-updating-an-application-cache:application-cache-download-process-4>application cache download process</a>. This can happen if another instance of this
        algorithm found the manifest to be 404 or 410 while this algorithm was waiting in the first
        step above.</p>

       </dl>

     <li><p>Let <var>cache group</var> be the <a href=#application-cache-group id=downloading-or-updating-an-application-cache:application-cache-group-7>application cache group</a>
     identified by <var>manifest URL</var>.<li><p>If these steps were invoked with a <a href=#concept-appcache-master id=downloading-or-updating-an-application-cache:concept-appcache-master-2>master</a>
     resource, then add the resource, along with the resource's <code id=downloading-or-updating-an-application-cache:document><a href=#document>Document</a></code>, to <var>cache group</var>'s <a href=#concept-appcache-pending-masters id=downloading-or-updating-an-application-cache:concept-appcache-pending-masters>list of pending
     master entries</a>.<li>
      <p>If these steps were invoked with a <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-2>cache host</a>, and the <a href=#concept-appcache-status id=downloading-or-updating-an-application-cache:concept-appcache-status>status</a> of <var>cache group</var> is
      <i>checking</i> or <i>downloading</i>, then <a href=#queue-a-post-load-task id=downloading-or-updating-an-application-cache:queue-a-post-load-task>queue a post-load task</a> to run these
      steps:</p>

      <ol><li><p>Let <var>showProgress</var> be the result of <a href=https://dom.spec.whatwg.org/#concept-event-fire id=downloading-or-updating-an-application-cache:concept-event-fire data-x-internal=concept-event-fire>firing
       an event</a> named <code id=downloading-or-updating-an-application-cache:event-appcache-checking><a href=#event-appcache-checking>checking</a></code> at the
       <code id=downloading-or-updating-an-application-cache:applicationcache><a href=#applicationcache>ApplicationCache</a></code> singleton of that <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-3>cache host</a>, with the <code id=downloading-or-updating-an-application-cache:dom-event-cancelable><a data-x-internal=dom-event-cancelable href=https://dom.spec.whatwg.org/#dom-event-cancelable>cancelable</a></code> attribute initialized to true.<li><p>If <var>showProgress</var> is true and the user agent <a href=#shows-caching-progress id=downloading-or-updating-an-application-cache:shows-caching-progress>shows caching
       progress</a>, then display some sort of user interface indicating to the user that the
       user agent is checking to see if it can download the application.</ol>
     <li>
      <p>If these steps were invoked with a <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-4>cache host</a>, and the <a href=#concept-appcache-status id=downloading-or-updating-an-application-cache:concept-appcache-status-2>status</a> of <var>cache group</var> is
      <i>downloading</i>, then also <a href=#queue-a-post-load-task id=downloading-or-updating-an-application-cache:queue-a-post-load-task-2>queue a post-load task</a> to run these steps:</p>

      <ol><li><p>Let <var>showProgress</var> be the result of <a href=https://dom.spec.whatwg.org/#concept-event-fire id=downloading-or-updating-an-application-cache:concept-event-fire-2 data-x-internal=concept-event-fire>firing
       an event</a> named <code id=downloading-or-updating-an-application-cache:event-appcache-downloading><a href=#event-appcache-downloading>downloading</a></code> at the
       <code id=downloading-or-updating-an-application-cache:applicationcache-2><a href=#applicationcache>ApplicationCache</a></code> singleton of that <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-5>cache host</a>, with the <code id=downloading-or-updating-an-application-cache:dom-event-cancelable-2><a data-x-internal=dom-event-cancelable href=https://dom.spec.whatwg.org/#dom-event-cancelable>cancelable</a></code> attribute initialized to true.<li><p>If <var>showProgress</var> is true and the user agent <a href=#shows-caching-progress id=downloading-or-updating-an-application-cache:shows-caching-progress-2>shows caching
       progress</a>, then display some sort of user interface indicating to the user the
       application is being downloaded.</ol>
     <li><p>If the <a href=#concept-appcache-status id=downloading-or-updating-an-application-cache:concept-appcache-status-3>status</a> of the <var>cache
     group</var> is either <i>checking</i> or <i>downloading</i>, then abort this instance of the
     <a href=#application-cache-download-process id=downloading-or-updating-an-application-cache:application-cache-download-process-5>application cache download process</a>, as an update is already in progress.<li><p>Set the <a href=#concept-appcache-status id=downloading-or-updating-an-application-cache:concept-appcache-status-4>status</a> of <var>cache
     group</var> to <i>checking</i>.</p>

     <li>
      <p>For each <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-6>cache host</a> associated with an <a href=#application-cache id=downloading-or-updating-an-application-cache:application-cache-2>application cache</a> in
      <var>cache group</var>, <a href=#queue-a-post-load-task id=downloading-or-updating-an-application-cache:queue-a-post-load-task-3>queue a post-load task</a> run these steps:</p>

      <ol><li><p>Let <var>showProgress</var> be the result of <a href=https://dom.spec.whatwg.org/#concept-event-fire id=downloading-or-updating-an-application-cache:concept-event-fire-3 data-x-internal=concept-event-fire>firing
       an event</a> named <code id=downloading-or-updating-an-application-cache:event-appcache-checking-2><a href=#event-appcache-checking>checking</a></code> at the
       <code id=downloading-or-updating-an-application-cache:applicationcache-3><a href=#applicationcache>ApplicationCache</a></code> singleton of the <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-7>cache host</a>, with the <code id=downloading-or-updating-an-application-cache:dom-event-cancelable-3><a data-x-internal=dom-event-cancelable href=https://dom.spec.whatwg.org/#dom-event-cancelable>cancelable</a></code> attribute initialized to true.<li><p>If <var>showProgress</var> is true and the user agent <a href=#shows-caching-progress id=downloading-or-updating-an-application-cache:shows-caching-progress-3>shows caching
       progress</a>, then display some sort of user interface indicating to the user that the
       user agent is checking for the availability of updates.</ol>
     </ol>

    <p class=note>The remainder of the steps run <a href=#in-parallel id=downloading-or-updating-an-application-cache:in-parallel-2>in parallel</a>.</p>

    <p>If <var>cache group</var> already has an <a href=#application-cache id=downloading-or-updating-an-application-cache:application-cache-3>application cache</a> in it, then
    this is an <dfn id=concept-appcache-upgrade>upgrade attempt</dfn>. Otherwise, this is a
    <dfn id=concept-appcache-cache>cache attempt</dfn>.</p>

   <li>
    <p>If this is a <a href=#concept-appcache-cache id=downloading-or-updating-an-application-cache:concept-appcache-cache>cache attempt</a>, then this algorithm
    was invoked with a <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-8>cache host</a>; <a href=#queue-a-post-load-task id=downloading-or-updating-an-application-cache:queue-a-post-load-task-4>queue a post-load task</a> to run these
    steps:</p>

    <ol><li><p>Let <var>showProgress</var> be the result of <a href=https://dom.spec.whatwg.org/#concept-event-fire id=downloading-or-updating-an-application-cache:concept-event-fire-4 data-x-internal=concept-event-fire>firing an
     event</a> named <code id=downloading-or-updating-an-application-cache:event-appcache-checking-3><a href=#event-appcache-checking>checking</a></code> at the
     <code id=downloading-or-updating-an-application-cache:applicationcache-4><a href=#applicationcache>ApplicationCache</a></code> singleton of that <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-9>cache host</a>, with the <code id=downloading-or-updating-an-application-cache:dom-event-cancelable-4><a data-x-internal=dom-event-cancelable href=https://dom.spec.whatwg.org/#dom-event-cancelable>cancelable</a></code> attribute initialized to true.<li><p>If <var>showProgress</var> is true and the user agent <a href=#shows-caching-progress id=downloading-or-updating-an-application-cache:shows-caching-progress-4>shows caching
     progress</a>, then display some sort of user interface indicating to the user that the user
     agent is checking for the availability of updates.</ol>
   <li><p>Let <var>request</var> be a new <a href=https://fetch.spec.whatwg.org/#concept-request id=downloading-or-updating-an-application-cache:concept-request data-x-internal=concept-request>request</a> whose
   <a href=https://fetch.spec.whatwg.org/#concept-request-url id=downloading-or-updating-an-application-cache:concept-request-url data-x-internal=concept-request-url>url</a> is <var>manifest URL</var>, <a href=https://fetch.spec.whatwg.org/#concept-request-client id=downloading-or-updating-an-application-cache:concept-request-client data-x-internal=concept-request-client>client</a> is null, <a href=https://fetch.spec.whatwg.org/#concept-request-destination id=downloading-or-updating-an-application-cache:concept-request-destination data-x-internal=concept-request-destination>destination</a> is the empty string, <a href=https://fetch.spec.whatwg.org/#concept-request-referrer id=downloading-or-updating-an-application-cache:concept-request-referrer data-x-internal=concept-request-referrer>referrer</a> is "<code>no-referrer</code>",
   <a id=downloading-or-updating-an-application-cache:synchronous-flag href=https://fetch.spec.whatwg.org/#synchronous-flag data-x-internal=synchronous-flag>synchronous flag</a> is set, <a href=https://fetch.spec.whatwg.org/#concept-request-credentials-mode id=downloading-or-updating-an-application-cache:concept-request-credentials-mode data-x-internal=concept-request-credentials-mode>credentials
   mode</a> is "<code>include</code>", and whose <a id=downloading-or-updating-an-application-cache:use-url-credentials-flag href=https://fetch.spec.whatwg.org/#concept-request-use-url-credentials-flag data-x-internal=use-url-credentials-flag>use-URL-credentials
   flag</a> is set.<li>

    <p><i>Fetching the manifest</i>: Let <var>manifest</var> be the result of <a href=https://fetch.spec.whatwg.org/#concept-fetch id=downloading-or-updating-an-application-cache:concept-fetch data-x-internal=concept-fetch>fetching</a> <var>request</var>. HTTP caching semantics should be
    honored for this request.</p>

    <p>Parse <var>manifest</var>'s <a href=https://fetch.spec.whatwg.org/#concept-response-body id=downloading-or-updating-an-application-cache:concept-response-body data-x-internal=concept-response-body>body</a> according to the
    <a href=#parse-a-manifest id=downloading-or-updating-an-application-cache:parse-a-manifest>rules for parsing manifests</a>, obtaining a list of
    <a href=#concept-appcache-explicit id=downloading-or-updating-an-application-cache:concept-appcache-explicit>explicit entries</a>, <a href=#concept-appcache-fallback id=downloading-or-updating-an-application-cache:concept-appcache-fallback>fallback entries</a> and the <a href=#concept-appcache-fallback-ns id=downloading-or-updating-an-application-cache:concept-appcache-fallback-ns>fallback namespaces</a> that map to them, entries for
    the <a href=#concept-appcache-onlinesafelist id=downloading-or-updating-an-application-cache:concept-appcache-onlinesafelist>online safelist</a>, and values for the
    <a href=#concept-appcache-onlinesafelist-wildcard id=downloading-or-updating-an-application-cache:concept-appcache-onlinesafelist-wildcard>online safelist wildcard flag</a>
    and the <a href=#concept-appcache-mode id=downloading-or-updating-an-application-cache:concept-appcache-mode>cache mode flag</a>.</p>

    <p class=note>The <a id=downloading-or-updating-an-application-cache:mime-type href=https://mimesniff.spec.whatwg.org/#mime-type data-x-internal=mime-type>MIME type</a> of the resource is ignored  it is assumed to
    be <code id=downloading-or-updating-an-application-cache:text/cache-manifest><a href=#text/cache-manifest>text/cache-manifest</a></code>. In the future, if new manifest formats are supported, the
    different types will probably be distinguished on the basis of the file signatures (for the
    current format, that is the "<code>CACHEMANIFEST</code>" string at the top of the
    file).</p>

   <li>

    <p>If <i>fetching the manifest</i> fails due to a 404 or 410 response status, then run these
    substeps:</p>

    <ol><li><p>Mark <var>cache group</var> as <a href=#concept-appcache-obsolete id=downloading-or-updating-an-application-cache:concept-appcache-obsolete-2>obsolete</a>. This <var>cache group</var> no
     longer exists for any purpose other than the processing of <code id=downloading-or-updating-an-application-cache:document-2><a href=#document>Document</a></code> objects
     already associated with an <a href=#application-cache id=downloading-or-updating-an-application-cache:application-cache-4>application cache</a> in the <var>cache
     group</var>.<li><p>Let <var>task list</var> be an empty list of <a href=#concept-task id=downloading-or-updating-an-application-cache:concept-task-2>tasks</a>.</p>

     <li>
      <p>For each <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-10>cache host</a> associated with an <a href=#application-cache id=downloading-or-updating-an-application-cache:application-cache-5>application cache</a> in
      <var>cache group</var>, create a <a href=#concept-task id=downloading-or-updating-an-application-cache:concept-task-3>task</a> to run these
      steps and append it to <var>task list</var>:</p>

      <ol><li><p>Let <var>showProgress</var> be the result of <a href=https://dom.spec.whatwg.org/#concept-event-fire id=downloading-or-updating-an-application-cache:concept-event-fire-5 data-x-internal=concept-event-fire>firing
       an event</a> named <code id=downloading-or-updating-an-application-cache:event-appcache-obsolete><a href=#event-appcache-obsolete>obsolete</a></code> at the
       <code id=downloading-or-updating-an-application-cache:applicationcache-5><a href=#applicationcache>ApplicationCache</a></code> singleton of the <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-11>cache host</a>, with the <code id=downloading-or-updating-an-application-cache:dom-event-cancelable-5><a data-x-internal=dom-event-cancelable href=https://dom.spec.whatwg.org/#dom-event-cancelable>cancelable</a></code> attribute initialized to true.<li><p>If <var>showProgress</var> is true and the user agent <a href=#shows-caching-progress id=downloading-or-updating-an-application-cache:shows-caching-progress-5>shows caching
       progress</a>, then display some sort of user interface indicating to the user that the
       application is no longer available for offline use.</ol>
     <li>
      <p>For each entry in <var>cache group</var>'s <a href=#concept-appcache-pending-masters id=downloading-or-updating-an-application-cache:concept-appcache-pending-masters-2>list of pending master entries</a>, create a
      <a href=#concept-task id=downloading-or-updating-an-application-cache:concept-task-4>task</a> to run these steps and append it to <var>task
      list</var>:</p>

      <ol><li><p>Let <var>showProgress</var> be the result of <a href=https://dom.spec.whatwg.org/#concept-event-fire id=downloading-or-updating-an-application-cache:concept-event-fire-6 data-x-internal=concept-event-fire>firing
       an event</a> named <code id=downloading-or-updating-an-application-cache:event-appcache-error><a href=#event-appcache-error>error</a></code> (not <code id=downloading-or-updating-an-application-cache:event-appcache-obsolete-2><a href=#event-appcache-obsolete>obsolete</a></code>!) at the <code id=downloading-or-updating-an-application-cache:applicationcache-6><a href=#applicationcache>ApplicationCache</a></code>
       singleton of the <code id=downloading-or-updating-an-application-cache:document-3><a href=#document>Document</a></code> for this entry, if there still is one, with the <code id=downloading-or-updating-an-application-cache:dom-event-cancelable-6><a data-x-internal=dom-event-cancelable href=https://dom.spec.whatwg.org/#dom-event-cancelable>cancelable</a></code> attribute initialized to true.<li><p>If <var>showProgress</var> is true and the user agent <a href=#shows-caching-progress id=downloading-or-updating-an-application-cache:shows-caching-progress-6>shows caching
       progress</a>, then display some sort of user interface indicating to the user that the
       user agent failed to save the application for offline use.</ol>
     <li><p>If <var>cache group</var> has an <a href=#application-cache id=downloading-or-updating-an-application-cache:application-cache-6>application cache</a> whose <a href=#concept-appcache-completeness id=downloading-or-updating-an-application-cache:concept-appcache-completeness>completeness flag</a> is <i>incomplete</i>, then
     discard that <a href=#application-cache id=downloading-or-updating-an-application-cache:application-cache-7>application cache</a>.</p>

     <li><p>If appropriate, remove any user interface indicating that an update for this cache is in
     progress.<li><p>Let the <a href=#concept-appcache-status id=downloading-or-updating-an-application-cache:concept-appcache-status-5>status</a> of <var>cache
     group</var> be <i>idle</i>.<li><p>For each <a href=#concept-task id=downloading-or-updating-an-application-cache:concept-task-5>task</a> in <var>task list</var>, <a href=#queue-a-post-load-task id=downloading-or-updating-an-application-cache:queue-a-post-load-task-5>queue that task as a post-load task</a>.<li><p>Abort the <a href=#application-cache-download-process id=downloading-or-updating-an-application-cache:application-cache-download-process-6>application cache download process</a>.</ol>

   <li>

    <p>Otherwise, if <i>fetching the manifest</i> fails in some other way (e.g. the server returns
    another 4xx or 5xx response, or there is a DNS error, or the connection times out, or the user
    cancels the download, or the parser for manifests fails when checking the magic signature), or
    if the server returned a redirect, then run the <a href=#cache-failure-steps id=downloading-or-updating-an-application-cache:cache-failure-steps>cache failure steps</a>. <a href=#refsHTTP>[HTTP]</a></p>

   <li>

    <p>If this is an <a href=#concept-appcache-upgrade id=downloading-or-updating-an-application-cache:concept-appcache-upgrade>upgrade attempt</a> and the newly
    downloaded <var>manifest</var> is byte-for-byte identical to the manifest found in the
    <a href=#concept-appcache-newer id=downloading-or-updating-an-application-cache:concept-appcache-newer>newest</a> <a href=#application-cache id=downloading-or-updating-an-application-cache:application-cache-8>application cache</a> in <var>cache
    group</var>, or the response status is <code>304</code>, then run these substeps:</p>

    <ol><li><p>Let <var>cache</var> be the <a href=#concept-appcache-newer id=downloading-or-updating-an-application-cache:concept-appcache-newer-2>newest</a>
     <a href=#application-cache id=downloading-or-updating-an-application-cache:application-cache-9>application cache</a> in <var>cache group</var>.<li><p>Let <var>task list</var> be an empty list of <a href=#concept-task id=downloading-or-updating-an-application-cache:concept-task-6>tasks</a>.</p>

     <li>

      <p>For each entry in <var>cache group</var>'s <a href=#concept-appcache-pending-masters id=downloading-or-updating-an-application-cache:concept-appcache-pending-masters-3>list of pending master entries</a>, wait for the
      resource for this entry to have either completely downloaded or failed.</p>

      <p>If the download failed (e.g. the server returns a 4xx or 5xx response, or there is a DNS
      error, the connection times out, or the user cancels the download), or if the resource is
      labeled with the "no-store" cache directive, then create a <a href=#concept-task id=downloading-or-updating-an-application-cache:concept-task-7>task</a> to run these steps and append it to <var>task
      list</var>:</p>

      <ol><li><p>Let <var>showProgress</var> be the result of <a href=https://dom.spec.whatwg.org/#concept-event-fire id=downloading-or-updating-an-application-cache:concept-event-fire-7 data-x-internal=concept-event-fire>firing
       an event</a> named <code id=downloading-or-updating-an-application-cache:event-appcache-error-2><a href=#event-appcache-error>error</a></code> at the
       <code id=downloading-or-updating-an-application-cache:applicationcache-7><a href=#applicationcache>ApplicationCache</a></code> singleton of the <code id=downloading-or-updating-an-application-cache:document-4><a href=#document>Document</a></code> for this entry, if there
       still is one, with the <code id=downloading-or-updating-an-application-cache:dom-event-cancelable-7><a data-x-internal=dom-event-cancelable href=https://dom.spec.whatwg.org/#dom-event-cancelable>cancelable</a></code> attribute
       initialized to true.<li><p>If <var>showProgress</var> is true and the user agent <a href=#shows-caching-progress id=downloading-or-updating-an-application-cache:shows-caching-progress-7>shows caching
       progress</a>, then display some sort of user interface indicating to the user that the
       user agent failed to save the application for offline use.</ol>

      <p>Otherwise, associate the <code id=downloading-or-updating-an-application-cache:document-5><a href=#document>Document</a></code> for this entry with <var>cache</var>; store the resource for this entry in <var>cache</var>, if it
      isn't already there, and categorize its entry as a <a href=#concept-appcache-master id=downloading-or-updating-an-application-cache:concept-appcache-master-3>master entry</a>. If applying the <a id=downloading-or-updating-an-application-cache:url-parser href=https://url.spec.whatwg.org/#concept-url-parser data-x-internal=url-parser>URL parser</a>
      algorithm to the resource's <a id=downloading-or-updating-an-application-cache:url href=https://url.spec.whatwg.org/#concept-url data-x-internal=url>URL</a> results in a <a id=downloading-or-updating-an-application-cache:url-record href=https://url.spec.whatwg.org/#concept-url data-x-internal=url-record>URL record</a> that has a
      non-null <a href=https://url.spec.whatwg.org/#concept-url-fragment id=downloading-or-updating-an-application-cache:concept-url-fragment data-x-internal=concept-url-fragment>fragment</a> component, the <a id=downloading-or-updating-an-application-cache:url-2 href=https://url.spec.whatwg.org/#concept-url data-x-internal=url>URL</a>
      used for the entry in <var>cache</var> must instead be the <a id=downloading-or-updating-an-application-cache:absolute-url-5 href=https://url.spec.whatwg.org/#syntax-url-absolute data-x-internal=absolute-url>absolute URL</a>
      obtained from applying the <a href=https://url.spec.whatwg.org/#concept-url-serializer id=downloading-or-updating-an-application-cache:concept-url-serializer data-x-internal=concept-url-serializer>URL serializer</a>
      algorithm to the <a id=downloading-or-updating-an-application-cache:url-record-2 href=https://url.spec.whatwg.org/#concept-url data-x-internal=url-record>URL record</a> with the <i>exclude fragment flag</i> set
      (application caches never include <a href=https://url.spec.whatwg.org/#concept-url-fragment id=downloading-or-updating-an-application-cache:concept-url-fragment-2 data-x-internal=concept-url-fragment>fragments</a>).</p>

     <li>
      <p>For each <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-12>cache host</a> associated with an <a href=#application-cache id=downloading-or-updating-an-application-cache:application-cache-10>application cache</a> in
      <var>cache group</var>, create a <a href=#concept-task id=downloading-or-updating-an-application-cache:concept-task-8>task</a> to run these steps
      and append it to <var>task list</var>:</p>

      <ol><li><p>Let <var>showProgress</var> be the result of <a href=https://dom.spec.whatwg.org/#concept-event-fire id=downloading-or-updating-an-application-cache:concept-event-fire-8 data-x-internal=concept-event-fire>firing
       an event</a> named <code id=downloading-or-updating-an-application-cache:event-appcache-noupdate><a href=#event-appcache-noupdate>noupdate</a></code> at the
       <code id=downloading-or-updating-an-application-cache:applicationcache-8><a href=#applicationcache>ApplicationCache</a></code> singleton of the <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-13>cache host</a>, with the <code id=downloading-or-updating-an-application-cache:dom-event-cancelable-8><a data-x-internal=dom-event-cancelable href=https://dom.spec.whatwg.org/#dom-event-cancelable>cancelable</a></code> attribute initialized to true.<li><p>If <var>showProgress</var> is true and the user agent <a href=#shows-caching-progress id=downloading-or-updating-an-application-cache:shows-caching-progress-8>shows caching
       progress</a>, then display some sort of user interface indicating to the user that the
       application is up to date.</ol>
     <li><p>Empty <var>cache group</var>'s <a href=#concept-appcache-pending-masters id=downloading-or-updating-an-application-cache:concept-appcache-pending-masters-4>list of pending master entries</a>.<li><p>If appropriate, remove any user interface indicating that an update for this cache is in
     progress.<li><p>Let the <a href=#concept-appcache-status id=downloading-or-updating-an-application-cache:concept-appcache-status-6>status</a> of <var>cache
     group</var> be <i>idle</i>.<li><p>For each <a href=#concept-task id=downloading-or-updating-an-application-cache:concept-task-9>task</a> in <var>task list</var>, <a href=#queue-a-post-load-task id=downloading-or-updating-an-application-cache:queue-a-post-load-task-6>queue that task as a post-load task</a>.<li><p>Abort the <a href=#application-cache-download-process id=downloading-or-updating-an-application-cache:application-cache-download-process-7>application cache download process</a>.</ol>

   <li><p>Let <var>new cache</var> be a newly created <a href=#application-cache id=downloading-or-updating-an-application-cache:application-cache-11>application cache</a> in
   <var>cache group</var>. Set its <a href=#concept-appcache-completeness id=downloading-or-updating-an-application-cache:concept-appcache-completeness-2>completeness
   flag</a> to <i>incomplete</i>.<li><p>For each entry in <var>cache group</var>'s <a href=#concept-appcache-pending-masters id=downloading-or-updating-an-application-cache:concept-appcache-pending-masters-5>list of pending master entries</a>, associate the
   <code id=downloading-or-updating-an-application-cache:document-6><a href=#document>Document</a></code> for this entry with <var>new cache</var>.<li><p>Set the <a href=#concept-appcache-status id=downloading-or-updating-an-application-cache:concept-appcache-status-7>status</a> of <var>cache
   group</var> to <i>downloading</i>.<li>
    <p>For each <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-14>cache host</a> associated with an <a href=#application-cache id=downloading-or-updating-an-application-cache:application-cache-12>application cache</a> in
    <var>cache group</var>, <a href=#queue-a-post-load-task id=downloading-or-updating-an-application-cache:queue-a-post-load-task-7>queue a post-load task</a> to run these steps:</p>

    <ol><li><p>Let <var>showProgress</var> be the result of <a href=https://dom.spec.whatwg.org/#concept-event-fire id=downloading-or-updating-an-application-cache:concept-event-fire-9 data-x-internal=concept-event-fire>firing an
     event</a> named <code id=downloading-or-updating-an-application-cache:event-appcache-downloading-2><a href=#event-appcache-downloading>downloading</a></code> at the
     <code id=downloading-or-updating-an-application-cache:applicationcache-9><a href=#applicationcache>ApplicationCache</a></code> singleton of the <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-15>cache host</a>, with the <code id=downloading-or-updating-an-application-cache:dom-event-cancelable-9><a data-x-internal=dom-event-cancelable href=https://dom.spec.whatwg.org/#dom-event-cancelable>cancelable</a></code> attribute initialized to true.<li><p>If <var>showProgress</var> is true and the user agent <a href=#shows-caching-progress id=downloading-or-updating-an-application-cache:shows-caching-progress-9>shows caching
     progress</a>, then display some sort of user interface indicating to the user that a new
     version is being downloaded.</ol>
   <li><p>Let <var>file list</var> be an empty list of URLs with flags.<li><p>Add all the URLs in the list of <a href=#concept-appcache-explicit id=downloading-or-updating-an-application-cache:concept-appcache-explicit-2>explicit
   entries</a> obtained by parsing <var>manifest</var> to <var>file list</var>,
   each flagged with "explicit entry".<li><p>Add all the URLs in the list of <a href=#concept-appcache-fallback id=downloading-or-updating-an-application-cache:concept-appcache-fallback-2>fallback
   entries</a> obtained by parsing <var>manifest</var> to <var>file list</var>,
   each flagged with "fallback entry".<li><p>If this is an <a href=#concept-appcache-upgrade id=downloading-or-updating-an-application-cache:concept-appcache-upgrade-2>upgrade attempt</a>, then add all
   the URLs of <a href=#concept-appcache-master id=downloading-or-updating-an-application-cache:concept-appcache-master-4>master entries</a> in the <a href=#concept-appcache-newer id=downloading-or-updating-an-application-cache:concept-appcache-newer-3>newest</a> <a href=#application-cache id=downloading-or-updating-an-application-cache:application-cache-13>application cache</a> in <var>cache group</var> whose <a href=#concept-appcache-completeness id=downloading-or-updating-an-application-cache:concept-appcache-completeness-3>completeness
   flag</a> is <i>complete</i> to <var>file list</var>, each flagged with "master
   entry".<li><p>If any URL is in <var>file list</var> more than once, then merge the entries into
   one entry for that URL, that entry having all the flags that the original entries had.<li>

    <p>For each URL in <var>file list</var>, run the following steps. These steps may be
    run in parallel for two or more of the URLs at a time. If, while running these steps, the
    <code id=downloading-or-updating-an-application-cache:applicationcache-10><a href=#applicationcache>ApplicationCache</a></code> object's <code id=downloading-or-updating-an-application-cache:dom-appcache-abort><a href=#dom-appcache-abort>abort()</a></code> method
    <a href=#send-a-signal id=downloading-or-updating-an-application-cache:send-a-signal>sends a signal</a> to this instance of the <a href=#application-cache-download-process id=downloading-or-updating-an-application-cache:application-cache-download-process-8>application
    cache download process</a> algorithm, then run the <a href=#cache-failure-steps id=downloading-or-updating-an-application-cache:cache-failure-steps-2>cache failure steps</a>
    instead.</p>

    <ol><li>

      <p>If the resource URL being processed was flagged as neither an "explicit entry" nor or a
      "fallback entry", then the user agent may skip this URL.</p>

      <p class=note>This is intended to allow user agents to expire resources not listed in the
      manifest from the cache. Generally, implementors are urged to use an approach that expires
      lesser-used resources first.</p>

     <li>
      <p>For each <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-16>cache host</a> associated with an <a href=#application-cache id=downloading-or-updating-an-application-cache:application-cache-14>application cache</a> in
      <var>cache group</var>, <a href=#queue-a-progress-post-load-task id=downloading-or-updating-an-application-cache:queue-a-progress-post-load-task>queue a progress post-load task</a> to run these steps:</p>

      <ol><li><p>Let <var>showProgress</var> be the result of <a href=https://dom.spec.whatwg.org/#concept-event-fire id=downloading-or-updating-an-application-cache:concept-event-fire-10 data-x-internal=concept-event-fire>firing
       an event</a> named <code id=downloading-or-updating-an-application-cache:event-appcache-progress><a href=#event-appcache-progress>progress</a></code> at the
       <code id=downloading-or-updating-an-application-cache:applicationcache-11><a href=#applicationcache>ApplicationCache</a></code> singleton of the <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-17>cache host</a>, using
       <code id=downloading-or-updating-an-application-cache:progressevent><a data-x-internal=progressevent href=https://xhr.spec.whatwg.org/#interface-progressevent>ProgressEvent</a></code>, with the <code id=downloading-or-updating-an-application-cache:dom-event-cancelable-10><a data-x-internal=dom-event-cancelable href=https://dom.spec.whatwg.org/#dom-event-cancelable>cancelable</a></code>
       attribute initialized to true, the <code id=downloading-or-updating-an-application-cache:dom-progressevent-lengthcomputable><a data-x-internal=dom-progressevent-lengthcomputable href=https://xhr.spec.whatwg.org/#dom-progressevent-lengthcomputable>lengthComputable</a></code> attribute initialized to
       true, the <code id=downloading-or-updating-an-application-cache:dom-progressevent-total><a data-x-internal=dom-progressevent-total href=https://xhr.spec.whatwg.org/#dom-progressevent-total>total</a></code> attribute initialized to the
       number of files in <var>file list</var>, and the <code id=downloading-or-updating-an-application-cache:dom-progressevent-loaded><a data-x-internal=dom-progressevent-loaded href=https://xhr.spec.whatwg.org/#dom-progressevent-loaded>loaded</a></code> attribute initialized to the number of files
       in <var>file list</var> that have been either downloaded or skipped so far. <a href=#refsXHR>[XHR]</a><li><p>If <var>showProgress</var> is true and the user agent <a href=#shows-caching-progress id=downloading-or-updating-an-application-cache:shows-caching-progress-10>shows caching
       progress</a>, then display some sort of user interface indicating to the user that a file
       is being downloaded in preparation for updating the application.</ol>
     <li><p>Let <var>request</var> be a new <a href=https://fetch.spec.whatwg.org/#concept-request id=downloading-or-updating-an-application-cache:concept-request-2 data-x-internal=concept-request>request</a> whose
     <a href=https://fetch.spec.whatwg.org/#concept-request-url id=downloading-or-updating-an-application-cache:concept-request-url-2 data-x-internal=concept-request-url>url</a> is URL, <a href=https://fetch.spec.whatwg.org/#concept-request-client id=downloading-or-updating-an-application-cache:concept-request-client-2 data-x-internal=concept-request-client>client</a> is null, <a href=https://fetch.spec.whatwg.org/#concept-request-destination id=downloading-or-updating-an-application-cache:concept-request-destination-2 data-x-internal=concept-request-destination>destination</a> is the empty string,
     <a href=https://fetch.spec.whatwg.org/#concept-request-origin id=downloading-or-updating-an-application-cache:concept-request-origin data-x-internal=concept-request-origin>origin</a> is
     <var>manifest URL</var>'s <a href=#concept-origin id=downloading-or-updating-an-application-cache:concept-origin>origin</a>, <a href=https://fetch.spec.whatwg.org/#concept-request-referrer id=downloading-or-updating-an-application-cache:concept-request-referrer-2 data-x-internal=concept-request-referrer>referrer</a> is "<code>no-referrer</code>",
     <a id=downloading-or-updating-an-application-cache:synchronous-flag-2 href=https://fetch.spec.whatwg.org/#synchronous-flag data-x-internal=synchronous-flag>synchronous flag</a> is set, <a href=https://fetch.spec.whatwg.org/#concept-request-credentials-mode id=downloading-or-updating-an-application-cache:concept-request-credentials-mode-2 data-x-internal=concept-request-credentials-mode>credentials mode</a> is "<code>include</code>", <a id=downloading-or-updating-an-application-cache:use-url-credentials-flag-2 href=https://fetch.spec.whatwg.org/#concept-request-use-url-credentials-flag data-x-internal=use-url-credentials-flag>use-URL-credentials flag</a> is set, and <a href=https://fetch.spec.whatwg.org/#concept-request-redirect-mode id=downloading-or-updating-an-application-cache:concept-request-redirect-mode data-x-internal=concept-request-redirect-mode>redirect mode</a> is "<code>manual</code>".<li><p><a href=https://fetch.spec.whatwg.org/#concept-fetch id=downloading-or-updating-an-application-cache:concept-fetch-2 data-x-internal=concept-fetch>Fetch</a> <var>request</var>. If this is an
     <a href=#concept-appcache-upgrade id=downloading-or-updating-an-application-cache:concept-appcache-upgrade-3>upgrade attempt</a>, then use the <a href=#concept-appcache-newer id=downloading-or-updating-an-application-cache:concept-appcache-newer-4>newest</a> <a href=#application-cache id=downloading-or-updating-an-application-cache:application-cache-15>application cache</a> in <var>cache
     group</var> as an HTTP cache, and honor HTTP caching semantics (such as expiration, ETags, and
     so forth) with respect to that cache. User agents may also have other caches in place that are
     also honored.<li>

      <p>If the previous step fails (e.g. the server returns a 4xx or 5xx response, or there is a
      DNS error, or the connection times out, or the user cancels the download), or if the server
      returned a redirect, or if the resource is labeled with the "no-store" cache directive, then
      run the first appropriate step from the following list: <a href=#refsHTTP>[HTTP]</a></p>

      <dl class=switch><dt>If the URL being processed was flagged as an "explicit entry" or a "fallback entry"<dd>

        <p>If these steps are being run in parallel for any other URLs in <var>file
        list</var>, then abort these steps for those other URLs. Run the <a href=#cache-failure-steps id=downloading-or-updating-an-application-cache:cache-failure-steps-3>cache failure
        steps</a>.</p>

        <p class=note>Redirects are fatal because they are either indicative of a network problem
        (e.g. a captive portal); or would allow resources to be added to the cache under URLs that
        differ from any URL that the networking model will allow access to, leaving orphan entries;
        or would allow resources to be stored under URLs different than their true URLs. All of
        these situations are bad.</p>

       <dt>If the error was a 404 or 410 HTTP response<dt>If the resource was labeled with the "no-store" cache directive<dd>

        <p>Skip this resource. It is dropped from the cache.</p>

       <dt>Otherwise<dd>

        <p>Copy the resource and its metadata from the <a href=#concept-appcache-newer id=downloading-or-updating-an-application-cache:concept-appcache-newer-5>newest</a> <a href=#application-cache id=downloading-or-updating-an-application-cache:application-cache-16>application cache</a> in <var>cache group</var> whose <a href=#concept-appcache-completeness id=downloading-or-updating-an-application-cache:concept-appcache-completeness-4>completeness
        flag</a> is <i>complete</i>, and act as if that was the fetched resource, ignoring the
        resource obtained from the network.</p>

       </dl>

      <p>User agents may warn the user of these errors as an aid to development.</p>

      <p class=note>These rules make errors for resources listed in the manifest fatal, while
      making it possible for other resources to be removed from caches when they are removed from
      the server, without errors, and making non-manifest resources survive server-side errors.</p>

      <p class=note>Except for the "no-store" directive, HTTP caching rules that would cause a
      file to be expired or otherwise not cached are ignored for the purposes of the
      <a href=#application-cache-download-process id=downloading-or-updating-an-application-cache:application-cache-download-process-9>application cache download process</a>.</p>

     <li>

      <p>Otherwise, the fetching succeeded. Store the resource in the <var>new
      cache</var>.</p>

      <p>If the user agent is not able to store the resource (e.g. because of quota restrictions),
      the user agent may prompt the user or try to resolve the problem in some other manner (e.g.
      automatically pruning content in other caches). If the problem cannot be resolved, the user
      agent must run the <a href=#cache-failure-steps id=downloading-or-updating-an-application-cache:cache-failure-steps-4>cache failure steps</a>.</p>

     <li><p>If the URL being processed was flagged as an "explicit entry" in <var>file
     list</var>, then categorize the entry as an <a href=#concept-appcache-explicit id=downloading-or-updating-an-application-cache:concept-appcache-explicit-3>explicit
     entry</a>.<li><p>If the URL being processed was flagged as a "fallback entry" in <var>file
     list</var>, then categorize the entry as a <a href=#concept-appcache-fallback id=downloading-or-updating-an-application-cache:concept-appcache-fallback-3>fallback
     entry</a>.<li><p>If the URL being processed was flagged as an "master entry" in <var>file
     list</var>, then categorize the entry as a <a href=#concept-appcache-master id=downloading-or-updating-an-application-cache:concept-appcache-master-5>master
     entry</a>.<li><p>As an optimization, if the resource is an HTML or XML file whose <a id=downloading-or-updating-an-application-cache:document-element href=https://dom.spec.whatwg.org/#document-element data-x-internal=document-element>document
     element</a> is an <code id=downloading-or-updating-an-application-cache:the-html-element><a href=#the-html-element>html</a></code> element with a <code id=downloading-or-updating-an-application-cache:attr-html-manifest><a href=#attr-html-manifest>manifest</a></code> attribute whose value doesn't match the manifest
     URL of the application cache being processed, then the user agent should mark the entry as
     being <a href=#concept-appcache-foreign id=downloading-or-updating-an-application-cache:concept-appcache-foreign>foreign</a>.</p>

    </ol>

   <li>
    <p>For each <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-18>cache host</a> associated with an <a href=#application-cache id=downloading-or-updating-an-application-cache:application-cache-17>application cache</a> in
    <var>cache group</var>, <a href=#queue-a-progress-post-load-task id=downloading-or-updating-an-application-cache:queue-a-progress-post-load-task-2>queue a progress post-load task</a> to run these steps:</p>

    <ol><li><p>Let <var>showProgress</var> be the result of <a href=https://dom.spec.whatwg.org/#concept-event-fire id=downloading-or-updating-an-application-cache:concept-event-fire-11 data-x-internal=concept-event-fire>firing an
     event </a> named <code id=downloading-or-updating-an-application-cache:event-appcache-progress-2><a href=#event-appcache-progress>progress</a></code> at the
     <code id=downloading-or-updating-an-application-cache:applicationcache-12><a href=#applicationcache>ApplicationCache</a></code> singleton of the <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-19>cache host</a>, using
     <code id=downloading-or-updating-an-application-cache:progressevent-2><a data-x-internal=progressevent href=https://xhr.spec.whatwg.org/#interface-progressevent>ProgressEvent</a></code>, with the <code id=downloading-or-updating-an-application-cache:dom-event-cancelable-11><a data-x-internal=dom-event-cancelable href=https://dom.spec.whatwg.org/#dom-event-cancelable>cancelable</a></code>
     attribute initialized to true, the <code id=downloading-or-updating-an-application-cache:dom-progressevent-lengthcomputable-2><a data-x-internal=dom-progressevent-lengthcomputable href=https://xhr.spec.whatwg.org/#dom-progressevent-lengthcomputable>lengthComputable</a></code> attribute initialized to
     true, and the <code id=downloading-or-updating-an-application-cache:dom-progressevent-total-2><a data-x-internal=dom-progressevent-total href=https://xhr.spec.whatwg.org/#dom-progressevent-total>total</a></code> and <code id=downloading-or-updating-an-application-cache:dom-progressevent-loaded-2><a data-x-internal=dom-progressevent-loaded href=https://xhr.spec.whatwg.org/#dom-progressevent-loaded>loaded</a></code> attributes initialized to the number of files
     in <var>file list</var>. <a href=#refsXHR>[XHR]</a><li><p>If <var>showProgress</var> is true and the user agent <a href=#shows-caching-progress id=downloading-or-updating-an-application-cache:shows-caching-progress-11>shows caching
     progress</a>, then display some sort of user interface indicating to the user that all the
     files have been downloaded. </ol>
   <li><p>Store the list of <a href=#concept-appcache-fallback-ns id=downloading-or-updating-an-application-cache:concept-appcache-fallback-ns-2>fallback namespaces</a>,
   and the URLs of the <a href=#concept-appcache-fallback id=downloading-or-updating-an-application-cache:concept-appcache-fallback-4>fallback entries</a> that they map
   to, in <var>new cache</var>.<li><p>Store the URLs that form the new <a href=#concept-appcache-onlinesafelist id=downloading-or-updating-an-application-cache:concept-appcache-onlinesafelist-2>online
   safelist</a> in <var>new cache</var>.<li><p>Store the value of the new <a href=#concept-appcache-onlinesafelist-wildcard id=downloading-or-updating-an-application-cache:concept-appcache-onlinesafelist-wildcard-2>online
   safelist wildcard flag</a> in <var>new cache</var>.<li><p>Store the value of the new <a href=#concept-appcache-mode id=downloading-or-updating-an-application-cache:concept-appcache-mode-2>cache mode flag</a> in
   <var>new cache</var>.<li>

    <p>For each entry in <var>cache group</var>'s <a href=#concept-appcache-pending-masters id=downloading-or-updating-an-application-cache:concept-appcache-pending-masters-6>list of pending master entries</a>, wait for the
    resource for this entry to have either completely downloaded or failed.</p>

    <p>If the download failed (e.g. the server returns a 4xx or 5xx response, or there is a DNS
    error, the connection times out, or the user cancels the download), or if the resource is
    labeled with the "no-store" cache directive, then run these substeps:</p>

    <ol><li><p>Unassociate the <code id=downloading-or-updating-an-application-cache:document-7><a href=#document>Document</a></code> for this entry from <var>new
     cache</var>.<li>
      <p><a href=#queue-a-post-load-task id=downloading-or-updating-an-application-cache:queue-a-post-load-task-8>Queue a post-load task</a> to run these steps:</p>

      <ol><li><p>Let <var>showProgress</var> be the result of <a href=https://dom.spec.whatwg.org/#concept-event-fire id=downloading-or-updating-an-application-cache:concept-event-fire-12 data-x-internal=concept-event-fire>firing
       an event</a> named <code id=downloading-or-updating-an-application-cache:event-appcache-error-3><a href=#event-appcache-error>error</a></code> at the
       <code id=downloading-or-updating-an-application-cache:applicationcache-13><a href=#applicationcache>ApplicationCache</a></code> singleton of the <code id=downloading-or-updating-an-application-cache:document-8><a href=#document>Document</a></code> for this entry, if there
       still is one, with the <code id=downloading-or-updating-an-application-cache:dom-event-cancelable-12><a data-x-internal=dom-event-cancelable href=https://dom.spec.whatwg.org/#dom-event-cancelable>cancelable</a></code> attribute
       initialized to true.<li><p>If <var>showProgress</var> is true and the user agent <a href=#shows-caching-progress id=downloading-or-updating-an-application-cache:shows-caching-progress-12>shows caching
       progress</a>, then display some sort of user interface indicating to the user that the
       user agent failed to save the application for offline use.</ol>
     <li>

      <p>If this is a <a href=#concept-appcache-cache id=downloading-or-updating-an-application-cache:concept-appcache-cache-2>cache attempt</a> and this entry is
      the last entry in <var>cache group</var>'s <a href=#concept-appcache-pending-masters id=downloading-or-updating-an-application-cache:concept-appcache-pending-masters-7>list of pending master entries</a>, then run these
      further substeps:</p>

      <ol><li><p>Discard <var>cache group</var> and its only <a href=#application-cache id=downloading-or-updating-an-application-cache:application-cache-18>application cache</a>,
       <var>new cache</var>.</p>

       <li><p>If appropriate, remove any user interface indicating that an update for this cache is
       in progress.<li><p>Abort the <a href=#application-cache-download-process id=downloading-or-updating-an-application-cache:application-cache-download-process-10>application cache download process</a>.</ol>

     <li><p>Otherwise, remove this entry from <var>cache group</var>'s <a href=#concept-appcache-pending-masters id=downloading-or-updating-an-application-cache:concept-appcache-pending-masters-8>list of pending master entries</a>.</ol>

    <p>Otherwise, store the resource for this entry in <var>new cache</var>, if it isn't
    already there, and categorize its entry as a <a href=#concept-appcache-master id=downloading-or-updating-an-application-cache:concept-appcache-master-6>master
    entry</a>.</p>

   <li><p>Let <var>request</var> be a new <a href=https://fetch.spec.whatwg.org/#concept-request id=downloading-or-updating-an-application-cache:concept-request-3 data-x-internal=concept-request>request</a> whose
   <a href=https://fetch.spec.whatwg.org/#concept-request-url id=downloading-or-updating-an-application-cache:concept-request-url-3 data-x-internal=concept-request-url>url</a> is <var>manifest URL</var>, <a href=https://fetch.spec.whatwg.org/#concept-request-client id=downloading-or-updating-an-application-cache:concept-request-client-3 data-x-internal=concept-request-client>client</a> is null, <a href=https://fetch.spec.whatwg.org/#concept-request-destination id=downloading-or-updating-an-application-cache:concept-request-destination-3 data-x-internal=concept-request-destination>destination</a> is the empty string,
   <a href=https://fetch.spec.whatwg.org/#concept-request-referrer id=downloading-or-updating-an-application-cache:concept-request-referrer-3 data-x-internal=concept-request-referrer>referrer</a> is "<code>no-referrer</code>",
   <a id=downloading-or-updating-an-application-cache:synchronous-flag-3 href=https://fetch.spec.whatwg.org/#synchronous-flag data-x-internal=synchronous-flag>synchronous flag</a> is set, <a href=https://fetch.spec.whatwg.org/#concept-request-credentials-mode id=downloading-or-updating-an-application-cache:concept-request-credentials-mode-3 data-x-internal=concept-request-credentials-mode>credentials
   mode</a> is "<code>include</code>", and whose <a id=downloading-or-updating-an-application-cache:use-url-credentials-flag-3 href=https://fetch.spec.whatwg.org/#concept-request-use-url-credentials-flag data-x-internal=use-url-credentials-flag>use-URL-credentials
   flag</a> is set.<li>

    <p>Let <var>second manifest</var> be the result of <a href=https://fetch.spec.whatwg.org/#concept-fetch id=downloading-or-updating-an-application-cache:concept-fetch-3 data-x-internal=concept-fetch>fetching</a> <var>request</var>. HTTP caching semantics should again
    be honored for this request.</p>

    <p class=note>Since caching can be honored, authors are encouraged to avoid setting the cache
    headers on the manifest in such a way that the user agent would simply not contact the network
    for this second request; otherwise, the user agent would not notice if the cache had changed
    during the cache update process.</p>

   <li>

    <p>If the previous step failed for any reason, or if the fetching attempt involved a redirect,
    or if <var>second manifest</var> and <var>manifest</var> are not byte-for-byte
    identical, then schedule a rerun of the entire algorithm with the same parameters after a short
    delay, and run the <a href=#cache-failure-steps id=downloading-or-updating-an-application-cache:cache-failure-steps-5>cache failure steps</a>.</p>

   <li>

    <p>Otherwise, store <var>manifest</var> in <var>new cache</var>, if it's not
    there already, and categorize its entry as <a href=#concept-appcache-manifest id=downloading-or-updating-an-application-cache:concept-appcache-manifest-4>the
    manifest</a>.</p>

   <li><p>Set the <a href=#concept-appcache-completeness id=downloading-or-updating-an-application-cache:concept-appcache-completeness-5>completeness flag</a> of <var>new cache</var> to <i>complete</i>.<li><p>Let <var>task list</var> be an empty list of <a href=#concept-task id=downloading-or-updating-an-application-cache:concept-task-10>tasks</a>.</p>

   <li>

    <p>If this is a <a href=#concept-appcache-cache id=downloading-or-updating-an-application-cache:concept-appcache-cache-3>cache attempt</a>, then for each
    <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-20>cache host</a> associated with an <a href=#application-cache id=downloading-or-updating-an-application-cache:application-cache-19>application cache</a> in <var>cache
    group</var>, create a <a href=#concept-task id=downloading-or-updating-an-application-cache:concept-task-11>task</a> to run these steps and append it
    to <var>task list</var>:

    <ol><li><p>Let <var>showProgress</var> be the result of <a href=https://dom.spec.whatwg.org/#concept-event-fire id=downloading-or-updating-an-application-cache:concept-event-fire-13 data-x-internal=concept-event-fire>firing an
     event</a> named <code id=downloading-or-updating-an-application-cache:event-appcache-cached><a href=#event-appcache-cached>cached</a></code> at the
     <code id=downloading-or-updating-an-application-cache:applicationcache-14><a href=#applicationcache>ApplicationCache</a></code> singleton of the <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-21>cache host</a>, with the <code id=downloading-or-updating-an-application-cache:dom-event-cancelable-13><a data-x-internal=dom-event-cancelable href=https://dom.spec.whatwg.org/#dom-event-cancelable>cancelable</a></code> attribute initialized to true.<li><p>If <var>showProgress</var> is true and the user agent <a href=#shows-caching-progress id=downloading-or-updating-an-application-cache:shows-caching-progress-13>shows caching
     progress</a>, then display some sort of user interface indicating to the user that the
     application has been cached and that they can now use it offline.</ol>

    <p>Otherwise, it is an <a href=#concept-appcache-upgrade id=downloading-or-updating-an-application-cache:concept-appcache-upgrade-4>upgrade attempt</a>. For each
    <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-22>cache host</a> associated with an <a href=#application-cache id=downloading-or-updating-an-application-cache:application-cache-20>application cache</a> in <var>cache
    group</var>, create a <a href=#concept-task id=downloading-or-updating-an-application-cache:concept-task-12>task</a> to run these steps and append it
    to <var>task list</var>:</p>

    <ol><li><p>Let <var>showProgress</var> be the result of <a href=https://dom.spec.whatwg.org/#concept-event-fire id=downloading-or-updating-an-application-cache:concept-event-fire-14 data-x-internal=concept-event-fire>firing an
     event</a> named <code id=downloading-or-updating-an-application-cache:event-appcache-updateready><a href=#event-appcache-updateready>updateready</a></code> at the
     <code id=downloading-or-updating-an-application-cache:applicationcache-15><a href=#applicationcache>ApplicationCache</a></code> singleton of the <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-23>cache host</a>, with the <code id=downloading-or-updating-an-application-cache:dom-event-cancelable-14><a data-x-internal=dom-event-cancelable href=https://dom.spec.whatwg.org/#dom-event-cancelable>cancelable</a></code> attribute initialized to true.<li><p>If <var>showProgress</var> is true and the user agent <a href=#shows-caching-progress id=downloading-or-updating-an-application-cache:shows-caching-progress-14>shows caching
     progress</a>, then display some sort of user interface indicating to the user that a new
     version is available and that they can activate it by reloading the page.</ol>

   <li><p>If appropriate, remove any user interface indicating that an update for this cache is in
   progress.<li><p>Set the <a href=#concept-appcache-status id=downloading-or-updating-an-application-cache:concept-appcache-status-8>update status</a> of <var>cache
   group</var> to <i>idle</i>.<li><p>For each <a href=#concept-task id=downloading-or-updating-an-application-cache:concept-task-13>task</a> in <var>task list</var>, <a href=#queue-a-post-load-task id=downloading-or-updating-an-application-cache:queue-a-post-load-task-9>queue that task as a post-load task</a>.</ol>

  <p>The <dfn id=cache-failure-steps>cache failure steps</dfn> are as follows:</p>

  <ol><li><p>Let <var>task list</var> be an empty list of <a href=#concept-task id=downloading-or-updating-an-application-cache:concept-task-14>tasks</a>.</p>

   <li>

    <p>For each entry in <var>cache group</var>'s <a href=#concept-appcache-pending-masters id=downloading-or-updating-an-application-cache:concept-appcache-pending-masters-9>list of pending master entries</a>, run the
    following further substeps. These steps may be run in parallel for two or more entries at a
    time.</p>

    <ol><li><p>Wait for the resource for this entry to have either completely downloaded or failed.</p>

     <li><p>Unassociate the <code id=downloading-or-updating-an-application-cache:document-9><a href=#document>Document</a></code> for this entry from its <a href=#application-cache id=downloading-or-updating-an-application-cache:application-cache-21>application
     cache</a>, if it has one.<li>
      <p>Create a <a href=#concept-task id=downloading-or-updating-an-application-cache:concept-task-15>task</a> to run these steps and append it to
      <var>task list</var>:</p>

      <ol><li><p>Let <var>showProgress</var> be the result of <a href=https://dom.spec.whatwg.org/#concept-event-fire id=downloading-or-updating-an-application-cache:concept-event-fire-15 data-x-internal=concept-event-fire>firing
       an event</a> named <code id=downloading-or-updating-an-application-cache:event-appcache-error-4><a href=#event-appcache-error>error</a></code> at the
       <code id=downloading-or-updating-an-application-cache:applicationcache-16><a href=#applicationcache>ApplicationCache</a></code> singleton of the <code id=downloading-or-updating-an-application-cache:document-10><a href=#document>Document</a></code> for this entry, if there
       still is one, with the <code id=downloading-or-updating-an-application-cache:dom-event-cancelable-15><a data-x-internal=dom-event-cancelable href=https://dom.spec.whatwg.org/#dom-event-cancelable>cancelable</a></code> attribute
       initialized to true.<li><p>If <var>showProgress</var> is true and the user agent <a href=#shows-caching-progress id=downloading-or-updating-an-application-cache:shows-caching-progress-15>shows caching
       progress</a>, then display some sort of user interface indicating to the user that the
       user agent failed to save the application for offline use.</ol>
     </ol>

   <li>
    <p>For each <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-24>cache host</a> still associated with an <a href=#application-cache id=downloading-or-updating-an-application-cache:application-cache-22>application cache</a> in
    <var>cache group</var>, create a <a href=#concept-task id=downloading-or-updating-an-application-cache:concept-task-16>task</a> to run these steps and
    append it to <var>task list</var>:</p>

    <ol><li><p>Let <var>showProgress</var> be the result of <a href=https://dom.spec.whatwg.org/#concept-event-fire id=downloading-or-updating-an-application-cache:concept-event-fire-16 data-x-internal=concept-event-fire>firing an
     event</a> named <code id=downloading-or-updating-an-application-cache:event-appcache-error-5><a href=#event-appcache-error>error</a></code> at the
     <code id=downloading-or-updating-an-application-cache:applicationcache-17><a href=#applicationcache>ApplicationCache</a></code> singleton of the <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-25>cache host</a>, with the <code id=downloading-or-updating-an-application-cache:dom-event-cancelable-16><a data-x-internal=dom-event-cancelable href=https://dom.spec.whatwg.org/#dom-event-cancelable>cancelable</a></code> attribute initialized to true.<li><p>If <var>showProgress</var> is true and the user agent <a href=#shows-caching-progress id=downloading-or-updating-an-application-cache:shows-caching-progress-16>shows caching
     progress</a>, then display some sort of user interface indicating to the user that the user
     agent failed to save the application for offline use.</ol>
   <li><p>Empty <var>cache group</var>'s <a href=#concept-appcache-pending-masters id=downloading-or-updating-an-application-cache:concept-appcache-pending-masters-10>list of pending master entries</a>.<li><p>If <var>cache group</var> has an <a href=#application-cache id=downloading-or-updating-an-application-cache:application-cache-23>application cache</a> whose <a href=#concept-appcache-completeness id=downloading-or-updating-an-application-cache:concept-appcache-completeness-6>completeness flag</a> is <i>incomplete</i>, then discard
   that <a href=#application-cache id=downloading-or-updating-an-application-cache:application-cache-24>application cache</a>.</p>

   <li><p>If appropriate, remove any user interface indicating that an update for this cache is in
   progress.<li><p>Let the <a href=#concept-appcache-status id=downloading-or-updating-an-application-cache:concept-appcache-status-9>status</a> of <var>cache
   group</var> be <i>idle</i>.<li><p>If this was a <a href=#concept-appcache-cache id=downloading-or-updating-an-application-cache:concept-appcache-cache-4>cache attempt</a>, discard <var>cache group</var> altogether.</p>

   <li><p>For each <a href=#concept-task id=downloading-or-updating-an-application-cache:concept-task-17>task</a> in <var>task list</var>, <a href=#queue-a-post-load-task id=downloading-or-updating-an-application-cache:queue-a-post-load-task-10>queue that task as a post-load task</a>.<li><p>Abort the <a href=#application-cache-download-process id=downloading-or-updating-an-application-cache:application-cache-download-process-11>application cache download process</a>.</ol>

  <p>Attempts to fetch resources as part of the <a href=#application-cache-download-process id=downloading-or-updating-an-application-cache:application-cache-download-process-12>application cache download process</a> may
  be done with cache-defeating semantics, to avoid problems with stale or inconsistent intermediary
  caches.</p>

  <hr>

  <p>User agents may invoke the <a href=#application-cache-download-process id=downloading-or-updating-an-application-cache:application-cache-download-process-13>application cache download process</a>, in the background,
  for any <a href=#application-cache-group id=downloading-or-updating-an-application-cache:application-cache-group-8>application cache group</a>, at any time (with no <a href=#cache-host id=downloading-or-updating-an-application-cache:cache-host-26>cache host</a>). This
  allows user agents to keep caches primed and to update caches even before the user visits a
  site.</p>

  <hr>

  <p>Each <code id=downloading-or-updating-an-application-cache:document-11><a href=#document>Document</a></code> has a list of <dfn id=pending-application-cache-download-process-tasks>pending application cache download process
  tasks</dfn> that is used to delay events fired by the algorithm above until the document's <code id=downloading-or-updating-an-application-cache:event-load-2><a href=#event-load>load</a></code> event has fired. When the <code id=downloading-or-updating-an-application-cache:document-12><a href=#document>Document</a></code> is created, the
  list must be empty.</p>

  <p>When the steps above say to <dfn id=queue-a-post-load-task>queue a post-load task</dfn> <var>task</var>, where
  <var>task</var> is a <a href=#concept-task id=downloading-or-updating-an-application-cache:concept-task-18>task</a> that dispatches an event on a
  target <code id=downloading-or-updating-an-application-cache:applicationcache-18><a href=#applicationcache>ApplicationCache</a></code> object <var>target</var>, the user agent must run
  the appropriate steps from the following list:</p>

  <dl><dt>If <var>target</var>'s <a id=downloading-or-updating-an-application-cache:node-document href=https://dom.spec.whatwg.org/#concept-node-document data-x-internal=node-document>node document</a> is
   <a href=#ready-for-post-load-tasks id=downloading-or-updating-an-application-cache:ready-for-post-load-tasks>ready for post-load tasks</a><dd><p><a href=#queue-a-task id=downloading-or-updating-an-application-cache:queue-a-task>Queue</a> the task <var>task</var>.<dt>Otherwise<dd><p>Add <var>task</var> to <var>target</var>'s <a id=downloading-or-updating-an-application-cache:node-document-2 href=https://dom.spec.whatwg.org/#concept-node-document data-x-internal=node-document>node document</a>'s list
   of <a href=#pending-application-cache-download-process-tasks id=downloading-or-updating-an-application-cache:pending-application-cache-download-process-tasks>pending application cache download process tasks</a>.</dl>

  <p>When the steps above say to <dfn id=queue-a-progress-post-load-task>queue a progress post-load task</dfn> <var>task</var>, where
  <var>task</var> is a <a href=#concept-task id=downloading-or-updating-an-application-cache:concept-task-19>task</a> that dispatches an event on a
  target <code id=downloading-or-updating-an-application-cache:applicationcache-19><a href=#applicationcache>ApplicationCache</a></code> object <var>target</var>, the user agent must run
  the following steps:</p>

  <ol><li><p>If there is a <var>task</var> in <var>target</var>'s <a id=downloading-or-updating-an-application-cache:node-document-3 href=https://dom.spec.whatwg.org/#concept-node-document data-x-internal=node-document>node document</a>'s list
   of <a href=#pending-application-cache-download-process-tasks id=downloading-or-updating-an-application-cache:pending-application-cache-download-process-tasks-2>pending application cache download process tasks</a> that is labeled as a
   <i>progress task</i>, then remove that task from the list.<li><p>Label <var>task</var> as a <i>progress task</i>.<li><p><a href=#queue-a-post-load-task id=downloading-or-updating-an-application-cache:queue-a-post-load-task-11>Queue a post-load task</a> <var>task</var>.</ol>

  <p>The <a href=#task-source id=downloading-or-updating-an-application-cache:task-source>task source</a> for these <a href=#concept-task id=downloading-or-updating-an-application-cache:concept-task-20>tasks</a> is the
  <a href=#networking-task-source id=downloading-or-updating-an-application-cache:networking-task-source>networking task source</a>.</p>




  <h4 id=the-application-cache-selection-algorithm>7.9.5 The application cache selection algorithm<a href=#the-application-cache-selection-algorithm class=self-link></a></h4>

  <p>When the <dfn id=concept-appcache-init>application cache selection algorithm</dfn>
  algorithm is invoked with a <code id=the-application-cache-selection-algorithm:document><a href=#document>Document</a></code> <var>document</var> and optionally a
  manifest <a id=the-application-cache-selection-algorithm:url href=https://url.spec.whatwg.org/#concept-url data-x-internal=url>URL</a> <var>manifest URL</var>, the user agent must run the first
  applicable set of steps from the following list:</p>

  <dl class=switch><dt>If there is a <var>manifest URL</var>, and <var>document</var> was loaded
   from an <a href=#application-cache id=the-application-cache-selection-algorithm:application-cache>application cache</a>, and the URL of the <a href=#concept-appcache-manifest id=the-application-cache-selection-algorithm:concept-appcache-manifest>manifest</a> of that cache's <a href=#application-cache-group id=the-application-cache-selection-algorithm:application-cache-group>application cache
   group</a> is <em>not</em> the same as <var>manifest URL</var><dd>

    <p>Mark the entry for the resource from which <var>document</var> was taken in the
    <a href=#application-cache id=the-application-cache-selection-algorithm:application-cache-2>application cache</a> from which it was loaded as <a href=#concept-appcache-foreign id=the-application-cache-selection-algorithm:concept-appcache-foreign>foreign</a>.</p>

    <p>Restart the current navigation from the top of the <a href=#navigate id=the-application-cache-selection-algorithm:navigate>navigation
    algorithm</a>, undoing any changes that were made as part of the initial load (changes can be
    avoided by ensuring that the step to <a href=#update-the-session-history-with-the-new-page id=the-application-cache-selection-algorithm:update-the-session-history-with-the-new-page>update the session history with the new page</a>
    is only ever completed <em>after</em> this <a href=#concept-appcache-init id=the-application-cache-selection-algorithm:concept-appcache-init>application cache
    selection algorithm</a> is run, though this is not required).</p>

    <p class=note>The navigation will not result in the same resource being loaded, because
    "foreign" entries are never picked during navigation.</p>

    <p>User agents may notify the user of the inconsistency between the cache manifest and the
    document's own metadata, to aid in application development.</p>

   <dt>If <var>document</var> was loaded from an <a href=#application-cache id=the-application-cache-selection-algorithm:application-cache-3>application cache</a>, and that
   <a href=#application-cache id=the-application-cache-selection-algorithm:application-cache-4>application cache</a> still exists (it is not now <a href=#concept-appcache-obsolete id=the-application-cache-selection-algorithm:concept-appcache-obsolete>obsolete</a>)<dd>

    <p>Associate <var>document</var> with the <a href=#application-cache id=the-application-cache-selection-algorithm:application-cache-5>application cache</a> from which it
    was loaded. Invoke, in the background, the <a href=#application-cache-download-process id=the-application-cache-selection-algorithm:application-cache-download-process>application cache download process</a> for
    that <a href=#application-cache id=the-application-cache-selection-algorithm:application-cache-6>application cache</a>'s <a href=#application-cache-group id=the-application-cache-selection-algorithm:application-cache-group-2>application cache group</a>, with <var>document</var> as the <a href=#cache-host id=the-application-cache-selection-algorithm:cache-host>cache host</a>.</p>

   <dt>If <var>document</var>  was loaded using `<code>GET</code>`, and, there is a
   <var>manifest URL</var>, and <var>manifest URL</var> has the <a href=#same-origin id=the-application-cache-selection-algorithm:same-origin>same origin</a> as
   <var>document</var><dd>

    <p>Invoke, in the background, the <a href=#application-cache-download-process id=the-application-cache-selection-algorithm:application-cache-download-process-2>application cache download process</a> for <var>manifest URL</var>, with <var>document</var> as the <a href=#cache-host id=the-application-cache-selection-algorithm:cache-host-2>cache host</a>
    and with the resource from which <var>document</var> was parsed as the <a href=#concept-appcache-master id=the-application-cache-selection-algorithm:concept-appcache-master>master</a> resource.</p>

    <p>If there are <a href=#relevant-application-cache id=the-application-cache-selection-algorithm:relevant-application-cache>relevant application caches</a> that
    are identified by a URL with the <a href=#same-origin id=the-application-cache-selection-algorithm:same-origin-2>same origin</a> as the URL of <var>document</var>, and that have this URL as one of their entries, excluding entries
    marked as <a href=#concept-appcache-foreign id=the-application-cache-selection-algorithm:concept-appcache-foreign-2>foreign</a>, then the user agent should use
    the <a href=#concept-appcache-selection id=the-application-cache-selection-algorithm:concept-appcache-selection>most appropriate application cache</a> of those
    that match as an HTTP cache for any subresource loads. User agents may also have other caches in
    place that are also honored.</p>

   <dt>Otherwise<dd>

    <p>The <code id=the-application-cache-selection-algorithm:document-2><a href=#document>Document</a></code> is not associated with any <a href=#application-cache id=the-application-cache-selection-algorithm:application-cache-7>application cache</a>.</p>

    <p>If there was a <var>manifest URL</var>, the user agent may report to the user that
    it was ignored, to aid in application development.</p>

   </dl>



  <h4 id=changesToNetworkingModel>7.9.6 Changes to the networking model<a href=#changesToNetworkingModel class=self-link></a></h4>

  <p class=XXX>If "AppCache" is not removed as a feature this
  section needs to be integrated into the Fetch standard.</p>

  <p>When a <a href=#cache-host id=changesToNetworkingModel:cache-host>cache host</a> is associated with an <a href=#application-cache id=changesToNetworkingModel:application-cache>application cache</a> whose <a href=#concept-appcache-completeness id=changesToNetworkingModel:concept-appcache-completeness>completeness flag</a> is <i>complete</i>, any and all
  loads for resources related to that <a href=#cache-host id=changesToNetworkingModel:cache-host-2>cache host</a> other than those for <a href=#child-browsing-context id=changesToNetworkingModel:child-browsing-context>child browsing contexts</a> must go through the following steps
  instead of immediately invoking the mechanisms appropriate to that resource's scheme:</p>

  <ol><li><p>If the resource is not to be fetched using the GET method, or if applying the <a id=changesToNetworkingModel:url-parser href=https://url.spec.whatwg.org/#concept-url-parser data-x-internal=url-parser>URL
   parser</a> algorithm to both its <a id=changesToNetworkingModel:url href=https://url.spec.whatwg.org/#concept-url data-x-internal=url>URL</a> and the <a href=#application-cache id=changesToNetworkingModel:application-cache-2>application cache</a>'s
   <a href=#concept-appcache-manifest id=changesToNetworkingModel:concept-appcache-manifest>manifest</a>'s URL results in two <a href=https://url.spec.whatwg.org/#concept-url id=changesToNetworkingModel:url-record data-x-internal=url-record>URL records</a> with different <a href=https://url.spec.whatwg.org/#concept-url-scheme id=changesToNetworkingModel:concept-url-scheme data-x-internal=concept-url-scheme>scheme</a>
   components, then fetch the resource normally and abort these steps.<li><p>If the resource's URL is <a href=#concept-appcache-master id=changesToNetworkingModel:concept-appcache-master>a master entry</a>,
   <a href=#concept-appcache-manifest id=changesToNetworkingModel:concept-appcache-manifest-2>the manifest</a>, <a href=#concept-appcache-explicit id=changesToNetworkingModel:concept-appcache-explicit>an explicit entry</a>, or <a href=#concept-appcache-fallback id=changesToNetworkingModel:concept-appcache-fallback>a fallback entry</a> in the <a href=#application-cache id=changesToNetworkingModel:application-cache-3>application cache</a>,
   then get the resource from the cache (instead of fetching it), and abort these steps.<li><p>If there is an entry in the <a href=#application-cache id=changesToNetworkingModel:application-cache-4>application cache</a>'s <a href=#concept-appcache-onlinesafelist id=changesToNetworkingModel:concept-appcache-onlinesafelist>online safelist</a> that has the <a href=#same-origin id=changesToNetworkingModel:same-origin>same
   origin</a> as the resource's URL and that is a <a href=#prefix-match id=changesToNetworkingModel:prefix-match>prefix match</a> for the resource's
   URL, then fetch the resource normally and abort these steps.<li>

    <p>If the resource's URL has the <a href=#same-origin id=changesToNetworkingModel:same-origin-2>same origin</a> as the manifest's URL, and there is a
    <a href=#concept-appcache-fallback-ns id=changesToNetworkingModel:concept-appcache-fallback-ns>fallback namespace</a> <var>f</var> in
    the <a href=#application-cache id=changesToNetworkingModel:application-cache-5>application cache</a> that is a <a href=#prefix-match id=changesToNetworkingModel:prefix-match-2>prefix match</a> for the resource's URL,
    then:</p>

    <p>Fetch the resource normally. If this results in a redirect to a resource with another
    <a href=#concept-origin id=changesToNetworkingModel:concept-origin>origin</a> (indicative of a captive portal), or a 4xx or 5xx status code, or if there
    were network errors (but not if the user canceled the download), then instead get, from the
    cache, the resource of the <a href=#concept-appcache-fallback id=changesToNetworkingModel:concept-appcache-fallback-2>fallback entry</a>
    corresponding to the <a href=#concept-appcache-fallback-ns id=changesToNetworkingModel:concept-appcache-fallback-ns-2>fallback namespace</a>
    <var>f</var>. Abort these steps.</p>

   <li><p>If the <a href=#application-cache id=changesToNetworkingModel:application-cache-6>application cache</a>'s <a href=#concept-appcache-onlinesafelist-wildcard id=changesToNetworkingModel:concept-appcache-onlinesafelist-wildcard>online safelist wildcard flag</a> is
   <i>open</i>, then fetch the resource normally and abort these steps.<li><p>Fail the resource load as if there had been a generic network error.</ol>

  <p class=note>The above algorithm ensures that so long as the <a href=#concept-appcache-onlinesafelist-wildcard id=changesToNetworkingModel:concept-appcache-onlinesafelist-wildcard-2>online safelist wildcard flag</a> is
  <i>blocking</i>, resources that are not present in the <a href=#concept-appcache-manifest id=changesToNetworkingModel:concept-appcache-manifest-3>manifest</a> will always fail to load (at least, after the
  <a href=#application-cache id=changesToNetworkingModel:application-cache-7>application cache</a> has been primed the first time), making the testing of offline
  applications simpler.</p>

  


  

  <h4 id=expiring-application-caches>7.9.7 Expiring application caches<a href=#expiring-application-caches class=self-link></a></h4>

  <p>As a general rule, user agents should not expire application caches, except on request from the
  user, or after having been left unused for an extended period of time.</p>

  <p>Application caches and cookies have similar implications with respect to privacy (e.g. if the
  site can identify the user when providing the cache, it can store data in the cache that can be
  used for cookie resurrection). Implementors are therefore encouraged to expose application caches
  in a manner related to HTTP cookies, allowing caches to be expunged together with cookies and
  other origin-specific data.</p>

  <p class=example>For example, a user agent could have a "delete site-specific data" feature that
  clears all cookies, application caches, local storage, databases, etc, from an origin all at
  once.</p>

  


  

  <h4 id=disk-space>7.9.8 Disk space<a href=#disk-space class=self-link></a></h4>

  <p>User agents should consider applying constraints on disk usage of <a href=#application-cache id=disk-space:application-cache>application caches</a>, and care should be taken to ensure that the restrictions cannot
  be easily worked around using subdomains.</p>

  <p>User agents should allow users to see how much space each domain is using, and may offer the
  user the ability to delete specific <a href=#application-cache id=disk-space:application-cache-2>application caches</a>.</p>

  <p>For predictability, quotas should be based on the uncompressed size of data stored.</p>
  

  <p class=note>How quotas are presented to the user is not defined by this specification. User
  agents are encouraged to provide features such as allowing a user to indicate that certain sites
  are trusted to use more than the default quota, e.g. by presenting a non-modal user interface
  while a cache is being updated, or by having an explicit safelist in the user agent's
  configuration interface.</p>

  



  <h4 id=security-concerns-with-offline-applications-caches>7.9.9 Security concerns with offline applications caches<a href=#security-concerns-with-offline-applications-caches class=self-link></a></h4>

  <p><i>This section is non-normative.</i></p>

  <p>The main risk introduced by offline application caches is that an injection attack can be
  elevated into persistent site-wide page replacement. This attack involves using an injection
  vulnerability to upload two files to the victim site. The first file is an application cache
  manifest consisting of just a fallback entry pointing to the second file, which is an HTML page
  whose manifest is declared as that first file. Once the user has been directed to that second
  file, all subsequent accesses to any file covered by the given fallback namespace while either the
  user or the site is offline will instead show that second file. Targeted denial-of-service
  attacks or cookie bombing attacks (where the client is made to send so many cookies that the
  server refuses to process the request) can be used to ensure that the site appears offline.</p>

  <p>To mitigate this, manifests can only specify fallbacks that are in the same path as the
  manifest itself. This means that a content injection upload vulnerability in a particular
  directory on a server can only be escalated to a take-over of that directory and its
  subdirectories. If there is no way to inject a file into the root directory, the entire site
  cannot be taken over.</p>

  <p>If a site has been attacked in this way, simply removing the offending manifest might eventually
  clear the problem, since the next time the manifest is updated, a 404 error will be seen, and the
  user agent will clear the cache. "Eventually" is the key word here, however; while the attack on
  the user or server is ongoing, such that connections from an affected user to the affected site
  are blocked, the user agent will simply assume that the user is offline and will continue to use
  the hostile manifest. Unfortunately, if a cookie bombing attack has also been used, merely
  removing the manifest is insufficient; in addition, the server has to be configured to return a
  404 or 410 response instead of the 413 "Request Entity Too Large" response.</p>

  <p>TLS does not inherently protect a site from this attack, since the attack relies on content
  being served from the server itself. Not using application caches also does not prevent this
  attack, since the attack relies on an attacker-provided manifest.</p>



  <h4 id=application-cache-api>7.9.10 Application cache API<a href=#application-cache-api class=self-link></a></h4>

  <pre class=idl>[Exposed=(Window,SharedWorker)]
interface <dfn id=applicationcache>ApplicationCache</dfn> : <a id=application-cache-api:eventtarget href=https://dom.spec.whatwg.org/#interface-eventtarget data-x-internal=eventtarget>EventTarget</a> {

  // <a href=#concept-appcache-status id=application-cache-api:concept-appcache-status>update status</a>
  const unsigned short <a href=#dom-appcache-uncached id=application-cache-api:dom-appcache-uncached>UNCACHED</a> = 0;
  const unsigned short <a href=#dom-appcache-idle id=application-cache-api:dom-appcache-idle>IDLE</a> = 1;
  const unsigned short <a href=#dom-appcache-checking id=application-cache-api:dom-appcache-checking>CHECKING</a> = 2;
  const unsigned short <a href=#dom-appcache-downloading id=application-cache-api:dom-appcache-downloading>DOWNLOADING</a> = 3;
  const unsigned short <a href=#dom-appcache-updateready id=application-cache-api:dom-appcache-updateready>UPDATEREADY</a> = 4;
  const unsigned short <a href=#dom-appcache-obsolete id=application-cache-api:dom-appcache-obsolete>OBSOLETE</a> = 5;
  readonly attribute unsigned short <a href=#dom-appcache-status id=application-cache-api:dom-appcache-status>status</a>;

  // updates
  void <a href=#dom-appcache-update id=application-cache-api:dom-appcache-update>update</a>();
  void <a href=#dom-appcache-abort id=application-cache-api:dom-appcache-abort>abort</a>();
  void <a href=#dom-appcache-swapcache id=application-cache-api:dom-appcache-swapcache>swapCache</a>();

  // events
  attribute <a href=#eventhandler id=application-cache-api:eventhandler>EventHandler</a> <a href=#handler-appcache-onchecking id=application-cache-api:handler-appcache-onchecking>onchecking</a>;
  attribute <a href=#eventhandler id=application-cache-api:eventhandler-2>EventHandler</a> <a href=#handler-appcache-onerror id=application-cache-api:handler-appcache-onerror>onerror</a>;
  attribute <a href=#eventhandler id=application-cache-api:eventhandler-3>EventHandler</a> <a href=#handler-appcache-onnoupdate id=application-cache-api:handler-appcache-onnoupdate>onnoupdate</a>;
  attribute <a href=#eventhandler id=application-cache-api:eventhandler-4>EventHandler</a> <a href=#handler-appcache-ondownloading id=application-cache-api:handler-appcache-ondownloading>ondownloading</a>;
  attribute <a href=#eventhandler id=application-cache-api:eventhandler-5>EventHandler</a> <a href=#handler-appcache-onprogress id=application-cache-api:handler-appcache-onprogress>onprogress</a>;
  attribute <a href=#eventhandler id=application-cache-api:eventhandler-6>EventHandler</a> <a href=#handler-appcache-onupdateready id=application-cache-api:handler-appcache-onupdateready>onupdateready</a>;
  attribute <a href=#eventhandler id=application-cache-api:eventhandler-7>EventHandler</a> <a href=#handler-appcache-oncached id=application-cache-api:handler-appcache-oncached>oncached</a>;
  attribute <a href=#eventhandler id=application-cache-api:eventhandler-8>EventHandler</a> <a href=#handler-appcache-onobsolete id=application-cache-api:handler-appcache-onobsolete>onobsolete</a>;
};</pre>

  <dl class=domintro><dt><var>cache</var> = <var>window</var> . <code id=application-cache-api:dom-applicationcache><a href=#dom-applicationcache>applicationCache</a></code><dd>

    <p>(In a window.) Returns the <code id=application-cache-api:applicationcache><a href=#applicationcache>ApplicationCache</a></code> object that applies to the
    <a href=#active-document id=application-cache-api:active-document>active document</a> of that <code id=application-cache-api:window><a href=#window>Window</a></code>.</p>

   <dt><var>cache</var> = <var>self</var> . <code id=application-cache-api:dom-applicationcache-2><a href=#dom-applicationcache>applicationCache</a></code><dd>

    <p>(In a shared worker.) Returns the <code id=application-cache-api:applicationcache-2><a href=#applicationcache>ApplicationCache</a></code> object that applies to the
    current shared worker.</p>

   <dt><var>cache</var> . <code id=application-cache-api:dom-appcache-status-2><a href=#dom-appcache-status>status</a></code><dd>

    <p>Returns the current status of the application cache, as given by the constants defined
    below.</p>

   <dt><var>cache</var> . <code id=application-cache-api:dom-appcache-update-2><a href=#dom-appcache-update>update</a></code>()<dd>

    <p>Invokes the <a href=#application-cache-download-process id=application-cache-api:application-cache-download-process>application cache download process</a>.</p>

    <p>Throws an <a id=application-cache-api:invalidstateerror href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a> <code id=application-cache-api:domexception><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> if there is
    no application cache to update.</p>

    <p>Calling this method is not usually necessary, as user agents will generally take care of
    updating <a href=#application-cache id=application-cache-api:application-cache>application caches</a> automatically.</p>

    <p>The method can be useful in situations such as long-lived applications. For example, a Web
    mail application might stay open in a browser tab for weeks at a time. Such an application could
    want to test for updates each day.</p>

   <dt><var>cache</var> . <code id=application-cache-api:dom-appcache-abort-2><a href=#dom-appcache-abort>abort</a></code>()<dd>

    <p>Cancels the <a href=#application-cache-download-process id=application-cache-api:application-cache-download-process-2>application cache download process</a>.</p>

    <p>This method is intended to be used by Web application showing their own caching progress UI,
    in case the user wants to stop the update (e.g. because bandwidth is limited).</p>

   <dt><var>cache</var> . <code id=application-cache-api:dom-appcache-swapcache-2><a href=#dom-appcache-swapcache>swapCache</a></code>()<dd>

    <p>Switches to the most recent application cache, if there is a newer one. If there isn't,
    throws an <a id=application-cache-api:invalidstateerror-2 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a> <code id=application-cache-api:domexception-2><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code>.</p>

    <p>This does not cause previously-loaded resources to be reloaded; for example, images do not
    suddenly get reloaded and style sheets and scripts do not get reparsed or reevaluated. The only
    change is that subsequent requests for cached resources will obtain the newer copies.</p>

    <p>The <code id=application-cache-api:event-appcache-updateready><a href=#event-appcache-updateready>updateready</a></code> event will fire before this
    method can be called. Once it fires, the Web application can, at its leisure, call this method
    to switch the underlying cache to the one with the more recent updates. To make proper use of
    this, applications have to be able to bring the new features into play; for example, reloading
    scripts to enable new features.</p>

    <p>An easier alternative to <code id=application-cache-api:dom-appcache-swapcache-3><a href=#dom-appcache-swapcache>swapCache()</a></code> is just to
    reload the entire page at a time suitable for the user, using <code id=application-cache-api:dom-location-reload><a href=#dom-location-reload>location.reload()</a></code>.</p>

   </dl>

  

  <p>There is a one-to-one mapping from <a href=#cache-host id=application-cache-api:cache-host>cache hosts</a> to
  <code id=application-cache-api:applicationcache-3><a href=#applicationcache>ApplicationCache</a></code> objects. The <dfn id=dom-applicationcache><code>applicationCache</code></dfn> attribute on <code id=application-cache-api:window-2><a href=#window>Window</a></code>
  objects must return the <code id=application-cache-api:applicationcache-4><a href=#applicationcache>ApplicationCache</a></code> object associated with the
  <code id=application-cache-api:window-3><a href=#window>Window</a></code> object's <a href=#active-document id=application-cache-api:active-document-2>active document</a>. The <dfn id=dom-sharedworkerglobalscope-applicationcache><code>applicationCache</code></dfn> attribute
  on <code id=application-cache-api:sharedworkerglobalscope><a href=#sharedworkerglobalscope>SharedWorkerGlobalScope</a></code> objects must return the <code id=application-cache-api:applicationcache-5><a href=#applicationcache>ApplicationCache</a></code>
  object associated with the worker.</p>

  <p class=note>A <code id=application-cache-api:window-4><a href=#window>Window</a></code> or <code id=application-cache-api:sharedworkerglobalscope-2><a href=#sharedworkerglobalscope>SharedWorkerGlobalScope</a></code> object has an
  associated <code id=application-cache-api:applicationcache-6><a href=#applicationcache>ApplicationCache</a></code> object even if that <a href=#cache-host id=application-cache-api:cache-host-2>cache host</a> has no actual
  <a href=#application-cache id=application-cache-api:application-cache-2>application cache</a>.</p>

  <hr>

  <p>The <dfn id=dom-appcache-status><code>status</code></dfn> attribute, on getting, must
  return the current state of the <a href=#application-cache id=application-cache-api:application-cache-3>application cache</a> that the
  <code id=application-cache-api:applicationcache-7><a href=#applicationcache>ApplicationCache</a></code> object's <a href=#cache-host id=application-cache-api:cache-host-3>cache host</a> is associated with, if any. This
  must be the appropriate value from the following list:</p>

  

  <dl><dt><dfn id=dom-appcache-uncached><code>UNCACHED</code></dfn> (numeric value 0)<dd><p>The <code id=application-cache-api:applicationcache-8><a href=#applicationcache>ApplicationCache</a></code> object's <a href=#cache-host id=application-cache-api:cache-host-4>cache host</a> is not associated with
   an <a href=#application-cache id=application-cache-api:application-cache-4>application cache</a> at this time.<dt><dfn id=dom-appcache-idle><code>IDLE</code></dfn> (numeric value 1)<dd><p>The <code id=application-cache-api:applicationcache-9><a href=#applicationcache>ApplicationCache</a></code> object's <a href=#cache-host id=application-cache-api:cache-host-5>cache host</a> is associated with an
   <a href=#application-cache id=application-cache-api:application-cache-5>application cache</a> whose <a href=#application-cache-group id=application-cache-api:application-cache-group>application cache group</a>'s <a href=#concept-appcache-status id=application-cache-api:concept-appcache-status-2>update status</a> is <i>idle</i>, and that <a href=#application-cache id=application-cache-api:application-cache-6>application
   cache</a> is the <a href=#concept-appcache-newer id=application-cache-api:concept-appcache-newer>newest</a> cache in its
   <a href=#application-cache-group id=application-cache-api:application-cache-group-2>application cache group</a>, and the <a href=#application-cache-group id=application-cache-api:application-cache-group-3>application cache group</a> is not marked
   as <a href=#concept-appcache-obsolete id=application-cache-api:concept-appcache-obsolete>obsolete</a>.<dt><dfn id=dom-appcache-checking><code>CHECKING</code></dfn> (numeric value 2)<dd><p>The <code id=application-cache-api:applicationcache-10><a href=#applicationcache>ApplicationCache</a></code> object's <a href=#cache-host id=application-cache-api:cache-host-6>cache host</a> is associated with an
   <a href=#application-cache id=application-cache-api:application-cache-7>application cache</a> whose <a href=#application-cache-group id=application-cache-api:application-cache-group-4>application cache group</a>'s <a href=#concept-appcache-status id=application-cache-api:concept-appcache-status-3>update status</a> is <i>checking</i>.<dt><dfn id=dom-appcache-downloading><code>DOWNLOADING</code></dfn> (numeric value 3)<dd><p>The <code id=application-cache-api:applicationcache-11><a href=#applicationcache>ApplicationCache</a></code> object's <a href=#cache-host id=application-cache-api:cache-host-7>cache host</a> is associated with an
   <a href=#application-cache id=application-cache-api:application-cache-8>application cache</a> whose <a href=#application-cache-group id=application-cache-api:application-cache-group-5>application cache group</a>'s <a href=#concept-appcache-status id=application-cache-api:concept-appcache-status-4>update status</a> is <i>downloading</i>.<dt><dfn id=dom-appcache-updateready><code>UPDATEREADY</code></dfn> (numeric value 4)<dd><p>The <code id=application-cache-api:applicationcache-12><a href=#applicationcache>ApplicationCache</a></code> object's <a href=#cache-host id=application-cache-api:cache-host-8>cache host</a> is associated with an
   <a href=#application-cache id=application-cache-api:application-cache-9>application cache</a> whose <a href=#application-cache-group id=application-cache-api:application-cache-group-6>application cache group</a>'s <a href=#concept-appcache-status id=application-cache-api:concept-appcache-status-5>update status</a> is <i>idle</i>, and whose <a href=#application-cache-group id=application-cache-api:application-cache-group-7>application
   cache group</a> is not marked as <a href=#concept-appcache-obsolete id=application-cache-api:concept-appcache-obsolete-2>obsolete</a>, but
   that <a href=#application-cache id=application-cache-api:application-cache-10>application cache</a> is <em>not</em> the <a href=#concept-appcache-newer id=application-cache-api:concept-appcache-newer-2>newest</a> cache in its group.<dt><dfn id=dom-appcache-obsolete><code>OBSOLETE</code></dfn> (numeric value 5)<dd><p>The <code id=application-cache-api:applicationcache-13><a href=#applicationcache>ApplicationCache</a></code> object's <a href=#cache-host id=application-cache-api:cache-host-9>cache host</a> is associated with an
   <a href=#application-cache id=application-cache-api:application-cache-11>application cache</a> whose <a href=#application-cache-group id=application-cache-api:application-cache-group-8>application cache group</a> is marked as <a href=#concept-appcache-obsolete id=application-cache-api:concept-appcache-obsolete-3>obsolete</a>.</dl>

  

  <hr>

  <p>If the <dfn id=dom-appcache-update><code>update()</code></dfn> method is invoked, the user
  agent must invoke the <a href=#application-cache-download-process id=application-cache-api:application-cache-download-process-3>application cache download process</a>, in the background, for the
  <a href=#application-cache-group id=application-cache-api:application-cache-group-9>application cache group</a> of the <a href=#application-cache id=application-cache-api:application-cache-12>application cache</a> with which the
  <code id=application-cache-api:applicationcache-14><a href=#applicationcache>ApplicationCache</a></code> object's <a href=#cache-host id=application-cache-api:cache-host-10>cache host</a> is associated, but without giving
  that <a href=#cache-host id=application-cache-api:cache-host-11>cache host</a> to the algorithm. If there is no such <a href=#application-cache id=application-cache-api:application-cache-13>application cache</a>,
  or if its <a href=#application-cache-group id=application-cache-api:application-cache-group-10>application cache group</a> is marked as <a href=#concept-appcache-obsolete id=application-cache-api:concept-appcache-obsolete-4>obsolete</a>, then the method must throw an
  <a id=application-cache-api:invalidstateerror-3 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a> <code id=application-cache-api:domexception-3><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> instead.</p>

  <p>If the <dfn id=dom-appcache-abort><code>abort()</code></dfn> method is invoked, the user
  agent must <dfn id=send-a-signal>send a signal</dfn> to the current <a href=#application-cache-download-process id=application-cache-api:application-cache-download-process-4>application cache download process</a>
  for the <a href=#application-cache-group id=application-cache-api:application-cache-group-11>application cache group</a> of the <a href=#application-cache id=application-cache-api:application-cache-14>application cache</a> with which the
  <code id=application-cache-api:applicationcache-15><a href=#applicationcache>ApplicationCache</a></code> object's <a href=#cache-host id=application-cache-api:cache-host-12>cache host</a> is associated, if any. If there is
  no such <a href=#application-cache id=application-cache-api:application-cache-15>application cache</a>, or it does not have a current <a href=#application-cache-download-process id=application-cache-api:application-cache-download-process-5>application cache
  download process</a>, then do nothing.</p>

  <p>If the <dfn id=dom-appcache-swapcache><code>swapCache()</code></dfn> method is invoked,
  the user agent must run the following steps:

  <ol><li><p>Check that <code id=application-cache-api:applicationcache-16><a href=#applicationcache>ApplicationCache</a></code> object's <a href=#cache-host id=application-cache-api:cache-host-13>cache host</a> is associated
   with an <a href=#application-cache id=application-cache-api:application-cache-16>application cache</a>. If it is not, then throw an
   <a id=application-cache-api:invalidstateerror-4 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a> <code id=application-cache-api:domexception-4><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these
   steps.<li><p>Let <var>cache</var> be the <a href=#application-cache id=application-cache-api:application-cache-17>application cache</a> with which the
   <code id=application-cache-api:applicationcache-17><a href=#applicationcache>ApplicationCache</a></code> object's <a href=#cache-host id=application-cache-api:cache-host-14>cache host</a> is associated. (By definition,
   this is the same as the one that was found in the previous step.)<li><p>If <var>cache</var>'s <a href=#application-cache-group id=application-cache-api:application-cache-group-12>application cache group</a> is marked as <a href=#concept-appcache-obsolete id=application-cache-api:concept-appcache-obsolete-5>obsolete</a>, then unassociate the
   <code id=application-cache-api:applicationcache-18><a href=#applicationcache>ApplicationCache</a></code> object's <a href=#cache-host id=application-cache-api:cache-host-15>cache host</a> from <var>cache</var> and
   abort these steps. (Resources will now load from the network instead of the cache.)<li><p>Check that there is an application cache in the same <a href=#application-cache-group id=application-cache-api:application-cache-group-13>application cache group</a>
   as <var>cache</var> whose <a href=#concept-appcache-completeness id=application-cache-api:concept-appcache-completeness>completeness
   flag</a> is <i>complete</i> and that is <a href=#concept-appcache-newer id=application-cache-api:concept-appcache-newer-3>newer</a> than
   <var>cache</var>. If there is not, then throw an <a id=application-cache-api:invalidstateerror-5 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a>
   <code id=application-cache-api:domexception-5><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> exception and abort these steps.<li><p>Let <var>new cache</var> be the <a href=#concept-appcache-newer id=application-cache-api:concept-appcache-newer-4>newest</a> <a href=#application-cache id=application-cache-api:application-cache-18>application cache</a> in the same
   <a href=#application-cache-group id=application-cache-api:application-cache-group-14>application cache group</a> as <var>cache</var> whose <a href=#concept-appcache-completeness id=application-cache-api:concept-appcache-completeness-2>completeness flag</a> is <i>complete</i>.<li><p>Unassociate the <code id=application-cache-api:applicationcache-19><a href=#applicationcache>ApplicationCache</a></code> object's <a href=#cache-host id=application-cache-api:cache-host-16>cache host</a> from <var>cache</var> and instead associate it with <var>new cache</var>.</ol>

  <p>The following are the <a href=#event-handlers id=application-cache-api:event-handlers>event handlers</a> (and their corresponding <a href=#event-handler-event-type id=application-cache-api:event-handler-event-type>event handler event types</a>) that must be
  supported, as <a href=#event-handler-idl-attributes id=application-cache-api:event-handler-idl-attributes>event handler IDL attributes</a>, by all objects implementing the
  <code id=application-cache-api:applicationcache-20><a href=#applicationcache>ApplicationCache</a></code> interface:</p>

  <table><thead><tr><th><a href=#event-handlers id=application-cache-api:event-handlers-2>Event handler</a> <th><a href=#event-handler-event-type id=application-cache-api:event-handler-event-type-2>Event handler event type</a>
   <tbody><tr><td><dfn id=handler-appcache-onchecking><code>onchecking</code></dfn> <td> <code id=application-cache-api:event-appcache-checking><a href=#event-appcache-checking>checking</a></code>
    <tr><td><dfn id=handler-appcache-onerror><code>onerror</code></dfn> <td> <code id=application-cache-api:event-appcache-error><a href=#event-appcache-error>error</a></code>
    <tr><td><dfn id=handler-appcache-onnoupdate><code>onnoupdate</code></dfn> <td> <code id=application-cache-api:event-appcache-noupdate><a href=#event-appcache-noupdate>noupdate</a></code>
    <tr><td><dfn id=handler-appcache-ondownloading><code>ondownloading</code></dfn> <td> <code id=application-cache-api:event-appcache-downloading><a href=#event-appcache-downloading>downloading</a></code>
    <tr><td><dfn id=handler-appcache-onprogress><code>onprogress</code></dfn> <td> <code id=application-cache-api:event-appcache-progress><a href=#event-appcache-progress>progress</a></code>
    <tr><td><dfn id=handler-appcache-onupdateready><code>onupdateready</code></dfn> <td> <code id=application-cache-api:event-appcache-updateready-2><a href=#event-appcache-updateready>updateready</a></code>
    <tr><td><dfn id=handler-appcache-oncached><code>oncached</code></dfn> <td> <code id=application-cache-api:event-appcache-cached><a href=#event-appcache-cached>cached</a></code>
    <tr><td><dfn id=handler-appcache-onobsolete><code>onobsolete</code></dfn> <td> <code id=application-cache-api:event-appcache-obsolete><a href=#event-appcache-obsolete>obsolete</a></code>
  </table>

  


  <h4 id=navigator.online>7.9.11 <span id=browser-state>Browser state</span><a href=#navigator.online class=self-link></a></h4><div class=status><input onclick=toggleStatus(this) value= type=button><p class=support><strong>Support:</strong> online-status<span class="and_chr yes"><span>Chrome for Android</span> <span>55+</span></span><span class="chrome yes"><span>Chrome</span> <span>14+</span></span><span class="ios_saf yes"><span>iOS Safari</span> <span>4.2+</span></span><span class="and_uc partial"><span>UC Browser for Android (limited)</span> <span>11+</span></span><span class="firefox yes"><span>Firefox</span> <span>41+</span></span><span class="ie yes"><span>IE</span> <span>9+</span></span><span class="samsung yes"><span>Samsung Internet</span> <span>4+</span></span><span class="op_mini no"><span>Opera Mini</span> <span>None</span></span><span class="android yes"><span>Android Browser</span> <span>2.3+</span></span><span class="safari yes"><span>Safari</span> <span>5+</span></span><span class="edge yes"><span>Edge</span> <span>12+</span></span><span class="opera yes"><span>Opera</span> <span>15+</span></span><p class=caniuse>Source: <a href="http://caniuse.com/#feat=online-status">caniuse.com</a></div>

  <pre class=idl>[NoInterfaceObject, Exposed=(Window,Worker)]
interface <dfn id=navigatoronline>NavigatorOnLine</dfn> {
  readonly attribute boolean <a href=#dom-navigator-online id=navigator.online:dom-navigator-online>onLine</a>;
};</pre>

  <dl class=domintro><dt><var>window</var> . <code id=navigator.online:dom-navigator><a href=#dom-navigator>navigator</a></code> . <code id=navigator.online:dom-navigator-online-2><a href=#dom-navigator-online>onLine</a></code><dd>

    <p>Returns false if the user agent is definitely offline (disconnected from the network).
    Returns true if the user agent might be online.</p>

    <p>The events <code id=navigator.online:event-online><a href=#event-online>online</a></code> and <code id=navigator.online:event-offline><a href=#event-offline>offline</a></code> are fired when the value of this attribute changes.</p>

   </dl>

  

  <p>The <dfn id=dom-navigator-online><code>navigator.onLine</code></dfn> attribute must return
  false if the user agent will not contact the network when the user follows links or when a script
  requests a remote page (or knows that such an attempt would fail), and must return true
  otherwise.</p>

  <p>When the value that would be returned by the <code id=navigator.online:dom-navigator-online-3><a href=#dom-navigator-online>navigator.onLine</a></code> attribute of a <code id=navigator.online:window><a href=#window>Window</a></code> or
  <code id=navigator.online:workerglobalscope><a href=#workerglobalscope>WorkerGlobalScope</a></code> changes from true to false, the user agent must <a href=#queue-a-task id=navigator.online:queue-a-task>queue a
  task</a> to <a href=https://dom.spec.whatwg.org/#concept-event-fire id=navigator.online:concept-event-fire data-x-internal=concept-event-fire>fire an event</a> named <code id=navigator.online:event-offline-2><a href=#event-offline>offline</a></code> at the <code id=navigator.online:window-2><a href=#window>Window</a></code> or <code id=navigator.online:workerglobalscope-2><a href=#workerglobalscope>WorkerGlobalScope</a></code>
  object.</p>

  <p>On the other hand, when the value that would be returned by the <code id=navigator.online:dom-navigator-online-4><a href=#dom-navigator-online>navigator.onLine</a></code> attribute of a <code id=navigator.online:window-3><a href=#window>Window</a></code> or
  <code id=navigator.online:workerglobalscope-3><a href=#workerglobalscope>WorkerGlobalScope</a></code> changes from false to true, the user agent must <a href=#queue-a-task id=navigator.online:queue-a-task-2>queue a
  task</a> to <a href=https://dom.spec.whatwg.org/#concept-event-fire id=navigator.online:concept-event-fire-2 data-x-internal=concept-event-fire>fire an event</a> named <code id=navigator.online:event-online-2><a href=#event-online>online</a></code> at the <code id=navigator.online:window-4><a href=#window>Window</a></code> or <code id=navigator.online:workerglobalscope-4><a href=#workerglobalscope>WorkerGlobalScope</a></code>
  object.</p>

  <p>The <a href=#task-source id=navigator.online:task-source>task source</a> for these <a href=#concept-task id=navigator.online:concept-task>tasks</a> is the
  <a href=#networking-task-source id=navigator.online:networking-task-source>networking task source</a>.</p>

  

  <p class=note>This attribute is inherently unreliable. A computer can be connected to a network
  without having Internet access.</p>

  <div class=example>

   <p>In this example, an indicator is updated as the browser goes online and offline.</p>

   <pre>&lt;!DOCTYPE HTML>
&lt;html lang="en">
 &lt;head>
  &lt;title>Online status&lt;/title>
  &lt;script>
   function updateIndicator() {
     document.getElementById('indicator').textContent = navigator.onLine ? 'online' : 'offline';
   }
  &lt;/script>
 &lt;/head>
 &lt;body onload="updateIndicator()" ononline="updateIndicator()" onoffline="updateIndicator()">
  &lt;p>The network is: &lt;span id="indicator">(state unknown)&lt;/span>
 &lt;/body>
&lt;/html></pre>

  </div>





  <h2 id=webappapis>8 Web application APIs<a href=#webappapis class=self-link></a></h2>

  <h3 id=scripting>8.1 Scripting<a href=#scripting class=self-link></a></h3>

  <h4 id=introduction-11>8.1.1 Introduction<a href=#introduction-11 class=self-link></a></h4>

  <p>Various mechanisms can cause author-provided executable code to run in the context of a
  document. These mechanisms include, but are probably not limited to:</p>

  <ul><li>Processing of <code id=introduction-11:the-script-element><a href=#the-script-element>script</a></code> elements.<li>Navigating to <a href=#javascript-protocol id=introduction-11:javascript-protocol><code>javascript:</code> URLs</a>.<li>Event handlers, whether registered through the DOM using <code>addEventListener()</code>, by explicit <a href=#event-handler-content-attributes id=introduction-11:event-handler-content-attributes>event handler content attributes</a>, by
   <a href=#event-handler-idl-attributes id=introduction-11:event-handler-idl-attributes>event handler IDL attributes</a>, or otherwise.<li>Processing of technologies like SVG that have their own scripting features.</ul>


  

  <h4 id=enabling-and-disabling-scripting>8.1.2 Enabling and disabling scripting<a href=#enabling-and-disabling-scripting class=self-link></a></h4>

  <p><dfn id=concept-bc-script>Scripting is enabled</dfn> in a <em><a href=#browsing-context id=enabling-and-disabling-scripting:browsing-context>browsing
  context</a></em> when all of the following conditions are true:</p>

  <ul><li>The user agent supports scripting.<li>The user has not disabled scripting for this <a href=#browsing-context id=enabling-and-disabling-scripting:browsing-context-2>browsing context</a> at this time.
   (User agents may provide users with the option to disable scripting globally, or in a
   finer-grained manner, e.g. on a per-origin basis.)
   <a href=#fingerprinting-vector id=enabling-and-disabling-scripting:fingerprinting-vector class=fingerprint title="There is a potential fingerprinting vector here."><img alt="(This is a fingerprinting vector.)" src=/images/fingerprint.png width=46 height=64></a>
   <li id=sandboxScriptBlocked>The <a href=#browsing-context id=enabling-and-disabling-scripting:browsing-context-3>browsing context</a>'s <a href=#active-document id=enabling-and-disabling-scripting:active-document>active document</a>'s
   <a href=#active-sandboxing-flag-set id=enabling-and-disabling-scripting:active-sandboxing-flag-set>active sandboxing flag set</a> does not have its <a href=#sandboxed-scripts-browsing-context-flag id=enabling-and-disabling-scripting:sandboxed-scripts-browsing-context-flag>sandboxed scripts browsing
   context flag</a> set.</ul>

  <p><dfn id=concept-bc-noscript>Scripting is disabled</dfn> in a <a href=#browsing-context id=enabling-and-disabling-scripting:browsing-context-4>browsing context</a>
  when any of the above conditions are false (i.e. when scripting is not <a href=#concept-bc-script id=enabling-and-disabling-scripting:concept-bc-script>enabled</a>).</p>

  <hr>

  <p><dfn id=concept-n-script>Scripting is enabled</dfn> for a <em>node</em> if the node's
  <a id=enabling-and-disabling-scripting:node-document href=https://dom.spec.whatwg.org/#concept-node-document data-x-internal=node-document>node document</a> has a <a href=#concept-document-bc id=enabling-and-disabling-scripting:concept-document-bc>browsing context</a>, and
  <a href=#concept-bc-script id=enabling-and-disabling-scripting:concept-bc-script-2>scripting is enabled</a> in that <a href=#browsing-context id=enabling-and-disabling-scripting:browsing-context-5>browsing
  context</a>.</p>

  <p><dfn id=concept-n-noscript>Scripting is disabled</dfn> for a node if there is no such
  <a href=#browsing-context id=enabling-and-disabling-scripting:browsing-context-6>browsing context</a>, or if <a href=#concept-bc-noscript id=enabling-and-disabling-scripting:concept-bc-noscript>scripting is
  disabled</a> in that <a href=#browsing-context id=enabling-and-disabling-scripting:browsing-context-7>browsing context</a>.</p>

  


  

  
  <h4 id=scripting-processing-model>8.1.3 <span id=processing-model-7></span>Processing model<a href=#scripting-processing-model class=self-link></a></h4>

  <h5 id=definitions-2>8.1.3.1 Definitions<a href=#definitions-2 class=self-link></a></h5>

  <p>A <dfn id=concept-script data-export="">script</dfn> is one of two possible structures.
  All scripts have:</p>

  <dl><dt>A <dfn data-dfn-for=script id=settings-object data-export="">settings object</dfn><dd>

    <p>An <a href=#environment-settings-object id=definitions-2:environment-settings-object>environment settings object</a>, containing various settings that are shared
    with other <a href=#concept-script id=definitions-2:concept-script>scripts</a> in the same context.</p>

   </dl>


  <p>A <dfn id=classic-script data-export="">classic script</dfn> is a <a href=#concept-script id=definitions-2:concept-script-2>script</a>
  that has the following additional fields:</p>

  <dl><dt><dfn id=concept-classic-script-source-text data-export="">Source text</dfn><dd>

    <p>A string containing a block of executable code to be evaluated as a JavaScript <i id=definitions-2:js-prod-script><a data-x-internal=js-prod-script href=https://tc39.github.io/ecma262/#prod-Script>Script</a></i>.</p>

   <dt>Optionally, a <dfn id=muted-errors>muted errors</dfn> flag<dd>

    <p>A flag which, if set, means that error information will not be provided for errors in this
    script (used to mute errors for cross-origin scripts, since that can leak private
    information).</p>

   </dl>

  <p>A <dfn id=module-script data-export="">module script</dfn> is a <a href=#concept-script id=definitions-2:concept-script-3>script</a>
  that has the following additional fields:</p>

  <dl><dt>A <dfn data-dfn-for="module
   script" id=concept-module-script-module-record data-export="">module record</dfn><dd>

    <p>A <a id=definitions-2:source-text-module-record href=https://tc39.github.io/ecma262/#sec-source-text-module-records data-x-internal=source-text-module-record>Source Text Module Record</a> representing the parsed module, ready to be
    evaluated.</p>

   <dt>A <dfn id=concept-module-script-base-url>base URL</dfn><dd>

    <p>A base URL used for resolving module specifiers when <a href=#resolve-a-module-specifier id=definitions-2:resolve-a-module-specifier>resolving a module specifier</a>. This will either be the URL from which the
    script was obtained, for external module scripts, or the <a href=#document-base-url id=definitions-2:document-base-url>document base URL</a> of the
    containing document, for inline module scripts.</p>

   <dt>An <dfn id=concept-module-script-instantiation-state>instantiation state</dfn><dd>

    <p>One of "<code>uninstantiated</code>", "<code>errored</code>", or "<code>instantiated</code>", used to prevent reinvocation of <a href=https://tc39.github.io/ecma262/#sec-moduledeclarationinstantiation id=definitions-2:js-moduledeclarationinstantiation data-x-internal=js-moduledeclarationinstantiation>ModuleDeclarationInstantiation</a> on modules that
    failed to instantiate previously.</p>

   <dt>An <dfn id=concept-module-script-instantiation-error>instantiation error</dfn><dd>

    <p>A JavaScript value, which has meaning only if the <a href=#concept-module-script-instantiation-state id=definitions-2:concept-module-script-instantiation-state>instantiation state</a> is "<code>errored</code>".</p>

   <dt>A <dfn id=concept-module-script-credentials-mode>credentials mode</dfn><dd>

    <p>A <a href=https://fetch.spec.whatwg.org/#concept-request-credentials-mode id=definitions-2:concept-request-credentials-mode data-x-internal=concept-request-credentials-mode>credentials mode</a> used to fetch
    imported modules.</p>

   <dt>A <dfn id=concept-module-script-nonce>cryptographic nonce</dfn><dd>

    <p>A <a href=https://fetch.spec.whatwg.org/#concept-request-nonce-metadata id=definitions-2:concept-request-nonce-metadata data-x-internal=concept-request-nonce-metadata>cryptographic nonce</a> used to fetch
    imported modules.</p>

   <dt>A <dfn id=concept-module-script-parser>parser state</dfn><dd>

    <p>The <a href=https://fetch.spec.whatwg.org/#concept-request-parser-metadata id=definitions-2:concept-request-parser-metadata data-x-internal=concept-request-parser-metadata>parser metadata</a> used to fetch
    imported modules.</p>

   </dl>

  <hr>

  <p>An <dfn id=environment data-export="">environment</dfn> is an object that identifies the settings of a
  current or potential execution environment. An <a href=#environment id=definitions-2:environment>environment</a> has the following
  fields:</p>

  <dl><dt>An <dfn data-dfn-for=environment id=concept-environment-id data-export="">id</dfn><dd><p>An opaque string that uniquely identifies the <a href=#environment id=definitions-2:environment-2>environment</a>.<dt>A <dfn data-dfn-for=environment id=concept-environment-creation-url data-export="">creation URL</dfn><dd>
    <p>An <a id=definitions-2:absolute-url href=https://url.spec.whatwg.org/#syntax-url-absolute data-x-internal=absolute-url>absolute URL</a> that represents the location of the resource with which the
    <a href=#environment id=definitions-2:environment-3>environment</a> is associated.</p>

    <p class=note>In the case of an <a href=#environment-settings-object id=definitions-2:environment-settings-object-2>environment settings object</a>, this URL might be
    distinct from the <a href=#environment-settings-object id=definitions-2:environment-settings-object-3>environment settings object</a>'s <a href=#responsible-document id=definitions-2:responsible-document>responsible
    document</a>'s <a href=https://dom.spec.whatwg.org/#concept-document-url id="definitions-2:the-document's-address" data-x-internal="the-document's-address">URL</a>, due to mechanisms such as
    <code id=definitions-2:dom-history-pushstate><a href=#dom-history-pushstate>history.pushState()</a></code>.</p>
   <dt>A <dfn data-dfn-for=environment id=concept-environment-target-browsing-context data-export="">target browsing context</dfn><dd><p>Null or a target <a href=#browsing-context id=definitions-2:browsing-context>browsing context</a> for a <a href=https://fetch.spec.whatwg.org/#navigation-request id=definitions-2:navigation-request data-x-internal=navigation-request>navigation request</a>.<dt>An <dfn data-dfn-for=environment id=concept-environment-active-service-worker data-export="">active service worker</dfn><dd><p>Null or a <a href=https://w3c.github.io/ServiceWorker/#dfn-service-worker id=definitions-2:dfn-service-worker data-x-internal=dfn-service-worker>service worker</a> that <a href=https://w3c.github.io/ServiceWorker/#dfn-control id=definitions-2:dfn-control data-x-internal=dfn-control>controls</a> the <a href=#environment id=definitions-2:environment-4>environment</a>.<dt>An <dfn data-dfn-for=environment id=concept-environment-execution-ready-flag data-export="">execution ready flag</dfn><dd><p>A flag that indicates whether the environment setup is done. It is initially
   unset.</dl>

  <p>An <dfn id=environment-settings-object data-export="">environment settings object</dfn> is an <a href=#environment id=definitions-2:environment-5>environment</a> that
  additionally specifies algorithms for:</p>

  <dl><dt>A <dfn data-dfn-for="environment settings object" id=realm-execution-context data-export="">realm execution
   context</dfn><dd>

    <p>A <a id=definitions-2:javascript-execution-context href=https://tc39.github.io/ecma262/#sec-execution-contexts data-x-internal=javascript-execution-context>JavaScript execution context</a> shared by all
    <a href=#the-script-element id=definitions-2:the-script-element>scripts</a> that use this settings object, i.e. all scripts in a given
    <a id=definitions-2:javascript-realm href=https://tc39.github.io/ecma262/#sec-code-realms data-x-internal=javascript-realm>JavaScript realm</a>. When we <a href=#run-a-classic-script id=definitions-2:run-a-classic-script>run a classic script</a> or <a href=#run-a-module-script id=definitions-2:run-a-module-script>run a module
    script</a>, this execution context becomes the top of the <a id=definitions-2:javascript-execution-context-stack href=https://tc39.github.io/ecma262/#execution-context-stack data-x-internal=javascript-execution-context-stack>JavaScript execution context
    stack</a>, on top of which another execution context specific to the script in question is
    pushed. (This setup ensures <a href=https://tc39.github.io/ecma262/#sec-parse-script id=definitions-2:js-parsescript data-x-internal=js-parsescript>ParseScript</a> and <a href=https://tc39.github.io/ecma262/#sec-moduleevaluation id=definitions-2:js-moduleevaluation data-x-internal=js-moduleevaluation>ModuleEvaluation</a> know which Realm to use.)</p>

   <dt>A <dfn data-dfn-for="environment
   settings object" id=concept-settings-object-module-map data-export="">module map</dfn><dd>

    <p>A <a href=#module-map id=definitions-2:module-map>module map</a> that is used when importing JavaScript modules.</p>

   <dt>A <dfn data-dfn-for="environment settings object" id=responsible-browsing-context data-export="">responsible browsing
   context</dfn><dd>

    <p>A <a href=#browsing-context id=definitions-2:browsing-context-2>browsing context</a> that is assigned responsibility for actions taken by the
    scripts that use this <a href=#environment-settings-object id=definitions-2:environment-settings-object-4>environment settings object</a>.</p>

    <p class=example>When a script creates and <a href=#navigate id=definitions-2:navigate>navigates</a> a new
    <a href=#top-level-browsing-context id=definitions-2:top-level-browsing-context>top-level browsing context</a>, the <code id=definitions-2:dom-opener><a href=#dom-opener>opener</a></code> attribute
    of the new <a href=#browsing-context id=definitions-2:browsing-context-3>browsing context</a>'s <code id=definitions-2:window><a href=#window>Window</a></code> object will be set to the
    <a href=#responsible-browsing-context id=definitions-2:responsible-browsing-context>responsible browsing context</a>'s <code id=definitions-2:windowproxy><a href=#windowproxy>WindowProxy</a></code> object.</p>

   <dt>A <dfn data-dfn-for="environment settings object" id=responsible-event-loop data-export="">responsible event
   loop</dfn><dd>

    <p>An <a href=#event-loop id=definitions-2:event-loop>event loop</a> that is used when it would not be immediately clear what event
    loop to use.</p>

   <dt>A <dfn data-dfn-for="environment settings object" id=responsible-document data-export="">responsible document</dfn><dd>

    <p>A <code id=definitions-2:document><a href=#document>Document</a></code> that is assigned responsibility for actions taken by the scripts that
    use this <a href=#environment-settings-object id=definitions-2:environment-settings-object-5>environment settings object</a>.</p>

    <p class=example>For example, the <a href=https://dom.spec.whatwg.org/#concept-document-url id="definitions-2:the-document's-address-2" data-x-internal="the-document's-address">URL</a> of the
    <a href=#responsible-document id=definitions-2:responsible-document-2>responsible document</a> is used to set the <a href=https://dom.spec.whatwg.org/#concept-document-url id="definitions-2:the-document's-address-3" data-x-internal="the-document's-address">URL</a> of the <code id=definitions-2:document-2><a href=#document>Document</a></code> after it has been reset
    using <code id=definitions-2:dom-document-open><a href=#dom-document-open>document.open()</a></code>.</p>

    <p>If the <a href=#responsible-event-loop id=definitions-2:responsible-event-loop>responsible event loop</a> is not a <a href=#browsing-context id=definitions-2:browsing-context-4>browsing context</a> <a href=#event-loop id=definitions-2:event-loop-2>event loop</a>,
    then the <a href=#environment-settings-object id=definitions-2:environment-settings-object-6>environment settings object</a> has no <a href=#responsible-document id=definitions-2:responsible-document-3>responsible document</a>.</p>

   <dt>An <dfn data-dfn-for="environment settings object" id=api-url-character-encoding data-export="">API URL character encoding</dfn><dd>

    <p>A character encoding used to encode URLs by APIs called by scripts that use this <a href=#environment-settings-object id=definitions-2:environment-settings-object-7>environment
    settings object</a>.</p>

   <dt>An <dfn data-dfn-for="environment settings object" id=api-base-url data-export="">API base URL</dfn><dd>

    <p>A <a id=definitions-2:url href=https://url.spec.whatwg.org/#concept-url data-x-internal=url>URL</a> used by APIs called by scripts that use this <a href=#environment-settings-object id=definitions-2:environment-settings-object-8>environment settings
    object</a> to <a href=#parse-a-url id=definitions-2:parse-a-url>parse URLs</a>.</p>

   <dt>An <dfn data-dfn-for="environment
   settings object" id=concept-settings-object-origin data-export="">origin</dfn><dd>

    <p>An <a href=#concept-origin id=definitions-2:concept-origin>origin</a> used in security checks.</p>

   <dt>An <dfn data-dfn-for="environment settings object" id=https-state data-export="">HTTPS state</dfn><dd><p>An <a id=definitions-2:https-state-value href=https://fetch.spec.whatwg.org/#concept-https-state-value data-x-internal=https-state-value>HTTPS state value</a> representing the security properties of the network
   channel used to deliver the resource with which the <a href=#environment-settings-object id=definitions-2:environment-settings-object-9>environment settings object</a> is
   associated.<dt>A <dfn data-dfn-for="environment settings object" id=concept-settings-object-referrer-policy data-export="">referrer policy</dfn><dd><p>The default <a id=definitions-2:referrer-policy href=https://w3c.github.io/webappsec-referrer-policy/#referrer-policy data-x-internal=referrer-policy>referrer policy</a> for <a href=https://fetch.spec.whatwg.org/#concept-fetch id=definitions-2:concept-fetch data-x-internal=concept-fetch>fetches</a>
   performed using this <a href=#environment-settings-object id=definitions-2:environment-settings-object-10>environment settings object</a> as a <a href=https://fetch.spec.whatwg.org/#concept-request-client id=definitions-2:concept-request-client data-x-internal=concept-request-client>request client</a>. <a href=#refsREFERRERPOLICY>[REFERRERPOLICY]</a>

  </dl>

  <p>An <a href=#environment-settings-object id=definitions-2:environment-settings-object-11>environment settings object</a> also has an <dfn id=outstanding-rejected-promises-weak-set>outstanding rejected promises
  weak set</dfn> and an <dfn id=about-to-be-notified-rejected-promises-list>about-to-be-notified rejected promises list</dfn>, used to track
  <a href=#unhandled-promise-rejections>unhandled promise rejections</a>. The <a href=#outstanding-rejected-promises-weak-set id=definitions-2:outstanding-rejected-promises-weak-set>outstanding
  rejected promises weak set</a> must not create strong references to any of its members, and
  implementations are free to limit its size, e.g. by removing old entries from it when new ones
  are added.</p>

  <h5 id=fetching-scripts>8.1.3.2 Fetching scripts<a href=#fetching-scripts class=self-link></a></h5>

  <p>This section introduces a number of algorithms for fetching scripts, taking various necessary
  inputs and resulting in <a href=#classic-script id=fetching-scripts:classic-script>classic</a> or <a href=#module-script id=fetching-scripts:module-script>module scripts</a>.</p>

  <p>The algorithms below can be customized by optionally supplying a custom <dfn data-dfn-for="fetching scripts" id=fetching-scripts-perform-fetch data-export="">perform the
  fetch</dfn> hook, which takes a <a href=https://fetch.spec.whatwg.org/#concept-request id=fetching-scripts:concept-request data-x-internal=concept-request>request</a> and an <dfn data-dfn-for="fetching scripts" id=fetching-scripts-is-top-level data-export=""><var>is
  top-level</var></dfn> flag. The algorithm must complete with a <a href=https://fetch.spec.whatwg.org/#concept-response id=fetching-scripts:concept-response data-x-internal=concept-response>response</a> (which may be a <a id=fetching-scripts:network-error href=https://fetch.spec.whatwg.org/#concept-network-error data-x-internal=network-error>network error</a>), either
  synchronously (when using <a href=#fetch-a-classic-worker-imported-script id=fetching-scripts:fetch-a-classic-worker-imported-script>fetch a classic worker-imported script</a>) or asynchronously
  (otherwise). The <var id=fetching-scripts:fetching-scripts-is-top-level><a href=#fetching-scripts-is-top-level>is top-level</a></var> flag will be set
  for all <a href=#classic-script id=fetching-scripts:classic-script-2>classic script</a> fetches, and for the initial fetch when <a href=#fetch-a-module-script-tree id=fetching-scripts:fetch-a-module-script-tree>fetching a module script graph</a> or <a href=#fetch-a-module-worker-script-tree id=fetching-scripts:fetch-a-module-worker-script-tree>fetching a module worker script graph</a>, but not for the fetches resulting from
  <code>import</code> statements encountered throughout the graph.</p>

  <div class=note>
   <p>By default, not supplying the <a href=#fetching-scripts-perform-fetch id=fetching-scripts:fetching-scripts-perform-fetch>perform the
   fetch</a> will cause the below algorithms to simply <a href=https://fetch.spec.whatwg.org/#concept-fetch id=fetching-scripts:concept-fetch data-x-internal=concept-fetch>fetch</a>
   the given <a href=https://fetch.spec.whatwg.org/#concept-request id=fetching-scripts:concept-request-2 data-x-internal=concept-request>request</a>, with algorithm-specific customizations
   to the <a href=https://fetch.spec.whatwg.org/#concept-request id=fetching-scripts:concept-request-3 data-x-internal=concept-request>request</a> and validations of the resulting <a href=https://fetch.spec.whatwg.org/#concept-response id=fetching-scripts:concept-response-2 data-x-internal=concept-response>response</a>.</p>

   <p>To layer your own customizations on top of these algorithm-specific ones, supply a <a href=#fetching-scripts-perform-fetch id=fetching-scripts:fetching-scripts-perform-fetch-2>perform the fetch</a> hook that modifies the given
   <a href=https://fetch.spec.whatwg.org/#concept-request id=fetching-scripts:concept-request-4 data-x-internal=concept-request>request</a>, <a href=https://fetch.spec.whatwg.org/#concept-fetch id=fetching-scripts:concept-fetch-2 data-x-internal=concept-fetch>fetches</a> it,
   and then performs specific validations of the resulting <a href=https://fetch.spec.whatwg.org/#concept-response id=fetching-scripts:concept-response-3 data-x-internal=concept-response>response</a> (completing with a <a id=fetching-scripts:network-error-2 href=https://fetch.spec.whatwg.org/#concept-network-error data-x-internal=network-error>network error</a> if the
   validations fail).</p>

   <p>The hook can also be used to perform more subtle customizations, such as keeping a cache of
   <a href=https://fetch.spec.whatwg.org/#concept-response id=fetching-scripts:concept-response-4 data-x-internal=concept-response>responses</a> and avoiding performing a <a href=https://fetch.spec.whatwg.org/#concept-fetch id=fetching-scripts:concept-fetch-3 data-x-internal=concept-fetch>fetch</a> at all.</p>
  </div>

  <p class=note><cite>Service Workers</cite> is an example of a specification that runs these
  algorithms with its own options for the hook. <a href=#refsSW>[SW]</a></p>

  <p>To <dfn id=fetch-a-classic-script data-export="">fetch a classic script</dfn> given a <var>url</var>, a <var>settings
  object</var>, a <var>cryptographic nonce</var>, an <var>integrity metadata</var>, a <var>parser
  state</var>, a <var>CORS setting</var>, and a <var>character encoding</var>, run these steps. The
  algorithm will asynchronously complete with either null (on failure) or a new <a href=#classic-script id=fetching-scripts:classic-script-3>classic
  script</a> (on success).</p>

  <ol><li><p>Let <var>request</var> be the result of <a href=#create-a-potential-cors-request id=fetching-scripts:create-a-potential-cors-request>creating a potential-CORS request</a> given <var>url</var>, "<code>script</code>", and <var>CORS setting</var>.<li><p>Set <var>request</var>'s <a href=https://fetch.spec.whatwg.org/#concept-request-client id=fetching-scripts:concept-request-client data-x-internal=concept-request-client>client</a> to
   <var>settings object</var>, its <a href=https://fetch.spec.whatwg.org/#concept-request-type id=fetching-scripts:concept-request-type data-x-internal=concept-request-type>type</a> to "<code>script</code>", its <a href=https://fetch.spec.whatwg.org/#concept-request-nonce-metadata id=fetching-scripts:concept-request-nonce-metadata data-x-internal=concept-request-nonce-metadata>cryptographic nonce
   metadata</a> to <var>cryptographic nonce</var>, its <a href=https://fetch.spec.whatwg.org/#concept-request-integrity-metadata id=fetching-scripts:concept-request-integrity-metadata data-x-internal=concept-request-integrity-metadata>integrity metadata</a> to <var>integrity
   metadata</var> and its <a href=https://fetch.spec.whatwg.org/#concept-request-parser-metadata id=fetching-scripts:concept-request-parser-metadata data-x-internal=concept-request-parser-metadata>parser metadata</a> to
   <var>parser state</var>.<li>
    <p>If the caller specified custom steps to <a href=#fetching-scripts-perform-fetch id=fetching-scripts:fetching-scripts-perform-fetch-3>perform
    the fetch</a>, perform them on <var>request</var>, with the <var id=fetching-scripts:fetching-scripts-is-top-level-2><a href=#fetching-scripts-is-top-level>is top-level</a></var> flag set. Return from this algorithm,
    and when the custom <a href=#fetching-scripts-perform-fetch id=fetching-scripts:fetching-scripts-perform-fetch-4>perform the fetch</a> steps
    complete with <a href=https://fetch.spec.whatwg.org/#concept-response id=fetching-scripts:concept-response-5 data-x-internal=concept-response>response</a> <var>response</var>, run the
    remaining steps.</p>

    <p>Otherwise, <a href=https://fetch.spec.whatwg.org/#concept-fetch id=fetching-scripts:concept-fetch-4 data-x-internal=concept-fetch>fetch</a> <var>request</var>. Return from this
    algorithm, and run the remaining steps as part of the fetch's <a id=fetching-scripts:process-response href=https://fetch.spec.whatwg.org/#process-response data-x-internal=process-response>process response</a> for
    the <a href=https://fetch.spec.whatwg.org/#concept-response id=fetching-scripts:concept-response-6 data-x-internal=concept-response>response</a> <var>response</var>.</p>

    <p class=note><var>response</var> can be either <a href=#cors-same-origin id=fetching-scripts:cors-same-origin>CORS-same-origin</a> or
    <a href=#cors-cross-origin id=fetching-scripts:cors-cross-origin>CORS-cross-origin</a>. This only affects how error reporting happens.</p>
   <li><p>Let <var>response</var> be <var>response</var>'s <a href=#unsafe-response id=fetching-scripts:unsafe-response>unsafe response</a>.<li><p>If <var>response</var>'s <a href=https://fetch.spec.whatwg.org/#concept-response-type id=fetching-scripts:concept-response-type data-x-internal=concept-response-type>type</a> is "<code>error</code>", or <var>response</var>'s <a href=https://fetch.spec.whatwg.org/#concept-response-status id=fetching-scripts:concept-response-status data-x-internal=concept-response-status>status</a> is not an <a id=fetching-scripts:ok-status href=https://fetch.spec.whatwg.org/#ok-status data-x-internal=ok-status>ok status</a>, asynchronously
   complete this algorithm with null, and abort these steps.<li><p>If <var>response</var>'s <a href=#content-type id=fetching-scripts:content-type>Content Type metadata</a>, if
   any, specifies a character encoding, and the user agent supports that encoding, then set
   <var>character encoding</var> to that encoding (ignoring the passed-in value).<li>
    <p>Let <var>source text</var> be the result of <a href=https://encoding.spec.whatwg.org/#decode id=fetching-scripts:decode data-x-internal=decode>decoding</a>
    <var>response</var>'s <a href=https://fetch.spec.whatwg.org/#concept-response-body id=fetching-scripts:concept-response-body data-x-internal=concept-response-body>body</a> to Unicode, using
    <var>character encoding</var> as the fallback encoding.</p>

    <p class=note>The <a id=fetching-scripts:decode-2 href=https://encoding.spec.whatwg.org/#decode data-x-internal=decode>decode</a> algorithm overrides <var>character encoding</var> if
    the file contains a BOM.</p>
   <li>
    <p>Let <var>script</var> be the result of <a href=#creating-a-classic-script id=fetching-scripts:creating-a-classic-script>creating a classic script</a> using
    <var>source text</var> and <var>settings object</var>.</p>

    <p>If <var>response</var> was <a href=#cors-cross-origin id=fetching-scripts:cors-cross-origin-2>CORS-cross-origin</a>, then pass the <var>muted
    errors</var> flag to the <a href=#creating-a-classic-script id=fetching-scripts:creating-a-classic-script-2>create a classic
    script</a> algorithm as well.</p>
   <li>Asynchronously complete this algorithm with <var>script</var>.</ol>

  <p>To <dfn id=fetch-a-classic-worker-script data-export="">fetch a classic worker script</dfn> given a <var>url</var>, a <var>fetch
  client settings object</var>, a <var>destination</var>, and a <var>script settings object</var>,
  run these steps. The algorithm will asynchronously complete with either null (on failure) or a new
  <a href=#classic-script id=fetching-scripts:classic-script-4>classic script</a> (on success).</p>

  <ol><li><p>Let <var>request</var> be a new <a href=https://fetch.spec.whatwg.org/#concept-request id=fetching-scripts:concept-request-5 data-x-internal=concept-request>request</a> whose <a href=https://fetch.spec.whatwg.org/#concept-request-url id=fetching-scripts:concept-request-url data-x-internal=concept-request-url>url</a> is <var>url</var>, <a href=https://fetch.spec.whatwg.org/#concept-request-client id=fetching-scripts:concept-request-client-2 data-x-internal=concept-request-client>client</a> is <var>fetch client settings object</var>, <a href=https://fetch.spec.whatwg.org/#concept-request-type id=fetching-scripts:concept-request-type-2 data-x-internal=concept-request-type>type</a> is "<code>script</code>", <a href=https://fetch.spec.whatwg.org/#concept-request-destination id=fetching-scripts:concept-request-destination data-x-internal=concept-request-destination>destination</a> is <var>destination</var>, <a href=https://fetch.spec.whatwg.org/#concept-request-mode id=fetching-scripts:concept-request-mode data-x-internal=concept-request-mode>mode</a> is "<code>same-origin</code>", <a href=https://fetch.spec.whatwg.org/#concept-request-credentials-mode id=fetching-scripts:concept-request-credentials-mode data-x-internal=concept-request-credentials-mode>credentials mode</a> is "<code>same-origin</code>", <a href=https://fetch.spec.whatwg.org/#concept-request-parser-metadata id=fetching-scripts:concept-request-parser-metadata-2 data-x-internal=concept-request-parser-metadata>parser
   metadata</a> is "<code>not parser-inserted</code>", and whose
   <a id=fetching-scripts:use-url-credentials-flag href=https://fetch.spec.whatwg.org/#concept-request-use-url-credentials-flag data-x-internal=use-url-credentials-flag>use-URL-credentials flag</a> is set.<li>
    <p>If the caller specified custom steps to <a href=#fetching-scripts-perform-fetch id=fetching-scripts:fetching-scripts-perform-fetch-5>perform
    the fetch</a>, perform them on <var>request</var>, with the <var id=fetching-scripts:fetching-scripts-is-top-level-3><a href=#fetching-scripts-is-top-level>is top-level</a></var> flag set. Return from this algorithm,
    and when the custom <a href=#fetching-scripts-perform-fetch id=fetching-scripts:fetching-scripts-perform-fetch-6>perform the fetch</a> steps
    complete with <a href=https://fetch.spec.whatwg.org/#concept-response id=fetching-scripts:concept-response-7 data-x-internal=concept-response>response</a> <var>response</var>, run the
    remaining steps.</p>

    <p>Otherwise, <a href=https://fetch.spec.whatwg.org/#concept-fetch id=fetching-scripts:concept-fetch-5 data-x-internal=concept-fetch>fetch</a> <var>request</var>. Return from this
    algorithm, and run the remaining steps as part of the fetch's <a id=fetching-scripts:process-response-2 href=https://fetch.spec.whatwg.org/#process-response data-x-internal=process-response>process response</a> for
    the <a href=https://fetch.spec.whatwg.org/#concept-response id=fetching-scripts:concept-response-8 data-x-internal=concept-response>response</a> <var>response</var>.</p>
   <li><p>Let <var>response</var> be <var>response</var>'s <a href=#unsafe-response id=fetching-scripts:unsafe-response-2>unsafe response</a>.<li><p>If <var>response</var>'s <a href=https://fetch.spec.whatwg.org/#concept-response-type id=fetching-scripts:concept-response-type-2 data-x-internal=concept-response-type>type</a> is "<code>error</code>", or <var>response</var>'s <a href=https://fetch.spec.whatwg.org/#concept-response-status id=fetching-scripts:concept-response-status-2 data-x-internal=concept-response-status>status</a> is not an <a id=fetching-scripts:ok-status-2 href=https://fetch.spec.whatwg.org/#ok-status data-x-internal=ok-status>ok status</a>, asynchronously
   complete this algorithm with null, and abort these steps.<li><p>Let <var>source text</var> be the result of <a href=https://encoding.spec.whatwg.org/#utf-8-decode id=fetching-scripts:utf-8-decode data-x-internal=utf-8-decode>UTF-8
   decoding</a> <var>response</var>'s <a href=https://fetch.spec.whatwg.org/#concept-response-body id=fetching-scripts:concept-response-body-2 data-x-internal=concept-response-body>body</a>.<li><p>Let <var>script</var> be the result of <a href=#creating-a-classic-script id=fetching-scripts:creating-a-classic-script-3>creating a classic script</a> using
   <var>source text</var> and <var>script settings object</var>.<li>Asynchronously complete this algorithm with <var>script</var>.</ol>

  <p>To <dfn id=fetch-a-classic-worker-imported-script data-export="">fetch a classic worker-imported script</dfn> given a <var>url</var> and
  a <var>settings object</var>, run these steps. The algorithm will synchronously complete with a
  <a href=#classic-script id=fetching-scripts:classic-script-5>classic script</a> on success, or throw an exception on failure.</p>

  <ol><li><p>Let <var>request</var> be a new <a href=https://fetch.spec.whatwg.org/#concept-request id=fetching-scripts:concept-request-6 data-x-internal=concept-request>request</a> whose <a href=https://fetch.spec.whatwg.org/#concept-request-url id=fetching-scripts:concept-request-url-2 data-x-internal=concept-request-url>url</a> is <var>url</var>, <a href=https://fetch.spec.whatwg.org/#concept-request-client id=fetching-scripts:concept-request-client-3 data-x-internal=concept-request-client>client</a> is <var>settings object</var>, <a href=https://fetch.spec.whatwg.org/#concept-request-type id=fetching-scripts:concept-request-type-3 data-x-internal=concept-request-type>type</a> is "<code>script</code>", <a href=https://fetch.spec.whatwg.org/#concept-request-destination id=fetching-scripts:concept-request-destination-2 data-x-internal=concept-request-destination>destination</a> is "<var>script</var>", <a href=https://fetch.spec.whatwg.org/#concept-request-parser-metadata id=fetching-scripts:concept-request-parser-metadata-3 data-x-internal=concept-request-parser-metadata>parser metadata</a> is "<code>not
   parser-inserted</code>", <a id=fetching-scripts:synchronous-flag href=https://fetch.spec.whatwg.org/#synchronous-flag data-x-internal=synchronous-flag>synchronous flag</a> is set, and whose
   <a id=fetching-scripts:use-url-credentials-flag-2 href=https://fetch.spec.whatwg.org/#concept-request-use-url-credentials-flag data-x-internal=use-url-credentials-flag>use-URL-credentials flag</a> is set.<li>
    <p>If the caller specified custom steps to <a href=#fetching-scripts-perform-fetch id=fetching-scripts:fetching-scripts-perform-fetch-7>perform
    the fetch</a>, perform them on <var>request</var>, with the <var id=fetching-scripts:fetching-scripts-is-top-level-4><a href=#fetching-scripts-is-top-level>is top-level</a></var> flag set. Let <var>response</var> be
    the result.</p>

    <p>Otherwise, <a href=https://fetch.spec.whatwg.org/#concept-fetch id=fetching-scripts:concept-fetch-6 data-x-internal=concept-fetch>fetch</a> <var>request</var>, and let
    <var>response</var> be the result.</p>

    <p class=note>Unlike other algorithms in this section, the fetching process is synchronous
    here. Thus any <a href=#fetching-scripts-perform-fetch id=fetching-scripts:fetching-scripts-perform-fetch-8>perform the fetch</a> steps must
    also finish their work synchronously.</p>
   <li><p>Let <var>response</var> be <var>response</var>'s <a href=#unsafe-response id=fetching-scripts:unsafe-response-3>unsafe response</a>.<li><p>If <var>response</var>'s <a href=https://fetch.spec.whatwg.org/#concept-response-type id=fetching-scripts:concept-response-type-3 data-x-internal=concept-response-type>type</a> is "<code>error</code>", or <var>response</var>'s <a href=https://fetch.spec.whatwg.org/#concept-response-status id=fetching-scripts:concept-response-status-3 data-x-internal=concept-response-status>status</a> is not an <a id=fetching-scripts:ok-status-3 href=https://fetch.spec.whatwg.org/#ok-status data-x-internal=ok-status>ok status</a>, throw a
   <a id=fetching-scripts:networkerror href=https://heycam.github.io/webidl/#networkerror data-x-internal=networkerror>"<code>NetworkError</code>"</a> <code id=fetching-scripts:domexception><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these
   steps.<li><p>Let <var>source text</var> be the result of <a href=https://encoding.spec.whatwg.org/#utf-8-decode id=fetching-scripts:utf-8-decode-2 data-x-internal=utf-8-decode>UTF-8
   decoding</a> <var>response</var>'s <a href=https://fetch.spec.whatwg.org/#concept-response-body id=fetching-scripts:concept-response-body-3 data-x-internal=concept-response-body>body</a>.<li>
    <p>Let <var>script</var> be the result of <a href=#creating-a-classic-script id=fetching-scripts:creating-a-classic-script-4>creating a classic script</a> using
    <var>source text</var> and <var>settings object</var>.</p>

    <p>If <var>response</var> was <a href=#cors-cross-origin id=fetching-scripts:cors-cross-origin-3>CORS-cross-origin</a>, then pass the <var>muted
    errors</var> flag to the <a href=#creating-a-classic-script id=fetching-scripts:creating-a-classic-script-5>create a classic
    script</a> algorithm as well.</p>
   <li><p>Return <var>script</var>.</ol>

  <p>To <dfn id=fetch-a-module-script-tree data-export="">fetch a module script graph</dfn> given
  a <var>url</var>, a <var>settings object</var>, a <var>destination</var>, a <var>cryptographic
  nonce</var>, a <var>parser state</var>, and a <var>credentials mode</var>, run these steps. The
  algorithm will asynchronously complete with either null (on failure) or a <a href=#module-script id=fetching-scripts:module-script-2>module
  script</a> (on success).</p>

  <ol><li><p>Perform the <a href=#internal-module-script-graph-fetching-procedure id=fetching-scripts:internal-module-script-graph-fetching-procedure>internal module script graph fetching procedure</a> given
   <var>url</var>, <var>settings object</var>, <var>destination</var>, <var>cryptographic
   nonce</var>, <var>parser state</var>, <var>credentials mode</var>, <var>settings object</var>, a
   new empty list, "<code>client</code>", and with the <var>top-level module fetch
   flag</var> set. If the caller of this algorithm specified custom <a href=#fetching-scripts-perform-fetch id=fetching-scripts:fetching-scripts-perform-fetch-9>perform the fetch</a> steps, pass those along as
   well.</p>

   <li><p>When the <a href=#internal-module-script-graph-fetching-procedure id=fetching-scripts:internal-module-script-graph-fetching-procedure-2>internal module script graph fetching procedure</a> asynchronously
   completes with <var>result</var>, asynchronously complete this algorithm with
   <var>result</var>.</ol>

  <p>To <dfn id=fetch-a-module-worker-script-tree data-export="">fetch a module worker script
  graph</dfn> given a <var>url</var>, a <var>fetch client settings object</var>, a
  <var>destination</var>, a <var>credentials mode</var>, and a <var>module map settings
  object</var>, run these steps. The algorithm will asynchronously complete with either null (on
  failure) or a <a href=#module-script id=fetching-scripts:module-script-3>module script</a> (on success).</p>

  <ol><li><p>Perform the <a href=#internal-module-script-graph-fetching-procedure id=fetching-scripts:internal-module-script-graph-fetching-procedure-3>internal module script graph fetching procedure</a> given
   <var>url</var>, <var>fetch client settings object</var>, <var>destination</var>, the empty
   string, "<code>not parser-inserted</code>", <var>credentials mode</var>, <var>module
   map settings object</var>, a new empty list, "<code>client</code>", and with the
   <var>top-level module fetch flag</var> set. If the caller of this algorithm specified custom
   <a href=#fetching-scripts-perform-fetch id=fetching-scripts:fetching-scripts-perform-fetch-10>perform the fetch</a> steps, pass those along as
   well.</p>

   <li><p>When the <a href=#internal-module-script-graph-fetching-procedure id=fetching-scripts:internal-module-script-graph-fetching-procedure-4>internal module script graph fetching procedure</a> asynchronously
   completes with <var>result</var>, asynchronously complete this algorithm with
   <var>result</var>.</ol>

  <hr>

  <p>The following algorithms are meant for internal use by this specification only as part of <a href=#fetch-a-module-script-tree id=fetching-scripts:fetch-a-module-script-tree-2>fetching a module script graph</a> or <a href=#prepare-a-script id=fetching-scripts:prepare-a-script>preparing a script</a>, and should not be used directly by other specifications.</p>

  <p>To perform the <dfn id=internal-module-script-graph-fetching-procedure>internal module script graph fetching procedure</dfn> given a
  <var>url</var>, a <var>fetch client settings object</var>, a <var>destination</var>, a
  <var>cryptographic nonce</var>, a <var>parser state</var>, a <var>credentials mode</var>, a
  <var>module map settings object</var>, an <var>ancestor list</var>, a <var>referrer</var>, and a
  <var>top-level module fetch</var> flag, perform these steps. The algorithm will asynchronously
  complete with either null (on failure) or a <a href=#module-script id=fetching-scripts:module-script-4>module script</a> (on success).</p>

  <ol><li><p><a href=#fetch-a-single-module-script id=fetching-scripts:fetch-a-single-module-script>Fetch a single module script</a> given <var>url</var>, <var>fetch client settings
   object</var>, <var>destination</var>, <var>cryptographic nonce</var>, <var>parser state</var>,
   <var>credentials mode</var>, <var>module map settings object</var>, <var>referrer</var>, and the
   <var>top-level module fetch</var> flag. If the caller of this algorithm specified custom <a href=#fetching-scripts-perform-fetch id=fetching-scripts:fetching-scripts-perform-fetch-11>perform the fetch</a> steps, pass those along while
   <a href=#fetch-a-single-module-script id=fetching-scripts:fetch-a-single-module-script-2>fetching a single module script</a>.</p>

   <li><p>Return from this algorithm, and run the following steps when <a href=#fetch-a-single-module-script id=fetching-scripts:fetch-a-single-module-script-3>fetching a single module script</a> asynchronously completes with
   <var>result</var>:<li><p>If <var>result</var> is null, asynchronously complete this algorithm with null and abort
   these steps.<li><p>Otherwise, <var>result</var> is a <a href=#module-script id=fetching-scripts:module-script-5>module script</a>. <a href=#fetch-the-descendants-of-a-module-script id=fetching-scripts:fetch-the-descendants-of-a-module-script>Fetch the descendants</a> of <var>result</var> given
   <var>destination</var> and an ancestor list obtained by appending <var>url</var> to <var>ancestor
   list</var>. Wait for <a href=#fetch-the-descendants-of-a-module-script id=fetching-scripts:fetch-the-descendants-of-a-module-script-2>fetching the
   descendants of a module script</a> to asynchronously complete with <var>descendants
   result</var> before proceeding to the next step.<li><p>Let <var>record</var> be <var>result</var>'s <a href=#concept-module-script-module-record id=fetching-scripts:concept-module-script-module-record>module record</a>.</p>

   <li>
    <p>Let <var>instantiationStatus</var> be <var>record</var>.<a href=https://tc39.github.io/ecma262/#sec-moduledeclarationinstantiation id=fetching-scripts:js-moduledeclarationinstantiation data-x-internal=js-moduledeclarationinstantiation>ModuleDeclarationInstantiation</a>().</p>

    <p class=note>This step will recursively call <a href=https://tc39.github.io/ecma262/#sec-moduledeclarationinstantiation id=fetching-scripts:js-moduledeclarationinstantiation-2 data-x-internal=js-moduledeclarationinstantiation>ModuleDeclarationInstantiation</a> all of the
    module's uninstantiated dependencies.</p>
   <li>
    <p>For each <a href=#module-script id=fetching-scripts:module-script-6>module script</a> <var>script</var> in <var>result</var>'s
    <a href=#uninstantiated-inclusive-descendant-module-scripts id=fetching-scripts:uninstantiated-inclusive-descendant-module-scripts>uninstantiated inclusive descendant module scripts</a>, perform the following
    steps:</p>

    <ol><li><p>If <var>instantiationStatus</var> is an abrupt completion, then set <var>script</var>'s
     <a href=#concept-module-script-instantiation-state id=fetching-scripts:concept-module-script-instantiation-state>instantiation state</a> to "<code>errored</code>", its <a href=#concept-module-script-instantiation-error id=fetching-scripts:concept-module-script-instantiation-error>instantiation error</a> to
     <var>instantiationStatus</var>.[[Value]], and its <a href=#concept-module-script-module-record id=fetching-scripts:concept-module-script-module-record-2>module record</a> to null.<li><p>Otherwise, set <var>script</var>'s <a href=#concept-module-script-instantiation-state id=fetching-scripts:concept-module-script-instantiation-state-2>instantiation state</a> to "<code>instantiated</code>".</ol>
   <li>
    <p>Asynchronously complete this algorithm with <var>descendants result</var>.</p>

    <p class=note>It is intentional that we complete with <var>descendants result</var> here, and
    not <var>result</var>, as this allows us to propagate error signals to the caller.</p>
   </ol>

  <p>In the above algorithm, a <a href=#module-script id=fetching-scripts:module-script-7>module script</a> <var>script</var>'s <dfn id=uninstantiated-inclusive-descendant-module-scripts>uninstantiated
  inclusive descendant module scripts</dfn> is a <a id=fetching-scripts:set href=https://infra.spec.whatwg.org/#ordered-set data-x-internal=set>set</a> of <a href=#module-script id=fetching-scripts:module-script-8>module scripts</a> determined as follows:</p>

  <ol><li><p>Let <var>moduleMap</var> be <var>script</var>'s <a href=#settings-object id=fetching-scripts:settings-object>settings object</a>'s
   <a href=#concept-settings-object-module-map id=fetching-scripts:concept-settings-object-module-map>module map</a>.<li><p>Let <var>stack</var> be the <a id=fetching-scripts:stack href=https://infra.spec.whatwg.org/#stack data-x-internal=stack>stack</a>  <var>script</var> .<li><p>Let <var>inclusive descendants</var> be an empty <a id=fetching-scripts:set-2 href=https://infra.spec.whatwg.org/#ordered-set data-x-internal=set>set</a>.<li>
    <p>While <var>stack</var> <a href=https://infra.spec.whatwg.org/#list-is-empty id=fetching-scripts:list-is-empty data-x-internal=list-is-empty>is not empty</a>:</p>

    <ol><li><p>Let <var>current</var> the result of <a href=https://infra.spec.whatwg.org/#stack-pop id=fetching-scripts:stack-pop data-x-internal=stack-pop>popping</a> from
     <var>stack</var>.<li>
      <p>If <var>inclusive descendants</var> and <var>stack</var> both do not <a href=https://infra.spec.whatwg.org/#list-contains id=fetching-scripts:list-contains data-x-internal=list-contains>contain</a> <var>current</var>, then:</p>

      <ol><li><p><a href=https://infra.spec.whatwg.org/#list-append id=fetching-scripts:list-append data-x-internal=list-append>Append</a> <var>current</var> to
       <var>inclusive descendants</var>.<li><p>Let <var>child specifiers</var> be the value of <var>current</var>'s <a href=#concept-module-script-module-record id=fetching-scripts:concept-module-script-module-record-3>module record</a>'s [[RequestedModules]]
       internal slot.<li><p>Let <var>child URLs</var> be the <a id=fetching-scripts:list href=https://infra.spec.whatwg.org/#list data-x-internal=list>list</a> obtained by calling
       <a href=#resolve-a-module-specifier id=fetching-scripts:resolve-a-module-specifier>resolve a module specifier</a> once for each item of <var>child specifiers</var>,
       given <var>current</var> and that item. Omit any failures.<li><p>Let <var>child modules</var> be the <a id=fetching-scripts:list-2 href=https://infra.spec.whatwg.org/#list data-x-internal=list>list</a> obtained by <a href=https://infra.spec.whatwg.org/#map-get id=fetching-scripts:map-get data-x-internal=map-get>getting each value</a> in <var>moduleMap</var> whose key is given by an
       item of <var>child URLs</var>.<li><p><a href=https://infra.spec.whatwg.org/#list-iterate id=fetching-scripts:list-iterate data-x-internal=list-iterate>For each</a> <var>s</var> in <var>child modules</var>
       that is not <a href=https://infra.spec.whatwg.org/#list-contains id=fetching-scripts:list-contains-2 data-x-internal=list-contains>contained by</a> <var>inclusive
       descendants</var>, <a href=https://infra.spec.whatwg.org/#stack-push id=fetching-scripts:stack-push data-x-internal=stack-push>push</a> <var>s</var> onto
       <var>stack</var>.</ol>
     </ol>
   <li><p>Return a <a id=fetching-scripts:set-3 href=https://infra.spec.whatwg.org/#ordered-set data-x-internal=set>set</a> containing all items of <var>inclusive descendants</var> whose
   <a href=#concept-module-script-instantiation-state id=fetching-scripts:concept-module-script-instantiation-state-3>instantiation state</a> is "<code>uninstantiated</code>".</ol>

  <p class=note>The above algorithm gives a depth-first search of the module dependency graph. The
  main interesting part is in how the "edges" of this graph are determined. The actual search
  implementation is not important; any other technique for exploring the graph will suffice, given
  that the output is a <a id=fetching-scripts:set-4 href=https://infra.spec.whatwg.org/#ordered-set data-x-internal=set>set</a> only used for membership testing and whose order is thus not
  important.</p>

  <p>To <dfn id=fetch-a-single-module-script>fetch a single module script</dfn>, given a <var>url</var>, a <var>fetch client
  settings object</var>, a <var>destination</var>, a <var>cryptographic nonce</var>, a <var>parser
  state</var>, a <var>credentials mode</var>, a <var>module map settings object</var>, a
  <var>referrer</var>, and a <var>top-level module fetch</var> flag, run these steps. The algorithm
  will asynchronously complete with either null (on failure) or a <a href=#module-script id=fetching-scripts:module-script-9>module script</a> (on
  success).</p>

  <ol><li><p>Let <var>moduleMap</var> be <var>module map settings object</var>'s <a href=#concept-settings-object-module-map id=fetching-scripts:concept-settings-object-module-map-2>module map</a>.<li><p>If <var>moduleMap</var>[<var>url</var>] is "<code>fetching</code>", wait
   <a href=#in-parallel id=fetching-scripts:in-parallel>in parallel</a> until that entry's value changes, then <a href=#queue-a-task id=fetching-scripts:queue-a-task>queue a task</a> on
   the <a href=#networking-task-source id=fetching-scripts:networking-task-source>networking task source</a> to proceed with running the following steps.<li><p>If <var>moduleMap</var>[<var>url</var>] <a href=https://infra.spec.whatwg.org/#map-exists id=fetching-scripts:map-exists data-x-internal=map-exists>exists</a>,
   asynchronously complete this algorithm with <var>moduleMap</var>[<var>url</var>], and abort these
   steps.<li><p><a href=https://infra.spec.whatwg.org/#map-set id=fetching-scripts:map-set data-x-internal=map-set>Set</a> <var>moduleMap</var>[<var>url</var>] to "<code>fetching</code>".</p>

   <li><p>Let <var>request</var> be a new <a href=https://fetch.spec.whatwg.org/#concept-request id=fetching-scripts:concept-request-7 data-x-internal=concept-request>request</a> whose
   <a href=https://fetch.spec.whatwg.org/#concept-request-url id=fetching-scripts:concept-request-url-3 data-x-internal=concept-request-url>url</a> is <var>url</var>, <a href=https://fetch.spec.whatwg.org/#concept-request-destination id=fetching-scripts:concept-request-destination-3 data-x-internal=concept-request-destination>destination</a> is <var>destination</var>, <a href=https://fetch.spec.whatwg.org/#concept-request-type id=fetching-scripts:concept-request-type-4 data-x-internal=concept-request-type>type</a> is "<code>script</code>", <a href=https://fetch.spec.whatwg.org/#concept-request-mode id=fetching-scripts:concept-request-mode-2 data-x-internal=concept-request-mode>mode</a> is "<code>cors</code>", <a href=https://fetch.spec.whatwg.org/#concept-request-credentials-mode id=fetching-scripts:concept-request-credentials-mode-2 data-x-internal=concept-request-credentials-mode>credentials mode</a> is <var>credentials
   mode</var>, <a href=https://fetch.spec.whatwg.org/#concept-request-nonce-metadata id=fetching-scripts:concept-request-nonce-metadata-2 data-x-internal=concept-request-nonce-metadata>cryptographic nonce metadata</a> is
   <var>cryptographic nonce</var>, <a href=https://fetch.spec.whatwg.org/#concept-request-parser-metadata id=fetching-scripts:concept-request-parser-metadata-4 data-x-internal=concept-request-parser-metadata>parser
   metadata</a> is <var>parser state</var>, <a href=https://fetch.spec.whatwg.org/#concept-request-referrer id=fetching-scripts:concept-request-referrer data-x-internal=concept-request-referrer>referrer</a> is <var>referrer</var>, and <a href=https://fetch.spec.whatwg.org/#concept-request-client id=fetching-scripts:concept-request-client-4 data-x-internal=concept-request-client>client</a> is <var>fetch client settings
   object</var>.<li>
    <p>If the caller specified custom steps to <a href=#fetching-scripts-perform-fetch id=fetching-scripts:fetching-scripts-perform-fetch-12>perform
    the fetch</a>, perform them on <var>request</var>, setting the <var id=fetching-scripts:fetching-scripts-is-top-level-5><a href=#fetching-scripts-is-top-level>is top-level</a></var> flag if the <var>top-level module
    fetch</var> flag is set. Return from this algorithm, and when the custom <a href=#fetching-scripts-perform-fetch id=fetching-scripts:fetching-scripts-perform-fetch-13>perform the fetch</a> steps complete with <a href=https://fetch.spec.whatwg.org/#concept-response id=fetching-scripts:concept-response-9 data-x-internal=concept-response>response</a> <var>response</var>, run the remaining steps.</p>

    <p>Otherwise, <a href=https://fetch.spec.whatwg.org/#concept-fetch id=fetching-scripts:concept-fetch-7 data-x-internal=concept-fetch>fetch</a> <var>request</var>. Return from this
    algorithm, and run the remaining steps as part of the fetch's <a id=fetching-scripts:process-response-3 href=https://fetch.spec.whatwg.org/#process-response data-x-internal=process-response>process response</a> for
    the <a href=https://fetch.spec.whatwg.org/#concept-response id=fetching-scripts:concept-response-10 data-x-internal=concept-response>response</a> <var>response</var>.</p>

    <p class=note><var>response</var> is always <a href=#cors-same-origin id=fetching-scripts:cors-same-origin-2>CORS-same-origin</a>.</p>
   <li>
    <p>If any of the following conditions are met, <a href=https://infra.spec.whatwg.org/#map-set id=fetching-scripts:map-set-2 data-x-internal=map-set>set</a>
    <var>moduleMap</var>[<var>url</var>] to null, asynchronously complete this algorithm with null,
    and abort these steps:</p>

    <ul class=compact><li><p><var>response</var>'s <a href=https://fetch.spec.whatwg.org/#concept-response-type id=fetching-scripts:concept-response-type-4 data-x-internal=concept-response-type>type</a> is "<code>error</code>"<li><p><var>response</var>'s <a href=https://fetch.spec.whatwg.org/#concept-response-status id=fetching-scripts:concept-response-status-4 data-x-internal=concept-response-status>status</a> is not an
     <a id=fetching-scripts:ok-status-4 href=https://fetch.spec.whatwg.org/#ok-status data-x-internal=ok-status>ok status</a><li>
      <p>The result of <a href=https://fetch.spec.whatwg.org/#concept-header-extract-mime-type id=fetching-scripts:extract-a-mime-type data-x-internal=extract-a-mime-type>extracting a MIME type</a> from
      <var>response</var>'s <a href=https://fetch.spec.whatwg.org/#concept-response-header-list id=fetching-scripts:concept-response-header-list data-x-internal=concept-response-header-list>header list</a>
      (ignoring parameters) is not a <a href=#javascript-mime-type id=fetching-scripts:javascript-mime-type>JavaScript MIME type</a></p>

      <p class=note>For historical reasons, <a href=#fetch-a-classic-script id=fetching-scripts:fetch-a-classic-script>fetching a
      classic script</a> does not include MIME type checking. In contrast, module scripts will
      fail to load if they are not of a correct MIME type.</p>
     </ul>
   <li><p>Let <var>source text</var> be the result of <a href=https://encoding.spec.whatwg.org/#utf-8-decode id=fetching-scripts:utf-8-decode-3 data-x-internal=utf-8-decode>UTF-8
   decoding</a> <var>response</var>'s <a href=https://fetch.spec.whatwg.org/#concept-response-body id=fetching-scripts:concept-response-body-4 data-x-internal=concept-response-body>body</a>.<li><p>Let <var>module script</var> be the result of <a href=#creating-a-module-script id=fetching-scripts:creating-a-module-script>creating a module script</a> given
   <var>source text</var>, <var>module map settings object</var>, <var>response</var>'s <a href=https://fetch.spec.whatwg.org/#concept-response-url id=fetching-scripts:concept-response-url data-x-internal=concept-response-url>url</a>, <var>cryptographic
   nonce</var>, <var>parser state</var>, and <var>credentials mode</var>.<li>
    <p><a href=https://infra.spec.whatwg.org/#map-set id=fetching-scripts:map-set-3 data-x-internal=map-set>Set</a> <var>moduleMap</var>[<var>url</var>] to <var>module
    script</var>, and asynchronously complete this algorithm with <var>module script</var>.</p>

    <p class=note>It is intentional that the <a href=#module-map id=fetching-scripts:module-map>module map</a> is keyed by the <a href=https://fetch.spec.whatwg.org/#concept-request-url id=fetching-scripts:concept-request-url-4 data-x-internal=concept-request-url>request URL</a>, whereas the <a href=#concept-module-script-base-url id=fetching-scripts:concept-module-script-base-url>base URL</a> for the <a href=#module-script id=fetching-scripts:module-script-10>module script</a> is
    set to the <a href=https://fetch.spec.whatwg.org/#concept-response-url id=fetching-scripts:concept-response-url-2 data-x-internal=concept-response-url>response URL</a>. The former is used to
    deduplicate fetches, while the latter is used for URL resolution.</p>
   </ol>

  <p>To <dfn id=fetch-the-descendants-of-a-module-script>fetch the descendants of a module script</dfn> <var>module script</var>, given a
  <var>destination</var> and an <var>ancestor list</var>, run these steps. The algorithm will
  asynchronously complete with either null (on failure) or with <var>module script</var> (on
  success).</p>

  <ol><li><p>Let <var>record</var> be <var>module script</var>'s <a href=#concept-module-script-module-record id=fetching-scripts:concept-module-script-module-record-4>module record</a>.<li><p>If <var>record</var>.[[RequestedModules]] <a href=https://infra.spec.whatwg.org/#list-is-empty id=fetching-scripts:list-is-empty-2 data-x-internal=list-is-empty>is empty</a>,
   asynchronously complete this algorithm with <var>module script</var>.<li><p>Let <var>urls</var> be a new empty <a id=fetching-scripts:list-3 href=https://infra.spec.whatwg.org/#list data-x-internal=list>list</a>.<li>
    <p><a href=https://infra.spec.whatwg.org/#list-iterate id=fetching-scripts:list-iterate-2 data-x-internal=list-iterate>For each</a> string <var>requested</var> of
    <var>record</var>.[[RequestedModules]],</p>

    <ol><li><p>Let <var>url</var> be the result of <a href=#resolve-a-module-specifier id=fetching-scripts:resolve-a-module-specifier-2>resolving
     a module specifier</a> given <var>module script</var> and <var>requested</var>.<li>
      <p>If the result is error:</p>

      <ol><li><p>Let <var>error</var> be a new <code id=fetching-scripts:typeerror><a data-x-internal=typeerror href=https://tc39.github.io/ecma262/#sec-native-error-types-used-in-this-standard-typeerror>TypeError</a></code> exception.<li><p><a href=#report-the-exception id=fetching-scripts:report-the-exception>Report the exception</a> <var>error</var> for <var>module
       script</var>.<li><p>Abort this algorithm, and asynchronously complete it with null.</ol>
     <li><p>Otherwise, if <var>ancestor list</var> does not <a href=https://infra.spec.whatwg.org/#list-contains id=fetching-scripts:list-contains-3 data-x-internal=list-contains>contain</a> <var>url</var>, <a href=https://infra.spec.whatwg.org/#list-append id=fetching-scripts:list-append-2 data-x-internal=list-append>append</a>
     <var>url</var> to <var>urls</var>.</ol>
   <li>
    <p><a href=https://infra.spec.whatwg.org/#list-iterate id=fetching-scripts:list-iterate-3 data-x-internal=list-iterate>For each</a> <var>url</var> in <var>urls</var>, perform the
    <a href=#internal-module-script-graph-fetching-procedure id=fetching-scripts:internal-module-script-graph-fetching-procedure-5>internal module script graph fetching procedure</a> given <var>url</var>, <var>module
    script</var>'s <a href=#concept-module-script-credentials-mode id=fetching-scripts:concept-module-script-credentials-mode>credentials mode</a>,
    <var>module script</var>'s <a href=#concept-module-script-nonce id=fetching-scripts:concept-module-script-nonce>cryptographic
    nonce</a>, <var>module script</var>'s <a href=#concept-module-script-parser id=fetching-scripts:concept-module-script-parser>parser
    state</a>, <var>destination</var>, <var>module script</var>'s <a href=#settings-object id=fetching-scripts:settings-object-2>settings object</a>,
    <var>module script</var>'s <a href=#settings-object id=fetching-scripts:settings-object-3>settings object</a>, <var>ancestor list</var>, <var>module
    script</var>'s <a href=#concept-module-script-base-url id=fetching-scripts:concept-module-script-base-url-2>base URL</a>, and with the
    <var>top-level module fetch</var> flag unset. If the caller of this algorithm specified custom
    <a href=#fetching-scripts-perform-fetch id=fetching-scripts:fetching-scripts-perform-fetch-14>perform the fetch</a> steps, pass those along
    while performing the <a href=#internal-module-script-graph-fetching-procedure id=fetching-scripts:internal-module-script-graph-fetching-procedure-6>internal module script graph fetching procedure</a>.</p>

    <p>Wait for all of the <a href=#internal-module-script-graph-fetching-procedure id=fetching-scripts:internal-module-script-graph-fetching-procedure-7>internal module script graph fetching procedure</a> invocations
    to asynchronously complete. If any of them asynchronously complete with null, then
    asynchronously complete this algorithm with null. Otherwise, asynchronously complete this
    algorithm with <var>module script</var>.</p>
   </ol>

  <h5 id=creating-scripts>8.1.3.3 Creating scripts<a href=#creating-scripts class=self-link></a></h5>

  <p>To <dfn id=creating-a-classic-script>create a classic script</dfn>, given some script
  source, an <a href=#environment-settings-object id=creating-scripts:environment-settings-object>environment settings object</a>, and an optional <var>muted errors</var>
  flag:</p>

  <ol><li><p>Let <var>script</var> be a new <a href=#classic-script id=creating-scripts:classic-script>classic script</a> that this algorithm will
   subsequently initialize.<li><p>Set <var>script</var>'s <a href=#settings-object id=creating-scripts:settings-object>settings object</a> to the <a href=#environment-settings-object id=creating-scripts:environment-settings-object-2>environment
   settings object</a> provided.<li><p>If <a href=#concept-bc-noscript id=creating-scripts:concept-bc-noscript>scripting is disabled</a> for the given
   <a href=#environment-settings-object id=creating-scripts:environment-settings-object-3>environment settings object</a>'s <a href=#responsible-browsing-context id=creating-scripts:responsible-browsing-context>responsible browsing context</a>, then set
   <var>script</var>'s <a href=#concept-classic-script-source-text id=creating-scripts:concept-classic-script-source-text>source text</a> to the
   empty string. Otherwise, set <var>script</var>'s <a href=#concept-classic-script-source-text id=creating-scripts:concept-classic-script-source-text-2>source text</a> to the supplied script
   source.<li><p>If the <var>muted errors</var> flag was set, then set <var>script</var>'s <a href=#muted-errors id=creating-scripts:muted-errors>muted
   errors</a> flag.<li><p>Return <var>script</var>.</ol>

  <p>To <dfn id=creating-a-module-script>create a module script</dfn>, given some script
  source, an <a href=#environment-settings-object id=creating-scripts:environment-settings-object-4>environment settings object</a>, a script base URL, a cryptographic nonce, a
  parser state, and a credentials mode:</p>

  <ol><li><p>Let <var>script</var> be a new <a href=#module-script id=creating-scripts:module-script>module script</a> that this algorithm will
   subsequently initialize.<li><p>Set <var>script</var>'s <a href=#settings-object id=creating-scripts:settings-object-2>settings object</a> to the <a href=#environment-settings-object id=creating-scripts:environment-settings-object-5>environment
   settings object</a> provided.<li><p>Let <var>realm</var> be the provided <a href=#environment-settings-object id=creating-scripts:environment-settings-object-6>environment settings object</a>'s <a href="#environment-settings-object's-realm" id="creating-scripts:environment-settings-object's-realm">Realm</a>.<li><p>If <a href=#concept-bc-noscript id=creating-scripts:concept-bc-noscript-2>scripting is disabled</a> for the given
   <a href=#environment-settings-object id=creating-scripts:environment-settings-object-7>environment settings object</a>'s <a href=#responsible-browsing-context id=creating-scripts:responsible-browsing-context-2>responsible browsing context</a>, then let
   <var>script source</var> be the empty string. Otherwise, let <var>script source</var> be the
   provided script source.<li><p>Let <var>result</var> be <a href=https://tc39.github.io/ecma262/#sec-parsemodule id=creating-scripts:js-parsemodule data-x-internal=js-parsemodule>ParseModule</a>(<var>script source</var>, <var>realm</var>,
   <var>script</var>).<li><p>If <var>result</var> is a <a id=creating-scripts:list href=https://infra.spec.whatwg.org/#list data-x-internal=list>List</a> of errors, <a href=#report-the-exception id=creating-scripts:report-the-exception>report the exception</a>
   given by the first element of <var>result</var> for <var>script</var>, return null, and abort
   these steps.<li><p>Set <var>script</var>'s <a href=#concept-module-script-module-record id=creating-scripts:concept-module-script-module-record>module
   record</a> to <var>result</var>.<li><p>Set <var>script</var>'s <a href=#concept-module-script-base-url id=creating-scripts:concept-module-script-base-url>base URL</a> to
   the script base URL provided.<li><p>Set <var>script</var>'s <a href=#concept-module-script-nonce id=creating-scripts:concept-module-script-nonce>cryptographic
   nonce</a> to the cryptographic nonce provided.<li><p>Set <var>script</var>'s <a href=#concept-module-script-parser id=creating-scripts:concept-module-script-parser>parser state</a>
   to the parser state.<li><p>Set <var>script</var>'s <a href=#concept-module-script-credentials-mode id=creating-scripts:concept-module-script-credentials-mode>credentials
   mode</a> to the credentials mode provided.<li><p>Return <var>script</var>.</ol>

  <h5 id=calling-scripts>8.1.3.4 Calling scripts<a href=#calling-scripts class=self-link></a></h5>

  <p>To <dfn id=run-a-classic-script data-export="">run a classic script</dfn> given a <a href=#classic-script id=calling-scripts:classic-script>classic script</a>
  <var>s</var> and an optional <var>rethrow errors</var> flag:</p>

  <ol><li><p>Let <var>settings</var> be the <a href=#settings-object id=calling-scripts:settings-object>settings object</a> of <var>s</var>.<li><p><a href=#check-if-we-can-run-script id=calling-scripts:check-if-we-can-run-script>Check if we can run script</a> with <var>settings</var>. If this returns "do not
   run", then return undefined and abort these steps.<li><p>Let <var>realm</var> be <var>settings</var>'s <a href="#environment-settings-object's-realm" id="calling-scripts:environment-settings-object's-realm">Realm</a>.<li><p><a href=#prepare-to-run-script id=calling-scripts:prepare-to-run-script>Prepare to run script</a> with <var>settings</var>.<li><p>Let <var>result</var> be <a href=https://tc39.github.io/ecma262/#sec-parse-script id=calling-scripts:js-parsescript data-x-internal=js-parsescript>ParseScript</a>(<var>s</var>'s <a href=#concept-classic-script-source-text id=calling-scripts:concept-classic-script-source-text>source text</a>, <var>realm</var>,
   <var>s</var>).<li><p>If <var>result</var> is a <a id=calling-scripts:list href=https://infra.spec.whatwg.org/#list data-x-internal=list>List</a> of errors, set <var>result</var> to the first
   element of <var>result</var> and go to the step labeled <i>error</i>.<li><p>Let <var>evaluationStatus</var> be <a href=https://tc39.github.io/ecma262/#sec-runtime-semantics-scriptevaluation id=calling-scripts:js-scriptevaluation data-x-internal=js-scriptevaluation>ScriptEvaluation</a>(<var>result</var>).<li><p>If <var>evaluationStatus</var> is an abrupt completion, set <var>result</var> to
   <var>evaluationStatus</var>.[[Value]] and go to the next step (labeled <i>error</i>). If
   <var>evaluationStatus</var> is a normal completion, or if <a href=https://tc39.github.io/ecma262/#sec-runtime-semantics-scriptevaluation id=calling-scripts:js-scriptevaluation-2 data-x-internal=js-scriptevaluation>ScriptEvaluation</a> does not complete because the user agent
   has <a href=#abort-a-running-script id=calling-scripts:abort-a-running-script>aborted the running script</a>, skip to the step
   labeled <i>cleanup</i>.<li>
    <p><i>Error</i>: At this point <var>result</var> must be an exception. Perform the following
    steps:</p>

    <ol><li><p>If the <var>rethrow errors</var> flag is set and <var>s</var>'s <a href=#muted-errors id=calling-scripts:muted-errors>muted
     errors</a> flag is not set, rethrow <var>result</var>.<li><p>If the <var>rethrow errors</var> flag is set and <var>s</var>'s <a href=#muted-errors id=calling-scripts:muted-errors-2>muted
     errors</a> flag is set, throw a <a id=calling-scripts:networkerror href=https://heycam.github.io/webidl/#networkerror data-x-internal=networkerror>"<code>NetworkError</code>"</a>
     <code id=calling-scripts:domexception><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code>.<li><p>If the <var>rethrow errors</var> flag is not set, <a href=#report-the-exception id=calling-scripts:report-the-exception>report the exception</a>
     given by <var>result</var> for the script <var>s</var>.</ol>
   <li><p><i>Cleanup</i>: <a href=#clean-up-after-running-script id=calling-scripts:clean-up-after-running-script>Clean up after running script</a> with
   <var>settings</var>.<li><p>If <var>evaluationStatus</var> exists and is a normal completion, return
   <var>evaluationStatus</var>.[[Value]]. Otherwise, script execution was unsuccessful, either
   because an error occurred during parsing, or an exception occurred during evaluation, or because
   it was <a href=#abort-a-running-script id=calling-scripts:abort-a-running-script-2>aborted prematurely</a>.</ol>

  <p>To <dfn id=run-a-module-script data-export="">run a module script</dfn> given a <a href=#module-script id=calling-scripts:module-script>module script</a>
  <var>s</var>:</p>

  <ol><li><p>Let <var>settings</var> be the <a href=#settings-object id=calling-scripts:settings-object-2>settings object</a> of <var>s</var>.<li><p><a href=#check-if-we-can-run-script id=calling-scripts:check-if-we-can-run-script-2>Check if we can run script</a> with <var>settings</var>. If this returns "do
   not run" then abort these steps.<li><p>If <var>s</var>'s <a href=#concept-module-script-instantiation-state id=calling-scripts:concept-module-script-instantiation-state>instantiation
   state</a> is "<code>errored</code>", then <a href=#report-the-exception id=calling-scripts:report-the-exception-2>report the
   exception</a> given by <var>s</var>'s <a href=#concept-module-script-instantiation-error id=calling-scripts:concept-module-script-instantiation-error>instantiation error</a> for <var>s</var>
   and abort these steps.<li><p>Assert: <var>s</var>'s <a href=#concept-module-script-instantiation-state id=calling-scripts:concept-module-script-instantiation-state-2>instantiation state</a> is "<code>instantiated</code>" (and thus its <a href=#concept-module-script-module-record id=calling-scripts:concept-module-script-module-record>module record</a> is not null).<li><p>Let <var>record</var> be <var>s</var>'s <a href=#concept-module-script-module-record id=calling-scripts:concept-module-script-module-record-2>module record</a>.</p>

   <li><p><a href=#prepare-to-run-script id=calling-scripts:prepare-to-run-script-2>Prepare to run script</a> given <var>settings</var>.<li>
    <p>Let <var>evaluationStatus</var> be <var>record</var>.<a href=https://tc39.github.io/ecma262/#sec-moduleevaluation id=calling-scripts:js-moduleevaluation data-x-internal=js-moduleevaluation>ModuleEvaluation</a>().</p>

    <p class=note>This step will recursively evaluate all of the module's dependencies.</p>
   <li><p>If <var>evaluationStatus</var> is an abrupt completion, then <a href=#report-the-exception id=calling-scripts:report-the-exception-3>report the
   exception</a> given by <var>evaluationStatus</var>.[[Value]] for <var>s</var>. (Do not perform
   this step if <a href=https://tc39.github.io/ecma262/#sec-moduleevaluation id=calling-scripts:js-moduleevaluation-2 data-x-internal=js-moduleevaluation>ModuleEvaluation</a> fails to complete as a
   result of the user agent <a href=#abort-a-running-script id=calling-scripts:abort-a-running-script-3>aborting the running
   script</a>.)<li><p><a href=#clean-up-after-running-script id=calling-scripts:clean-up-after-running-script-2>Clean up after running script</a> with <var>settings</var>.</ol>

  <p>The steps to <dfn id=check-if-we-can-run-script>check if we can run script</dfn> with an <a href=#environment-settings-object id=calling-scripts:environment-settings-object>environment settings
  object</a> <var>settings</var> are as follows. They return either "run" or "do not run".</p>

  <ol><li><p>If the <a href=#concept-settings-object-global id=calling-scripts:concept-settings-object-global>global object</a> specified by
   <var>settings</var> is a <code id=calling-scripts:window><a href=#window>Window</a></code> object whose <code id=calling-scripts:document><a href=#document>Document</a></code> object is not
   <a href=#fully-active id=calling-scripts:fully-active>fully active</a>, then return "do not run" and abort these steps.</p>

   <li><p>If <a href=#concept-bc-noscript id=calling-scripts:concept-bc-noscript>scripting is disabled</a> for the
   <a href=#responsible-browsing-context id=calling-scripts:responsible-browsing-context>responsible browsing context</a> specified by <var>settings</var>, then return "do
   not run" and abort these steps.</p>

   <li><p>Return "run".</ol>

  <p>The steps to <dfn id=prepare-to-run-script data-export="">prepare to run script</dfn> with an <a href=#environment-settings-object id=calling-scripts:environment-settings-object-2>environment settings
  object</a> <var>settings</var> are as follows:</p>

  <ol><li><p>Increment <var>settings</var>'s <a href=#realm-execution-context id=calling-scripts:realm-execution-context>realm execution context</a>'s <a href=#entrance-counter id=calling-scripts:entrance-counter>entrance
   counter</a> by one.<li><p>Push <var>settings</var>'s <a href=#realm-execution-context id=calling-scripts:realm-execution-context-2>realm execution context</a> onto the <a id=calling-scripts:javascript-execution-context-stack href=https://tc39.github.io/ecma262/#execution-context-stack data-x-internal=javascript-execution-context-stack>JavaScript
   execution context stack</a>; it is now the <a id=calling-scripts:running-javascript-execution-context href=https://tc39.github.io/ecma262/#running-execution-context data-x-internal=running-javascript-execution-context>running JavaScript execution
   context</a>.</ol>

  <p>The steps to <dfn id=clean-up-after-running-script data-export="">clean up after running script</dfn> with an <a href=#environment-settings-object id=calling-scripts:environment-settings-object-3>environment
  settings object</a> <var>settings</var> are as follows:</p>

  <ol><li><p>Assert: <var>settings</var>'s <a href=#realm-execution-context id=calling-scripts:realm-execution-context-3>realm execution context</a> is the <a id=calling-scripts:running-javascript-execution-context-2 href=https://tc39.github.io/ecma262/#running-execution-context data-x-internal=running-javascript-execution-context>running
   JavaScript execution context</a>.<li><p>Remove <var>settings</var>'s <a href=#realm-execution-context id=calling-scripts:realm-execution-context-4>realm execution context</a> from the
   <a id=calling-scripts:javascript-execution-context-stack-2 href=https://tc39.github.io/ecma262/#execution-context-stack data-x-internal=javascript-execution-context-stack>JavaScript execution context stack</a>.<li><p>Decrement <var>settings</var>'s <a href=#realm-execution-context id=calling-scripts:realm-execution-context-5>realm execution context</a>'s <a href=#entrance-counter id=calling-scripts:entrance-counter-2>entrance
   counter</a> by one.<li><p>If the <a id=calling-scripts:javascript-execution-context-stack-3 href=https://tc39.github.io/ecma262/#execution-context-stack data-x-internal=javascript-execution-context-stack>JavaScript execution context stack</a> is now empty, <a href=#perform-a-microtask-checkpoint id=calling-scripts:perform-a-microtask-checkpoint>perform a
   microtask checkpoint</a>. (If this runs scripts, these algorithms will be invoked
   reentrantly.)</ol>

  <p class=note>These algorithms are not invoked by one script directly calling another, but they
  can be invoked reentrantly in an indirect manner, e.g. if a script dispatches an event which has
  event listeners registered.</p>

  <p>The <dfn id=running-script>running script</dfn> is the <a href=#the-script-element id=calling-scripts:the-script-element>script</a> in the [[HostDefined]] field in the
  ScriptOrModule component of the <a id=calling-scripts:running-javascript-execution-context-3 href=https://tc39.github.io/ecma262/#running-execution-context data-x-internal=running-javascript-execution-context>running JavaScript execution context</a>.</p>

  <h5 id=realms-settings-objects-global-objects>8.1.3.5 Realms, settings objects, and global objects<a href=#realms-settings-objects-global-objects class=self-link></a></h5>

  <p>A <dfn id=global-object data-export="">global object</dfn> is a JavaScript object that is the [[GlobalObject]]
  field of a <a id=realms-settings-objects-global-objects:javascript-realm href=https://tc39.github.io/ecma262/#sec-code-realms data-x-internal=javascript-realm>JavaScript realm</a>.</p>

  <p class=note>In this specification, all <a href=https://tc39.github.io/ecma262/#sec-code-realms id=realms-settings-objects-global-objects:javascript-realm-2 data-x-internal=javascript-realm>JavaScript
  realms</a> are <a href=https://tc39.github.io/ecma262/#sec-initializehostdefinedrealm id=realms-settings-objects-global-objects:js-initializehostdefinedrealm data-x-internal=js-initializehostdefinedrealm>initialized</a> with <a href=#global-object id=realms-settings-objects-global-objects:global-object>global objects</a> that are either <code id=realms-settings-objects-global-objects:window><a href=#window>Window</a></code> or
  <code id=realms-settings-objects-global-objects:workerglobalscope><a href=#workerglobalscope>WorkerGlobalScope</a></code> objects.</p>

  <p>There is always a 1-to-1-to-1 mapping between <a href=https://tc39.github.io/ecma262/#sec-code-realms id=realms-settings-objects-global-objects:javascript-realm-3 data-x-internal=javascript-realm>JavaScript
  realms</a>, <a href=#global-object id=realms-settings-objects-global-objects:global-object-2>global objects</a>, and <a href=#environment-settings-object id=realms-settings-objects-global-objects:environment-settings-object>environment settings objects</a>:</p>

  <ul><li><p>A <a id=realms-settings-objects-global-objects:javascript-realm-4 href=https://tc39.github.io/ecma262/#sec-code-realms data-x-internal=javascript-realm>JavaScript realm</a> has a [[HostDefined]] field, which contains <dfn data-dfn-for=Realm id=concept-realm-settings-object data-lt="settings object" data-export="">the Realm's settings object</dfn>.<li><p>A <a id=realms-settings-objects-global-objects:javascript-realm-5 href=https://tc39.github.io/ecma262/#sec-code-realms data-x-internal=javascript-realm>JavaScript realm</a> has a [[GlobalObject]] field, which contains <dfn data-dfn-for=Realm id=concept-realm-global data-lt="global object" data-export="">the
   Realm's global object</dfn>.<li><p>Each <a href=#global-object id=realms-settings-objects-global-objects:global-object-3>global object</a> in this specification is created during the <a href=https://tc39.github.io/ecma262/#sec-initializehostdefinedrealm id=realms-settings-objects-global-objects:js-initializehostdefinedrealm-2 data-x-internal=js-initializehostdefinedrealm>initialization</a> of a corresponding <a id=realms-settings-objects-global-objects:javascript-realm-6 href=https://tc39.github.io/ecma262/#sec-code-realms data-x-internal=javascript-realm>JavaScript
   realm</a>, known as <dfn data-dfn-for="global object" id=concept-global-object-realm data-lt=Realm data-export="">the global object's Realm</dfn>.<li id=relevant-settings-object-for-a-global-object><p>Each <a href=#global-object id=realms-settings-objects-global-objects:global-object-4>global object</a> in this
   specification is created alongside a corresponding <a href=#environment-settings-object id=realms-settings-objects-global-objects:environment-settings-object-2>environment settings object</a>,
   known as its <a href=#relevant-settings-object id=realms-settings-objects-global-objects:relevant-settings-object>relevant settings object</a>.</p>

   <li><p>An <a href=#environment-settings-object id=realms-settings-objects-global-objects:environment-settings-object-3>environment settings object</a>'s <a href=#realm-execution-context id=realms-settings-objects-global-objects:realm-execution-context>realm execution context</a>'s
   Realm component is <dfn data-dfn-for="environment settings object" id="environment-settings-object's-realm" data-lt=Realm data-export="">the environment settings object's
   Realm</dfn>.<li><p>An <a href=#environment-settings-object id=realms-settings-objects-global-objects:environment-settings-object-4>environment settings object</a>'s <a href="#environment-settings-object's-realm" id="realms-settings-objects-global-objects:environment-settings-object's-realm">Realm</a> then has a [[GlobalObject]] field, which contains <dfn data-dfn-for="environment
   settings object" id=concept-settings-object-global data-lt="global object" data-export="">the environment settings object's global object</dfn>.</ul>

  <hr>

  <p>When defining algorithm steps throughout this specification, it is often important to indicate
  what <a id=realms-settings-objects-global-objects:javascript-realm-7 href=https://tc39.github.io/ecma262/#sec-code-realms data-x-internal=javascript-realm>JavaScript realm</a> is to be usedor, equivalently, what <a href=#global-object id=realms-settings-objects-global-objects:global-object-5>global object</a>
  or <a href=#environment-settings-object id=realms-settings-objects-global-objects:environment-settings-object-5>environment settings object</a> is to be used. In general, there are at least four
  possibilities:</p>

  <dl><dt><dfn id=concept-entry-everything>Entry</dfn><dd>This corresponds to the script that initiated the currently running script action: i.e.,
    the function or script that the user agent called into when it called into author code.<dt><dfn id=concept-incumbent-everything>Incumbent</dfn><dd>This corresponds to the most-recently-entered author function or script on the stack, or the
    author function or script that originally scheduled the currently-running callback.<dt><dfn id=concept-current-everything>Current</dfn><dd>This corresponds to the currently-running function object, including built-in user-agent
    functions which might not be implemented as JavaScript. (It is derived from the <a href=https://tc39.github.io/ecma262/#current-realm id=realms-settings-objects-global-objects:current-realm-record data-x-internal=current-realm-record>current JavaScript realm</a>.)<dt><dfn id=concept-relevant-everything>Relevant</dfn><dd>Every <a id=realms-settings-objects-global-objects:platform-object href=https://heycam.github.io/webidl/#dfn-platform-object data-x-internal=platform-object>platform object</a> has a <a href=#concept-relevant-realm id=realms-settings-objects-global-objects:concept-relevant-realm>relevant
    Realm</a>, which is roughly the <a id=realms-settings-objects-global-objects:javascript-realm-8 href=https://tc39.github.io/ecma262/#sec-code-realms data-x-internal=javascript-realm>JavaScript realm</a> in which it was created. When
    writing algorithms, the most prominent <a id=realms-settings-objects-global-objects:platform-object-2 href=https://heycam.github.io/webidl/#dfn-platform-object data-x-internal=platform-object>platform object</a> whose <a href=#concept-relevant-realm id=realms-settings-objects-global-objects:concept-relevant-realm-2>relevant Realm</a> might be important is the <b>this</b>
    value of the currently-running function object. In some cases, there can be other important
    <a href=#concept-relevant-realm id=realms-settings-objects-global-objects:concept-relevant-realm-3>relevant Realms</a>, such as those of any
    arguments.</dl>

  <p>Note how the <a href=#concept-entry-everything id=realms-settings-objects-global-objects:concept-entry-everything>entry</a>, <a href=#concept-incumbent-everything id=realms-settings-objects-global-objects:concept-incumbent-everything>incumbent</a>, and <a href=#concept-current-everything id=realms-settings-objects-global-objects:concept-current-everything>current</a> concepts are usable without qualification,
  whereas the <a href=#concept-relevant-everything id=realms-settings-objects-global-objects:concept-relevant-everything>relevant</a> concept must be applied to
  a particular <a id=realms-settings-objects-global-objects:platform-object-3 href=https://heycam.github.io/webidl/#dfn-platform-object data-x-internal=platform-object>platform object</a>.</p>

  <div class=example>

   <p>Consider the following pages, with <code>a.html</code> being loaded in a browser
   window, <code>b.html</code> being loaded in an <code id=realms-settings-objects-global-objects:the-iframe-element><a href=#the-iframe-element>iframe</a></code> as shown, and <code>c.html</code> and <code>d.html</code> omitted (they can simply be empty
   documents):</p>

   <pre>&lt;!-- a.html -->
&lt;!DOCTYPE html>
&lt;html lang="en">
&lt;title>Entry page&lt;/title>

&lt;iframe src="b.html">&lt;/iframe>
&lt;button onclick="frames[0].hello()">Hello&lt;/button>

&lt;!--b.html -->
&lt;!DOCTYPE html>
&lt;html lang="en">
&lt;title>Incumbent page&lt;/title>

&lt;iframe src="c.html" id="c">&lt;/iframe>
&lt;iframe src="d.html" id="d">&lt;/iframe>

&lt;script>
  const c = document.querySelector("#c").contentWindow;
  const d = document.querySelector("#d").contentWindow;

  window.hello = () => {
    c.print.call(d);
  };
&lt;/script></pre>

   <p>Each page has its own <a href=#browsing-context id=realms-settings-objects-global-objects:browsing-context>browsing context</a>, and thus its own <a id=realms-settings-objects-global-objects:javascript-realm-9 href=https://tc39.github.io/ecma262/#sec-code-realms data-x-internal=javascript-realm>JavaScript
   realm</a>, <a href=#global-object id=realms-settings-objects-global-objects:global-object-6>global object</a>, and <a href=#environment-settings-object id=realms-settings-objects-global-objects:environment-settings-object-6>environment settings object</a>.</p>

   <p>When the <code id=realms-settings-objects-global-objects:dom-print><a href=#dom-print>print()</a></code> method is called in response to pressing the
   button in <code>a.html</code>, then:</p>

   <ul><li><p>The <a href=#concept-entry-realm id=realms-settings-objects-global-objects:concept-entry-realm>entry Realm</a> is that of <code>a.html</code>.<li><p>The <a href=#concept-incumbent-realm id=realms-settings-objects-global-objects:concept-incumbent-realm>incumbent Realm</a> is that of <code>b.html</code>.<li><p>The <a href=https://tc39.github.io/ecma262/#current-realm id=realms-settings-objects-global-objects:current-realm-record-2 data-x-internal=current-realm-record>current Realm</a> is that of <code>c.html</code> (since it is the <code id=realms-settings-objects-global-objects:dom-print-2><a href=#dom-print>print()</a></code> method from
    <code>c.html</code> whose code is running).<li><p>The <a href=#concept-relevant-realm id=realms-settings-objects-global-objects:concept-relevant-realm-4>relevant Realm</a> of the object on which
    the <code id=realms-settings-objects-global-objects:dom-print-3><a href=#dom-print>print()</a></code> method is being called is that of <code>d.html</code>.</ul>
  </div>

  <p class=warning>The <a href=#concept-incumbent-everything id=realms-settings-objects-global-objects:concept-incumbent-everything-2>incumbent</a> and <a href=#concept-entry-everything id=realms-settings-objects-global-objects:concept-entry-everything-2>entry</a> concepts should not be used by new specifications,
  as they are excessively complicated and unintuitive to work with. We are working to remove almost
  all existing uses from the platform: see <a href=https://github.com/whatwg/html/issues/1430>issue #1430</a> for <a href=#concept-incumbent-everything id=realms-settings-objects-global-objects:concept-incumbent-everything-3>incumbent</a>, and <a href=https://github.com/whatwg/html/issues/1431>issue #1431</a> for <a href=#concept-entry-everything id=realms-settings-objects-global-objects:concept-entry-everything-3>entry</a>.</p>

  <p>In general, web platform specifications should use the <a href=#concept-relevant-everything id=realms-settings-objects-global-objects:concept-relevant-everything-2>relevant</a> concept, applied to the object being operated
  on (usually the <b>this</b> value of the current method). This mismatches the JavaScript
  specification, where <a href=#concept-current-everything id=realms-settings-objects-global-objects:concept-current-everything-2>current</a> is generally used as
  the default (e.g. in determining the <a id=realms-settings-objects-global-objects:javascript-realm-10 href=https://tc39.github.io/ecma262/#sec-code-realms data-x-internal=javascript-realm>JavaScript realm</a> whose <code>Array</code> constructor should be used to construct the result in <code>Array.prototype.map</code>). But this inconsistency is so embedded in the platform that
  we have to accept it going forward.</p>

  <p>Note that in constructors, where there is no <b>this</b> value yet, the <a href=#concept-current-everything id=realms-settings-objects-global-objects:concept-current-everything-3>current</a> concept is the appropriate default.</p>

  <div class=example>
   <p>One reason why the <a href=#concept-relevant-everything id=realms-settings-objects-global-objects:concept-relevant-everything-3>relevant</a> concept is
   generally a better default choice than the <a href=#concept-current-everything id=realms-settings-objects-global-objects:concept-current-everything-4>current</a> concept is that it is more suitable for
   creating an object that is to be persisted and returned multiple times. For example, the <code id=realms-settings-objects-global-objects:dom-navigator-getbattery><a data-x-internal=dom-navigator-getbattery href=https://w3c.github.io/battery/#widl-Navigator-getBattery-Promise-BatteryManager>navigator.getBattery()</a></code> method creates promises in the
   <a href=#concept-relevant-realm id=realms-settings-objects-global-objects:concept-relevant-realm-5>relevant Realm</a> for the <code id=realms-settings-objects-global-objects:navigator><a href=#navigator>Navigator</a></code> object
   on which it is invoked. This has the following impact: <a href=#refsBATTERY>[BATTERY]</a>

   <pre>&lt;!-- outer.html -->
&lt;!DOCTYPE html>
&lt;html lang="en">
&lt;title>Relevant Realm demo: outer page&lt;/title>
&lt;script>
  function doTest() {
    const promise = navigator.getBattery.call(frames[0].navigator);

    console.log(promise instanceof Promise);           // logs false
    console.log(promise instanceof frames[0].Promise); // logs true

    frames[0].hello();
  }
&lt;/script>
&lt;iframe src="inner.html" onload="doTest()">&lt;/iframe>

&lt;!-- inner.html -->
&lt;!DOCTYPE html>
&lt;html lang="en">
&lt;title>Relevant Realm demo: inner page&lt;/title>
&lt;script>
  function hello() {
    const promise = navigator.getBattery();

    console.log(promise instanceof Promise);        // logs true
    console.log(promise instanceof parent.Promise); // logs false
  }
&lt;/script></pre>

   <p>If the algorithm for the <code id=realms-settings-objects-global-objects:dom-navigator-getbattery-2><a data-x-internal=dom-navigator-getbattery href=https://w3c.github.io/battery/#widl-Navigator-getBattery-Promise-BatteryManager>getBattery()</a></code> method
   had instead used the <a href=https://tc39.github.io/ecma262/#current-realm id=realms-settings-objects-global-objects:current-realm-record-3 data-x-internal=current-realm-record>current Realm</a>, all the results
   would be reversed. That is, after the first call to <code id=realms-settings-objects-global-objects:dom-navigator-getbattery-3><a data-x-internal=dom-navigator-getbattery href=https://w3c.github.io/battery/#widl-Navigator-getBattery-Promise-BatteryManager>getBattery()</a></code> in <code>outer.html</code>, the
   <code id=realms-settings-objects-global-objects:navigator-2><a href=#navigator>Navigator</a></code> object in <code>inner.html</code> would be permanently storing
   a <code>Promise</code> object created in <code>outer.html</code>'s
   <a id=realms-settings-objects-global-objects:javascript-realm-11 href=https://tc39.github.io/ecma262/#sec-code-realms data-x-internal=javascript-realm>JavaScript realm</a>, and calls like that inside the <code>hello()</code>
   function would thus return a promise from the "wrong" realm. Since this is undesirable, the
   algorithm instead uses the <a href=#concept-relevant-realm id=realms-settings-objects-global-objects:concept-relevant-realm-6>relevant Realm</a>, giving
   the sensible results indicated in the comments above.</p>
  </div>

  <hr>

  <p>The rest of this section deals with formally defining the <a href=#concept-entry-everything id=realms-settings-objects-global-objects:concept-entry-everything-4>entry</a>, <a href=#concept-incumbent-everything id=realms-settings-objects-global-objects:concept-incumbent-everything-4>incumbent</a>, <a href=#concept-current-everything id=realms-settings-objects-global-objects:concept-current-everything-5>current</a>, and <a href=#concept-relevant-everything id=realms-settings-objects-global-objects:concept-relevant-everything-4>relevant</a> concepts.</p>

  <h6 id=entry>8.1.3.5.1 Entry<a href=#entry class=self-link></a></h6>

  <p>All <a href=#realm-execution-context id=entry:realm-execution-context>realm execution contexts</a> must contain, as
  part of their code evaluation state, an <dfn id=entrance-counter>entrance counter</dfn> value, which is initially
  zero. In the process of <a href=#calling-scripts>calling scripts</a>, this value will be
  incremented and decremented.</p>

  <p>With this in hand, we define the <dfn id=entry-execution-context>entry execution context</dfn> to be the most recently
  pushed entry in the <a id=entry:javascript-execution-context-stack href=https://tc39.github.io/ecma262/#execution-context-stack data-x-internal=javascript-execution-context-stack>JavaScript execution context stack</a> whose <a href=#entrance-counter id=entry:entrance-counter>entrance
  counter</a> value is greater than zero. The <dfn id=concept-entry-realm>entry Realm</dfn>
  is the <a href=#entry-execution-context id=entry:entry-execution-context>entry execution context</a>'s Realm component.</p>

  <p>Then, the <dfn id=entry-settings-object>entry settings object</dfn> is the <a href=#concept-realm-settings-object id=entry:concept-realm-settings-object>environment settings object</a> of the <a href=#concept-entry-realm id=entry:concept-entry-realm>entry Realm</a>.</p>

  <p>Similarly, the <dfn id=entry-global-object>entry global object</dfn> is the <a href=#concept-realm-global id=entry:concept-realm-global>global object</a> of the <a href=#concept-entry-realm id=entry:concept-entry-realm-2>entry
  Realm</a>.</p>

  <h6 id=incumbent>8.1.3.5.2 Incumbent<a href=#incumbent class=self-link></a></h6>

  <p>All <a href=https://tc39.github.io/ecma262/#sec-execution-contexts id=incumbent:javascript-execution-context data-x-internal=javascript-execution-context>JavaScript execution contexts</a> must
  contain, as part of their code evaluation state, a <dfn id=skip-when-determining-incumbent-counter>skip-when-determining-incumbent
  counter</dfn> value, which is initially zero. In the process of <a href=#prepare-to-run-a-callback id=incumbent:prepare-to-run-a-callback>preparing to run a callback</a> and <a href=#clean-up-after-running-a-callback id=incumbent:clean-up-after-running-a-callback>cleaning up after running a callback</a>, this value will be incremented and
  decremented.</p>

  <p>Every <a href=#event-loop id=incumbent:event-loop>event loop</a> has an associated <dfn id=backup-incumbent-settings-object-stack>backup incumbent settings object
  stack</dfn>, initially empty. Roughly speaking, it is used to determine the <a href=#incumbent-settings-object id=incumbent:incumbent-settings-object>incumbent
  settings object</a> when no author code is on the stack, but author code is responsible for the
  current algorithm having been run in some way. The process of <a href=#prepare-to-run-a-callback id=incumbent:prepare-to-run-a-callback-2>preparing to run a callback</a> and <a href=#clean-up-after-running-a-callback id=incumbent:clean-up-after-running-a-callback-2>cleaning up after running a callback</a> manipulate this stack. <a href=#refsWEBIDL>[WEBIDL]</a></p>

  <p>When Web IDL is used to <a href=https://heycam.github.io/webidl/#es-invoking-callback-functions id=incumbent:es-invoking-callback-functions data-x-internal=es-invoking-callback-functions>invoke</a> author
  code, or when <a href=#enqueuejob(queuename,-job,-arguments) id=incumbent:enqueuejob(queuename,-job,-arguments)>EnqueueJob</a> invokes a promise job, they use the following algorithms to
  track relevant data for determining the <a href=#incumbent-settings-object id=incumbent:incumbent-settings-object-2>incumbent settings object</a>:</p>

  <p>To <dfn id=prepare-to-run-a-callback data-export="">prepare to run a callback</dfn> with an <a href=#environment-settings-object id=incumbent:environment-settings-object>environment settings
  object</a> <var>settings</var>:</p>

  <ol><li><p>Push <var>settings</var> onto the <a href=#backup-incumbent-settings-object-stack id=incumbent:backup-incumbent-settings-object-stack>backup incumbent settings object
   stack</a>.<li><p>Let <var>context</var> be the <a href=#topmost-script-having-execution-context id=incumbent:topmost-script-having-execution-context>topmost script-having execution
   context</a>.<li><p>If <var>context</var> is not null, increment <var>context</var>'s
   <a href=#skip-when-determining-incumbent-counter id=incumbent:skip-when-determining-incumbent-counter>skip-when-determining-incumbent counter</a>.</ol>

  <p>To <dfn id=clean-up-after-running-a-callback data-export="">clean up after running a callback</dfn> with an <a href=#environment-settings-object id=incumbent:environment-settings-object-2>environment
  settings object</a> <var>settings</var>:</p>

  <ol><li>
    <p>Let <var>context</var> be the <a href=#topmost-script-having-execution-context id=incumbent:topmost-script-having-execution-context-2>topmost script-having execution context</a>.</p>

    <p class=note>This will be the same as the <a href=#topmost-script-having-execution-context id=incumbent:topmost-script-having-execution-context-3>topmost script-having execution
    context</a> inside the corresponding invocation of <a href=#prepare-to-run-a-callback id=incumbent:prepare-to-run-a-callback-3>prepare to run a
    callback</a>.</p>
   <li><p>If <var>context</var> is not null, decrement <var>context</var>'s
   <a href=#skip-when-determining-incumbent-counter id=incumbent:skip-when-determining-incumbent-counter-2>skip-when-determining-incumbent counter</a>.<li><p>Assert: the topmost entry of the <a href=#backup-incumbent-settings-object-stack id=incumbent:backup-incumbent-settings-object-stack-2>backup incumbent settings object stack</a> is
   <var>settings</var>.<li><p>Remove <var>settings</var> from the <a href=#backup-incumbent-settings-object-stack id=incumbent:backup-incumbent-settings-object-stack-3>backup incumbent settings object
   stack</a>.</ol>

  <p>Here, the <dfn id=topmost-script-having-execution-context>topmost script-having execution context</dfn> is the topmost entry of the
  <a id=incumbent:javascript-execution-context-stack href=https://tc39.github.io/ecma262/#execution-context-stack data-x-internal=javascript-execution-context-stack>JavaScript execution context stack</a> that has a non-null ScriptOrModule component, or
  null if there is no such entry in the <a id=incumbent:javascript-execution-context-stack-2 href=https://tc39.github.io/ecma262/#execution-context-stack data-x-internal=javascript-execution-context-stack>JavaScript execution context stack</a>.</p>

  <p>With all this in place, the <dfn id=incumbent-settings-object data-export="">incumbent settings object</dfn> is determined
  as follows:</p>

  <ol><li><p>Let <var>context</var> be the <a href=#topmost-script-having-execution-context id=incumbent:topmost-script-having-execution-context-4>topmost script-having execution
   context</a>.<li>
    <p>If <var>context</var> is null, or if <var>context</var>'s
    <a href=#skip-when-determining-incumbent-counter id=incumbent:skip-when-determining-incumbent-counter-3>skip-when-determining-incumbent counter</a> is greater than zero, then:</p>

    <ol><li>
      <p>Assert: the <a href=#backup-incumbent-settings-object-stack id=incumbent:backup-incumbent-settings-object-stack-4>backup incumbent settings object stack</a> is not empty.</p>

      <p class=note>This assert would fail if you try to obtain the <a href=#incumbent-settings-object id=incumbent:incumbent-settings-object-3>incumbent settings
      object</a> from inside an algorithm that was triggered neither by <a href=#calling-scripts>calling scripts</a> nor by Web IDL <a href=https://heycam.github.io/webidl/#es-invoking-callback-functions id=incumbent:es-invoking-callback-functions-2 data-x-internal=es-invoking-callback-functions>invoking</a> a callback. For example, it would
      trigger if you tried to obtain the <a href=#incumbent-settings-object id=incumbent:incumbent-settings-object-4>incumbent settings object</a> inside an algorithm
      that ran periodically as part of the <a href=#event-loop id=incumbent:event-loop-2>event loop</a>, with no involvement of author
      code. In such cases the <a href=#concept-incumbent-everything id=incumbent:concept-incumbent-everything>incumbent</a> concept
      cannot be used.</p>
     <li><p>Return the topmost entry of the <a href=#backup-incumbent-settings-object-stack id=incumbent:backup-incumbent-settings-object-stack-5>backup incumbent settings object
     stack</a>.</ol>
   <li><p>Return <var>context</var>'s Realm component's <a href=#concept-realm-settings-object id=incumbent:concept-realm-settings-object>settings obect</a>.</ol>

  <p>Then, the <dfn id=concept-incumbent-realm>incumbent Realm</dfn> is the <a href="#environment-settings-object's-realm" id="incumbent:environment-settings-object's-realm">Realm</a> of the <a href=#incumbent-settings-object id=incumbent:incumbent-settings-object-5>incumbent settings
  object</a>.</p>

  <p>Similarly, the <dfn id=concept-incumbent-global>incumbent global object</dfn> is the
  <a href=#concept-settings-object-global id=incumbent:concept-settings-object-global>global object</a> of the <a href=#incumbent-settings-object id=incumbent:incumbent-settings-object-6>incumbent
  settings object</a>.</p>

  <hr>

  <p>The following series of examples is intended to make it clear how all of the different
  mechanisms contribute to the definition of the <a href=#incumbent>incumbent</a> concept:</p>

  <div class=example>
   <p>Consider the following very simple example:</p>

   <pre>&lt;!DOCTYPE html>
&lt;iframe>&lt;/iframe>
&lt;script>
  new frames[0].MessageChannel();
&lt;/script></pre>

   <p>When the <code id=incumbent:dom-messagechannel><a href=#dom-messagechannel>MessageChannel()</a></code> constructor looks up the
   <a href=#incumbent-settings-object id=incumbent:incumbent-settings-object-7>incumbent settings object</a> to use as the <a href=#concept-port-owner id=incumbent:concept-port-owner>owner</a> of the new <code id=incumbent:messageport><a href=#messageport>MessagePort</a></code> objects, the
   <a href=#topmost-script-having-execution-context id=incumbent:topmost-script-having-execution-context-5>topmost script-having execution context</a> will be that corresponding to the
   <code id=incumbent:the-script-element><a href=#the-script-element>script</a></code> element: it was pushed onto the <a id=incumbent:javascript-execution-context-stack-3 href=https://tc39.github.io/ecma262/#execution-context-stack data-x-internal=javascript-execution-context-stack>JavaScript execution context
   stack</a> as part of <a href=https://tc39.github.io/ecma262/#sec-runtime-semantics-scriptevaluation id=incumbent:js-scriptevaluation data-x-internal=js-scriptevaluation>ScriptEvaluation</a> during the
   <a href=#run-a-classic-script id=incumbent:run-a-classic-script>run a classic script</a> algorithm. Since there are no Web IDL callback invocations
   involved, the context's <a href=#skip-when-determining-incumbent-counter id=incumbent:skip-when-determining-incumbent-counter-4>skip-when-determining-incumbent counter</a> is zero, so it is
   used to determine the <a href=#incumbent-settings-object id=incumbent:incumbent-settings-object-8>incumbent settings object</a>; the result is the <a href=#environment-settings-object id=incumbent:environment-settings-object-3>environment
   settings object</a> of <code>window</code>.</p>

   <p>(In this example, the <a href=#environment-settings-object id=incumbent:environment-settings-object-4>environment settings object</a> of <code>frames[0]</code> is not involved at all. It is the <a href=#current-settings-object id=incumbent:current-settings-object>current settings
   object</a>, but the <code id=incumbent:dom-messagechannel-2><a href=#dom-messagechannel>MessageChannel()</a></code> constructor
   cares only about the incumbent, not current.)</p>
  </div>

  <div class=example>
   <p>Consider the following more complicated example:</p>

   <pre>&lt;!DOCTYPE html>
&lt;iframe>&lt;/iframe>
&lt;script>
  const bound = frames[0].postMessage.bind(frames[0], "some data", "*");
  window.setTimeout(bound);
&lt;/script></pre>

   <p>There are two interesting <a href=#environment-settings-object id=incumbent:environment-settings-object-5>environment settings
   objects</a> here: that of <code>window</code>, and that of <code>frames[0]</code>. Our concern is: what is the <a href=#incumbent-settings-object id=incumbent:incumbent-settings-object-9>incumbent settings object</a> at
   the time that the algorithm for <code id=incumbent:dom-window-postmessage><a href=#dom-window-postmessage>postMessage()</a></code>
   executes?</p>

   <p>It should be that of <code>window</code>, to capture the intuitive notion that the
   author script responsible for causing the algorithm to happen is executing in <code>window</code>, not <code>frames[0]</code>. Another way of capturing the
   intuition here is that invoking algorithms asynchronously (in this case via <code id=incumbent:dom-settimeout><a href=#dom-settimeout>setTimeout()</a></code>) should not change the <a href=#concept-incumbent-everything id=incumbent:concept-incumbent-everything-2>incumbent</a> concept.</p>

   <p>Let us now explain how the steps given above give us our intuitively-desired result of <code>window</code>'s <a href=#relevant-settings-object id=incumbent:relevant-settings-object>relevant settings object</a>.</p>

   <p>When <code>bound</code> is <a href=https://heycam.github.io/webidl/#es-type-mapping id=incumbent:concept-idl-convert data-x-internal=concept-idl-convert>converted</a> to a
   Web IDL callback type, the <a href=#incumbent-settings-object id=incumbent:incumbent-settings-object-10>incumbent settings object</a> is that corresponding to <code>window</code> (in the same manner as in our simple example above). Web IDL stores this
   as the resulting callback value's <a id=incumbent:callback-context href=https://heycam.github.io/webidl/#dfn-callback-context data-x-internal=callback-context>callback context</a>.</p>

   <p>When the <a href=#concept-task id=incumbent:concept-task>task</a> posted by <code id=incumbent:dom-settimeout-2><a href=#dom-settimeout>setTimeout()</a></code> executes, the algorithm for that task uses Web IDL to
   <a href=https://heycam.github.io/webidl/#es-invoking-callback-functions id=incumbent:es-invoking-callback-functions-3 data-x-internal=es-invoking-callback-functions>invoke</a> the stored callback value. Web IDL in
   turn calls the above <a href=#prepare-to-run-a-callback id=incumbent:prepare-to-run-a-callback-4>prepare to run a callback</a> algorithm. This pushes the stored
   <a id=incumbent:callback-context-2 href=https://heycam.github.io/webidl/#dfn-callback-context data-x-internal=callback-context>callback context</a> onto the <a href=#backup-incumbent-settings-object-stack id=incumbent:backup-incumbent-settings-object-stack-6>backup incumbent settings object stack</a>. At
   this time (inside the timer task) there is no author code on the stack, so the <a href=#topmost-script-having-execution-context id=incumbent:topmost-script-having-execution-context-6>topmost
   script-having execution context</a> is null, and nothing gets its
   <a href=#skip-when-determining-incumbent-counter id=incumbent:skip-when-determining-incumbent-counter-5>skip-when-determining-incumbent counter</a> incremented.</p>

   <p>Invoking the callback then calls <code>bound</code>, which in turn calls
   the <code id=incumbent:dom-window-postmessage-2><a href=#dom-window-postmessage>postMessage()</a></code> method of <code>frames[0]</code>. When the <code id=incumbent:dom-window-postmessage-3><a href=#dom-window-postmessage>postMessage()</a></code>
   algorithm looks up the <a href=#incumbent-settings-object id=incumbent:incumbent-settings-object-11>incumbent settings object</a>, there is still no author code on
   the stack, since the bound function just directly calls the built-in method. So the
   <a href=#topmost-script-having-execution-context id=incumbent:topmost-script-having-execution-context-7>topmost script-having execution context</a> will be null: the <a id=incumbent:javascript-execution-context-2 href=https://tc39.github.io/ecma262/#sec-execution-contexts data-x-internal=javascript-execution-context>JavaScript execution
   context</a> stack only contains an execution context corresponding to <code id=incumbent:dom-window-postmessage-4><a href=#dom-window-postmessage>postMessage()</a></code>, with no <a href=https://tc39.github.io/ecma262/#sec-runtime-semantics-scriptevaluation id=incumbent:js-scriptevaluation-2 data-x-internal=js-scriptevaluation>ScriptEvaluation</a> context or similar below it.</p>

   <p>This is where we fall back to the <a href=#backup-incumbent-settings-object-stack id=incumbent:backup-incumbent-settings-object-stack-7>backup incumbent settings object stack</a>. As
   noted above, it will contain as its topmost entry the <a href=#relevant-settings-object id=incumbent:relevant-settings-object-2>relevant settings object</a> of
   <code>window</code>. So that is what is used as the <a href=#incumbent-settings-object id=incumbent:incumbent-settings-object-12>incumbent settings
   object</a> while executing the <code id=incumbent:dom-window-postmessage-5><a href=#dom-window-postmessage>postMessage()</a></code>
   algorithm.</p>
  </div>

  <div class=example>
   <p>Consider this final, even more convoluted example:</p>

   <pre>&lt;!-- a.html -->
&lt;!DOCTYPE html>
&lt;button>click me&lt;/button>
&lt;iframe>&lt;/iframe>
&lt;script>
const bound = frames[0].location.assign.bind(frames[0].location, "https://example.com/");
document.querySelector("button").addEventListener("click", bound);
&lt;/script>

&lt;!-- b.html -->
&lt;!DOCTYPE html>
&lt;iframe src="a.html">&lt;/iframe>
&lt;script>
  const iframe = document.querySelector("iframe");
  iframe.onload = function onLoad() {
    iframe.contentWindow.document.querySelector("button").click();
  };
&lt;/script></pre>

   <p>Again there are two interesting <a href=#environment-settings-object id=incumbent:environment-settings-object-6>environment
   settings objects</a> in play: that of <code>a.html</code>, and that of <code>b.html</code>. When the <code id=incumbent:dom-location-assign><a href=#dom-location-assign>location.assign()</a></code>
   method triggers the <a href=#location-object-navigate id=incumbent:location-object-navigate><code>Location</code>-object navigate</a> algorithm, what will be
   the <a href=#incumbent-settings-object id=incumbent:incumbent-settings-object-13>incumbent settings object</a>? As before, it should intuitively be that of <code>a.html</code>: the <code id=incumbent:event-click><a data-x-internal=event-click href=https://w3c.github.io/uievents/#event-type-click>click</a></code> listener was originally
   scheduled by <code>a.html</code>, so even if something involving <code>b.html</code> causes the listener to fire, the <a href=#incumbent-everything>incumbent</a> responsible is that of <code>a.html</code>.</p>

   <p>The callback setup is similar to the previous example: when <code>bound</code> is
   <a href=https://heycam.github.io/webidl/#es-type-mapping id=incumbent:concept-idl-convert-2 data-x-internal=concept-idl-convert>converted</a> to a Web IDL callback type, the
   <a href=#incumbent-settings-object id=incumbent:incumbent-settings-object-14>incumbent settings object</a> is that corresponding to <code>a.html</code>,
   which is stored as the callback's <a id=incumbent:callback-context-3 href=https://heycam.github.io/webidl/#dfn-callback-context data-x-internal=callback-context>callback context</a>.</p>

   <p>When the <code id=incumbent:dom-click><a href=#dom-click>click()</a></code> method is called inside <code>b.html</code>, it <a href=https://dom.spec.whatwg.org/#concept-event-dispatch id=incumbent:concept-event-dispatch data-x-internal=concept-event-dispatch>dispatches</a> a <code id=incumbent:event-click-2><a data-x-internal=event-click href=https://w3c.github.io/uievents/#event-type-click>click</a></code> event on the button that is inside <code>a.html</code>. This time, when the <a href=#prepare-to-run-a-callback id=incumbent:prepare-to-run-a-callback-5>prepare to run a callback</a> algorithm
   executes as part of event dispatch, there <em>is</em> author code on the stack; the <a href=#topmost-script-having-execution-context id=incumbent:topmost-script-having-execution-context-8>topmost
   script-having execution context</a> is that of the <code>onLoad</code> function,
   whose <a href=#skip-when-determining-incumbent-counter id=incumbent:skip-when-determining-incumbent-counter-6>skip-when-determining-incumbent counter</a> gets incremented. Additionally, <code>a.html</code>'s <a href=#environment-settings-object id=incumbent:environment-settings-object-7>environment settings object</a> (stored as the
   <code id=incumbent:eventhandler><a href=#eventhandler>EventHandler</a></code>'s <a id=incumbent:callback-context-4 href=https://heycam.github.io/webidl/#dfn-callback-context data-x-internal=callback-context>callback context</a>) is pushed onto the
   <a href=#backup-incumbent-settings-object-stack id=incumbent:backup-incumbent-settings-object-stack-8>backup incumbent settings object stack</a>.</p>

   <p>Now, when the <a href=#location-object-navigate id=incumbent:location-object-navigate-2><code>Location</code>-object navigate</a> algorithm looks up the
   <a href=#incumbent-settings-object id=incumbent:incumbent-settings-object-15>incumbent settings object</a>, the <a href=#topmost-script-having-execution-context id=incumbent:topmost-script-having-execution-context-9>topmost script-having execution
   context</a> is still that of the <code>onLoad</code> function (due to the fact we
   are using a bound function as the callback). Its <a href=#skip-when-determining-incumbent-counter id=incumbent:skip-when-determining-incumbent-counter-7>skip-when-determining-incumbent
   counter</a> value is one, however, so we fall back to the <a href=#backup-incumbent-settings-object-stack id=incumbent:backup-incumbent-settings-object-stack-9>backup incumbent settings
   object stack</a>. This gives us the <a href=#environment-settings-object id=incumbent:environment-settings-object-8>environment settings object</a> of <code>a.html</code>, as expected.</p>

   <p>Note that this means that even though it is the <code id=incumbent:the-iframe-element><a href=#the-iframe-element>iframe</a></code> inside <code>a.html</code> that navigates, it is <code>a.html</code> itself that is used
   as the <a href=#source-browsing-context id=incumbent:source-browsing-context>source browsing context</a>, which determines among other things the <a href=https://fetch.spec.whatwg.org/#concept-request-client id=incumbent:concept-request-client data-x-internal=concept-request-client>request client</a>. This is <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=26603#c36">perhaps the only justifiable use
   of the incumbent concept on the web platform</a>; in all other cases the consequences of using it
   are simply confusing and we hope to one day switch them to use <a href=#current-everything>current</a> or <a href=#relevant-everything>relevant</a> as
   appropriate.</p>
  </div>

  <h6 id=current>8.1.3.5.3 Current<a href=#current class=self-link></a></h6>

  <p>The JavaScript specification defines the <a id=current:current-realm-record href=https://tc39.github.io/ecma262/#current-realm data-x-internal=current-realm-record>current Realm Record</a>, sometimes
  abbreviated to the "current Realm". <a href=#refsJAVASCRIPT>[JAVASCRIPT]</a></p>

  <p>Then, the <dfn id=current-settings-object data-export="">current settings object</dfn> is the <a href=#concept-realm-settings-object id=current:concept-realm-settings-object>environment settings object</a> of the <a id=current:current-realm-record-2 href=https://tc39.github.io/ecma262/#current-realm data-x-internal=current-realm-record>current
  Realm Record</a>.</p>

  <p>Similarly, the <dfn id=current-global-object data-export="">current global object</dfn> is the <a href=#concept-realm-global id=current:concept-realm-global>global object</a> of the <a id=current:current-realm-record-3 href=https://tc39.github.io/ecma262/#current-realm data-x-internal=current-realm-record>current Realm Record</a>.</p>

  <h6 id=relevant>8.1.3.5.4 Relevant<a href=#relevant class=self-link></a></h6>

  <p>The <dfn id=relevant-settings-object data-export="">relevant settings object</dfn> for a <a id=relevant:platform-object href=https://heycam.github.io/webidl/#dfn-platform-object data-x-internal=platform-object>platform object</a> is
  defined as follows:</p>

  <dl class=switch><dt>If the object is a <a href=#global-object id=relevant:global-object>global object</a><dd>Each <a href=#global-object id=relevant:global-object-2>global object</a> in this specification is created alongside a corresponding
   <a href=#environment-settings-object id=relevant:environment-settings-object>environment settings object</a>; that is its <a href=#relevant-settings-object id=relevant:relevant-settings-object>relevant settings object</a>.<dt>Otherwise<dd>
    <p>The <a href=#relevant-settings-object id=relevant:relevant-settings-object-2>relevant settings object</a> for a non-global <a id=relevant:platform-object-2 href=https://heycam.github.io/webidl/#dfn-platform-object data-x-internal=platform-object>platform object</a>
    <var>o</var> is the <a href=#environment-settings-object id=relevant:environment-settings-object-2>environment settings object</a> whose <a href=#concept-settings-object-global id=relevant:concept-settings-object-global>global object</a> is the global object of the
    <a id=relevant:global-environment-associated-with href=https://heycam.github.io/webidl/#es-platform-objects data-x-internal=global-environment-associated-with>global environment associated with</a> <var>o</var>.</p>

    <p class=note>The "<a id=relevant:global-environment-associated-with-2 href=https://heycam.github.io/webidl/#es-platform-objects data-x-internal=global-environment-associated-with>global environment associated with</a>" concept is from the olden
    days, before the modern JavaScript specification and its concept of <a href=https://tc39.github.io/ecma262/#sec-code-realms id=relevant:javascript-realm data-x-internal=javascript-realm>realms</a>. We expect that as the Web IDL specification gets updated, every
    <a id=relevant:platform-object-3 href=https://heycam.github.io/webidl/#dfn-platform-object data-x-internal=platform-object>platform object</a> will have a <a href=https://tc39.github.io/ecma262/#sec-code-realms id=relevant:javascript-realm-2 data-x-internal=javascript-realm>Realm</a> associated
    with it, and this definition can be re-cast in those terms. <a href=#refsJAVASCRIPT>[JAVASCRIPT]</a> <a href=#refsWEBIDL>[WEBIDL]</a></p>
   </dl>

  <p>Then, the <dfn id=concept-relevant-realm data-export="">relevant Realm</dfn> for a
  <a id=relevant:platform-object-4 href=https://heycam.github.io/webidl/#dfn-platform-object data-x-internal=platform-object>platform object</a> is the <a href="#environment-settings-object's-realm" id="relevant:environment-settings-object's-realm">Realm</a> of its <a href=#relevant-settings-object id=relevant:relevant-settings-object-3>relevant settings object</a>.</p>

  <p>Similarly, the <dfn id=concept-relevant-global data-export="">relevant global
  object</dfn> for a <a id=relevant:platform-object-5 href=https://heycam.github.io/webidl/#dfn-platform-object data-x-internal=platform-object>platform object</a> is the <a href=#concept-settings-object-global id=relevant:concept-settings-object-global-2>global object</a> of its <a href=#relevant-settings-object id=relevant:relevant-settings-object-4>relevant settings
  object</a>.</p>


  <h5 id=killing-scripts>8.1.3.6 Killing scripts<a href=#killing-scripts class=self-link></a></h5>

  <p>Although the JavaScript specification does not account for this possibility, it's sometimes
  necessary to <dfn id=abort-a-running-script>abort a running script</dfn>. This causes any <a href=https://tc39.github.io/ecma262/#sec-runtime-semantics-scriptevaluation id=killing-scripts:js-scriptevaluation data-x-internal=js-scriptevaluation>ScriptEvaluation</a> or <a href=https://tc39.github.io/ecma262/#sec-moduleevaluation id=killing-scripts:js-moduleevaluation data-x-internal=js-moduleevaluation>ModuleEvaluation</a> to cease immediately, emptying the
  <a id=killing-scripts:javascript-execution-context-stack href=https://tc39.github.io/ecma262/#execution-context-stack data-x-internal=javascript-execution-context-stack>JavaScript execution context stack</a> without triggering any of the normal mechanisms
  like <code>finally</code> blocks. <a href=#refsJAVASCRIPT>[JAVASCRIPT]</a></p>

  <p>User agents may impose resource limitations on scripts, for example CPU quotas, memory limits,
  total execution time limits, or bandwidth limitations. When a script exceeds a limit, the user
  agent may either throw a <a id=killing-scripts:quotaexceedederror href=https://heycam.github.io/webidl/#quotaexceedederror data-x-internal=quotaexceedederror>"<code>QuotaExceededError</code>"</a> <code id=killing-scripts:domexception><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code>,
  <a href=#abort-a-running-script id=killing-scripts:abort-a-running-script>abort the script</a> without an exception, prompt the
  user, or throttle script execution.</p>

  <div class=example>

   <p>For example, the following script never terminates. A user agent could, after waiting for a
   few seconds, prompt the user to either terminate the script or let it continue.</p>

   <pre>&lt;script>
 while (true) { /* loop */ }
&lt;/script></pre>

  </div>

  <p>User agents are encouraged to allow users to disable scripting whenever the user is prompted
  either by a script (e.g. using the <code id=killing-scripts:dom-alert><a href=#dom-alert>window.alert()</a></code> API) or because
  of a script's actions (e.g. because it has exceeded a time limit).</p>

  <p>If scripting is disabled while a script is executing, the script should be terminated
  immediately.</p>

  <p>User agents may allow users to specifically disable scripts just for the purposes of closing a
  <a href=#browsing-context id=killing-scripts:browsing-context>browsing context</a>.</p>

  <p class=example>For example, the prompt mentioned in the example above could also offer the
  user with a mechanism to just close the page entirely, without running any <code id=killing-scripts:event-unload><a href=#event-unload>unload</a></code> event handlers.</p>

  <h5 id=integration-with-the-javascript-job-queue>8.1.3.7 Integration with the JavaScript job queue<a href=#integration-with-the-javascript-job-queue class=self-link></a></h5>

  <p>The JavaScript specification defines the JavaScript job and job queue abstractions in order to
  specify certain invariants about how promise operations execute with a clean <a id=integration-with-the-javascript-job-queue:javascript-execution-context-stack href=https://tc39.github.io/ecma262/#execution-context-stack data-x-internal=javascript-execution-context-stack>JavaScript
  execution context stack</a> and in a certain order. However, as of the time of this writing
  the definition of <a href=https://tc39.github.io/ecma262/#sec-enqueuejob id=integration-with-the-javascript-job-queue:js-enqueuejob data-x-internal=js-enqueuejob>EnqueueJob</a> in that specification is not
  sufficiently flexible to integrate with HTML as a host environment. <a href=#refsJAVASCRIPT>[JAVASCRIPT]</a></p>

  <p class=note>This is not strictly true. It is in fact possible, by taking liberal advantage of
  the many "implementation defined" sections of the algorithm, to contort it to our purposes.
  However, the end result is a mass of messy indirection and workarounds that essentially bypasses
  the job queue infrastructure entirely, albeit in a way that is technically sanctioned within the
  bounds of implementation-defined behavior. We do not take this path, and instead introduce the
  following <a href=#willful-violation id=integration-with-the-javascript-job-queue:willful-violation>willful violation</a>.</p>

  <p>As such, user agents must instead use the following definition in place of that in the
  JavaScript specification. These ensure that the promise jobs enqueued by the JavaScript
  specification are properly integrated into the user agent's <a href=#event-loop id=integration-with-the-javascript-job-queue:event-loop>event
  loops</a>.</p>

  <p>The <a id=integration-with-the-javascript-job-queue:runjobs href=https://tc39.github.io/ecma262/#sec-runjobs data-x-internal=runjobs>RunJobs</a> abstract operation from the JavaScript specification must
  not be used by user agents.</p>

  <h6 id=enqueuejob(queuename,-job,-arguments)>8.1.3.7.1 <dfn>EnqueueJob</dfn>(<var>queueName</var>, <var>job</var>, <var>arguments</var>)<a href=#enqueuejob(queuename,-job,-arguments) class=self-link></a></h6>

  <p>When the JavaScript specification says to call the EnqueueJob abstract operation, the
  following algorithm must be used in place of JavaScript's <a href=https://tc39.github.io/ecma262/#sec-enqueuejob id=enqueuejob(queuename,-job,-arguments):js-enqueuejob data-x-internal=js-enqueuejob>EnqueueJob</a>:</p>

  <ol><li><p>Assert: <var>queueName</var> is <code>"PromiseJobs"</code>. (<code>"ScriptJobs"</code> must not be used by user agents.)<li>
    <p>Let <var>job settings</var> be some appropriate <a href=#environment-settings-object id=enqueuejob(queuename,-job,-arguments):environment-settings-object>environment settings object</a>.</p>

    <p class=warning>It is not yet clear how to specify the <a href=#environment-settings-object id=enqueuejob(queuename,-job,-arguments):environment-settings-object-2>environment settings
    object</a> that should be used here. In practice, this means that the <a href=#entry-everything>entry</a> concept is not correctly specified while executing a job. See
    <a href=https://github.com/whatwg/html/pull/1189#issuecomment-224950188>discussion in issue
    #1189</a>.</p>
   <li><p>Let <var>incumbent settings</var> be the <a href=#incumbent-settings-object id=enqueuejob(queuename,-job,-arguments):incumbent-settings-object>incumbent settings object</a>.<li>
    <p><a href=#queue-a-microtask id=enqueuejob(queuename,-job,-arguments):queue-a-microtask>Queue a microtask</a>, on <var>job settings</var>'s <a href=#responsible-event-loop id=enqueuejob(queuename,-job,-arguments):responsible-event-loop>responsible event
    loop</a>, to perform the following steps:</p>

    <ol><li><p><a href=#check-if-we-can-run-script id=enqueuejob(queuename,-job,-arguments):check-if-we-can-run-script>Check if we can run script</a> with <var>job settings</var>. If this returns
     "do not run" then abort these steps.<li><p><a href=#prepare-to-run-script id=enqueuejob(queuename,-job,-arguments):prepare-to-run-script>Prepare to run script</a> with <var>job settings</var>.<li><p><a href=#prepare-to-run-a-callback id=enqueuejob(queuename,-job,-arguments):prepare-to-run-a-callback>Prepare to run a callback</a> with <var>incumbent settings</var>.<li><p>Let <var>result</var> be the result of performing the abstract operation specified by
     <var>job</var>, using the elements of <var>arguments</var> as its arguments.<li><p><a href=#clean-up-after-running-a-callback id=enqueuejob(queuename,-job,-arguments):clean-up-after-running-a-callback>Clean up after running a callback</a> with <var>incumbent
     settings</var>.<li><p><a href=#clean-up-after-running-script id=enqueuejob(queuename,-job,-arguments):clean-up-after-running-script>Clean up after running script</a> with <var>job settings</var>.<li><p>If <var>result</var> is an abrupt completion, <a href=#report-the-exception id=enqueuejob(queuename,-job,-arguments):report-the-exception>report the exception</a> given by
     <var>result</var>.[[Value]].</ol>
   </ol>

  <h5 id=integration-with-the-javascript-module-system>8.1.3.8 Integration with the JavaScript module system<a href=#integration-with-the-javascript-module-system class=self-link></a></h5>

  <p>The JavaScript specification defines a syntax for modules, as well as some host-agnostic parts
  of their processing model. This specification defines the rest of their processing model: how the
  module system is bootstrapped, via the <code id=integration-with-the-javascript-module-system:the-script-element><a href=#the-script-element>script</a></code> element with <code id=integration-with-the-javascript-module-system:attr-script-type><a href=#attr-script-type>type</a></code> attribute set to "<code>module</code>", and how
  modules are fetched, resolved, and executed. <a href=#refsJAVASCRIPT>[JAVASCRIPT]</a></p>

  <p class=note>Although the JavaScript specification speaks in terms of "scripts" versus
  "modules", in general this specification speaks in terms of <a href=#classic-script id=integration-with-the-javascript-module-system:classic-script>classic
  scripts</a> versus <a href=#module-script id=integration-with-the-javascript-module-system:module-script>module scripts</a>, since both of them use
  the <code id=integration-with-the-javascript-module-system:the-script-element-2><a href=#the-script-element>script</a></code> element.</p>

  <p>A <dfn id=module-map>module map</dfn> is a <a href=https://infra.spec.whatwg.org/#ordered-map id=integration-with-the-javascript-module-system:ordered-map data-x-internal=ordered-map>map</a> of <a href=https://url.spec.whatwg.org/#syntax-url-absolute id=integration-with-the-javascript-module-system:absolute-url data-x-internal=absolute-url>absolute URLs</a> to values that are either a <a href=#module-script id=integration-with-the-javascript-module-system:module-script-2>module script</a>, null (used to
  represent failed fetches), or a placeholder value "<code>fetching</code>". <a href=#module-map id=integration-with-the-javascript-module-system:module-map>Module maps</a> are used to ensure that imported JavaScript modules are
  only fetched, parsed, and evaluated once per <code id=integration-with-the-javascript-module-system:document><a href=#document>Document</a></code> or <a href=#workers>worker</a>.</p>

  <div class=example>
   <p>Since <a href=#module-map id=integration-with-the-javascript-module-system:module-map-2>module maps</a> are keyed by URL, the following code will
   create three separate entries in the <a href=#module-map id=integration-with-the-javascript-module-system:module-map-3>module map</a>, since it results in three different
   URLs:</p>

   <pre>import "https://example.com/module.js";
import "https://example.com/module.js#map-buster";
import "https://example.com/module.js?debug=true";</pre>

   <p>That is, URL <a href=https://url.spec.whatwg.org/#concept-url-query id=integration-with-the-javascript-module-system:concept-url-query data-x-internal=concept-url-query>queries</a> and <a href=https://url.spec.whatwg.org/#concept-url-fragment id=integration-with-the-javascript-module-system:concept-url-fragment data-x-internal=concept-url-fragment>fragments</a> can be varied to create distinct entries in the
   <a href=#module-map id=integration-with-the-javascript-module-system:module-map-4>module map</a>; they are not ignored. Thus, three separate fetches and three separate
   module evaluations will be performed.</p>

   <p>In contrast, the following code would only create a single entry in the <a href=#module-map id=integration-with-the-javascript-module-system:module-map-5>module
   map</a>, since after applying the <a id=integration-with-the-javascript-module-system:url-parser href=https://url.spec.whatwg.org/#concept-url-parser data-x-internal=url-parser>URL parser</a> to these inputs, the resulting <a href=https://url.spec.whatwg.org/#concept-url id=integration-with-the-javascript-module-system:url-record data-x-internal=url-record>URL records</a> are equal:</p>

   <pre>import "https://example.com/module2.js";
import "https:example.com/module2.js";
import "https://///example.com\\module2.js";
import "https://example.com/foo/../module2.js";</pre>

   <p>So in this second example, only one fetch and one module evaluation will occur.</p>

   <p>Note that this behavior is the same as how <a href=#sharedworker id=integration-with-the-javascript-module-system:sharedworker>shared workers</a> are keyed by their parsed <a href=#concept-sharedworkerglobalscope-constructor-url id=integration-with-the-javascript-module-system:concept-sharedworkerglobalscope-constructor-url>constructor url</a>.</p>
  </div>

  <p>To <dfn id=resolve-a-module-specifier>resolve a module specifier</dfn> given a <a href=#module-script id=integration-with-the-javascript-module-system:module-script-3>module script</a> <var>script</var>
  and a string <var>specifier</var>, perform the following steps. It will return either an
  <a id=integration-with-the-javascript-module-system:absolute-url-2 href=https://url.spec.whatwg.org/#syntax-url-absolute data-x-internal=absolute-url>absolute URL</a> or failure.</p>

  <ol><li><p>Apply the <a id=integration-with-the-javascript-module-system:url-parser-2 href=https://url.spec.whatwg.org/#concept-url-parser data-x-internal=url-parser>URL parser</a> to <var>specifier</var>. If the result is not failure,
   return the result.<li>
    <p>If <var>specifier</var> does not start with the character U+002F SOLIDUS (<code>/</code>), the two-character sequence U+002E FULL STOP, U+002F SOLIDUS (<code>./</code>), or the three-character sequence U+002E FULL STOP, U+002E FULL STOP,
    U+002F SOLIDUS (<code>../</code>), return failure and abort these steps.</p>

    <p class=note>This restriction is in place so that in the future we can allow custom module
    loaders to give special meaning to "bare" import specifiers, like <code>import "jquery"</code> or <code>import "web/crypto"</code>. For now any
    such imports will fail, instead of being treated as relative URLs.</p>
   <li><p>Return the result of applying the <a id=integration-with-the-javascript-module-system:url-parser-3 href=https://url.spec.whatwg.org/#concept-url-parser data-x-internal=url-parser>URL parser</a> to <var>specifier</var> with
   <var>script</var>'s <a href=#concept-module-script-base-url id=integration-with-the-javascript-module-system:concept-module-script-base-url>base URL</a> as the base
   URL.</ol>

  <div id=module-specifier-examples class=example>
   <p>The following are valid module specifiers according to the above algorithm:</p>

   <ul class=brief><li><code>https://example.com/apples.js</code><li><code>http:example.com\pears.mjs</code> (becomes <code>http://example.com/pears.mjs</code> as step 1 parses with no base URL)<li><code>//example.com/bananas</code><li><code>./strawberries.js.cgi</code><li><code>../lychees</code><li><code>/limes.jsx</code><li><code>data:text/javascript,export default 'grapes';</code><li><code>blob:https://whatwg.org/d0360e2f-caee-469f-9a2f-87d5b0456f6f</code></ul>

   <p>The following are valid module specifiers according to the above algorithm, but will
   invariably cause failures when they are <a href=#fetch-a-single-module-script id=integration-with-the-javascript-module-system:fetch-a-single-module-script>fetched</a>:</p>

   <ul class=brief><li><code>javascript:export default 'artichokes';</code><li><code>data:text/plain,export default 'kale';</code><li><code>about:legumes</code><li><code>wss://example.com/celery</code></ul>

   <p>The following are not valid module specifiers according to the above algorithm:</p>

   <ul class=brief><li><code>https://eggplant:b/c</code><li><code>pumpkins.js</code><li><code>.tomato</code><li><code>..zucchini.js</code><li><code>.\yam.es</code></ul>
  </div>

  <h6 id=hostresolveimportedmodule(referencingmodule,-specifier)>8.1.3.8.1 <dfn>HostResolveImportedModule</dfn>(<var>referencingModule</var>, <var>specifier</var>)<a href=#hostresolveimportedmodule(referencingmodule,-specifier) class=self-link></a></h6>

  <p>JavaScript contains an implementation-defined <a href=https://tc39.github.io/ecma262/#sec-hostresolveimportedmodule id=hostresolveimportedmodule(referencingmodule,-specifier):js-hostresolveimportedmodule data-x-internal=js-hostresolveimportedmodule>HostResolveImportedModule</a> abstract operation. User
  agents must use the following implementation: <a href=#refsJAVASCRIPT>[JAVASCRIPT]</a></p>

  <ol><li><p>Let <var>referencing module script</var> be
   <var>referencingModule</var>.[[HostDefined]].<li><p>Let <var>moduleMap</var> be <var>referencing module script</var>'s <a href=#settings-object id=hostresolveimportedmodule(referencingmodule,-specifier):settings-object>settings
   object</a>'s <a href=#concept-settings-object-module-map id=hostresolveimportedmodule(referencingmodule,-specifier):concept-settings-object-module-map>module map</a>.<li><p>Let <var>url</var> be the result of <a href=#resolve-a-module-specifier id=hostresolveimportedmodule(referencingmodule,-specifier):resolve-a-module-specifier>resolving a
   module specifier</a> given <var>referencing module script</var> and <var>specifier</var>. If
   the result is failure, then throw a <code id=hostresolveimportedmodule(referencingmodule,-specifier):typeerror><a data-x-internal=typeerror href=https://tc39.github.io/ecma262/#sec-native-error-types-used-in-this-standard-typeerror>TypeError</a></code> exception and abort these
   steps.<li><p>Let <var>resolved module script</var> be <var>moduleMap</var>[<var>url</var>]. If no such
   entry <a href=https://infra.spec.whatwg.org/#map-exists id=hostresolveimportedmodule(referencingmodule,-specifier):map-exists data-x-internal=map-exists>exists</a>, or if <var>resolved module script</var> is null or
   "<code>fetching</code>", then throw a <code id=hostresolveimportedmodule(referencingmodule,-specifier):typeerror-2><a data-x-internal=typeerror href=https://tc39.github.io/ecma262/#sec-native-error-types-used-in-this-standard-typeerror>TypeError</a></code> exception and abort these
   steps.<li><p>If <var>resolved module script</var>'s <a href=#concept-module-script-instantiation-state id=hostresolveimportedmodule(referencingmodule,-specifier):concept-module-script-instantiation-state>instantiation state</a> is "<code>errored</code>", then throw <var>resolved module script</var>'s <a href=#concept-module-script-instantiation-error id=hostresolveimportedmodule(referencingmodule,-specifier):concept-module-script-instantiation-error>instantiation error</a>.<li><p>Assert: <var>resolved module script</var>'s <a href=#concept-module-script-instantiation-state id=hostresolveimportedmodule(referencingmodule,-specifier):concept-module-script-instantiation-state-2>instantiation state</a> is "<code>instantiated</code>" (and thus its <a href=#concept-module-script-module-record id=hostresolveimportedmodule(referencingmodule,-specifier):concept-module-script-module-record>module record</a> is not null).<li><p>Return <var>resolved module script</var>'s <a href=#concept-module-script-module-record id=hostresolveimportedmodule(referencingmodule,-specifier):concept-module-script-module-record-2>module record</a>.</ol>

  


  <h5 id=runtime-script-errors>8.1.3.9 Runtime script errors<a href=#runtime-script-errors class=self-link></a></h5>

  

  <p>When the user agent is required to <dfn id=report-the-error>report an error</dfn> for a
  particular <a href=#concept-script id=runtime-script-errors:concept-script>script</a> <var>script</var> with a particular
  position <var>line</var>:<var>col</var>, using a particular target <var>target</var>, it must run these steps, after which the error is either <dfn id=concept-error-handled><i>handled</i></dfn> or <dfn id=concept-error-nothandled><i>not
  handled</i></dfn>:</p>

  <ol><li><p>If <var>target</var> is <a href=#in-error-reporting-mode id=runtime-script-errors:in-error-reporting-mode>in error reporting mode</a>, then abort these
   steps; the error is <i id=runtime-script-errors:concept-error-nothandled><a href=#concept-error-nothandled>not handled</a></i>.<li><p>Let <var>target</var> be <dfn id=in-error-reporting-mode>in error reporting mode</dfn>.<li><p>Let <var>message</var> be a user-agent-defined string describing the error in a
   helpful manner.
   <a href=#fingerprinting-vector id=runtime-script-errors:fingerprinting-vector class=fingerprint title="There is a potential fingerprinting vector here."><img alt="(This is a fingerprinting vector.)" src=/images/fingerprint.png width=46 height=64></a>
   <li><p>Let <var>errorValue</var> be the value that represents the error: in the case of an
   uncaught exception, that would be the value that was thrown; in the case of a JavaScript error
   that would be an <code id=runtime-script-errors:idl-error><a data-x-internal=idl-error href=https://heycam.github.io/webidl/#idl-Error>Error</a></code> object. If there is no corresponding
   value, then the null value must be used instead.<li>

    <p>Let <var>urlString</var> be the result of applying the <a href=https://url.spec.whatwg.org/#concept-url-serializer id=runtime-script-errors:concept-url-serializer data-x-internal=concept-url-serializer>URL serializer</a> to the <a id=runtime-script-errors:url-record href=https://url.spec.whatwg.org/#concept-url data-x-internal=url-record>URL record</a> that
    corresponds to the resource from which <var>script</var> was obtained.</p>

    <p class=note>The resource containing the script will typically be the file from which the
    <code id=runtime-script-errors:document><a href=#document>Document</a></code> was parsed, e.g. for inline <code id=runtime-script-errors:the-script-element><a href=#the-script-element>script</a></code> elements or <a href=#event-handler-content-attributes id=runtime-script-errors:event-handler-content-attributes>event
    handler content attributes</a>; or the JavaScript file that the script was in, for external
    scripts. Even for dynamically-generated scripts, user agents are strongly encouraged to attempt
    to keep track of the original source of a script. For example, if an external script uses the
    <code id=runtime-script-errors:dom-document-write><a href=#dom-document-write>document.write()</a></code> API to insert an inline
    <code id=runtime-script-errors:the-script-element-2><a href=#the-script-element>script</a></code> element during parsing, the URL of the resource containing the script would
    ideally be reported as being the external script, and the line number might ideally be reported
    as the line with the <code id=runtime-script-errors:dom-document-write-2><a href=#dom-document-write>document.write()</a></code> call or where the
    string passed to that call was first constructed. Naturally, implementing this can be somewhat
    non-trivial.</p>

    <p class=note>User agents are similarly encouraged to keep careful track of the original line
    numbers, even in the face of <code id=runtime-script-errors:dom-document-write-3><a href=#dom-document-write>document.write()</a></code> calls
    mutating the document as it is parsed, or <a href=#event-handler-content-attributes id=runtime-script-errors:event-handler-content-attributes-2>event handler content attributes</a> spanning
    multiple lines.</p>

   <li><p>If <var>script</var> has <a href=#muted-errors id=runtime-script-errors:muted-errors>muted errors</a>, then set <var>message</var> to "<code>Script error.</code>", <var>urlString</var> to the empty string, <var>line</var> and
   <var>col</var> to 0, and <var>errorValue</var> to null.<li><p>Let <var>notHandled</var> be the result of <a href=https://dom.spec.whatwg.org/#concept-event-fire id=runtime-script-errors:concept-event-fire data-x-internal=concept-event-fire>firing an
   event</a> named <code id=runtime-script-errors:event-error><a href=#event-error>error</a></code> at <var>target</var>, using
   <code id=runtime-script-errors:errorevent><a href=#errorevent>ErrorEvent</a></code>, with the <code id=runtime-script-errors:dom-event-cancelable><a data-x-internal=dom-event-cancelable href=https://dom.spec.whatwg.org/#dom-event-cancelable>cancelable</a></code> attribute
   initialized to true, the <code id=runtime-script-errors:dom-errorevent-message><a href=#dom-errorevent-message>message</a></code> attribute
   initialized to <var>message</var>, the <code id=runtime-script-errors:dom-errorevent-filename><a href=#dom-errorevent-filename>filename</a></code>
   attribute initialized to <var>urlString</var>, the <code id=runtime-script-errors:dom-errorevent-lineno><a href=#dom-errorevent-lineno>lineno</a></code> attribute initialized to <var>line</var>, the <code id=runtime-script-errors:dom-errorevent-colno><a href=#dom-errorevent-colno>colno</a></code> attribute initialized to <var>col</var>, and the <code id=runtime-script-errors:dom-errorevent-error><a href=#dom-errorevent-error>error</a></code> attribute initialized to
   <var>errorValue</var>.<li><p>Let <var>target</var> no longer be <a href=#in-error-reporting-mode id=runtime-script-errors:in-error-reporting-mode-2>in error reporting mode</a>.<li>
    <p>If <var>notHandled</var> is false, then the error is <i id=runtime-script-errors:concept-error-handled><a href=#concept-error-handled>handled</a></i>. Otherwise, the error is <i id=runtime-script-errors:concept-error-nothandled-2><a href=#concept-error-nothandled>not handled</a></i>.</p>

    <p class=note>Returning true in an event handler cancels the event per <a href=#the-event-handler-processing-algorithm id=runtime-script-errors:the-event-handler-processing-algorithm>the event handler
    processing algorithm</a>.</p>
   </ol>


  <h6 id=runtime-script-errors-in-documents>8.1.3.9.1 Runtime script errors in documents<a href=#runtime-script-errors-in-documents class=self-link></a></h6>

  <p>When the user agent is to <dfn id=report-the-exception data-lt="report the
  exception|report an exception" data-export="">report an exception</dfn> <var>E</var>, the user
  agent must <a href=#report-the-error id=runtime-script-errors-in-documents:report-the-error>report the error</a> for the relevant <a href=#concept-script id=runtime-script-errors-in-documents:concept-script>script</a>, with the problematic position (line number and column
  number) in the resource containing the script, using the <a href=#concept-settings-object-global id=runtime-script-errors-in-documents:concept-settings-object-global>global object</a> specified by the script's
  <a href=#settings-object id=runtime-script-errors-in-documents:settings-object>settings object</a> as the target. If the error is still <i id=runtime-script-errors-in-documents:concept-error-nothandled><a href=#concept-error-nothandled>not handled</a></i> after this, then the error may be reported to a
  developer console.</p>


  <h6 id=the-errorevent-interface>8.1.3.9.2 The <code id=the-errorevent-interface:errorevent><a href=#errorevent>ErrorEvent</a></code> interface<a href=#the-errorevent-interface class=self-link></a></h6>

  

  <pre class=idl>[Constructor(DOMString type, optional <a href=#erroreventinit id=the-errorevent-interface:erroreventinit>ErrorEventInit</a> eventInitDict), Exposed=(Window,Worker)]
interface <dfn id=errorevent>ErrorEvent</dfn> : <a id=the-errorevent-interface:event href=https://dom.spec.whatwg.org/#interface-event data-x-internal=event>Event</a> {
  readonly attribute DOMString <a href=#dom-errorevent-message id=the-errorevent-interface:dom-errorevent-message>message</a>;
  readonly attribute USVString <a href=#dom-errorevent-filename id=the-errorevent-interface:dom-errorevent-filename>filename</a>;
  readonly attribute unsigned long <a href=#dom-errorevent-lineno id=the-errorevent-interface:dom-errorevent-lineno>lineno</a>;
  readonly attribute unsigned long <a href=#dom-errorevent-colno id=the-errorevent-interface:dom-errorevent-colno>colno</a>;
  readonly attribute any <a href=#dom-errorevent-error id=the-errorevent-interface:dom-errorevent-error>error</a>;
};

dictionary <dfn id=erroreventinit>ErrorEventInit</dfn> : <a id=the-errorevent-interface:eventinit href=https://dom.spec.whatwg.org/#dictdef-eventinit data-x-internal=eventinit>EventInit</a> {
  DOMString message = "";
  USVString filename = "";
  unsigned long lineno = 0;
  unsigned long colno = 0;
  any error = null;
};</pre>

  <p>The <dfn id=dom-errorevent-message><code>message</code></dfn> attribute must return the
  value it was initialized to. It represents the error message.</p>

  <p>The <dfn id=dom-errorevent-filename><code>filename</code></dfn> attribute must return the
  value it was initialized to. It represents the <a id=the-errorevent-interface:url href=https://url.spec.whatwg.org/#concept-url data-x-internal=url>URL</a> of the script in which the error
  originally occurred.</p>

  <p>The <dfn id=dom-errorevent-lineno><code>lineno</code></dfn> attribute must return the
  value it was initialized to. It represents the line number where the error occurred in the
  script.</p>

  <p>The <dfn id=dom-errorevent-colno><code>colno</code></dfn> attribute must return the value
  it was initialized to. It represents the column number where the error occurred in the script.</p>

  <p>The <dfn id=dom-errorevent-error><code>error</code></dfn> attribute must return the value
  it was initialized to. Where appropriate, it is set to the object representing the error (e.g.,
  the exception object in the case of an uncaught DOM exception).</p>

  <h5 id=unhandled-promise-rejections>8.1.3.10 Unhandled promise rejections<a href=#unhandled-promise-rejections class=self-link></a></h5>

  <p>In addition to synchronous <a href=#runtime-script-errors>runtime script errors</a>, scripts
  may experience asynchronous promise rejections, tracked via the <code id=unhandled-promise-rejections:event-unhandledrejection><a href=#event-unhandledrejection>unhandledrejection</a></code> and <code id=unhandled-promise-rejections:event-rejectionhandled><a href=#event-rejectionhandled>rejectionhandled</a></code> events.</p>

  <p>When the user agent is to <dfn id=notify-about-rejected-promises>notify about rejected promises</dfn> on a given
  <a href=#environment-settings-object id=unhandled-promise-rejections:environment-settings-object>environment settings object</a> <var>settings object</var>, it must run these steps:</p>

  <ol><li><p>Let <var>list</var> be a copy of <var>settings object</var>'s <a href=#about-to-be-notified-rejected-promises-list id=unhandled-promise-rejections:about-to-be-notified-rejected-promises-list>about-to-be-notified
   rejected promises list</a>.<li><p>If <var>list</var> is empty, abort these steps.<li><p>Clear <var>settings object</var>'s <a href=#about-to-be-notified-rejected-promises-list id=unhandled-promise-rejections:about-to-be-notified-rejected-promises-list-2>about-to-be-notified rejected promises
   list</a>.<li>

    <p><a href=#queue-a-task id=unhandled-promise-rejections:queue-a-task>Queue a task</a> to run the following substep:</p>

    <ol><li><p>For each promise <var>p</var> in <var>list</var>:</p>

      <ol><li><p>If <var>p</var>'s [[PromiseIsHandled]] internal slot is true, continue to the next
       iteration of the loop.<li><p>Let <var>notHandled</var> be the result of <a href=https://dom.spec.whatwg.org/#concept-event-fire id=unhandled-promise-rejections:concept-event-fire data-x-internal=concept-event-fire>firing an
       event</a> named <code id=unhandled-promise-rejections:event-unhandledrejection-2><a href=#event-unhandledrejection>unhandledrejection</a></code> at
       <var>settings object</var>'s <a href=#concept-settings-object-global id=unhandled-promise-rejections:concept-settings-object-global>global
       object</a>, using <code id=unhandled-promise-rejections:promiserejectionevent><a href=#promiserejectionevent>PromiseRejectionEvent</a></code>, with the <code id=unhandled-promise-rejections:dom-event-cancelable><a data-x-internal=dom-event-cancelable href=https://dom.spec.whatwg.org/#dom-event-cancelable>cancelable</a></code> attribute initialized to true, the <code id=unhandled-promise-rejections:dom-promiserejectionevent-promise><a href=#dom-promiserejectionevent-promise>promise</a></code> attribute initialized to
       <var>p</var>, and the <code id=unhandled-promise-rejections:dom-promiserejectionevent-reason><a href=#dom-promiserejectionevent-reason>reason</a></code> attribute
       initialized to the value of <var>p</var>'s [[PromiseResult]] internal slot.<li><p>If <var>notHandled</var> is false, then the promise rejection is <i id=unhandled-promise-rejections:concept-promise-rejection-handled><a href=#concept-promise-rejection-handled>handled</a></i>. Otherwise, the promise rejection is
       <i id=unhandled-promise-rejections:concept-promise-rejection-nothandled><a href=#concept-promise-rejection-nothandled>not handled</a></i>.<li><p>If <var>p</var>'s [[PromiseIsHandled]] internal slot is false, add <var>p</var> to
       <var>settings object</var>'s <a href=#outstanding-rejected-promises-weak-set id=unhandled-promise-rejections:outstanding-rejected-promises-weak-set>outstanding rejected promises weak set</a>.

      </ol>
     </ol>
   </ol>

  <p>This algorithm results in promise rejections being marked as <dfn id=concept-promise-rejection-handled><i>handled</i></dfn> or <dfn id=concept-promise-rejection-nothandled><i>not handled</i></dfn>. These concepts parallel
  <i id=unhandled-promise-rejections:concept-error-handled><a href=#concept-error-handled>handled</a></i> and <i id=unhandled-promise-rejections:concept-error-nothandled><a href=#concept-error-nothandled>not
  handled</a></i> script errors. If a rejection is still <i id=unhandled-promise-rejections:concept-promise-rejection-nothandled-2><a href=#concept-promise-rejection-nothandled>not handled</a></i> after this, then the rejection may
  be reported to a developer console.</p>


  <h6 id=the-hostpromiserejectiontracker-implementation>8.1.3.10.1 <dfn>HostPromiseRejectionTracker</dfn>(<var>promise</var>, <var>operation</var>)<a href=#the-hostpromiserejectiontracker-implementation class=self-link></a></h6>

  <p>JavaScript contains an implementation-defined <a href=https://tc39.github.io/ecma262/#sec-host-promise-rejection-tracker id=the-hostpromiserejectiontracker-implementation:js-hostpromiserejectiontracker data-x-internal=js-hostpromiserejectiontracker>HostPromiseRejectionTracker</a>(<var>promise</var>,
  <var>operation</var>) abstract operation. User agents must use the following implementation:
  <a href=#refsJAVASCRIPT>[JAVASCRIPT]</a></p>

  <ol><li><p>Let <var>script</var> be the <a href=#running-script id=the-hostpromiserejectiontracker-implementation:running-script>running script</a>.<li><p>If <var>script</var> has <a href=#muted-errors id=the-hostpromiserejectiontracker-implementation:muted-errors>muted errors</a>, terminate these steps.<li><p>Let <var>settings object</var> be <var>script</var>'s <a href=#settings-object id=the-hostpromiserejectiontracker-implementation:settings-object>settings object</a>.</p>
   <li>
    <p>If <var>operation</var> is <code>"reject"</code>,

    <ol><li><p>Add <var>promise</var> to <var>settings object</var>'s <a href=#about-to-be-notified-rejected-promises-list id=the-hostpromiserejectiontracker-implementation:about-to-be-notified-rejected-promises-list>about-to-be-notified
     rejected promises list</a>.</ol>
   <li>
    <p>If <var>operation</var> is <code>"handle"</code>,

    <ol><li><p>If <var>settings object</var>'s <a href=#about-to-be-notified-rejected-promises-list id=the-hostpromiserejectiontracker-implementation:about-to-be-notified-rejected-promises-list-2>about-to-be-notified rejected promises
     list</a> contains <var>promise</var>, remove <var>promise</var> from that list and abort
     these steps.<li><p>If <var>settings object</var>'s <a href=#outstanding-rejected-promises-weak-set id=the-hostpromiserejectiontracker-implementation:outstanding-rejected-promises-weak-set>outstanding rejected promises weak set</a>
     does not contain <var>promise</var>, abort these steps.<li><p>Remove <var>promise</var> from <var>settings object</var>'s <a href=#outstanding-rejected-promises-weak-set id=the-hostpromiserejectiontracker-implementation:outstanding-rejected-promises-weak-set-2>outstanding rejected
     promises weak set</a>.<li><p><a href=#queue-a-task id=the-hostpromiserejectiontracker-implementation:queue-a-task>Queue a task</a> to <a href=https://dom.spec.whatwg.org/#concept-event-fire id=the-hostpromiserejectiontracker-implementation:concept-event-fire data-x-internal=concept-event-fire>fire an event</a>
     named <code id=the-hostpromiserejectiontracker-implementation:event-rejectionhandled><a href=#event-rejectionhandled>rejectionhandled</a></code> at <var>settings
     object</var>'s <a href=#concept-settings-object-global id=the-hostpromiserejectiontracker-implementation:concept-settings-object-global>global object</a>, using
     <code id=the-hostpromiserejectiontracker-implementation:promiserejectionevent><a href=#promiserejectionevent>PromiseRejectionEvent</a></code>, with the <code id=the-hostpromiserejectiontracker-implementation:dom-promiserejectionevent-promise><a href=#dom-promiserejectionevent-promise>promise</a></code> attribute initialized to
     <var>promise</var>, and the <code id=the-hostpromiserejectiontracker-implementation:dom-promiserejectionevent-reason><a href=#dom-promiserejectionevent-reason>reason</a></code>
     attribute initialized to the value of <var>promise</var>'s [[PromiseResult]] internal
     slot.</ol>
   </ol>

  <h6 id=the-promiserejectionevent-interface>8.1.3.10.2 The <code id=the-promiserejectionevent-interface:promiserejectionevent><a href=#promiserejectionevent>PromiseRejectionEvent</a></code> interface<a href=#the-promiserejectionevent-interface class=self-link></a></h6>

  <pre class=idl>[Constructor(DOMString type, <a href=#promiserejectioneventinit id=the-promiserejectionevent-interface:promiserejectioneventinit>PromiseRejectionEventInit</a> eventInitDict), Exposed=(Window,Worker)]
interface <dfn id=promiserejectionevent>PromiseRejectionEvent</dfn> : <a id=the-promiserejectionevent-interface:event href=https://dom.spec.whatwg.org/#interface-event data-x-internal=event>Event</a> {
  readonly attribute Promise&lt;any> <a href=#dom-promiserejectionevent-promise id=the-promiserejectionevent-interface:dom-promiserejectionevent-promise>promise</a>;
  readonly attribute any <a href=#dom-promiserejectionevent-reason id=the-promiserejectionevent-interface:dom-promiserejectionevent-reason>reason</a>;
};

dictionary <dfn id=promiserejectioneventinit>PromiseRejectionEventInit</dfn> : <a id=the-promiserejectionevent-interface:eventinit href=https://dom.spec.whatwg.org/#dictdef-eventinit data-x-internal=eventinit>EventInit</a> {
  required Promise&lt;any> promise;
  any reason;
};</pre>

  <p>The <dfn id=dom-promiserejectionevent-promise><code>promise</code></dfn> attribute must
  return the value it was initialized to. It represents the promise which this notification is about.</p>

  <p>The <dfn id=dom-promiserejectionevent-reason><code>reason</code></dfn> attribute must
  return the value it was initialized to. It represents the rejection reason for the promise.</p>

  <h5 id=hostensurecancompilestrings(callerrealm,-calleerealm)>8.1.3.11 <dfn>HostEnsureCanCompileStrings</dfn>(<var>callerRealm</var>, <var>calleeRealm</var>)<a href=#hostensurecancompilestrings(callerrealm,-calleerealm) class=self-link></a></h5>

  <p>JavaScript contains an implementation-defined <a href=https://tc39.github.io/ecma262/#sec-hostensurecancompilestrings id=hostensurecancompilestrings(callerrealm,-calleerealm):js-hostensurecancompilestrings data-x-internal=js-hostensurecancompilestrings>HostEnsureCanCompileStrings</a>(<var>callerRealm</var>,
  <var>calleeRealm</var>) abstract operation. User agents must use the following implementation:
  <a href=#refsJAVASCRIPT>[JAVASCRIPT]</a>

  <ol><li><p>Perform ? <a href=https://w3c.github.io/webappsec-csp/#can-compile-strings id=hostensurecancompilestrings(callerrealm,-calleerealm):csp-ensurecspdoesnotblockstringcompilation data-x-internal=csp-ensurecspdoesnotblockstringcompilation>EnsureCSPDoesNotBlockStringCompilation</a>(<var>callerRealm</var>,
   <var>calleeRealm</var>). <a href=#refsCSP>[CSP]</a></ol>

  

  <h4 id=event-loops>8.1.4 Event loops<a href=#event-loops class=self-link></a></h4> 

  <h5 id=definitions-3>8.1.4.1 Definitions<a href=#definitions-3 class=self-link></a></h5>

  <p>To coordinate events, user interaction, scripts, rendering, networking, and so forth, user
  agents must use <dfn id=event-loop data-lt="event loop" data-export="">event loops</dfn> as
  described in this section. There are two kinds of event loops: those for <a href=#browsing-context id=definitions-3:browsing-context>browsing contexts</a>, and those for <a href=#workers>workers</a>.</p>

  <p>There must be at least one <a href=#browsing-context id=definitions-3:browsing-context-2>browsing context</a> <a href=#event-loop id=definitions-3:event-loop>event loop</a> per user
  agent, and at most one per <a href=#unit-of-related-similar-origin-browsing-contexts id=definitions-3:unit-of-related-similar-origin-browsing-contexts>unit of related similar-origin browsing contexts</a>.</p>

  <p class=note>When there is more than one <a href=#event-loop id=definitions-3:event-loop-2>event loop</a> for a <a href=#unit-of-related-browsing-contexts id=definitions-3:unit-of-related-browsing-contexts>unit of related
  browsing contexts</a>, complications arise when a <a href=#browsing-context id=definitions-3:browsing-context-3>browsing context</a> in that group
  is <a href=#navigate id=definitions-3:navigate>navigated</a> such that it switches from one <a href=#unit-of-related-similar-origin-browsing-contexts id=definitions-3:unit-of-related-similar-origin-browsing-contexts-2>unit of related
  similar-origin browsing contexts</a> to another. This specification does not currently describe
  how to handle these complications.</p>

  <p>A <a href=#browsing-context id=definitions-3:browsing-context-4>browsing context</a> <a href=#event-loop id=definitions-3:event-loop-3>event loop</a> always has at least one <a href=#browsing-context id=definitions-3:browsing-context-5>browsing
  context</a>. If such an <a href=#event-loop id=definitions-3:event-loop-4>event loop</a>'s <a href=#browsing-context id=definitions-3:browsing-context-6>browsing
  contexts</a> all go away, then the <a href=#event-loop id=definitions-3:event-loop-5>event loop</a> goes away as well. A <a href=#browsing-context id=definitions-3:browsing-context-7>browsing
  context</a> always has an <a href=#event-loop id=definitions-3:event-loop-6>event loop</a> coordinating its activities.</p>

  <p><a href=#worker-event-loop>Worker event loops</a> are simpler: each worker has one
  <a href=#event-loop id=definitions-3:event-loop-7>event loop</a>, and the <a href=#run-a-worker id=definitions-3:run-a-worker>worker processing model</a>
  manages the <a href=#event-loop id=definitions-3:event-loop-8>event loop</a>'s lifetime.</p>

  <hr>

  <p>An <a href=#event-loop id=definitions-3:event-loop-9>event loop</a> has one or more <dfn id=task-queue>task queues</dfn>. A
  <a href=#task-queue id=definitions-3:task-queue>task queue</a> is an ordered list of <dfn id=concept-task data-lt=task data-export="">tasks</dfn>, which are algorithms that are responsible for such work as:</p>

  <dl><dt>Events<dd>

    <p>Dispatching an <code id=definitions-3:event><a data-x-internal=event href=https://dom.spec.whatwg.org/#interface-event>Event</a></code> object at a particular
    <code id=definitions-3:eventtarget><a data-x-internal=eventtarget href=https://dom.spec.whatwg.org/#interface-eventtarget>EventTarget</a></code> object is often done by a dedicated task.</p>

    <p class=note>Not all events are dispatched using the <a href=#task-queue id=definitions-3:task-queue-2>task queue</a>, many are
    dispatched during other tasks.</p>

   <dt>Parsing<dd><p>The <a href=#html-parser id=definitions-3:html-parser>HTML parser</a> tokenizing one or more bytes, and then processing any
   resulting tokens, is typically a task.<dt>Callbacks<dd><p>Calling a callback is often done by a dedicated task.<dt>Using a resource<dd><p>When an algorithm <a href=https://fetch.spec.whatwg.org/#concept-fetch id=definitions-3:concept-fetch data-x-internal=concept-fetch>fetches</a> a resource, if the fetching
   occurs in a non-blocking fashion then the processing of the resource once some or all of the
   resource is available is performed by a task.<dt>Reacting to DOM manipulation<dd><p>Some elements have tasks that trigger in response to DOM manipulation, e.g. when that
   element is <a href=#insert-an-element-into-a-document id=definitions-3:insert-an-element-into-a-document>inserted into the document</a>.</p>

  </dl>

  <p>Each <a href=#concept-task id=definitions-3:concept-task>task</a> in a <a href=#browsing-context id=definitions-3:browsing-context-8>browsing context</a> <a href=#event-loop id=definitions-3:event-loop-10>event
  loop</a> is associated with a <code id=definitions-3:document><a href=#document>Document</a></code>; if the task was queued in the context of
  an element, then it is the element's <a id=definitions-3:node-document href=https://dom.spec.whatwg.org/#concept-node-document data-x-internal=node-document>node document</a>; if the task was queued in the context
  of a <a href=#browsing-context id=definitions-3:browsing-context-9>browsing context</a>, then it is the <a href=#browsing-context id=definitions-3:browsing-context-10>browsing context</a>'s <a href=#active-document id=definitions-3:active-document>active
  document</a> at the time the task was queued; if the task was queued by or for a <a href=#concept-script id=definitions-3:concept-script>script</a> then the document is the <a href=#responsible-document id=definitions-3:responsible-document>responsible document</a>
  specified by the script's <a href=#settings-object id=definitions-3:settings-object>settings object</a>.</p>

  <p>A <a href=#concept-task id=definitions-3:concept-task-2>task</a> is intended for a specific <a href=#event-loop id=definitions-3:event-loop-11>event loop</a>:
  the <a href=#event-loop id=definitions-3:event-loop-12>event loop</a> that is handling <a href=#concept-task id=definitions-3:concept-task-3>tasks</a> for the
  <a href=#concept-task id=definitions-3:concept-task-4>task</a>'s associated <code id=definitions-3:document-2><a href=#document>Document</a></code> or <a href=#workers>worker</a>.</p>

  <p>When a user agent is to <dfn id=queue-a-task data-export="">queue a task</dfn>, it must add the given task to
  one of the <a href=#task-queue id=definitions-3:task-queue-3>task queues</a> of the relevant <a href=#event-loop id=definitions-3:event-loop-13>event
  loop</a>.</p>

  <p>Each <a href=#concept-task id=definitions-3:concept-task-5>task</a> is defined as coming from a specific <dfn id=task-source data-export="">task source</dfn>. All the tasks from one particular <a href=#task-source id=definitions-3:task-source>task source</a> and
  destined to a particular <a href=#event-loop id=definitions-3:event-loop-14>event loop</a> (e.g. the callbacks generated by timers of a
  <code id=definitions-3:document-3><a href=#document>Document</a></code>, the events fired for mouse movements over that <code id=definitions-3:document-4><a href=#document>Document</a></code>, the
  tasks queued for the parser of that <code id=definitions-3:document-5><a href=#document>Document</a></code>) must always be added to the same
  <a href=#task-queue id=definitions-3:task-queue-4>task queue</a>, but <a href=#concept-task id=definitions-3:concept-task-6>tasks</a> from different <a href=#task-source id=definitions-3:task-source-2>task sources</a> may be placed in different <a href=#task-queue id=definitions-3:task-queue-5>task
  queues</a>.</p>

  <p class=example>For example, a user agent could have one <a href=#task-queue id=definitions-3:task-queue-6>task queue</a> for mouse and
  key events (the <a href=#user-interaction-task-source id=definitions-3:user-interaction-task-source>user interaction task source</a>), and another for everything else. The
  user agent could then give keyboard and mouse events preference over other tasks three quarters of
  the time, keeping the interface responsive but not starving other task queues, and never
  processing events from any one <a href=#task-source id=definitions-3:task-source-3>task source</a> out of order.</p>

  <p>Each <a href=#event-loop id=definitions-3:event-loop-15>event loop</a> has a <dfn id=currently-running-task>currently running task</dfn>. Initially, this is null.
  It is used to handle reentrancy. Each <a href=#event-loop id=definitions-3:event-loop-16>event loop</a> also has a <dfn id=performing-a-microtask-checkpoint>performing a
  microtask checkpoint</dfn> flag, which must initially be false. It is used to prevent reentrant
  invocation of the <a href=#perform-a-microtask-checkpoint id=definitions-3:perform-a-microtask-checkpoint>perform a microtask checkpoint</a> algorithm.</p>

  <h5 id=event-loop-processing-model>8.1.4.2 <span id=processing-model-8></span>Processing model<a href=#event-loop-processing-model class=self-link></a></h5>
  

  <p>An <a href=#event-loop id=event-loop-processing-model:event-loop>event loop</a> must continually run through the following steps for as long as it
  exists:</p>

  <ol><li id=step1>

    <p>Select the oldest <a href=#concept-task id=event-loop-processing-model:concept-task>task</a> on one of the <a href=#event-loop id=event-loop-processing-model:event-loop-2>event
    loop</a>'s <a href=#task-queue id=event-loop-processing-model:task-queue>task queues</a>, if any, ignoring, in the case of a
    <a href=#browsing-context id=event-loop-processing-model:browsing-context>browsing context</a> <a href=#event-loop id=event-loop-processing-model:event-loop-3>event loop</a>, tasks whose associated
    <code id=event-loop-processing-model:document><a href=#document>Document</a></code>s are not <a href=#fully-active id=event-loop-processing-model:fully-active>fully active</a>. The user agent may pick any <a href=#task-queue id=event-loop-processing-model:task-queue-2>task
    queue</a>. If there is no task to select, then jump to the <i>microtasks</i> step below.</p>

   <li><p>Set the <a href=#event-loop id=event-loop-processing-model:event-loop-4>event loop</a>'s <a href=#currently-running-task id=event-loop-processing-model:currently-running-task>currently running task</a> to the <a href=#concept-task id=event-loop-processing-model:concept-task-2>task</a> selected in the previous step.<li><p><i>Run</i>: Run the selected <a href=#concept-task id=event-loop-processing-model:concept-task-3>task</a>.<li><p>Set the <a href=#event-loop id=event-loop-processing-model:event-loop-5>event loop</a>'s <a href=#currently-running-task id=event-loop-processing-model:currently-running-task-2>currently running task</a> back to
   null.<li><p>Remove the task that was run in the <i>run</i> step above from its <a href=#task-queue id=event-loop-processing-model:task-queue-3>task
   queue</a>.<li><p><i>Microtasks</i>: <a href=#perform-a-microtask-checkpoint id=event-loop-processing-model:perform-a-microtask-checkpoint>Perform a microtask checkpoint</a>.<li>

    <p><i>Update the rendering</i>: If this <a href=#event-loop id=event-loop-processing-model:event-loop-6>event loop</a> is a <a href=#browsing-context id=event-loop-processing-model:browsing-context-2>browsing
    context</a> <a href=#event-loop id=event-loop-processing-model:event-loop-7>event loop</a> (as opposed to a <a href=#workers>worker</a>
    <a href=#event-loop id=event-loop-processing-model:event-loop-8>event loop</a>), then run the following substeps.</p>

    <ol><li><p>Let <var>now</var> be the value that would be returned by the <code id=event-loop-processing-model:performance><a data-x-internal=performance href=https://w3c.github.io/hr-time/#the-performance-interface>Performance</a></code>
     object's <code id=event-loop-processing-model:dom-performance-now><a data-x-internal=dom-performance-now href=https://w3c.github.io/hr-time/#dom-performance-now>now()</a></code> method. <a href=#refsHRT>[HRT]</a></p>

     <li>

      <p>Let <var>docs</var> be the list of <code id=event-loop-processing-model:document-2><a href=#document>Document</a></code> objects associated with the
      <a href=#event-loop id=event-loop-processing-model:event-loop-9>event loop</a> in question, sorted arbitrarily except that the following conditions
      must be met:</p>

      <ul><li><p>Any <code id=event-loop-processing-model:document-3><a href=#document>Document</a></code> <var>B</var> that is <a href=#browsing-context-nested-through id=event-loop-processing-model:browsing-context-nested-through>nested through</a> a <code id=event-loop-processing-model:document-4><a href=#document>Document</a></code> <var>A</var> must be listed after
       <var>A</var> in the list.<li><p>If there are two documents <var>A</var> and <var>B</var> whose <a href=#concept-document-bc id=event-loop-processing-model:concept-document-bc>browsing contexts</a> are both <a href=#nested-browsing-context id=event-loop-processing-model:nested-browsing-context>nested browsing contexts</a> and their <a href=#browsing-context-container id=event-loop-processing-model:browsing-context-container>browsing context containers</a> are both elements in the same
       <code id=event-loop-processing-model:document-5><a href=#document>Document</a></code> <var>C</var>, then the order of <var>A</var> and <var>B</var> in the
       list must match the relative <a id=event-loop-processing-model:tree-order href=https://dom.spec.whatwg.org/#concept-tree-order data-x-internal=tree-order>tree order</a> of their respective <a href=#browsing-context-container id=event-loop-processing-model:browsing-context-container-2>browsing context containers</a> in
       <var>C</var>.</ul>

      <p>In the steps below that iterate over <var>docs</var>, each <code id=event-loop-processing-model:document-6><a href=#document>Document</a></code> must be
      processed in the order it is found in the list.</p>

     <li>

      <p>If there are <a href=#top-level-browsing-context id=event-loop-processing-model:top-level-browsing-context>top-level browsing contexts</a>
      <var>B</var> that the user agent believes would not benefit from having their rendering
      updated at this time, then remove from <var>docs</var> all <code id=event-loop-processing-model:document-7><a href=#document>Document</a></code> objects whose
      <a href=#concept-document-bc id=event-loop-processing-model:concept-document-bc-2>browsing context</a>'s <a href=#top-level-browsing-context id=event-loop-processing-model:top-level-browsing-context-2>top-level browsing
      context</a> is in <var>B</var>.</p>

      <div class=note>
       <p>Whether a <a href=#top-level-browsing-context id=event-loop-processing-model:top-level-browsing-context-3>top-level browsing context</a> would benefit from having its rendering
       updated depends on various factors, such as the update frequency. For example, if the browser
       is attempting to achieve a 60Hz refresh rate, then these steps are only necessary every 60th
       of a second (about 16.7ms). If the browser finds that a <a href=#top-level-browsing-context id=event-loop-processing-model:top-level-browsing-context-4>top-level browsing
       context</a> is not able to sustain this rate, it might drop to a more sustainable 30Hz for
       that set of <code id=event-loop-processing-model:document-8><a href=#document>Document</a></code>s, rather than occasionally dropping frames. (This
       specification does not mandate any particular model for when to update the rendering.)
       Similarly, if a <a href=#top-level-browsing-context id=event-loop-processing-model:top-level-browsing-context-5>top-level browsing context</a> is in the background, the user agent
       might decide to drop that page to a much slower 4Hz, or even less.</p>

       <p>Another example of why a browser might skip updating the rendering is to ensure certain
       <a href=#concept-task id=event-loop-processing-model:concept-task-4>tasks</a> are executed immediately after each other, with only
       <a href=#perform-a-microtask-checkpoint id=event-loop-processing-model:perform-a-microtask-checkpoint-2>microtask checkpoints</a> interleaved (and
       without, e.g., <a href=#run-the-animation-frame-callbacks id=event-loop-processing-model:run-the-animation-frame-callbacks>animation frame
       callbacks</a> interleaved). For example, a user agent might wish to coalesce timer
       callbacks together, with no intermediate rendering updates.</p>
      </div>

     <li>

      <p>If there are a <a href=#nested-browsing-context id=event-loop-processing-model:nested-browsing-context-2>nested browsing contexts</a>
      <var>B</var> that the user agent believes would not benefit from having their rendering
      updated at this time, then remove from <var>docs</var> all <code id=event-loop-processing-model:document-9><a href=#document>Document</a></code> objects whose
      <a href=#concept-document-bc id=event-loop-processing-model:concept-document-bc-3>browsing context</a> is in <var>B</var>.</p>

      <p class=note>As with <a href=#top-level-browsing-context id=event-loop-processing-model:top-level-browsing-context-6>top-level browsing
      contexts</a>, a variety of factors can influence whether it is profitable for a browser to
      update the rendering of <a href=#nested-browsing-context id=event-loop-processing-model:nested-browsing-context-3>nested browsing
      contexts</a>. For example, a user agent might wish to spend less resources rendering
      third-party content, especially if it is not currently visible to the user or if resources are
      constrained. In such cases, the browser could decide to update the rendering for such content
      infrequently or never.</p>

     <li><p>For each <a href=#fully-active id=event-loop-processing-model:fully-active-2>fully active</a> <code id=event-loop-processing-model:document-10><a href=#document>Document</a></code> in <var>docs</var>, <a id=event-loop-processing-model:run-the-resize-steps href=https://drafts.csswg.org/cssom-view/#run-the-resize-steps data-x-internal=run-the-resize-steps>run the resize
     steps</a> for that <code id=event-loop-processing-model:document-11><a href=#document>Document</a></code>, passing in <var>now</var> as the timestamp. <a href=#refsCSSOMVIEW>[CSSOMVIEW]</a><li><p>For each <a href=#fully-active id=event-loop-processing-model:fully-active-3>fully active</a> <code id=event-loop-processing-model:document-12><a href=#document>Document</a></code> in <var>docs</var>, <a id=event-loop-processing-model:run-the-scroll-steps href=https://drafts.csswg.org/cssom-view/#run-the-scroll-steps data-x-internal=run-the-scroll-steps>run the scroll
     steps</a> for that <code id=event-loop-processing-model:document-13><a href=#document>Document</a></code>, passing in <var>now</var> as the timestamp. <a href=#refsCSSOMVIEW>[CSSOMVIEW]</a><li><p>For each <a href=#fully-active id=event-loop-processing-model:fully-active-4>fully active</a> <code id=event-loop-processing-model:document-14><a href=#document>Document</a></code> in <var>docs</var>, <a id=event-loop-processing-model:evaluate-media-queries-and-report-changes href=https://drafts.csswg.org/cssom-view/#evaluate-media-queries-and-report-changes data-x-internal=evaluate-media-queries-and-report-changes>evaluate media queries
     and report changes</a> for that <code id=event-loop-processing-model:document-15><a href=#document>Document</a></code>, passing in <var>now</var> as the timestamp. <a href=#refsCSSOMVIEW>[CSSOMVIEW]</a><li><p>For each <a href=#fully-active id=event-loop-processing-model:fully-active-5>fully active</a> <code id=event-loop-processing-model:document-16><a href=#document>Document</a></code> in <var>docs</var>, <dfn id=run-css-animations-and-send-events>run CSS animations and send
     events</dfn> for that <code id=event-loop-processing-model:document-17><a href=#document>Document</a></code>, passing in <var>now</var> as the timestamp. <a href=#refsCSSANIMATIONS>[CSSANIMATIONS]</a><li><p>For each <a href=#fully-active id=event-loop-processing-model:fully-active-6>fully active</a> <code id=event-loop-processing-model:document-18><a href=#document>Document</a></code> in <var>docs</var>, <dfn id=run-the-fullscreen-rendering-steps>run the fullscreen rendering
     steps</dfn> for that <code id=event-loop-processing-model:document-19><a href=#document>Document</a></code>, passing in <var>now</var> as the timestamp. <a href=#refsFULLSCREEN>[FULLSCREEN]</a><div class=status><input onclick=toggleStatus(this) value= type=button><p class=bugs><strong>Spec bugs:</strong> <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=28001" title="Formalize rendering tasks">28001</a></div><li><p>For each <a href=#fully-active id=event-loop-processing-model:fully-active-7>fully active</a> <code id=event-loop-processing-model:document-20><a href=#document>Document</a></code> in <var>docs</var>, <a href=#run-the-animation-frame-callbacks id=event-loop-processing-model:run-the-animation-frame-callbacks-2>run the animation frame
     callbacks</a> for that <code id=event-loop-processing-model:document-21><a href=#document>Document</a></code>, passing in <var>now</var> as the
     timestamp.<li><p>For each <a href=#fully-active id=event-loop-processing-model:fully-active-8>fully active</a> <code id=event-loop-processing-model:document-22><a href=#document>Document</a></code> in <var>docs</var>, <a id=event-loop-processing-model:run-the-update-intersection-observations-steps href=https://wicg.github.io/IntersectionObserver/#run-the-update-intersection-observations-steps data-x-internal=run-the-update-intersection-observations-steps>run the update
     intersection observations steps</a> for that <code id=event-loop-processing-model:document-23><a href=#document>Document</a></code>, passing in <var>now</var> as the
     timestamp. <a href=#refsINTERSECTIONOBSERVER>[INTERSECTIONOBSERVER]</a><li><p>For each <a href=#fully-active id=event-loop-processing-model:fully-active-9>fully active</a> <code id=event-loop-processing-model:document-24><a href=#document>Document</a></code> in <var>docs</var>, update the
     rendering or user interface of that <code id=event-loop-processing-model:document-25><a href=#document>Document</a></code> and its <a href=#concept-document-bc id=event-loop-processing-model:concept-document-bc-4>browsing context</a> to reflect the current state.</ol>

   <li><p>If this is a <a href=#workers>worker</a> <a href=#event-loop id=event-loop-processing-model:event-loop-10>event loop</a> (i.e. one running for a
   <code id=event-loop-processing-model:workerglobalscope><a href=#workerglobalscope>WorkerGlobalScope</a></code>), but there are no <a href=#concept-task id=event-loop-processing-model:concept-task-5>tasks</a> in the
   <a href=#event-loop id=event-loop-processing-model:event-loop-11>event loop</a>'s <a href=#task-queue id=event-loop-processing-model:task-queue-4>task queues</a> and the
   <code id=event-loop-processing-model:workerglobalscope-2><a href=#workerglobalscope>WorkerGlobalScope</a></code> object's <a href=#dom-workerglobalscope-closing id=event-loop-processing-model:dom-workerglobalscope-closing>closing</a> flag is true, then destroy the <a href=#event-loop id=event-loop-processing-model:event-loop-12>event
   loop</a>, aborting these steps, resuming the <a href=#run-a-worker id=event-loop-processing-model:run-a-worker>run a worker</a> steps described in the
   <a href=#workers>Web workers</a> section below.<li><p>Return to the <a href=#step1>first step</a> of the <a href=#event-loop id=event-loop-processing-model:event-loop-13>event loop</a>.</ol>

  <hr>

  <p>Each <a href=#event-loop id=event-loop-processing-model:event-loop-14>event loop</a> has a <dfn id=microtask-queue>microtask queue</dfn>. A <dfn id=microtask data-export="">microtask</dfn> is a <a href=#concept-task id=event-loop-processing-model:concept-task-6>task</a> that is originally to
  be queued on the <a href=#microtask-queue id=event-loop-processing-model:microtask-queue>microtask queue</a> rather than a <a href=#task-queue id=event-loop-processing-model:task-queue-5>task queue</a>. There are two
  kinds of <a href=#microtask id=event-loop-processing-model:microtask>microtasks</a>: <dfn id=solitary-callback-microtask data-lt="solitary callback microtask" data-export="">solitary callback
  microtasks</dfn>, and <dfn id=compound-microtask data-lt="compound microtask" data-export="">compound microtasks</dfn>.</p>

  <p class=note>This specification only has <a href=#solitary-callback-microtask id=event-loop-processing-model:solitary-callback-microtask>solitary
  callback microtasks</a>. Specifications that use <a href=#compound-microtask id=event-loop-processing-model:compound-microtask>compound
  microtasks</a> have to take extra care to <a href=#execute-a-compound-microtask-subtask id=event-loop-processing-model:execute-a-compound-microtask-subtask>wrap callbacks</a> to handle <a href=#spin-the-event-loop id=event-loop-processing-model:spin-the-event-loop>spinning the event
  loop</a>.</p>

  <p>When an algorithm requires a <a href=#microtask id=event-loop-processing-model:microtask-2>microtask</a> to be <dfn id=queue-a-microtask data-lt="queue a microtask" data-export="">queued</dfn>, it must be appended to the
  relevant <a href=#event-loop id=event-loop-processing-model:event-loop-15>event loop</a>'s <a href=#microtask-queue id=event-loop-processing-model:microtask-queue-2>microtask queue</a>; the <a href=#task-source id=event-loop-processing-model:task-source>task source</a> of
  such a <a href=#microtask id=event-loop-processing-model:microtask-3>microtask</a> is the <dfn id=microtask-task-source>microtask task source</dfn>.</p>

  <p class=note>It is possible for a <a href=#microtask id=event-loop-processing-model:microtask-4>microtask</a> to be moved to a regular <a href=#task-queue id=event-loop-processing-model:task-queue-6>task
  queue</a>, if, during its initial execution, it <a href=#spin-the-event-loop id=event-loop-processing-model:spin-the-event-loop-2>spins the
  event loop</a>. In that case, the <a href=#microtask-task-source id=event-loop-processing-model:microtask-task-source>microtask task source</a> is the <a href=#task-source id=event-loop-processing-model:task-source-2>task
  source</a> used. Normally, the <a href=#task-source id=event-loop-processing-model:task-source-3>task source</a> of a <a href=#microtask id=event-loop-processing-model:microtask-5>microtask</a> is
  irrelevant.</p>

  <p>When a user agent is to <dfn id=perform-a-microtask-checkpoint data-export="">perform a microtask checkpoint</dfn>, if the
  <a href=#performing-a-microtask-checkpoint id=event-loop-processing-model:performing-a-microtask-checkpoint>performing a microtask checkpoint</a> flag is false, then the user agent must run the
  following steps:</p>

  <ol><li><p>Let the <a href=#performing-a-microtask-checkpoint id=event-loop-processing-model:performing-a-microtask-checkpoint-2>performing a microtask checkpoint</a> flag be true.<li><p><i>Microtask queue handling</i>: If the <a href=#event-loop id=event-loop-processing-model:event-loop-16>event loop</a>'s <a href=#microtask-queue id=event-loop-processing-model:microtask-queue-3>microtask
   queue</a> is empty, jump to the <i>done</i> step below.<li><p>Select the oldest <a href=#microtask id=event-loop-processing-model:microtask-6>microtask</a> on the <a href=#event-loop id=event-loop-processing-model:event-loop-17>event loop</a>'s <a href=#microtask-queue id=event-loop-processing-model:microtask-queue-4>microtask
   queue</a>.<li><p>Set the <a href=#event-loop id=event-loop-processing-model:event-loop-18>event loop</a>'s <a href=#currently-running-task id=event-loop-processing-model:currently-running-task-3>currently running task</a> to the <a href=#concept-task id=event-loop-processing-model:concept-task-7>task</a> selected in the previous step.<li>

    <p><i>Run</i>: Run the selected <a href=#concept-task id=event-loop-processing-model:concept-task-8>task</a>.</p>

    <p class=note>This might involve invoking scripted callbacks, which eventually calls the
    <a href=#clean-up-after-running-script id=event-loop-processing-model:clean-up-after-running-script>clean up after running script</a> steps, which call this <a href=#perform-a-microtask-checkpoint id=event-loop-processing-model:perform-a-microtask-checkpoint-3>perform a microtask
    checkpoint</a> algorithm again, which is why we use the <a href=#performing-a-microtask-checkpoint id=event-loop-processing-model:performing-a-microtask-checkpoint-3>performing a microtask
    checkpoint</a> flag to avoid reentrancy.</p>

   <li><p>Set the <a href=#event-loop id=event-loop-processing-model:event-loop-19>event loop</a>'s <a href=#currently-running-task id=event-loop-processing-model:currently-running-task-4>currently running task</a> back to
   null.<li><p>Remove the <a href=#microtask id=event-loop-processing-model:microtask-7>microtask</a> run in the step above from the <a href=#microtask-queue id=event-loop-processing-model:microtask-queue-5>microtask
   queue</a>, and return to the <i>microtask queue handling</i> step.<li><p><i>Done</i>: For each <a href=#environment-settings-object id=event-loop-processing-model:environment-settings-object>environment settings object</a> whose <a href=#responsible-event-loop id=event-loop-processing-model:responsible-event-loop>responsible
   event loop</a> is this <a href=#event-loop id=event-loop-processing-model:event-loop-20>event loop</a>, <a href=#notify-about-rejected-promises id=event-loop-processing-model:notify-about-rejected-promises>notify about rejected promises</a>
   on that <a href=#environment-settings-object id=event-loop-processing-model:environment-settings-object-2>environment settings object</a>.<li><p>Let the <a href=#performing-a-microtask-checkpoint id=event-loop-processing-model:performing-a-microtask-checkpoint-4>performing a microtask checkpoint</a> flag be false.</ol>

  <p>If, while a <a href=#compound-microtask id=event-loop-processing-model:compound-microtask-2>compound microtask</a> is running, the user agent is required to
  <dfn id=execute-a-compound-microtask-subtask data-export="">execute a compound microtask subtask</dfn> to run a series of steps, the user
  agent must run the following steps:</p>

  <ol><li><p>Let <var>parent</var> be the <a href=#event-loop id=event-loop-processing-model:event-loop-21>event loop</a>'s <a href=#currently-running-task id=event-loop-processing-model:currently-running-task-5>currently running
   task</a> (the currently running <a href=#compound-microtask id=event-loop-processing-model:compound-microtask-3>compound microtask</a>).<li><p>Let <var>subtask</var> be a new <a href=#concept-task id=event-loop-processing-model:concept-task-9>task</a> that
   consists of running the given series of steps. The <a href=#task-source id=event-loop-processing-model:task-source-4>task source</a> of such a
   <a href=#microtask id=event-loop-processing-model:microtask-8>microtask</a> is the <a href=#microtask-task-source id=event-loop-processing-model:microtask-task-source-2>microtask task source</a>. This is a <dfn id=compound-microtask-subtask>compound
   microtask subtask</dfn>.<li><p>Set the <a href=#event-loop id=event-loop-processing-model:event-loop-22>event loop</a>'s <a href=#currently-running-task id=event-loop-processing-model:currently-running-task-6>currently running task</a> to <var>subtask</var>.<li><p>Run <var>subtask</var>.<li><p>Set the <a href=#event-loop id=event-loop-processing-model:event-loop-23>event loop</a>'s <a href=#currently-running-task id=event-loop-processing-model:currently-running-task-7>currently running task</a> back to <var>parent</var>.</ol>

  <hr>

  <p>When an algorithm running <a href=#in-parallel id=event-loop-processing-model:in-parallel>in parallel</a> is to <dfn id=await-a-stable-state>await a stable state</dfn>, the
  user agent must <a href=#queue-a-microtask id=event-loop-processing-model:queue-a-microtask>queue a microtask</a> that runs the following steps, and must then stop
  executing (execution of the algorithm resumes when the microtask is run, as described in the
  following steps):</p>

  <ol><li><p>Run the algorithm's <dfn id=synchronous-section>synchronous section</dfn>.<li><p>Resumes execution of the algorithm <a href=#in-parallel id=event-loop-processing-model:in-parallel-2>in parallel</a>, if appropriate, as described
   in the algorithm's steps.</ol>

  <p class=note>Steps in <a href=#synchronous-section id=event-loop-processing-model:synchronous-section>synchronous sections</a> are marked
  with .</p>

  <hr>

  <p>When an algorithm says to <dfn id=spin-the-event-loop>spin the event loop</dfn> until a condition <var>goal</var> is met, the user agent must run the following steps:</p>

  <ol><li>

    <p>Let <var>task</var> be the <a href=#event-loop id=event-loop-processing-model:event-loop-24>event loop</a>'s <a href=#currently-running-task id=event-loop-processing-model:currently-running-task-8>currently running
    task</a>.</p>

    <p class=note>This might be a <a href=#microtask id=event-loop-processing-model:microtask-9>microtask</a>, in which case it is a <a href=#solitary-callback-microtask id=event-loop-processing-model:solitary-callback-microtask-2>solitary
    callback microtask</a>. It could also be a <a href=#compound-microtask-subtask id=event-loop-processing-model:compound-microtask-subtask>compound microtask subtask</a>, or a
    regular <a href=#concept-task id=event-loop-processing-model:concept-task-10>task</a> that is not a <a href=#microtask id=event-loop-processing-model:microtask-10>microtask</a>. It will
    <em>not</em> be a <a href=#compound-microtask id=event-loop-processing-model:compound-microtask-4>compound microtask</a>.</p> 

   <li><p>Let <var>task source</var> be <var>task</var>'s <a href=#task-source id=event-loop-processing-model:task-source-5>task
   source</a>.<li><p>Let <var>old stack</var> be a copy of the <a id=event-loop-processing-model:javascript-execution-context-stack href=https://tc39.github.io/ecma262/#execution-context-stack data-x-internal=javascript-execution-context-stack>JavaScript execution context
   stack</a>.<li><p>Empty the <a id=event-loop-processing-model:javascript-execution-context-stack-2 href=https://tc39.github.io/ecma262/#execution-context-stack data-x-internal=javascript-execution-context-stack>JavaScript execution context stack</a>.<li><p><a href=#perform-a-microtask-checkpoint id=event-loop-processing-model:perform-a-microtask-checkpoint-4>Perform a microtask checkpoint</a>.<li>

    <p>Stop <var>task</var>, allowing whatever algorithm that invoked it to resume, but
    continue these steps <a href=#in-parallel id=event-loop-processing-model:in-parallel-3>in parallel</a>.</p>

    <p class=note>This causes one of the following algorithms to continue: the <a href=#event-loop id=event-loop-processing-model:event-loop-25>event
    loop</a>'s main set of steps, the <a href=#perform-a-microtask-checkpoint id=event-loop-processing-model:perform-a-microtask-checkpoint-5>perform a microtask checkpoint</a> algorithm, or
    the <a href=#execute-a-compound-microtask-subtask id=event-loop-processing-model:execute-a-compound-microtask-subtask-2>execute a compound microtask subtask</a> algorithm.</p>

   <li><p>Wait until the condition <var>goal</var> is met.<li><p><a href=#queue-a-task id=event-loop-processing-model:queue-a-task>Queue a task</a> to continue running these steps, using the <a href=#task-source id=event-loop-processing-model:task-source-6>task
   source</a> <var>task source</var>. Wait until this new task runs before continuing
   these steps.<li><p>Replace the <a id=event-loop-processing-model:javascript-execution-context-stack-3 href=https://tc39.github.io/ecma262/#execution-context-stack data-x-internal=javascript-execution-context-stack>JavaScript execution context stack</a> with the <var>old
   stack</var>.<li><p>Return to the caller.</ol>

  <hr>

  <p>Some of the algorithms in this specification, for historical reasons, require the user agent to
  <dfn id=pause>pause</dfn> while running a <a href=#concept-task id=event-loop-processing-model:concept-task-11>task</a> until a condition <var>goal</var> is met. This means running the following steps:</p>

  <ol><li><p>If necessary, update the rendering or user interface of any <code id=event-loop-processing-model:document-26><a href=#document>Document</a></code> or
   <a href=#browsing-context id=event-loop-processing-model:browsing-context-3>browsing context</a> to reflect the current state.<li><p>Wait until the condition <var>goal</var> is met. While a user agent has a paused
   <a href=#concept-task id=event-loop-processing-model:concept-task-12>task</a>, the corresponding <a href=#event-loop id=event-loop-processing-model:event-loop-26>event loop</a> must not run
   further <a href=#concept-task id=event-loop-processing-model:concept-task-13>tasks</a>, and any script in the currently running <a href=#concept-task id=event-loop-processing-model:concept-task-14>task</a> must block. User agents should remain responsive to user input
   while paused, however, albeit in a reduced capacity since the <a href=#event-loop id=event-loop-processing-model:event-loop-27>event loop</a> will not be
   doing anything.</ol>

  <div class=warning>
   <p><a href=#pause id=event-loop-processing-model:pause>Pausing</a> is highly detrimental to the user experience, especially
   in scenarios where a single <a href=#event-loop id=event-loop-processing-model:event-loop-28>event loop</a> is shared among multiple documents. User
   agents are encouraged to experiment with alternatives to <a href=#pause id=event-loop-processing-model:pause-2>pausing</a>,
   such as <a href=#spin-the-event-loop id=event-loop-processing-model:spin-the-event-loop-3>spinning the event loop</a> or even simply
   proceeding without any kind of suspended execution at all, insofar as it is possible to do so
   while preserving compatibility with existing content. This specification will happily change if
   a less-drastic alternative is discovered to be web-compatible.</p>

   <p>In the interim, implementers should be aware that the variety of alternatives that user agents
   might experiment with can change subtle aspects of <a href=#event-loop id=event-loop-processing-model:event-loop-29>event loop</a> behavior, including
   <a href=#concept-task id=event-loop-processing-model:concept-task-15>task</a> and <a href=#microtask id=event-loop-processing-model:microtask-11>microtask</a> timing. Implementations should
   continue experimenting even if doing so causes them to violate the exact semantics implied by the
   <a href=#pause id=event-loop-processing-model:pause-3>pause</a> operation.</p>
  </div>

  <h5 id=generic-task-sources>8.1.4.3 Generic task sources<a href=#generic-task-sources class=self-link></a></h5>

  <p>The following <a href=#task-source id=generic-task-sources:task-source>task sources</a> are used by a number of mostly
  unrelated features in this and other specifications.</p>

  <dl><dt>The <dfn id=dom-manipulation-task-source data-dfn-type=dfn data-export="">DOM manipulation task source</dfn><dd>

    <p>This <a href=#task-source id=generic-task-sources:task-source-2>task source</a> is used for features that react to DOM manipulations, such as
    things that happen in a non-blocking fashion when an element is <a href=#insert-an-element-into-a-document id=generic-task-sources:insert-an-element-into-a-document>inserted into the document</a>.</p>

   <dt>The <dfn id=user-interaction-task-source data-export="">user interaction task source</dfn><dd>

    <p>This <a href=#task-source id=generic-task-sources:task-source-3>task source</a> is used for features that react to user interaction, for
    example keyboard or mouse input.</p>

    <p>Events sent in response to user input (e.g. <code id=generic-task-sources:event-click><a data-x-internal=event-click href=https://w3c.github.io/uievents/#event-type-click>click</a></code> events) must be fired using <a href=#concept-task id=generic-task-sources:concept-task>tasks</a> <a href=#queue-a-task id=generic-task-sources:queue-a-task>queued</a> with the <a href=#user-interaction-task-source id=generic-task-sources:user-interaction-task-source>user
    interaction task source</a>. <a href=#refsUIEVENTS>[UIEVENTS]</a></p> 

   <dt>The <dfn id=networking-task-source data-export="">networking task source</dfn><dd>

    <p>This <a href=#task-source id=generic-task-sources:task-source-4>task source</a> is used for features that trigger in response to network
    activity.</p>

   <dt>The <dfn id=history-traversal-task-source data-export="">history traversal task source</dfn><dd>

    <p>This <a href=#task-source id=generic-task-sources:task-source-5>task source</a> is used to queue calls to <code id=generic-task-sources:dom-history-back><a href=#dom-history-back>history.back()</a></code> and similar APIs.</p>

   </dl>

  



  <h4 id=events>8.1.5 Events<a href=#events class=self-link></a></h4>

  <h5 id=event-handler-attributes>8.1.5.1 Event handlers<a href=#event-handler-attributes class=self-link></a></h5>

  

  <p>Many objects can have <dfn id=event-handlers data-lt="event handler" data-export="">event handlers</dfn>
  specified. These act as non-capture event listeners for the object on which they are specified.
  <a href=#refsDOM>[DOM]</a></p>

  <p>An <a href=#event-handlers id=event-handler-attributes:event-handlers>event handler</a> has a name, which always starts with
  "<code>on</code>" and is followed by the name of the event for which it is intended.</p>

  <p>An <a href=#event-handlers id=event-handler-attributes:event-handlers-2>event handler</a> has a value, which is either null, or is
  a callback object, or is an <a href=#internal-raw-uncompiled-handler id=event-handler-attributes:internal-raw-uncompiled-handler>internal raw uncompiled handler</a>.
  The <code id=event-handler-attributes:eventhandler><a href=#eventhandler>EventHandler</a></code> callback function type describes how this is exposed to scripts.
  Initially, an <a href=#event-handlers id=event-handler-attributes:event-handlers-3>event handler</a>'s value must be set
  to null.</p>

  <p>Event handlers are exposed in one of two ways.</p>

  <p>The first way, common to all event handlers, is as an <a href=#event-handler-idl-attributes id=event-handler-attributes:event-handler-idl-attributes>event handler IDL attribute</a>.</p>

  <p>The second way is as an <a href=#event-handler-content-attributes id=event-handler-attributes:event-handler-content-attributes>event handler content
  attribute</a>. Event handlers on <a href=#html-elements id=event-handler-attributes:html-elements>HTML elements</a> and some of the event handlers on
  <code id=event-handler-attributes:window><a href=#window>Window</a></code> objects are exposed in this way.</p>

  

  <hr>

  <p>An <dfn id=event-handler-idl-attributes data-export="">event handler IDL attribute</dfn>
  is an IDL attribute for a specific <a href=#event-handlers id=event-handler-attributes:event-handlers-4>event handler</a>. The name of
  the IDL attribute is the same as the name of the <a href=#event-handlers id=event-handler-attributes:event-handlers-5>event
  handler</a>.</p>

  <p><a href=#event-handler-idl-attributes id=event-handler-attributes:event-handler-idl-attributes-2>Event handler IDL attributes</a>, on setting, must set the corresponding <a href=#event-handlers id=event-handler-attributes:event-handlers-6>event handler</a> to their new value, and on getting, must return the
  result of <a href=#getting-the-current-value-of-the-event-handler id=event-handler-attributes:getting-the-current-value-of-the-event-handler>getting the current value of the event handler</a> in question.</p>

  <p>If an <a href=#event-handler-idl-attributes id=event-handler-attributes:event-handler-idl-attributes-3>event handler IDL attribute</a> exposes an
  <a href=#event-handlers id=event-handler-attributes:event-handlers-7>event handler</a> of an object that doesn't exist, it must always
  return null on getting and must do nothing on setting.</p>

  <p class=note>This can happen in particular for <a href=#event-handler-idl-attributes id=event-handler-attributes:event-handler-idl-attributes-4>event
  handler IDL attribute</a> on <code id=event-handler-attributes:the-body-element><a href=#the-body-element>body</a></code> elements that do not have corresponding
  <code id=event-handler-attributes:window-2><a href=#window>Window</a></code> objects.</p>

  <p class=note>Certain event handler IDL attributes have additional requirements, in particular
  the <code id=event-handler-attributes:handler-messageport-onmessage><a href=#handler-messageport-onmessage>onmessage</a></code> attribute of
  <code id=event-handler-attributes:messageport><a href=#messageport>MessagePort</a></code> objects.</p>

  <hr>

  

  <p>An <dfn id=event-handler-content-attributes data-export="">event handler content
  attribute</dfn> is a content attribute for a specific <a href=#event-handlers id=event-handler-attributes:event-handlers-8>event
  handler</a>. The name of the content attribute is the same as the name of the <a href=#event-handlers id=event-handler-attributes:event-handlers-9>event handler</a>.</p>

  <p><a href=#event-handler-content-attributes id=event-handler-attributes:event-handler-content-attributes-2>Event handler content attributes</a>, when specified, must contain valid JavaScript
  code which, when parsed, would match the <i id=event-handler-attributes:js-prod-functionbody><a data-x-internal=js-prod-functionbody href=https://tc39.github.io/ecma262/#prod-FunctionBody>FunctionBody</a></i>
  production after <a id=event-handler-attributes:automatic-semicolon-insertion href=https://tc39.github.io/ecma262/#sec-automatic-semicolon-insertion data-x-internal=automatic-semicolon-insertion>automatic semicolon insertion</a>.</p>

  

  <p>When an <a href=#event-handler-content-attributes id=event-handler-attributes:event-handler-content-attributes-3>event handler content attribute</a>
  is set, execute the following steps:</p>

  <ol><li><p>If the <a id="event-handler-attributes:should-element's-inline-behavior-be-blocked-by-content-security-policy" href=https://w3c.github.io/webappsec-csp/#should-block-inline data-x-internal="should-element's-inline-behavior-be-blocked-by-content-security-policy">Should element's inline behavior be blocked by Content Security
   Policy?</a> algorithm returns "<code>Blocked</code>" when executed upon the
   attribute's <a id=event-handler-attributes:element href=https://dom.spec.whatwg.org/#interface-element data-x-internal=element>element</a>, "<code>script attribute</code>", and the attribute's
   value, then abort these steps. <a href=#refsCSP>[CSP]</a><li><p>Set the corresponding <a href=#event-handlers id=event-handler-attributes:event-handlers-10>event handler</a> to an
   <a href=#internal-raw-uncompiled-handler id=event-handler-attributes:internal-raw-uncompiled-handler-2>internal raw uncompiled handler</a> consisting of the attribute's new value and the
   script location where the attribute was set to this value</ol>

  <p>When an event handler content attribute is removed, the user agent must set the corresponding
  <a href=#event-handlers id=event-handler-attributes:event-handlers-11>event handler</a> to null.</p>
  

  <hr>

  <p>When an <a href=#event-handlers id=event-handler-attributes:event-handlers-12>event handler</a> <var>H</var> of an element
  or object <var>T</var> implementing the <code id=event-handler-attributes:eventtarget><a data-x-internal=eventtarget href=https://dom.spec.whatwg.org/#interface-eventtarget>EventTarget</a></code> interface is first set
  to a non-null value, the user agent must append an <a href=https://dom.spec.whatwg.org/#concept-event-listener id=event-handler-attributes:concept-event-listener data-x-internal=concept-event-listener>event
  listener</a> to the list of <a href=https://dom.spec.whatwg.org/#concept-event-listener id=event-handler-attributes:concept-event-listener-2 data-x-internal=concept-event-listener>event listeners</a>
  associated with <var>T</var> with <b>type</b> set to the <dfn id=event-handler-event-type data-export="">event handler event
  type</dfn> corresponding to <var>H</var> and <b>callback</b> set to <a href=#the-event-handler-processing-algorithm id=event-handler-attributes:the-event-handler-processing-algorithm>the event handler
  processing algorithm</a> defined below. <a href=#refsDOM>[DOM]</a></p>

  <p class=note>The <b>callback</b> is emphatically <em>not</em> the <a href=#event-handlers id=event-handler-attributes:event-handlers-13>event handler</a> itself. Every event handler ends up registering the same
  <b>callback</b>, the algorithm defined below, which takes care of invoking the right callback, and
  processing the callback's return value.</p>

  <p class=note>This only happens the first time the <a href=#event-handlers id=event-handler-attributes:event-handlers-14>event
  handler</a>'s value is set. Since listeners are called in the order they were registered, the
  order of event listeners for a particular event type will always be first the event listeners
  registered with <code id=event-handler-attributes:dom-eventtarget-addeventlistener><a data-x-internal=dom-eventtarget-addeventlistener href=https://dom.spec.whatwg.org/#dom-eventtarget-addeventlistener>addEventListener()</a></code> before
  the first time the <a href=#event-handlers id=event-handler-attributes:event-handlers-15>event handler</a> was set to a non-null value,
  then the callback to which it is currently set, if any, and finally the event listeners registered
  with <code id=event-handler-attributes:dom-eventtarget-addeventlistener-2><a data-x-internal=dom-eventtarget-addeventlistener href=https://dom.spec.whatwg.org/#dom-eventtarget-addeventlistener>addEventListener()</a></code> <em>after</em> the
  first time the <a href=#event-handlers id=event-handler-attributes:event-handlers-16>event handler</a> was set to a non-null value.</p>

  

  <div class=example>

   <p>This example demonstrates the order in which event listeners are invoked. If the button in
   this example is clicked by the user, the page will show four alerts, with the text "ONE", "TWO",
   "THREE", and "FOUR" respectively.</p>

   <pre>&lt;button id="test">Start Demo&lt;/button>
&lt;script>
 var button = document.getElementById('test');
 button.addEventListener('click', function () { alert('ONE') }, false);
 button.setAttribute('onclick', "alert('NOT CALLED')"); // event handler listener is registered here
 button.addEventListener('click', function () { alert('THREE') }, false);
 button.onclick = function () { alert('TWO'); };
 button.addEventListener('click', function () { alert('FOUR') }, false);
&lt;/script></pre>

  </div>

  

  <p class=note>The interfaces implemented by the event object do not influence whether an <a href=#event-handlers id=event-handler-attributes:event-handlers-17>event handler</a> is triggered or not.</p>

  <p><dfn id=the-event-handler-processing-algorithm>The event handler processing algorithm</dfn> for an <a href=#event-handlers id=event-handler-attributes:event-handlers-18>event
  handler</a> <var>H</var> and an <code id=event-handler-attributes:event><a data-x-internal=event href=https://dom.spec.whatwg.org/#interface-event>Event</a></code> object <var>E</var> is as
  follows:</p>

  <ol><li>

    <p>Let <var>callback</var> be the result of <a href=#getting-the-current-value-of-the-event-handler id=event-handler-attributes:getting-the-current-value-of-the-event-handler-2>getting the current value of the
    event handler</a> <var>H</var>.</p>

   <li><p>If <var>callback</var> is null, then abort these steps.<li>

    <p>Process the <code id=event-handler-attributes:event-2><a data-x-internal=event href=https://dom.spec.whatwg.org/#interface-event>Event</a></code> object <var>E</var> as follows:</p>

    <dl class=switch><dt>If <var>E</var> is an <code id=event-handler-attributes:errorevent><a href=#errorevent>ErrorEvent</a></code> object and the <a href=#event-handler-idl-attributes id=event-handler-attributes:event-handler-idl-attributes-5 data-export="">event handler IDL attribute</a>'s type is
     <code id=event-handler-attributes:onerroreventhandler><a href=#onerroreventhandler>OnErrorEventHandler</a></code><dd>

      <p><a href=#concept-invoke-event-handler id=event-handler-attributes:concept-invoke-event-handler>Invoke</a> <var>callback</var> with five
      arguments, the first one having the value of <var>E</var>'s <code id=event-handler-attributes:dom-errorevent-message><a href=#dom-errorevent-message>message</a></code> attribute, the second having the value of
      <var>E</var>'s <code id=event-handler-attributes:dom-errorevent-filename><a href=#dom-errorevent-filename>filename</a></code> attribute, the third
      having the value of <var>E</var>'s <code id=event-handler-attributes:dom-errorevent-lineno><a href=#dom-errorevent-lineno>lineno</a></code>
      attribute, the fourth having the value of <var>E</var>'s <code id=event-handler-attributes:dom-errorevent-colno><a href=#dom-errorevent-colno>colno</a></code> attribute, the fifth having the value of
      <var>E</var>'s <code id=event-handler-attributes:dom-errorevent-error><a href=#dom-errorevent-error>error</a></code> attribute, and with the <i id=event-handler-attributes:dfn-callback-this-value><a data-x-internal=dfn-callback-this-value href=https://heycam.github.io/webidl/#dfn-callback-this-value>callback this value</a></i> set to <var>E</var>'s <code id=event-handler-attributes:dom-event-currenttarget><a data-x-internal=dom-event-currenttarget href=https://dom.spec.whatwg.org/#dom-event-currenttarget>currentTarget</a></code>. Let <var>return value</var> be the
      callback's return value. <a href=#refsWEBIDL>[WEBIDL]</a></p>

     <dt>Otherwise<dd>

      <p><a href=#concept-invoke-event-handler id=event-handler-attributes:concept-invoke-event-handler-2>Invoke</a> <var>callback</var>
      with one argument, the value of which is the <code id=event-handler-attributes:event-3><a data-x-internal=event href=https://dom.spec.whatwg.org/#interface-event>Event</a></code> object <var>E</var>,
      with the <i id=event-handler-attributes:dfn-callback-this-value-2><a data-x-internal=dfn-callback-this-value href=https://heycam.github.io/webidl/#dfn-callback-this-value>callback this value</a></i> set to <var>E</var>'s <code id=event-handler-attributes:dom-event-currenttarget-2><a data-x-internal=dom-event-currenttarget href=https://dom.spec.whatwg.org/#dom-event-currenttarget>currentTarget</a></code>. Let <var>return value</var> be the callback's return value. <a href=#refsWEBIDL>[WEBIDL]</a></p>

     </dl>

    <p>In this step, <dfn id=concept-invoke-event-handler>invoke</dfn> means to <a href=https://heycam.github.io/webidl/#es-invoking-callback-functions id=event-handler-attributes:es-invoking-callback-functions data-x-internal=es-invoking-callback-functions>invoke the Web IDL callback function</a>.</p>

    <p>If an exception gets thrown by the callback, end these steps and allow the exception to
    propagate. (It will propagate to the <a href=https://dom.spec.whatwg.org/#concept-event-dispatch id=event-handler-attributes:concept-event-dispatch data-x-internal=concept-event-dispatch>DOM event dispatch
    logic</a>, which will then <a href=#report-the-exception id=event-handler-attributes:report-the-exception>report the exception</a>.)</p>

   <li>

    <p>Process <var>return value</var> as follows:</p>

    <dl class=switch><dt>If the event type is <code id=event-handler-attributes:event-mouseover><a data-x-internal=event-mouseover href=https://w3c.github.io/uievents/#event-type-mouseover>mouseover</a></code><dt>If the event type is <code id=event-handler-attributes:event-error><a href=#event-error>error</a></code> and <var>E</var> is an <code id=event-handler-attributes:errorevent-2><a href=#errorevent>ErrorEvent</a></code> object<dd><p>If <var>return value</var> is a Web IDL boolean true value, then cancel the event.<dt>If the event type is <code id=event-handler-attributes:event-beforeunload><a href=#event-beforeunload>beforeunload</a></code><dd>

      <p class=note>The <a href=#event-handler-idl-attributes id=event-handler-attributes:event-handler-idl-attributes-6>event handler IDL
      attribute</a>'s type is <code id=event-handler-attributes:onbeforeunloadeventhandler><a href=#onbeforeunloadeventhandler>OnBeforeUnloadEventHandler</a></code>, and the <var>return value</var> will therefore have been coerced into either the value null or a
      DOMString.</p>

      <p>If the <var>return value</var> is null, then cancel the event.</p>

      <p>Otherwise, If the <code id=event-handler-attributes:event-4><a data-x-internal=event href=https://dom.spec.whatwg.org/#interface-event>Event</a></code> object <var>E</var> is a
      <code id=event-handler-attributes:beforeunloadevent><a href=#beforeunloadevent>BeforeUnloadEvent</a></code> object, and the <code id=event-handler-attributes:event-5><a data-x-internal=event href=https://dom.spec.whatwg.org/#interface-event>Event</a></code> object <var>E</var>'s <code id=event-handler-attributes:dom-beforeunloadevent-returnvalue><a href=#dom-beforeunloadevent-returnvalue>returnValue</a></code>
      attribute's value is the empty string, then set the <code id=event-handler-attributes:dom-beforeunloadevent-returnvalue-2><a href=#dom-beforeunloadevent-returnvalue>returnValue</a></code> attribute's value to <var>return value</var>.</p>

     <dt>Otherwise<dd><p>If <var>return value</var> is a Web IDL boolean false value, then cancel the
     event.</dl>

   </ol>

  

  <hr>

  <p>The <code id=event-handler-attributes:eventhandler-2><a href=#eventhandler>EventHandler</a></code> callback function type represents a callback used for event
  handlers. It is represented in Web IDL as follows:</p>

  <pre class=idl>[TreatNonObjectAsNull]
callback <dfn id=eventhandlernonnull>EventHandlerNonNull</dfn> = any (<a id=event-handler-attributes:event-6 href=https://dom.spec.whatwg.org/#interface-event data-x-internal=event>Event</a> event);
typedef <a href=#eventhandlernonnull id=event-handler-attributes:eventhandlernonnull>EventHandlerNonNull</a>? <dfn id=eventhandler>EventHandler</dfn>;</pre>

  <p class=note>In JavaScript, any <code id=event-handler-attributes:idl-function><a data-x-internal=idl-function href=https://heycam.github.io/webidl/#common-Function>Function</a></code> object implements
  this interface.</p>

  <div class=example>

   <p>For example, the following document fragment:</p>

   <pre>&lt;body onload="alert(this)" onclick="alert(this)"></pre>

   <p>...leads to an alert saying "<code>[objectWindow]</code>" when the document is
   loaded, and an alert saying "<code>[objectHTMLBodyElement]</code>" whenever the
   user clicks something in the page.</p>

  </div>

  <p class=note>The return value of the function affects whether the event is canceled or not:
  as described above, if the return value is false, the event is canceled
  (except for <code id=event-handler-attributes:event-mouseover-2><a data-x-internal=event-mouseover href=https://w3c.github.io/uievents/#event-type-mouseover>mouseover</a></code> events, where the return value has to
  be true to cancel the event). With <code id=event-handler-attributes:event-beforeunload-2><a href=#event-beforeunload>beforeunload</a></code> events,
  the value is instead used to determine whether or not to prompt about unloading the document.</p>

  <p>For historical reasons, the <code id=event-handler-attributes:handler-onerror><a href=#handler-onerror>onerror</a></code> handler has different
  arguments:</p>

  <pre class=idl>[TreatNonObjectAsNull]
callback <dfn id=onerroreventhandlernonnull>OnErrorEventHandlerNonNull</dfn> = any ((<a id=event-handler-attributes:event-7 href=https://dom.spec.whatwg.org/#interface-event data-x-internal=event>Event</a> or DOMString) event, optional DOMString source, optional unsigned long lineno, optional unsigned long colno, optional any error);
typedef <a href=#onerroreventhandlernonnull id=event-handler-attributes:onerroreventhandlernonnull>OnErrorEventHandlerNonNull</a>? <dfn id=onerroreventhandler>OnErrorEventHandler</dfn>;</pre>

  <p>Similarly, the <code id=event-handler-attributes:handler-window-onbeforeunload><a href=#handler-window-onbeforeunload>onbeforeunload</a></code> handler has a
  different return value:</p>

  <pre class=idl>[TreatNonObjectAsNull]
callback <dfn id=onbeforeunloadeventhandlernonnull>OnBeforeUnloadEventHandlerNonNull</dfn> = DOMString? (<a id=event-handler-attributes:event-8 href=https://dom.spec.whatwg.org/#interface-event data-x-internal=event>Event</a> event);
typedef <a href=#onbeforeunloadeventhandlernonnull id=event-handler-attributes:onbeforeunloadeventhandlernonnull>OnBeforeUnloadEventHandlerNonNull</a>? <dfn id=onbeforeunloadeventhandler>OnBeforeUnloadEventHandler</dfn>;</pre>

  

  

  <hr>

  <p>An <dfn id=internal-raw-uncompiled-handler>internal raw uncompiled handler</dfn> is a tuple with the following information:</p>

  <ul class=brief><li>An uncompiled script body

   <li>A location where the script body originated, in case an error needs to be reported

  </ul>

  <p>When the user agent is to <dfn id=getting-the-current-value-of-the-event-handler>get the
  current value of the event handler</dfn> <var>H</var>, it must run these steps:</p>

  <ol><li>

    <p>If <var>H</var>'s value is an <a href=#internal-raw-uncompiled-handler id=event-handler-attributes:internal-raw-uncompiled-handler-3>internal raw uncompiled handler</a>, run these
    substeps:</p>

    <ol><li>

      <p>If <var>H</var> is an element's <a href=#event-handlers id=event-handler-attributes:event-handlers-19>event
      handler</a>, then let <var>element</var> be the element, and <var>document</var> be the element's <a id=event-handler-attributes:node-document href=https://dom.spec.whatwg.org/#concept-node-document data-x-internal=node-document>node document</a>.</p>

      <p>Otherwise, <var>H</var> is a <code id=event-handler-attributes:window-3><a href=#window>Window</a></code> object's <a href=#event-handlers id=event-handler-attributes:event-handlers-20>event handler</a>: let <var>element</var> be null, and let <var>document</var> be the <code id=event-handler-attributes:document><a href=#document>Document</a></code> most recently associated with that
      <code id=event-handler-attributes:window-4><a href=#window>Window</a></code> object.</p>

     <li><p>If <a href=#concept-n-noscript id=event-handler-attributes:concept-n-noscript>scripting is disabled</a> for
     <var>document</var>, then return null.<li><p>Let <var>body</var> be the uncompiled script body in the <a href=#internal-raw-uncompiled-handler id=event-handler-attributes:internal-raw-uncompiled-handler-4>internal raw
     uncompiled handler</a>.<li><p>Let <var>location</var> be the location where the script body originated, as
     given by the <a href=#internal-raw-uncompiled-handler id=event-handler-attributes:internal-raw-uncompiled-handler-5>internal raw uncompiled handler</a>.<li><p>If <var>element</var> is not null and <var>element</var> has a
     <a href=#form-owner id=event-handler-attributes:form-owner>form owner</a>, let <var>form owner</var> be that <a href=#form-owner id=event-handler-attributes:form-owner-2>form owner</a>.
     Otherwise, let <var>form owner</var> be null.<li><p>Let <var>settings object</var> be the <a href=#relevant-settings-object id=event-handler-attributes:relevant-settings-object>relevant settings object</a> of
     <var>document</var>.<li>

      <p>If <var>body</var> is not parsable as <i id=event-handler-attributes:js-prod-functionbody-2><a data-x-internal=js-prod-functionbody href=https://tc39.github.io/ecma262/#prod-FunctionBody>FunctionBody</a></i>
      or if parsing detects an <a id=event-handler-attributes:early-error href=https://tc39.github.io/ecma262/#early-error-rule data-x-internal=early-error>early error</a>, then follow these substeps:</p>

      <ol><li><p>Set <var>H</var>'s value to null.<li><p><a href=#report-the-error id=event-handler-attributes:report-the-error>Report the error</a> for the appropriate <a href=#concept-script id=event-handler-attributes:concept-script>script</a> and with the appropriate position (line number and
       column number) given by <var>location</var>, using <var>settings object</var>'s <a href=#concept-settings-object-global id=event-handler-attributes:concept-settings-object-global>global object</a>. If the error is still <i id=event-handler-attributes:concept-error-nothandled><a href=#concept-error-nothandled>not handled</a></i> after this, then the error may be reported
       to a developer console.<li><p>Return null.</ol>

     <li>

      <p>If <var>body</var> begins with a <a id=event-handler-attributes:directive-prologue href=https://tc39.github.io/ecma262/#directive-prologue data-x-internal=directive-prologue>Directive Prologue</a> that contains a <a id=event-handler-attributes:use-strict-directive href=https://tc39.github.io/ecma262/#use-strict-directive data-x-internal=use-strict-directive>Use
      Strict Directive</a> then let <var>strict</var> be true, otherwise let <var>strict</var>
      be false.</p> 

     <li><p>Push <var>settings object</var>'s <a href=#realm-execution-context id=event-handler-attributes:realm-execution-context>realm execution context</a> onto the
     <a id=event-handler-attributes:javascript-execution-context-stack href=https://tc39.github.io/ecma262/#execution-context-stack data-x-internal=javascript-execution-context-stack>JavaScript execution context stack</a>; it is now the <a id=event-handler-attributes:running-javascript-execution-context href=https://tc39.github.io/ecma262/#running-execution-context data-x-internal=running-javascript-execution-context>running JavaScript
     execution context</a>.<li>

      <p>Let <var>function</var> be the result of calling <a href=https://tc39.github.io/ecma262/#sec-functioncreate id=event-handler-attributes:js-functioncreate data-x-internal=js-functioncreate>FunctionCreate</a>, with arguments:</p>

      <dl><dt><var>kind</var><dd>Normal<dt><var>ParameterList</var><dd>

        <dl class=switch><dt>If <var>H</var> is an <code id=event-handler-attributes:handler-onerror-2><a href=#handler-onerror>onerror</a></code> <a href=#event-handlers id=event-handler-attributes:event-handlers-21>event handler</a> of a <code id=event-handler-attributes:window-5><a href=#window>Window</a></code> object<dd>Let the function have five arguments, named <code>event</code>, <code>source</code>, <code>lineno</code>, <code>colno</code>, and
         <code>error</code>.<dt>Otherwise<dd>Let the function have a single argument called <code>event</code>.</dl>

       <dt><var>Body</var><dd>The result of parsing <var>body</var> above.<dt><var>Scope</var><dd>

        <ol><li>

          <p>If <var>H</var> is an element's <a href=#event-handlers id=event-handler-attributes:event-handlers-22>event
          handler</a>, then let <var>Scope</var> be <a href=https://tc39.github.io/ecma262/#sec-newobjectenvironment id=event-handler-attributes:js-newobjectenvironment data-x-internal=js-newobjectenvironment>NewObjectEnvironment</a>(<var>document</var>,
          the <var>global environment</var>).</p>

          <p>Otherwise, <var>H</var> is a <code id=event-handler-attributes:window-6><a href=#window>Window</a></code> object's <a href=#event-handlers id=event-handler-attributes:event-handlers-23>event handler</a>: let <var>Scope</var> be the <var>global environment</var>.</p>

         <li><p>If <var>form owner</var> is not null, let <var>Scope</var> be
         <a href=https://tc39.github.io/ecma262/#sec-newobjectenvironment id=event-handler-attributes:js-newobjectenvironment-2 data-x-internal=js-newobjectenvironment>NewObjectEnvironment</a>(<var>form owner</var>,
         <var>Scope</var>).<li><p>If <var>element</var> is not null, let <var>Scope</var> be <a href=https://tc39.github.io/ecma262/#sec-newobjectenvironment id=event-handler-attributes:js-newobjectenvironment-3 data-x-internal=js-newobjectenvironment>NewObjectEnvironment</a>(<var>element</var>,
         <var>Scope</var>).</ol>

       <dt><var>Strict</var><dd>The value of <var>strict</var>.</dl>

     <li><p>Remove <var>settings object</var>'s <a href=#realm-execution-context id=event-handler-attributes:realm-execution-context-2>realm execution context</a> from the
     <a id=event-handler-attributes:javascript-execution-context-stack-2 href=https://tc39.github.io/ecma262/#execution-context-stack data-x-internal=javascript-execution-context-stack>JavaScript execution context stack</a>.<li><p>Set <var>H</var>'s value to <var>function</var>.</ol>

   <li><p>Return <var>H</var>'s value.</ol>

  



  <h5 id=event-handlers-on-elements,-document-objects,-and-window-objects>8.1.5.2 Event handlers on elements, <code id=event-handlers-on-elements,-document-objects,-and-window-objects:document><a href=#document>Document</a></code> objects, and <code id=event-handlers-on-elements,-document-objects,-and-window-objects:window><a href=#window>Window</a></code> objects<a href=#event-handlers-on-elements,-document-objects,-and-window-objects class=self-link></a></h5>

  <p>The following are the <a href=#event-handlers id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handlers>event handlers</a> (and their corresponding <a href=#event-handler-event-type id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-event-type>event handler event types</a>) that must be
  supported by all <a href=#html-elements id=event-handlers-on-elements,-document-objects,-and-window-objects:html-elements>HTML elements</a>, as both <a href=#event-handler-content-attributes id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-content-attributes>event handler content attributes</a>
  and <a href=#event-handler-idl-attributes id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-idl-attributes>event handler IDL attributes</a>; and that must be
  supported by all <code id=event-handlers-on-elements,-document-objects,-and-window-objects:document-2><a href=#document>Document</a></code> and <code id=event-handlers-on-elements,-document-objects,-and-window-objects:window-2><a href=#window>Window</a></code> objects, as <a href=#event-handler-idl-attributes id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-idl-attributes-2>event handler IDL
  attributes</a>:</p>

  <table><thead><tr><th><a href=#event-handlers id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handlers-2>Event handler</a> <th><a href=#event-handler-event-type id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-event-type-2>Event handler event type</a>
   <tbody><tr><td><dfn id=handler-onabort><code>onabort</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-abort><a href=#event-abort>abort</a></code>
    <tr><td><dfn id=handler-onauxclick><code>onauxclick</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-auxclick><a data-x-internal=event-auxclick href=https://wicg.github.io/auxclick/#the-auxclick-event>auxclick</a></code>
    <tr><td><dfn id=handler-oncancel><code>oncancel</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-cancel><a href=#event-cancel>cancel</a></code>
    <tr><td><dfn id=handler-oncanplay><code>oncanplay</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-media-canplay><a href=#event-media-canplay>canplay</a></code>
    <tr><td><dfn id=handler-oncanplaythrough><code>oncanplaythrough</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-media-canplaythrough><a href=#event-media-canplaythrough>canplaythrough</a></code>
    <tr><td><dfn id=handler-onchange><code>onchange</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-change><a href=#event-change>change</a></code> 
    <tr><td><dfn id=handler-onclick><code>onclick</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-click><a data-x-internal=event-click href=https://w3c.github.io/uievents/#event-type-click>click</a></code> 
    <tr><td><dfn id=handler-onclose><code>onclose</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-close><a href=#event-close>close</a></code> 
    <tr><td><dfn id=handler-oncontextmenu><code>oncontextmenu</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-contextmenu><a href=#event-contextmenu>contextmenu</a></code> 
    <tr><td><dfn id=handler-oncuechange><code>oncuechange</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-media-cuechange><a href=#event-media-cuechange>cuechange</a></code>
    <tr><td><dfn id=handler-ondblclick><code>ondblclick</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-dblclick><a data-x-internal=event-dblclick href=https://w3c.github.io/uievents/#event-type-dblclick>dblclick</a></code> 
    <tr><td><dfn id=handler-ondrag><code>ondrag</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-dnd-drag><a href=#event-dnd-drag>drag</a></code>
    <tr><td><dfn id=handler-ondragend><code>ondragend</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-dnd-dragend><a href=#event-dnd-dragend>dragend</a></code>
    <tr><td><dfn id=handler-ondragenter><code>ondragenter</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-dnd-dragenter><a href=#event-dnd-dragenter>dragenter</a></code>
    <tr><td><dfn id=handler-ondragexit><code>ondragexit</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-dnd-dragexit><a href=#event-dnd-dragexit>dragexit</a></code>
    <tr><td><dfn id=handler-ondragleave><code>ondragleave</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-dnd-dragleave><a href=#event-dnd-dragleave>dragleave</a></code>
    <tr><td><dfn id=handler-ondragover><code>ondragover</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-dnd-dragover><a href=#event-dnd-dragover>dragover</a></code>
    <tr><td><dfn id=handler-ondragstart><code>ondragstart</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-dnd-dragstart><a href=#event-dnd-dragstart>dragstart</a></code> 
    <tr><td><dfn id=handler-ondrop><code>ondrop</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-dnd-drop><a href=#event-dnd-drop>drop</a></code>
    <tr><td><dfn id=handler-ondurationchange><code>ondurationchange</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-media-durationchange><a href=#event-media-durationchange>durationchange</a></code>
    <tr><td><dfn id=handler-onemptied><code>onemptied</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-media-emptied><a href=#event-media-emptied>emptied</a></code>
    <tr><td><dfn id=handler-onended><code>onended</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-media-ended><a href=#event-media-ended>ended</a></code>
    <tr><td><dfn id=handler-oninput><code>oninput</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-input><a href=#event-input>input</a></code>
    <tr><td><dfn id=handler-oninvalid><code>oninvalid</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-invalid><a href=#event-invalid>invalid</a></code>
    <tr><td><dfn id=handler-onkeydown><code>onkeydown</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-keydown><a data-x-internal=event-keydown href=https://w3c.github.io/uievents/#event-type-keydown>keydown</a></code> 
    <tr><td><dfn id=handler-onkeypress><code>onkeypress</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-keypress><a data-x-internal=event-keypress href=https://w3c.github.io/uievents/#event-type-keypress>keypress</a></code> 
    <tr><td><dfn id=handler-onkeyup><code>onkeyup</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-keyup><a data-x-internal=event-keyup href=https://w3c.github.io/uievents/#event-type-keyup>keyup</a></code> 
    <tr><td><dfn id=handler-onloadeddata><code>onloadeddata</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-media-loadeddata><a href=#event-media-loadeddata>loadeddata</a></code>
    <tr><td><dfn id=handler-onloadedmetadata><code>onloadedmetadata</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-media-loadedmetadata><a href=#event-media-loadedmetadata>loadedmetadata</a></code>
    <tr><td><dfn id=handler-onloadend><code>onloadend</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-loadend><a href=#event-loadend>loadend</a></code>
    <tr><td><dfn id=handler-onloadstart><code>onloadstart</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-media-loadstart><a href=#event-media-loadstart>loadstart</a></code>
    <tr><td><dfn id=handler-onmousedown><code>onmousedown</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-mousedown><a data-x-internal=event-mousedown href=https://w3c.github.io/uievents/#event-type-mousedown>mousedown</a></code> 
    <tr><td><dfn id=handler-onmouseenter><code>onmouseenter</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-mouseenter><a data-x-internal=event-mouseenter href=https://w3c.github.io/uievents/#event-type-mouseenter>mouseenter</a></code> 
    <tr><td><dfn id=handler-onmouseleave><code>onmouseleave</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-mouseleave><a data-x-internal=event-mouseleave href=https://w3c.github.io/uievents/#event-type-mouseleave>mouseleave</a></code> 
    <tr><td><dfn id=handler-onmousemove><code>onmousemove</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-mousemove><a data-x-internal=event-mousemove href=https://w3c.github.io/uievents/#event-type-mousemove>mousemove</a></code> 
    <tr><td><dfn id=handler-onmouseout><code>onmouseout</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-mouseout><a data-x-internal=event-mouseout href=https://w3c.github.io/uievents/#event-type-mouseout>mouseout</a></code> 
    <tr><td><dfn id=handler-onmouseover><code>onmouseover</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-mouseover><a data-x-internal=event-mouseover href=https://w3c.github.io/uievents/#event-type-mouseover>mouseover</a></code> 
    <tr><td><dfn id=handler-onmouseup><code>onmouseup</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-mouseup><a data-x-internal=event-mouseup href=https://w3c.github.io/uievents/#event-type-mouseup>mouseup</a></code> 
    <tr><td><dfn id=handler-onwheel><code>onwheel</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-wheel><a data-x-internal=event-wheel href=https://w3c.github.io/uievents/#event-type-wheel>wheel</a></code> 
    <tr><td><dfn id=handler-onpause><code>onpause</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-media-pause><a href=#event-media-pause>pause</a></code>
    <tr><td><dfn id=handler-onplay><code>onplay</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-media-play><a href=#event-media-play>play</a></code>
    <tr><td><dfn id=handler-onplaying><code>onplaying</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-media-playing><a href=#event-media-playing>playing</a></code>
    <tr><td><dfn id=handler-onprogress><code>onprogress</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-media-progress><a href=#event-media-progress>progress</a></code>
    <tr><td><dfn id=handler-onratechange><code>onratechange</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-media-ratechange><a href=#event-media-ratechange>ratechange</a></code>
    <tr><td><dfn id=handler-onreset><code>onreset</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-reset><a href=#event-reset>reset</a></code>
    <tr><td><dfn id=handler-onseeked><code>onseeked</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-media-seeked><a href=#event-media-seeked>seeked</a></code>
    <tr><td><dfn id=handler-onseeking><code>onseeking</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-media-seeking><a href=#event-media-seeking>seeking</a></code>
    <tr><td><dfn id=handler-onselect><code>onselect</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-select><a href=#event-select>select</a></code>  
    <tr><td><dfn id=handler-onshow><code>onshow</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-show><a href=#event-show>show</a></code>
    <tr><td><dfn id=handler-onstalled><code>onstalled</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-media-stalled><a href=#event-media-stalled>stalled</a></code>
    <tr><td><dfn id=handler-onsubmit><code>onsubmit</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-submit><a href=#event-submit>submit</a></code> 
    <tr><td><dfn id=handler-onsuspend><code>onsuspend</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-media-suspend><a href=#event-media-suspend>suspend</a></code>
    <tr><td><dfn id=handler-ontimeupdate><code>ontimeupdate</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-media-timeupdate><a href=#event-media-timeupdate>timeupdate</a></code>
    <tr><td><dfn id=handler-ontoggle><code>ontoggle</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-toggle><a href=#event-toggle>toggle</a></code>
    <tr><td><dfn id=handler-onvolumechange><code>onvolumechange</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-media-volumechange><a href=#event-media-volumechange>volumechange</a></code>
    <tr><td><dfn id=handler-onwaiting><code>onwaiting</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-media-waiting><a href=#event-media-waiting>waiting</a></code>


 
 
 

 
  </table>

  <hr>

  <p>The following are the <a href=#event-handlers id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handlers-3>event handlers</a> (and their corresponding <a href=#event-handler-event-type id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-event-type-3>event handler event types</a>) that must be
  supported by all <a href=#html-elements id=event-handlers-on-elements,-document-objects,-and-window-objects:html-elements-2>HTML elements</a> other than <code id=event-handlers-on-elements,-document-objects,-and-window-objects:the-body-element><a href=#the-body-element>body</a></code> and <code id=event-handlers-on-elements,-document-objects,-and-window-objects:frameset><a href=#frameset>frameset</a></code>
  elements, as both <a href=#event-handler-content-attributes id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-content-attributes-2>event handler content attributes</a> and <a href=#event-handler-idl-attributes id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-idl-attributes-3>event handler IDL
  attributes</a>; that must be supported by all <code id=event-handlers-on-elements,-document-objects,-and-window-objects:document-3><a href=#document>Document</a></code>
  objects, as <a href=#event-handler-idl-attributes id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-idl-attributes-4>event handler IDL attributes</a>; and that must be
  supported by all <code id=event-handlers-on-elements,-document-objects,-and-window-objects:window-3><a href=#window>Window</a></code> objects, as <a href=#event-handler-idl-attributes id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-idl-attributes-5>event handler IDL attributes</a> on the
  <code id=event-handlers-on-elements,-document-objects,-and-window-objects:window-4><a href=#window>Window</a></code> objects themselves, and with corresponding <a href=#event-handler-content-attributes id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-content-attributes-3>event handler content
  attributes</a> and <a href=#event-handler-idl-attributes id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-idl-attributes-6>event handler IDL attributes</a> exposed on all <code id=event-handlers-on-elements,-document-objects,-and-window-objects:the-body-element-2><a href=#the-body-element>body</a></code>
  and <code id=event-handlers-on-elements,-document-objects,-and-window-objects:frameset-2><a href=#frameset>frameset</a></code> elements that are owned by that <code id=event-handlers-on-elements,-document-objects,-and-window-objects:window-5><a href=#window>Window</a></code> object's <a href=#concept-document-window id=event-handlers-on-elements,-document-objects,-and-window-objects:concept-document-window>associated <code>Document</code></a>:</p>

  <table><thead><tr><th><a href=#event-handlers id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handlers-4>Event handler</a> <th><a href=#event-handler-event-type id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-event-type-4>Event handler event type</a>
   <tbody><tr><td><dfn id=handler-onblur><code>onblur</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-blur><a href=#event-blur>blur</a></code> 
    <tr><td><dfn id=handler-onerror><code>onerror</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-error><a href=#event-error>error</a></code>
    <tr><td><dfn id=handler-onfocus><code>onfocus</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-focus><a href=#event-focus>focus</a></code> 
    <tr><td><dfn id=handler-onload><code>onload</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-load><a href=#event-load>load</a></code>
    <tr><td><dfn id=handler-onresize><code>onresize</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-resize><a data-x-internal=event-resize href=https://drafts.csswg.org/cssom-view/#eventdef-window-resize>resize</a></code>
    <tr><td><dfn id=handler-onscroll><code>onscroll</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-scroll><a data-x-internal=event-scroll href=https://drafts.csswg.org/cssom-view/#eventdef-document-scroll>scroll</a></code>
  </table>

  <hr>

  <p>The following are the <a href=#event-handlers id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handlers-5>event handlers</a> (and their corresponding <a href=#event-handler-event-type id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-event-type-5>event handler event types</a>) that must be
  supported by <code id=event-handlers-on-elements,-document-objects,-and-window-objects:window-6><a href=#window>Window</a></code> objects, as <a href=#event-handler-idl-attributes id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-idl-attributes-7>event handler IDL attributes</a> on the
  <code id=event-handlers-on-elements,-document-objects,-and-window-objects:window-7><a href=#window>Window</a></code> objects themselves, and with corresponding <a href=#event-handler-content-attributes id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-content-attributes-4>event handler content
  attributes</a> and <a href=#event-handler-idl-attributes id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-idl-attributes-8>event handler IDL attributes</a> exposed on all <code id=event-handlers-on-elements,-document-objects,-and-window-objects:the-body-element-3><a href=#the-body-element>body</a></code>
  and <code id=event-handlers-on-elements,-document-objects,-and-window-objects:frameset-3><a href=#frameset>frameset</a></code> elements that are owned by that <code id=event-handlers-on-elements,-document-objects,-and-window-objects:window-8><a href=#window>Window</a></code> object's <a href=#concept-document-window id=event-handlers-on-elements,-document-objects,-and-window-objects:concept-document-window-2>associated <code>Document</code></a>:</p>

  <table><thead><tr><th><a href=#event-handlers id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handlers-6>Event handler</a> <th><a href=#event-handler-event-type id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-event-type-6>Event handler event type</a>
   <tbody><tr><td><dfn id=handler-window-onafterprint><code>onafterprint</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-afterprint><a href=#event-afterprint>afterprint</a></code>
    <tr><td><dfn id=handler-window-onbeforeprint><code>onbeforeprint</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-beforeprint><a href=#event-beforeprint>beforeprint</a></code>
    <tr><td><dfn id=handler-window-onbeforeunload><code>onbeforeunload</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-beforeunload><a href=#event-beforeunload>beforeunload</a></code>
    <tr><td><dfn id=handler-window-onhashchange><code>onhashchange</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-hashchange><a href=#event-hashchange>hashchange</a></code> 
    <tr><td><dfn id=handler-window-onlanguagechange><code>onlanguagechange</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-languagechange><a href=#event-languagechange>languagechange</a></code> 
    <tr><td><dfn id=handler-window-onmessage><code>onmessage</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-message><a href=#event-message>message</a></code> 
    <tr><td><dfn id=handler-window-onoffline><code>onoffline</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-offline><a href=#event-offline>offline</a></code> 
    <tr><td><dfn id=handler-window-ononline><code>ononline</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-online><a href=#event-online>online</a></code> 
    <tr><td><dfn id=handler-window-onpagehide><code>onpagehide</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-pagehide><a href=#event-pagehide>pagehide</a></code> 
    <tr><td><dfn id=handler-window-onpageshow><code>onpageshow</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-pageshow><a href=#event-pageshow>pageshow</a></code> 
    <tr><td><dfn id=handler-window-onpopstate><code>onpopstate</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-popstate><a href=#event-popstate>popstate</a></code> 
    <tr><td><dfn id=handler-window-onrejectionhandled><code>onrejectionhandled</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-rejectionhandled><a href=#event-rejectionhandled>rejectionhandled</a></code>
    <tr><td><dfn id=handler-window-onstorage><code>onstorage</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-storage><a href=#event-storage>storage</a></code> 
    <tr><td><dfn id=handler-window-onunhandledrejection><code>onunhandledrejection</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-unhandledrejection><a href=#event-unhandledrejection>unhandledrejection</a></code>
    <tr><td><dfn id=handler-window-onunload><code>onunload</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-unload><a href=#event-unload>unload</a></code> 
  </table>

  <hr>

  

  <p>The following are the <a href=#event-handlers id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handlers-7>event handlers</a> (and their corresponding <a href=#event-handler-event-type id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-event-type-7>event handler event types</a>) that must be
  supported by all <a href=#html-elements id=event-handlers-on-elements,-document-objects,-and-window-objects:html-elements-3>HTML elements</a>, as both <a href=#event-handler-content-attributes id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-content-attributes-5>event handler content attributes</a>
  and <a href=#event-handler-idl-attributes id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-idl-attributes-9>event handler IDL attributes</a>; and that must be
  supported by all <code id=event-handlers-on-elements,-document-objects,-and-window-objects:document-4><a href=#document>Document</a></code> objects, as <a href=#event-handler-idl-attributes id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-idl-attributes-10>event handler IDL attributes</a>:</p>

  <table><thead><tr><th><a href=#event-handlers id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handlers-8>Event handler</a> <th><a href=#event-handler-event-type id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-event-type-8>Event handler event type</a>
   <tbody><tr><td><dfn id=handler-oncut><code>oncut</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-cut><a href=#event-cut>cut</a></code>
    <tr><td><dfn id=handler-oncopy><code>oncopy</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-copy><a href=#event-copy>copy</a></code>
    <tr><td><dfn id=handler-onpaste><code>onpaste</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-paste><a href=#event-paste>paste</a></code>
  </table>

  <p>The following are the <a href=#event-handlers id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handlers-9>event handlers</a> (and their corresponding <a href=#event-handler-event-type id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-event-type-9>event handler event types</a>) that must be
  supported on <code id=event-handlers-on-elements,-document-objects,-and-window-objects:document-5><a href=#document>Document</a></code> objects as <a href=#event-handler-idl-attributes id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-idl-attributes-11>event handler IDL attributes</a>:</p>

  <table><thead><tr><th><a href=#event-handlers id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handlers-10>Event handler</a> <th><a href=#event-handler-event-type id=event-handlers-on-elements,-document-objects,-and-window-objects:event-handler-event-type-10>Event handler event type</a>
   <tbody><tr><td><dfn id=handler-onreadystatechange><code>onreadystatechange</code></dfn> <td> <code id=event-handlers-on-elements,-document-objects,-and-window-objects:event-readystatechange><a href=#event-readystatechange>readystatechange</a></code>
  </table>


  <h6 id=idl-definitions>8.1.5.2.1 IDL definitions<a href=#idl-definitions class=self-link></a></h6>

  <pre class=idl>[NoInterfaceObject]
interface <dfn id=globaleventhandlers>GlobalEventHandlers</dfn> {
  attribute <a href=#eventhandler id=idl-definitions:eventhandler>EventHandler</a> <a href=#handler-onabort id=idl-definitions:handler-onabort>onabort</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-2>EventHandler</a> <a href=#handler-onauxclick id=idl-definitions:handler-onauxclick>onauxclick</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-3>EventHandler</a> <a href=#handler-onblur id=idl-definitions:handler-onblur>onblur</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-4>EventHandler</a> <a href=#handler-oncancel id=idl-definitions:handler-oncancel>oncancel</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-5>EventHandler</a> <a href=#handler-oncanplay id=idl-definitions:handler-oncanplay>oncanplay</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-6>EventHandler</a> <a href=#handler-oncanplaythrough id=idl-definitions:handler-oncanplaythrough>oncanplaythrough</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-7>EventHandler</a> <a href=#handler-onchange id=idl-definitions:handler-onchange>onchange</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-8>EventHandler</a> <a href=#handler-onclick id=idl-definitions:handler-onclick>onclick</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-9>EventHandler</a> <a href=#handler-onclose id=idl-definitions:handler-onclose>onclose</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-10>EventHandler</a> <a href=#handler-oncontextmenu id=idl-definitions:handler-oncontextmenu>oncontextmenu</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-11>EventHandler</a> <a href=#handler-oncuechange id=idl-definitions:handler-oncuechange>oncuechange</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-12>EventHandler</a> <a href=#handler-ondblclick id=idl-definitions:handler-ondblclick>ondblclick</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-13>EventHandler</a> <a href=#handler-ondrag id=idl-definitions:handler-ondrag>ondrag</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-14>EventHandler</a> <a href=#handler-ondragend id=idl-definitions:handler-ondragend>ondragend</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-15>EventHandler</a> <a href=#handler-ondragenter id=idl-definitions:handler-ondragenter>ondragenter</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-16>EventHandler</a> <a href=#handler-ondragexit id=idl-definitions:handler-ondragexit>ondragexit</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-17>EventHandler</a> <a href=#handler-ondragleave id=idl-definitions:handler-ondragleave>ondragleave</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-18>EventHandler</a> <a href=#handler-ondragover id=idl-definitions:handler-ondragover>ondragover</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-19>EventHandler</a> <a href=#handler-ondragstart id=idl-definitions:handler-ondragstart>ondragstart</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-20>EventHandler</a> <a href=#handler-ondrop id=idl-definitions:handler-ondrop>ondrop</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-21>EventHandler</a> <a href=#handler-ondurationchange id=idl-definitions:handler-ondurationchange>ondurationchange</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-22>EventHandler</a> <a href=#handler-onemptied id=idl-definitions:handler-onemptied>onemptied</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-23>EventHandler</a> <a href=#handler-onended id=idl-definitions:handler-onended>onended</a>;
  attribute <a href=#onerroreventhandler id=idl-definitions:onerroreventhandler>OnErrorEventHandler</a> <a href=#handler-onerror id=idl-definitions:handler-onerror>onerror</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-24>EventHandler</a> <a href=#handler-onfocus id=idl-definitions:handler-onfocus>onfocus</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-25>EventHandler</a> <a href=#handler-oninput id=idl-definitions:handler-oninput>oninput</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-26>EventHandler</a> <a href=#handler-oninvalid id=idl-definitions:handler-oninvalid>oninvalid</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-27>EventHandler</a> <a href=#handler-onkeydown id=idl-definitions:handler-onkeydown>onkeydown</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-28>EventHandler</a> <a href=#handler-onkeypress id=idl-definitions:handler-onkeypress>onkeypress</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-29>EventHandler</a> <a href=#handler-onkeyup id=idl-definitions:handler-onkeyup>onkeyup</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-30>EventHandler</a> <a href=#handler-onload id=idl-definitions:handler-onload>onload</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-31>EventHandler</a> <a href=#handler-onloadeddata id=idl-definitions:handler-onloadeddata>onloadeddata</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-32>EventHandler</a> <a href=#handler-onloadedmetadata id=idl-definitions:handler-onloadedmetadata>onloadedmetadata</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-33>EventHandler</a> <a href=#handler-onloadend id=idl-definitions:handler-onloadend>onloadend</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-34>EventHandler</a> <a href=#handler-onloadstart id=idl-definitions:handler-onloadstart>onloadstart</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-35>EventHandler</a> <a href=#handler-onmousedown id=idl-definitions:handler-onmousedown>onmousedown</a>;
  [LenientThis] attribute <a href=#eventhandler id=idl-definitions:eventhandler-36>EventHandler</a> <a href=#handler-onmouseenter id=idl-definitions:handler-onmouseenter>onmouseenter</a>;
  [LenientThis] attribute <a href=#eventhandler id=idl-definitions:eventhandler-37>EventHandler</a> <a href=#handler-onmouseleave id=idl-definitions:handler-onmouseleave>onmouseleave</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-38>EventHandler</a> <a href=#handler-onmousemove id=idl-definitions:handler-onmousemove>onmousemove</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-39>EventHandler</a> <a href=#handler-onmouseout id=idl-definitions:handler-onmouseout>onmouseout</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-40>EventHandler</a> <a href=#handler-onmouseover id=idl-definitions:handler-onmouseover>onmouseover</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-41>EventHandler</a> <a href=#handler-onmouseup id=idl-definitions:handler-onmouseup>onmouseup</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-42>EventHandler</a> <a href=#handler-onwheel id=idl-definitions:handler-onwheel>onwheel</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-43>EventHandler</a> <a href=#handler-onpause id=idl-definitions:handler-onpause>onpause</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-44>EventHandler</a> <a href=#handler-onplay id=idl-definitions:handler-onplay>onplay</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-45>EventHandler</a> <a href=#handler-onplaying id=idl-definitions:handler-onplaying>onplaying</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-46>EventHandler</a> <a href=#handler-onprogress id=idl-definitions:handler-onprogress>onprogress</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-47>EventHandler</a> <a href=#handler-onratechange id=idl-definitions:handler-onratechange>onratechange</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-48>EventHandler</a> <a href=#handler-onreset id=idl-definitions:handler-onreset>onreset</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-49>EventHandler</a> <a href=#handler-onresize id=idl-definitions:handler-onresize>onresize</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-50>EventHandler</a> <a href=#handler-onscroll id=idl-definitions:handler-onscroll>onscroll</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-51>EventHandler</a> <a href=#handler-onseeked id=idl-definitions:handler-onseeked>onseeked</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-52>EventHandler</a> <a href=#handler-onseeking id=idl-definitions:handler-onseeking>onseeking</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-53>EventHandler</a> <a href=#handler-onselect id=idl-definitions:handler-onselect>onselect</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-54>EventHandler</a> <a href=#handler-onshow id=idl-definitions:handler-onshow>onshow</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-55>EventHandler</a> <a href=#handler-onstalled id=idl-definitions:handler-onstalled>onstalled</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-56>EventHandler</a> <a href=#handler-onsubmit id=idl-definitions:handler-onsubmit>onsubmit</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-57>EventHandler</a> <a href=#handler-onsuspend id=idl-definitions:handler-onsuspend>onsuspend</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-58>EventHandler</a> <a href=#handler-ontimeupdate id=idl-definitions:handler-ontimeupdate>ontimeupdate</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-59>EventHandler</a> <a href=#handler-ontoggle id=idl-definitions:handler-ontoggle>ontoggle</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-60>EventHandler</a> <a href=#handler-onvolumechange id=idl-definitions:handler-onvolumechange>onvolumechange</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-61>EventHandler</a> <a href=#handler-onwaiting id=idl-definitions:handler-onwaiting>onwaiting</a>;
};

[NoInterfaceObject]
interface <dfn id=windoweventhandlers>WindowEventHandlers</dfn> {
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-62>EventHandler</a> <a href=#handler-window-onafterprint id=idl-definitions:handler-window-onafterprint>onafterprint</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-63>EventHandler</a> <a href=#handler-window-onbeforeprint id=idl-definitions:handler-window-onbeforeprint>onbeforeprint</a>;
  attribute <a href=#onbeforeunloadeventhandler id=idl-definitions:onbeforeunloadeventhandler>OnBeforeUnloadEventHandler</a> <a href=#handler-window-onbeforeunload id=idl-definitions:handler-window-onbeforeunload>onbeforeunload</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-64>EventHandler</a> <a href=#handler-window-onhashchange id=idl-definitions:handler-window-onhashchange>onhashchange</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-65>EventHandler</a> <a href=#handler-window-onlanguagechange id=idl-definitions:handler-window-onlanguagechange>onlanguagechange</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-66>EventHandler</a> <a href=#handler-window-onmessage id=idl-definitions:handler-window-onmessage>onmessage</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-67>EventHandler</a> <a href=#handler-window-onoffline id=idl-definitions:handler-window-onoffline>onoffline</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-68>EventHandler</a> <a href=#handler-window-ononline id=idl-definitions:handler-window-ononline>ononline</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-69>EventHandler</a> <a href=#handler-window-onpagehide id=idl-definitions:handler-window-onpagehide>onpagehide</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-70>EventHandler</a> <a href=#handler-window-onpageshow id=idl-definitions:handler-window-onpageshow>onpageshow</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-71>EventHandler</a> <a href=#handler-window-onpopstate id=idl-definitions:handler-window-onpopstate>onpopstate</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-72>EventHandler</a> <a href=#handler-window-onrejectionhandled id=idl-definitions:handler-window-onrejectionhandled>onrejectionhandled</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-73>EventHandler</a> <a href=#handler-window-onstorage id=idl-definitions:handler-window-onstorage>onstorage</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-74>EventHandler</a> <a href=#handler-window-onunhandledrejection id=idl-definitions:handler-window-onunhandledrejection>onunhandledrejection</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-75>EventHandler</a> <a href=#handler-window-onunload id=idl-definitions:handler-window-onunload>onunload</a>;
};

[NoInterfaceObject]
interface <dfn id=documentandelementeventhandlers>DocumentAndElementEventHandlers</dfn> {
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-76>EventHandler</a> <a href=#handler-oncopy id=idl-definitions:handler-oncopy>oncopy</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-77>EventHandler</a> <a href=#handler-oncut id=idl-definitions:handler-oncut>oncut</a>;
  attribute <a href=#eventhandler id=idl-definitions:eventhandler-78>EventHandler</a> <a href=#handler-onpaste id=idl-definitions:handler-onpaste>onpaste</a>;
};</pre>

  

  <h5 id=event-firing>8.1.5.3 Event firing<a href=#event-firing class=self-link></a></h5>

  <p>Certain operations and methods are defined as firing events on elements. For example, the <code id=event-firing:dom-click><a href=#dom-click>click()</a></code> method on the <code id=event-firing:htmlelement><a href=#htmlelement>HTMLElement</a></code> interface is defined as
  firing a <code id=event-firing:event-click><a data-x-internal=event-click href=https://w3c.github.io/uievents/#event-type-click>click</a></code> event on the element. <a href=#refsUIEVENTS>[UIEVENTS]</a></p>

  <p><dfn id=fire-a-synthetic-mouse-event>Firing a synthetic mouse event named
  <var>e</var></dfn> at <var>target</var>, with an optional <var>not trusted flag</var>, means
  running these steps:</p>

  <ol><li><p>Let <var>event</var> be the result of <a id=event-firing:creating-an-event href=https://dom.spec.whatwg.org/#concept-event-create data-x-internal=creating-an-event>creating an event</a> using
   <code id=event-firing:mouseevent><a data-x-internal=mouseevent href=https://w3c.github.io/uievents/#interface-MouseEvent>MouseEvent</a></code>.<li><p>Initialize <var>event</var>'s <code id=event-firing:dom-event-type><a data-x-internal=dom-event-type href=https://dom.spec.whatwg.org/#dom-event-type>type</a></code> attribute to
   <var>e</var>.<li><p>Initialize <var>event</var>'s <code id=event-firing:dom-event-bubbles><a data-x-internal=dom-event-bubbles href=https://dom.spec.whatwg.org/#dom-event-bubbles>bubbles</a></code> and <code id=event-firing:dom-event-cancelable><a data-x-internal=dom-event-cancelable href=https://dom.spec.whatwg.org/#dom-event-cancelable>cancelable</a></code> attributes to true.<li><p>If the <var>not trusted flag</var> is set, initialize <var>event</var>'s <code id=event-firing:dom-event-istrusted><a data-x-internal=dom-event-istrusted href=https://dom.spec.whatwg.org/#dom-event-istrusted>isTrusted</a></code> attribute to false.<li><p>Initialize <var>event</var>'s <code>ctrlKey</code>, <code>shiftKey</code>, <code>altKey</code>, and <code>metaKey</code>
   attributes according to the current state of the key input device, if any (false for any keys
   that are not available).<li><p>Initialize <var>event</var>'s <code id=event-firing:dom-uievent-view><a data-x-internal=dom-uievent-view href=https://w3c.github.io/uievents/#widl-UIEvent-view>view</a></code> attribute to
   <var>target</var>'s <a id=event-firing:node-document href=https://dom.spec.whatwg.org/#concept-node-document data-x-internal=node-document>node document</a>'s <code id=event-firing:window><a href=#window>Window</a></code> object, if any, and null
   otherwise.<li><p><var>event</var>'s <code>getModifierState()</code> method is to return values
   appropriately describing the current state of the key input device.<li><p>Return the result of <a href=https://dom.spec.whatwg.org/#concept-event-dispatch id=event-firing:concept-event-dispatch data-x-internal=concept-event-dispatch>dispatching</a>
   <var>event</var> at <var>target</var>.</ol>

  <p><dfn id=fire-a-click-event>Firing a <code>click</code> event</dfn>
  at <var>target</var> means <a href=#fire-a-synthetic-mouse-event id=event-firing:fire-a-synthetic-mouse-event>firing a synthetic mouse
  event named <code>click</code></a> at <var>target</var>.</p>

  


  <h3 id=windoworworkerglobalscope-mixin>8.2 The <code id=windoworworkerglobalscope-mixin:windoworworkerglobalscope><a href=#windoworworkerglobalscope>WindowOrWorkerGlobalScope</a></code> mixin<a href=#windoworworkerglobalscope-mixin class=self-link></a></h3>

  <p>The <code id=windoworworkerglobalscope-mixin:windoworworkerglobalscope-2><a href=#windoworworkerglobalscope>WindowOrWorkerGlobalScope</a></code> mixin is for use of APIs that are to be exposed on
  <code id=windoworworkerglobalscope-mixin:window><a href=#window>Window</a></code> and <code id=windoworworkerglobalscope-mixin:workerglobalscope><a href=#workerglobalscope>WorkerGlobalScope</a></code> objects.</p>

  <p class=note>Other standards are encouraged to further extend it using <code>partial
  interface <a href=#windoworworkerglobalscope id=windoworworkerglobalscope-mixin:windoworworkerglobalscope-3>WindowOrWorkerGlobalScope</a> {  };</code> along with an appropriate
  reference.</p>

  <pre class=idl>typedef (DOMString or <a href=https://heycam.github.io/webidl/#common-Function id=windoworworkerglobalscope-mixin:idl-function data-x-internal=idl-function>Function</a>) <dfn id=timerhandler>TimerHandler</dfn>;

[NoInterfaceObject, Exposed=(Window,Worker)]
interface <dfn id=windoworworkerglobalscope>WindowOrWorkerGlobalScope</dfn> {
  [Replaceable] readonly attribute USVString <a href=#dom-origin id=windoworworkerglobalscope-mixin:dom-origin>origin</a>;

  // base64 utility methods
  DOMString <a href=#dom-btoa id=windoworworkerglobalscope-mixin:dom-btoa>btoa</a>(DOMString data);
  DOMString <a href=#dom-atob id=windoworworkerglobalscope-mixin:dom-atob>atob</a>(DOMString data);

  // timers
  long <a href=#dom-settimeout id=windoworworkerglobalscope-mixin:dom-settimeout>setTimeout</a>(<a href=#timerhandler id=windoworworkerglobalscope-mixin:timerhandler>TimerHandler</a> handler, optional long timeout = 0, any... arguments);
  void <a href=#dom-cleartimeout id=windoworworkerglobalscope-mixin:dom-cleartimeout>clearTimeout</a>(optional long handle = 0);
  long <a href=#dom-setinterval id=windoworworkerglobalscope-mixin:dom-setinterval>setInterval</a>(<a href=#timerhandler id=windoworworkerglobalscope-mixin:timerhandler-2>TimerHandler</a> handler, optional long timeout = 0, any... arguments);
  void <a href=#dom-clearinterval id=windoworworkerglobalscope-mixin:dom-clearinterval>clearInterval</a>(optional long handle = 0);

  // ImageBitmap
  Promise&lt;<a href=#imagebitmap id=windoworworkerglobalscope-mixin:imagebitmap>ImageBitmap</a>> <a href=#dom-createimagebitmap id=windoworworkerglobalscope-mixin:dom-createimagebitmap>createImageBitmap</a>(<a href=#imagebitmapsource id=windoworworkerglobalscope-mixin:imagebitmapsource>ImageBitmapSource</a> image, optional <a href=#imagebitmapoptions id=windoworworkerglobalscope-mixin:imagebitmapoptions>ImageBitmapOptions</a> options);
  Promise&lt;<a href=#imagebitmap id=windoworworkerglobalscope-mixin:imagebitmap-2>ImageBitmap</a>> <a href=#dom-createimagebitmap id=windoworworkerglobalscope-mixin:dom-createimagebitmap-2>createImageBitmap</a>(<a href=#imagebitmapsource id=windoworworkerglobalscope-mixin:imagebitmapsource-2>ImageBitmapSource</a> image, long sx, long sy, long sw, long sh, optional <a href=#imagebitmapoptions id=windoworworkerglobalscope-mixin:imagebitmapoptions-2>ImageBitmapOptions</a> options);
};
<a href=#window id=windoworworkerglobalscope-mixin:window-2>Window</a> implements <a href=#windoworworkerglobalscope id=windoworworkerglobalscope-mixin:windoworworkerglobalscope-4>WindowOrWorkerGlobalScope</a>;
<a href=#workerglobalscope id=windoworworkerglobalscope-mixin:workerglobalscope-2>WorkerGlobalScope</a> implements <a href=#windoworworkerglobalscope id=windoworworkerglobalscope-mixin:windoworworkerglobalscope-5>WindowOrWorkerGlobalScope</a>;</pre>

  

  <dl class=domintro><dt><var>origin</var> = self . <code id=windoworworkerglobalscope-mixin:dom-origin-2><a href=#dom-origin>origin</a></code><dd><p>Returns the global object's <a href=#concept-origin id=windoworworkerglobalscope-mixin:concept-origin>origin</a>, serialized as string.</dl>

  <div class=example>
   <p>Developers are strongly encouraged to use <code>self.origin</code> over <code>location.origin</code>. The former returns the <a href=#concept-origin id=windoworworkerglobalscope-mixin:concept-origin-2>origin</a> of the environment,
   the latter of the URL of the environment. Imagine the following script executing in a document on
   <code>https://stargate.example/</code>:</p>

   <pre>var frame = document.createElement("iframe")
frame.onload = function() {
  var frameWin = frame.contentWindow
  console.log(frameWin.location.origin) // "null"
  console.log(frameWin.origin) // "https://stargate.example"
}
document.body.appendChild(frame)</pre>

   <p><code>self.origin</code> is a more reliable security indicator.</p>
  </div>

  <p>The <dfn id=dom-origin><code>origin</code></dfn> attribute's getter must return this
  object's <a href=#relevant-settings-object id=windoworworkerglobalscope-mixin:relevant-settings-object>relevant settings object</a>'s <a href=#concept-settings-object-origin id=windoworworkerglobalscope-mixin:concept-settings-object-origin>origin</a>, <a href=#unicode-serialisation-of-an-origin id=windoworworkerglobalscope-mixin:unicode-serialisation-of-an-origin>serialized</a>.</p>


  <h3 id=atob>8.3 Base64 utility methods<a href=#atob class=self-link></a></h3><div class=status><input onclick=toggleStatus(this) value= type=button><p class=support><strong>Support:</strong> atob-btoa<span class="and_chr yes"><span>Chrome for Android</span> <span>55+</span></span><span class="chrome yes"><span>Chrome</span> <span>4+</span></span><span class="ios_saf yes"><span>iOS Safari</span> <span>3.2+</span></span><span class="and_uc yes"><span>UC Browser for Android</span> <span>11+</span></span><span class="firefox yes"><span>Firefox</span> <span>2+</span></span><span class="ie yes"><span>IE</span> <span>10+</span></span><span class="samsung yes"><span>Samsung Internet</span> <span>4+</span></span><span class="op_mini yes"><span>Opera Mini</span> <span>all+</span></span><span class="android yes"><span>Android Browser</span> <span>2.1+</span></span><span class="safari yes"><span>Safari</span> <span>3.1+</span></span><span class="edge yes"><span>Edge</span> <span>12+</span></span><span class="opera yes"><span>Opera</span> <span>10.6+</span></span><p class=caniuse>Source: <a href="http://caniuse.com/#feat=atob-btoa">caniuse.com</a></div>

  <p>The <code id=atob:dom-atob><a href=#dom-atob>atob()</a></code> and <code id=atob:dom-btoa><a href=#dom-btoa>btoa()</a></code> methods
  allow developers to transform content to and from the base64 encoding.</p>

  <p class=note>In these APIs, for mnemonic purposes, the "b" can be considered to stand for
  "binary", and the "a" for "ASCII". In practice, though, for primarily historical reasons, both the
  input and output of these functions are Unicode strings.</p>

  <dl class=domintro><dt><var>result</var> = self . <code id=atob:dom-btoa-2><a href=#dom-btoa>btoa</a></code>( <var>data</var> )<dd>

    <p>Takes the input data, in the form of a Unicode string containing only characters in the range
    U+0000 to U+00FF, each representing a binary byte with values 0x00 to 0xFF respectively, and
    converts it to its base64 representation, which it returns.</p>

    <p>Throws an <a id=atob:invalidcharactererror href=https://heycam.github.io/webidl/#invalidcharactererror data-x-internal=invalidcharactererror>"<code>InvalidCharacterError</code>"</a> <code id=atob:domexception><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code>
    exception if the input string contains any out-of-range characters.</p>

   <dt><var>result</var> = self . <code id=atob:dom-atob-2><a href=#dom-atob>atob</a></code>( <var>data</var> )<dd>

    <p>Takes the input data, in the form of a Unicode string containing base64-encoded binary data,
    decodes it, and returns a string consisting of characters in the range U+0000 to U+00FF, each
    representing a binary byte with values 0x00 to 0xFF respectively, corresponding to that binary
    data.</p>

    <p>Throws an <a id=atob:invalidcharactererror-2 href=https://heycam.github.io/webidl/#invalidcharactererror data-x-internal=invalidcharactererror>"<code>InvalidCharacterError</code>"</a> <code id=atob:domexception-2><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> if the
    input string is not valid base64 data.</p>

   </dl>

  

  <p>The <dfn id=dom-btoa><code id=dom-windowbase64-btoa>btoa(<var>data</var>)</code></dfn>
  method must throw an <a id=atob:invalidcharactererror-3 href=https://heycam.github.io/webidl/#invalidcharactererror data-x-internal=invalidcharactererror>"<code>InvalidCharacterError</code>"</a> <code id=atob:domexception-3><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code>
  if <var>data</var> contains any character whose code point is greater than U+00FF. Otherwise, the
  user agent must convert <var>data</var> to a sequence of octets whose <var>n</var>th octet is the
  eight-bit representation of the code point of the <var>n</var>th character of <var>data</var>, and
  then must apply the base64 algorithm to that sequence of octets, and return the result. <a href=#refsRFC4648>[RFC4648]</a></p>
  


  <p>The <dfn id=dom-atob><code id=dom-windowbase64-atob>atob(<var>data</var>)</code></dfn>
  method, when invoked, must run the following steps:</p>

  <ol><li><p>Let <var>position</var> be a pointer into <var>data</var>, initially
   pointing at the start of the string.<li><p>Remove all <a href=#space-character id=atob:space-character>space characters</a> from
   <var>data</var>.<li><p>If the length of <var>data</var> divides by 4 leaving no remainder, then: if
   <var>data</var> ends with one or two U+003D EQUALS SIGN (=) characters, remove them from
   <var>data</var>.<li><p>If the length of <var>data</var> divides by 4 leaving a remainder of 1, throw an
   <a id=atob:invalidcharactererror-4 href=https://heycam.github.io/webidl/#invalidcharactererror data-x-internal=invalidcharactererror>"<code>InvalidCharacterError</code>"</a> <code id=atob:domexception-4><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these
   steps.</p>

   <li>

    <p>If <var>data</var> contains a character that is not in the following list of
    characters and character ranges, throw an <a id=atob:invalidcharactererror-5 href=https://heycam.github.io/webidl/#invalidcharactererror data-x-internal=invalidcharactererror>"<code>InvalidCharacterError</code>"</a>
    <code id=atob:domexception-5><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these steps:</p>

    <ul class=brief><li>U+002B PLUS SIGN (+)
     <li>U+002F SOLIDUS (/)
     <li><a href=#alphanumeric-ascii-characters id=atob:alphanumeric-ascii-characters>Alphanumeric ASCII characters</a>
    </ul>

   <li><p>Let <var>output</var> be a string, initially empty.<li><p>Let <var>buffer</var> be a buffer that can have bits appended to it, initially
   empty.<li>

    <p>While <var>position</var> does not point past the end of <var>data</var>, run these
    substeps:</p>

    <ol><li>

      <p>Find the character pointed to by <var>position</var> in the first column of the
      following table. Let <var>n</var> be the number given in the second cell of the same
      row.</p>

      <div id=base64-table>
       <table><thead><tr><th>Character
          <th>Number
        <tbody><tr><td>A<td>0
         <tr><td>B<td>1
         <tr><td>C<td>2
         <tr><td>D<td>3
         <tr><td>E<td>4
         <tr><td>F<td>5
         <tr><td>G<td>6
         <tr><td>H<td>7
         <tr><td>I<td>8
         <tr><td>J<td>9
         <tr><td>K<td>10
         <tr><td>L<td>11
         <tr><td>M<td>12
         <tr><td>N<td>13
         <tr><td>O<td>14
         <tr><td>P<td>15
         <tr><td>Q<td>16
         <tr><td>R<td>17
         <tr><td>S<td>18
         <tr><td>T<td>19
         <tr><td>U<td>20
         <tr><td>V<td>21
         <tr><td>W<td>22
         <tr><td>X<td>23
         <tr><td>Y<td>24
         <tr><td>Z<td>25
         <tr><td>a<td>26
         <tr><td>b<td>27
         <tr><td>c<td>28
         <tr><td>d<td>29
         <tr><td>e<td>30
         <tr><td>f<td>31
         <tr><td>g<td>32
         <tr><td>h<td>33
         <tr><td>i<td>34
         <tr><td>j<td>35
         <tr><td>k<td>36
         <tr><td>l<td>37
         <tr><td>m<td>38
         <tr><td>n<td>39
         <tr><td>o<td>40
         <tr><td>p<td>41
         <tr><td>q<td>42
         <tr><td>r<td>43
         <tr><td>s<td>44
         <tr><td>t<td>45
         <tr><td>u<td>46
         <tr><td>v<td>47
         <tr><td>w<td>48
         <tr><td>x<td>49
         <tr><td>y<td>50
         <tr><td>z<td>51
         <tr><td>0<td>52
         <tr><td>1<td>53
         <tr><td>2<td>54
         <tr><td>3<td>55
         <tr><td>4<td>56
         <tr><td>5<td>57
         <tr><td>6<td>58
         <tr><td>7<td>59
         <tr><td>8<td>60
         <tr><td>9<td>61
         <tr><td>+<td>62
         <tr><td>/<td>63
       </table>
      </div>

     <li><p>Append to <var>buffer</var> the six bits corresponding to <var>number</var>, most significant bit first.<li><p>If <var>buffer</var> has accumulated 24 bits, interpret them as three 8-bit
     big-endian numbers. Append the three characters with code points equal to those numbers to <var>output</var>, in the same order, and then empty <var>buffer</var>.<li><p>Advance <var>position</var> by one character.</ol>

   <li>

    <p>If <var>buffer</var> is not empty, it contains either 12 or 18 bits. If it contains
    12 bits, discard the last four and interpret the remaining eight as an 8-bit big-endian number.
    If it contains 18 bits, discard the last two and interpret the remaining 16 as two 8-bit
    big-endian numbers. Append the one or two characters with code points equal to those one or two
    numbers to <var>output</var>, in the same order.</p>

    <p class=note>The discarded bits mean that, for instance, <code>atob("YQ")</code> and
    <code>atob("YR")</code> both return "<code>a</code>".</p>

   <li><p>Return <var>output</var>.</ol>

  

  



  <h3 id=dynamic-markup-insertion>8.4 <dfn>Dynamic markup insertion</dfn><a href=#dynamic-markup-insertion class=self-link></a></h3>

  <p class=note>APIs for dynamically inserting markup into the document interact with the parser,
  and thus their behavior varies depending on whether they are used with <a id=dynamic-markup-insertion:html-documents href=https://dom.spec.whatwg.org/#html-document data-x-internal=html-documents>HTML
  documents</a> (and the <a href=#html-parser id=dynamic-markup-insertion:html-parser>HTML parser</a>) or <a id=dynamic-markup-insertion:xml-documents href=https://dom.spec.whatwg.org/#xml-document data-x-internal=xml-documents>XML documents</a> (and the
  <a href=#xml-parser id=dynamic-markup-insertion:xml-parser>XML parser</a>).</p>

  

  <p><code id=dynamic-markup-insertion:document><a href=#document>Document</a></code> objects have a <dfn id=throw-on-dynamic-markup-insertion-counter>throw-on-dynamic-markup-insertion counter</dfn>,
  which is used in conjunction with the <a href=#create-an-element-for-the-token id=dynamic-markup-insertion:create-an-element-for-the-token>create an element for the token</a> algorithm to
  prevent <a href=#custom-element-constructor id=dynamic-markup-insertion:custom-element-constructor>custom element constructors</a> from being
  able to use <code id=dynamic-markup-insertion:dom-document-open><a href=#dom-document-open>document.open()</a></code>, <code id=dynamic-markup-insertion:dom-document-close><a href=#dom-document-close>document.close()</a></code>, and <code id=dynamic-markup-insertion:dom-document-write><a href=#dom-document-write>document.write()</a></code> when they are invoked by the parser.
  Initially, the counter must be set to zero.</p>

  



  <h4 id=opening-the-input-stream>8.4.1 Opening the input stream<a href=#opening-the-input-stream class=self-link></a></h4>

  <p>The <dfn id=dom-document-open><code>open()</code></dfn> method comes in several variants
  with different numbers of arguments.</p>

  <dl class=domintro><dt><var>document</var> = <var>document</var> . <code id=opening-the-input-stream:dom-document-open><a href=#dom-document-open>open</a></code>( [ <var>type</var> [, <var>replace</var> ] ] )<dd>

    <p>Causes the <code id=opening-the-input-stream:document><a href=#document>Document</a></code> to be replaced in-place, as if it was a new
    <code id=opening-the-input-stream:document-2><a href=#document>Document</a></code> object, but reusing the previous object, which is then returned.</p>

    <p>If the <var>type</var> argument is omitted or has the value
    "<code id=opening-the-input-stream:text/html><a href=#text/html>text/html</a></code>", then the resulting <code id=opening-the-input-stream:document-3><a href=#document>Document</a></code> has an HTML parser associated
    with it, which can be given data to parse using <code id=opening-the-input-stream:dom-document-write><a href=#dom-document-write>document.write()</a></code>. Otherwise, all content passed to <code id=opening-the-input-stream:dom-document-write-2><a href=#dom-document-write>document.write()</a></code> will be parsed as plain text.</p>

    <p>If the <var>replace</var> argument is present and has the value "<code>replace</code>", the existing entries in the session history for the
    <code id=opening-the-input-stream:document-4><a href=#document>Document</a></code> object are removed.</p>

    <p>The method has no effect if the <code id=opening-the-input-stream:document-5><a href=#document>Document</a></code> is still being parsed.</p>

    <p>Throws an <a id=opening-the-input-stream:invalidstateerror href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a> <code id=opening-the-input-stream:domexception><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> if the
    <code id=opening-the-input-stream:document-6><a href=#document>Document</a></code> is an <a href=https://dom.spec.whatwg.org/#xml-document id=opening-the-input-stream:xml-documents data-x-internal=xml-documents>XML document</a>.</p>

    <p>Throws an <a id=opening-the-input-stream:invalidstateerror-2 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a> <code id=opening-the-input-stream:domexception-2><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> if the
    parser is currently executing a <a href=#custom-element-constructor id=opening-the-input-stream:custom-element-constructor>custom element constructor</a>.</p>

   <dt><var>window</var> = <var>document</var> . <code id=opening-the-input-stream:dom-document-open-2><a href=#dom-document-open>open</a></code>( <var>url</var>, <var>name</var>, <var>features</var> )<dd>

    <p>Works like the <code id=opening-the-input-stream:dom-open><a href=#dom-open>window.open()</a></code> method.</p>

   </dl>

  

  <p><code id=opening-the-input-stream:document-7><a href=#document>Document</a></code> objects have an <dfn id=ignore-opens-during-unload-counter>ignore-opens-during-unload counter</dfn>, which is
  used to prevent scripts from invoking the <code id=opening-the-input-stream:dom-document-open-3><a href=#dom-document-open>document.open()</a></code>
  method (directly or indirectly) while the document is <a href=#unload-a-document id=opening-the-input-stream:unload-a-document>being
  unloaded</a>. Initially, the counter must be set to zero.</p> 

  <p>When called with two arguments (or fewer), the <code id=opening-the-input-stream:dom-document-open-4><a href=#dom-document-open>document.open()</a></code>
  method must act as follows:</p>

  <ol><li><p>If the <code id=opening-the-input-stream:document-8><a href=#document>Document</a></code> object is an <a href=https://dom.spec.whatwg.org/#xml-document id=opening-the-input-stream:xml-documents-2 data-x-internal=xml-documents>XML
   document</a>, then throw an <a id=opening-the-input-stream:invalidstateerror-3 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a>
   <code id=opening-the-input-stream:domexception-3><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these steps.<li><p>If the <code id=opening-the-input-stream:document-9><a href=#document>Document</a></code> object's <a href=#throw-on-dynamic-markup-insertion-counter id=opening-the-input-stream:throw-on-dynamic-markup-insertion-counter>throw-on-dynamic-markup-insertion
   counter</a> is greater than zero, then throw an <a id=opening-the-input-stream:invalidstateerror-4 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a>
   <code id=opening-the-input-stream:domexception-4><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these steps.<li><p>If the <code id=opening-the-input-stream:document-10><a href=#document>Document</a></code> object is not an <a href=#active-document id=opening-the-input-stream:active-document>active document</a>, then abort
   these steps.<li><p>If the <a href=#concept-origin id=opening-the-input-stream:concept-origin>origin</a> of the <code id=opening-the-input-stream:document-11><a href=#document>Document</a></code> is not equal to the
   <a href=#concept-origin id=opening-the-input-stream:concept-origin-2>origin</a> of the <a href=#responsible-document id=opening-the-input-stream:responsible-document>responsible document</a> specified by the <a href=#entry-settings-object id=opening-the-input-stream:entry-settings-object>entry
   settings object</a>, throw a <a id=opening-the-input-stream:securityerror href=https://heycam.github.io/webidl/#securityerror data-x-internal=securityerror>"<code>SecurityError</code>"</a>
   <code id=opening-the-input-stream:domexception-5><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these steps.<li>

    <p>If the <code id=opening-the-input-stream:document-12><a href=#document>Document</a></code> has an <a href=#active-parser id=opening-the-input-stream:active-parser>active parser</a> whose <a href=#script-nesting-level id=opening-the-input-stream:script-nesting-level>script nesting
    level</a> is greater than zero, then the method does nothing. Abort these steps and return
    the <code id=opening-the-input-stream:document-13><a href=#document>Document</a></code> object on which the method was invoked.</p>

    <p class=note>This basically causes <code id=opening-the-input-stream:dom-document-open-5><a href=#dom-document-open>document.open()</a></code> to
    be ignored when it's called in an inline script found during parsing, while still letting it
    have an effect when called from a non-parser task such as a timer callback or event handler.</p>

   <li>

    <p>Similarly, if the <code id=opening-the-input-stream:document-14><a href=#document>Document</a></code>'s <a href=#ignore-opens-during-unload-counter id=opening-the-input-stream:ignore-opens-during-unload-counter>ignore-opens-during-unload counter</a> is
    greater than zero, then the method does nothing. Abort these steps and return the
    <code id=opening-the-input-stream:document-15><a href=#document>Document</a></code> object on which the method was invoked.</p>

    <p class=note>This basically causes <code id=opening-the-input-stream:dom-document-open-6><a href=#dom-document-open>document.open()</a></code> to
    be ignored when it's called from a <code id=opening-the-input-stream:event-beforeunload><a href=#event-beforeunload>beforeunload</a></code> <code id=opening-the-input-stream:event-pagehide><a href=#event-pagehide>pagehide</a></code>, or <code id=opening-the-input-stream:event-unload><a href=#event-unload>unload</a></code> event
    handler while the <code id=opening-the-input-stream:document-16><a href=#document>Document</a></code> is being unloaded.</p>

   <li><p>Let <var>type</var> be the value of the first argument.<li>

    <p>If the second argument is an <a id=opening-the-input-stream:ascii-case-insensitive href=https://infra.spec.whatwg.org/#ascii-case-insensitive data-x-internal=ascii-case-insensitive>ASCII case-insensitive</a> match for the value
    "replace", then let <var>replace</var> be true.</p>

    <p>Otherwise, if the <a href=#browsing-context id=opening-the-input-stream:browsing-context>browsing context</a>'s <a href=#session-history id=opening-the-input-stream:session-history>session history</a> contains only
    one <code id=opening-the-input-stream:document-17><a href=#document>Document</a></code>, and that was the <code id=opening-the-input-stream:about:blank><a href=#about:blank>about:blank</a></code> <code id=opening-the-input-stream:document-18><a href=#document>Document</a></code>
    created when the <a href=#browsing-context id=opening-the-input-stream:browsing-context-2>browsing context</a> was <a href=#creating-a-new-browsing-context id=opening-the-input-stream:creating-a-new-browsing-context>created</a>, and that <code id=opening-the-input-stream:document-19><a href=#document>Document</a></code> has never had the <a href=#unload-a-document id=opening-the-input-stream:unload-a-document-2>unload a
    document</a> algorithm invoked on it (e.g. by a previous call to <code id=opening-the-input-stream:dom-document-open-7><a href=#dom-document-open>document.open()</a></code>), then let <var>replace</var> be true.</p>

    <p>Otherwise, let <var>replace</var> be false.</p>

   <li><p>Set the <code id=opening-the-input-stream:document-20><a href=#document>Document</a></code>'s <i id=opening-the-input-stream:concept-document-salvageable><a href=#concept-document-salvageable>salvageable</a></i> state to false.<li><p><a href=#prompt-to-unload-a-document id=opening-the-input-stream:prompt-to-unload-a-document>Prompt to unload</a> the
   <code id=opening-the-input-stream:document-21><a href=#document>Document</a></code> object. If the user <a href=#refused-to-allow-the-document-to-be-unloaded id=opening-the-input-stream:refused-to-allow-the-document-to-be-unloaded>refused to allow the document to be
   unloaded</a>, then abort these steps and return the <code id=opening-the-input-stream:document-22><a href=#document>Document</a></code> object on which the
   method was invoked.<li><p><a href=#unload-a-document id=opening-the-input-stream:unload-a-document-3>Unload</a> the <code id=opening-the-input-stream:document-23><a href=#document>Document</a></code> object, with the
   <var>recycle</var> parameter set to true.<li><p><a href=#abort-a-document id=opening-the-input-stream:abort-a-document>Abort</a> the <code id=opening-the-input-stream:document-24><a href=#document>Document</a></code>.<li><p>Unregister all event listeners registered on the <code id=opening-the-input-stream:document-25><a href=#document>Document</a></code> node and its
   descendants.</p>

   <li><p>Remove any <a href=#concept-task id=opening-the-input-stream:concept-task>tasks</a> associated with the
   <code id=opening-the-input-stream:document-26><a href=#document>Document</a></code> in any <a href=#task-source id=opening-the-input-stream:task-source>task source</a>.<li><p>Remove all child nodes of the document, without firing any mutation events.<li>
    <p>Call the JavaScript <a href=https://tc39.github.io/ecma262/#sec-initializehostdefinedrealm id=opening-the-input-stream:js-initializehostdefinedrealm data-x-internal=js-initializehostdefinedrealm>InitializeHostDefinedRealm()</a> abstract operation
    with the following customizations:</p>

    <ul><li><p>For the global object, create a new <code id=opening-the-input-stream:window><a href=#window>Window</a></code> object
     <var>window</var>.<li><p>For the global <b>this</b> value, use the current <a href=#browsing-context id=opening-the-input-stream:browsing-context-3>browsing context</a>'s
     associated <code id=opening-the-input-stream:windowproxy><a href=#windowproxy>WindowProxy</a></code>.<li><p>Let <var>realm execution context</var> be the created <a id=opening-the-input-stream:javascript-execution-context href=https://tc39.github.io/ecma262/#sec-execution-contexts data-x-internal=javascript-execution-context>JavaScript execution
     context</a>.</ul>
   <li><p>Set <var>window</var>'s <a href=#concept-document-window id=opening-the-input-stream:concept-document-window>associated
   <code>Document</code></a> to the <code id=opening-the-input-stream:document-27><a href=#document>Document</a></code>.<li><p><a href=#set-up-a-browsing-context-environment-settings-object id=opening-the-input-stream:set-up-a-browsing-context-environment-settings-object>Set up a browsing context environment settings object</a> with <var>realm
   execution context</var>.<li><p>Replace the <code id=opening-the-input-stream:document-28><a href=#document>Document</a></code>'s singleton objects with new instances of those objects,
   created in <var>window</var>'s <a href=#concept-global-object-realm id=opening-the-input-stream:concept-global-object-realm>Realm</a>. (This
   includes in particular the <code id=opening-the-input-stream:history-3><a href=#history-3>History</a></code>, <code id=opening-the-input-stream:applicationcache><a href=#applicationcache>ApplicationCache</a></code>, and
   <code id=opening-the-input-stream:navigator><a href=#navigator>Navigator</a></code>, objects, the various <code id=opening-the-input-stream:barprop><a href=#barprop>BarProp</a></code> objects, the two
   <code id=opening-the-input-stream:storage-2><a href=#storage-2>Storage</a></code> objects, the various <code id=opening-the-input-stream:htmlcollection><a data-x-internal=htmlcollection href=https://dom.spec.whatwg.org/#interface-htmlcollection>HTMLCollection</a></code> objects, and objects
   defined by other specifications, like <code id=opening-the-input-stream:selection><a data-x-internal=selection href=https://w3c.github.io/selection-api/#selection-interface>Selection</a></code>. It also includes all the Web IDL
   prototypes in the JavaScript binding, including the <code id=opening-the-input-stream:document-29><a href=#document>Document</a></code> object's
   prototype.)<li><p>Change the <a id="opening-the-input-stream:document's-character-encoding" href=https://dom.spec.whatwg.org/#concept-document-encoding data-x-internal="document's-character-encoding">document's character encoding</a> to UTF-8.<li><p>If the <code id=opening-the-input-stream:document-30><a href=#document>Document</a></code> is <a href=#ready-for-post-load-tasks id=opening-the-input-stream:ready-for-post-load-tasks>ready for post-load tasks</a>, then set the
   <code id=opening-the-input-stream:document-31><a href=#document>Document</a></code> object's <a href=#reload-override-flag id=opening-the-input-stream:reload-override-flag>reload override flag</a> and set the
   <code id=opening-the-input-stream:document-32><a href=#document>Document</a></code>'s <a href=#reload-override-buffer id=opening-the-input-stream:reload-override-buffer>reload override buffer</a> to the empty string.<li><p>Set the <code id=opening-the-input-stream:document-33><a href=#document>Document</a></code>'s <i id=opening-the-input-stream:concept-document-salvageable-2><a href=#concept-document-salvageable>salvageable</a></i> state back to true.<li><p>Change the document's <a href=https://dom.spec.whatwg.org/#concept-document-url id="opening-the-input-stream:the-document's-address" data-x-internal="the-document's-address">URL</a> to the <a href=https://dom.spec.whatwg.org/#concept-document-url id="opening-the-input-stream:the-document's-address-2" data-x-internal="the-document's-address">URL</a> of the <a href=#responsible-document id=opening-the-input-stream:responsible-document-2>responsible document</a> specified by
   the <a href=#entry-settings-object id=opening-the-input-stream:entry-settings-object-2>entry settings object</a>.<li><p>If the <code id=opening-the-input-stream:document-34><a href=#document>Document</a></code>'s <a href=#iframe-load-in-progress id=opening-the-input-stream:iframe-load-in-progress>iframe load in progress</a> flag is set, set the
   <code id=opening-the-input-stream:document-35><a href=#document>Document</a></code>'s <a href=#mute-iframe-load id=opening-the-input-stream:mute-iframe-load>mute iframe load</a> flag.<li><p>Create a new <a href=#html-parser id=opening-the-input-stream:html-parser>HTML parser</a> and associate it with the document. This is a
   <dfn id=script-created-parser>script-created parser</dfn> (meaning that it can be closed by the <code id=opening-the-input-stream:dom-document-open-8><a href=#dom-document-open>document.open()</a></code> and <code id=opening-the-input-stream:dom-document-close><a href=#dom-document-close>document.close()</a></code> methods, and that the tokenizer will wait for
   an explicit call to <code id=opening-the-input-stream:dom-document-close-2><a href=#dom-document-close>document.close()</a></code> before emitting an
   end-of-file token). The encoding <a href=#concept-encoding-confidence id=opening-the-input-stream:concept-encoding-confidence>confidence</a> is
   <i>irrelevant</i>.<li><p>Set the <a href=#current-document-readiness id=opening-the-input-stream:current-document-readiness>current document readiness</a> of the document to "<code>loading</code>".<li>

    

    <p>If <var>type</var> is an <a id=opening-the-input-stream:ascii-case-insensitive-2 href=https://infra.spec.whatwg.org/#ascii-case-insensitive data-x-internal=ascii-case-insensitive>ASCII case-insensitive</a> match for the string
    "<code>replace</code>", then, for historical reasons, set it to the string "<code>text/html</code>".</p>

    <p>Otherwise:</p>

    <p>If the <var>type</var> string contains a U+003B SEMICOLON character (;), remove the
    first such character and all characters from it up to the end of the string.</p>

    <p><a href=#strip-leading-and-trailing-whitespace id=opening-the-input-stream:strip-leading-and-trailing-whitespace>Strip leading and trailing whitespace</a> from <var>type</var>.</p>

   <li>

    <p>If <var>type</var> is <em>not</em> now an <a id=opening-the-input-stream:ascii-case-insensitive-3 href=https://infra.spec.whatwg.org/#ascii-case-insensitive data-x-internal=ascii-case-insensitive>ASCII case-insensitive</a> match
    for the string "<code id=opening-the-input-stream:text/html-2><a href=#text/html>text/html</a></code>", then act as if the tokenizer had emitted a start tag
    token with the tag name "pre" followed by a single U+000A LINE FEED (LF) character, then switch the
    <a href=#html-parser id=opening-the-input-stream:html-parser-2>HTML parser</a>'s tokenizer to the <a href=#plaintext-state id=opening-the-input-stream:plaintext-state>PLAINTEXT state</a>.</p>

    

   <li>

    <p>Remove all the entries in the <a href=#browsing-context id=opening-the-input-stream:browsing-context-4>browsing context</a>'s <a href=#session-history id=opening-the-input-stream:session-history-2>session history</a>
    after the <a href=#current-entry id=opening-the-input-stream:current-entry>current entry</a>. If the <a href=#current-entry id=opening-the-input-stream:current-entry-2>current entry</a> is the last entry in the
    session history, then no entries are removed.</p>

    <p class=note>This <a href=#history-notes>doesn't necessarily have to affect</a> the user
    agent's user interface.</p>

   <li><p>Remove any <a href=#concept-task id=opening-the-input-stream:concept-task-2>tasks</a> queued by the <a href=#history-traversal-task-source id=opening-the-input-stream:history-traversal-task-source>history traversal
   task source</a> that are associated with any <code id=opening-the-input-stream:document-36><a href=#document>Document</a></code> objects in the
   <a href=#top-level-browsing-context id=opening-the-input-stream:top-level-browsing-context>top-level browsing context</a>'s <a href=#document-family id=opening-the-input-stream:document-family>document family</a>.<li>Remove any earlier entries that share the same <code id=opening-the-input-stream:document-37><a href=#document>Document</a></code>.<li><p>If <var>replace</var> is false, then add a new entry, just before the last entry,
   and associate with the new entry the text that was parsed by the previous parser associated with
   the <code id=opening-the-input-stream:document-38><a href=#document>Document</a></code> object, as well as the state of the document at the start of these
   steps. This allows the user to step backwards in the session history to see the page before it
   was blown away by the <code id=opening-the-input-stream:dom-document-open-9><a href=#dom-document-open>document.open()</a></code> call. This new entry
   does not have a <code id=opening-the-input-stream:document-39><a href=#document>Document</a></code> object, so a new one will be created if the session history
   is traversed to that entry.<li><p>Set the <code id=opening-the-input-stream:document-40><a href=#document>Document</a></code>'s <a href=#fired-unload id=opening-the-input-stream:fired-unload>fired unload</a> flag to false. (It could have
   been set to true during the <a href=#unload-a-document id=opening-the-input-stream:unload-a-document-4>unload</a> step above.)<li><p>Finally, set the <a href=#insertion-point id=opening-the-input-stream:insertion-point>insertion point</a> to point at just before the end of the
   <a href=#input-stream id=opening-the-input-stream:input-stream>input stream</a> (which at this point will be empty).<li><p>Return the <code id=opening-the-input-stream:document-41><a href=#document>Document</a></code> on which the method was invoked.</ol>

  <p class=note>The <code id=opening-the-input-stream:dom-document-open-10><a href=#dom-document-open>document.open()</a></code> method does not affect
  whether a <code id=opening-the-input-stream:document-42><a href=#document>Document</a></code> is <a href=#ready-for-post-load-tasks id=opening-the-input-stream:ready-for-post-load-tasks-2>ready for post-load tasks</a> or <a href=#completely-loaded id=opening-the-input-stream:completely-loaded>completely
  loaded</a>.</p>

  <p>When called with three arguments, the <code id=opening-the-input-stream:dom-document-open-11><a href=#dom-document-open>open()</a></code> method on
  the <code id=opening-the-input-stream:document-43><a href=#document>Document</a></code> object must call the <code id=opening-the-input-stream:dom-open-2><a href=#dom-open>open()</a></code> method on the
  <code id=opening-the-input-stream:window-2><a href=#window>Window</a></code> object of the <code id=opening-the-input-stream:document-44><a href=#document>Document</a></code> object, with the same arguments as the
  original call to the <code id=opening-the-input-stream:dom-document-open-12><a href=#dom-document-open>open()</a></code> method, and return whatever
  that method returned. If the <code id=opening-the-input-stream:document-45><a href=#document>Document</a></code> object has no <code id=opening-the-input-stream:window-3><a href=#window>Window</a></code> object, then
  the method must throw an <a id=opening-the-input-stream:invalidaccesserror href=https://heycam.github.io/webidl/#invalidaccesserror data-x-internal=invalidaccesserror>"<code>InvalidAccessError</code>"</a>
  <code id=opening-the-input-stream:domexception-6><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code>.</p>

  



  <h4 id=closing-the-input-stream>8.4.2 Closing the input stream<a href=#closing-the-input-stream class=self-link></a></h4>

  <dl class=domintro><dt><var>document</var> . <code id=closing-the-input-stream:dom-document-close><a href=#dom-document-close>close</a></code>()<dd>

    <p>Closes the input stream that was opened by the <code id=closing-the-input-stream:dom-document-open><a href=#dom-document-open>document.open()</a></code> method.</p>

    <p>Throws an <a id=closing-the-input-stream:invalidstateerror href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a> <code id=closing-the-input-stream:domexception><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> if the
    <code id=closing-the-input-stream:document><a href=#document>Document</a></code> is an <a href=https://dom.spec.whatwg.org/#xml-document id=closing-the-input-stream:xml-documents data-x-internal=xml-documents>XML document</a>.</p>

    <p>Throws an <a id=closing-the-input-stream:invalidstateerror-2 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a> <code id=closing-the-input-stream:domexception-2><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> if the
    parser is currently executing a <a href=#custom-element-constructor id=closing-the-input-stream:custom-element-constructor>custom element constructor</a>.</p>

   </dl>

  

  <p>The <dfn id=dom-document-close><code>close()</code></dfn> method must run the following
  steps:</p>

  <ol><li><p>If the <code id=closing-the-input-stream:document-2><a href=#document>Document</a></code> object is an <a href=https://dom.spec.whatwg.org/#xml-document id=closing-the-input-stream:xml-documents-2 data-x-internal=xml-documents>XML
   document</a>, then throw an <a id=closing-the-input-stream:invalidstateerror-3 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a>
   <code id=closing-the-input-stream:domexception-3><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these steps.<li><p>If the <code id=closing-the-input-stream:document-3><a href=#document>Document</a></code> object's <a href=#throw-on-dynamic-markup-insertion-counter id=closing-the-input-stream:throw-on-dynamic-markup-insertion-counter>throw-on-dynamic-markup-insertion
   counter</a> is greater than zero, then throw an <a id=closing-the-input-stream:invalidstateerror-4 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a>
   <code id=closing-the-input-stream:domexception-4><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these steps.<li><p>If there is no <a href=#script-created-parser id=closing-the-input-stream:script-created-parser>script-created parser</a> associated with the document, then abort
   these steps.<li><p>Insert an <a href=#explicit-eof-character id=closing-the-input-stream:explicit-eof-character>explicit "EOF" character</a> at the end of the parser's <a href=#input-stream id=closing-the-input-stream:input-stream>input
   stream</a>.<li><p>If there is a <a href=#pending-parsing-blocking-script id=closing-the-input-stream:pending-parsing-blocking-script>pending parsing-blocking script</a>, then abort these
   steps.<li><p>Run the tokenizer, processing resulting tokens as they are emitted, and stopping when the
   tokenizer reaches the <a href=#explicit-eof-character id=closing-the-input-stream:explicit-eof-character-2>explicit "EOF" character</a> or <a href=#spin-the-event-loop id=closing-the-input-stream:spin-the-event-loop>spins the event loop</a>.</ol>

  



  <h4 id=document.write()>8.4.3 <code id=document.write():dom-document-write><a href=#dom-document-write>document.write()</a></code><a href=#document.write() class=self-link></a></h4>

  <dl class=domintro><dt><var>document</var> . <code id=document.write():dom-document-write-2><a href=#dom-document-write>write</a></code>(<var>text</var>...)<dd>

    <p>In general, adds the given string(s) to the <code id=document.write():document><a href=#document>Document</a></code>'s input stream.</p>

    <p class=warning>This method has very idiosyncratic behavior. In some cases, this method can
    affect the state of the <a href=#html-parser id=document.write():html-parser>HTML parser</a> while the parser is running, resulting in a DOM
    that does not correspond to the source of the document (e.g. if the string written is the string
    "<code>&lt;plaintext></code>" or "<code>&lt;!--</code>"). In other cases,
    the call can clear the current page first, as if <code id=document.write():dom-document-open><a href=#dom-document-open>document.open()</a></code> had been called. In yet more cases, the method
    is simply ignored, or throws an exception. To make matters worse, the exact behavior of this
    method can in some cases be dependent on network latency, which can lead to failures that are very hard to debug. <strong>For all these reasons, use
    of this method is strongly discouraged.</strong></p>

    <p>Throws an <a id=document.write():invalidstateerror href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a> <code id=document.write():domexception><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> when
    invoked on <a id=document.write():xml-documents href=https://dom.spec.whatwg.org/#xml-document data-x-internal=xml-documents>XML documents</a>.</p>

    <p>Throws an <a id=document.write():invalidstateerror-2 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a> <code id=document.write():domexception-2><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> if the
    parser is currently executing a <a href=#custom-element-constructor id=document.write():custom-element-constructor>custom element constructor</a>.</p>

   </dl>

  

  <p><code id=document.write():document-2><a href=#document>Document</a></code> objects have an <dfn id=ignore-destructive-writes-counter>ignore-destructive-writes counter</dfn>, which is
  used in conjunction with the processing of <code id=document.write():the-script-element><a href=#the-script-element>script</a></code> elements to prevent external
  scripts from being able to use <code id=document.write():dom-document-write-3><a href=#dom-document-write>document.write()</a></code> to blow
  away the document by implicitly calling <code id=document.write():dom-document-open-2><a href=#dom-document-open>document.open()</a></code>.
  Initially, the counter must be set to zero.</p>

  <p>The <dfn id=dom-document-write><code>document.write(...)</code></dfn> method must act as
  follows:</p>

  <ol><li>

    <p>If the method was invoked on an <a href=https://dom.spec.whatwg.org/#xml-document id=document.write():xml-documents-2 data-x-internal=xml-documents>XML document</a>, throw an
    <a id=document.write():invalidstateerror-3 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a> <code id=document.write():domexception-3><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these
    steps.</p>

    

   <li><p>If the <code id=document.write():document-3><a href=#document>Document</a></code> object's <a href=#throw-on-dynamic-markup-insertion-counter id=document.write():throw-on-dynamic-markup-insertion-counter>throw-on-dynamic-markup-insertion
   counter</a> is greater than zero, then throw an <a id=document.write():invalidstateerror-4 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a>
   <code id=document.write():domexception-4><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these steps.<li><p>If the <code id=document.write():document-4><a href=#document>Document</a></code> object is not an <a href=#active-document id=document.write():active-document>active document</a>, then abort
   these steps.<li>

    <p>If the <a href=#insertion-point id=document.write():insertion-point>insertion point</a> is undefined and either the <code id=document.write():document-5><a href=#document>Document</a></code>'s
    <a href=#ignore-opens-during-unload-counter id=document.write():ignore-opens-during-unload-counter>ignore-opens-during-unload counter</a> is greater than zero or the
    <code id=document.write():document-6><a href=#document>Document</a></code>'s <a href=#ignore-destructive-writes-counter id=document.write():ignore-destructive-writes-counter>ignore-destructive-writes counter</a> is greater than zero,
    abort these steps.</p>

   <li>

    <p>If the <a href=#insertion-point id=document.write():insertion-point-2>insertion point</a> is undefined, call the <code id=document.write():dom-document-open-3><a href=#dom-document-open>open()</a></code> method on the <code id=document.write():document-7><a href=#document>document</a></code>
    object (with no arguments). If the user <a href=#refused-to-allow-the-document-to-be-unloaded id=document.write():refused-to-allow-the-document-to-be-unloaded>refused to allow the document to be
    unloaded</a>, then abort these steps. Otherwise, the <a href=#insertion-point id=document.write():insertion-point-3>insertion point</a> will point
    at just before the end of the (empty) <a href=#input-stream id=document.write():input-stream>input stream</a>.</p>

   <li>

    <p>Insert the string consisting of the concatenation of all the arguments to the method into the
    <a href=#input-stream id=document.write():input-stream-2>input stream</a> just before the <a href=#insertion-point id=document.write():insertion-point-4>insertion point</a>.</p>

   <li>

    <p>If the <code id=document.write():document-8><a href=#document>Document</a></code> object's <a href=#reload-override-flag id=document.write():reload-override-flag>reload override flag</a> is set, then append
    the string consisting of the concatenation of all the arguments to the method to the
    <code id=document.write():document-9><a href=#document>Document</a></code>'s <a href=#reload-override-buffer id=document.write():reload-override-buffer>reload override buffer</a>.</p>

   <li>

    <p>If there is no <a href=#pending-parsing-blocking-script id=document.write():pending-parsing-blocking-script>pending parsing-blocking script</a>, have the <a href=#html-parser id=document.write():html-parser-2>HTML
    parser</a> process the characters that were inserted, one at a time, processing resulting
    tokens as they are emitted, and stopping when the tokenizer reaches the insertion point or when
    the processing of the tokenizer is aborted by the tree construction stage (this can happen if a
    <code id=document.write():the-script-element-2><a href=#the-script-element>script</a></code> end tag token is emitted by the tokenizer).

    <p class=note>If the <code id=document.write():dom-document-write-4><a href=#dom-document-write>document.write()</a></code> method was
    called from script executing inline (i.e. executing because the parser parsed a set of
    <code id=document.write():the-script-element-3><a href=#the-script-element>script</a></code> tags), then this is a <a href=#nestedParsing>reentrant invocation of the
    parser</a>. If the <a href=#parser-pause-flag id=document.write():parser-pause-flag>parser pause flag</a> is set, the tokenizer will abort immediately
    and no HTML will be parsed, per the tokenizer's <a href=#check-parser-pause-flag>parser pause
    flag check</a>.</p>

   <li>

    <p>Finally, return from the method.</p>

   </ol>

  


  <h4 id=document.writeln()>8.4.4 <code id=document.writeln():dom-document-writeln><a href=#dom-document-writeln>document.writeln()</a></code><a href=#document.writeln() class=self-link></a></h4>

  <dl class=domintro><dt><var>document</var> . <code id=document.writeln():dom-document-writeln-2><a href=#dom-document-writeln>writeln</a></code>(<var>text</var>...)<dd>

    <p>Adds the given string(s) to the <code id=document.writeln():document><a href=#document>Document</a></code>'s input stream, followed by a newline
    character. If necessary, calls the <code id=document.writeln():dom-document-open><a href=#dom-document-open>open()</a></code> method
    implicitly first.</p>

    <p>Throws an <a id=document.writeln():invalidstateerror href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a> <code id=document.writeln():domexception><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> when
    invoked on <a id=document.writeln():xml-documents href=https://dom.spec.whatwg.org/#xml-document data-x-internal=xml-documents>XML documents</a>.</p>

    <p>Throws an <a id=document.writeln():invalidstateerror-2 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a> <code id=document.writeln():domexception-2><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> if the
    parser is currently executing a <a href=#custom-element-constructor id=document.writeln():custom-element-constructor>custom element constructor</a>.</p>

   </dl>

  

  <p>The <dfn id=dom-document-writeln><code>document.writeln(...)</code></dfn> method, when
  invoked, must act as if the <code id=document.writeln():dom-document-write><a href=#dom-document-write>document.write()</a></code> method had
  been invoked with the same argument(s), plus an extra argument consisting of a string containing a
  single line feed character (U+000A).</p>

  



  <h3 id=timers>8.5 Timers<a href=#timers class=self-link></a></h3>

  <p>The <code id=timers:dom-settimeout><a href=#dom-settimeout>setTimeout()</a></code> and <code id=timers:dom-setinterval><a href=#dom-setinterval>setInterval()</a></code> methods allow authors to schedule timer-based
  callbacks.</p>

  <dl class=domintro><dt><var>handle</var> = self . <code id=timers:dom-settimeout-2><a href=#dom-settimeout>setTimeout</a></code>( <var>handler</var> [, <var>timeout</var> [, <var>arguments</var>... ] ] )<dd>

    <p>Schedules a timeout to run <var>handler</var> after <var>timeout</var>
    milliseconds. Any <var>arguments</var> are passed straight through to the <var>handler</var>.</p>

   <dt><var>handle</var> = self . <code id=timers:dom-settimeout-3><a href=#dom-settimeout>setTimeout</a></code>( <var>code</var> [, <var>timeout</var> ] )<dd>

    <p>Schedules a timeout to compile and run <var>code</var> after <var>timeout</var> milliseconds.</p>

   <dt>self . <code id=timers:dom-cleartimeout><a href=#dom-cleartimeout>clearTimeout</a></code>( <var>handle</var> )<dd>

    <p>Cancels the timeout set with <code id=timers:dom-settimeout-4><a href=#dom-settimeout>setTimeout()</a></code> or <code id=timers:dom-setinterval-2><a href=#dom-setinterval>setInterval()</a></code> identified by <var>handle</var>.</p>

   <dt><var>handle</var> = self . <code id=timers:dom-setinterval-3><a href=#dom-setinterval>setInterval</a></code>( <var>handler</var> [, <var>timeout</var> [, <var>arguments</var>... ] ] )<dd>

    <p>Schedules a timeout to run <var>handler</var> every <var>timeout</var>
    milliseconds. Any <var>arguments</var> are passed straight through to the <var>handler</var>.</p>

   <dt><var>handle</var> = self . <code id=timers:dom-setinterval-4><a href=#dom-setinterval>setInterval</a></code>( <var>code</var> [, <var>timeout</var> ] )<dd>

    <p>Schedules a timeout to compile and run <var>code</var> every <var>timeout</var> milliseconds.</p>

   <dt>self . <code id=timers:dom-clearinterval><a href=#dom-clearinterval>clearInterval</a></code>( <var>handle</var> )<dd>

    <p>Cancels the timeout set with <code id=timers:dom-setinterval-5><a href=#dom-setinterval>setInterval()</a></code> or <code id=timers:dom-settimeout-5><a href=#dom-settimeout>setTimeout()</a></code> identified by <var>handle</var>.</p>

   </dl>

  <p class=note>Timers can be nested; after five such nested timers, however, the interval is
  forced to be at least four milliseconds.</p>

  <p class=note>This API does not guarantee that timers will run exactly on schedule. Delays due
  to CPU load, other tasks, etc, are to be expected.</p>

  

  <p>Objects that implement the <code id=timers:windoworworkerglobalscope><a href=#windoworworkerglobalscope>WindowOrWorkerGlobalScope</a></code> mixin have a <dfn id=list-of-active-timers data-export="">list of active timers</dfn>. Each entry in this lists is identified by a number,
  which must be unique within the list for the lifetime of the object that implements the
  <code id=timers:windoworworkerglobalscope-2><a href=#windoworworkerglobalscope>WindowOrWorkerGlobalScope</a></code> mixin.</p>

  <hr>

  <p>The <dfn id=dom-settimeout><code id=dom-windowtimers-setTimeout>setTimeout()</code></dfn> method must return the value returned
  by the <a href=#timer-initialisation-steps id=timers:timer-initialisation-steps>timer initialization steps</a>, passing them the method's arguments, the object on
  which the method for which the algorithm is running is implemented (a <code id=timers:window><a href=#window>Window</a></code> or
  <code id=timers:workerglobalscope><a href=#workerglobalscope>WorkerGlobalScope</a></code> object) as the <var>method context</var>, and the <var>repeat</var>
  flag set to false.</p>

  <p>The <dfn id=dom-setinterval><code id=dom-windowtimers-setInterval>setInterval()</code></dfn> method must return the value returned
  by the <a href=#timer-initialisation-steps id=timers:timer-initialisation-steps-2>timer initialization steps</a>, passing them the method's arguments, the object on
  which the method for which the algorithm is running is implemented (a <code id=timers:window-2><a href=#window>Window</a></code> or
  <code id=timers:workerglobalscope-2><a href=#workerglobalscope>WorkerGlobalScope</a></code> object) as the <var>method context</var>, and the <var>repeat</var>
  flag set to true.</p>

  <p>The <dfn id=dom-cleartimeout><code id=dom-windowtimers-clearTimeout>clearTimeout()</code></dfn> and <dfn id=dom-clearinterval><code id=dom-windowtimers-clearInterval>clearInterval()</code></dfn>
  methods must clear the entry identified as <var>handle</var> from the <a href=#list-of-active-timers id=timers:list-of-active-timers>list of active
  timers</a> of the <code id=timers:windoworworkerglobalscope-3><a href=#windoworworkerglobalscope>WindowOrWorkerGlobalScope</a></code> object on which the method was
  invoked, if any, where <var>handle</var> is the argument passed to the method. (If
  <var>handle</var> does not identify an entry in the <a href=#list-of-active-timers id=timers:list-of-active-timers-2>list of active timers</a> of the
  <code id=timers:windoworworkerglobalscope-4><a href=#windoworworkerglobalscope>WindowOrWorkerGlobalScope</a></code> object on which the method was invoked, the method does
  nothing.)</p>

  <p class=note>Because <code id=timers:dom-cleartimeout-2><a href=#dom-cleartimeout>clearTimeout()</a></code> and <code id=timers:dom-clearinterval-2><a href=#dom-clearinterval>clearInterval()</a></code> clear entries from the same list, either method
  can be used to clear timers created by <code id=timers:dom-settimeout-6><a href=#dom-settimeout>setTimeout()</a></code> or <code id=timers:dom-setinterval-6><a href=#dom-setinterval>setInterval()</a></code>.</p>

  <hr>

  <p>The <dfn id=timer-initialisation-steps>timer initialization steps</dfn>, which
  are invoked with some method arguments, a <var>method context</var>, a <var>repeat</var> flag
  which can be true or false, and optionally (and only if the <var>repeat</var> flag is true) a
  <var>previous handle</var>, are as follows:</p>

  <ol><li><p>Let <var>method context proxy</var> be <var>method context</var> if that
   is a <code id=timers:workerglobalscope-3><a href=#workerglobalscope>WorkerGlobalScope</a></code> object, or else the <code id=timers:windowproxy><a href=#windowproxy>WindowProxy</a></code> that corresponds
   to <var>method context</var>.<li><p>If <var>previous handle</var> was provided, let <var>handle</var> be
   <var>previous handle</var>; otherwise, let <var>handle</var> be a
   user-agent-defined integer that is greater than zero that will identify the timeout to be set by
   this call in the <a href=#list-of-active-timers id=timers:list-of-active-timers-3>list of active timers</a>.<li><p>If <var>previous handle</var> was not provided, add an entry to the <a href=#list-of-active-timers id=timers:list-of-active-timers-4>list of
   active timers</a> for <var>handle</var>.<li><p>Let <var>callerRealm</var> be the <a id=timers:current-realm-record href=https://tc39.github.io/ecma262/#current-realm data-x-internal=current-realm-record>current Realm Record</a>, and
   <var>calleeRealm</var> be <var>method context</var>'s <a id=timers:javascript-realm href=https://tc39.github.io/ecma262/#sec-code-realms data-x-internal=javascript-realm>JavaScript realm</a>.<li>

    <p>Let <var>task</var> be a <a href=#concept-task id=timers:concept-task>task</a> that runs the
    following substeps:</p>

    <ol><li><p>If the entry for <var>handle</var> in the <a href=#list-of-active-timers id=timers:list-of-active-timers-5>list of active timers</a>
     has been cleared, then abort this <a href=#concept-task id=timers:concept-task-2>task</a>'s substeps.<li>

      <p>Run the appropriate set of steps from the following list:</p>

      <dl class=switch><dt>If the first method argument is a <code id=timers:idl-function><a data-x-internal=idl-function href=https://heycam.github.io/webidl/#common-Function>Function</a></code><dd>

        <p><a href=https://heycam.github.io/webidl/#es-invoking-callback-functions id=timers:es-invoking-callback-functions data-x-internal=es-invoking-callback-functions>Invoke</a> the <code id=timers:idl-function-2><a data-x-internal=idl-function href=https://heycam.github.io/webidl/#common-Function>Function</a></code>. Use the third and subsequent method
        arguments (if any) as the arguments for invoking the <code id=timers:idl-function-3><a data-x-internal=idl-function href=https://heycam.github.io/webidl/#common-Function>Function</a></code>. Use <var>method context proxy</var> as the
        <a href=https://heycam.github.io/webidl/#dfn-callback-this-value id=timers:dfn-callback-this-value data-x-internal=dfn-callback-this-value>callback this value</a>.</p>

       <dt>Otherwise<dd>

        <ol><li><p>Perform <a href=#hostensurecancompilestrings(callerrealm,-calleerealm) id=timers:hostensurecancompilestrings(callerrealm,-calleerealm)>HostEnsureCanCompileStrings</a>(<var>callerRealm</var>,
         <var>calleeRealm</var>). If this throws an exception, <a href=#report-the-exception id=timers:report-the-exception>report the
         exception</a>.<li><p>Let <var>script source</var> be the first method argument.<li><p>Let <var>settings object</var> be <var>method context</var>'s <a href=#environment-settings-object id=timers:environment-settings-object>environment
         settings object</a>.<li><p>Let <var>script</var> be the result of <a href=#creating-a-classic-script id=timers:creating-a-classic-script>creating a classic script</a> using
         <var>script source</var> and <var>settings object</var>.<li><p><a href=#run-a-classic-script id=timers:run-a-classic-script>Run the classic script</a>
         <var>script</var>.</ol>

       </dl>

     <li><p>If the <var>repeat</var> flag is true, then call <a href=#timer-initialisation-steps id=timers:timer-initialisation-steps-3>timer initialization
     steps</a> again, passing them the same method arguments, the same <var>method
     context</var>, with the <var>repeat</var> flag still set to true, and with the <var>previous handle</var> set to <var>handler</var>.</ol>

   <li><p>Let <var>timeout</var> be the second method argument.<li>
    <p>If the currently running <a href=#concept-task id=timers:concept-task-3>task</a> is a task that was created
    by this algorithm, then let <var>nesting level</var> be the <a href=#concept-task id=timers:concept-task-4>task</a>'s <a href=#timer-nesting-level id=timers:timer-nesting-level>timer nesting level</a>. Otherwise, let
    <var>nesting level</var> be zero.</p>

    <p class=note>The task's <a href=#timer-nesting-level id=timers:timer-nesting-level-2>timer nesting level</a> is used both for nested calls to
    <code id=timers:dom-settimeout-7><a href=#dom-settimeout>setTimeout()</a></code>, and for the repeating timers created by <code id=timers:dom-setinterval-7><a href=#dom-setinterval>setInterval()</a></code>. (Or, indeed, for any combination of the two.) In
    other words, it represents nested invocations of this algorithm, not of a particular method.</p>
   <li><p>If <var>nesting level</var> is greater than 5, and <var>timeout</var> is
   less than 4, then increase <var>timeout</var> to 4.<li><p>Increment <var>nesting level</var> by one.<li><p>Let <var>task</var>'s <dfn id=timer-nesting-level>timer nesting level</dfn> be <var>nesting
   level</var>.<li><p>Return <var>handle</var>, and then continue running this algorithm
   <a href=#in-parallel id=timers:in-parallel>in parallel</a>.<li>

    <p>If <var>method context</var> is a <code id=timers:window-3><a href=#window>Window</a></code> object, wait until the
    <code id=timers:document><a href=#document>Document</a></code> associated with <var>method context</var> has been <a href=#fully-active id=timers:fully-active>fully
    active</a> for a further <var>timeout</var> milliseconds (not necessarily
    consecutively).</p>

    <p>Otherwise, <var>method context</var> is a <code id=timers:workerglobalscope-4><a href=#workerglobalscope>WorkerGlobalScope</a></code> object;
    wait until <var>timeout</var> milliseconds have passed with the worker not suspended
    (not necessarily consecutively).</p>

   <li>

    <p>Wait until any invocations of this algorithm that had the same <var>method
    context</var>, that started before this one, and whose <var>timeout</var> is equal to
    or less than this one's, have completed.</p>

    <p class=note>Argument conversion as defined by Web IDL (for example, invoking <code>toString()</code> methods on objects passed as the first argument) happens in the
    algorithms defined in Web IDL, before this algorithm is invoked.</p>

    <div class=example>

     <p>So for example, the following rather silly code will result in the log containing "<code>ONETWO</code>":</p>

     <pre>var log = '';
function logger(s) { log += s + ' '; }

setTimeout({ toString: function () {
  setTimeout("logger('ONE')", 100);
  return "logger('TWO')";
} }, 100);</pre>

    </div>

   <li>

    <p>Optionally, wait a further user-agent defined length of time.</p>

    <p class=note>This is intended to allow user agents to pad timeouts as needed to optimize the
    power usage of the device. For example, some processors have a low-power mode where the
    granularity of timers is reduced; on such platforms, user agents can slow timers down to fit
    this schedule instead of requiring the processor to use the more accurate mode with its
    associated higher power usage.</p>

   <li>

    <p><a href=#queue-a-task id=timers:queue-a-task>Queue</a> the <a href=#concept-task id=timers:concept-task-5>task</a> <var>task</var>.</p>

    <p class=note>Once the task has been processed, if the <var>repeat</var> flag is
    false, it is safe to remove the entry for <var>handle</var> from the <a href=#list-of-active-timers id=timers:list-of-active-timers-6>list of
    active timers</a> (there is no way for the entry's existence to be detected past this point,
    so it does not technically matter one way or the other).</p>

   </ol>

  <p>The <a href=#task-source id=timers:task-source>task source</a> for these <a href=#concept-task id=timers:concept-task-6>tasks</a> is the
  <dfn id=timer-task-source>timer task source</dfn>.</p>

  

  <div class=example>

   <p>To run tasks of several milliseconds back to back without any delay, while still yielding back
   to the browser to avoid starving the user interface (and to avoid the browser killing the script
   for hogging the CPU), simply queue the next timer before performing work:</p>

   <pre>function doExpensiveWork() {
  var done = false;
  // ...
  // this part of the function takes up to five milliseconds
  // set done to true if we're done
  // ...
  return done;
}

function rescheduleWork() {
  var handle = setTimeout(rescheduleWork, 0); // preschedule next iteration
  if (doExpensiveWork())
    clearTimeout(handle); // clear the timeout if we don't need it
}

function scheduleWork() {
  setTimeout(rescheduleWork, 0);
}

scheduleWork(); // queues a task to do lots of work</pre>

  </div>


  <h3 id=user-prompts>8.6 User prompts<a href=#user-prompts class=self-link></a></h3>

  

  <h4 id=simple-dialogs>8.6.1 Simple dialogs<a href=#simple-dialogs class=self-link></a></h4>

  <dl class=domintro><dt><var>window</var> . <code id=simple-dialogs:dom-alert><a href=#dom-alert>alert</a></code>(<var>message</var>)<dd>

    <p>Displays a modal alert with the given message, and waits for the user to dismiss it.</p>

   <dt><var>result</var> = <var>window</var> . <code id=simple-dialogs:dom-confirm><a href=#dom-confirm>confirm</a></code>(<var>message</var>)<dd>

    <p>Displays a modal OK/Cancel prompt with the given message, waits for the user to dismiss it,
    and returns true if the user clicks OK and false if the user clicks Cancel.</p>

   <dt><var>result</var> = <var>window</var> . <code id=simple-dialogs:dom-prompt><a href=#dom-prompt>prompt</a></code>(<var>message</var> [, <var>default</var>] )<dd>

    <p>Displays a modal text control prompt with the given message, waits for the user to dismiss
    it, and returns the value that the user entered. If the user cancels the prompt, then returns
    null instead. If the second argument is present, then the given value is used as a default.</p>

   </dl>

  <p class=note>Logic that depends on <a href=#concept-task id=simple-dialogs:concept-task>tasks</a> or <a href=#microtask id=simple-dialogs:microtask>microtasks</a>, such as <a href=#media-element id=simple-dialogs:media-element>media elements</a>
  loading their <a href=#media-data id=simple-dialogs:media-data>media data</a>, are stalled when these methods are invoked.</p>

  

  <p>To <dfn id=optionally-truncate-a-simple-dialog-string>optionally truncate a simple dialog string</dfn> <var>s</var>, return either
  <var>s</var> itself or some string derived from <var>s</var> that is shorter. User agents should
  not provide UI for displaying the elided portion of <var>s</var>, as this makes it too easy for
  abusers to create dialogs of the form "Important security alert! Click 'Show More' for full
  details!".</p>

  <p class=note>For example, a user agent might want to only display the first 100 characters of a
  message. Or, a user agent might replace the middle of the string with "". These types of
  modifications can be useful in limiting the abuse potential of unnaturally large,
  trustworthy-looking system dialogs.</p>

  <p>The <dfn id=dom-alert><code>alert(<var>message</var>)</code></dfn> method, when
  invoked, must run the following steps:</p>

  <ol><li><p>If the <a href=#event-loop id=simple-dialogs:event-loop>event loop</a>'s <a href=#termination-nesting-level id=simple-dialogs:termination-nesting-level>termination nesting level</a> is non-zero,
   optionally abort these steps.<li><p>If the <a href=#active-sandboxing-flag-set id=simple-dialogs:active-sandboxing-flag-set>active sandboxing flag set</a> of this <code id=simple-dialogs:window><a href=#window>Window</a></code> object's <a href=#concept-document-window id=simple-dialogs:concept-document-window>associated <code>Document</code></a> has the <a href=#sandboxed-modals-flag id=simple-dialogs:sandboxed-modals-flag>sandboxed
   modals flag</a> set, then abort these steps.<li><p>Optionally, abort these steps. (For example, the user agent might give the user the option
   to ignore all alerts, and would thus abort at this step whenever the method was
   invoked.)<li><p>If the method was invoked with no arguments, then let <var>message</var> be the
   empty string; otherwise, let <var>message</var> be the method's first
   argument.<li><p>Set <var>message</var> to the result of <a href=#optionally-truncate-a-simple-dialog-string id=simple-dialogs:optionally-truncate-a-simple-dialog-string>optionally truncating</a> <var>message</var>.<li><p>Show <var>message</var> to the user.<li><p>Optionally, <a href=#pause id=simple-dialogs:pause>pause</a> while waiting for the user to acknowledge the
   message.</ol>

  <p>The <dfn id=dom-confirm><code>confirm(<var>message</var>)</code></dfn> method,
  when invoked, must run the following steps:</p>

  <ol><li><p>If the <a href=#event-loop id=simple-dialogs:event-loop-2>event loop</a>'s <a href=#termination-nesting-level id=simple-dialogs:termination-nesting-level-2>termination nesting level</a> is non-zero,
   optionally abort these steps, returning false.<li><p>If the <a href=#active-sandboxing-flag-set id=simple-dialogs:active-sandboxing-flag-set-2>active sandboxing flag set</a> of this <code id=simple-dialogs:window-2><a href=#window>Window</a></code> object's <a href=#concept-document-window id=simple-dialogs:concept-document-window-2>associated <code>Document</code></a> has the <a href=#sandboxed-modals-flag id=simple-dialogs:sandboxed-modals-flag-2>sandboxed
   modals flag</a> set, then abort these steps.<li><p>Optionally, return false and abort these steps. (For example, the user agent might give
   the user the option to ignore all prompts, and would thus abort at this step whenever the method
   was invoked.)<li><p>Set <var>message</var> to the result of <a href=#optionally-truncate-a-simple-dialog-string id=simple-dialogs:optionally-truncate-a-simple-dialog-string-2>optionally truncating</a> <var>message</var>.<li><p>Show <var>message</var> to the user, and ask the user to respond with a positive or
   negative response.<li><p><a href=#pause id=simple-dialogs:pause-2>Pause</a> until the user responds either positively or negatively.<li><p>If the user responded positively, return true; otherwise, the user responded negatively:
   return false.</ol>

  <p>The <dfn id=dom-prompt><code>prompt(<var>message</var>, <var>default</var>)</code></dfn>
  method, when invoked, must run the following steps:</p>

  <ol><li><p>If the <a href=#event-loop id=simple-dialogs:event-loop-3>event loop</a>'s <a href=#termination-nesting-level id=simple-dialogs:termination-nesting-level-3>termination nesting level</a> is non-zero,
   optionally abort these steps, returning null.<li><p>If the <a href=#active-sandboxing-flag-set id=simple-dialogs:active-sandboxing-flag-set-3>active sandboxing flag set</a> of this <code id=simple-dialogs:window-3><a href=#window>Window</a></code> object's <a href=#concept-document-window id=simple-dialogs:concept-document-window-3>associated <code>Document</code></a> has the <a href=#sandboxed-modals-flag id=simple-dialogs:sandboxed-modals-flag-3>sandboxed
   modals flag</a> set, then abort these steps.<li><p>Optionally, return null and abort these steps. (For example, the user agent might give the
   user the option to ignore all prompts, and would thus abort at this step whenever the method was
   invoked.)<li><p>Set <var>message</var> to the result of <a href=#optionally-truncate-a-simple-dialog-string id=simple-dialogs:optionally-truncate-a-simple-dialog-string-3>optionally truncating</a> <var>message</var>.<li><p>Set <var>default</var> to the result of <a href=#optionally-truncate-a-simple-dialog-string id=simple-dialogs:optionally-truncate-a-simple-dialog-string-4>optionally truncating</a> <var>default</var>.<li><p>Show <var>message</var> to the user, and ask the user to either respond with a string
   value or abort. The response must be defaulted to the value given by <var>default</var>.<li><p><a href=#pause id=simple-dialogs:pause-3>Pause</a> while waiting for the user's response.<li><p>If the user aborts, then return null; otherwise, return the string that the user responded
   with.</ol>

  


  <h4 id=printing>8.6.2 Printing<a href=#printing class=self-link></a></h4>

  <dl class=domintro><dt><var>window</var> . <code id=printing:dom-print><a href=#dom-print>print</a></code>()<dd>

    <p>Prompts the user to print the page.</p>

   </dl>

  

  <p>When the <dfn id=dom-print><code>print()</code></dfn> method is invoked, if the
  <code id=printing:document><a href=#document>Document</a></code> is <a href=#ready-for-post-load-tasks id=printing:ready-for-post-load-tasks>ready for post-load tasks</a>, then the user agent must
  run the <a href=#printing-steps id=printing:printing-steps>printing steps</a> <a href=#in-parallel id=printing:in-parallel>in parallel</a>. Otherwise, the user agent must only set the
  <dfn id=print-when-loaded>print when loaded</dfn> flag on the <code id=printing:document-2><a href=#document>Document</a></code>.</p>



  <p>User agents should also run the <a href=#printing-steps id=printing:printing-steps-2>printing steps</a> whenever the user asks for the
  opportunity to <a href=#obtain-a-physical-form id=printing:obtain-a-physical-form>obtain a physical form</a> (e.g. printed copy), or the representation of a
  physical form (e.g. PDF copy), of a document.</p>

  <p>The <dfn id=printing-steps>printing steps</dfn> are as follows:<div class=status><input onclick=toggleStatus(this) value= type=button><p class=bugs><strong>Spec bugs:</strong> <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=27864" title="Printing steps should apply &quot;img environment changed&quot; algorithm before and after printing and wait u [...]">27864</a></div>

  <ol><li>

    <p>The user agent may display a message to the user or abort these steps (or both).</p>

    <p class=example>For instance, a kiosk browser could silently ignore any invocations of the
    <code id=printing:dom-print-2><a href=#dom-print>print()</a></code> method.</p>

    <p class=example>For instance, a browser on a mobile device could detect that there are no
    printers in the vicinity and display a message saying so before continuing to offer a "save to
    PDF" option.</p>

   <li>

    <p>If the <a href=#active-sandboxing-flag-set id=printing:active-sandboxing-flag-set>active sandboxing flag set</a> of this <code id=printing:window><a href=#window>Window</a></code> object's <a href=#concept-document-window id=printing:concept-document-window>associated <code>Document</code></a> has the <a href=#sandboxed-modals-flag id=printing:sandboxed-modals-flag>sandboxed
    modals flag</a> set, then abort these steps.</p>

    <p class=note>If the printing dialog is blocked by a <code id=printing:document-3><a href=#document>Document</a></code>'s sandbox,
    then neither the <code id=printing:event-beforeprint><a href=#event-beforeprint>beforeprint</a></code> nor <code id=printing:event-afterprint><a href=#event-afterprint>afterprint</a></code> events will be fired.</p>

   <li>

    <p>The user agent must <a href=https://dom.spec.whatwg.org/#concept-event-fire id=printing:concept-event-fire data-x-internal=concept-event-fire>fire an event</a> named <code id=printing:event-beforeprint-2><a href=#event-beforeprint>beforeprint</a></code> at the <code id=printing:window-2><a href=#window>Window</a></code> object of the
    <code id=printing:document-4><a href=#document>Document</a></code> that is being printed, as well as any <a href=#nested-browsing-context id=printing:nested-browsing-context>nested browsing contexts</a> in it.</p>

    <p class=example>The <code id=printing:event-beforeprint-3><a href=#event-beforeprint>beforeprint</a></code> event can be used to
    annotate the printed copy, for instance adding the time at which the document was printed.</p>

   <li>

    <p>The user agent should offer the user the opportunity to <a href=#obtain-a-physical-form id=printing:obtain-a-physical-form-2>obtain a physical form</a>
    (or the representation of a physical form) of the document. The user agent may wait for the user
    to either accept or decline before returning; if so, the user agent must <a href=#pause id=printing:pause>pause</a>
    while the method is waiting. Even if the user agent doesn't wait at this point, the user agent
    must use the state of the relevant documents as they are at this point in the algorithm if and
    when it eventually creates the alternate form.</p>

   <li>

    <p>The user agent must <a href=https://dom.spec.whatwg.org/#concept-event-fire id=printing:concept-event-fire-2 data-x-internal=concept-event-fire>fire an event</a> named <code id=printing:event-afterprint-2><a href=#event-afterprint>afterprint</a></code> at the <code id=printing:window-3><a href=#window>Window</a></code> object of the
    <code id=printing:document-5><a href=#document>Document</a></code> that is being printed, as well as any <a href=#nested-browsing-context id=printing:nested-browsing-context-2>nested browsing contexts</a> in it.</p>

    <p class=example>The <code id=printing:event-afterprint-3><a href=#event-afterprint>afterprint</a></code> event can be used to
    revert annotations added in the earlier event, as well as showing post-printing UI. For
    instance, if a page is walking the user through the steps of applying for a home loan, the
    script could automatically advance to the next step after having printed a form or other.</p>

   </ol>

  


  <h3 id=system-state-and-capabilities>8.7 System state and capabilities<a href=#system-state-and-capabilities class=self-link></a></h3>

  <h4 id=the-navigator-object>8.7.1 The <code id=the-navigator-object:navigator><a href=#navigator>Navigator</a></code> object<a href=#the-navigator-object class=self-link></a></h4>

  

  <p>The <dfn id=dom-navigator><code>navigator</code></dfn> attribute of the
  <code id=the-navigator-object:window><a href=#window>Window</a></code> interface must return an instance of the <code id=the-navigator-object:navigator-2><a href=#navigator>Navigator</a></code> interface,
  which represents the identity and state of the user agent (the client), and allows Web pages to
  register themselves as potential protocol and content handlers:</p>

  

  <pre class=idl>interface <dfn id=navigator>Navigator</dfn> {
  // objects implementing this interface also implement the interfaces given below
};
<a href=#navigator id=the-navigator-object:navigator-3>Navigator</a> implements <a href=#navigatorid id=the-navigator-object:navigatorid>NavigatorID</a>;
<a href=#navigator id=the-navigator-object:navigator-4>Navigator</a> implements <a href=#navigatorlanguage id=the-navigator-object:navigatorlanguage>NavigatorLanguage</a>;
<a href=#navigator id=the-navigator-object:navigator-5>Navigator</a> implements <a href=#navigatoronline id=the-navigator-object:navigatoronline>NavigatorOnLine</a>;
<a href=#navigator id=the-navigator-object:navigator-6>Navigator</a> implements <a href=#navigatorcontentutils id=the-navigator-object:navigatorcontentutils>NavigatorContentUtils</a>;
<a href=#navigator id=the-navigator-object:navigator-7>Navigator</a> implements <a href=#navigatorcookies id=the-navigator-object:navigatorcookies>NavigatorCookies</a>;
<a href=#navigator id=the-navigator-object:navigator-8>Navigator</a> implements <a href=#navigatorplugins id=the-navigator-object:navigatorplugins>NavigatorPlugins</a>;
<a href=#navigator id=the-navigator-object:navigator-9>Navigator</a> implements <a href=#navigatorconcurrenthardware id=the-navigator-object:navigatorconcurrenthardware>NavigatorConcurrentHardware</a>;</pre>



  

  <p>These interfaces are defined separately so that <code id=the-navigator-object:workernavigator><a href=#workernavigator>WorkerNavigator</a></code> can re-use parts
  of the <code id=the-navigator-object:navigator-10><a href=#navigator>Navigator</a></code> interface.</p>

  


  <h5 id=client-identification>8.7.1.1 Client identification<a href=#client-identification class=self-link></a></h5>

  <pre class=idl>[NoInterfaceObject, Exposed=(Window,Worker)]
interface <dfn id=navigatorid>NavigatorID</dfn> {
  readonly attribute DOMString <a href=#dom-navigator-appcodename id=client-identification:dom-navigator-appcodename>appCodeName</a>; // constant "Mozilla"
  readonly attribute DOMString <a href=#dom-navigator-appname id=client-identification:dom-navigator-appname>appName</a>; // constant "Netscape"
  readonly attribute DOMString <a href=#dom-navigator-appversion id=client-identification:dom-navigator-appversion>appVersion</a>;
  readonly attribute DOMString <a href=#dom-navigator-platform id=client-identification:dom-navigator-platform>platform</a>;
  readonly attribute DOMString <a href=#dom-navigator-product id=client-identification:dom-navigator-product>product</a>; // constant "Gecko"
  [Exposed=Window] readonly attribute DOMString <a href=#dom-navigator-productsub id=client-identification:dom-navigator-productsub>productSub</a>;
  readonly attribute DOMString <a href=#dom-navigator-useragent id=client-identification:dom-navigator-useragent>userAgent</a>;
  [Exposed=Window] readonly attribute DOMString <a href=#dom-navigator-vendor id=client-identification:dom-navigator-vendor>vendor</a>;
  [Exposed=Window] readonly attribute DOMString <a href=#dom-navigator-vendorsub id=client-identification:dom-navigator-vendorsub>vendorSub</a>; // constant ""

  // <a href="#NavigatorID-partial">also has additional members in a partial interface</a>
};</pre>

  <p>In certain cases, despite the best efforts of the entire industry, Web browsers have bugs and
  limitations that Web authors are forced to work around.</p>

  <p>This section defines a collection of attributes that can be used to determine, from script, the
  kind of user agent in use, in order to work around these issues.</p>

  

  <p>The user agent has a <dfn id=concept-navigator-compatibility-mode>navigator compatibility
  mode</dfn>, which is either <i>Chrome</i>, <i>Gecko</i>, or <i>WebKit</i>.</p>

  <p class=note>The <a href=#concept-navigator-compatibility-mode id=client-identification:concept-navigator-compatibility-mode>navigator compatibility
  mode</a> constrains the <a href=#navigatorid id=client-identification:navigatorid>NavigatorID</a> interface to the combinations of attribute
  values and presence of <code id=client-identification:dom-navigator-taintenabled><a href=#dom-navigator-taintenabled>taintEnabled()</a></code> and <code id=client-identification:dom-navigator-oscpu><a href=#dom-navigator-oscpu>oscpu</a></code> that are known to be compatible with existing Web
  content.</p>

  

  <p>Client detection should always be limited to detecting known current versions; future versions
  and unknown versions should always be assumed to be fully compliant.</p>

  <dl class=domintro><dt><var>window</var> . <code id=client-identification:dom-navigator><a href=#dom-navigator>navigator</a></code> . <code id=client-identification:dom-navigator-appcodename-2><a href=#dom-navigator-appcodename>appCodeName</a></code><dd>
    <p>Returns the string "<code>Mozilla</code>".</p>
   <dt><var>window</var> . <code id=client-identification:dom-navigator-2><a href=#dom-navigator>navigator</a></code> . <code id=client-identification:dom-navigator-appname-2><a href=#dom-navigator-appname>appName</a></code><dd>
    <p>Returns the string "<code>Netscape</code>".</p>
   <dt><var>window</var> . <code id=client-identification:dom-navigator-3><a href=#dom-navigator>navigator</a></code> . <code id=client-identification:dom-navigator-appversion-2><a href=#dom-navigator-appversion>appVersion</a></code><dd>
    <p>Returns the version of the browser.</p>
   <dt><var>window</var> . <code id=client-identification:dom-navigator-4><a href=#dom-navigator>navigator</a></code> . <code id=client-identification:dom-navigator-platform-2><a href=#dom-navigator-platform>platform</a></code><dd>
    <p>Returns the name of the platform.</p>
   <dt><var>window</var> . <code id=client-identification:dom-navigator-5><a href=#dom-navigator>navigator</a></code> . <code id=client-identification:dom-navigator-product-2><a href=#dom-navigator-product>product</a></code><dd>
    <p>Returns the string "<code>Gecko</code>".</p>
   <dt><var>window</var> . <code id=client-identification:dom-navigator-6><a href=#dom-navigator>navigator</a></code> . <code id=client-identification:dom-navigator-productsub-2><a href=#dom-navigator-productsub>productSub</a></code><dd>
    <p>Returns either the string "<code>20030107</code>", or the string "<code>20100101</code>".</p>
   <dt><var>window</var> . <code id=client-identification:dom-navigator-7><a href=#dom-navigator>navigator</a></code> . <code id=client-identification:dom-navigator-useragent-2><a href=#dom-navigator-useragent>userAgent</a></code><dd>
    <p>Returns the complete `<code>User-Agent</code>` header.</p>
   <dt><var>window</var> . <code id=client-identification:dom-navigator-8><a href=#dom-navigator>navigator</a></code> . <code id=client-identification:dom-navigator-vendor-2><a href=#dom-navigator-vendor>vendor</a></code><dd>
    <p>Returns either the empty string, the string "<code>Apple Computer, Inc.</code>", or
    the string "<code>Google Inc.</code>".</p>
   <dt><var>window</var> . <code id=client-identification:dom-navigator-9><a href=#dom-navigator>navigator</a></code> . <code id=client-identification:dom-navigator-vendorsub-2><a href=#dom-navigator-vendorsub>vendorSub</a></code><dd>
    <p>Returns the empty string.</p>
   </dl>

  

  <dl><dt><dfn id=dom-navigator-appcodename><code>appCodeName</code></dfn><dd><p>Must return the string "<code>Mozilla</code>".<dt><dfn id=dom-navigator-appname><code>appName</code></dfn><dd><p>Must return the string "<code>Netscape</code>".<dt><dfn id=dom-navigator-appversion><code>appVersion</code></dfn><dd><p>Must return either the string "<code>4.0</code>" or a string representing the
   version of the browser in detail, e.g. "<code>1.0 (VMS; en-US)
   Mellblomenator/9000</code>".<dt><dfn id=dom-navigator-platform><code>platform</code></dfn><dd><p>Must return either the empty string or a string representing the platform on which the
   browser is executing, e.g. "<code>MacIntel</code>", "<code>Win32</code>",
   "<code>FreeBSD i386</code>", "<code>WebTV OS</code>".<dt><dfn id=dom-navigator-product><code>product</code></dfn><dd><p>Must return the string "<code>Gecko</code>".<dt><dfn id=dom-navigator-productsub><code>productSub</code></dfn><dd>

    <p>Must return the appropriate string from the following list:</p>

    <dl class=switch><dt>If the <a href=#concept-navigator-compatibility-mode id=client-identification:concept-navigator-compatibility-mode-2>navigator compatibility
     mode</a> is <i>Chrome</i> or <i>WebKit</i><dd><p>The string "<code>20030107</code>".<dt>If the <a href=#concept-navigator-compatibility-mode id=client-identification:concept-navigator-compatibility-mode-3>navigator compatibility
     mode</a> is <i>Gecko</i><dd><p>The string "<code>20100101</code>".</dl>

   <dt><dfn id=dom-navigator-useragent><code>userAgent</code></dfn><dd><p>Must return the <a href=https://fetch.spec.whatwg.org/#default-user-agent-value id=client-identification:default-user-agent-value data-x-internal=default-user-agent-value>default `<code>User-Agent</code>`
   value</a>.<dt><dfn id=dom-navigator-vendor><code>vendor</code></dfn><dd>

    <p>Must return the appropriate string from the following list:</p>

    <dl class=switch><dt>If the <a href=#concept-navigator-compatibility-mode id=client-identification:concept-navigator-compatibility-mode-4>navigator compatibility
     mode</a> is <i>Chrome</i><dd><p>The string "<code>Google Inc.</code>".<dt>If the <a href=#concept-navigator-compatibility-mode id=client-identification:concept-navigator-compatibility-mode-5>navigator compatibility
     mode</a> is <i>Gecko</i><dd><p>The empty string.<dt>If the <a href=#concept-navigator-compatibility-mode id=client-identification:concept-navigator-compatibility-mode-6>navigator compatibility
     mode</a> is <i>WebKit</i><dd><p>The string "<code>Apple Computer, Inc.</code>".</dl>

   <dt><dfn id=dom-navigator-vendorsub><code>vendorSub</code></dfn><dd><p>Must return the empty string.</dl>

  <p>If the <a href=#concept-navigator-compatibility-mode id=client-identification:concept-navigator-compatibility-mode-7>navigator compatibility mode</a>
  is <i>Gecko</i>, then the user agent must also support the following partial interface:</p>

  <pre class=idl>partial interface <a href=#navigatorid id=NavigatorID-partial>NavigatorID</a> {
  [Exposed=Window] boolean <a href=#dom-navigator-taintenabled id=client-identification:dom-navigator-taintenabled-2>taintEnabled</a>(); // constant false
  [Exposed=Window] readonly attribute DOMString <a href=#dom-navigator-oscpu id=client-identification:dom-navigator-oscpu-2>oscpu</a>;
};</pre>

  <p>The <dfn id=dom-navigator-taintenabled><code>taintEnabled()</code></dfn> method must
  return false.</p>

  <p>The <dfn id=dom-navigator-oscpu><code>oscpu</code></dfn> attribute's getter must return
  either the empty string or a string representing the platform on which the browser is executing,
  e.g. "<code>Windows NT 10.0; Win64; x64</code>", "<code>Linux
  x86_64</code>".</p>

  
  <p class=warning>Any information in this API that varies from user to user can be used to
  profile the user. In fact, if enough such information is available, a user can actually be
  uniquely identified. For this reason, user agent implementors are strongly urged to include as
  little information in this API as possible.
  <a href=#fingerprinting-vector id=client-identification:fingerprinting-vector class=fingerprint title="There is a potential fingerprinting vector here."><img alt="(This is a fingerprinting vector.)" src=/images/fingerprint.png width=46 height=64></a>
  </p>

  

  

  <h5 id=language-preferences>8.7.1.2 Language preferences<a href=#language-preferences class=self-link></a></h5>

  <pre class=idl>[NoInterfaceObject, Exposed=(Window,Worker)]
interface <dfn id=navigatorlanguage>NavigatorLanguage</dfn> {
  readonly attribute DOMString <a href=#dom-navigator-language id=language-preferences:dom-navigator-language>language</a>;
  readonly attribute FrozenArray&lt;DOMString> <a href=#dom-navigator-languages id=language-preferences:dom-navigator-languages>languages</a>;
};</pre>

  <dl class=domintro><dt><var>window</var> . <code id=language-preferences:dom-navigator><a href=#dom-navigator>navigator</a></code> . <code id=language-preferences:dom-navigator-language-2><a href=#dom-navigator-language>language</a></code><dd>
    <p>Returns a language tag representing the user's preferred language.</p>
   <dt><var>window</var> . <code id=language-preferences:dom-navigator-2><a href=#dom-navigator>navigator</a></code> . <code id=language-preferences:dom-navigator-languages-2><a href=#dom-navigator-languages>languages</a></code><dd>
    <p>Returns an array of language tags representing the user's preferred languages, with the most preferred language first.</p>
    <p>The most preferred language is the one returned by <code id=language-preferences:dom-navigator-language-3><a href=#dom-navigator-language>navigator.language</a></code>.</p>
   </dl>

  <p class=note>A <code id=language-preferences:event-languagechange><a href=#event-languagechange>languagechange</a></code> event is fired at the
  <code id=language-preferences:window><a href=#window>Window</a></code> or <code id=language-preferences:workerglobalscope><a href=#workerglobalscope>WorkerGlobalScope</a></code> object when the user agent's understanding
  of what the user's preferred languages are changes.</p>

  

  <dl><dt><dfn id=dom-navigator-language><code>language</code></dfn><dd><p>Must return a valid BCP 47 language tag representing either <a href=#a-plausible-language id=language-preferences:a-plausible-language>a plausible
   language</a> or the user's most preferred language. <a href=#refsBCP47>[BCP47]</a><dt><dfn id=dom-navigator-languages><code>languages</code></dfn><dd>

    <p>Must return a <a id=language-preferences:frozen-array href=https://heycam.github.io/webidl/#dfn-frozen-array-type data-x-internal=frozen-array>frozen array</a> of valid BCP 47 language tags representing either one
    or more <a href=#a-plausible-language id=language-preferences:a-plausible-language-2>plausible languages</a>, or the user's preferred
    languages, ordered by preference with the most preferred language first. The same object must be
    returned until the user agent needs to return different values, or values in a different order.
    <a href=#refsBCP47>[BCP47]</a></p>

    <p>Whenever the user agent needs to make the <code id=language-preferences:dom-navigator-languages-3><a href=#dom-navigator-languages>navigator.languages</a></code> attribute of a <code id=language-preferences:window-2><a href=#window>Window</a></code>
    or <code id=language-preferences:workerglobalscope-2><a href=#workerglobalscope>WorkerGlobalScope</a></code> object return a new set of language tags, the user agent must
    <a href=#queue-a-task id=language-preferences:queue-a-task>queue a task</a> to <a href=https://dom.spec.whatwg.org/#concept-event-fire id=language-preferences:concept-event-fire data-x-internal=concept-event-fire>fire an event</a> named <code id=language-preferences:event-languagechange-2><a href=#event-languagechange>languagechange</a></code> at the <code id=language-preferences:window-3><a href=#window>Window</a></code> or
    <code id=language-preferences:workerglobalscope-3><a href=#workerglobalscope>WorkerGlobalScope</a></code> object and wait until that task begins to be executed before
    actually returning a new value.</p>

    <p>The <a href=#task-source id=language-preferences:task-source>task source</a> for this <a href=#concept-task id=language-preferences:concept-task>task</a> is the
    <a href=#dom-manipulation-task-source id=language-preferences:dom-manipulation-task-source>DOM manipulation task source</a>.</p>

   </dl>

  <p>To determine <dfn id=a-plausible-language>a plausible language</dfn>, the user agent should bear in mind the following:</p>

  <ul><li>Any information in this API that varies from user to user can be used to profile or identify
   the user.
   <a href=#fingerprinting-vector id=language-preferences:fingerprinting-vector class=fingerprint title="There is a potential fingerprinting vector here."><img alt="(This is a fingerprinting vector.)" src=/images/fingerprint.png width=46 height=64></a>
   <li>If the user is not using a service that obfuscates the user's point of origin (e.g. the Tor
   anonymity network), then the value that is least likely to distinguish the user from other users
   with similar origins (e.g. from the same IP address block) is the language used by the majority
   of such users. <a href=#refsTOR>[TOR]</a><li>If the user is using an anonymizing service, then the value "<code>en-US</code>" is
   suggested; if all users of the service use that same value, that reduces the possibility of
   distinguishing the users from each other.</ul>

  <p>To avoid introducing any more fingerprinting vectors, user agents should use the same list for
  the APIs defined in this function as for the HTTP `<code id=language-preferences:http-accept-language><a data-x-internal=http-accept-language href=https://tools.ietf.org/html/rfc7231#section-5.3.5>Accept-Language</a></code>` header.
  <a href=#fingerprinting-vector id=language-preferences:fingerprinting-vector-2 class=fingerprint title="There is a potential fingerprinting vector here."><img alt="(This is a fingerprinting vector.)" src=/images/fingerprint.png width=46 height=64></a>
  </p>

  



  <h5 id=custom-handlers>8.7.1.3 Custom scheme and content handlers: the <code id=custom-handlers:dom-navigator-registerprotocolhandler><a href=#dom-navigator-registerprotocolhandler>registerProtocolHandler()</a></code> and <code id=custom-handlers:dom-navigator-registercontenthandler><a href=#dom-navigator-registercontenthandler>registerContentHandler()</a></code> methods<a href=#custom-handlers class=self-link></a></h5><div class=status><input onclick=toggleStatus(this) value= type=button><p class=support><strong>Support:</strong> registerprotocolhandler<span class="and_chr no"><span>Chrome for Android</span> <span>None</span></span><span class="chrome yes"><span>Chrome</span> <span>13+</span></span><span class="ios_saf no"><span>iOS Safari</span> <span>None</span></span><span class="and_uc no"><span>UC Browser for Android</span> <span>None</span></span><span class="firefox yes"><span>Firefox</span> <span>3+</span></span><span class="ie no"><span>IE</span> <span>None</span></span><span class="samsung no"><span>Samsung Internet</span> <span>None</span></span><span class="op_mini no"><span>Opera Mini</span> <span>None</span></span><span class="android no"><span>Android Browser</span> <span>None</span></span><span class="safari no"><span>Safari</span> <span>None</span></span><span class="edge no"><span>Edge</span> <span>None</span></span><span class="opera yes"><span>Opera</span> <span>11.6+</span></span><p class=caniuse>Source: <a href="http://caniuse.com/#feat=registerprotocolhandler">caniuse.com</a></div>

  <pre class=idl>[NoInterfaceObject]
interface <dfn id=navigatorcontentutils>NavigatorContentUtils</dfn> {
  // content handler registration
  void <a href=#dom-navigator-registerprotocolhandler id=custom-handlers:dom-navigator-registerprotocolhandler-2>registerProtocolHandler</a>(DOMString scheme, USVString url, DOMString title);
  void <a href=#dom-navigator-registercontenthandler id=custom-handlers:dom-navigator-registercontenthandler-2>registerContentHandler</a>(DOMString mimeType, USVString url, DOMString title);
  DOMString <a href=#dom-navigator-isprotocolhandlerregistered id=custom-handlers:dom-navigator-isprotocolhandlerregistered>isProtocolHandlerRegistered</a>(DOMString scheme, USVString url);
  DOMString <a href=#dom-navigator-iscontenthandlerregistered id=custom-handlers:dom-navigator-iscontenthandlerregistered>isContentHandlerRegistered</a>(DOMString mimeType, USVString url);
  void <a href=#dom-navigator-unregisterprotocolhandler id=custom-handlers:dom-navigator-unregisterprotocolhandler>unregisterProtocolHandler</a>(DOMString scheme, USVString url);
  void <a href=#dom-navigator-unregistercontenthandler id=custom-handlers:dom-navigator-unregistercontenthandler>unregisterContentHandler</a>(DOMString mimeType, USVString url);
};</pre>

  <p>The <dfn id=dom-navigator-registerprotocolhandler><code>registerProtocolHandler()</code></dfn> method
  allows Web sites to register themselves as possible handlers for particular schemes. For example,
  an online telephone messaging service could register itself as a handler of the <code id=custom-handlers:sms-protocol><a data-x-internal=sms-protocol href=https://tools.ietf.org/html/rfc5724#section-2>sms:</a></code> scheme, so that if the user clicks on such a link, they are given the
  opportunity to use that Web site. Analogously, the <dfn id=dom-navigator-registercontenthandler><code>registerContentHandler()</code></dfn> method allows
  Web sites to register themselves as possible handlers for content in a particular <a id=custom-handlers:mime-type href=https://mimesniff.spec.whatwg.org/#mime-type data-x-internal=mime-type>MIME
  type</a>. For example, the same online telephone messaging service could register itself as a
  handler for <code id=custom-handlers:text/vcard><a href=#text/vcard>text/vcard</a></code> files, so that if the user has no native application capable
  of handling vCards, their Web browser can instead suggest they use that site to view contact
  information stored on vCards that they open. <a href=#refsSMS>[SMS]</a> <a href=#refsRFC6350>[RFC6350]</a></p>

  <dl class=domintro><dt><var>window</var> . <code id=custom-handlers:dom-navigator><a href=#dom-navigator>navigator</a></code> . <code id=custom-handlers:dom-navigator-registerprotocolhandler-3><a href=#dom-navigator-registerprotocolhandler>registerProtocolHandler</a></code>(<var>scheme</var>, <var>url</var>, <var>title</var>)<dt><var>window</var> . <code id=custom-handlers:dom-navigator-2><a href=#dom-navigator>navigator</a></code> . <code id=custom-handlers:dom-navigator-registercontenthandler-3><a href=#dom-navigator-registercontenthandler>registerContentHandler</a></code>(<var>mimeType</var>, <var>url</var>, <var>title</var>)<dd>

    <p>Registers a handler for the given scheme or content type, at the given URL, with the given
    title.</p>

    <p>The string "<code>%s</code>" in the URL is used as a placeholder for where to put
    the URL of the content to be handled.</p>

    <p>Throws a <a id=custom-handlers:securityerror href=https://heycam.github.io/webidl/#securityerror data-x-internal=securityerror>"<code>SecurityError</code>"</a> <code id=custom-handlers:domexception><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> if the user
    agent blocks the registration (this might happen if trying to register as a handler for "http",
    for instance).</p>

    <p>Throws a <a id=custom-handlers:syntaxerror href=https://heycam.github.io/webidl/#syntaxerror data-x-internal=syntaxerror>"<code>SyntaxError</code>"</a> <code id=custom-handlers:domexception-2><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> if the "<code>%s</code>" string is missing in the URL.</p>

   </dl>

  

  <p>User agents may, within the constraints described in this section, do whatever they like when
  the methods are called. A UA could, for instance, prompt the user and offer the user the
  opportunity to add the site to a shortlist of handlers, or make the handlers their default, or
  cancel the request. UAs could provide such a UI through modal UI or through a non-modal transient
  notification interface. UAs could also simply silently collect the information, providing it only
  when relevant to the user.</p>

  <p>User agents should keep track of which sites have registered handlers (even if the user has
  declined such registrations) so that the user is not repeatedly prompted with the same
  request.</p>

  <p>The arguments to the methods have the following meanings and corresponding implementation
  requirements. The requirements that involve throwing exceptions must be processed in the order
  given below, stopping at the first exception thrown. (So the exceptions for the first argument
  take precedence over the exceptions for the second argument.)</p>

  <dl><dt><var>scheme</var> (<code id=custom-handlers:dom-navigator-registerprotocolhandler-4><a href=#dom-navigator-registerprotocolhandler>registerProtocolHandler()</a></code> only)<dd>

    <p>A scheme, such as "<code>mailto</code>" or "<code>web+auth</code>". The
    scheme must be compared in an <a id=custom-handlers:ascii-case-insensitive href=https://infra.spec.whatwg.org/#ascii-case-insensitive data-x-internal=ascii-case-insensitive>ASCII case-insensitive</a> manner by user agents for the
    purposes of comparing with the scheme part of URLs that they consider against the list of
    registered handlers.</p>

    <p>The <var>scheme</var> value, if it contains a colon (as in "<code>mailto:</code>"),
    will never match anything, since schemes don't contain colons.</p>

    <p>If the <code id=custom-handlers:dom-navigator-registerprotocolhandler-5><a href=#dom-navigator-registerprotocolhandler>registerProtocolHandler()</a></code>
    method is invoked with a scheme that is neither a <a href=#safelisted-scheme id=custom-handlers:safelisted-scheme>safelisted scheme</a> nor a scheme
    whose value starts with the substring "<code>web+</code>" and otherwise contains only
    <a href=#lowercase-ascii-letters id=custom-handlers:lowercase-ascii-letters>lowercase ASCII letters</a>, and whose length is at least five characters (including
    the "<code>web+</code>" prefix), the user agent must throw a
    <a id=custom-handlers:securityerror-2 href=https://heycam.github.io/webidl/#securityerror data-x-internal=securityerror>"<code>SecurityError</code>"</a> <code id=custom-handlers:domexception-3><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code>.</p>

    <p>The following schemes are the <dfn id=safelisted-scheme>safelisted schemes</dfn>:</p>

    <ul class=brief><li><code>bitcoin</code><li><code>geo</code><li><code>im</code><li><code>irc</code><li><code>ircs</code><li><code>magnet</code><li><code>mailto</code><li><code>mms</code><li><code>news</code><li><code>nntp</code><li><code>openpgp4fpr</code><li><code>sip</code><li><code>sms</code><li><code>smsto</code><li><code>ssh</code><li><code>tel</code><li><code>urn</code><li><code>webcal</code><li><code>wtai</code><li><code>xmpp</code></ul>

    <p class=note>This list can be changed. If there are schemes that should be added, please send
    feedback.</p>

    <p class=note>This list excludes any schemes that could reasonably be expected to be supported
    inline, e.g. in an <code id=custom-handlers:the-iframe-element><a href=#the-iframe-element>iframe</a></code>, such as <code>http</code> or (more
    theoretically) <code>gopher</code>. If those were supported, they could potentially be
    used in man-in-the-middle attacks, by replacing pages that have frames with such content with
    content under the control of the protocol handler. If the user agent has native support for the
    schemes, this could further be used for cookie-theft attacks.</p>

   <dt><var>mimeType</var> (<code id=custom-handlers:dom-navigator-registercontenthandler-4><a href=#dom-navigator-registercontenthandler>registerContentHandler()</a></code> only)<dd>

    <p>A <a id=custom-handlers:mime-type-2 href=https://mimesniff.spec.whatwg.org/#mime-type data-x-internal=mime-type>MIME type</a>, such as <code>model/vnd.flatland.3dml</code> or <code>application/vnd.google-earth.kml+xml</code>. The <a id=custom-handlers:mime-type-3 href=https://mimesniff.spec.whatwg.org/#mime-type data-x-internal=mime-type>MIME type</a> must be
    compared in an <a id=custom-handlers:ascii-case-insensitive-2 href=https://infra.spec.whatwg.org/#ascii-case-insensitive data-x-internal=ascii-case-insensitive>ASCII case-insensitive</a> manner by user agents for the purposes of
    comparing with MIME types of documents that they consider against the list of registered
    handlers.</p>

    <p>User agents must compare the given values only to the MIME type/subtype parts of content
    types, not to the complete type including parameters. Thus, if <var>mimeType</var>
    values passed to this method include characters such as commas or whitespace, or include MIME
    parameters, then the handler being registered will never be used.</p>

    <p class=note>The type is compared to the <a id=custom-handlers:mime-type-4 href=https://mimesniff.spec.whatwg.org/#mime-type data-x-internal=mime-type>MIME type</a> used by the user agent
    <em>after</em> the sniffing algorithms have been applied.</p>

    <p>If the <code id=custom-handlers:dom-navigator-registercontenthandler-5><a href=#dom-navigator-registercontenthandler>registerContentHandler()</a></code>
    method is invoked with a <a id=custom-handlers:mime-type-5 href=https://mimesniff.spec.whatwg.org/#mime-type data-x-internal=mime-type>MIME type</a> that is in the <a href=#type-blocklist id=custom-handlers:type-blocklist>type blocklist</a> or
    that the user agent has deemed a privileged type, the user agent must throw a
    <a id=custom-handlers:securityerror-3 href=https://heycam.github.io/webidl/#securityerror data-x-internal=securityerror>"<code>SecurityError</code>"</a> <code id=custom-handlers:domexception-4><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code>.</p>

    <p>The following <a href=https://mimesniff.spec.whatwg.org/#mime-type id=custom-handlers:mime-type-6 data-x-internal=mime-type>MIME types</a> are in the <dfn id=type-blocklist>type
    blocklist</dfn>:</p>

    <ul class=brief><li><code id=custom-handlers:application/x-www-form-urlencoded><a data-x-internal=application/x-www-form-urlencoded href=https://url.spec.whatwg.org/#concept-urlencoded>application/x-www-form-urlencoded</a></code><li><code id=custom-handlers:application/xhtml+xml><a href=#application/xhtml+xml>application/xhtml+xml</a></code><li><code id=custom-handlers:application/xml><a href=#application/xml>application/xml</a></code><li><code id=custom-handlers:image/gif><a href=#image/gif>image/gif</a></code><li><code id=custom-handlers:image/jpeg><a href=#image/jpeg>image/jpeg</a></code><li><code id=custom-handlers:image/png><a href=#image/png>image/png</a></code><li><code id=custom-handlers:image/svg+xml><a href=#image/svg+xml>image/svg+xml</a></code><li><code id=custom-handlers:multipart/x-mixed-replace><a href=#multipart/x-mixed-replace>multipart/x-mixed-replace</a></code><li><code id=custom-handlers:text/cache-manifest><a href=#text/cache-manifest>text/cache-manifest</a></code><li><code id=custom-handlers:text/css><a href=#text/css>text/css</a></code><li><code id=custom-handlers:text/html><a href=#text/html>text/html</a></code><li><code id=custom-handlers:text/ping><a href=#text/ping>text/ping</a></code><li><code id=custom-handlers:text/plain><a data-x-internal=text/plain href=https://tools.ietf.org/html/rfc2046#section-4.1.3>text/plain</a></code><li><code id=custom-handlers:text/vtt><a href=#text/vtt>text/vtt</a></code><li><code id=custom-handlers:text/xml><a href=#text/xml>text/xml</a></code><li>All types that the user agent supports displaying natively in a <a href=#browsing-context id=custom-handlers:browsing-context>browsing context</a> during <a href=#navigate id=custom-handlers:navigate>navigation</a>, except for <code id=custom-handlers:application/rss+xml><a href=#application/rss+xml>application/rss+xml</a></code> and <code id=custom-handlers:application/atom+xml><a href=#application/atom+xml>application/atom+xml</a></code></ul>

    <p class=note>This list can be changed. If there are MIME types that should be added, please
    send feedback.</p>

   <dt><var>url</var><dd>

    <p>A string used to build the <a id=custom-handlers:url href=https://url.spec.whatwg.org/#concept-url data-x-internal=url>URL</a> of the page that will handle the requests.</p>

    <p>User agents must throw a <a id=custom-handlers:syntaxerror-2 href=https://heycam.github.io/webidl/#syntaxerror data-x-internal=syntaxerror>"<code>SyntaxError</code>"</a> <code id=custom-handlers:domexception-5><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> if
    the <var>url</var> argument passed to one of these methods does not contain the exact literal
    string "<code>%s</code>".</p>

    <p>User agents must throw a <a id=custom-handlers:syntaxerror-3 href=https://heycam.github.io/webidl/#syntaxerror data-x-internal=syntaxerror>"<code>SyntaxError</code>"</a> <code id=custom-handlers:domexception-6><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> if
    <a href=#parse-a-url id=custom-handlers:parse-a-url>parsing</a> the <var>url</var> argument relative to the
    <a href=#relevant-settings-object id=custom-handlers:relevant-settings-object>relevant settings object</a> of this <code id=custom-handlers:navigatorcontentutils><a href=#navigatorcontentutils>NavigatorContentUtils</a></code> object is not
    successful.</p>

    <p class=note>The <a href=#resulting-url-string id=custom-handlers:resulting-url-string>resulting URL string</a> would by definition not be a <a href=#valid-url id=custom-handlers:valid-url>valid
    URL</a> as it would include the string "<code>%s</code>" which is not a valid
    component in a URL.</p>

    <p>User agents must throw a <a id=custom-handlers:securityerror-4 href=https://heycam.github.io/webidl/#securityerror data-x-internal=securityerror>"<code>SecurityError</code>"</a> <code id=custom-handlers:domexception-7><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code>
    if the <a href=#resulting-url-record id=custom-handlers:resulting-url-record>resulting URL record</a> has an <a href=https://url.spec.whatwg.org/#concept-url-origin id=custom-handlers:concept-url-origin data-x-internal=concept-url-origin>origin</a>
    that differs from the <a href=#concept-settings-object-origin id=custom-handlers:concept-settings-object-origin>origin</a> specified by
    the <a href=#relevant-settings-object id=custom-handlers:relevant-settings-object-2>relevant settings object</a> of this <code id=custom-handlers:navigatorcontentutils-2><a href=#navigatorcontentutils>NavigatorContentUtils</a></code> object.</p>

    <p class=note>This is forcibly the case if the <code>%s</code> placeholder is in the
    scheme, host, or port parts of the URL.</p>

    <p>The <a href=#resulting-url-string id=custom-handlers:resulting-url-string-2>resulting URL string</a> is the <dfn id=proto-url>proto-URL</dfn>. It identifies the
    handler for the purposes of the methods described below.</p>

    <p>When the user agent uses this handler, it must replace the first occurrence of the exact
    literal string "<code>%s</code>" in the <var>url</var> argument with an
    escaped version of the <a id=custom-handlers:absolute-url href=https://url.spec.whatwg.org/#syntax-url-absolute data-x-internal=absolute-url>absolute URL</a> of the content in question (as defined below),
    then <a href=#parse-a-url id=custom-handlers:parse-a-url-2>parse</a> the resulting URL, relative to the <a href=#relevant-settings-object id=custom-handlers:relevant-settings-object-3>relevant
    settings object</a> of the <code id=custom-handlers:navigatorcontentutils-3><a href=#navigatorcontentutils>NavigatorContentUtils</a></code> object on which the <code id=custom-handlers:dom-navigator-registercontenthandler-6><a href=#dom-navigator-registercontenthandler>registerContentHandler()</a></code> or <code id=custom-handlers:dom-navigator-registerprotocolhandler-6><a href=#dom-navigator-registerprotocolhandler>registerProtocolHandler()</a></code> method was
    invoked, and then <a href=#navigate id=custom-handlers:navigate-2>navigate</a> an appropriate <a href=#browsing-context id=custom-handlers:browsing-context-2>browsing
    context</a> to the resulting URL.</p>

    <p>To get the escaped version of the <a id=custom-handlers:absolute-url-2 href=https://url.spec.whatwg.org/#syntax-url-absolute data-x-internal=absolute-url>absolute URL</a> of the content in question, the
    user agent must replace every character in that <a id=custom-handlers:absolute-url-3 href=https://url.spec.whatwg.org/#syntax-url-absolute data-x-internal=absolute-url>absolute URL</a> that is not a
    character in the URL <a id=custom-handlers:default-encode-set href=https://url.spec.whatwg.org/#default-encode-set data-x-internal=default-encode-set>default encode set</a> with the result of <a href=https://url.spec.whatwg.org/#utf-8-percent-encode id=custom-handlers:utf-8-percent-encode data-x-internal=utf-8-percent-encode>UTF-8 percent encoding</a> that character.</p>

    <div class=example>

     <p>If the user had visited a site at <code>https://example.com/</code> that made the
     following call:</p>

     <pre>navigator.registerContentHandler('application/x-soup', 'soup?url=%s', 'SoupWeb')</pre>

     <p>...and then, much later, while visiting <code>https://www.example.net/</code>,
     clicked on a link such as:</p>

     <pre>&lt;a href="chickenkwi.soup">Download our Chicken Kwi soup!&lt;/a></pre>

     <p>...then, assuming this <code>chickenkwi.soup</code> file was served with the
     <a id=custom-handlers:mime-type-7 href=https://mimesniff.spec.whatwg.org/#mime-type data-x-internal=mime-type>MIME type</a> <code>application/x-soup</code>, the UA might navigate to the
     following URL:</p>

     <pre>https://example.com/soup?url=https://www.example.net/chickenk%C3%AFwi.soup</pre>

     <p>This site could then fetch the <code>chickenkwi.soup</code> file and do
     whatever it is that it does with soup (synthesize it and ship it to the user, or whatever).</p>

    </div>

   <dt><var>title</var><dd>

    <p>A descriptive title of the handler, which the UA might use to remind the user what the site
    in question is.</p>

   </dl>

  <p>This section does not define how the pages registered by these methods are used, beyond the
  requirements on how to process the <var>url</var> value (see above). To some extent, the
  <a href=#navigate id=custom-handlers:navigate-3>processing model for navigating across documents</a> defines some cases
  where these methods are relevant, but in general UAs may use this information wherever they would
  otherwise consider handing content to native plugins or helper applications.</p>

  <p>UAs must not use registered content handlers to handle content that was returned as part of a
  non-GET transaction (or rather, as part of any non-idempotent transaction), as the remote site
  would not be able to fetch the same data.</p>

  <hr>

  

  <p>In addition to the registration methods, there are also methods for determining if particular
  handlers have been registered, and for unregistering handlers.</p>

  <dl class=domintro><dt><var>state</var> = <var>window</var> . <code id=custom-handlers:dom-navigator-3><a href=#dom-navigator>navigator</a></code> . <code id=custom-handlers:dom-navigator-isprotocolhandlerregistered-2><a href=#dom-navigator-isprotocolhandlerregistered>isProtocolHandlerRegistered</a></code>(<var>scheme</var>, <var>url</var>)<dt><var>state</var> = <var>window</var> . <code id=custom-handlers:dom-navigator-4><a href=#dom-navigator>navigator</a></code> . <code id=custom-handlers:dom-navigator-iscontenthandlerregistered-2><a href=#dom-navigator-iscontenthandlerregistered>isContentHandlerRegistered</a></code>(<var>mimeType</var>, <var>url</var>)<dd>

    <p>Returns one of the following strings describing the state of the handler given by the
    arguments:</p>

    <dl><dt><code>new</code>

     <dd>Indicates that no attempt has been made to register the given handler (or that the handler
     has been unregistered). It would be appropriate to promote the availability of the handler or
     to just automatically register the handler.

     <dt><code>registered</code>

     <dd>Indicates that the given handler has been registered or that the site is blocked from
     registering the handler. Trying to register the handler again would have no effect.

     <dt><code>declined</code>

     <dd>Indicates that the given handler has been offered but was rejected. Trying to register the
     handler again may prompt the user again.

    </dl>

   <dt><var>window</var> . <code id=custom-handlers:dom-navigator-5><a href=#dom-navigator>navigator</a></code> . <code id=custom-handlers:dom-navigator-unregisterprotocolhandler-2><a href=#dom-navigator-unregisterprotocolhandler>unregisterProtocolHandler</a></code>(<var>scheme</var>, <var>url</var>)<dt><var>window</var> . <code id=custom-handlers:dom-navigator-6><a href=#dom-navigator>navigator</a></code> . <code id=custom-handlers:dom-navigator-unregistercontenthandler-2><a href=#dom-navigator-unregistercontenthandler>unregisterContentHandler</a></code>(<var>mimeType</var>, <var>url</var>)<dd>

    <p>Unregisters the handler given by the arguments.</p>

   </dl>

  

  <p>The <dfn id=dom-navigator-isprotocolhandlerregistered><code>isProtocolHandlerRegistered()</code></dfn>
  method must return the <a href=#handler-state-string id=custom-handlers:handler-state-string>handler state string</a> that most closely describes the current
  state of the handler described by the two arguments to the method, where the first argument gives
  the scheme and the second gives the string used to build the <a id=custom-handlers:url-2 href=https://url.spec.whatwg.org/#concept-url data-x-internal=url>URL</a> of the page that
  will handle the requests.
  <a href=#fingerprinting-vector id=custom-handlers:fingerprinting-vector class=fingerprint title="There is a potential fingerprinting vector here."><img alt="(This is a fingerprinting vector.)" src=/images/fingerprint.png width=46 height=64></a>
  </p>

  <p>The first argument must be compared to the schemes for which custom protocol handlers are
  registered in an <a id=custom-handlers:ascii-case-insensitive-3 href=https://infra.spec.whatwg.org/#ascii-case-insensitive data-x-internal=ascii-case-insensitive>ASCII case-insensitive</a> manner to find the relevant handlers.</p>

  <p>The second argument must be preprocessed as described below, and if that is successful, must
  then be matched against the <a href=#proto-url id=custom-handlers:proto-url>proto-URLs</a> of the relevant handlers to
  find the described handler.</p>

  <hr>

  <p>The <dfn id=dom-navigator-iscontenthandlerregistered><code>isContentHandlerRegistered()</code></dfn>
  method must return the <a href=#handler-state-string id=custom-handlers:handler-state-string-2>handler state string</a> that most closely describes the current
  state of the handler described by the two arguments to the method, where the first argument gives
  the <a id=custom-handlers:mime-type-8 href=https://mimesniff.spec.whatwg.org/#mime-type data-x-internal=mime-type>MIME type</a> and the second gives the string used to build the <a id=custom-handlers:url-3 href=https://url.spec.whatwg.org/#concept-url data-x-internal=url>URL</a> of
  the page that will handle the requests.
  <a href=#fingerprinting-vector id=custom-handlers:fingerprinting-vector-2 class=fingerprint title="There is a potential fingerprinting vector here."><img alt="(This is a fingerprinting vector.)" src=/images/fingerprint.png width=46 height=64></a>
  </p>

  <p>The first argument must be compared to the <a href=https://mimesniff.spec.whatwg.org/#mime-type id=custom-handlers:mime-type-9 data-x-internal=mime-type>MIME types</a> for which
  custom content handlers are registered in an <a id=custom-handlers:ascii-case-insensitive-4 href=https://infra.spec.whatwg.org/#ascii-case-insensitive data-x-internal=ascii-case-insensitive>ASCII case-insensitive</a> manner to find
  the relevant handlers.</p>

  <p>The second argument must be preprocessed as described below, and if that is successful, must
  then be matched against the <a href=#proto-url id=custom-handlers:proto-url-2>proto-URLs</a> of the relevant handlers to
  find the described handler.</p>

  <hr>

  <p>The <dfn id=handler-state-string>handler state strings</dfn> are the following strings.
  Each string describes several situations, as given by the following list.</p>

  <dl><dt><code>new</code>

   <dd>The described handler has never been registered for the given scheme or type.

   <dd>The described handler was once registered for the given scheme or type, but the site has
   since unregistered it. If the handler were to be reregistered, the user would be notified
   accordingly.

   <dd>The described handler was once registered for the given scheme or type, but the site has
   since unregistered it, but the user has indicated that the site is to be blocked from registering
   the type again, so the user agent would ignore further registration attempts.


   <dt><code>registered</code>

   <dd>An attempt was made to register the described handler for the given scheme or type, but the
   user has not yet been notified, and the user agent would ignore further registration attempts.
   (Maybe the user agent batches registration requests to display them when the user requests to be
   notified about them, and the user has not yet requested that the user agent notify it of the
   previous registration attempt.)

   <dd>The described handler is registered for the given scheme or type (maybe, or maybe not, as the
   default handler).

   <dd>The described handler is permanently blocked from being (re)registered. (Maybe the user
   marked the registration attempt as spam, or blocked the site for other reasons.)


   <dt><code>declined</code>

   <dd>An attempt was made to register the described handler for the given scheme or type, but the
   user has not yet been notified; however, the user might be notified if another registration
   attempt were to be made. (Maybe the last registration attempt was made while the page was in the
   background and the user closed the page without looking at it, and the user agent requires
   confirmation for this registration attempt.)

   <dd>An attempt was made to register the described handler for the given scheme or type, but the
   user has not yet responded.

   <dd>An attempt was made to register the described handler for the given scheme or type, but the
   user declined the offer. The user has not indicated that the handler is to be permanently
   blocked, however, so another attempt to register the described handler might result in the user
   being prompted again.

   <dd>The described handler was once registered for the given scheme or type, but the user has
   since removed it. The user has not indicated that the handler is to be permanently blocked,
   however, so another attempt to register the described handler might result in the user being
   prompted again.

  </dl>

  <hr>

  <p>The <dfn id=dom-navigator-unregisterprotocolhandler><code>unregisterProtocolHandler()</code></dfn>
  method must unregister the handler described by the two arguments to the method, where the first
  argument gives the scheme and the second gives the string used to build the <a id=custom-handlers:url-4 href=https://url.spec.whatwg.org/#concept-url data-x-internal=url>URL</a> of
  the page that will handle the requests.</p>

  <p>The first argument must be compared to the schemes for which custom protocol handlers are
  registered in an <a id=custom-handlers:ascii-case-insensitive-5 href=https://infra.spec.whatwg.org/#ascii-case-insensitive data-x-internal=ascii-case-insensitive>ASCII case-insensitive</a> manner to find the relevant handlers.</p>

  <p>The second argument must be preprocessed as described below, and if that is successful, must
  then be matched against the <a href=#proto-url id=custom-handlers:proto-url-3>proto-URLs</a> of the relevant handlers to
  find the described handler.</p>

  <hr>

  <p>The <dfn id=dom-navigator-unregistercontenthandler><code>unregisterContentHandler()</code></dfn>
  method must unregister the handler described by the two arguments to the method, where the first
  argument gives the <a id=custom-handlers:mime-type-10 href=https://mimesniff.spec.whatwg.org/#mime-type data-x-internal=mime-type>MIME type</a> and the second gives the string used to build the
  <a id=custom-handlers:url-5 href=https://url.spec.whatwg.org/#concept-url data-x-internal=url>URL</a> of the page that will handle the requests.</p>

  <p>The first argument must be compared to the <a href=https://mimesniff.spec.whatwg.org/#mime-type id=custom-handlers:mime-type-11 data-x-internal=mime-type>MIME types</a> for which
  custom content handlers are registered in an <a id=custom-handlers:ascii-case-insensitive-6 href=https://infra.spec.whatwg.org/#ascii-case-insensitive data-x-internal=ascii-case-insensitive>ASCII case-insensitive</a> manner to find
  the relevant handlers.</p>

  <p>The second argument must be preprocessed as described below, and if that is successful, must
  then be matched against the <a href=#proto-url id=custom-handlers:proto-url-4>proto-URLs</a> of the relevant handlers to
  find the described handler.</p>

  <hr>

  <p>The second argument of the four methods described above must be preprocessed as follows:</p>

  <ol><li><p>If the string does not contain the substring "<code>%s</code>", abort these
   steps. There's no matching handler.<li><p><a href=#parse-a-url id=custom-handlers:parse-a-url-3>Parse</a> the string relative to the <a href=#relevant-settings-object id=custom-handlers:relevant-settings-object-4>relevant settings
   object</a> of this <code id=custom-handlers:navigatorcontentutils-4><a href=#navigatorcontentutils>NavigatorContentUtils</a></code> object. If this fails, then throw a
   <a id=custom-handlers:syntaxerror-4 href=https://heycam.github.io/webidl/#syntaxerror data-x-internal=syntaxerror>"<code>SyntaxError</code>"</a> <code id=custom-handlers:domexception-8><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code>.<li><p>If the <a href=#resulting-url-record id=custom-handlers:resulting-url-record-2>resulting URL record</a>'s <a href=https://url.spec.whatwg.org/#concept-url-origin id=custom-handlers:concept-url-origin-2 data-x-internal=concept-url-origin>origin</a>
   is not the <a href=#same-origin id=custom-handlers:same-origin>same origin</a> as the <a href=#concept-settings-object-origin id=custom-handlers:concept-settings-object-origin-2>origin</a> of the <a href=#relevant-settings-object id=custom-handlers:relevant-settings-object-5>relevant settings
   object</a> of this <code id=custom-handlers:navigatorcontentutils-5><a href=#navigatorcontentutils>NavigatorContentUtils</a></code> object, throw a
   <a id=custom-handlers:securityerror-5 href=https://heycam.github.io/webidl/#securityerror data-x-internal=securityerror>"<code>SecurityError</code>"</a> <code id=custom-handlers:domexception-9><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code>.<li><p>Return the <a href=#resulting-url-string id=custom-handlers:resulting-url-string-3>resulting URL string</a> as the result of preprocessing the
   argument.</ol>

  




  

  <h6 id=security-and-privacy>8.7.1.3.1 Security and privacy<a href=#security-and-privacy class=self-link></a></h6>

  <p>These mechanisms can introduce a number of concerns, in particular privacy concerns.</p>

  <p><strong>Hijacking all Web usage.</strong> User agents should not allow schemes that are key to
  its normal operation, such as an <a id=security-and-privacy:http(s)-scheme href=https://url.spec.whatwg.org/#http-scheme data-x-internal=http(s)-scheme>HTTP(S) scheme</a>, to be rerouted through third-party
  sites. This would allow a user's activities to be trivially tracked, and would allow user
  information, even in secure connections, to be collected.</p>

  <p><strong>Hijacking defaults.</strong> User agents are strongly urged to not automatically change
  any defaults, as this could lead the user to send data to remote hosts that the user is not
  expecting. New handlers registering themselves should never automatically cause those sites to be
  used.</p>

  <p><strong>Registration spamming.</strong> User agents should consider the possibility that a site
  will attempt to register a large number of handlers, possibly from multiple domains (e.g. by
  redirecting through a series of pages each on a different domain, and each registering a handler
  for <code id=security-and-privacy:video/mpeg><a href=#video/mpeg>video/mpeg</a></code>  analogous practices abusing other Web browser features have
  been used by pornography Web sites for many years). User agents should gracefully handle such
  hostile attempts, protecting the user.</p>

  <p><strong>Misleading titles.</strong> User agents should not rely wholly on the <var>title</var>
  argument to the methods when presenting the registered handlers to the user, since sites could
  easily lie. For example, a site <code>hostile.example.net</code> could claim that it was
  registering the "Cuddly Bear Happy Content Handler". User agents should therefore use the
  handler's domain in any UI along with any title.</p>

  <p><strong>Hostile handler metadata.</strong> User agents should protect against typical attacks
  against strings embedded in their interface, for example ensuring that markup or escape characters
  in such strings are not executed, that null bytes are properly handled, that over-long strings do
  not cause crashes or buffer overruns, and so forth.</p>

  <p><strong>Leaking Intranet URLs.</strong> The mechanism described in this section can result in
  secret Intranet URLs being leaked, in the following manner:</p>

  <ol><li>The user registers a third-party content handler as the default handler for a content
   type.<li>The user then browses their corporate Intranet site and accesses a document that uses that
   content type.<li>The user agent contacts the third party and hands the third party the URL to the Intranet
   content.</ol>

  <p>No actual confidential file data is leaked in this manner, but the URLs themselves could
  contain confidential information. For example, the URL could be <code>https://www.corp.example.com/upcoming-aquisitions/the-sample-company.egf</code>, which
  might tell the third party that Example Corporation is intending to merge with The Sample Company.
  Implementors might wish to consider allowing administrators to disable this feature for certain
  subdomains, content types, or schemes.</p>

  <p><strong>Leaking secure URLs.</strong> User agents should not send HTTPS URLs to third-party
  sites registered as content handlers without the user's informed consent, for the same reason that
  user agents sometimes avoid sending `<code id=security-and-privacy:http-referer><a data-x-internal=http-referer href=https://tools.ietf.org/html/rfc7231#section-5.5.2>Referer</a></code>` (sic) HTTP
  headers from secure sites to third-party sites.</p>

  <p><strong>Leaking credentials.</strong> User agents must never send username or password
  information in the URLs that are escaped and included sent to the handler sites. User agents may
  even avoid attempting to pass to Web-based handlers the URLs of resources that are known to
  require authentication to access, as such sites would be unable to access the resources in
  question without prompting the user for credentials themselves (a practice that would require the
  user to know whether to trust the third-party handler, a decision many users are unable to make or
  even understand).</p>

  <p><strong>Interface interference.</strong> User agents should be prepared to handle intentionally
  long arguments to the methods. For example, if the user interface exposed consists of an "accept"
  button and a "deny" button, with the "accept" binding containing the name of the handler, it's
  important that a long name not cause the "deny" button to be pushed off the screen.</p>

  <p><strong>Fingerprinting users.</strong> Since a site can detect if it has attempted to register
  a particular handler or not, whether or not the user responds, the mechanism can be used to store
  data. User agents are therefore strongly urged to treat registrations in the same manner as
  cookies: clearing cookies for a site should also clear all registrations for that site, and
  disabling cookies for a site should also disable registrations.</p>

  



  

  <h6 id=sample-handler-impl>8.7.1.3.2 Sample user interface<a href=#sample-handler-impl class=self-link></a></h6>

  <p><i>This section is non-normative.</i></p>

  <p>A simple implementation of this feature for a desktop Web browser might work as follows.</p>

  <p>The <code id=sample-handler-impl:dom-navigator-registercontenthandler><a href=#dom-navigator-registercontenthandler>registerContentHandler()</a></code> method
  could display a modal dialog box:</p>

  <p><img src=/images/sample-content-handler-registration.png width=534 alt="The modal dialog box could have the title 'Content Handler Registration', and could say 'This Web page: Kittens at work http://kittens.example.org/ ...would like permission to handle files of type: application/x-meowmeow using the following Web-based application: Kittens-at-work displayer http://kittens.example.org/?show=%s Do you trust the administrators of the &quot;kittens.example.org&quot; domain?' with two buttons, 'Trust kittens.example.org' and 'Cancel'." height=374></p>

  <p>In this dialog box, "Kittens at work" is the title of the page that invoked the method,
  "http://kittens.example.org/" is the URL of that page, "application/x-meowmeow" is the string that
  was passed to the <code id=sample-handler-impl:dom-navigator-registercontenthandler-2><a href=#dom-navigator-registercontenthandler>registerContentHandler()</a></code> method as its first
  argument (<var>mimeType</var>), "http://kittens.example.org/?show=%s" was the second
  argument (<var>url</var>), and "Kittens-at-work displayer" was the third argument (<var>title</var>).</p>

  <p>If the user clicks the Cancel button, then nothing further happens. If the user clicks the
  "Trust" button, then the handler is remembered.</p>

  <p>When the user then attempts to fetch a URL that uses the "application/x-meowmeow" <a id=sample-handler-impl:mime-type href=https://mimesniff.spec.whatwg.org/#mime-type data-x-internal=mime-type>MIME
  type</a>, then it might display a dialog as follows:</p>

  <p><img src=/images/sample-content-handler.png width=577 alt="The dialog box could have the title 'Unknown File Type' and could say 'You have attempted to access:' followed by a URL, followed by a prompt such as 'How would you like FerretBrowser to handle this resource?' with three radio buttons, one saying 'Contact the FerretBrowser plugin registry to see if there is an official way to handle this resource.', one saying 'Pass this URL to a local application' with an application selector, and one saying 'Pass this URL to the &quot;Kittens-at-work displayer&quot; application at &quot;kittens.example.org&quot;', with a checkbox labeled 'Always do this for resources using the &quot;application/x-meowmeow&quot; type in future.', and with two buttons, 'Ok' and 'Cancel'." height=428></p>

  <p>In this dialog, the third option is the one that was primed by the site registering itself
  earlier.</p>

  <p>If the user does select that option, then the browser, in accordance with the requirements
  described in the previous two sections, will redirect the user to
  "http://kittens.example.org/?show=data%3Aapplication/x-meowmeow;base64,S2l0dGVucyBhcmUgdGhlIGN1dGVzdCE%253D".</p>

  <p>The <code id=sample-handler-impl:dom-navigator-registerprotocolhandler><a href=#dom-navigator-registerprotocolhandler>registerProtocolHandler()</a></code> method
  would work equivalently, but for schemes instead of unknown content types.</p>

  



  <h5 id=cookies>8.7.1.4 Cookies<a href=#cookies class=self-link></a></h5>

  <pre class=idl>[NoInterfaceObject]
interface <dfn id=navigatorcookies>NavigatorCookies</dfn> {
  readonly attribute boolean <a href=#dom-navigator-cookieenabled id=cookies:dom-navigator-cookieenabled>cookieEnabled</a>;
};</pre>

  <dl class=domintro><dt><var>window</var> . <code id=cookies:dom-navigator><a href=#dom-navigator>navigator</a></code> . <code id=cookies:dom-navigator-cookieenabled-2><a href=#dom-navigator-cookieenabled>cookieEnabled</a></code><dd>

    <p>Returns false if setting a cookie will be ignored, and true otherwise.</p>

   </dl>

  

   <p>The <dfn id=dom-navigator-cookieenabled><code>cookieEnabled</code></dfn> attribute must
   return true if the user agent attempts to handle cookies according to the cookie specification,
   and false if it ignores cookie change requests. <a href=#refsCOOKIES>[COOKIES]</a></p>

  



  <h5 id=plugins-2>8.7.1.5 Plugins<a href=#plugins-2 class=self-link></a></h5>

  <pre class=idl>[NoInterfaceObject]
interface <dfn id=navigatorplugins>NavigatorPlugins</dfn> {
  [SameObject] readonly attribute <a href=#pluginarray id=plugins-2:pluginarray>PluginArray</a> <a href=#dom-navigator-plugins id=plugins-2:dom-navigator-plugins>plugins</a>;
  [SameObject] readonly attribute <a href=#mimetypearray id=plugins-2:mimetypearray>MimeTypeArray</a> <a href=#dom-navigator-mimetypes id=plugins-2:dom-navigator-mimetypes>mimeTypes</a>;
  boolean <a href=#dom-navigator-javaenabled id=plugins-2:dom-navigator-javaenabled>javaEnabled()</a>;
};

[LegacyUnenumerableNamedProperties]
interface <dfn id=pluginarray>PluginArray</dfn> {
  void <a href=#dom-pluginarray-refresh id=plugins-2:dom-pluginarray-refresh>refresh</a>(optional boolean reload = false);
  readonly attribute unsigned long <a href=#dom-pluginarray-length id=plugins-2:dom-pluginarray-length>length</a>;
  getter <a href=#dom-plugin id=plugins-2:dom-plugin>Plugin</a>? <a href=#dom-pluginarray-item id=plugins-2:dom-pluginarray-item>item</a>(unsigned long index);
  getter <a href=#dom-plugin id=plugins-2:dom-plugin-2>Plugin</a>? <a href=#dom-pluginarray-nameditem id=plugins-2:dom-pluginarray-nameditem>namedItem</a>(DOMString name);
};

[LegacyUnenumerableNamedProperties]
interface <dfn id=mimetypearray>MimeTypeArray</dfn> {
  readonly attribute unsigned long <a href=#dom-mimetypearray-length id=plugins-2:dom-mimetypearray-length>length</a>;
  getter <a href=#mimetype id=plugins-2:mimetype>MimeType</a>? <a href=#dom-mimetypearray-item id=plugins-2:dom-mimetypearray-item>item</a>(unsigned long index);
  getter <a href=#mimetype id=plugins-2:mimetype-2>MimeType</a>? <a href=#dom-mimetypearray-nameditem id=plugins-2:dom-mimetypearray-nameditem>namedItem</a>(DOMString name);
};

[LegacyUnenumerableNamedProperties]
interface <dfn id=dom-plugin>Plugin</dfn> {
  readonly attribute DOMString <a href=#dom-plugin-name id=plugins-2:dom-plugin-name>name</a>;
  readonly attribute DOMString <a href=#dom-plugin-description id=plugins-2:dom-plugin-description>description</a>;
  readonly attribute DOMString <a href=#dom-plugin-filename id=plugins-2:dom-plugin-filename>filename</a>;
  readonly attribute unsigned long <a href=#dom-plugin-length id=plugins-2:dom-plugin-length>length</a>;
  getter <a href=#mimetype id=plugins-2:mimetype-3>MimeType</a>? <a href=#dom-plugin-item id=plugins-2:dom-plugin-item>item</a>(unsigned long index);
  getter <a href=#mimetype id=plugins-2:mimetype-4>MimeType</a>? <a href=#dom-plugin-nameditem id=plugins-2:dom-plugin-nameditem>namedItem</a>(DOMString name);
};

interface <dfn id=mimetype>MimeType</dfn> {
  readonly attribute DOMString <a href=#dom-mimetype-type id=plugins-2:dom-mimetype-type>type</a>;
  readonly attribute DOMString <a href=#dom-mimetype-description id=plugins-2:dom-mimetype-description>description</a>;
  readonly attribute DOMString <a href=#dom-mimetype-suffixes id=plugins-2:dom-mimetype-suffixes>suffixes</a>; // comma-separated
  readonly attribute <a href=#dom-plugin id=plugins-2:dom-plugin-3>Plugin</a> <a href=#dom-mimetype-enabledplugin id=plugins-2:dom-mimetype-enabledplugin>enabledPlugin</a>;
};</pre>

  <dl class=domintro><dt><var>window</var> . <code id=plugins-2:dom-navigator><a href=#dom-navigator>navigator</a></code> . <code id=plugins-2:dom-navigator-plugins-2><a href=#dom-navigator-plugins>plugins</a></code> . <code id=plugins-2:dom-pluginarray-refresh-2><a href=#dom-pluginarray-refresh>refresh</a></code>( [ <var>refresh</var> ] )<dd>
    <p>Updates the lists of supported plugins and MIME types for this page, and reloads the page if the lists have changed.</p>
    
   <dt><var>window</var> . <code id=plugins-2:dom-navigator-2><a href=#dom-navigator>navigator</a></code> . <code id=plugins-2:dom-navigator-plugins-3><a href=#dom-navigator-plugins>plugins</a></code> . <code id=plugins-2:dom-pluginarray-length-2><a href=#dom-pluginarray-length>length</a></code><dd>
    <p>Returns the number of plugins, represented by <code id=plugins-2:dom-plugin-4><a href=#dom-plugin>Plugin</a></code> objects, that the user agent reports.</p>
   <dt><var>plugin</var> = <var>window</var> . <code id=plugins-2:dom-navigator-3><a href=#dom-navigator>navigator</a></code> . <code id=plugins-2:dom-navigator-plugins-4><a href=#dom-navigator-plugins>plugins</a></code> . <code id=plugins-2:dom-pluginarray-item-2><a href=#dom-pluginarray-item>item</a></code>(<var>index</var>)<dt><var>window</var> . <code id=plugins-2:dom-navigator-4><a href=#dom-navigator>navigator</a></code> . <code id=plugins-2:dom-navigator-plugins-5><a href=#dom-navigator-plugins>plugins</a></code>[<var>index</var>]<dd>
    <p>Returns the specified <code id=plugins-2:dom-plugin-5><a href=#dom-plugin>Plugin</a></code> object.</p>
   <dt><var>plugin</var> = <var>window</var> . <code id=plugins-2:dom-navigator-5><a href=#dom-navigator>navigator</a></code> . <code id=plugins-2:dom-navigator-plugins-6><a href=#dom-navigator-plugins>plugins</a></code> . <code id=plugins-2:dom-pluginarray-item-3><a href=#dom-pluginarray-item>item</a></code>(<var>name</var>)<dt><var>window</var> . <code id=plugins-2:dom-navigator-6><a href=#dom-navigator>navigator</a></code> . <code id=plugins-2:dom-navigator-plugins-7><a href=#dom-navigator-plugins>plugins</a></code>[<var>name</var>]<dd>
    <p>Returns the <code id=plugins-2:dom-plugin-6><a href=#dom-plugin>Plugin</a></code> object for the plugin with the given name.</p>
   <dt><var>window</var> . <code id=plugins-2:dom-navigator-7><a href=#dom-navigator>navigator</a></code> . <code id=plugins-2:dom-navigator-mimetypes-2><a href=#dom-navigator-mimetypes>mimeTypes</a></code> . <code id=plugins-2:dom-mimetypearray-length-2><a href=#dom-mimetypearray-length>length</a></code><dd>
    <p>Returns the number of MIME types, represented by <code id=plugins-2:mimetype-5><a href=#mimetype>MimeType</a></code> objects, supported by the plugins that the user agent reports.</p>
   <dt><var>mimeType</var> = <var>window</var> . <code id=plugins-2:dom-navigator-8><a href=#dom-navigator>navigator</a></code> . <code id=plugins-2:dom-navigator-mimetypes-3><a href=#dom-navigator-mimetypes>mimeTypes</a></code> . <code id=plugins-2:dom-mimetypearray-item-2><a href=#dom-mimetypearray-item>item</a></code>(<var>index</var>)<dt><var>window</var> . <code id=plugins-2:dom-navigator-9><a href=#dom-navigator>navigator</a></code> . <code id=plugins-2:dom-navigator-mimetypes-4><a href=#dom-navigator-mimetypes>mimeTypes</a></code>[<var>index</var>]<dd>
    <p>Returns the specified <code id=plugins-2:mimetype-6><a href=#mimetype>MimeType</a></code> object.</p>
   <dt><var>mimeType</var> = <var>window</var> . <code id=plugins-2:dom-navigator-10><a href=#dom-navigator>navigator</a></code> . <code id=plugins-2:dom-navigator-mimetypes-5><a href=#dom-navigator-mimetypes>mimeTypes</a></code> . <code id=plugins-2:dom-mimetypearray-item-3><a href=#dom-mimetypearray-item>item</a></code>(<var>name</var>)<dt><var>window</var> . <code id=plugins-2:dom-navigator-11><a href=#dom-navigator>navigator</a></code> . <code id=plugins-2:dom-navigator-mimetypes-6><a href=#dom-navigator-mimetypes>mimeTypes</a></code>[<var>name</var>]<dd>
    <p>Returns the <code id=plugins-2:mimetype-7><a href=#mimetype>MimeType</a></code> object for the given MIME type.</p>
   <dt><var>plugin</var> . <code id=plugins-2:dom-plugin-name-2><a href=#dom-plugin-name>name</a></code>
   <dd>
    <p>Returns the plugin's name.</p>
   <dt><var>plugin</var> . <code id=plugins-2:dom-plugin-description-2><a href=#dom-plugin-description>description</a></code>
   <dd>
    <p>Returns the plugin's description.</p>
   <dt><var>plugin</var> . <code id=plugins-2:dom-plugin-filename-2><a href=#dom-plugin-filename>filename</a></code>
   <dd>
    <p>Returns the plugin library's filename, if applicable on the current platform.</p>
   <dt><var>plugin</var> . <code id=plugins-2:dom-plugin-length-2><a href=#dom-plugin-length>length</a></code><dd>
    <p>Returns the number of MIME types, represented by <code id=plugins-2:mimetype-8><a href=#mimetype>MimeType</a></code> objects, supported by the plugin.</p>
   <dt><var>mimeType</var> = <var>plugin</var> . <code id=plugins-2:dom-plugin-item-2><a href=#dom-plugin-item>item</a></code>(<var>index</var>)<dt><var>plugin</var>[<var>index</var>]<dd>
    <p>Returns the specified <code id=plugins-2:mimetype-9><a href=#mimetype>MimeType</a></code> object.</p>
   <dt><var>mimeType</var> = <var>plugin</var> . <code id=plugins-2:dom-plugin-item-3><a href=#dom-plugin-item>item</a></code>(<var>name</var>)<dt><var>plugin</var>[<var>name</var>]<dd>
    <p>Returns the <code id=plugins-2:mimetype-10><a href=#mimetype>MimeType</a></code> object for the given MIME type.</p>
   <dt><var>mimeType</var> . <code id=plugins-2:dom-mimetype-type-2><a href=#dom-mimetype-type>type</a></code>
   <dd>
    <p>Returns the MIME type.</p>
   <dt><var>mimeType</var> . <code id=plugins-2:dom-mimetype-description-2><a href=#dom-mimetype-description>description</a></code>
   <dd>
    <p>Returns the MIME type's description.</p>
   <dt><var>mimeType</var> . <code id=plugins-2:dom-mimetype-suffixes-2><a href=#dom-mimetype-suffixes>suffixes</a></code>
   <dd>
    <p>Returns the MIME type's typical file extensions, in a comma-separated list.</p>
   <dt><var>mimeType</var> . <code id=plugins-2:dom-mimetype-enabledplugin-2><a href=#dom-mimetype-enabledplugin>enabledPlugin</a></code>
   <dd>
    <p>Returns the <code id=plugins-2:dom-plugin-7><a href=#dom-plugin>Plugin</a></code> object that implements this MIME type.</p>
   <dt><var>window</var> . <code id=plugins-2:dom-navigator-12><a href=#dom-navigator>navigator</a></code> . <code id=plugins-2:dom-navigator-javaenabled-2><a href=#dom-navigator-javaenabled>javaEnabled()</a></code><dd>
    <p>Returns true if there's a plugin that supports the MIME type "<code>application/x-java-vm</code>".</p>
   </dl>

  

  <p>The <dfn id=dom-navigator-plugins><code>navigator.plugins</code></dfn> attribute must
  return a <code id=plugins-2:pluginarray-2><a href=#pluginarray>PluginArray</a></code> object.</p>

  <p>The <dfn id=dom-navigator-mimetypes><code>navigator.mimeTypes</code></dfn> attribute must
  return a <code id=plugins-2:mimetypearray-2><a href=#mimetypearray>MimeTypeArray</a></code> object.</p>

  <hr>

  <p>A <code id=plugins-2:pluginarray-3><a href=#pluginarray>PluginArray</a></code> object represents none, some, or all of the <a href=#plugin id=plugins-2:plugin>plugins</a> supported by the user agent, each of which is represented by a <code id=plugins-2:dom-plugin-8><a href=#dom-plugin>Plugin</a></code> object. Each of these <code id=plugins-2:dom-plugin-9><a href=#dom-plugin>Plugin</a></code>
  objects may be <dfn id=hidden-plugin>hidden plugins</dfn>. A <a href=#hidden-plugin id=plugins-2:hidden-plugin>hidden plugin</a> can't
  be enumerated, but can still be inspected by using its name.</p>

  <p class=note>The fewer <a href=#plugin id=plugins-2:plugin-2>plugins</a> are represented by the
  <code id=plugins-2:pluginarray-4><a href=#pluginarray>PluginArray</a></code> object, and of those, the more that are <a href=#hidden-plugin id=plugins-2:hidden-plugin-2>hidden</a>, the more the user's privacy will be protected. Each exposed plugin
  increases the number of bits that can be derived for fingerprinting. Hiding a plugin helps, but
  unless it is an extremely rare plugin, it is likely that a site attempting to derive the list of
  plugins can still determine whether the plugin is supported or not by probing for it by name (the
  names of popular plugins are widely known). Therefore not exposing a plugin at all is preferred.
  Unfortunately, many legacy sites use this feature to determine, for example, which plugin to use
  to play video. Not exposing any plugins at all might therefore not be entirely plausible.</p>

  <p>The <code id=plugins-2:pluginarray-5><a href=#pluginarray>PluginArray</a></code> objects created by a user agent must not be <a href=#live id=plugins-2:live>live</a>. The
  set of plugins represented by the objects must not change once an object is created, except when
  it is updated by the <code id=plugins-2:dom-pluginarray-refresh-3><a href=#dom-pluginarray-refresh>refresh()</a></code> method.</p>

  <p>Each <a href=#plugin id=plugins-2:plugin-3>plugin</a> represented by a <code id=plugins-2:pluginarray-6><a href=#pluginarray>PluginArray</a></code> can support a number of
  <a href=https://mimesniff.spec.whatwg.org/#mime-type id=plugins-2:mime-type data-x-internal=mime-type>MIME types</a>. For each such <a href=#plugin id=plugins-2:plugin-4>plugin</a>, the user agent must
  pick one or more of these <a href=https://mimesniff.spec.whatwg.org/#mime-type id=plugins-2:mime-type-2 data-x-internal=mime-type>MIME types</a> to be those that are
  <dfn id=explicitly-supported>explicitly supported</dfn>.</p>

  <p class=note>The <a href=#explicitly-supported id=plugins-2:explicitly-supported>explicitly supported</a> <a href=https://mimesniff.spec.whatwg.org/#mime-type id=plugins-2:mime-type-3 data-x-internal=mime-type>MIME types</a> of
  a <a href=#plugin id=plugins-2:plugin-5>plugin</a> are those that are exposed through the <code id=plugins-2:dom-plugin-10><a href=#dom-plugin>Plugin</a></code> and <code id=plugins-2:mimetypearray-3><a href=#mimetypearray>MimeTypeArray</a></code> interfaces. As with <a href=#plugin id=plugins-2:plugin-6>plugins</a> themselves, any variation between users regarding what is exposed
  allows sites to fingerprint users. User agents are therefore encouraged to expose the same <a href=https://mimesniff.spec.whatwg.org/#mime-type id=plugins-2:mime-type-4 data-x-internal=mime-type>MIME types</a> for all users of a <a href=#plugin id=plugins-2:plugin-7>plugin</a>, regardless of the
  actual types supported... at least, within the constraints imposed by compatibility with legacy
  content.</p>

  <p>The <a id=plugins-2:supported-property-indices href=https://heycam.github.io/webidl/#dfn-supported-property-indices data-x-internal=supported-property-indices>supported property indices</a> of a <code id=plugins-2:pluginarray-7><a href=#pluginarray>PluginArray</a></code> object are the
  numbers from zero to the number of non-<a href=#hidden-plugin id=plugins-2:hidden-plugin-3>hidden</a> <a href=#plugin id=plugins-2:plugin-8>plugins</a> represented by the object, if any.
  <a href=#fingerprinting-vector id=plugins-2:fingerprinting-vector class=fingerprint title="There is a potential fingerprinting vector here."><img alt="(This is a fingerprinting vector.)" src=/images/fingerprint.png width=46 height=64></a>
  </p>

  <p>The <dfn id=dom-pluginarray-length><code>length</code></dfn> attribute must return the
  number of non-<a href=#hidden-plugin id=plugins-2:hidden-plugin-4>hidden</a> <a href=#plugin id=plugins-2:plugin-9>plugins</a>
  represented by the object.
  <a href=#fingerprinting-vector id=plugins-2:fingerprinting-vector-2 class=fingerprint title="There is a potential fingerprinting vector here."><img alt="(This is a fingerprinting vector.)" src=/images/fingerprint.png width=46 height=64></a>
  </p>

  <p>The <dfn id=dom-pluginarray-item><code>item()</code></dfn> method of a
  <code id=plugins-2:pluginarray-8><a href=#pluginarray>PluginArray</a></code> object must return null if the argument is not one of the object's
  <a id=plugins-2:supported-property-indices-2 href=https://heycam.github.io/webidl/#dfn-supported-property-indices data-x-internal=supported-property-indices>supported property indices</a>, and otherwise must return the result of running the
  following steps, using the method's argument as <var>index</var>:</p>

  <ol><li><p>Let <var>list</var> be the <code id=plugins-2:dom-plugin-11><a href=#dom-plugin>Plugin</a></code> objects
   representing the non-<a href=#hidden-plugin id=plugins-2:hidden-plugin-5>hidden</a> <a href=#plugin id=plugins-2:plugin-10>plugins</a> represented by the <code id=plugins-2:pluginarray-9><a href=#pluginarray>PluginArray</a></code> object.<li><p>Sort <var>list</var> alphabetically by the <code id=plugins-2:dom-plugin-name-3><a href=#dom-plugin-name>name</a></code> of each <code id=plugins-2:dom-plugin-12><a href=#dom-plugin>Plugin</a></code>.<li><p>Return the <var>index</var>th entry in <var>list</var>.</ol>

  <p class=note>It is important <a href=#fingerprinting-vector id=plugins-2:fingerprinting-vector-3 class=no-backref>for
  privacy</a> that the order of plugins not leak additional information, e.g. the order in which
  plugins were installed.</p>

  <p>The <a id=plugins-2:supported-property-names href=https://heycam.github.io/webidl/#dfn-supported-property-names data-x-internal=supported-property-names>supported property names</a> of a <code id=plugins-2:pluginarray-10><a href=#pluginarray>PluginArray</a></code> object are the values
  of the <code id=plugins-2:dom-plugin-name-4><a href=#dom-plugin-name>name</a></code> attributes of all the <code id=plugins-2:dom-plugin-13><a href=#dom-plugin>Plugin</a></code> objects represented by the <code id=plugins-2:pluginarray-11><a href=#pluginarray>PluginArray</a></code> object.
  <a href=#fingerprinting-vector id=plugins-2:fingerprinting-vector-4 class=fingerprint title="There is a potential fingerprinting vector here."><img alt="(This is a fingerprinting vector.)" src=/images/fingerprint.png width=46 height=64></a>
  </p>

  <p>The <dfn id=dom-pluginarray-nameditem><code>namedItem()</code></dfn> method of a
  <code id=plugins-2:pluginarray-12><a href=#pluginarray>PluginArray</a></code> object must return null if the argument is not one of the object's
  <a id=plugins-2:supported-property-names-2 href=https://heycam.github.io/webidl/#dfn-supported-property-names data-x-internal=supported-property-names>supported property names</a>, and otherwise must return the <code id=plugins-2:dom-plugin-14><a href=#dom-plugin>Plugin</a></code> object, of those represented by the <code id=plugins-2:pluginarray-13><a href=#pluginarray>PluginArray</a></code>
  object, that has a <code id=plugins-2:dom-plugin-name-5><a href=#dom-plugin-name>name</a></code> equal to the method's argument.</p>

  <p>The <dfn id=dom-pluginarray-refresh><code>refresh()</code></dfn> method of the
  <code id=plugins-2:pluginarray-14><a href=#pluginarray>PluginArray</a></code> object of a <code id=plugins-2:navigator><a href=#navigator>Navigator</a></code> object, when invoked, must check to
  see if any <a href=#plugin id=plugins-2:plugin-11>plugins</a> have been installed or reconfigured since the user
  agent created the <code id=plugins-2:pluginarray-15><a href=#pluginarray>PluginArray</a></code> object. If so, and the method's argument is true, then
  the user agent must act as if the <code id=plugins-2:dom-location-reload><a href=#dom-location-reload>location.reload()</a></code>
  method was called instead. Otherwise, the user agent must update the <code id=plugins-2:pluginarray-16><a href=#pluginarray>PluginArray</a></code>
  object and <code id=plugins-2:mimetypearray-4><a href=#mimetypearray>MimeTypeArray</a></code> object created for attributes of that <code id=plugins-2:navigator-2><a href=#navigator>Navigator</a></code>
  object, and the <code id=plugins-2:dom-plugin-15><a href=#dom-plugin>Plugin</a></code> and <code id=plugins-2:mimetype-11><a href=#mimetype>MimeType</a></code> objects created
  for those <code id=plugins-2:pluginarray-17><a href=#pluginarray>PluginArray</a></code> and <code id=plugins-2:mimetypearray-5><a href=#mimetypearray>MimeTypeArray</a></code> objects, using the same <code id=plugins-2:dom-plugin-16><a href=#dom-plugin>Plugin</a></code> objects for cases where the <code id=plugins-2:dom-plugin-name-6><a href=#dom-plugin-name>name</a></code> is the same, and the same <code id=plugins-2:mimetype-12><a href=#mimetype>MimeType</a></code> objects for
  cases where the <code id=plugins-2:dom-mimetype-type-3><a href=#dom-mimetype-type>type</a></code> is the same, and creating new objects
  for cases where there were no matching objects immediately prior to the <code id=plugins-2:dom-pluginarray-refresh-4><a href=#dom-pluginarray-refresh>refresh()</a></code> call. Old <code id=plugins-2:dom-plugin-17><a href=#dom-plugin>Plugin</a></code>
  and <code id=plugins-2:mimetype-13><a href=#mimetype>MimeType</a></code> objects must continue to return the same values that they had prior to
  the update, though naturally now the data is stale and may appear inconsistent (for example, an
  old <code id=plugins-2:mimetype-14><a href=#mimetype>MimeType</a></code> entry might list as its <code id=plugins-2:dom-mimetype-enabledplugin-3><a href=#dom-mimetype-enabledplugin>enabledPlugin</a></code> a <code id=plugins-2:dom-plugin-18><a href=#dom-plugin>Plugin</a></code>
  object that no longer lists that <code id=plugins-2:mimetype-15><a href=#mimetype>MimeType</a></code> as a supported <code id=plugins-2:mimetype-16><a href=#mimetype>MimeType</a></code>).</p>

  <hr>

  <p>A <code id=plugins-2:mimetypearray-6><a href=#mimetypearray>MimeTypeArray</a></code> object represents the <a href=https://mimesniff.spec.whatwg.org/#mime-type id=plugins-2:mime-type-5 data-x-internal=mime-type>MIME types</a>
  <a href=#explicitly-supported id=plugins-2:explicitly-supported-2>explicitly supported</a> by <a href=#plugin id=plugins-2:plugin-12>plugins</a> supported by the user
  agent, each of which is represented by a <code id=plugins-2:mimetype-17><a href=#mimetype>MimeType</a></code> object.</p>

  <p>The <code id=plugins-2:mimetypearray-7><a href=#mimetypearray>MimeTypeArray</a></code> objects created by a user agent must not be <a href=#live id=plugins-2:live-2>live</a>.
  The set of MIME types represented by the objects must not change once an object is created, except
  when it is updated by the <code id=plugins-2:pluginarray-18><a href=#pluginarray>PluginArray</a></code> object's <code id=plugins-2:dom-pluginarray-refresh-5><a href=#dom-pluginarray-refresh>refresh()</a></code> method.</p>

  <p>The <a id=plugins-2:supported-property-indices-3 href=https://heycam.github.io/webidl/#dfn-supported-property-indices data-x-internal=supported-property-indices>supported property indices</a> of a <code id=plugins-2:mimetypearray-8><a href=#mimetypearray>MimeTypeArray</a></code> object are the
  numbers from zero to the number of <a href=https://mimesniff.spec.whatwg.org/#mime-type id=plugins-2:mime-type-6 data-x-internal=mime-type>MIME types</a> <a href=#explicitly-supported id=plugins-2:explicitly-supported-3>explicitly
  supported</a> by non-<a href=#hidden-plugin id=plugins-2:hidden-plugin-6>hidden</a> <a href=#plugin id=plugins-2:plugin-13>plugins</a> represented by the corresponding <code id=plugins-2:pluginarray-19><a href=#pluginarray>PluginArray</a></code> object, if
  any.
  <a href=#fingerprinting-vector id=plugins-2:fingerprinting-vector-5 class=fingerprint title="There is a potential fingerprinting vector here."><img alt="(This is a fingerprinting vector.)" src=/images/fingerprint.png width=46 height=64></a>
  </p>

  <p>The <dfn id=dom-mimetypearray-length><code>length</code></dfn> attribute must return the
  number of <a href=https://mimesniff.spec.whatwg.org/#mime-type id=plugins-2:mime-type-7 data-x-internal=mime-type>MIME types</a> <a href=#explicitly-supported id=plugins-2:explicitly-supported-4>explicitly supported</a> by non-<a href=#hidden-plugin id=plugins-2:hidden-plugin-7>hidden</a> <a href=#plugin id=plugins-2:plugin-14>plugins</a> represented by the
  corresponding <code id=plugins-2:pluginarray-20><a href=#pluginarray>PluginArray</a></code> object, if any.
  <a href=#fingerprinting-vector id=plugins-2:fingerprinting-vector-6 class=fingerprint title="There is a potential fingerprinting vector here."><img alt="(This is a fingerprinting vector.)" src=/images/fingerprint.png width=46 height=64></a>
  </p>

  <p>The <dfn id=dom-mimetypearray-item><code>item()</code></dfn> method of a
  <code id=plugins-2:mimetypearray-9><a href=#mimetypearray>MimeTypeArray</a></code> object must return null if the argument is not one of the object's
  <a id=plugins-2:supported-property-indices-4 href=https://heycam.github.io/webidl/#dfn-supported-property-indices data-x-internal=supported-property-indices>supported property indices</a>, and otherwise must return the result of running the
  following steps, using the method's argument as <var>index</var>:</p>

  <ol><li><p>Let <var>list</var> be the <code id=plugins-2:mimetype-18><a href=#mimetype>MimeType</a></code> objects representing the <a href=https://mimesniff.spec.whatwg.org/#mime-type id=plugins-2:mime-type-8 data-x-internal=mime-type>MIME types</a> <a href=#explicitly-supported id=plugins-2:explicitly-supported-5>explicitly supported</a> by non-<a href=#hidden-plugin id=plugins-2:hidden-plugin-8>hidden</a> <a href=#plugin id=plugins-2:plugin-15>plugins</a> represented by the corresponding
   <code id=plugins-2:pluginarray-21><a href=#pluginarray>PluginArray</a></code> object, if any.<li><p>Sort <var>list</var> alphabetically by the <code id=plugins-2:dom-mimetype-type-4><a href=#dom-mimetype-type>type</a></code> of each <code id=plugins-2:mimetype-19><a href=#mimetype>MimeType</a></code>.<li><p>Return the <var>index</var>th entry in <var>list</var>.</ol>

  <p class=note>It is important <a href=#fingerprinting-vector id=plugins-2:fingerprinting-vector-7 class=no-backref>for
  privacy</a> that the order of MIME types not leak additional information, e.g. the order in
  which plugins were installed.</p>

  <p>The <a id=plugins-2:supported-property-names-3 href=https://heycam.github.io/webidl/#dfn-supported-property-names data-x-internal=supported-property-names>supported property names</a> of a <code id=plugins-2:mimetypearray-10><a href=#mimetypearray>MimeTypeArray</a></code> object are the values
  of the <code id=plugins-2:dom-mimetype-type-5><a href=#dom-mimetype-type>type</a></code> attributes of all the <code id=plugins-2:mimetype-20><a href=#mimetype>MimeType</a></code>
  objects represented by the <code id=plugins-2:mimetypearray-11><a href=#mimetypearray>MimeTypeArray</a></code> object.
  <a href=#fingerprinting-vector id=plugins-2:fingerprinting-vector-8 class=fingerprint title="There is a potential fingerprinting vector here."><img alt="(This is a fingerprinting vector.)" src=/images/fingerprint.png width=46 height=64></a>
  </p>

  <p>The <dfn id=dom-mimetypearray-nameditem><code>namedItem()</code></dfn> method of a
  <code id=plugins-2:mimetypearray-12><a href=#mimetypearray>MimeTypeArray</a></code> object must return null if the argument is not one of the object's
  <a id=plugins-2:supported-property-names-4 href=https://heycam.github.io/webidl/#dfn-supported-property-names data-x-internal=supported-property-names>supported property names</a>, and otherwise must return the <code id=plugins-2:mimetype-21><a href=#mimetype>MimeType</a></code> object
  that has a <code id=plugins-2:dom-mimetype-type-6><a href=#dom-mimetype-type>type</a></code> equal to the method's argument.</p>

  <hr>

  <p>A <code id=plugins-2:dom-plugin-19><a href=#dom-plugin>Plugin</a></code> object represents a <a href=#plugin id=plugins-2:plugin-16>plugin</a>. It has
  several attributes to provide details about the plugin, and can be enumerated to obtain the list
  of <a href=https://mimesniff.spec.whatwg.org/#mime-type id=plugins-2:mime-type-9 data-x-internal=mime-type>MIME types</a> that it <a href=#explicitly-supported id=plugins-2:explicitly-supported-6>explicitly
  supports</a>.</p>

  <p>The <code id=plugins-2:dom-plugin-20><a href=#dom-plugin>Plugin</a></code> objects created by a user agent must not be
  <a href=#live id=plugins-2:live-3>live</a>. The set of MIME types represented by the objects, and the values of the
  objects' attributes, must not change once an object is created, except when updated by the
  <code id=plugins-2:pluginarray-22><a href=#pluginarray>PluginArray</a></code> object's <code id=plugins-2:dom-pluginarray-refresh-6><a href=#dom-pluginarray-refresh>refresh()</a></code>
  method.</p>

  <p>The <dfn id=reported-mime-types>reported MIME types</dfn> for a <code id=plugins-2:dom-plugin-21><a href=#dom-plugin>Plugin</a></code> object are the
  <a href=https://mimesniff.spec.whatwg.org/#mime-type id=plugins-2:mime-type-10 data-x-internal=mime-type>MIME types</a> <a href=#explicitly-supported id=plugins-2:explicitly-supported-7>explicitly supported</a> by the corresponding
  <a href=#plugin id=plugins-2:plugin-17>plugin</a> when this object was last created or updated by <code id=plugins-2:dom-pluginarray-refresh-7><a href=#dom-pluginarray-refresh>PluginArray.refresh()</a></code>, whichever happened most
  recently.</p>

  <p>The <a id=plugins-2:supported-property-indices-5 href=https://heycam.github.io/webidl/#dfn-supported-property-indices data-x-internal=supported-property-indices>supported property indices</a> of a <code id=plugins-2:dom-plugin-22><a href=#dom-plugin>Plugin</a></code> object
  are the numbers from zero to the number of <a href=#reported-mime-types id=plugins-2:reported-mime-types>reported MIME types</a>.
  <a href=#fingerprinting-vector id=plugins-2:fingerprinting-vector-9 class=fingerprint title="There is a potential fingerprinting vector here."><img alt="(This is a fingerprinting vector.)" src=/images/fingerprint.png width=46 height=64></a>
  </p>

  <p>The <dfn id=dom-plugin-length><code>length</code></dfn> attribute must return the number
  of <a href=#reported-mime-types id=plugins-2:reported-mime-types-2>reported MIME types</a>.
  <a href=#fingerprinting-vector id=plugins-2:fingerprinting-vector-10 class=fingerprint title="There is a potential fingerprinting vector here."><img alt="(This is a fingerprinting vector.)" src=/images/fingerprint.png width=46 height=64></a>
  </p>

  <p>The <dfn id=dom-plugin-item><code>item()</code></dfn> method of a <code id=plugins-2:dom-plugin-23><a href=#dom-plugin>Plugin</a></code> object must return null if the argument is not one of the
  object's <a id=plugins-2:supported-property-indices-6 href=https://heycam.github.io/webidl/#dfn-supported-property-indices data-x-internal=supported-property-indices>supported property indices</a>, and otherwise must return the result of running
  the following steps, using the method's argument as <var>index</var>:</p>

  <ol><li><p>Let <var>list</var> be the <code id=plugins-2:mimetype-22><a href=#mimetype>MimeType</a></code> objects representing the
   <a href=#reported-mime-types id=plugins-2:reported-mime-types-3>reported MIME types</a>.<li><p>Sort <var>list</var> alphabetically by the <code id=plugins-2:dom-mimetype-type-7><a href=#dom-mimetype-type>type</a></code> of each <code id=plugins-2:mimetype-23><a href=#mimetype>MimeType</a></code>.<li><p>Return the <var>index</var>th entry in <var>list</var>.</ol>

  <p class=note>It is important <a href=#fingerprinting-vector id=plugins-2:fingerprinting-vector-11 class=no-backref>for
  privacy</a> that the order of MIME types not leak additional information, e.g. the order in
  which plugins were installed.</p>

  <p>The <a id=plugins-2:supported-property-names-5 href=https://heycam.github.io/webidl/#dfn-supported-property-names data-x-internal=supported-property-names>supported property names</a> of a <code id=plugins-2:dom-plugin-24><a href=#dom-plugin>Plugin</a></code> object
  are the values of the <code id=plugins-2:dom-mimetype-type-8><a href=#dom-mimetype-type>type</a></code> attributes of the
  <code id=plugins-2:mimetype-24><a href=#mimetype>MimeType</a></code> objects representing the <a href=#reported-mime-types id=plugins-2:reported-mime-types-4>reported MIME types</a>.
  <a href=#fingerprinting-vector id=plugins-2:fingerprinting-vector-12 class=fingerprint title="There is a potential fingerprinting vector here."><img alt="(This is a fingerprinting vector.)" src=/images/fingerprint.png width=46 height=64></a>
  </p>

  <p>The <dfn id=dom-plugin-nameditem><code>namedItem()</code></dfn> method of a <code id=plugins-2:dom-plugin-25><a href=#dom-plugin>Plugin</a></code> object must return null if the argument is not one of the
  object's <a id=plugins-2:supported-property-names-6 href=https://heycam.github.io/webidl/#dfn-supported-property-names data-x-internal=supported-property-names>supported property names</a>, and otherwise must return the
  <code id=plugins-2:mimetype-25><a href=#mimetype>MimeType</a></code> object that has a <code id=plugins-2:dom-mimetype-type-9><a href=#dom-mimetype-type>type</a></code> equal to the
  method's argument.</p>

  <p>The <dfn id=dom-plugin-name><code>name</code></dfn> attribute must return the
  <a href=#plugin id=plugins-2:plugin-18>plugin</a>'s name.</p>

  <p>The <dfn id=dom-plugin-description><code>description</code></dfn> and <dfn id=dom-plugin-filename><code>filename</code></dfn> attributes must return user-agent-defined
  (or, in all likelihood, <a href=#plugin id=plugins-2:plugin-19>plugin</a>-defined) strings. In each case, the same string must
  be returned each time, except that the strings returned may change when the <code id=plugins-2:dom-pluginarray-refresh-8><a href=#dom-pluginarray-refresh>PluginArray.refresh()</a></code> method updates the object.</p>

  <p class=warning>If the values returned by the <code id=plugins-2:dom-plugin-description-3><a href=#dom-plugin-description>description</a></code> or <code id=plugins-2:dom-plugin-filename-3><a href=#dom-plugin-filename>filename</a></code> attributes vary between versions of a
  <a href=#plugin id=plugins-2:plugin-20>plugin</a>, they can be used both as a fingerprinting vector and, even more importantly,
  as a trivial way to determine what security vulnerabilities a <a href=#plugin id=plugins-2:plugin-21>plugin</a> (and thus a
  browser) may have. It is thus highly recommended that the <code id=plugins-2:dom-plugin-description-4><a href=#dom-plugin-description>description</a></code> attribute just return the same value as the
  <code id=plugins-2:dom-plugin-name-7><a href=#dom-plugin-name>name</a></code> attribute, and that the <code id=plugins-2:dom-plugin-filename-4><a href=#dom-plugin-filename>filename</a></code> attribute return the empty string.
  <a href=#fingerprinting-vector id=plugins-2:fingerprinting-vector-13 class=fingerprint title="There is a potential fingerprinting vector here."><img alt="(This is a fingerprinting vector.)" src=/images/fingerprint.png width=46 height=64></a>
  </p>

  <hr>

  <p>A <code id=plugins-2:mimetype-26><a href=#mimetype>MimeType</a></code> object represents a <a id=plugins-2:mime-type-11 href=https://mimesniff.spec.whatwg.org/#mime-type data-x-internal=mime-type>MIME type</a> that is, or was,
  <a href=#explicitly-supported id=plugins-2:explicitly-supported-8>explicitly supported</a> by a <a href=#plugin id=plugins-2:plugin-22>plugin</a>.</p>

  <p>The <code id=plugins-2:mimetype-27><a href=#mimetype>MimeType</a></code> objects created by a user agent must not be <a href=#live id=plugins-2:live-4>live</a>. The
  values of the objects' attributes must not change once an object is created, except when updated
  by the <code id=plugins-2:pluginarray-23><a href=#pluginarray>PluginArray</a></code> object's <code id=plugins-2:dom-pluginarray-refresh-9><a href=#dom-pluginarray-refresh>refresh()</a></code>
  method.</p>

  <p>The <dfn id=dom-mimetype-type><code>type</code></dfn> attribute must return the
  <a id=plugins-2:valid-mime-type-with-no-parameters href=https://mimesniff.spec.whatwg.org/#valid-mime-type-with-no-parameters data-x-internal=valid-mime-type-with-no-parameters>valid MIME type with no parameters</a> describing the <a id=plugins-2:mime-type-12 href=https://mimesniff.spec.whatwg.org/#mime-type data-x-internal=mime-type>MIME type</a>.</p>

  <p>The <dfn id=dom-mimetype-description><code>description</code></dfn> and <dfn id=dom-mimetype-suffixes><code>suffixes</code></dfn> attributes must return
  user-agent-defined (or, in all likelihood, <a href=#plugin id=plugins-2:plugin-23>plugin</a>-defined) strings. In each case, the
  same string must be returned each time, except that the strings returned may change when the <code id=plugins-2:dom-pluginarray-refresh-10><a href=#dom-pluginarray-refresh>PluginArray.refresh()</a></code> method updates the object.</p>

  <p class=warning>If the values returned by the <code id=plugins-2:dom-mimetype-description-3><a href=#dom-mimetype-description>description</a></code> or <code id=plugins-2:dom-mimetype-suffixes-3><a href=#dom-mimetype-suffixes>suffixes</a></code> attributes vary between versions of a
  <a href=#plugin id=plugins-2:plugin-24>plugin</a>, they can be used both as a fingerprinting vector and, even more importantly,
  as a trivial way to determine what security vulnerabilities a <a href=#plugin id=plugins-2:plugin-25>plugin</a> (and thus a
  browser) may have. It is thus highly recommended that the <code id=plugins-2:dom-mimetype-description-4><a href=#dom-mimetype-description>description</a></code> attribute just return the same value as the
  <code id=plugins-2:dom-mimetype-type-10><a href=#dom-mimetype-type>type</a></code> attribute, and that the <code id=plugins-2:dom-mimetype-suffixes-4><a href=#dom-mimetype-suffixes>suffixes</a></code> attribute return the empty string.
  <a href=#fingerprinting-vector id=plugins-2:fingerprinting-vector-14 class=fingerprint title="There is a potential fingerprinting vector here."><img alt="(This is a fingerprinting vector.)" src=/images/fingerprint.png width=46 height=64></a>
  </p>

  <p class=note>Commas in the <code id=plugins-2:dom-mimetype-suffixes-5><a href=#dom-mimetype-suffixes>suffixes</a></code> attribute are
  interpreted as separating subsequent filename extensions, as in "<code>htm,html</code>".</p>

  <p>The <dfn id=dom-mimetype-enabledplugin><code>enabledPlugin</code></dfn> attribute must
  return the <code id=plugins-2:dom-plugin-26><a href=#dom-plugin>Plugin</a></code> object that represents the <a href=#plugin id=plugins-2:plugin-26>plugin</a>
  that <a href=#explicitly-supported id=plugins-2:explicitly-supported-9>explicitly supported</a> the <a id=plugins-2:mime-type-13 href=https://mimesniff.spec.whatwg.org/#mime-type data-x-internal=mime-type>MIME type</a> that this <code id=plugins-2:mimetype-28><a href=#mimetype>MimeType</a></code>
  object represents when this object was last created or updated by <code id=plugins-2:dom-pluginarray-refresh-11><a href=#dom-pluginarray-refresh>PluginArray.refresh()</a></code>, whichever happened most
  recently.</p>

  <hr>

  <p>The <dfn id=dom-navigator-javaenabled><code>navigator.javaEnabled()</code></dfn> method
  must return true if the user agent supports a <a href=#plugin id=plugins-2:plugin-27>plugin</a> that supports the <a id=plugins-2:mime-type-14 href=https://mimesniff.spec.whatwg.org/#mime-type data-x-internal=mime-type>MIME
  type</a> "<code>application/x-java-vm</code>"; otherwise it must return false.
  <a href=#fingerprinting-vector id=plugins-2:fingerprinting-vector-15 class=fingerprint title="There is a potential fingerprinting vector here."><img alt="(This is a fingerprinting vector.)" src=/images/fingerprint.png width=46 height=64></a>
  </p>

  




  <h3 id=images-2>8.8 Images<a href=#images-2 class=self-link></a></h3>

  <pre class=idl>[Exposed=(Window,Worker)]
interface <dfn id=imagebitmap>ImageBitmap</dfn> {
  readonly attribute unsigned long <a href=#dom-imagebitmap-width id=images-2:dom-imagebitmap-width>width</a>;
  readonly attribute unsigned long <a href=#dom-imagebitmap-height id=images-2:dom-imagebitmap-height>height</a>;
  void <a href=#dom-imagebitmap-close id=images-2:dom-imagebitmap-close>close</a>();
};

typedef (<a href=#canvasimagesource id=images-2:canvasimagesource>CanvasImageSource</a> or
         <a id=images-2:blob href=https://w3c.github.io/FileAPI/#blob data-x-internal=blob>Blob</a> or
         <a href=#imagedata id=images-2:imagedata>ImageData</a>) <dfn id=imagebitmapsource>ImageBitmapSource</dfn>;

enum <dfn id=imageorientation>ImageOrientation</dfn> { "<a href=#dom-imageorientation-none id=images-2:dom-imageorientation-none>none</a>", "<a href=#dom-imageorientation-flipy id=images-2:dom-imageorientation-flipy>flipY</a>" };
enum <dfn id=premultiplyalpha>PremultiplyAlpha</dfn> { "<a href=#dom-premultiplyalpha-none id=images-2:dom-premultiplyalpha-none>none</a>", "<a href=#dom-premultiplyalpha-premultiply id=images-2:dom-premultiplyalpha-premultiply>premultiply</a>", "<a href=#dom-premultiplyalpha-default id=images-2:dom-premultiplyalpha-default>default</a>" };
enum <dfn id=colorspaceconversion>ColorSpaceConversion</dfn> { "<a href=#dom-colorspaceconversion-none id=images-2:dom-colorspaceconversion-none>none</a>", "<a href=#dom-colorspaceconversion-default id=images-2:dom-colorspaceconversion-default>default</a>" };
enum <dfn id=resizequality>ResizeQuality</dfn> { "<a href=#dom-resizequality-pixelated id=images-2:dom-resizequality-pixelated>pixelated</a>", "<a href=#dom-resizequality-low id=images-2:dom-resizequality-low>low</a>", "<a href=#dom-resizequality-medium id=images-2:dom-resizequality-medium>medium</a>", "<a href=#dom-resizequality-high id=images-2:dom-resizequality-high>high</a>" };

dictionary <dfn id=imagebitmapoptions>ImageBitmapOptions</dfn> {
  <a href=#imageorientation id=images-2:imageorientation>ImageOrientation</a> <a href=#dom-imagebitmapoptions-imageorientation id=images-2:dom-imagebitmapoptions-imageorientation>imageOrientation</a> = "<a href=#dom-imageorientation-none id=images-2:dom-imageorientation-none-2>none</a>";
  <a href=#premultiplyalpha id=images-2:premultiplyalpha>PremultiplyAlpha</a> <a href=#dom-imagebitmapoptions-premultiplyalpha id=images-2:dom-imagebitmapoptions-premultiplyalpha>premultiplyAlpha</a> = "<a href=#dom-premultiplyalpha-default id=images-2:dom-premultiplyalpha-default-2>default</a>";
  <a href=#colorspaceconversion id=images-2:colorspaceconversion>ColorSpaceConversion</a> <a href=#dom-imagebitmapoptions-colorspaceconversion id=images-2:dom-imagebitmapoptions-colorspaceconversion>colorSpaceConversion</a> = "<a href=#dom-colorspaceconversion-default id=images-2:dom-colorspaceconversion-default-2>default</a>";
  [EnforceRange] unsigned long <a href=#dom-imagebitmapoptions-resizewidth id=images-2:dom-imagebitmapoptions-resizewidth>resizeWidth</a>;
  [EnforceRange] unsigned long <a href=#dom-imagebitmapoptions-resizeheight id=images-2:dom-imagebitmapoptions-resizeheight>resizeHeight</a>;
  <a href=#resizequality id=images-2:resizequality>ResizeQuality</a> <a href=#dom-imagebitmapoptions-resizequality id=images-2:dom-imagebitmapoptions-resizequality>resizeQuality</a> = "<a href=#dom-resizequality-low id=images-2:dom-resizequality-low-2>low</a>";
};</pre>

  <p>An <code id=images-2:imagebitmap><a href=#imagebitmap>ImageBitmap</a></code> object represents a bitmap image that can be painted to a canvas
  without undue latency.</p>

  <p class=note>The exact judgement of what is undue latency of this is left up to the
  implementer, but in general if making use of the bitmap requires network I/O, or even local disk
  I/O, then the latency is probably undue; whereas if it only requires a blocking read from a GPU or
  system RAM, the latency is probably acceptable.</p>

  <dl class=domintro><dt><var>promise</var> = self . <code id=images-2:dom-createimagebitmap><a href=#dom-createimagebitmap>createImageBitmap</a></code>(<var>image</var> [, <var>options</var> ])<dt><var>promise</var> = self . <code id=images-2:dom-createimagebitmap-2><a href=#dom-createimagebitmap>createImageBitmap</a></code>(<var>image</var>, <var>sx</var>, <var>sy</var>, <var>sw</var>, <var>sh</var> [, <var>options</var> ])<dd>

    <p>Takes <var>image</var>, which can be an <code id=images-2:the-img-element><a href=#the-img-element>img</a></code> element, an <a id=images-2:svg-image href=https://www.w3.org/TR/SVG11/struct.html#ImageElement data-x-internal=svg-image>SVG
    <code>image</code></a> element, a <code id=images-2:the-video-element><a href=#the-video-element>video</a></code> element, a <code id=images-2:the-canvas-element><a href=#the-canvas-element>canvas</a></code>
    element, a <code id=images-2:blob-2><a data-x-internal=blob href=https://w3c.github.io/FileAPI/#blob>Blob</a></code> object, an <code id=images-2:imagedata-2><a href=#imagedata>ImageData</a></code> object, or another
    <code id=images-2:imagebitmap-2><a href=#imagebitmap>ImageBitmap</a></code> object, and returns a promise that is resolved when a new
    <code id=images-2:imagebitmap-3><a href=#imagebitmap>ImageBitmap</a></code> is created.</p>

    <p>If no <code id=images-2:imagebitmap-4><a href=#imagebitmap>ImageBitmap</a></code> object can be constructed, for example because the provided
    <var>image</var> data is not actually an image, then the promise is rejected instead.</p>

    <p>If <var>sx</var>, <var>sy</var>, <var>sw</var>, and <var>sh</var> arguments are provided, the source image is cropped to the given pixels, with
    any pixels missing in the original replaced by transparent black. These coordinates are in the
    source image's pixel coordinate space, <em>not</em> in <a href=https://drafts.csswg.org/css-values/#px id="images-2:'px'" data-x-internal="'px'">CSS
    pixels</a>.</p>

    <p>If <var>options</var> is provided, the <code id=images-2:imagebitmap-5><a href=#imagebitmap>ImageBitmap</a></code> object's bitmap
    data is modified according to <var>options</var>. For example,
    if the <code id=images-2:dom-imagebitmapoptions-premultiplyalpha-2><a href=#dom-imagebitmapoptions-premultiplyalpha>premultiplyAlpha</a></code>
    option is set to "<code id=images-2:dom-premultiplyalpha-premultiply-2><a href=#dom-premultiplyalpha-premultiply>premultiply</a></code>",
    the <a href=#concept-imagebitmap-bitmap-data id=images-2:concept-imagebitmap-bitmap-data>bitmap data</a>'s color channels are
    premultiplied by its alpha channel.

    <p>Rejects the promise with an <a id=images-2:invalidstateerror href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a>
    <code id=images-2:domexception><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> if the source image is not in a valid state (e.g. an <code id=images-2:the-img-element-2><a href=#the-img-element>img</a></code>
    element that hasn't loaded successfully, an <code id=images-2:imagebitmap-6><a href=#imagebitmap>ImageBitmap</a></code> object whose
    <a href=#detached id=images-2:detached>[[Detached]]</a> internal slot value is true, an <code id=images-2:imagedata-3><a href=#imagedata>ImageData</a></code> object whose
    <code id=images-2:dom-imagedata-data><a href=#dom-imagedata-data>data</a></code> attribute value's <a href=#detached id=images-2:detached-2>[[Detached]]</a>
    internal slot value is true, or a <code id=images-2:blob-3><a data-x-internal=blob href=https://w3c.github.io/FileAPI/#blob>Blob</a></code> whose data cannot be interpreted as a bitmap
    image).</p>

    <p>Rejects the promise with a <a id=images-2:securityerror href=https://heycam.github.io/webidl/#securityerror data-x-internal=securityerror>"<code>SecurityError</code>"</a>
    <code id=images-2:domexception-2><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> if the script is not allowed to access the image data of the source
    image (e.g. a <code id=images-2:the-video-element-2><a href=#the-video-element>video</a></code> that is <a href=#cors-cross-origin id=images-2:cors-cross-origin>CORS-cross-origin</a>, or a
    <code id=images-2:the-canvas-element-2><a href=#the-canvas-element>canvas</a></code> being drawn on by a script in a worker from another
    <a href=#concept-origin id=images-2:concept-origin>origin</a>).</p>

   <dt><var>imageBitmap</var> . <code id=images-2:dom-imagebitmap-close-2><a href=#dom-imagebitmap-close>close</a></code>()<dd>

    <p>Releases <var>imageBitmap</var>'s underlying <a href=#concept-imagebitmap-bitmap-data id=images-2:concept-imagebitmap-bitmap-data-2>bitmap data</a>.</p>

   <dt><var>imageBitmap</var> . <code id=images-2:dom-imagebitmap-width-2><a href=#dom-imagebitmap-width>width</a></code><dd>

    <p>Returns the <a href=#intrinsic-width id=images-2:intrinsic-width>intrinsic width</a> of the image, in <a href=https://drafts.csswg.org/css-values/#px id="images-2:'px'-2" data-x-internal="'px'">CSS
    pixels</a>.</p>

   <dt><var>imageBitmap</var> . <code id=images-2:dom-imagebitmap-height-2><a href=#dom-imagebitmap-height>height</a></code><dd>

    <p>Returns the <a href=#intrinsic-height id=images-2:intrinsic-height>intrinsic height</a> of the image, in <a href=https://drafts.csswg.org/css-values/#px id="images-2:'px'-3" data-x-internal="'px'">CSS
    pixels</a>.</p>

   </dl>

  

  <p>An <code id=images-2:imagebitmap-7><a href=#imagebitmap>ImageBitmap</a></code> object whose <a href=#detached id=images-2:detached-3>[[Detached]]</a> internal slot value
  is false always has associated <dfn id=concept-imagebitmap-bitmap-data>bitmap data</dfn>,
  with a width and a height. However, it is possible for this data to be corrupted. If an
  <code id=images-2:imagebitmap-8><a href=#imagebitmap>ImageBitmap</a></code> object's media data can be decoded without errors, it is said to be <dfn id=concept-imagebitmap-good>fully decodable</dfn>.</p>

  <p>An <code id=images-2:imagebitmap-9><a href=#imagebitmap>ImageBitmap</a></code> object's bitmap has an <a href=#concept-canvas-origin-clean id=images-2:concept-canvas-origin-clean>origin-clean</a> flag, which indicates whether the
  bitmap is tainted by content from a different <a href=#concept-origin id=images-2:concept-origin-2>origin</a>. The flag is initially set to
  true and may be changed to false by the steps of <code id=images-2:dom-createimagebitmap-3><a href=#dom-createimagebitmap>createImageBitmap()</a></code>.</p>

  <p><code id=images-2:imagebitmap-10><a href=#imagebitmap>ImageBitmap</a></code> objects are <a href=#cloneable-objects id=images-2:cloneable-objects>cloneable objects</a> and <a href=#transferable-objects id=images-2:transferable-objects>transferable
  objects</a>.</p>

  <p>Each <code id=images-2:imagebitmap-11><a href=#imagebitmap>ImageBitmap</a></code> object's <a href=#clone-() id=images-2:clone-()>[[Clone]](<var>targetRealm</var>, <var>memory</var>)</a> internal method
  must run these steps:</p>

  <ol><li><p>If <b>this</b>'s <a href=#detached id=images-2:detached-4>[[Detached]]</a> internal slot is true, then throw a
   <a id=images-2:datacloneerror href=https://heycam.github.io/webidl/#datacloneerror data-x-internal=datacloneerror>"<code>DataCloneError</code>"</a> <code id=images-2:domexception-3><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code>.<li><p>Return a new <code id=images-2:imagebitmap-12><a href=#imagebitmap>ImageBitmap</a></code> object in <var>targetRealm</var> whose <a href=#concept-imagebitmap-bitmap-data id=images-2:concept-imagebitmap-bitmap-data-3>bitmap data</a> is a copy of <b>this</b>'s <a href=#concept-imagebitmap-bitmap-data id=images-2:concept-imagebitmap-bitmap-data-4>bitmap data</a>, and whose <a href=#concept-canvas-origin-clean id=images-2:concept-canvas-origin-clean-2>origin-clean</a> flag is set to the same value as
   <b>this</b>'s <a href=#concept-canvas-origin-clean id=images-2:concept-canvas-origin-clean-3>origin-clean</a> flag.</ol>

  <p>Each <code id=images-2:imagebitmap-13><a href=#imagebitmap>ImageBitmap</a></code> object's <a href=#transfer-() id=images-2:transfer-()>[[Transfer]](<var>targetRealm</var>)</a> internal method must run these
  steps:</p>

  <ol><li><p>Let <var>new</var> be a new <code id=images-2:imagebitmap-14><a href=#imagebitmap>ImageBitmap</a></code> object in <var>targetRealm</var>,
   pointing at the same underlying <a href=#concept-imagebitmap-bitmap-data id=images-2:concept-imagebitmap-bitmap-data-5>bitmap data</a>
   as <b>this</b>.<li><p>Set <var>new</var>'s bitmap's <a href=#concept-canvas-origin-clean id=images-2:concept-canvas-origin-clean-4>origin-clean</a> flag to the same values as
   <b>this</b>'s bitmap's <a href=#concept-canvas-origin-clean id=images-2:concept-canvas-origin-clean-5>origin-clean</a>
   flag.<li><p>Set <b>this</b>'s <a href=#detached id=images-2:detached-5>[[Detached]]</a> internal slot value to true.<li><p>Unset <b>this</b>'s <a href=#concept-imagebitmap-bitmap-data id=images-2:concept-imagebitmap-bitmap-data-6>bitmap
   data</a>.<li><p>Return <var>new</var>.</ol>

  <p>An <code id=images-2:imagebitmap-15><a href=#imagebitmap>ImageBitmap</a></code> object can be obtained from a variety of different objects, using
  the <dfn id=dom-createimagebitmap><code>createImageBitmap()</code></dfn> method. When
  invoked, the method must act as follows:</p>
  

  <dl><dt>If <var>image</var> is an <code id=images-2:the-img-element-3><a href=#the-img-element>img</a></code> element
   <dt>If <var>image</var> is an <a id=images-2:svg-image-2 href=https://www.w3.org/TR/SVG11/struct.html#ImageElement data-x-internal=svg-image>SVG <code>image</code></a> element

   <dd>

    <ol><li><p>If either the <var>sw</var> or <var>sh</var> arguments are specified
     but zero, return a promise rejected with an <a id=images-2:indexsizeerror href=https://heycam.github.io/webidl/#indexsizeerror data-x-internal=indexsizeerror>"<code>IndexSizeError</code>"</a>
     <code id=images-2:domexception-4><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these steps.<li><p>If <var>image</var> is not <a href=#img-all id=images-2:img-all>completely available</a>, then
     return a promise rejected with an <a id=images-2:invalidstateerror-2 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a>
     <code id=images-2:domexception-5><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these steps.<li><p>If <var>image</var>'s media data has no <a id=images-2:intrinsic-dimensions href=https://drafts.csswg.org/css2/conform.html#intrinsic data-x-internal=intrinsic-dimensions>intrinsic dimensions</a> (e.g. it's a
     vector graphic with no specified content size), and both or either of the <dfn id=dom-imagebitmapoptions-resizewidth><code>resizeWidth</code></dfn> and <dfn id=dom-imagebitmapoptions-resizeheight><code>resizeHeight</code></dfn> options are not specified,
     then return a promise rejected with an <a id=images-2:invalidstateerror-3 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a>
     <code id=images-2:domexception-6><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these steps.<li><p>If <var>image</var>'s media data has no <a id=images-2:intrinsic-dimensions-2 href=https://drafts.csswg.org/css2/conform.html#intrinsic data-x-internal=intrinsic-dimensions>intrinsic dimensions</a> (e.g. it's a vector
     graphics with no specified content size), it should be rendered to a bitmap of the size
     specified by the <code id=images-2:dom-imagebitmapoptions-resizewidth-2><a href=#dom-imagebitmapoptions-resizewidth>resizeWidth</a></code> and the
     <code id=images-2:dom-imagebitmapoptions-resizeheight-2><a href=#dom-imagebitmapoptions-resizeheight>resizeHeight</a></code> options.<li><p>If the <var>sw</var> and <var>sh</var> arguments are not specified and
     <var>image</var>'s media data has both or either of its <a href=#intrinsic-width id=images-2:intrinsic-width-2>intrinsic width</a> and
     <a href=#intrinsic-height id=images-2:intrinsic-height-2>intrinsic height</a> values equal to 0, then return a promise rejected with an
     <a id=images-2:invalidstateerror-4 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a> <code id=images-2:domexception-7><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these
     steps.<li><p>If the <var>sh</var> argument is not specified and <var>image</var>'s media data has
     an <a href=#intrinsic-height id=images-2:intrinsic-height-3>intrinsic height</a> of 0, then return a promise rejected with an
     <a id=images-2:invalidstateerror-5 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a> <code id=images-2:domexception-8><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these
     steps.<li><p>Create a new <code id=images-2:imagebitmap-16><a href=#imagebitmap>ImageBitmap</a></code> object.<li><p>Let the <code id=images-2:imagebitmap-17><a href=#imagebitmap>ImageBitmap</a></code> object's <a href=#concept-imagebitmap-bitmap-data id=images-2:concept-imagebitmap-bitmap-data-7>bitmap data</a> be a copy of <var>image</var>'s
     media data, <a href=#cropped-to-the-source-rectangle-with-formatting id=images-2:cropped-to-the-source-rectangle-with-formatting>cropped to the source rectangle with formatting</a>. If this is an
     animated image, the <code id=images-2:imagebitmap-18><a href=#imagebitmap>ImageBitmap</a></code> object's <a href=#concept-imagebitmap-bitmap-data id=images-2:concept-imagebitmap-bitmap-data-8>bitmap data</a> must only be taken from the
     default image of the animation (the one that the format defines is to be used when animation
     is not supported or is disabled), or, if there is no such image, the first frame of the
     animation.<li><p>If the <a href=#concept-origin id=images-2:concept-origin-3>origin</a> of <var>image</var>'s image is not the <a href=#same-origin id=images-2:same-origin>same
     origin</a> as the <a href=#concept-settings-object-origin id=images-2:concept-settings-object-origin>origin</a> specified by
     the <a href=#entry-settings-object id=images-2:entry-settings-object>entry settings object</a>, then set the <a href=#concept-canvas-origin-clean id=images-2:concept-canvas-origin-clean-6>origin-clean</a> flag of the <code id=images-2:imagebitmap-19><a href=#imagebitmap>ImageBitmap</a></code>
     object's bitmap to false.<li><p>Return a new promise, but continue running these steps
     <a href=#in-parallel id=images-2:in-parallel>in parallel</a>.<li><p>Resolve the promise with the new <code id=images-2:imagebitmap-20><a href=#imagebitmap>ImageBitmap</a></code> object as the value.</ol>

   <dt>If <var>image</var> is a <code id=images-2:the-video-element-3><a href=#the-video-element>video</a></code> element

   <dd>

    <ol><li><p>If either the <var>sw</var> or <var>sh</var> arguments are specified
     but zero, return a promise rejected with an <a id=images-2:indexsizeerror-2 href=https://heycam.github.io/webidl/#indexsizeerror data-x-internal=indexsizeerror>"<code>IndexSizeError</code>"</a>
     <code id=images-2:domexception-9><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these steps.<li><p>If the <code id=images-2:the-video-element-4><a href=#the-video-element>video</a></code> element's <code id=images-2:dom-media-networkstate><a href=#dom-media-networkstate>networkState</a></code> attribute is <code id=images-2:dom-media-network_empty><a href=#dom-media-network_empty>NETWORK_EMPTY</a></code>, then return a promise rejected with an
     <a id=images-2:invalidstateerror-6 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a> <code id=images-2:domexception-10><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these
     steps.<li><p>If the <code id=images-2:the-video-element-5><a href=#the-video-element>video</a></code> element's <code id=images-2:dom-media-readystate><a href=#dom-media-readystate>readyState</a></code> attribute is either <code id=images-2:dom-media-have_nothing><a href=#dom-media-have_nothing>HAVE_NOTHING</a></code> or <code id=images-2:dom-media-have_metadata><a href=#dom-media-have_metadata>HAVE_METADATA</a></code>, then return a promise rejected with an
     <a id=images-2:invalidstateerror-7 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a> <code id=images-2:domexception-11><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these
     steps.<li><p>Create a new <code id=images-2:imagebitmap-21><a href=#imagebitmap>ImageBitmap</a></code> object.<li><p>Let the <code id=images-2:imagebitmap-22><a href=#imagebitmap>ImageBitmap</a></code> object's <a href=#concept-imagebitmap-bitmap-data id=images-2:concept-imagebitmap-bitmap-data-9>bitmap data</a> be a copy of the frame at the
     <a href=#current-playback-position id=images-2:current-playback-position>current playback position</a>, at the <a href=#media-resource id=images-2:media-resource>media resource</a>'s <a href=#concept-video-intrinsic-width id=images-2:concept-video-intrinsic-width>intrinsic width</a> and <a href=#concept-video-intrinsic-height id=images-2:concept-video-intrinsic-height>intrinsic height</a> (i.e. after any aspect-ratio
     correction has been applied), <a href=#cropped-to-the-source-rectangle-with-formatting id=images-2:cropped-to-the-source-rectangle-with-formatting-2>cropped to the source rectangle with formatting</a>.</p>

     <li><p>If the <a href=#concept-origin id=images-2:concept-origin-4>origin</a> of the <code id=images-2:the-video-element-6><a href=#the-video-element>video</a></code> element is not the <a href=#same-origin id=images-2:same-origin-2>same
     origin</a> as the <a href=#concept-settings-object-origin id=images-2:concept-settings-object-origin-2>origin</a> specified by
     the <a href=#entry-settings-object id=images-2:entry-settings-object-2>entry settings object</a>, then set the <a href=#concept-canvas-origin-clean id=images-2:concept-canvas-origin-clean-7>origin-clean</a> flag of the <code id=images-2:imagebitmap-23><a href=#imagebitmap>ImageBitmap</a></code>
     object's bitmap to false.<li><p>Return a new promise, but continue running these steps
     <a href=#in-parallel id=images-2:in-parallel-2>in parallel</a>.<li><p>Resolve the promise with the new <code id=images-2:imagebitmap-24><a href=#imagebitmap>ImageBitmap</a></code> object as the value.</ol>

   <dt>If <var>image</var> is a <code id=images-2:the-canvas-element-3><a href=#the-canvas-element>canvas</a></code> element

   <dd>

    <ol><li><p>If either the <var>sw</var> or <var>sh</var> arguments are specified
     but zero, return a promise rejected with an <a id=images-2:indexsizeerror-3 href=https://heycam.github.io/webidl/#indexsizeerror data-x-internal=indexsizeerror>"<code>IndexSizeError</code>"</a>
     <code id=images-2:domexception-12><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these steps.<li><p>If the <code id=images-2:the-canvas-element-4><a href=#the-canvas-element>canvas</a></code> element's bitmap has either a horizontal dimension or a
     vertical dimension equal to zero, then return a promise rejected with an
     <a id=images-2:invalidstateerror-8 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a> <code id=images-2:domexception-13><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these
     steps.<li><p>Create a new <code id=images-2:imagebitmap-25><a href=#imagebitmap>ImageBitmap</a></code> object.<li><p>Let the <code id=images-2:imagebitmap-26><a href=#imagebitmap>ImageBitmap</a></code> object's <a href=#concept-imagebitmap-bitmap-data id=images-2:concept-imagebitmap-bitmap-data-10>bitmap data</a> be a copy of the
     <code id=images-2:the-canvas-element-5><a href=#the-canvas-element>canvas</a></code> element's <a href=#concept-imagebitmap-bitmap-data id=images-2:concept-imagebitmap-bitmap-data-11>bitmap data</a>, <a href=#cropped-to-the-source-rectangle-with-formatting id=images-2:cropped-to-the-source-rectangle-with-formatting-3>cropped to the source
     rectangle with formatting</a>.<li><p>Set the <a href=#concept-canvas-origin-clean id=images-2:concept-canvas-origin-clean-8>origin-clean</a> flag of the
     <code id=images-2:imagebitmap-27><a href=#imagebitmap>ImageBitmap</a></code> object's bitmap to the same value as the <a href=#concept-canvas-origin-clean id=images-2:concept-canvas-origin-clean-9>origin-clean</a> flag of the <code id=images-2:the-canvas-element-6><a href=#the-canvas-element>canvas</a></code>
     element's bitmap.<li><p>Return a new promise, but continue running these steps
     <a href=#in-parallel id=images-2:in-parallel-3>in parallel</a>.<li><p>Resolve the promise with the new <code id=images-2:imagebitmap-28><a href=#imagebitmap>ImageBitmap</a></code> object as the value.</ol>

   <dt>If <var>image</var> is a <code id=images-2:blob-4><a data-x-internal=blob href=https://w3c.github.io/FileAPI/#blob>Blob</a></code> object

   <dd>

    <ol><li><p>If either the <var>sw</var> or <var>sh</var> arguments are specified
     but zero, return a promise rejected with an <a id=images-2:indexsizeerror-4 href=https://heycam.github.io/webidl/#indexsizeerror data-x-internal=indexsizeerror>"<code>IndexSizeError</code>"</a>
     <code id=images-2:domexception-14><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these steps.<li><p>If <var>image</var> is <a href=https://w3c.github.io/FileAPI/#closed id=images-2:concept-blob-closed data-x-internal=concept-blob-closed>closed</a>, then return a
     promise rejected with an <a id=images-2:invalidstateerror-9 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a>
     <code id=images-2:domexception-15><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these steps.<li><p>Return a new promise, but continue running these steps
     <a href=#in-parallel id=images-2:in-parallel-4>in parallel</a>.<li><p>Read the <code id=images-2:blob-5><a data-x-internal=blob href=https://w3c.github.io/FileAPI/#blob>Blob</a></code> object's data. If an <a href=#file-error-read id=images-2:file-error-read>error
     occurs during reading of the object</a>, then reject the promise with an
     <a id=images-2:invalidstateerror-10 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a> <code id=images-2:domexception-16><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code>, and abort these
     steps.<li><p>Apply the <a href=https://mimesniff.spec.whatwg.org/#rules-for-sniffing-images-specifically id=images-2:content-type-sniffing:-image data-x-internal=content-type-sniffing:-image>image sniffing rules</a> to
     determine the file format of the image data, with MIME type of the <code id=images-2:blob-6><a data-x-internal=blob href=https://w3c.github.io/FileAPI/#blob>Blob</a></code> (as given
     by the <code id=images-2:blob-7><a data-x-internal=blob href=https://w3c.github.io/FileAPI/#blob>Blob</a></code> object's <code id=images-2:dom-blob-type><a data-x-internal=dom-blob-type href=https://w3c.github.io/FileAPI/#dfn-type>type</a></code> attribute) giving
     the official type.<li><p>If the image data is not in a supported image file format (e.g. it's not an image at
     all), or if the image data is corrupted in some fatal way such that the image dimensions
     cannot be obtained (e.g. a vector graphic with no intrinsic size), then reject the promise
     with an <a id=images-2:invalidstateerror-11 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a> <code id=images-2:domexception-17><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code>, and abort
     these steps.<li><p>Create a new <code id=images-2:imagebitmap-29><a href=#imagebitmap>ImageBitmap</a></code> object.<li><p>Let the <code id=images-2:imagebitmap-30><a href=#imagebitmap>ImageBitmap</a></code> object's <a href=#concept-imagebitmap-bitmap-data id=images-2:concept-imagebitmap-bitmap-data-12>bitmap data</a> be the image data read from the
     <code id=images-2:blob-8><a data-x-internal=blob href=https://w3c.github.io/FileAPI/#blob>Blob</a></code> object, <a href=#cropped-to-the-source-rectangle-with-formatting id=images-2:cropped-to-the-source-rectangle-with-formatting-4>cropped to the source rectangle with formatting</a>.
     If this is an animated image, the <code id=images-2:imagebitmap-31><a href=#imagebitmap>ImageBitmap</a></code> object's <a href=#concept-imagebitmap-bitmap-data id=images-2:concept-imagebitmap-bitmap-data-13>bitmap data</a> must only be taken from the
     default image of the animation (the one that the format defines is to be used when animation
     is not supported or is disabled), or, if there is no such image, the first frame of the
     animation.<li><p>Resolve the promise with the new <code id=images-2:imagebitmap-32><a href=#imagebitmap>ImageBitmap</a></code> object as the value.</ol>

   <dt>If <var>image</var> is an <code id=images-2:imagedata-4><a href=#imagedata>ImageData</a></code> object

   <dd>

    <ol><li><p>If either the <var>sw</var> or <var>sh</var> arguments are specified
     but zero, return a promise rejected with an <a id=images-2:indexsizeerror-5 href=https://heycam.github.io/webidl/#indexsizeerror data-x-internal=indexsizeerror>"<code>IndexSizeError</code>"</a>
     <code id=images-2:domexception-18><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these steps.<li><p>If the <var>image</var> object's <code id=images-2:dom-imagedata-data-2><a href=#dom-imagedata-data>data</a></code> attribute
     value's <a href=#detached id=images-2:detached-6>[[Detached]]</a> internal slot value is true, return a promise rejected with
     an <a id=images-2:invalidstateerror-12 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a> <code id=images-2:domexception-19><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these
     steps.<li><p>Create a new <code id=images-2:imagebitmap-33><a href=#imagebitmap>ImageBitmap</a></code> object.<li><p>Let the <code id=images-2:imagebitmap-34><a href=#imagebitmap>ImageBitmap</a></code> object's <a href=#concept-imagebitmap-bitmap-data id=images-2:concept-imagebitmap-bitmap-data-14>bitmap data</a> be the image data given by the
     <code id=images-2:imagedata-5><a href=#imagedata>ImageData</a></code> object, <a href=#cropped-to-the-source-rectangle-with-formatting id=images-2:cropped-to-the-source-rectangle-with-formatting-5>cropped to the source rectangle with formatting</a>.<li><p>Return a new promise, but continue running these steps
     <a href=#in-parallel id=images-2:in-parallel-5>in parallel</a>.<li><p>Resolve the promise with the new <code id=images-2:imagebitmap-35><a href=#imagebitmap>ImageBitmap</a></code> object as the value.</ol>

   <dt>If <var>image</var> is an <code id=images-2:imagebitmap-36><a href=#imagebitmap>ImageBitmap</a></code> object

   <dd>

    <ol><li><p>If either the <var>sw</var> or <var>sh</var> arguments are specified
     but zero, return a promise rejected with an <a id=images-2:indexsizeerror-6 href=https://heycam.github.io/webidl/#indexsizeerror data-x-internal=indexsizeerror>"<code>IndexSizeError</code>"</a>
     <code id=images-2:domexception-20><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these steps.<li><p>If <var>image</var>'s <a href=#detached id=images-2:detached-7>[[Detached]]</a> internal slot value is true, return a
     promise rejected with an <a id=images-2:invalidstateerror-13 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a>
     <code id=images-2:domexception-21><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these steps.<li><p>Create a new <code id=images-2:imagebitmap-37><a href=#imagebitmap>ImageBitmap</a></code> object.<li><p>Let the <code id=images-2:imagebitmap-38><a href=#imagebitmap>ImageBitmap</a></code> object's <a href=#concept-imagebitmap-bitmap-data id=images-2:concept-imagebitmap-bitmap-data-15>bitmap data</a> be a copy of the <var>image</var>
     argument's <a href=#concept-imagebitmap-bitmap-data id=images-2:concept-imagebitmap-bitmap-data-16>bitmap data</a>, <a href=#cropped-to-the-source-rectangle-with-formatting id=images-2:cropped-to-the-source-rectangle-with-formatting-6>cropped
     to the source rectangle with formatting</a>.<li><p>Set the <a href=#concept-canvas-origin-clean id=images-2:concept-canvas-origin-clean-10>origin-clean</a> flag of the
     <code id=images-2:imagebitmap-39><a href=#imagebitmap>ImageBitmap</a></code> object's bitmap to the same value as the <a href=#concept-canvas-origin-clean id=images-2:concept-canvas-origin-clean-11>origin-clean</a> flag of the bitmap of the
     <var>image</var> argument.<li><p>Return a new promise, but continue running these steps
     <a href=#in-parallel id=images-2:in-parallel-6>in parallel</a>.<li><p>Resolve the promise with the new <code id=images-2:imagebitmap-40><a href=#imagebitmap>ImageBitmap</a></code> object as the value.</ol>

   </dl>

  <p>When the steps above require that the user agent <dfn id=cropped-to-the-source-rectangle-with-formatting>crop bitmap data to the source rectangle with formatting</dfn>,
  the user agent must run the following steps:</p>

  <ol><li><p>Let <var>input</var> be the <a href=#concept-imagebitmap-bitmap-data id=images-2:concept-imagebitmap-bitmap-data-17>bitmap
   data</a> being transformed.<li><p>If either or both of <code id=images-2:dom-imagebitmapoptions-resizewidth-3><a href=#dom-imagebitmapoptions-resizewidth>resizeWidth</a></code>
   and <code id=images-2:dom-imagebitmapoptions-resizeheight-3><a href=#dom-imagebitmapoptions-resizeheight>resizeHeight</a></code> members of
   <var>options</var> are less than or equal to 0, then return a promise rejected with
   <a id=images-2:invalidstateerror-14 href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a> <code id=images-2:domexception-22><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these steps.<li>

    <p>If <var>sx</var>, <var>sy</var>, <var>sw</var> and <var>sh</var> are specified, let
    <var>sourceRectangle</var> be a rectangle whose corners are the four points (<var>sx</var>,
    <var>sy</var>), (<var>sx</var>+<var>sw</var>, <var>sy</var>),(<var>sx</var>+<var>sw</var>,
    <var>sy</var>+<var>sh</var>), (<var>sx</var>,<var>sy</var>+<var>sh</var>). Otherwise let
    <var>sourceRectangle</var> be a rectangle whose corners are the four points (0,0), (width of
    <var>input</var>, 0), (width of <var>input</var>, height of <var>input</var>), (0, height of
    <var>input</var>).</p>

    <p class=note>If either <var>sw</var> or <var>sh</var> are negative, then
    the top-left corner of this rectangle will be to the left or above the (<var>sx</var>,
    <var>sy</var>) point.</p>

   <li><p>Clip <var>sourceRectangle</var> to the dimensions of <var>input</var>.<li>
    <p>Let <var>outputWidth</var> be determined as follows:</p>

    <dl class=switch><dt>If the <code id=images-2:dom-imagebitmapoptions-resizewidth-4><a href=#dom-imagebitmapoptions-resizewidth>resizeWidth</a></code> member of
     <var>options</var> is specified<dd>the value of the <code id=images-2:dom-imagebitmapoptions-resizewidth-5><a href=#dom-imagebitmapoptions-resizewidth>resizeWidth</a></code>
     member of <var>options</var><dt>If the <code id=images-2:dom-imagebitmapoptions-resizewidth-6><a href=#dom-imagebitmapoptions-resizewidth>resizeWidth</a></code> member of
     <var>options</var> is not specified, but the <code id=images-2:dom-imagebitmapoptions-resizeheight-4><a href=#dom-imagebitmapoptions-resizeheight>resizeHeight</a></code> member is specified<dd>the width of <var>sourceRectangle</var>, times the value of the <code id=images-2:dom-imagebitmapoptions-resizeheight-5><a href=#dom-imagebitmapoptions-resizeheight>resizeHeight</a></code> member of <var>options</var>,
     divided by the height of <var>sourceRectangle</var>, rounded up to the nearest integer<dt>If neither <code id=images-2:dom-imagebitmapoptions-resizewidth-7><a href=#dom-imagebitmapoptions-resizewidth>resizeWidth</a></code> nor <code id=images-2:dom-imagebitmapoptions-resizeheight-6><a href=#dom-imagebitmapoptions-resizeheight>resizeHeight</a></code> are specified<dd>the width of <var>sourceRectangle</var></dl>
   <li>
    <p>Let <var>outputHeight</var> be determined as follows:</p>

    <dl class=switch><dt>If the <code id=images-2:dom-imagebitmapoptions-resizeheight-7><a href=#dom-imagebitmapoptions-resizeheight>resizeHeight</a></code> member of
     <var>options</var> is specified<dd>the value of the <code id=images-2:dom-imagebitmapoptions-resizeheight-8><a href=#dom-imagebitmapoptions-resizeheight>resizeHeight</a></code>
     member of <var>options</var><dt>If the <code id=images-2:dom-imagebitmapoptions-resizeheight-9><a href=#dom-imagebitmapoptions-resizeheight>resizeHeight</a></code> member of
     <var>options</var> is not specified, but the <code id=images-2:dom-imagebitmapoptions-resizewidth-8><a href=#dom-imagebitmapoptions-resizewidth>resizeWidth</a></code> member is specified<dd>the height of <var>sourceRectangle</var>, times the value of the <code id=images-2:dom-imagebitmapoptions-resizewidth-9><a href=#dom-imagebitmapoptions-resizewidth>resizeWidth</a></code> member of <var>options</var>,
     divided by the width of <var>sourceRectangle</var>, rounded up to the nearest integer<dt>If neither <code id=images-2:dom-imagebitmapoptions-resizewidth-10><a href=#dom-imagebitmapoptions-resizewidth>resizeWidth</a></code> nor <code id=images-2:dom-imagebitmapoptions-resizeheight-10><a href=#dom-imagebitmapoptions-resizeheight>resizeHeight</a></code> are specified<dd>the height of <var>sourceRectangle</var></dl>
   <li><p>Place <var>input</var> on an infinite transparent black grid plane, positioned so that
   its top left corner is at the origin of the plane, with the <var>x</var>-coordinate increasing
   to the right, and the <var>y</var>-coordinate increasing down, and with each pixel in the
   <var>input</var> image data occupying a cell on the plane's grid.<li><p>Let <var>output</var> be the rectangle on the plane denoted by
   <var>sourceRectangle</var>.<li><p>Scale <var>output</var> to the size specified by <var>outputWidth</var> and
   <var>outputHeight</var>. The user agent should use the value of the <dfn id=dom-imagebitmapoptions-resizequality><code>resizeQuality</code></dfn> option to guide the
   choice of scaling algorithm.<li>

    <p>If the value of the <dfn id=dom-imagebitmapoptions-imageorientation><code>imageOrientation</code></dfn> member of
    <var>options</var> is "<dfn id=dom-imageorientation-flipy><code>flipY</code></dfn>",
    <var>output</var> must be flipped vertically, disregarding any image orientation metadata of
    the source (such as EXIF metadata), if any. <a href=#refsEXIF>[EXIF]</a></p>

    <p class=note>If the value is "<dfn id=dom-imageorientation-none><code>none</code></dfn>", no extra step is required.</p>

   <li>

    <p>If <var>image</var> is an <code id=images-2:the-img-element-4><a href=#the-img-element>img</a></code> element or a <code id=images-2:blob-9><a data-x-internal=blob href=https://w3c.github.io/FileAPI/#blob>Blob</a></code> object, let
    <var>val</var> be the value of the <dfn id=dom-imagebitmapoptions-colorspaceconversion><code>colorSpaceConversion</code></dfn> member
    of <var>options</var>, and then run these substeps:</p>

    <ol><li><p>If <var>val</var> is "<dfn id=dom-colorspaceconversion-default><code>default</code></dfn>",
     the color space conversion behavior is implementation-specific, and should be chosen according
     to the color space that the implementation uses for drawing images onto the canvas.<li><p>If <var>val</var> is "<dfn id=dom-colorspaceconversion-none><code>none</code></dfn>", <var>output</var> must be decoded
     without performing any color space conversions. This means that the image decoding algorithm
     must ignore color profile metadata embedded in the source data as well as the display device
     color profile.</ol>

    <p class=note>The native color space of canvas is currently unspecified, but this is expected
    to change in the future.</p>

   <li>

    <p>Let <var>val</var> be the value of <dfn id=dom-imagebitmapoptions-premultiplyalpha><code>premultiplyAlpha</code></dfn> member of
    <var>options</var>, and then run these substeps:</p>

    <ol><li><p>If <var>val</var> is "<dfn id=dom-premultiplyalpha-default><code>default</code></dfn>", the alpha premultiplication
     behavior is implementation-specific, and should be chosen according to implementation deems
     optimal for drawing images onto the canvas.<li><p>If <var>val</var> is "<dfn id=dom-premultiplyalpha-premultiply><code>premultiply</code></dfn>", the <var>output</var>
     that is not premultiplied by alpha must have its color components multiplied by alpha and
     that is premultiplied by alpha must be left untouched.<li><p>If <var>val</var> is "<dfn id=dom-premultiplyalpha-none><code>none</code></dfn>", the <var>output</var> that is not
     premultiplied by alpha must be left untouched and that is premultiplied by alpha must have
     its color components divided by alpha.</ol>

   <li><p>Return <var>output</var>.</ol>

  <p>When the <dfn id=dom-imagebitmap-close><code>close()</code></dfn> method is called, the
  user agent must run these steps:</p>

  <ol><li><p>Set this <code id=images-2:imagebitmap-41><a href=#imagebitmap>ImageBitmap</a></code> object's <a href=#detached id=images-2:detached-8>[[Detached]]</a> internal slot value
   to true.<li><p>Unset this <code id=images-2:imagebitmap-42><a href=#imagebitmap>ImageBitmap</a></code> object's <a href=#concept-imagebitmap-bitmap-data id=images-2:concept-imagebitmap-bitmap-data-18>bitmap data</a>.</ol>

  <p>The <dfn id=dom-imagebitmap-width><code>width</code></dfn> attribute's getter must run
  these steps:</p>

  <ol><li><p>If this <code id=images-2:imagebitmap-43><a href=#imagebitmap>ImageBitmap</a></code> object's <a href=#detached id=images-2:detached-9>[[Detached]]</a> internal slot's
   value is true, then return 0.<li><p>Return this <code id=images-2:imagebitmap-44><a href=#imagebitmap>ImageBitmap</a></code> object's width, in <a href=https://drafts.csswg.org/css-values/#px id="images-2:'px'-4" data-x-internal="'px'">CSS
   pixels</a>.</ol>

  <p>The <dfn id=dom-imagebitmap-height><code>height</code></dfn> attribute's getter must run
  these steps:</p>

  <ol><li><p>If this <code id=images-2:imagebitmap-45><a href=#imagebitmap>ImageBitmap</a></code> object's <a href=#detached id=images-2:detached-10>[[Detached]]</a> internal slot's
   value is true, then return 0.<li><p>Return this <code id=images-2:imagebitmap-46><a href=#imagebitmap>ImageBitmap</a></code> object's height, in <a href=https://drafts.csswg.org/css-values/#px id="images-2:'px'-5" data-x-internal="'px'">CSS
   pixels</a>.</ol>

  <p>The <a href=#resizequality id=images-2:resizequality-2>ResizeQuality</a> enumeration is used to express a preference for the
  interpolation quality to use when scaling images.</p>

  <p>The "<dfn id=dom-resizequality-pixelated><code>pixelated</code></dfn>" value indicates
  a preference to scale the image that maximizes the appearance. Scaling algorithms that "smooth"
  colors are acceptable, such as bilinear interpolation.</p>

  <p>The "<dfn id=dom-resizequality-low><code>low</code></dfn>" value
  indicates a preference for a low level of image interpolation quality. Low-quality image
  interpolation may be more computationally efficient than higher settings.</p>

  <p>The "<dfn id=dom-resizequality-medium><code>medium</code></dfn>" value indicates
  a preference for a medium level of image interpolation quality.</p>

  <p>The "<dfn id=dom-resizequality-high><code>high</code></dfn>" value indicates a
  preference for a high level of image interpolation quality. High-quality image
  interpolation may be more computationally expensive than lower settings.</p>

  <p class=note>Bilinear scaling is an example of a relatively fast, lower-quality image-smoothing
  algorithm. Bicubic or Lanczos scaling are examples of image-scaling algorithms that produce
  higher-quality output. This specification does not mandate that specific interpolation algorithms
  be used unless the value is "<a href=#dom-resizequality-pixelated id=images-2:dom-resizequality-pixelated-2>pixelated</a>".</p>

  

  <div class=example>

   <p>Using this API, a sprite sheet can be precut and prepared:</p>

   <pre>var sprites = {};
function loadMySprites() {
  var image = new Image();
  image.src = 'mysprites.png';
  var resolver;
  var promise = new Promise(function (arg) { resolver = arg });
  image.onload = function () {
    resolver(Promise.all(
      createImageBitmap(image,  0,  0, 40, 40).then(function (image) { sprites.woman = image }),
      createImageBitmap(image, 40,  0, 40, 40).then(function (image) { sprites.man   = image }),
      createImageBitmap(image, 80,  0, 40, 40).then(function (image) { sprites.tree  = image }),
      createImageBitmap(image,  0, 40, 40, 40).then(function (image) { sprites.hut   = image }),
      createImageBitmap(image, 40, 40, 40, 40).then(function (image) { sprites.apple = image }),
      createImageBitmap(image, 80, 40, 40, 40).then(function (image) { sprites.snake = image }),
    ));
  };
  return promise;
}

function runDemo() {
  var canvas = document.querySelector('canvas#demo');
  var context = canvas.getContext('2d');
  context.drawImage(sprites.tree, 30, 10);
  context.drawImage(sprites.snake, 70, 10);
}

loadMySprites().then(runDemo);</pre>

  </div>




  <h3 id=animation-frames>8.9 Animation Frames<a href=#animation-frames class=self-link></a></h3><div class=status><input onclick=toggleStatus(this) value= type=button><p class=support><strong>Support:</strong> requestanimationframe<span class="and_chr yes"><span>Chrome for Android</span> <span>55+</span></span><span class="chrome yes"><span>Chrome</span> <span>24+</span></span><span class="ios_saf yes"><span>iOS Safari</span> <span>7.0+</span></span><span class="and_uc yes"><span>UC Browser for Android</span> <span>11+</span></span><span class="firefox yes"><span>Firefox</span> <span>23+</span></span><span class="ie yes"><span>IE</span> <span>10+</span></span><span class="samsung yes"><span>Samsung Internet</span> <span>4+</span></span><span class="op_mini no"><span>Opera Mini</span> <span>None</span></span><span class="android yes"><span>Android Browser</span> <span>4.4+</span></span><span class="safari yes"><span>Safari</span> <span>6.1+</span></span><span class="edge yes"><span>Edge</span> <span>12+</span></span><span class="opera yes"><span>Opera</span> <span>15+</span></span><p class=caniuse>Source: <a href="http://caniuse.com/#feat=requestanimationframe">caniuse.com</a></div>

  <p>Each <code id=animation-frames:document><a href=#document>Document</a></code> has a <dfn id=list-of-animation-frame-callbacks>list of animation frame callbacks</dfn>, which must be
  initially empty, and an <dfn id=animation-frame-callback-identifier>animation frame callback identifier</dfn>, which is a number which
  must initially be zero.</p>

  <p>When the <dfn id=dom-window-requestanimationframe><code>requestAnimationFrame()</code></dfn> method is called,
  the user agent must run the following steps:</p>

  <ol><li><p>Let <var>document</var> be this <code id=animation-frames:window><a href=#window>Window</a></code> object's <a href=#concept-document-window id=animation-frames:concept-document-window>associated <code>Document</code></a>.<li><p>Increment <var>document</var>'s <a href=#animation-frame-callback-identifier id=animation-frames:animation-frame-callback-identifier>animation frame callback identifier</a> by
   one.<li><p>Append the method's argument to <var>document</var>'s <a href=#list-of-animation-frame-callbacks id=animation-frames:list-of-animation-frame-callbacks>list of animation frame
   callbacks</a>, associated with <var>document</var>'s <a href=#animation-frame-callback-identifier id=animation-frames:animation-frame-callback-identifier-2>animation frame callback
   identifier</a>'s current value.<li><p>Return <var>document</var>'s <a href=#animation-frame-callback-identifier id=animation-frames:animation-frame-callback-identifier-3>animation frame callback identifier</a>'s current
   value.</ol>

  <p>When the <dfn id=dom-window-cancelanimationframe><code>cancelAnimationFrame()</code></dfn> method is called,
  the user agent must run the following steps:</p>

  <ol><li><p>Let <var>document</var> be this <code id=animation-frames:window-2><a href=#window>Window</a></code> object's <a href=#concept-document-window id=animation-frames:concept-document-window-2>associated <code>Document</code></a>.<li><p>Find the entry in <var>document</var>'s <a href=#list-of-animation-frame-callbacks id=animation-frames:list-of-animation-frame-callbacks-2>list of animation frame callbacks</a>
   that is associated with the value given by the method's argument.<li><p>If there is such an entry, remove it from <var>document</var>'s <a href=#list-of-animation-frame-callbacks id=animation-frames:list-of-animation-frame-callbacks-3>list of animation
   frame callbacks</a>.</ol>

  <p>When the user agent is to <dfn id=run-the-animation-frame-callbacks>run the animation frame callbacks</dfn> for a
  <code id=animation-frames:document-2><a href=#document>Document</a></code> <var>doc</var> with a timestamp <var>now</var>, it must run the following
  steps:</p>

  <ol><li><p>Let <var>callbacks</var> be a list of the entries in <var>doc</var>'s <a href=#list-of-animation-frame-callbacks id=animation-frames:list-of-animation-frame-callbacks-4>list of
   animation frame callbacks</a>, in the order in which they were added to the list.<li><p>Set <var>doc</var>'s <a href=#list-of-animation-frame-callbacks id=animation-frames:list-of-animation-frame-callbacks-5>list of animation frame callbacks</a> to the empty
   list.<li><p>For each entry in <var>callbacks</var>, in order: <a href=https://heycam.github.io/webidl/#es-invoking-callback-functions id=animation-frames:es-invoking-callback-functions data-x-internal=es-invoking-callback-functions>invoke the callback</a>, passing
   <var>now</var> as the only argument, and if an exception is thrown, <a href=#report-the-exception id=animation-frames:report-the-exception>report the
   exception</a>. <a href=#refsWEBIDL>[WEBIDL]</a></ol>



  <h2 id=comms>9 Communication<a href=#comms class=self-link></a></h2>

  <h3 id=the-messageevent-interfaces>9.1 The <code id=the-messageevent-interfaces:messageevent><a href=#messageevent>MessageEvent</a></code> interfaces<a href=#the-messageevent-interfaces class=self-link></a></h3>

  <p>Messages in <a href=#server-sent-events id=the-messageevent-interfaces:server-sent-events>server-sent events</a>, <a href=#network id=the-messageevent-interfaces:network>Web sockets</a>, <a href=#web-messaging id=the-messageevent-interfaces:web-messaging>cross-document
  messaging</a>, <a href=#channel-messaging id=the-messageevent-interfaces:channel-messaging>channel messaging</a>, and <a href=#broadcasting-to-other-browsing-contexts id=the-messageevent-interfaces:broadcasting-to-other-browsing-contexts>broadcast channels</a> use the
  <code id=the-messageevent-interfaces:messageevent-2><a href=#messageevent>MessageEvent</a></code> interface for their <code id=the-messageevent-interfaces:event-message><a href=#event-message>message</a></code>
  events:</p>

  <pre class=idl>[Constructor(DOMString type, optional <a href=#messageeventinit id=the-messageevent-interfaces:messageeventinit>MessageEventInit</a> eventInitDict), Exposed=(Window,Worker)]
interface <dfn id=messageevent>MessageEvent</dfn> : <a id=the-messageevent-interfaces:event href=https://dom.spec.whatwg.org/#interface-event data-x-internal=event>Event</a> {
  readonly attribute any <a href=#dom-messageevent-data id=the-messageevent-interfaces:dom-messageevent-data>data</a>;
  readonly attribute USVString <a href=#dom-messageevent-origin id=the-messageevent-interfaces:dom-messageevent-origin>origin</a>;
  readonly attribute DOMString <a href=#dom-messageevent-lasteventid id=the-messageevent-interfaces:dom-messageevent-lasteventid>lastEventId</a>;
  readonly attribute <a href=#messageeventsource id=the-messageevent-interfaces:messageeventsource>MessageEventSource</a>? <a href=#dom-messageevent-source id=the-messageevent-interfaces:dom-messageevent-source>source</a>;
  readonly attribute FrozenArray&lt;<a href=#messageport id=the-messageevent-interfaces:messageport>MessagePort</a>> <a href=#dom-messageevent-ports id=the-messageevent-interfaces:dom-messageevent-ports>ports</a>;

  void <a href=#dom-messageevent-initmessageevent id=the-messageevent-interfaces:dom-messageevent-initmessageevent>initMessageEvent</a>(DOMString type, boolean bubbles, boolean cancelable, any data, USVString origin, DOMString lastEventId, <a href=#messageeventsource id=the-messageevent-interfaces:messageeventsource-2>MessageEventSource</a>? source, sequence&lt;<a href=#messageport id=the-messageevent-interfaces:messageport-2>MessagePort</a>> ports);
};

dictionary <dfn id=messageeventinit>MessageEventInit</dfn> : <a id=the-messageevent-interfaces:eventinit href=https://dom.spec.whatwg.org/#dictdef-eventinit data-x-internal=eventinit>EventInit</a> {
  any data = null;
  USVString origin = "";
  DOMString lastEventId = "";
  <a href=#messageeventsource id=the-messageevent-interfaces:messageeventsource-3>MessageEventSource</a>? source = null;
  sequence&lt;<a href=#messageport id=the-messageevent-interfaces:messageport-3>MessagePort</a>> ports = [];
};

typedef (<a href=#windowproxy id=the-messageevent-interfaces:windowproxy>WindowProxy</a> or <a href=#messageport id=the-messageevent-interfaces:messageport-4>MessagePort</a> or <a id=the-messageevent-interfaces:serviceworker href=https://w3c.github.io/ServiceWorker/#serviceworker data-x-internal=serviceworker>ServiceWorker</a>) <dfn id=messageeventsource>MessageEventSource</dfn>;</pre>

  <dl class=domintro><dt><var>event</var> . <code id=the-messageevent-interfaces:dom-messageevent-data-2><a href=#dom-messageevent-data>data</a></code><dd>

    <p>Returns the data of the message.</p>

   <dt><var>event</var> . <code id=the-messageevent-interfaces:dom-messageevent-origin-2><a href=#dom-messageevent-origin>origin</a></code><dd>

    <p>Returns the origin of the message, for <a href=#server-sent-events id=the-messageevent-interfaces:server-sent-events-2>server-sent events</a> and
    <a href=#web-messaging id=the-messageevent-interfaces:web-messaging-2>cross-document messaging</a>.</p>

   <dt><var>event</var> . <code id=the-messageevent-interfaces:dom-messageevent-lasteventid-2><a href=#dom-messageevent-lasteventid>lastEventId</a></code><dd>

    <p>Returns the <a href=#concept-event-stream-last-event-id id=the-messageevent-interfaces:concept-event-stream-last-event-id>last event ID string</a>, for
    <a href=#server-sent-events id=the-messageevent-interfaces:server-sent-events-3>server-sent events</a>.</p>

   <dt><var>event</var> . <code id=the-messageevent-interfaces:dom-messageevent-source-2><a href=#dom-messageevent-source>source</a></code><dd>

    <p>Returns the <code id=the-messageevent-interfaces:windowproxy-2><a href=#windowproxy>WindowProxy</a></code> of the source window, for <a href=#web-messaging id=the-messageevent-interfaces:web-messaging-3>cross-document
    messaging</a>, and the <code id=the-messageevent-interfaces:messageport-5><a href=#messageport>MessagePort</a></code> being attached, in the <code id=the-messageevent-interfaces:event-workerglobalscope-connect><a href=#event-workerglobalscope-connect>connect</a></code> event fired at
    <code id=the-messageevent-interfaces:sharedworkerglobalscope><a href=#sharedworkerglobalscope>SharedWorkerGlobalScope</a></code> objects.</p>

   <dt><var>event</var> . <code id=the-messageevent-interfaces:dom-messageevent-ports-2><a href=#dom-messageevent-ports>ports</a></code><dd>

    <p>Returns the <code id=the-messageevent-interfaces:messageport-6><a href=#messageport>MessagePort</a></code> array sent with the message, for <a href=#web-messaging id=the-messageevent-interfaces:web-messaging-4>cross-document
    messaging</a> and <a href=#channel-messaging id=the-messageevent-interfaces:channel-messaging-2>channel messaging</a>.</p>

   </dl>

  

  <p>The <dfn id=dom-messageevent-data><code>data</code></dfn> attribute must return the value
  it was initialized to. It represents the message being sent.</p>

  <p>The <dfn id=dom-messageevent-origin><code>origin</code></dfn> attribute must return the
  value it was initialized to. It represents, in <a href=#server-sent-events id=the-messageevent-interfaces:server-sent-events-4>server-sent events</a> and
  <a href=#web-messaging id=the-messageevent-interfaces:web-messaging-5>cross-document messaging</a>, the <a href=#concept-origin id=the-messageevent-interfaces:concept-origin>origin</a> of the document that sent the
  message (typically the scheme, hostname, and port of the document, but not its path or <a href=https://url.spec.whatwg.org/#concept-url-fragment id=the-messageevent-interfaces:concept-url-fragment data-x-internal=concept-url-fragment>fragment</a>).</p>

  <p>The <dfn id=dom-messageevent-lasteventid><code>lastEventId</code></dfn> attribute must
  return the value it was initialized to. It represents, in <a href=#server-sent-events id=the-messageevent-interfaces:server-sent-events-5>server-sent events</a>, the
  <a href=#concept-event-stream-last-event-id id=the-messageevent-interfaces:concept-event-stream-last-event-id-2>last event ID string</a> of the event
  source.</p>

  <p>The <dfn id=dom-messageevent-source><code>source</code></dfn> attribute must return the
  value it was initialized to. It represents, in <a href=#web-messaging id=the-messageevent-interfaces:web-messaging-6>cross-document messaging</a>, the
  <code id=the-messageevent-interfaces:windowproxy-3><a href=#windowproxy>WindowProxy</a></code> of the <a href=#browsing-context id=the-messageevent-interfaces:browsing-context>browsing context</a> of the <code id=the-messageevent-interfaces:window><a href=#window>Window</a></code> object
  from which the message came; and in the <code id=the-messageevent-interfaces:event-workerglobalscope-connect-2><a href=#event-workerglobalscope-connect>connect</a></code> events used by <a href=#sharedworkerglobalscope id=the-messageevent-interfaces:sharedworkerglobalscope-2>shared workers</a>, the newly connecting
  <code id=the-messageevent-interfaces:messageport-7><a href=#messageport>MessagePort</a></code>.</p>

  <p>The <dfn id=dom-messageevent-ports><code>ports</code></dfn> attribute must return the
  value it was initialized to. It represents, in <a href=#web-messaging id=the-messageevent-interfaces:web-messaging-7>cross-document messaging</a> and
  <a href=#channel-messaging id=the-messageevent-interfaces:channel-messaging-3>channel messaging</a>, the <code id=the-messageevent-interfaces:messageport-8><a href=#messageport>MessagePort</a></code> array being sent.</p>

  
  <p>The <dfn id=dom-messageevent-initmessageevent><code>initMessageEvent()</code></dfn>
  method must initialize the event in a manner analogous to the similarly-named <code id=the-messageevent-interfaces:dom-event-initevent><a data-x-internal=dom-event-initevent href=https://dom.spec.whatwg.org/#dom-event-initevent>initEvent()</a></code> method. <a href=#refsDOM>[DOM]</a></p>

  

  <p class=note>Various APIs (e.g., <code id=the-messageevent-interfaces:websocket><a href=#websocket>WebSocket</a></code>, <code id=the-messageevent-interfaces:eventsource><a href=#eventsource>EventSource</a></code>) use the
  <code id=the-messageevent-interfaces:messageevent-3><a href=#messageevent>MessageEvent</a></code> interface for their <code id=the-messageevent-interfaces:event-message-2><a href=#event-message>message</a></code> event
  without using the <code id=the-messageevent-interfaces:messageport-9><a href=#messageport>MessagePort</a></code> API.</p>


  <h3 id=server-sent-events>9.2 <dfn>Server-sent events</dfn><a href=#server-sent-events class=self-link></a></h3><div class=status><input onclick=toggleStatus(this) value= type=button><p class=support><strong>Support:</strong> eventsource<span class="and_chr yes"><span>Chrome for Android</span> <span>55+</span></span><span class="chrome yes"><span>Chrome</span> <span>6+</span></span><span class="ios_saf yes"><span>iOS Safari</span> <span>4.0+</span></span><span class="and_uc yes"><span>UC Browser for Android</span> <span>11+</span></span><span class="firefox yes"><span>Firefox</span> <span>6+</span></span><span class="ie no"><span>IE</span> <span>None</span></span><span class="samsung yes"><span>Samsung Internet</span> <span>4+</span></span><span class="op_mini no"><span>Opera Mini</span> <span>None</span></span><span class="android yes"><span>Android Browser</span> <span>4.4+</span></span><span class="safari yes"><span>Safari</span> <span>5+</span></span><span class="edge no"><span>Edge</span> <span>None</span></span><span class="opera yes"><span>Opera</span> <span>11+</span></span><p class=caniuse>Source: <a href="http://caniuse.com/#feat=eventsource">caniuse.com</a></div>

  <h4 id=server-sent-events-intro>9.2.1 Introduction<a href=#server-sent-events-intro class=self-link></a></h4>

  <p><i>This section is non-normative.</i></p>

  <p>To enable servers to push data to Web pages over HTTP or using dedicated server-push protocols,
  this specification introduces the <code id=server-sent-events-intro:eventsource><a href=#eventsource>EventSource</a></code> interface.</p>

  <p>Using this API consists of creating an <code id=server-sent-events-intro:eventsource-2><a href=#eventsource>EventSource</a></code> object and registering an event
  listener.</p>

  <pre>var source = new EventSource('updates.cgi');
source.onmessage = function (event) {
  alert(event.data);
};</pre>

  <p>On the server-side, the script ("<code>updates.cgi</code>" in this case) sends
  messages in the following form, with the <code id=server-sent-events-intro:text/event-stream><a href=#text/event-stream>text/event-stream</a></code> MIME type:</p>

  <pre>data: This is the first message.

data: This is the second message, it
data: has two lines.

data: This is the third message.</pre>

  <hr>

  <p>Authors can separate events by using different event types. Here is a stream that has two event
  types, "add" and "remove":</p>

  <pre>event: add
data: 73857293

event: remove
data: 2153

event: add
data: 113411</pre>

  <p>The script to handle such a stream would look like this (where <code>addHandler</code>
  and <code>removeHandler</code> are functions that take one argument, the event):</p>

  <pre>var source = new EventSource('updates.cgi');
source.addEventListener('add', addHandler, false);
source.addEventListener('remove', removeHandler, false);</pre>

  <p>The default event type is "message".</p>

  <p>Event streams are always decoded as UTF-8. There is no way to specify another character
  encoding.</p>

  <hr>

  <p>Event stream requests can be redirected using HTTP 301 and 307 redirects as with normal HTTP
  requests. Clients will reconnect if the connection is closed; a client can be told to stop
  reconnecting using the HTTP 204 No Content response code.</p>

  <p>Using this API rather than emulating it using <code id=server-sent-events-intro:xmlhttprequest><a data-x-internal=xmlhttprequest href=https://xhr.spec.whatwg.org/#xmlhttprequest>XMLHttpRequest</a></code> or an
  <code id=server-sent-events-intro:the-iframe-element><a href=#the-iframe-element>iframe</a></code> allows the user agent to make better use of network resources in cases where
  the user agent implementor and the network operator are able to coordinate in advance. Amongst
  other benefits, this can result in significant savings in battery life on portable devices. This
  is discussed further in the section below on <a href=#eventsource-push>connectionless
  push</a>.</p>


  <h4 id=the-eventsource-interface>9.2.2 The <code id=the-eventsource-interface:eventsource><a href=#eventsource>EventSource</a></code> interface<a href=#the-eventsource-interface class=self-link></a></h4>

  <pre class=idl>[<a href=#dom-eventsource id=the-eventsource-interface:dom-eventsource>Constructor</a>(USVString url, optional <a href=#eventsourceinit id=the-eventsource-interface:eventsourceinit>EventSourceInit</a> eventSourceInitDict), Exposed=(Window,Worker)]
interface <dfn id=eventsource>EventSource</dfn> : <a id=the-eventsource-interface:eventtarget href=https://dom.spec.whatwg.org/#interface-eventtarget data-x-internal=eventtarget>EventTarget</a> {
  readonly attribute USVString <a href=#dom-eventsource-url id=the-eventsource-interface:dom-eventsource-url>url</a>;
  readonly attribute boolean <a href=#dom-eventsource-withcredentials id=the-eventsource-interface:dom-eventsource-withcredentials>withCredentials</a>;

  // ready state
  const unsigned short <a href=#dom-eventsource-connecting id=the-eventsource-interface:dom-eventsource-connecting>CONNECTING</a> = 0;
  const unsigned short <a href=#dom-eventsource-open id=the-eventsource-interface:dom-eventsource-open>OPEN</a> = 1;
  const unsigned short <a href=#dom-eventsource-closed id=the-eventsource-interface:dom-eventsource-closed>CLOSED</a> = 2;
  readonly attribute unsigned short <a href=#dom-eventsource-readystate id=the-eventsource-interface:dom-eventsource-readystate>readyState</a>;

  // networking
  attribute <a href=#eventhandler id=the-eventsource-interface:eventhandler>EventHandler</a> <a href=#handler-eventsource-onopen id=the-eventsource-interface:handler-eventsource-onopen>onopen</a>;
  attribute <a href=#eventhandler id=the-eventsource-interface:eventhandler-2>EventHandler</a> <a href=#handler-eventsource-onmessage id=the-eventsource-interface:handler-eventsource-onmessage>onmessage</a>;
  attribute <a href=#eventhandler id=the-eventsource-interface:eventhandler-3>EventHandler</a> <a href=#handler-eventsource-onerror id=the-eventsource-interface:handler-eventsource-onerror>onerror</a>;
  void <a href=#dom-eventsource-close id=the-eventsource-interface:dom-eventsource-close>close</a>();
};

dictionary <dfn id=eventsourceinit>EventSourceInit</dfn> {
  boolean <dfn id=dom-eventsourceinit-withcredentials>withCredentials</dfn> = false;
};</pre>

  <p>Each <code id=the-eventsource-interface:eventsource-2><a href=#eventsource>EventSource</a></code> object has the following associated with it:</p>

  <ul><li><p>A <dfn id=concept-eventsource-url data-for=EventSource>url</dfn> (a <a id=the-eventsource-interface:url-record href=https://url.spec.whatwg.org/#concept-url data-x-internal=url-record>URL
   record</a>). Set during construction.<li><p>A <dfn id=concept-event-stream-request>request</dfn>. This must initially be
   null.<li><p>A <dfn id=concept-event-stream-reconnection-time>reconnection time</dfn>, in
   milliseconds. This must initially be a user-agent-defined value, probably in the region of a few
   seconds.<li><p>A <dfn id=concept-event-stream-last-event-id>last event ID string</dfn>. This must
   initially be the empty string.</ul>

  <p>Apart from <a href=#concept-eventsource-url id=the-eventsource-interface:concept-eventsource-url>url</a> these are not currently exposed on
  the <code id=the-eventsource-interface:eventsource-3><a href=#eventsource>EventSource</a></code> object.</p>

  <p>The <dfn id=dom-eventsource><code>EventSource(<var>url</var>,
  <var>eventSourceInitDict</var>)</code></dfn> constructor, when invoked, must run these steps:</p>

  <ol><li><p>Let <var>ev</var> be a new <code id=the-eventsource-interface:eventsource-4><a href=#eventsource>EventSource</a></code> object.<li><p>Let <var>settings</var> be <var>ev</var>'s <a href=#relevant-settings-object id=the-eventsource-interface:relevant-settings-object>relevant settings object</a>.

   <li><p>Let <var>urlRecord</var> be the result of <a href=https://url.spec.whatwg.org/#concept-url-parser id=the-eventsource-interface:url-parser data-x-internal=url-parser>parsing</a>
   <var>url</var> with <var>settings</var>'s <a href=#api-base-url id=the-eventsource-interface:api-base-url>API base URL</a> and <var>settings</var>'s
   <a href=#api-url-character-encoding id=the-eventsource-interface:api-url-character-encoding>API URL character encoding</a>.<li><p>If <var>urlRecord</var> is failure, then throw a <a id=the-eventsource-interface:syntaxerror href=https://heycam.github.io/webidl/#syntaxerror data-x-internal=syntaxerror>"<code>SyntaxError</code>"</a>
   <code id=the-eventsource-interface:domexception><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code>.<li><p>Set <var>ev</var>'s <a href=#concept-eventsource-url id=the-eventsource-interface:concept-eventsource-url-2>url</a> to
   <var>urlRecord</var>.</p>

   <li><p>Let <var>corsAttributeState</var> be <a href=#attr-crossorigin-anonymous id=the-eventsource-interface:attr-crossorigin-anonymous>Anonymous</a>.<li><p>If the value of <var>eventSourceInitDict</var>'s <code id=the-eventsource-interface:dom-eventsourceinit-withcredentials><a href=#dom-eventsourceinit-withcredentials>withCredentials</a></code> member is true, then set
   <var>corsAttributeState</var> to <a href=#attr-crossorigin-use-credentials id=the-eventsource-interface:attr-crossorigin-use-credentials>Use
   Credentials</a> and set <var>ev</var>'s <code id=the-eventsource-interface:dom-eventsource-withcredentials-2><a href=#dom-eventsource-withcredentials>withCredentials</a></code> attribute to true.<li><p>Let <var>request</var> be the result of <a href=#create-a-potential-cors-request id=the-eventsource-interface:create-a-potential-cors-request>creating a potential-CORS request</a> given
   <var>urlRecord</var>, the empty string, and <var>corsAttributeState</var>, and with the
   <i>same-origin fallback flag</i> set.<li><p>Set <var>request</var>'s <a href=https://fetch.spec.whatwg.org/#concept-request-client id=the-eventsource-interface:concept-request-client data-x-internal=concept-request-client>client</a> to
   <var>settings</var>.<li><p>User agents may <a href=https://fetch.spec.whatwg.org/#concept-header-list-set id=the-eventsource-interface:concept-header-list-set data-x-internal=concept-header-list-set>set</a> `<code id=the-eventsource-interface:http-accept><a data-x-internal=http-accept href=https://tools.ietf.org/html/rfc7231#section-5.3.2>Accept</a></code>`/`<code id=the-eventsource-interface:text/event-stream><a href=#text/event-stream>text/event-stream</a></code>` in <var>request</var>'s
   <a href=https://fetch.spec.whatwg.org/#concept-request-header-list id=the-eventsource-interface:concept-request-header-list data-x-internal=concept-request-header-list>header list</a>.<li><p>Set <var>request</var>'s <a href=https://fetch.spec.whatwg.org/#concept-request-cache-mode id=the-eventsource-interface:concept-request-cache-mode data-x-internal=concept-request-cache-mode>cache mode</a> to
   "<code>no-store</code>".<li><p>Set <var>ev</var>'s <a href=#concept-event-stream-request id=the-eventsource-interface:concept-event-stream-request>request</a> to
   <var>request</var>.<li><p>Return <var>ev</var>, but continue these steps <a href=#in-parallel id=the-eventsource-interface:in-parallel>in parallel</a>.<li><p><a href=https://fetch.spec.whatwg.org/#concept-fetch id=the-eventsource-interface:concept-fetch data-x-internal=concept-fetch>Fetch</a> <var>request</var>.</ol>

  <hr>

  <p>The <dfn id=dom-eventsource-url><code>url</code></dfn> attribute's getter must return the
  <a href=https://url.spec.whatwg.org/#concept-url-serializer id=the-eventsource-interface:concept-url-serializer data-x-internal=concept-url-serializer>serialization</a> of this <code id=the-eventsource-interface:eventsource-5><a href=#eventsource>EventSource</a></code>
  object's <a href=#concept-eventsource-url id=the-eventsource-interface:concept-eventsource-url-3>url</a>.</p>

  <p>The <dfn id=dom-eventsource-withcredentials><code>withCredentials</code></dfn> attribute
  must return the value to which it was last initialized. When the object is created, it must be
  initialized to false.</p>

  <p>The <dfn id=dom-eventsource-readystate><code>readyState</code></dfn> attribute represents
  the state of the connection. It can have the following values:</p>

  <dl><dt><dfn id=dom-eventsource-connecting><code>CONNECTING</code></dfn> (numeric value 0)<dd>The connection has not yet been established, or it was closed and the user agent is
   reconnecting.<dt><dfn id=dom-eventsource-open><code>OPEN</code></dfn> (numeric value 1)<dd>The user agent has an open connection and is dispatching events as it receives them.<dt><dfn id=dom-eventsource-closed><code>CLOSED</code></dfn> (numeric value 2)<dd>The connection is not open, and the user agent is not trying to reconnect. Either there was a
   fatal error or the <code id=the-eventsource-interface:dom-eventsource-close-2><a href=#dom-eventsource-close>close()</a></code> method was invoked.</dl>

  <p>When the object is created its <code id=the-eventsource-interface:dom-eventsource-readystate-2><a href=#dom-eventsource-readystate>readyState</a></code> must
  be set to <code id=the-eventsource-interface:dom-eventsource-connecting-2><a href=#dom-eventsource-connecting>CONNECTING</a></code> (0). The rules given below
  for handling the connection define when the value changes.</p>

  <p>The <dfn id=dom-eventsource-close><code>close()</code></dfn> method must abort any
  instances of the <a href=https://fetch.spec.whatwg.org/#concept-fetch id=the-eventsource-interface:concept-fetch-2 data-x-internal=concept-fetch>fetch</a> algorithm started for this
  <code id=the-eventsource-interface:eventsource-6><a href=#eventsource>EventSource</a></code> object, and must set the <code id=the-eventsource-interface:dom-eventsource-readystate-3><a href=#dom-eventsource-readystate>readyState</a></code> attribute to <code id=the-eventsource-interface:dom-eventsource-closed-2><a href=#dom-eventsource-closed>CLOSED</a></code>.</p> 

  <p>The following are the <a href=#event-handlers id=the-eventsource-interface:event-handlers>event handlers</a> (and their corresponding <a href=#event-handler-event-type id=the-eventsource-interface:event-handler-event-type>event handler event types</a>) that must be supported, as <a href=#event-handler-idl-attributes id=the-eventsource-interface:event-handler-idl-attributes>event
  handler IDL attributes</a>, by all objects implementing the <code id=the-eventsource-interface:eventsource-7><a href=#eventsource>EventSource</a></code>
  interface:</p>

  <table><thead><tr><th><a href=#event-handlers id=the-eventsource-interface:event-handlers-2>Event handler</a> <th><a href=#event-handler-event-type id=the-eventsource-interface:event-handler-event-type-2>Event handler event type</a>
   <tbody><tr><td><dfn id=handler-eventsource-onopen><code>onopen</code></dfn> <td> <code id=the-eventsource-interface:event-open><a href=#event-open>open</a></code>
    <tr><td><dfn id=handler-eventsource-onmessage><code>onmessage</code></dfn> <td> <code id=the-eventsource-interface:event-message><a href=#event-message>message</a></code>
    <tr><td><dfn id=handler-eventsource-onerror><code>onerror</code></dfn> <td> <code id=the-eventsource-interface:event-error><a href=#event-error>error</a></code>
  </table>

  <hr>


  <h4 id=sse-processing-model>9.2.3 <span id=processing-model-9></span>Processing model<a href=#sse-processing-model class=self-link></a></h4>

  <p>The resource indicated in the argument to the <code id=sse-processing-model:dom-eventsource><a href=#dom-eventsource>EventSource</a></code>
  constructor is fetched when the constructor is run.</p>

  <p>As data is received, the <a href=#concept-task id=sse-processing-model:concept-task>tasks</a> queued by the <a href=#networking-task-source id=sse-processing-model:networking-task-source>networking
  task source</a> to handle the data must act as follows.</p>

  <p>HTTP 200 OK responses with a `<a href=#content-type id=sse-processing-model:content-type>Content-Type</a>` header specifying the type
  `<code id=sse-processing-model:text/event-stream><a href=#text/event-stream>text/event-stream</a></code>`, ignoring any <a id=sse-processing-model:mime-type href=https://mimesniff.spec.whatwg.org/#mime-type data-x-internal=mime-type>MIME type</a> parameters, must be
  processed line by line <a href=#event-stream-interpretation>as described below</a>.</p>

  <p>When a successful response with a supported <a id=sse-processing-model:mime-type-2 href=https://mimesniff.spec.whatwg.org/#mime-type data-x-internal=mime-type>MIME type</a> is received, such that the
  user agent begins parsing the contents of the stream, the user agent must <a href=#announce-the-connection id=sse-processing-model:announce-the-connection>announce the
  connection</a>.</p>

  <p>The <a href=#concept-task id=sse-processing-model:concept-task-2>task</a> that the <a href=#networking-task-source id=sse-processing-model:networking-task-source-2>networking task source</a> places
  on the <a href=#task-queue id=sse-processing-model:task-queue>task queue</a> once fetching for such a resource (with the correct <a id=sse-processing-model:mime-type-3 href=https://mimesniff.spec.whatwg.org/#mime-type data-x-internal=mime-type>MIME
  type</a>) has completed must cause the user agent to <a href=#reestablish-the-connection id=sse-processing-model:reestablish-the-connection>reestablish the connection</a>
  <a href=#in-parallel id=sse-processing-model:in-parallel>in parallel</a>. This applies whether the connection is closed gracefully or unexpectedly
  (but does not apply when fetching is canceled by the user agent, e.g., in response to <code id=sse-processing-model:dom-window-stop><a href=#dom-window-stop>window.stop()</a></code>, since in those cases the final <a href=#concept-task id=sse-processing-model:concept-task-3>task</a> is actually discarded). It doesn't apply for the error
  conditions listed below except where explicitly specified.</p>

  <p>HTTP 200 OK responses that have a <a href=#content-type id=sse-processing-model:content-type-2>Content-Type</a> specifying an unsupported type, or
  that have no <a href=#content-type id=sse-processing-model:content-type-3>Content-Type</a> at all, must cause the user agent to <a href=#fail-the-connection id=sse-processing-model:fail-the-connection>fail the
  connection</a>.</p> 

  <p id=event-source-network-errors-reconnect>Network errors that prevents the connection from
  being established in the first place (e.g. DNS errors), should cause the user agent to
  <a href=#reestablish-the-connection id=sse-processing-model:reestablish-the-connection-2>reestablish the connection</a> <a href=#in-parallel id=sse-processing-model:in-parallel-2>in parallel</a>, unless the user agent knows that
  to be futile, in which case the user agent may <a href=#fail-the-connection id=sse-processing-model:fail-the-connection-2>fail the connection</a>.</p>

  <p id=event-source-fail-reasons>Any other HTTP response code not listed here, as well as the
  cancelation of the fetch algorithm by the user agent (e.g. in response to <code id=sse-processing-model:dom-window-stop-2><a href=#dom-window-stop>window.stop()</a></code> or the user canceling the network connection
  manually) must cause the user agent to <a href=#fail-the-connection id=sse-processing-model:fail-the-connection-3>fail the connection</a>.</p>  

  <hr>

  <p>When a user agent is to <dfn id=announce-the-connection>announce the connection</dfn>, the user agent must <a href=#queue-a-task id=sse-processing-model:queue-a-task>queue a
  task</a> which, if the <code id=sse-processing-model:dom-eventsource-readystate><a href=#dom-eventsource-readystate>readyState</a></code> attribute is
  set to a value other than <code id=sse-processing-model:dom-eventsource-closed><a href=#dom-eventsource-closed>CLOSED</a></code>, sets the <code id=sse-processing-model:dom-eventsource-readystate-2><a href=#dom-eventsource-readystate>readyState</a></code> attribute to <code id=sse-processing-model:dom-eventsource-open><a href=#dom-eventsource-open>OPEN</a></code> and <a href=https://dom.spec.whatwg.org/#concept-event-fire id=sse-processing-model:concept-event-fire data-x-internal=concept-event-fire>fires an
  event</a> named <code id=sse-processing-model:event-open><a href=#event-open>open</a></code> at the <code id=sse-processing-model:eventsource><a href=#eventsource>EventSource</a></code>
  object.</p>

  <p>When a user agent is to <dfn id=reestablish-the-connection>reestablish the connection</dfn>, the user agent must run the
  following steps. These steps are run <a href=#in-parallel id=sse-processing-model:in-parallel-3>in parallel</a>, not as part of a <a href=#concept-task id=sse-processing-model:concept-task-4>task</a>. (The tasks that it queues, of course, are run like normal tasks
  and not themselves <a href=#in-parallel id=sse-processing-model:in-parallel-4>in parallel</a>.)</p>

  <ol><li>

    <p><a href=#queue-a-task id=sse-processing-model:queue-a-task-2>Queue a task</a> to run the following steps:</p>

    <ol><li><p>If the <code id=sse-processing-model:dom-eventsource-readystate-3><a href=#dom-eventsource-readystate>readyState</a></code> attribute is set to
     <code id=sse-processing-model:dom-eventsource-closed-2><a href=#dom-eventsource-closed>CLOSED</a></code>, abort the task.<li><p>Set the <code id=sse-processing-model:dom-eventsource-readystate-4><a href=#dom-eventsource-readystate>readyState</a></code> attribute to <code id=sse-processing-model:dom-eventsource-connecting><a href=#dom-eventsource-connecting>CONNECTING</a></code>.<li><p><a href=https://dom.spec.whatwg.org/#concept-event-fire id=sse-processing-model:concept-event-fire-2 data-x-internal=concept-event-fire>Fire an event</a> named <code id=sse-processing-model:event-error><a href=#event-error>error</a></code> at the <code id=sse-processing-model:eventsource-2><a href=#eventsource>EventSource</a></code> object.</ol>

   <li><p>Wait a delay equal to the reconnection time of the event source.<li><p>Optionally, wait some more. In particular, if the previous attempt failed, then user
   agents might introduce an exponential backoff delay to avoid overloading a potentially already
   overloaded server. Alternatively, if the operating system has reported that there is no network
   connectivity, user agents might wait for the operating system to announce that the network
   connection has returned before retrying.<li><p>Wait until the aforementioned task has run, if it has not yet run.<li>

    <p><a href=#queue-a-task id=sse-processing-model:queue-a-task-3>Queue a task</a> to run the following steps:</p>

    <ol><li><p>If the <code id=sse-processing-model:eventsource-3><a href=#eventsource>EventSource</a></code> object's <code id=sse-processing-model:dom-eventsource-readystate-5><a href=#dom-eventsource-readystate>readyState</a></code> attribute is not set to <code id=sse-processing-model:dom-eventsource-connecting-2><a href=#dom-eventsource-connecting>CONNECTING</a></code>, abort these steps.<li><p>Let <var>request</var> be the <code id=sse-processing-model:eventsource-4><a href=#eventsource>EventSource</a></code> object's <a href=#concept-event-stream-request id=sse-processing-model:concept-event-stream-request>request</a>.

     <li><p>If the <code id=sse-processing-model:eventsource-5><a href=#eventsource>EventSource</a></code> object's <a href=#concept-event-stream-last-event-id id=sse-processing-model:concept-event-stream-last-event-id>last event ID string</a> is not the empty
     string, <a href=https://fetch.spec.whatwg.org/#concept-header-list-set id=sse-processing-model:concept-header-list-set data-x-internal=concept-header-list-set>set</a> `<code id=sse-processing-model:last-event-id><a href=#last-event-id>Last-Event-ID</a></code>`/<a href=#concept-event-stream-last-event-id id=sse-processing-model:concept-event-stream-last-event-id-2>last event ID string</a>, encoded as UTF-8, in
     <var>request</var>'s <a href=https://fetch.spec.whatwg.org/#concept-request-header-list id=sse-processing-model:concept-request-header-list data-x-internal=concept-request-header-list>header list</a>.<li><p><a href=https://fetch.spec.whatwg.org/#concept-fetch id=sse-processing-model:concept-fetch data-x-internal=concept-fetch>Fetch</a> <var>request</var> and process the
     response obtained in this fashion, if any, as described earlier in this section.</ol>

   </ol>

  <p>When a user agent is to <dfn id=fail-the-connection>fail the connection</dfn>, the user agent must <a href=#queue-a-task id=sse-processing-model:queue-a-task-4>queue a
  task</a> which, if the <code id=sse-processing-model:dom-eventsource-readystate-6><a href=#dom-eventsource-readystate>readyState</a></code> attribute is
  set to a value other than <code id=sse-processing-model:dom-eventsource-closed-3><a href=#dom-eventsource-closed>CLOSED</a></code>, sets the <code id=sse-processing-model:dom-eventsource-readystate-7><a href=#dom-eventsource-readystate>readyState</a></code> attribute to <code id=sse-processing-model:dom-eventsource-closed-4><a href=#dom-eventsource-closed>CLOSED</a></code> and <a href=https://dom.spec.whatwg.org/#concept-event-fire id=sse-processing-model:concept-event-fire-3 data-x-internal=concept-event-fire>fires an
  event</a> named <code id=sse-processing-model:event-error-2><a href=#event-error>error</a></code> at the <code id=sse-processing-model:eventsource-6><a href=#eventsource>EventSource</a></code> object.
  <strong>Once the user agent has <a href=#fail-the-connection id=sse-processing-model:fail-the-connection-4>failed the connection</a>,
  it does <em>not</em> attempt to reconnect!</strong></p>

  <hr>

  <p>The <a href=#task-source id=sse-processing-model:task-source>task source</a> for any <a href=#concept-task id=sse-processing-model:concept-task-5>tasks</a> that are <a href=#queue-a-task id=sse-processing-model:queue-a-task-5>queued</a> by <code id=sse-processing-model:eventsource-7><a href=#eventsource>EventSource</a></code> objects is the <dfn id=remote-event-task-source>remote event
  task source</dfn>.</p>


  <h4 id=parsing-an-event-stream>9.2.4 Parsing an event stream<a href=#parsing-an-event-stream class=self-link></a></h4>

  <p>This event stream format's <a id=parsing-an-event-stream:mime-type href=https://mimesniff.spec.whatwg.org/#mime-type data-x-internal=mime-type>MIME type</a> is <code id=parsing-an-event-stream:text/event-stream><a href=#text/event-stream>text/event-stream</a></code>.</p>

  <p>The event stream format is as described by the <code>stream</code> production of the
  following ABNF, the character set for which is Unicode. <a href=#refsABNF>[ABNF]</a></p>

  <pre>stream        = [ bom ] *event
event         = *( comment / field ) end-of-line
comment       = colon *any-char end-of-line
field         = 1*name-char [ colon [ space ] *any-char ] end-of-line
end-of-line   = ( cr lf / cr / lf )

; characters
lf            = %x000A ; U+000A LINE FEED (LF)
cr            = %x000D ; U+000D CARRIAGE RETURN (CR)
space         = %x0020 ; U+0020 SPACE
colon         = %x003A ; U+003A COLON (:)
bom           = %xFEFF ; U+FEFF BYTE ORDER MARK
name-char     = %x0000-0009 / %x000B-000C / %x000E-0039 / %x003B-10FFFF
                ; a <a href=#unicode-character id=parsing-an-event-stream:unicode-character>Unicode character</a> other than U+000A LINE FEED (LF), U+000D CARRIAGE RETURN (CR), or U+003A COLON (:)
any-char      = %x0000-0009 / %x000B-000C / %x000E-10FFFF
                ; a <a href=#unicode-character id=parsing-an-event-stream:unicode-character-2>Unicode character</a> other than U+000A LINE FEED (LF) or U+000D CARRIAGE RETURN (CR)</pre>

  <p>Event streams in this format must always be encoded as UTF-8. <a href=#refsENCODING>[ENCODING]</a></p>

  <p>Lines must be separated by either a U+000D CARRIAGE RETURN U+000A LINE FEED (CRLF) character
  pair, a single U+000A LINE FEED (LF) character, or a single U+000D CARRIAGE RETURN (CR)
  character.</p>

  <p>Since connections established to remote servers for such resources are expected to be
  long-lived, UAs should ensure that appropriate buffering is used. In particular, while line
  buffering with lines are defined to end with a single U+000A LINE FEED (LF) character is safe,
  block buffering or line buffering with different expected line endings can cause delays in event
  dispatch.</p>


  <h4 id=event-stream-interpretation>9.2.5 Interpreting an event stream<a href=#event-stream-interpretation class=self-link></a></h4>

  <p>Streams must be decoded using the <a id=event-stream-interpretation:utf-8-decode href=https://encoding.spec.whatwg.org/#utf-8-decode data-x-internal=utf-8-decode>UTF-8 decode</a> algorithm.</p>

  <p class=note>The <a id=event-stream-interpretation:utf-8-decode-2 href=https://encoding.spec.whatwg.org/#utf-8-decode data-x-internal=utf-8-decode>UTF-8 decode</a> algorithm strips one leading UTF-8 Byte Order Mark
  (BOM), if any.</p>

  <p>The stream must then be parsed by reading everything line by line, with a U+000D CARRIAGE
  RETURN U+000A LINE FEED (CRLF) character pair, a single U+000A LINE FEED (LF) character not
  preceded by a U+000D CARRIAGE RETURN (CR) character, and a single U+000D CARRIAGE RETURN (CR)
  character not followed by a U+000A LINE FEED (LF) character being the ways in which a line can
  end.</p>

  <p>When a stream is parsed, a <var>data</var> buffer, an <var>event type</var>
  buffer, and a <var>last event ID</var> buffer must be associated with it. They must be
  initialized to the empty string</p>

  <p>Lines must be processed, in the order they are received, as follows:</p>

  <dl class=switch><dt>If the line is empty (a blank line)<dd><p><a href=#dispatchMessage id=event-stream-interpretation:dispatchMessage>Dispatch the event</a>, as defined below.<dt>If the line starts with a U+003A COLON character (:)<dd><p>Ignore the line.<dt>If the line contains a U+003A COLON character (:)<dd>

    <p>Collect the characters on the line before the first U+003A COLON character (:), and let <var>field</var> be that string.</p>

    <p>Collect the characters on the line after the first U+003A COLON character (:), and let <var>value</var> be that string. If <var>value</var> starts with a U+0020 SPACE
    character, remove it from <var>value</var>.</p>

    <p><a href=#processField>Process the field</a> using the steps described below, using <var>field</var> as the field name and <var>value</var> as the field value.</p>

   <dt>Otherwise, the string is not empty but does not contain a U+003A COLON character (:)<dd>

    <p><a href=#processField>Process the field</a> using the steps described below, using the
    whole line as the field name, and the empty string as the field value.</p>

   </dl>

  <p>Once the end of the file is reached, any pending data must be discarded. (If the file ends in
  the middle of an event, before the final empty line, the incomplete event is not dispatched.)</p>

  <hr>

  <p id=processField>The steps to <dfn>process the field</dfn> given a field name and a
  field value depend on the field name, as given in the following list. Field names must be compared
  literally, with no case folding performed.</p>

  <dl class=switch><dt>If the field name is "event"<dd><p>Set the <var>event type</var> buffer to field value.<dt>If the field name is "data"<dd><p>Append the field value to the <var>data</var> buffer, then append a single U+000A
   LINE FEED (LF) character to the <var>data</var> buffer.<dt>If the field name is "id"<dd><p>Set the <var>last event ID</var> buffer to the field value.<dt>If the field name is "retry"<dd><p>If the field value consists of only <a href=#ascii-digits id=event-stream-interpretation:ascii-digits>ASCII digits</a>, then interpret the field
   value as an integer in base ten, and set the event stream's <a href=#concept-event-stream-reconnection-time id=event-stream-interpretation:concept-event-stream-reconnection-time>reconnection time</a> to that integer.
   Otherwise, ignore the field.<dt>Otherwise<dd><p>The field is ignored.</dl>


  <p>When the user agent is required to <dfn id=dispatchMessage>dispatch the
  event</dfn>, the user agent must process the <var>data</var> buffer, the <var>event type</var> buffer, and the <var>last event ID</var> buffer using steps
  appropriate for the user agent.</p>

  <p>For Web browsers, the appropriate steps to <a href=#dispatchMessage id=event-stream-interpretation:dispatchMessage-2>dispatch the event</a> are as follows:</p>

  <ol><li><p>Set the <a href=#concept-event-stream-last-event-id id=event-stream-interpretation:concept-event-stream-last-event-id>last event ID string</a> of
   the event source to the value of the <var>last event ID</var> buffer. The buffer does
   not get reset, so the <a href=#concept-event-stream-last-event-id id=event-stream-interpretation:concept-event-stream-last-event-id-2>last event ID
   string</a> of the event source remains set to this value until the next time it is set by the
   server.<li><p>If the <var>data</var> buffer is an empty string, set the <var>data</var> buffer and the <var>event type</var> buffer to the empty string and
   abort these steps.<li><p>If the <var>data</var> buffer's last character is a U+000A LINE FEED (LF)
   character, then remove the last character from the <var>data</var> buffer.<li><p>Let <var>event</var> be the result of <a id=event-stream-interpretation:creating-an-event href=https://dom.spec.whatwg.org/#concept-event-create data-x-internal=creating-an-event>creating an event</a> using
   <code id=event-stream-interpretation:messageevent><a href=#messageevent>MessageEvent</a></code>, in the <a href=#concept-relevant-realm id=event-stream-interpretation:concept-relevant-realm>relevant Realm</a> of
   the <code id=event-stream-interpretation:eventsource><a href=#eventsource>EventSource</a></code> object.<li><p>Initialize <var>event</var>'s <code id=event-stream-interpretation:dom-event-type><a data-x-internal=dom-event-type href=https://dom.spec.whatwg.org/#dom-event-type>type</a></code> attribute to <code id=event-stream-interpretation:event-message><a href=#event-message>message</a></code>, its <code id=event-stream-interpretation:dom-messageevent-data><a href=#dom-messageevent-data>data</a></code>
   attribute to <var>data</var>, its <code id=event-stream-interpretation:dom-messageevent-origin><a href=#dom-messageevent-origin>origin</a></code> attribute
   to the <a href=#unicode-serialisation-of-an-origin id=event-stream-interpretation:unicode-serialisation-of-an-origin>Unicode serialization</a>
   of the <a href=#concept-origin id=event-stream-interpretation:concept-origin>origin</a> of the event stream's final URL (i.e. the URL after redirects), and
   its <code id=event-stream-interpretation:dom-messageevent-lasteventid><a href=#dom-messageevent-lasteventid>lastEventId</a></code> attribute to the <a href=#concept-event-stream-last-event-id id=event-stream-interpretation:concept-event-stream-last-event-id-3>last event ID string</a> of the event
   source.<li><p>If the <var>event type</var> buffer has a value other than the empty string, change the
   <a href=https://dom.spec.whatwg.org/#dom-event-type id=event-stream-interpretation:concept-event-type data-x-internal=concept-event-type>type</a> of the newly created event to equal the value of
   the <var>event type</var> buffer.<li><p>Set the <var>data</var> buffer and the <var>event type</var> buffer to
   the empty string.<li><p><a href=#queue-a-task id=event-stream-interpretation:queue-a-task>Queue a task</a> which, if the <code id=event-stream-interpretation:dom-eventsource-readystate><a href=#dom-eventsource-readystate>readyState</a></code> attribute is set to a value other than <code id=event-stream-interpretation:dom-eventsource-closed><a href=#dom-eventsource-closed>CLOSED</a></code>, <a href=https://dom.spec.whatwg.org/#concept-event-dispatch id=event-stream-interpretation:concept-event-dispatch data-x-internal=concept-event-dispatch>dispatches</a> the newly created event at the
   <code id=event-stream-interpretation:eventsource-2><a href=#eventsource>EventSource</a></code> object.</ol>

  <p class=note>If an event doesn't have an "id" field, but an earlier event did set the event
  source's <a href=#concept-event-stream-last-event-id id=event-stream-interpretation:concept-event-stream-last-event-id-4>last event ID string</a>, then the
  event's <code id=event-stream-interpretation:dom-messageevent-lasteventid-2><a href=#dom-messageevent-lasteventid>lastEventId</a></code> field will be set to the
  value of whatever the last seen "id" field was.</p>

  <p>For other user agents, the appropriate steps to <a href=#dispatchMessage id=event-stream-interpretation:dispatchMessage-3>dispatch the event</a> are
  implementation dependent, but at a minimum they must set the <var>data</var> and <var>event type</var> buffers to the empty string before returning.</p>

  <div class=example>

   <p>The following event stream, once followed by a blank line:</p>
   <pre>data: YHOO
data: +2
data: 10</pre>

   <p>...would cause an event <code id=event-stream-interpretation:event-message-2><a href=#event-message>message</a></code> with the interface
   <code id=event-stream-interpretation:messageevent-2><a href=#messageevent>MessageEvent</a></code> to be dispatched on the <code id=event-stream-interpretation:eventsource-3><a href=#eventsource>EventSource</a></code> object. The event's
   <code id=event-stream-interpretation:dom-messageevent-data-2><a href=#dom-messageevent-data>data</a></code> attribute would contain the string "<code>YHOO\n+2\n10</code>" (where "<code>\n</code>" represents a newline).</p>

   <p>This could be used as follows:
   <pre>var stocks = new EventSource("https://stocks.example.com/ticker.php");
stocks.onmessage = function (event) {
  var data = event.data.split('\n');
  updateStocks(data[0], data[1], data[2]);
};</pre>

   <p>...where <code>updateStocks()</code> is a function defined as:</p>

   <pre>function updateStocks(symbol, delta, value) { ... }</pre>

   <p>...or some such.</p>

  </div>

  <div class=example>

   <p>The following stream contains four blocks. The first block has just a comment, and will fire
   nothing. The second block has two fields with names "data" and "id" respectively; an event will
   be fired for this block, with the data "first event", and will then set the last event ID to "1"
   so that if the connection died between this block and the next, the server would be sent a `<code id=event-stream-interpretation:last-event-id><a href=#last-event-id>Last-Event-ID</a></code>` header with the value "1". The third block
   fires an event with data "second event", and also has an "id" field, this time with no value,
   which resets the last event ID to the empty string (meaning no `<code id=event-stream-interpretation:last-event-id-2><a href=#last-event-id>Last-Event-ID</a></code>` header will now be sent in the event of a
   reconnection being attempted). Finally, the last block just fires an event with the data
   "thirdevent" (with a single leading space character). Note that the last still has to
   end with a blank line, the end of the stream is not enough to trigger the dispatch of the last
   event.</p>

   <pre>: test stream

data: first event
id: 1

data:second event
id

data:third event
</pre>
  </div>

  <div class=example>

   <p>The following stream fires two events:</p>

   <pre>data

data
data

data:</pre>

   <p>The first block fires events with the data set to the empty string, as would the last block if
   it was followed by a blank line. The middle block fires an event with the data set to a single
   newline character. The last block is discarded because it is not followed by a blank line.</p>

  </div>

  <div class=example>

   <p>The following stream fires two identical events:</p>

   <pre>data:test

data:test
</pre>

   <p>This is because the space after the colon is ignored if present.</p>

  </div>


  <h4 id=authoring-notes>9.2.6 Authoring notes<a href=#authoring-notes class=self-link></a></h4>

  <p>Legacy proxy servers are known to, in certain cases, drop HTTP connections after a short
  timeout. To protect against such proxy servers, authors can include a comment line (one starting
  with a ':' character) every 15 seconds or so.</p>

  <p>Authors wishing to relate event source connections to each other or to specific documents
  previously served might find that relying on IP addresses doesn't work, as individual clients can
  have multiple IP addresses (due to having multiple proxy servers) and individual IP addresses can
  have multiple clients (due to sharing a proxy server). It is better to include a unique identifier
  in the document when it is served and then pass that identifier as part of the URL when the
  connection is established.</p>

  <p>Authors are also cautioned that HTTP chunking can have unexpected negative effects on the
  reliability of this protocol, in particular if the chunking is done by a different layer unaware
  of the timing requirements. If this is a problem, chunking can be disabled for serving event
  streams.</p> 

  <p>Clients that support HTTP's per-server connection limitation might run into trouble when
  opening multiple pages from a site if each page has an <code id=authoring-notes:eventsource><a href=#eventsource>EventSource</a></code> to the same
  domain. Authors can avoid this using the relatively complex mechanism of using unique domain names
  per connection, or by allowing the user to enable or disable the <code id=authoring-notes:eventsource-2><a href=#eventsource>EventSource</a></code>
  functionality on a per-page basis, or by sharing a single <code id=authoring-notes:eventsource-3><a href=#eventsource>EventSource</a></code> object using a
  <a href=#sharedworkerglobalscope id=authoring-notes:sharedworkerglobalscope>shared worker</a>.</p>


  <h4 id=eventsource-push>9.2.7 Connectionless push and other features<a href=#eventsource-push class=self-link></a></h4>

  <p>User agents running in controlled environments, e.g. browsers on mobile handsets tied to
  specific carriers, may offload the management of the connection to a proxy on the network. In such
  a situation, the user agent for the purposes of conformance is considered to include both the
  handset software and the network proxy.</p>

  <div class=example>

   <p>For example, a browser on a mobile device, after having established a connection, might detect
   that it is on a supporting network and request that a proxy server on the network take over the
   management of the connection. The timeline for such a situation might be as follows:</p>

   <ol><li>Browser connects to a remote HTTP server and requests the resource specified by the author
    in the <code id=eventsource-push:dom-eventsource><a href=#dom-eventsource>EventSource</a></code> constructor.<li>The server sends occasional messages.<li>In between two messages, the browser detects that it is idle except for the network activity
    involved in keeping the TCP connection alive, and decides to switch to sleep mode to save
    power.<li>The browser disconnects from the server.<li>The browser contacts a service on the network, and requests that the service, a "push
    proxy", maintain the connection instead.<li>The "push proxy" service contacts the remote HTTP server and requests the resource specified
    by the author in the <code id=eventsource-push:dom-eventsource-2><a href=#dom-eventsource>EventSource</a></code> constructor (possibly
    including a `<code id=eventsource-push:last-event-id><a href=#last-event-id>Last-Event-ID</a></code>` HTTP header, etc).<li>The browser allows the mobile device to go to sleep.<li>The server sends another message.<li>The "push proxy" service uses a technology such as OMA push to convey the event to the
    mobile device, which wakes only enough to process the event and then returns to sleep.</ol>

  </div>

  <p>This can reduce the total data usage, and can therefore result in considerable power
  savings.</p>

  <p>As well as implementing the existing API and <code id=eventsource-push:text/event-stream><a href=#text/event-stream>text/event-stream</a></code> wire format as
  defined by this specification and in more distributed ways as described above, formats of event
  framing defined by <a href=#other-applicable-specifications id=eventsource-push:other-applicable-specifications>other applicable specifications</a> may be supported. This
  specification does not define how they are to be parsed or processed.</p>


  <h4 id=garbage-collection-2>9.2.8 Garbage collection<a href=#garbage-collection-2 class=self-link></a></h4>

  <p>While an <code id=garbage-collection-2:eventsource><a href=#eventsource>EventSource</a></code> object's <code id=garbage-collection-2:dom-eventsource-readystate><a href=#dom-eventsource-readystate>readyState</a></code> is <code id=garbage-collection-2:dom-eventsource-connecting><a href=#dom-eventsource-connecting>CONNECTING</a></code>, and the object has one or more event
  listeners registered for <code id=garbage-collection-2:event-open><a href=#event-open>open</a></code>, <code id=garbage-collection-2:event-message><a href=#event-message>message</a></code> or <code id=garbage-collection-2:event-error><a href=#event-error>error</a></code> events, there must
  be a strong reference from the <code id=garbage-collection-2:window><a href=#window>Window</a></code> or <code id=garbage-collection-2:workerglobalscope><a href=#workerglobalscope>WorkerGlobalScope</a></code> object that
  the <code id=garbage-collection-2:eventsource-2><a href=#eventsource>EventSource</a></code> object's constructor was invoked from to the <code id=garbage-collection-2:eventsource-3><a href=#eventsource>EventSource</a></code>
  object itself.</p>

  <p>While an <code id=garbage-collection-2:eventsource-4><a href=#eventsource>EventSource</a></code> object's <code id=garbage-collection-2:dom-eventsource-readystate-2><a href=#dom-eventsource-readystate>readyState</a></code> is <code id=garbage-collection-2:dom-eventsource-open><a href=#dom-eventsource-open>OPEN</a></code>, and the object has one or more event listeners
  registered for <code id=garbage-collection-2:event-message-2><a href=#event-message>message</a></code> or <code id=garbage-collection-2:event-error-2><a href=#event-error>error</a></code> events, there must be a strong reference from the
  <code id=garbage-collection-2:window-2><a href=#window>Window</a></code> or <code id=garbage-collection-2:workerglobalscope-2><a href=#workerglobalscope>WorkerGlobalScope</a></code> object that the <code id=garbage-collection-2:eventsource-5><a href=#eventsource>EventSource</a></code>
  object's constructor was invoked from to the <code id=garbage-collection-2:eventsource-6><a href=#eventsource>EventSource</a></code> object itself.</p>

  <p>While there is a task queued by an <code id=garbage-collection-2:eventsource-7><a href=#eventsource>EventSource</a></code> object on the <a href=#remote-event-task-source id=garbage-collection-2:remote-event-task-source>remote event
  task source</a>, there must be a strong reference from the <code id=garbage-collection-2:window-3><a href=#window>Window</a></code> or
  <code id=garbage-collection-2:workerglobalscope-3><a href=#workerglobalscope>WorkerGlobalScope</a></code> object that the <code id=garbage-collection-2:eventsource-8><a href=#eventsource>EventSource</a></code> object's constructor was
  invoked from to that <code id=garbage-collection-2:eventsource-9><a href=#eventsource>EventSource</a></code> object.</p>

  <p>If a user agent is to <dfn id=concept-eventsource-forcibly-close>forcibly close</dfn> an
  <code id=garbage-collection-2:eventsource-10><a href=#eventsource>EventSource</a></code> object (this happens when a <code id=garbage-collection-2:document><a href=#document>Document</a></code> object goes away
  permanently), the user agent must abort any instances of the <a href=https://fetch.spec.whatwg.org/#concept-fetch id=garbage-collection-2:concept-fetch data-x-internal=concept-fetch>fetch</a> algorithm started for this <code id=garbage-collection-2:eventsource-11><a href=#eventsource>EventSource</a></code> object,
  and must set the <code id=garbage-collection-2:dom-eventsource-readystate-3><a href=#dom-eventsource-readystate>readyState</a></code> attribute to <code id=garbage-collection-2:dom-eventsource-closed><a href=#dom-eventsource-closed>CLOSED</a></code>.</p> 

  <p>If an <code id=garbage-collection-2:eventsource-12><a href=#eventsource>EventSource</a></code> object is garbage collected while its connection is still open,
  the user agent must abort any instance of the <a href=https://fetch.spec.whatwg.org/#concept-fetch id=garbage-collection-2:concept-fetch-2 data-x-internal=concept-fetch>fetch</a> algorithm
  opened by this <code id=garbage-collection-2:eventsource-13><a href=#eventsource>EventSource</a></code>.</p> 


  <h4 id=implementation-advice>9.2.9 Implementation advice<a href=#implementation-advice class=self-link></a></h4>

  <p><i>This section is non-normative.</i></p>

  <p>User agents are strongly urged to provide detailed diagnostic information about
  <code id=implementation-advice:eventsource><a href=#eventsource>EventSource</a></code> objects and their related network connections in their development
  consoles, to aid authors in debugging code using this API.</p>

  <p>For example, a user agent could have a panel displaying all the <code id=implementation-advice:eventsource-2><a href=#eventsource>EventSource</a></code>
  objects a page has created, each listing the constructor's arguments, whether there was a network
  error, what the CORS status of the connection is and what headers were sent by the client and
  received from the server to lead to that status, the messages that were received and how they were
  parsed, and so forth.</p>

  <p>Implementations are especially encouraged to report detailed information to their development
  consoles whenever an <code id=implementation-advice:event-error><a href=#event-error>error</a></code> event is fired, since little to no
  information can be made available in the events themselves.</p>


  <h3 id=network>9.3 <dfn>Web sockets</dfn><a href=#network class=self-link></a></h3><div class=status><input onclick=toggleStatus(this) value= type=button><p class=support><strong>Support:</strong> websockets<span class="and_chr yes"><span>Chrome for Android</span> <span>55+</span></span><span class="chrome yes"><span>Chrome</span> <span>16+</span></span><span class="ios_saf yes"><span>iOS Safari</span> <span>6.0+</span></span><span class="and_uc yes"><span>UC Browser for Android</span> <span>11+</span></span><span class="firefox yes"><span>Firefox</span> <span>11+</span></span><span class="ie yes"><span>IE</span> <span>10+</span></span><span class="samsung yes"><span>Samsung Internet</span> <span>4+</span></span><span class="op_mini no"><span>Opera Mini</span> <span>None</span></span><span class="android yes"><span>Android Browser</span> <span>4.4+</span></span><span class="safari yes"><span>Safari</span> <span>7+</span></span><span class="edge yes"><span>Edge</span> <span>12+</span></span><span class="opera yes"><span>Opera</span> <span>12.1+</span></span><p class=caniuse>Source: <a href="http://caniuse.com/#feat=websockets">caniuse.com</a></div>

  <h4 id=network-intro>9.3.1 Introduction<a href=#network-intro class=self-link></a></h4>

  <p><i>This section is non-normative.</i></p>

  <p>To enable Web applications to maintain bidirectional communications with server-side processes,
  this specification introduces the <code id=network-intro:websocket><a href=#websocket>WebSocket</a></code> interface.</p>

  <p class=note>This interface does not allow for raw access to the underlying network. For
  example, this interface could not be used to implement an IRC client without proxying messages
  through a custom server.</p>


  <h4 id=the-websocket-interface>9.3.2 The <code id=the-websocket-interface:websocket><a href=#websocket>WebSocket</a></code> interface<a href=#the-websocket-interface class=self-link></a></h4>

  <pre class=idl>enum <dfn id=binarytype>BinaryType</dfn> { "<a href=#dom-binarytype-blob id=the-websocket-interface:dom-binarytype-blob>blob</a>", "<a href=#dom-binarytype-arraybuffer id=the-websocket-interface:dom-binarytype-arraybuffer>arraybuffer</a>" };
[<a href=#dom-websocket id=the-websocket-interface:dom-websocket>Constructor</a>(USVString url, optional (DOMString or sequence&lt;DOMString>) protocols = []), Exposed=(Window,Worker)]
interface <dfn id=websocket>WebSocket</dfn> : <a id=the-websocket-interface:eventtarget href=https://dom.spec.whatwg.org/#interface-eventtarget data-x-internal=eventtarget>EventTarget</a> {
  readonly attribute USVString <a href=#dom-websocket-url id=the-websocket-interface:dom-websocket-url>url</a>;

  // ready state
  const unsigned short <a href=#dom-websocket-connecting id=the-websocket-interface:dom-websocket-connecting>CONNECTING</a> = 0;
  const unsigned short <a href=#dom-websocket-open id=the-websocket-interface:dom-websocket-open>OPEN</a> = 1;
  const unsigned short <a href=#dom-websocket-closing id=the-websocket-interface:dom-websocket-closing>CLOSING</a> = 2;
  const unsigned short <a href=#dom-websocket-closed id=the-websocket-interface:dom-websocket-closed>CLOSED</a> = 3;
  readonly attribute unsigned short <a href=#dom-websocket-readystate id=the-websocket-interface:dom-websocket-readystate>readyState</a>;
  readonly attribute unsigned long long <a href=#dom-websocket-bufferedamount id=the-websocket-interface:dom-websocket-bufferedamount>bufferedAmount</a>;

  // networking
  attribute <a href=#eventhandler id=the-websocket-interface:eventhandler>EventHandler</a> <a href=#handler-websocket-onopen id=the-websocket-interface:handler-websocket-onopen>onopen</a>;
  attribute <a href=#eventhandler id=the-websocket-interface:eventhandler-2>EventHandler</a> <a href=#handler-websocket-onerror id=the-websocket-interface:handler-websocket-onerror>onerror</a>;
  attribute <a href=#eventhandler id=the-websocket-interface:eventhandler-3>EventHandler</a> <a href=#handler-websocket-onclose id=the-websocket-interface:handler-websocket-onclose>onclose</a>;
  readonly attribute DOMString <a href=#dom-websocket-extensions id=the-websocket-interface:dom-websocket-extensions>extensions</a>;
  readonly attribute DOMString <a href=#dom-websocket-protocol id=the-websocket-interface:dom-websocket-protocol>protocol</a>;
  void <a href=#dom-websocket-close id=the-websocket-interface:dom-websocket-close>close</a>([Clamp] optional unsigned short code, optional <a href=https://heycam.github.io/webidl/#idl-USVString id=the-websocket-interface:idl-usvstring data-x-internal=idl-usvstring>USVString</a> reason);

  // messaging
  attribute <a href=#eventhandler id=the-websocket-interface:eventhandler-4>EventHandler</a> <a href=#handler-websocket-onmessage id=the-websocket-interface:handler-websocket-onmessage>onmessage</a>;
  attribute <a href=#binarytype id=the-websocket-interface:binarytype>BinaryType</a> <a href=#dom-websocket-binarytype id=the-websocket-interface:dom-websocket-binarytype>binaryType</a>;
  void <a href=#dom-websocket-send id=the-websocket-interface:dom-websocket-send>send</a>(<a href=https://heycam.github.io/webidl/#idl-USVString id=the-websocket-interface:idl-usvstring-2 data-x-internal=idl-usvstring>USVString</a> data);
  void <a href=#dom-websocket-send id=the-websocket-interface:dom-websocket-send-2>send</a>(<a id=the-websocket-interface:blob href=https://w3c.github.io/FileAPI/#blob data-x-internal=blob>Blob</a> data);
  void <a href=#dom-websocket-send id=the-websocket-interface:dom-websocket-send-3>send</a>(<a href=https://heycam.github.io/webidl/#idl-ArrayBuffer id=the-websocket-interface:idl-arraybuffer data-x-internal=idl-arraybuffer>ArrayBuffer</a> data);
  void <a href=#dom-websocket-send id=the-websocket-interface:dom-websocket-send-4>send</a>(<a href=https://heycam.github.io/webidl/#common-ArrayBufferView id=the-websocket-interface:idl-arraybufferview data-x-internal=idl-arraybufferview>ArrayBufferView</a> data);
};</pre>

  <p>Each <code id=the-websocket-interface:websocket-2><a href=#websocket>WebSocket</a></code> object has an associated <dfn id=concept-websocket-url>url</dfn> (a <a id=the-websocket-interface:url-record href=https://url.spec.whatwg.org/#concept-url data-x-internal=url-record>URL record</a>).

  <p>The <dfn id=dom-websocket><code>WebSocket(<var>url</var>,
  <var>protocols</var>)</code></dfn> constructor takes one or two arguments. The first argument,
  <var>url</var>, specifies the <a id=the-websocket-interface:url href=https://url.spec.whatwg.org/#concept-url data-x-internal=url>URL</a> to which to connect. The second,
  <var>protocols</var>, if present, is either a string or an array of strings. If it is a string, it
  is equivalent to an array consisting of just that string; if it is omitted, it is equivalent to
  the empty array. Each string in the array is a subprotocol name. The connection will only be
  established if the server reports that it has selected one of these subprotocols. The subprotocol
  names must all be strings that match the requirements for elements that comprise the value of
  <code id=the-websocket-interface:http-sec-websocket-protocol><a href=#http-sec-websocket-protocol>Sec-WebSocket-Protocol</a></code> fields as defined by the
  WebSocket protocol specification. <a href=#refsWSP>[WSP]</a></p>

  <p>The <code id=the-websocket-interface:dom-websocket-2><a href=#dom-websocket>WebSocket(<var>url</var>, <var>protocols</var>)</a></code>
  constructor, when invoked, must run these steps:</p>

  <ol><li><p>Let <var>urlRecord</var> be the result of applying the <a id=the-websocket-interface:url-parser href=https://url.spec.whatwg.org/#concept-url-parser data-x-internal=url-parser>URL parser</a> to
   <var>url</var>.<li><p>If <var>urlRecord</var> is failure, then throw a <a id=the-websocket-interface:syntaxerror href=https://heycam.github.io/webidl/#syntaxerror data-x-internal=syntaxerror>"<code>SyntaxError</code>"</a>
   <code id=the-websocket-interface:domexception><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code>.<li><p>If <var>urlRecord</var>'s <a href=https://url.spec.whatwg.org/#concept-url-scheme id=the-websocket-interface:concept-url-scheme data-x-internal=concept-url-scheme>scheme</a> is not "<code>ws</code>" or "<code>wss</code>", then throw a
   <a id=the-websocket-interface:syntaxerror-2 href=https://heycam.github.io/webidl/#syntaxerror data-x-internal=syntaxerror>"<code>SyntaxError</code>"</a> <code id=the-websocket-interface:domexception-2><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code>.<li><p>If <var>urlRecord</var>'s <a href=https://url.spec.whatwg.org/#concept-url-fragment id=the-websocket-interface:concept-url-fragment data-x-internal=concept-url-fragment>fragment</a> is non-null,
   then throw a <a id=the-websocket-interface:syntaxerror-3 href=https://heycam.github.io/webidl/#syntaxerror data-x-internal=syntaxerror>"<code>SyntaxError</code>"</a> <code id=the-websocket-interface:domexception-3><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code>.<li><p>If <var>protocols</var> is a string, set <var>protocols</var> to a sequence consisting of
   just that string.<li><p>If any of the values in <var>protocols</var> occur more than once or otherwise fail to
   match the requirements for elements that comprise the value of <code id=the-websocket-interface:http-sec-websocket-protocol-2><a href=#http-sec-websocket-protocol>Sec-WebSocket-Protocol</a></code> fields as defined by the
   WebSocket protocol specification, then throw a <a id=the-websocket-interface:syntaxerror-4 href=https://heycam.github.io/webidl/#syntaxerror data-x-internal=syntaxerror>"<code>SyntaxError</code>"</a>
   <code id=the-websocket-interface:domexception-4><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these steps. <a href=#refsWSP>[WSP]</a><li><p>Return a new <code id=the-websocket-interface:websocket-3><a href=#websocket>WebSocket</a></code> object whose <a href=#concept-websocket-url id=the-websocket-interface:concept-websocket-url>url</a> is <var>urlRecord</var>, but continue these steps
   <a href=#in-parallel id=the-websocket-interface:in-parallel>in parallel</a>.<li>
    <p><a href=https://fetch.spec.whatwg.org/#concept-websocket-establish id=the-websocket-interface:concept-websocket-establish data-x-internal=concept-websocket-establish>Establish a WebSocket connection</a> given
    <var>urlRecord</var>, <var>protocols</var>, and the <a href=#entry-settings-object id=the-websocket-interface:entry-settings-object>entry settings object</a>. <a href=#refsFETCH>[FETCH]</a></p>

    <p class=note>If the <a href=https://fetch.spec.whatwg.org/#concept-websocket-establish id=the-websocket-interface:concept-websocket-establish-2 data-x-internal=concept-websocket-establish>establish a WebSocket
    connection</a> algorithm fails, it triggers the <i id=the-websocket-interface:concept-websocket-fail><a href=#concept-websocket-fail>fail the
    WebSocket connection</a></i> algorithm, which then invokes the <i id=the-websocket-interface:concept-websocket-close><a href=#concept-websocket-close>close the WebSocket connection</a></i> algorithm, which then
    establishes that <i id=the-websocket-interface:concept-websocket-closed><a href=#concept-websocket-closed>the WebSocket connection is closed</a></i>,
    which fires the <code id=the-websocket-interface:event-close><a href=#event-close>close</a></code> event <a href=#closeWebSocket>as
    described below</a>.</p>
   </ol>

  <hr>

  <p>The <dfn id=dom-websocket-url><code>url</code></dfn> attribute's getter must return this
  <code id=the-websocket-interface:websocket-4><a href=#websocket>WebSocket</a></code> object's <a href=#concept-websocket-url id=the-websocket-interface:concept-websocket-url-2>url</a>, <a href=https://url.spec.whatwg.org/#concept-url-serializer id=the-websocket-interface:concept-url-serializer data-x-internal=concept-url-serializer>serialized</a>.</p>

  <p>The <dfn id=dom-websocket-readystate><code>readyState</code></dfn> attribute represents
  the state of the connection. It can have the following values:</p>

  <dl><dt><dfn id=dom-websocket-connecting><code>CONNECTING</code></dfn> (numeric value 0)<dd>The connection has not yet been established.<dt><dfn id=dom-websocket-open><code>OPEN</code></dfn> (numeric value 1)<dd><i id=the-websocket-interface:concept-websocket-established><a href=#concept-websocket-established>The WebSocket connection is established</a></i> and
   communication is possible.<dt><dfn id=dom-websocket-closing><code>CLOSING</code></dfn> (numeric value 2)<dd>The connection is going through the closing handshake, or the <code id=the-websocket-interface:dom-websocket-close-2><a href=#dom-websocket-close>close()</a></code> method has been invoked.<dt><dfn id=dom-websocket-closed><code>CLOSED</code></dfn> (numeric value 3)<dd>The connection has been closed or could not be opened.</dl>

  <p>When the object is created its <code id=the-websocket-interface:dom-websocket-readystate-2><a href=#dom-websocket-readystate>readyState</a></code> must be
  set to <code id=the-websocket-interface:dom-websocket-connecting-2><a href=#dom-websocket-connecting>CONNECTING</a></code> (0).</p>

  <p>The <dfn id=dom-websocket-extensions><code>extensions</code></dfn> attribute must
  initially return the empty string. After <i id=the-websocket-interface:concept-websocket-established-2><a href=#concept-websocket-established>the WebSocket
  connection is established</a></i>, its value might change, as defined below.</p>

  <p class=note>The <code id=the-websocket-interface:dom-websocket-extensions-2><a href=#dom-websocket-extensions>extensions</a></code> attribute returns
  the extensions selected by the server, if any.</p>

  <p>The <dfn id=dom-websocket-protocol><code>protocol</code></dfn> attribute must initially
  return the empty string. After <i id=the-websocket-interface:concept-websocket-established-3><a href=#concept-websocket-established>the WebSocket connection
  is established</a></i>, its value might change, as defined below.</p>

  <p class=note>The <code id=the-websocket-interface:dom-websocket-protocol-2><a href=#dom-websocket-protocol>protocol</a></code> attribute returns the
  subprotocol selected by the server, if any. It can be used in conjunction with the array form of
  the constructor's second argument to perform subprotocol negotiation.</p>

  <p>The <dfn id=dom-websocket-close><code>close(<var>code</var>,
  <var>reason</var>)</code></dfn> method, when invoked, must run these steps:</p>

  <ol><li><p>If <var>code</var> is present, but is neither an integer equal to 1000 nor an integer in
   the range 3000 to 4999, inclusive, throw an <a id=the-websocket-interface:invalidaccesserror href=https://heycam.github.io/webidl/#invalidaccesserror data-x-internal=invalidaccesserror>"<code>InvalidAccessError</code>"</a>
   <code id=the-websocket-interface:domexception-5><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code>.<li>
    <p>If <var>reason</var> is present, then run these substeps:</p>

    <ol><li><p>Let <var>reasonBytes</var> be the result of <a href=https://encoding.spec.whatwg.org/#utf-8-encode id=the-websocket-interface:utf-8-encode data-x-internal=utf-8-encode>encoding</a>
     <var>reason</var>.<li><p>If <var>reasonBytes</var> is longer than 123 bytes, then throw a
     <a id=the-websocket-interface:syntaxerror-5 href=https://heycam.github.io/webidl/#syntaxerror data-x-internal=syntaxerror>"<code>SyntaxError</code>"</a> <code id=the-websocket-interface:domexception-6><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code>.</ol>
   <li><p>Run the first matching steps from the following list:</p>

    <dl class=switch><dt>If the <code id=the-websocket-interface:dom-websocket-readystate-3><a href=#dom-websocket-readystate>readyState</a></code> attribute is in the <code id=the-websocket-interface:dom-websocket-closing-2><a href=#dom-websocket-closing>CLOSING</a></code> (2) or <code id=the-websocket-interface:dom-websocket-closed-2><a href=#dom-websocket-closed>CLOSED</a></code> (3) state<dd>

      <p>Do nothing.</p>

      <p class=note>The connection is already closing or is already closed. If it has not already,
      a <code id=the-websocket-interface:event-close-2><a href=#event-close>close</a></code> event will eventually fire <a href=#closeWebSocket>as described below</a>.</p>

     <dt>If the WebSocket connection is not yet <i id=the-websocket-interface:concept-websocket-established-4><a href=#concept-websocket-established>established</a></i> <a href=#refsWSP>[WSP]</a><dd>

      <p><i id=the-websocket-interface:concept-websocket-fail-2><a href=#concept-websocket-fail>Fail the WebSocket connection</a></i> and set the <code id=the-websocket-interface:dom-websocket-readystate-4><a href=#dom-websocket-readystate>readyState</a></code> attribute's value to <code id=the-websocket-interface:dom-websocket-closing-3><a href=#dom-websocket-closing>CLOSING</a></code> (2). <a href=#refsWSP>[WSP]</a></p>

      <p class=note>The <i id=the-websocket-interface:concept-websocket-fail-3><a href=#concept-websocket-fail>fail the WebSocket connection</a></i>
      algorithm invokes the <i id=the-websocket-interface:concept-websocket-close-2><a href=#concept-websocket-close>close the WebSocket connection</a></i>
      algorithm, which then establishes that <i id=the-websocket-interface:concept-websocket-closed-2><a href=#concept-websocket-closed>the WebSocket
      connection is closed</a></i>, which fires the <code id=the-websocket-interface:event-close-3><a href=#event-close>close</a></code> event <a href=#closeWebSocket>as described below</a>.</p>

     <dt>If the WebSocket closing handshake has not yet been <i id=the-websocket-interface:concept-websocket-closing-handshake><a href=#concept-websocket-closing-handshake>started</a></i> <a href=#refsWSP>[WSP]</a><dd>

      <p><i id=the-websocket-interface:concept-websocket-start-closing-handshake><a href=#concept-websocket-start-closing-handshake>Start the WebSocket closing
      handshake</a></i> and set the <code id=the-websocket-interface:dom-websocket-readystate-5><a href=#dom-websocket-readystate>readyState</a></code>
      attribute's value to <code id=the-websocket-interface:dom-websocket-closing-4><a href=#dom-websocket-closing>CLOSING</a></code> (2). <a href=#refsWSP>[WSP]</a></p>

      <p>If neither <var>code</var> nor <var>reason</var> is present, the WebSocket Close message
      must not have a body.</p>

      <p class=note>The WebSocket Protocol specification erroneously states that the status code
      is required for the <i id=the-websocket-interface:concept-websocket-start-closing-handshake-2><a href=#concept-websocket-start-closing-handshake>start the WebSocket
      closing handshake</a></i> algorithm.</p>

      <p>If <var>code</var> is present, then the status code to use in the
      WebSocket Close message must be the integer given by <var>close</var>. <a href=#refsWSP>[WSP]</a></p>

      <p>If <var>reason</var> is also present, then <var>reasonBytes</var> must be provided in the
      Close message after the status code. <a href=#refsWSP>[WSP]</a></p>

      <p class=note>The <i id=the-websocket-interface:concept-websocket-start-closing-handshake-3><a href=#concept-websocket-start-closing-handshake>start the WebSocket
      closing handshake</a></i> algorithm eventually invokes the <i id=the-websocket-interface:concept-websocket-close-3><a href=#concept-websocket-close>close the WebSocket connection</a></i> algorithm, which then
      establishes that <i id=the-websocket-interface:concept-websocket-closed-3><a href=#concept-websocket-closed>the WebSocket connection is closed</a></i>,
      which fires the <code id=the-websocket-interface:event-close-4><a href=#event-close>close</a></code> event <a href=#closeWebSocket>as
      described below</a>.</p>

     <dt>Otherwise<dd>

      <p>Set the <code id=the-websocket-interface:dom-websocket-readystate-6><a href=#dom-websocket-readystate>readyState</a></code> attribute's value to <code id=the-websocket-interface:dom-websocket-closing-5><a href=#dom-websocket-closing>CLOSING</a></code> (2).</p>

      <p class=note><i id=the-websocket-interface:concept-websocket-closing-handshake-2><a href=#concept-websocket-closing-handshake>The WebSocket closing
      handshake is started</a></i>, and will eventually invoke the <i id=the-websocket-interface:concept-websocket-close-4><a href=#concept-websocket-close>close the WebSocket connection</a></i> algorithm, which will
      establish that <i id=the-websocket-interface:concept-websocket-closed-4><a href=#concept-websocket-closed>the WebSocket connection is closed</a></i>,
      and thus the <code id=the-websocket-interface:event-close-5><a href=#event-close>close</a></code> event will fire, <a href=#closeWebSocket>as described below</a>.</p>

     </dl>

   </ol>

  <p class=note>The <code id=the-websocket-interface:dom-websocket-close-3><a href=#dom-websocket-close>close()</a></code> method does not discard
  previously sent messages before starting the WebSocket closing handshake  even if, in
  practice, the user agent is still busy sending those messages, the handshake will only start after
  the messages are sent.</p> 

  <hr>

  <p>The <dfn id=dom-websocket-bufferedamount><code>bufferedAmount</code></dfn> attribute must
  return the number of bytes of application data (UTF-8 text and binary data) that have been queued
  using <code id=the-websocket-interface:dom-websocket-send-5><a href=#dom-websocket-send>send()</a></code> but that, as of the last time the
  <a href=#event-loop id=the-websocket-interface:event-loop>event loop</a> reached <a href=#step1>step 1</a>, had not yet been transmitted to the network. (This thus
  includes any text sent during the execution of the current task, regardless of whether the user
  agent is able to transmit text in the background <a href=#in-parallel id=the-websocket-interface:in-parallel-2>in parallel</a> with script execution.) This does not include
  framing overhead incurred by the protocol, or buffering done by the operating system or network
  hardware. If the connection is closed, this attribute's value will only increase with each call to
  the <code id=the-websocket-interface:dom-websocket-send-6><a href=#dom-websocket-send>send()</a></code> method (the number does not reset to zero once
  the connection closes).</p>

  <div class=example>

   <p>In this simple example, the <code id=the-websocket-interface:dom-websocket-bufferedamount-2><a href=#dom-websocket-bufferedamount>bufferedAmount</a></code>
   attribute is used to ensure that updates are sent either at the rate of one update every 50ms, if
   the network can handle that rate, or at whatever rate the network <em>can</em> handle, if that is
   too fast.</p>

   <pre>var socket = new WebSocket('ws://game.example.com:12010/updates');
socket.onopen = function () {
  setInterval(function() {
    if (socket.bufferedAmount == 0)
      socket.send(getUpdateData());
  }, 50);
};</pre>

   <p>The <code id=the-websocket-interface:dom-websocket-bufferedamount-3><a href=#dom-websocket-bufferedamount>bufferedAmount</a></code> attribute can also be
   used to saturate the network without sending the data at a higher rate than the network can
   handle, though this requires more careful monitoring of the value of the attribute over time.</p>

  </div>

  <hr>

  <p>When a <code id=the-websocket-interface:websocket-5><a href=#websocket>WebSocket</a></code> object is created, its <dfn id=dom-websocket-binarytype><code>binaryType</code></dfn> IDL attribute must be set to the string
  "<code id=the-websocket-interface:dom-binarytype-blob-2><a href=#dom-binarytype-blob>blob</a></code>". On getting, it must return the last value it was
  set to. On setting, the user agent must set the IDL attribute to the new value.</p>

  <p class=note>This attribute allows authors to control how binary data is exposed to scripts. By
  setting the attribute to "<dfn id=dom-binarytype-blob><code>blob</code></dfn>", binary data
  is returned in <code id=the-websocket-interface:blob-2><a data-x-internal=blob href=https://w3c.github.io/FileAPI/#blob>Blob</a></code> form; by setting it to "<dfn id=dom-binarytype-arraybuffer><code>arraybuffer</code></dfn>", it is returned in
  <code id=the-websocket-interface:idl-arraybuffer-2><a data-x-internal=idl-arraybuffer href=https://heycam.github.io/webidl/#idl-ArrayBuffer>ArrayBuffer</a></code> form. User agents can use this as a hint for
  how to handle incoming binary data: if the attribute is set to "<code id=the-websocket-interface:dom-binarytype-blob-3><a href=#dom-binarytype-blob>blob</a></code>", it is safe to spool it to disk, and if it is set to
  "<code id=the-websocket-interface:dom-binarytype-arraybuffer-2><a href=#dom-binarytype-arraybuffer>arraybuffer</a></code>", it is likely more efficient to
  keep the data in memory. Naturally, user agents are encouraged to use more subtle heuristics to
  decide whether to keep incoming data in memory or not, e.g. based on how big the data is or how
  common it is for a script to change the attribute at the last minute. This latter aspect is
  important in particular because it is quite possible for the attribute to be changed after the
  user agent has received the data but before the user agent has fired the event for it.</p>

  <p>The <dfn id=dom-websocket-send><code>send(<var>data</var>)</code></dfn> method transmits
  data using the connection. If the <code id=the-websocket-interface:dom-websocket-readystate-7><a href=#dom-websocket-readystate>readyState</a></code>
  attribute is <code id=the-websocket-interface:dom-websocket-connecting-3><a href=#dom-websocket-connecting>CONNECTING</a></code>, it must throw an
  <a id=the-websocket-interface:invalidstateerror href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a> <code id=the-websocket-interface:domexception-7><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code>. Otherwise, the user agent
  must run the appropriate set of steps from the following list:</p>

  <dl><dt>If the argument is a string<dd>

    <p>If <i id=the-websocket-interface:concept-websocket-established-5><a href=#concept-websocket-established>the WebSocket connection is
    established</a></i> and <i id=the-websocket-interface:concept-websocket-closing-handshake-3><a href=#concept-websocket-closing-handshake>the WebSocket closing
    handshake has not yet started</a></i>, then the user agent must <i id=the-websocket-interface:concept-websocket-send><a href=#concept-websocket-send>send a WebSocket Message</a></i> comprised of the <var>data</var> argument using
    a text frame opcode; if the data cannot be sent, e.g. because it would need to be buffered but
    the buffer is full, the user agent must <a href=#concept-websocket-close-fail id=the-websocket-interface:concept-websocket-close-fail>flag the
    WebSocket as full</a> and then <i id=the-websocket-interface:concept-websocket-close-5><a href=#concept-websocket-close>close the WebSocket
    connection</a></i>. Any invocation of this method with a string argument that does not throw an
    exception must increase the <code id=the-websocket-interface:dom-websocket-bufferedamount-4><a href=#dom-websocket-bufferedamount>bufferedAmount</a></code>
    attribute by the number of bytes needed to express the argument as UTF-8. <a href=#refsUNICODE>[UNICODE]</a>
    <a href=#refsENCODING>[ENCODING]</a> <a href=#refsWSP>[WSP]</a></p>

   <dt>If the argument is a <code id=the-websocket-interface:blob-3><a data-x-internal=blob href=https://w3c.github.io/FileAPI/#blob>Blob</a></code> object<dd>

    <p>If <i id=the-websocket-interface:concept-websocket-established-6><a href=#concept-websocket-established>the WebSocket connection is established</a></i>, and
    <i id=the-websocket-interface:concept-websocket-closing-handshake-4><a href=#concept-websocket-closing-handshake>the WebSocket closing handshake has not yet
    started</a></i>, then the user agent must <i id=the-websocket-interface:concept-websocket-send-2><a href=#concept-websocket-send>send a WebSocket
    Message</a></i> comprised of <var>data</var> using a binary frame opcode; if the data cannot be
    sent, e.g. because it would need to be buffered but the buffer is full, the user agent must
    <a href=#concept-websocket-close-fail id=the-websocket-interface:concept-websocket-close-fail-2>flag the WebSocket as full</a> and then <i id=the-websocket-interface:concept-websocket-close-6><a href=#concept-websocket-close>close the WebSocket connection</a></i>. The data to be sent is the
    raw data represented by the <code id=the-websocket-interface:blob-4><a data-x-internal=blob href=https://w3c.github.io/FileAPI/#blob>Blob</a></code> object.  Any invocation of this method with a
    <code id=the-websocket-interface:blob-5><a data-x-internal=blob href=https://w3c.github.io/FileAPI/#blob>Blob</a></code> argument that does not throw an exception must increase the <code id=the-websocket-interface:dom-websocket-bufferedamount-5><a href=#dom-websocket-bufferedamount>bufferedAmount</a></code> attribute by the size of the
    <code id=the-websocket-interface:blob-6><a data-x-internal=blob href=https://w3c.github.io/FileAPI/#blob>Blob</a></code> object's raw data, in bytes.  <a href=#refsWSP>[WSP]</a> <a href=#refsFILEAPI>[FILEAPI]</a></p>

   <dt>If the argument is an <code id=the-websocket-interface:idl-arraybuffer-3><a data-x-internal=idl-arraybuffer href=https://heycam.github.io/webidl/#idl-ArrayBuffer>ArrayBuffer</a></code> object<dd>

    <p>If <i id=the-websocket-interface:concept-websocket-established-7><a href=#concept-websocket-established>the WebSocket connection is established</a></i>, and
    <i id=the-websocket-interface:concept-websocket-closing-handshake-5><a href=#concept-websocket-closing-handshake>the WebSocket closing handshake has not yet
    started</a></i>, then the user agent must <i id=the-websocket-interface:concept-websocket-send-3><a href=#concept-websocket-send>send a WebSocket
    Message</a></i> comprised of <var>data</var> using a binary frame opcode; if the data cannot be
    sent, e.g. because it would need to be buffered but the buffer is full, the user agent must
    <a href=#concept-websocket-close-fail id=the-websocket-interface:concept-websocket-close-fail-3>flag the WebSocket as full</a> and then <i id=the-websocket-interface:concept-websocket-close-7><a href=#concept-websocket-close>close the WebSocket connection</a></i>. The data to be sent is the
    data stored in the buffer described by the <code id=the-websocket-interface:idl-arraybuffer-4><a data-x-internal=idl-arraybuffer href=https://heycam.github.io/webidl/#idl-ArrayBuffer>ArrayBuffer</a></code>
    object. Any invocation of this method with an <code id=the-websocket-interface:idl-arraybuffer-5><a data-x-internal=idl-arraybuffer href=https://heycam.github.io/webidl/#idl-ArrayBuffer>ArrayBuffer</a></code>
    argument that does not throw an exception must increase the <code id=the-websocket-interface:dom-websocket-bufferedamount-6><a href=#dom-websocket-bufferedamount>bufferedAmount</a></code> attribute by the length of the
    <code id=the-websocket-interface:idl-arraybuffer-6><a data-x-internal=idl-arraybuffer href=https://heycam.github.io/webidl/#idl-ArrayBuffer>ArrayBuffer</a></code> in bytes. <a href=#refsWSP>[WSP]</a></p>

   <dt>If the argument is an object that matches the <code id=the-websocket-interface:idl-arraybufferview-2><a data-x-internal=idl-arraybufferview href=https://heycam.github.io/webidl/#common-ArrayBufferView>ArrayBufferView</a></code> type definition<dd>

    <p>If <i id=the-websocket-interface:concept-websocket-established-8><a href=#concept-websocket-established>the WebSocket connection is established</a></i>, and
    <i id=the-websocket-interface:concept-websocket-closing-handshake-6><a href=#concept-websocket-closing-handshake>the WebSocket closing handshake has not yet
    started</a></i>, then the user agent must <i id=the-websocket-interface:concept-websocket-send-4><a href=#concept-websocket-send>send a WebSocket
    Message</a></i> comprised of <var>data</var> using a binary frame opcode; if the data cannot be
    sent, e.g. because it would need to be buffered but the buffer is full, the user agent must
    <a href=#concept-websocket-close-fail id=the-websocket-interface:concept-websocket-close-fail-4>flag the WebSocket as full</a> and then <i id=the-websocket-interface:concept-websocket-close-8><a href=#concept-websocket-close>close the WebSocket connection</a></i>. The data to be sent is the
    data stored in the section of the buffer described by the <code id=the-websocket-interface:idl-arraybuffer-7><a data-x-internal=idl-arraybuffer href=https://heycam.github.io/webidl/#idl-ArrayBuffer>ArrayBuffer</a></code> object that <var>data</var> references. Any
    invocation of this method with this kind of argument that does not throw an exception must
    increase the <code id=the-websocket-interface:dom-websocket-bufferedamount-7><a href=#dom-websocket-bufferedamount>bufferedAmount</a></code> attribute by the
    length of <var>data</var>'s buffer in bytes. <a href=#refsWSP>[WSP]</a></p>

   </dl>

  <hr>

  <p>The following are the <a href=#event-handlers id=the-websocket-interface:event-handlers>event handlers</a> (and their corresponding <a href=#event-handler-event-type id=the-websocket-interface:event-handler-event-type>event handler event types</a>) that must be supported, as <a href=#event-handler-idl-attributes id=the-websocket-interface:event-handler-idl-attributes>event
  handler IDL attributes</a>, by all objects implementing the <code id=the-websocket-interface:websocket-6><a href=#websocket>WebSocket</a></code>
  interface:</p>

  <table><thead><tr><th><a href=#event-handlers id=the-websocket-interface:event-handlers-2>Event handler</a> <th><a href=#event-handler-event-type id=the-websocket-interface:event-handler-event-type-2>Event handler event type</a>
   <tbody><tr><td><dfn id=handler-websocket-onopen><code>onopen</code></dfn> <td> <code id=the-websocket-interface:event-open><a href=#event-open>open</a></code>
    <tr><td><dfn id=handler-websocket-onmessage><code>onmessage</code></dfn> <td> <code id=the-websocket-interface:event-message><a href=#event-message>message</a></code>
    <tr><td><dfn id=handler-websocket-onerror><code>onerror</code></dfn> <td> <code id=the-websocket-interface:event-error><a href=#event-error>error</a></code>
    <tr><td><dfn id=handler-websocket-onclose><code>onclose</code></dfn> <td> <code id=the-websocket-interface:event-close-6><a href=#event-close>close</a></code>
  </table>



  <h4 id=feedback-from-the-protocol>9.3.3 Feedback from the protocol<a href=#feedback-from-the-protocol class=self-link></a></h4>

  <p>When <i id=feedback-from-the-protocol:concept-websocket-established><a href=#concept-websocket-established>the WebSocket connection is established</a></i>, the
  user agent must <a href=#queue-a-task id=feedback-from-the-protocol:queue-a-task>queue a task</a> to run these steps:</p>

  <ol><li><p>Change the <code id=feedback-from-the-protocol:dom-websocket-readystate><a href=#dom-websocket-readystate>readyState</a></code> attribute's value to
   <code id=feedback-from-the-protocol:dom-websocket-open><a href=#dom-websocket-open>OPEN</a></code> (1).<li><p>Change the <code id=feedback-from-the-protocol:dom-websocket-extensions><a href=#dom-websocket-extensions>extensions</a></code> attribute's value to
   the <i id=feedback-from-the-protocol:concept-websockets-active-extensions><a href=#concept-websockets-active-extensions>extensions in use</a></i>, if is not the null
   value. <a href=#refsWSP>[WSP]</a><li><p>Change the <code id=feedback-from-the-protocol:dom-websocket-protocol><a href=#dom-websocket-protocol>protocol</a></code> attribute's value to the
   <i id=feedback-from-the-protocol:concept-websocket-subprotocol><a href=#concept-websocket-subprotocol>subprotocol in use</a></i>, if is not the null value. <a href=#refsWSP>[WSP]</a><li><p><a href=https://dom.spec.whatwg.org/#concept-event-fire id=feedback-from-the-protocol:concept-event-fire data-x-internal=concept-event-fire>Fire an event</a> named <code id=feedback-from-the-protocol:event-open><a href=#event-open>open</a></code> at the <code id=feedback-from-the-protocol:websocket><a href=#websocket>WebSocket</a></code> object.</p>

  </ol>

  <p class=note>Since the algorithm above is <a href=#queue-a-task id=feedback-from-the-protocol:queue-a-task-2>queued as a task</a>,
  there is no race condition between <i id=feedback-from-the-protocol:concept-websocket-established-2><a href=#concept-websocket-established>the WebSocket
  connection being established</a></i> and the script setting up an event listener for the <code id=feedback-from-the-protocol:event-open-2><a href=#event-open>open</a></code> event.</p>

  <hr>

  <p>When <i id=feedback-from-the-protocol:concept-websocket-message-received><a href=#concept-websocket-message-received>a WebSocket message has been received</a></i>
  with type <var>type</var> and data <var>data</var>, the user agent must <a href=#queue-a-task id=feedback-from-the-protocol:queue-a-task-3>queue a task</a>
  to follow these steps: <a href=#refsWSP>[WSP]</a></p>

  <ol><li>

    <p>If the <code id=feedback-from-the-protocol:dom-websocket-readystate-2><a href=#dom-websocket-readystate>readyState</a></code> attribute's value is not
    <code id=feedback-from-the-protocol:dom-websocket-open-2><a href=#dom-websocket-open>OPEN</a></code> (1), then abort these steps.</p>

   <li>
    <p>Let <var>dataForEvent</var> be determined by switching on <var>type</var> and <code id=feedback-from-the-protocol:dom-websocket-binarytype><a href=#dom-websocket-binarytype>binaryType</a></code>:</p>

    <dl class=switch><dt><var>type</var> indicates that the data is Text<dd>a new <code id=feedback-from-the-protocol:idl-domstring><a data-x-internal=idl-domstring href=https://heycam.github.io/webidl/#idl-DOMString>DOMString</a></code> containing <var>data</var><dt><var>type</var> indicates that the data is Binary and <code id=feedback-from-the-protocol:dom-websocket-binarytype-2><a href=#dom-websocket-binarytype>binaryType</a></code> is "<code id=feedback-from-the-protocol:dom-binarytype-blob><a href=#dom-binarytype-blob>blob</a></code>"<dd>a new <code id=feedback-from-the-protocol:blob><a data-x-internal=blob href=https://w3c.github.io/FileAPI/#blob>Blob</a></code> object, created in the <a href=#concept-relevant-realm id=feedback-from-the-protocol:concept-relevant-realm>relevant Realm</a> of the <code id=feedback-from-the-protocol:websocket-2><a href=#websocket>WebSocket</a></code> object,
     that represents <var>data</var> as its raw data <a href=#refsFILEAPI>[FILEAPI]</a><dt><var>type</var> indicates that the data is Binary and <code id=feedback-from-the-protocol:dom-websocket-binarytype-3><a href=#dom-websocket-binarytype>binaryType</a></code> is "<code id=feedback-from-the-protocol:dom-binarytype-arraybuffer><a href=#dom-binarytype-arraybuffer>arraybuffer</a></code>"<dd>a new <code id=feedback-from-the-protocol:idl-arraybuffer><a data-x-internal=idl-arraybuffer href=https://heycam.github.io/webidl/#idl-ArrayBuffer>ArrayBuffer</a></code> object, created in the <a href=#concept-relevant-realm id=feedback-from-the-protocol:concept-relevant-realm-2>relevant Realm</a> of the <code id=feedback-from-the-protocol:websocket-3><a href=#websocket>WebSocket</a></code> object,
     whose contents are <var>data</var></dl>
   <li><p><a href=https://dom.spec.whatwg.org/#concept-event-fire id=feedback-from-the-protocol:concept-event-fire-2 data-x-internal=concept-event-fire>Fire an event</a> named <code id=feedback-from-the-protocol:event-message><a href=#event-message>message</a></code> at the <code id=feedback-from-the-protocol:websocket-4><a href=#websocket>WebSocket</a></code> object, using
   <code id=feedback-from-the-protocol:messageevent><a href=#messageevent>MessageEvent</a></code>, with the <code id=feedback-from-the-protocol:dom-messageevent-origin><a href=#dom-messageevent-origin>origin</a></code>
   attribute initialized to the <a href=#unicode-serialisation-of-an-origin id=feedback-from-the-protocol:unicode-serialisation-of-an-origin>Unicode
   serialization</a> of the <code id=feedback-from-the-protocol:websocket-5><a href=#websocket>WebSocket</a></code> object's <a href=#concept-websocket-url id=feedback-from-the-protocol:concept-websocket-url>url</a>'s <a href=https://url.spec.whatwg.org/#concept-url-origin id=feedback-from-the-protocol:concept-url-origin data-x-internal=concept-url-origin>origin</a>, and
   the <code id=feedback-from-the-protocol:dom-messageevent-data><a href=#dom-messageevent-data>data</a></code> attribute initialized to
   <var>dataForEvent</var>.</ol>

  <p class=note>User agents are encouraged to check if they can perform the above steps
  efficiently before they run the task, picking tasks from other <a href=#task-queue id=feedback-from-the-protocol:task-queue>task
  queues</a> while they prepare the buffers if not. For example, if the <code id=feedback-from-the-protocol:dom-websocket-binarytype-4><a href=#dom-websocket-binarytype>binaryType</a></code> attribute was set to "<code id=feedback-from-the-protocol:dom-binarytype-blob-2><a href=#dom-binarytype-blob>blob</a></code>" when the data arrived, and the user agent spooled all
  the data to disk, but just before running the above <a href=#concept-task id=feedback-from-the-protocol:concept-task>task</a> for
  this particular message the script switched <code id=feedback-from-the-protocol:dom-websocket-binarytype-5><a href=#dom-websocket-binarytype>binaryType</a></code> to "<code id=feedback-from-the-protocol:dom-binarytype-arraybuffer-2><a href=#dom-binarytype-arraybuffer>arraybuffer</a></code>", the user agent would want to page the
  data back to RAM before running this <a href=#concept-task id=feedback-from-the-protocol:concept-task-2>task</a> so as to avoid
  stalling the main thread while it created the <code id=feedback-from-the-protocol:idl-arraybuffer-2><a data-x-internal=idl-arraybuffer href=https://heycam.github.io/webidl/#idl-ArrayBuffer>ArrayBuffer</a></code>
  object.</p>

  <div class=example>

   <p>Here is an example of how to define a handler for the <code id=feedback-from-the-protocol:event-message-2><a href=#event-message>message</a></code> event in the case of text frames:</p>

   <pre>mysocket.onmessage = function (event) {
  if (event.data == 'on') {
    turnLampOn();
  } else if (event.data == 'off') {
    turnLampOff();
  }
};</pre>

   <p>The protocol here is a trivial one, with the server just sending "on" or "off" messages.</p>

  </div>

  <hr>

  <p>When <i id=feedback-from-the-protocol:concept-websocket-closing-handshake><a href=#concept-websocket-closing-handshake>the WebSocket closing handshake is
  started</a></i>, the user agent must <a href=#queue-a-task id=feedback-from-the-protocol:queue-a-task-4>queue a task</a> to change the <code id=feedback-from-the-protocol:dom-websocket-readystate-3><a href=#dom-websocket-readystate>readyState</a></code> attribute's value to <code id=feedback-from-the-protocol:dom-websocket-closing><a href=#dom-websocket-closing>CLOSING</a></code> (2). (If the <code id=feedback-from-the-protocol:dom-websocket-close><a href=#dom-websocket-close>close()</a></code> method was called, the <code id=feedback-from-the-protocol:dom-websocket-readystate-4><a href=#dom-websocket-readystate>readyState</a></code> attribute's value will already be set to <code id=feedback-from-the-protocol:dom-websocket-closing-2><a href=#dom-websocket-closing>CLOSING</a></code> (2) when this task runs.) <a href=#refsWSP>[WSP]</a></p>

  <hr>

  <p id=closeWebSocket>When <i id=feedback-from-the-protocol:concept-websocket-closed><a href=#concept-websocket-closed>the WebSocket connection is
  closed</a></i>, possibly <i>cleanly</i>, the user agent must <a href=#queue-a-task id=feedback-from-the-protocol:queue-a-task-5>queue a task</a> to run the
  following substeps:</p>

  <ol><li><p>Change the <code id=feedback-from-the-protocol:dom-websocket-readystate-5><a href=#dom-websocket-readystate>readyState</a></code> attribute's value to
   <code id=feedback-from-the-protocol:dom-websocket-closed><a href=#dom-websocket-closed>CLOSED</a></code> (3).<li><p>If the user agent was required to <i id=feedback-from-the-protocol:concept-websocket-fail><a href=#concept-websocket-fail>fail the WebSocket
   connection</a></i>, or if the <i id=feedback-from-the-protocol:concept-websocket-closed-2><a href=#concept-websocket-closed>the WebSocket connection was
   closed</a></i> after being <dfn id=concept-websocket-close-fail>flagged as full</dfn>, <a href=https://dom.spec.whatwg.org/#concept-event-fire id=feedback-from-the-protocol:concept-event-fire-3 data-x-internal=concept-event-fire>fire an event</a> named <code>error</code> at the
   <code id=feedback-from-the-protocol:websocket-6><a href=#websocket>WebSocket</a></code> object. <a href=#refsWSP>[WSP]</a><li><p><a href=https://dom.spec.whatwg.org/#concept-event-fire id=feedback-from-the-protocol:concept-event-fire-4 data-x-internal=concept-event-fire>Fire an event</a> named <code id=feedback-from-the-protocol:event-close><a href=#event-close>close</a></code> at the <code id=feedback-from-the-protocol:websocket-7><a href=#websocket>WebSocket</a></code> object, using
   <code id=feedback-from-the-protocol:closeevent><a href=#closeevent>CloseEvent</a></code>, with the <code id=feedback-from-the-protocol:dom-closeevent-wasclean><a href=#dom-closeevent-wasclean>wasClean</a></code>
   attribute initialized to true if the connection closed <i>cleanly</i> and false otherwise, the
   <code id=feedback-from-the-protocol:dom-closeevent-code><a href=#dom-closeevent-code>code</a></code> attribute initialized to <i id=feedback-from-the-protocol:concept-websocket-close-code><a href=#concept-websocket-close-code>the WebSocket connection close code</a></i>, and the <code id=feedback-from-the-protocol:dom-closeevent-reason><a href=#dom-closeevent-reason>reason</a></code> attribute initialized to the result of applying
   <a id=feedback-from-the-protocol:utf-8-decode-without-bom href=https://encoding.spec.whatwg.org/#utf-8-decode-without-bom data-x-internal=utf-8-decode-without-bom>UTF-8 decode without BOM</a> to <i id=feedback-from-the-protocol:concept-websocket-close-reason><a href=#concept-websocket-close-reason>the WebSocket
   connection close reason</a></i>. <a href=#refsWSP>[WSP]</a></ol>

  <div class=warning>

   <p>User agents must not convey any failure information to scripts in a way that would allow a
   script to distinguish the following situations:</p>

   <ul><li>A server whose host name could not be resolved.

    <li>A server to which packets could not successfully be routed.

    <li>A server that refused the connection on the specified port.

    <li>A server that failed to correctly perform a TLS handshake (e.g., the server certificate
    can't be verified).

    <li>A server that did not complete the opening handshake (e.g. because it was not a WebSocket
    server).

    <li>A WebSocket server that sent a correct opening handshake, but that specified options that
    caused the client to drop the connection (e.g. the server specified a subprotocol that the
    client did not offer).

    <li>A WebSocket server that abruptly closed the connection after successfully completing the
    opening handshake.

   </ul>

   <p>In all of these cases, the <i id=feedback-from-the-protocol:concept-websocket-close-code-2><a href=#concept-websocket-close-code>the WebSocket connection close code</a></i> would be 1006, as
   required by the WebSocket Protocol specification. <a href=#refsWSP>[WSP]</a></p>

   <p>Allowing a script to distinguish these cases would allow a script to probe the user's local
   network in preparation for an attack.</p>

   <p class=note>In particular, this means the code 1015 is not used by the user agent (unless the
   server erroneously uses it in its close frame, of course).</p>

  </div>

  <hr>

  <p>The <a href=#task-source id=feedback-from-the-protocol:task-source>task source</a> for all <a href=#concept-task id=feedback-from-the-protocol:concept-task-3>tasks</a> <a href=#queue-a-task id=feedback-from-the-protocol:queue-a-task-6>queued</a> in this section is the <dfn id=websocket-task-source>WebSocket task source</dfn>.</p>


  <h4 id=ping-and-pong-frames>9.3.4 Ping and Pong frames<a href=#ping-and-pong-frames class=self-link></a></h4>

  <p>The WebSocket protocol specification defines Ping and Pong frames that can be used for
  keep-alive, heart-beats, network status probing, latency instrumentation, and so forth. These are
  not currently exposed in the API.</p>

  <p>User agents may send ping and unsolicited pong frames as desired, for example in an attempt to
  maintain local network NAT mappings, to detect failed connections, or to display latency metrics
  to the user. User agents must not use pings or unsolicited pongs to aid the server; it is assumed
  that servers will solicit pongs whenever appropriate for the server's needs.</p>

  


  <h4 id=the-closeevent-interfaces>9.3.5 The <code id=the-closeevent-interfaces:closeevent><a href=#closeevent>CloseEvent</a></code> interfaces<a href=#the-closeevent-interfaces class=self-link></a></h4>

  <pre class=idl>[Constructor(DOMString type, optional <a href=#closeeventinit id=the-closeevent-interfaces:closeeventinit>CloseEventInit</a> eventInitDict), Exposed=(Window,Worker)]
interface <dfn id=closeevent>CloseEvent</dfn> : <a id=the-closeevent-interfaces:event href=https://dom.spec.whatwg.org/#interface-event data-x-internal=event>Event</a> {
  readonly attribute boolean <a href=#dom-closeevent-wasclean id=the-closeevent-interfaces:dom-closeevent-wasclean>wasClean</a>;
  readonly attribute unsigned short <a href=#dom-closeevent-code id=the-closeevent-interfaces:dom-closeevent-code>code</a>;
  readonly attribute USVString <a href=#dom-closeevent-reason id=the-closeevent-interfaces:dom-closeevent-reason>reason</a>;
};

dictionary <dfn id=closeeventinit>CloseEventInit</dfn> : <a id=the-closeevent-interfaces:eventinit href=https://dom.spec.whatwg.org/#dictdef-eventinit data-x-internal=eventinit>EventInit</a> {
  boolean wasClean = false;
  unsigned short code = 0;
  USVString reason = "";
};</pre>

  <p>The <dfn id=dom-closeevent-wasclean><code>wasClean</code></dfn> attribute must return the
  value it was initialized to. It represents whether the connection closed cleanly or not.</p>

  <p>The <dfn id=dom-closeevent-code><code>code</code></dfn> attribute must return the value
  it was initialized to. It represents the WebSocket connection close code provided by the
  server.</p>

  <p>The <dfn id=dom-closeevent-reason><code>reason</code></dfn> attribute must return the
  value it was initialized to. It represents the WebSocket connection close reason provided by the
  server.</p>



  <h4 id=garbage-collection-3>9.3.6 Garbage collection<a href=#garbage-collection-3 class=self-link></a></h4>

  <p>A <code id=garbage-collection-3:websocket><a href=#websocket>WebSocket</a></code> object whose <code id=garbage-collection-3:dom-websocket-readystate><a href=#dom-websocket-readystate>readyState</a></code>
  attribute's value was set to <code id=garbage-collection-3:dom-websocket-connecting><a href=#dom-websocket-connecting>CONNECTING</a></code> (0) as of
  the last time the <a href=#event-loop id=garbage-collection-3:event-loop>event loop</a> reached <a href=#step1>step 1</a> must not be garbage collected if there
  are any event listeners registered for <code id=garbage-collection-3:event-open><a href=#event-open>open</a></code> events, <code id=garbage-collection-3:event-message><a href=#event-message>message</a></code> events, <code id=garbage-collection-3:event-error><a href=#event-error>error</a></code> events, or
  <code id=garbage-collection-3:event-close><a href=#event-close>close</a></code> events.</p>

  <p>A <code id=garbage-collection-3:websocket-2><a href=#websocket>WebSocket</a></code> object whose <code id=garbage-collection-3:dom-websocket-readystate-2><a href=#dom-websocket-readystate>readyState</a></code>
  attribute's value was set to <code id=garbage-collection-3:dom-websocket-open><a href=#dom-websocket-open>OPEN</a></code> (1) as of the last time
  the <a href=#event-loop id=garbage-collection-3:event-loop-2>event loop</a> reached <a href=#step1>step 1</a> must not be garbage collected if there are any event
  listeners registered for <code id=garbage-collection-3:event-message-2><a href=#event-message>message</a></code> events, <code id=garbage-collection-3:event-error-2><a href=#event-error>error</a></code>, or <code id=garbage-collection-3:event-close-2><a href=#event-close>close</a></code> events.</p>

  <p>A <code id=garbage-collection-3:websocket-3><a href=#websocket>WebSocket</a></code> object whose <code id=garbage-collection-3:dom-websocket-readystate-3><a href=#dom-websocket-readystate>readyState</a></code>
  attribute's value was set to <code id=garbage-collection-3:dom-websocket-closing><a href=#dom-websocket-closing>CLOSING</a></code> (2) as of the
  last time the <a href=#event-loop id=garbage-collection-3:event-loop-3>event loop</a> reached <a href=#step1>step 1</a> must not be garbage collected if there are
  any event listeners registered for <code id=garbage-collection-3:event-error-3><a href=#event-error>error</a></code> or <code id=garbage-collection-3:event-close-3><a href=#event-close>close</a></code> events.</p>

  <p>A <code id=garbage-collection-3:websocket-4><a href=#websocket>WebSocket</a></code> object with <i id=garbage-collection-3:concept-websocket-established><a href=#concept-websocket-established>an
  established connection</a></i> that has data queued to be transmitted to the network must not be
  garbage collected. <a href=#refsWSP>[WSP]</a></p>

  <p>If a <code id=garbage-collection-3:websocket-5><a href=#websocket>WebSocket</a></code> object is garbage collected while its connection is still open, the
  user agent must <i id=garbage-collection-3:concept-websocket-start-closing-handshake><a href=#concept-websocket-start-closing-handshake>start the WebSocket closing
  handshake</a></i>, with no status code for the Close message. <a href=#refsWSP>[WSP]</a></p>

  <hr>

  <p>If a user agent is to <dfn id=make-disappear>make disappear</dfn> a <code id=garbage-collection-3:websocket-6><a href=#websocket>WebSocket</a></code> object (this happens
  when a <code id=garbage-collection-3:document><a href=#document>Document</a></code> object goes away), the user agent must follow the first appropriate
  set of steps from the following list:</p>

  <dl class=switch><dt>If the WebSocket connection is not yet <i id=garbage-collection-3:concept-websocket-established-2><a href=#concept-websocket-established>established</a></i> <a href=#refsWSP>[WSP]</a><dd>

    <p><i id=garbage-collection-3:concept-websocket-fail><a href=#concept-websocket-fail>Fail the WebSocket connection</a></i>. <a href=#refsWSP>[WSP]</a></p>

   <dt>If the WebSocket closing handshake has not yet been <i id=garbage-collection-3:concept-websocket-closing-handshake><a href=#concept-websocket-closing-handshake>started</a></i> <a href=#refsWSP>[WSP]</a><dd>

    <p><i id=garbage-collection-3:concept-websocket-start-closing-handshake-2><a href=#concept-websocket-start-closing-handshake>Start the WebSocket closing
    handshake</a></i>, with the status code to use in the WebSocket Close message being
    1001. <a href=#refsWSP>[WSP]</a></p>

   <dt>Otherwise<dd>

    <p>Do nothing.</p>

   </dl>


  <h3 id=web-messaging>9.4 <dfn id=crossDocumentMessages>Cross-document messaging</dfn><a href=#web-messaging class=self-link></a></h3><div class=status><input onclick=toggleStatus(this) value= type=button><p class=support><strong>Support:</strong> x-doc-messaging<span class="and_chr yes"><span>Chrome for Android</span> <span>55+</span></span><span class="chrome yes"><span>Chrome</span> <span>4+</span></span><span class="ios_saf yes"><span>iOS Safari</span> <span>3.2+</span></span><span class="and_uc yes"><span>UC Browser for Android</span> <span>11+</span></span><span class="firefox yes"><span>Firefox</span> <span>3+</span></span><span class="ie partial"><span>IE (limited)</span> <span>8+</span></span><span class="samsung yes"><span>Samsung Internet</span> <span>4+</span></span><span class="op_mini yes"><span>Opera Mini</span> <span>all+</span></span><span class="android yes"><span>Android Browser</span> <span>2.1+</span></span><span class="safari yes"><span>Safari</span> <span>4+</span></span><span class="edge yes"><span>Edge</span> <span>12+</span></span><span class="opera yes"><span>Opera</span> <span>9.5+</span></span><p class=caniuse>Source: <a href="http://caniuse.com/#feat=x-doc-messaging">caniuse.com</a></div>

  <p>Web browsers, for security and privacy reasons, prevent documents in different domains from
  affecting each other; that is, cross-site scripting is disallowed.</p>

  <p>While this is an important security feature, it prevents pages from different domains from
  communicating even when those pages are not hostile. This section introduces a messaging system
  that allows documents to communicate with each other regardless of their source domain, in a way
  designed to not enable cross-site scripting attacks.</p>

  <p class=note>This API <a href=#fingerprint-postMessage>has some privacy implications</a> that
  may not be immediately obvious.</p>

  

  <p>The <a href=#task-source id=web-messaging:task-source>task source</a> for the <a href=#concept-task id=web-messaging:concept-task>tasks</a> in
  <a href=#web-messaging id=web-messaging:web-messaging>cross-document messaging</a> is the <dfn id=posted-message-task-source>posted message task source</dfn>.</p>

  


  <h4 id=introduction-12>9.4.1 Introduction<a href=#introduction-12 class=self-link></a></h4>

  <p><i>This section is non-normative.</i></p>

  <div class=example>

   <p>For example, if document A contains an <code id=introduction-12:the-iframe-element><a href=#the-iframe-element>iframe</a></code> element that contains document B,
   and script in document A calls <code id=introduction-12:dom-window-postmessage><a href=#dom-window-postmessage>postMessage()</a></code> on the
   <code id=introduction-12:window><a href=#window>Window</a></code> object of document B, then a message event will be fired on that object,
   marked as originating from the <code id=introduction-12:window-2><a href=#window>Window</a></code> of document A. The script in document A might
   look like:</p>

   <pre>var o = document.getElementsByTagName('iframe')[0];
o.contentWindow.postMessage('Hello world', 'https://b.example.org/');</pre>

   <p>To register an event handler for incoming events, the script would use <code>addEventListener()</code> (or similar mechanisms). For example, the script in document B
   might look like:</p>

   <pre>window.addEventListener('message', receiver, false);
function receiver(e) {
  if (e.origin == 'https://example.com') {
    if (e.data == 'Hello world') {
      e.source.postMessage('Hello', e.origin);
    } else {
      alert(e.data);
    }
  }
}</pre>

   <p>This script first checks the domain is the expected domain, and then looks at the message,
   which it either displays to the user, or responds to by sending a message back to the document
   which sent the message in the first place.</p>

  </div>



  <h4 id=security-postmsg>9.4.2 Security<a href=#security-postmsg class=self-link></a></h4>

  

  <h5 id=authors>9.4.2.1 Authors<a href=#authors class=self-link></a></h5>

  

  <p id=security-4 class=warning>Use of this API requires extra care to protect users from
  hostile entities abusing a site for their own purposes.</p>

  <p>Authors should check the <code id=authors:dom-messageevent-origin><a href=#dom-messageevent-origin>origin</a></code> attribute to
  ensure that messages are only accepted from domains that they expect to receive messages from.
  Otherwise, bugs in the author's message handling code could be exploited by hostile sites.</p>

  <p>Furthermore, even after checking the <code id=authors:dom-messageevent-origin-2><a href=#dom-messageevent-origin>origin</a></code>
  attribute, authors should also check that the data in question is of the expected format.
  Otherwise, if the source of the event has been attacked using a cross-site scripting flaw, further
  unchecked processing of information sent using the <code id=authors:dom-window-postmessage><a href=#dom-window-postmessage>postMessage()</a></code> method could result in the attack being
  propagated into the receiver.</p>

  <p>Authors should not use the wildcard keyword (*) in the <var>targetOrigin</var>
  argument in messages that contain any confidential information, as otherwise there is no way to
  guarantee that the message is only delivered to the recipient to which it was intended.</p>

  <hr>

  <p>Authors who accept messages from any origin are encouraged to consider the risks of a
  denial-of-service attack. An attacker could send a high volume of messages; if the receiving page
  performs expensive computation or causes network traffic to be sent for each such message, the
  attacker's message could be multiplied into a denial-of-service attack. Authors are encouraged to
  employ rate limiting (only accepting a certain number of messages per minute) to make such attacks
  impractical.</p>


  

  <h5 id=user-agents>9.4.2.2 User agents<a href=#user-agents class=self-link></a></h5>

  <p>The integrity of this API is based on the inability for scripts of one <a href=#concept-origin id=user-agents:concept-origin>origin</a> to
  post arbitrary events (using <code>dispatchEvent()</code> or otherwise) to objects in
  other origins (those that are not the <a href=#same-origin id=user-agents:same-origin>same</a>).</p>

  <p class=note>Implementors are urged to take extra care in the implementation of this feature.
  It allows authors to transmit information from one domain to another domain, which is normally
  disallowed for security reasons. It also requires that UAs be careful to allow access to certain
  properties but not others.</p>

  <hr>

  <p>User agents are also encouraged to consider rate-limiting message traffic between different
  <a href=#concept-origin id=user-agents:concept-origin-2>origins</a>, to protect nave sites from denial-of-service
  attacks.</p>

  




  <h4 id=posting-messages>9.4.3 Posting messages<a href=#posting-messages class=self-link></a></h4>

  <dl class=domintro><dt><var>window</var> . <code id=posting-messages:dom-window-postmessage><a href=#dom-window-postmessage>postMessage</a></code>(<var>message</var>, <var>targetOrigin</var> [, <var>transfer</var> ] )<dd>

    <p>Posts a message to the given window. Messages can be structured objects, e.g. nested objects
    and arrays, can contain JavaScript values (strings, numbers, <code id=posting-messages:date><a data-x-internal=date href=https://tc39.github.io/ecma262/#sec-date-objects>Date</a></code>
    objects, etc), and can contain certain data objects such as <code id=posting-messages:file><a data-x-internal=file href=https://w3c.github.io/FileAPI/#file>File</a></code> <code id=posting-messages:blob><a data-x-internal=blob href=https://w3c.github.io/FileAPI/#blob>Blob</a></code>,
    <code id=posting-messages:filelist><a data-x-internal=filelist href=https://w3c.github.io/FileAPI/#filelist-section>FileList</a></code>, and <code id=posting-messages:idl-arraybuffer><a data-x-internal=idl-arraybuffer href=https://heycam.github.io/webidl/#idl-ArrayBuffer>ArrayBuffer</a></code> objects.</p>

    <p>Objects listed in <var>transfer</var> are transferred, not just cloned, meaning that
    they are no longer usable on the sending side.</p>

    <p>If the origin of the target window doesn't match the given origin, the message is discarded,
    to avoid information leakage. To send the message to the target regardless of origin, set the
    target origin to "<code>*</code>". To restrict the message to same-origin targets only,
    without needing to explicitly state the origin, set the target origin to "<code>/</code>".</p>

    <p>Throws a <a id=posting-messages:datacloneerror href=https://heycam.github.io/webidl/#datacloneerror data-x-internal=datacloneerror>"<code>DataCloneError</code>"</a> <code id=posting-messages:domexception><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> if
    <var>transfer</var> array contains duplicate objects or if <var>message</var> could not be
    cloned.</p>

   </dl>

  <p class=note>When posting a message to a <code id=posting-messages:window><a href=#window>Window</a></code> of a <a href=#browsing-context id=posting-messages:browsing-context>browsing context</a>
  that has just been navigated to a new <code id=posting-messages:document><a href=#document>Document</a></code> is likely to result in the message not
  receiving its intended recipient: the scripts in the target <a href=#browsing-context id=posting-messages:browsing-context-2>browsing context</a> have to
  have had time to set up listeners for the messages. Thus, for instance, in situations where a
  message is to be sent to the <code id=posting-messages:window-2><a href=#window>Window</a></code> of newly created child <code id=posting-messages:the-iframe-element><a href=#the-iframe-element>iframe</a></code>,
  authors are advised to have the child <code id=posting-messages:document-2><a href=#document>Document</a></code> post a message to their parent
  announcing their readiness to receive messages, and for the parent to wait for this message before
  beginning posting messages.</p>

  

  <p>The <dfn id=dom-window-postmessage><code>postMessage(<var>message</var>,
  <var>targetOrigin</var>, <var>transfer</var>)</code></dfn> method, when invoked on a
  <code id=posting-messages:window-3><a href=#window>Window</a></code> object must run the following steps:</p>

  <ol><li><p>Let <var>targetWindow</var> be this <code id=posting-messages:window-4><a href=#window>Window</a></code> object.</p>

   <li><p>Let <var>targetRealm</var> be <var>targetWindow</var>'s <a href=#concept-global-object-realm id=posting-messages:concept-global-object-realm>Realm</a>.<li><p>Let <var>incumbentSettings</var> be the <a href=#incumbent-settings-object id=posting-messages:incumbent-settings-object>incumbent settings object</a>.<li><p>If <var>targetOrigin</var> is a single U+002F SOLIDUS character (/), then set
   <var>targetOrigin</var> to <var>incumbentSettings</var>'s <a href=#concept-settings-object-origin id=posting-messages:concept-settings-object-origin>origin</a>.</p>

   <li>
    <p>Otherwise, if <var>targetOrigin</var> is not a single U+002A ASTERISK character (*),
    then:</p>

    <ol><li><p>Let <var>parsedURL</var> be the result of running the <a id=posting-messages:url-parser href=https://url.spec.whatwg.org/#concept-url-parser data-x-internal=url-parser>URL parser</a> on
     <var>targetOrigin</var>.<li><p>If <var>parsedURL</var> is failure, then throw a <a id=posting-messages:syntaxerror href=https://heycam.github.io/webidl/#syntaxerror data-x-internal=syntaxerror>"<code>SyntaxError</code>"</a>
     <code id=posting-messages:domexception-2><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code>.<li><p>Set <var>targetOrigin</var> to <var>parsedURL</var>'s <a href=https://url.spec.whatwg.org/#concept-url-origin id=posting-messages:concept-url-origin data-x-internal=concept-url-origin>origin</a>.</ol>
   <li><p>Let <var>cloneRecord</var> be <a href=#structuredclonewithtransfer id=posting-messages:structuredclonewithtransfer>StructuredCloneWithTransfer</a>(<var>message</var>,
   <var>transfer</var>, <var>targetRealm</var>). Rethrow any exceptions.<li><p>Let <var>messageClone</var> be <var>cloneRecord</var>.[[Clone]].<li><p>Let <var>newPorts</var> be a new <a id=posting-messages:frozen-array href=https://heycam.github.io/webidl/#dfn-frozen-array-type data-x-internal=frozen-array>frozen array</a> consisting of all
   <code id=posting-messages:messageport><a href=#messageport>MessagePort</a></code> objects in <var>cloneRecord</var>.[[TransferList]], if any, maintaining
   their relative order.<li><p>Return, but continue running these steps in <a href=#in-parallel id=posting-messages:in-parallel>in parallel</a>.<li><p>If the <var>targetOrigin</var> argument is not a single literal U+002A ASTERISK character
   (*) and <var>targetWindow</var>'s <a href=#concept-document-window id=posting-messages:concept-document-window>associated
   <code>Document</code></a>'s <a href=#concept-origin id=posting-messages:concept-origin>origin</a> is not <a href=#same-origin id=posting-messages:same-origin>same origin</a> with
   <var>targetOrigin</var>, then abort these steps.<li><p><a href=#queue-a-task id=posting-messages:queue-a-task>Queue a task</a> on the <a href=#posted-message-task-source id=posting-messages:posted-message-task-source>posted message task source</a> to <a href=https://dom.spec.whatwg.org/#concept-event-fire id=posting-messages:concept-event-fire data-x-internal=concept-event-fire>fire an event</a> named <code id=posting-messages:event-message><a href=#event-message>message</a></code> at <var>targetWindow</var>, using
   <code id=posting-messages:messageevent><a href=#messageevent>MessageEvent</a></code>, with the <code id=posting-messages:dom-messageevent-data><a href=#dom-messageevent-data>data</a></code> attribute
   initialized to <var>messageClone</var>, the <code id=posting-messages:dom-messageevent-origin><a href=#dom-messageevent-origin>origin</a></code>
   attribute initialized to the <a href=#unicode-serialisation-of-an-origin id=posting-messages:unicode-serialisation-of-an-origin>Unicode
   serialization</a> of <var>incumbentSettings</var>'s <a href=#concept-settings-object-origin id=posting-messages:concept-settings-object-origin-2>origin</a>, the <code id=posting-messages:dom-messageevent-source><a href=#dom-messageevent-source>source</a></code> attribute initialized to the
   <code id=posting-messages:windowproxy><a href=#windowproxy>WindowProxy</a></code> object's corresponding <var>incumbentSettings</var>'s <a href=#concept-settings-object-global id=posting-messages:concept-settings-object-global>global object</a> (a <code id=posting-messages:window-5><a href=#window>Window</a></code> object), and
   the <code id=posting-messages:dom-messageevent-ports><a href=#dom-messageevent-ports>ports</a></code> attribute initialized to
   <var>newPorts</var>.</ol>

  




  <h3 id=channel-messaging>9.5 <dfn>Channel messaging</dfn><a href=#channel-messaging class=self-link></a></h3><div class=status><input onclick=toggleStatus(this) value= type=button><p class=support><strong>Support:</strong> channel-messaging<span class="and_chr yes"><span>Chrome for Android</span> <span>55+</span></span><span class="chrome yes"><span>Chrome</span> <span>4+</span></span><span class="ios_saf yes"><span>iOS Safari</span> <span>5.0+</span></span><span class="and_uc yes"><span>UC Browser for Android</span> <span>11+</span></span><span class="firefox yes"><span>Firefox</span> <span>41+</span></span><span class="ie yes"><span>IE</span> <span>10+</span></span><span class="samsung yes"><span>Samsung Internet</span> <span>4+</span></span><span class="op_mini no"><span>Opera Mini</span> <span>None</span></span><span class="android yes"><span>Android Browser</span> <span>4.4+</span></span><span class="safari yes"><span>Safari</span> <span>5+</span></span><span class="edge yes"><span>Edge</span> <span>12+</span></span><span class="opera yes"><span>Opera</span> <span>10.6+</span></span><p class=caniuse>Source: <a href="http://caniuse.com/#feat=channel-messaging">caniuse.com</a></div>

  <h4 id=introduction-13>9.5.1 Introduction<a href=#introduction-13 class=self-link></a></h4>

  <p><i>This section is non-normative.</i></p>

  <p>To enable independent pieces of code (e.g. running in different <a href=#browsing-context id=introduction-13:browsing-context>browsing contexts</a>) to communicate directly, authors can use <a href=#channel-messaging id=introduction-13:channel-messaging>channel
  messaging</a>.</p>

  <p>Communication channels in this mechanism are implemented as two-ways pipes, with a port at each
  end. Messages sent in one port are delivered at the other port, and vice-versa. Messages are
  delivered as DOM events, without interrupting or blocking running <a href=#concept-task id=introduction-13:concept-task>tasks</a>.</p>

  <p>To create a connection (two "entangled" ports), the <code>MessageChannel()</code>
  constructor is called:</p>

  <pre>var channel = new MessageChannel();</pre>

  <p>One of the ports is kept as the local port, and the other port is sent to the remote code, e.g.
  using <code id=introduction-13:dom-window-postmessage><a href=#dom-window-postmessage>postMessage()</a></code>:</p>

  <pre>otherWindow.postMessage('hello', 'https://example.com', [channel.port2]);</pre>

  <p>To send messages, the <code id=introduction-13:dom-messageport-postmessage><a href=#dom-messageport-postmessage>postMessage()</a></code> method on
  the port is used:</p>

  <pre>channel.port1.postMessage('hello');</pre>

  <p>To receive messages, one listens to <code id=introduction-13:event-message><a href=#event-message>message</a></code> events:</p>

  <pre>channel.port1.onmessage = handleMessage;
function handleMessage(event) {
  // message is in event.data
  // ...
}</pre>

  <p>Data sent on a port can be structured data; for example here an array of strings is passed on a
  <code id=introduction-13:messageport><a href=#messageport>MessagePort</a></code>:</p>

  <pre>port1.postMessage(['hello', 'world']);</pre>


  <h5 id=examples-5>9.5.1.1 Examples<a href=#examples-5 class=self-link></a></h5>

  <p><i>This section is non-normative.</i></p>

  <div class=example>

   <p>In this example, two JavaScript libraries are connected to each other using
   <code id=examples-5:messageport><a href=#messageport>MessagePort</a></code>s. This allows the libraries to later be hosted in different frames, or
   in <code id=examples-5:worker><a href=#worker>Worker</a></code> objects, without any change to the APIs.</p>

   <pre>&lt;script src="contacts.js">&lt;/script> &lt;!-- exposes a contacts object -->
&lt;script src="compose-mail.js">&lt;/script> &lt;!-- exposes a composer object -->
&lt;script>
 var channel = new MessageChannel();
 composer.addContactsProvider(channel.port1);
 contacts.registerConsumer(channel.port2);
&lt;/script></pre>

   <p>Here's what the "addContactsProvider()" function's implementation could look like:</p>

   <pre>function addContactsProvider(port) {
  port.onmessage = function (event) {
    switch (event.data.messageType) {
      'search-result': handleSearchResult(event.data.results); break;
      'search-done': handleSearchDone(); break;
      'search-error': handleSearchError(event.data.message); break;
      // ...
    }
  };
};</pre>

   <p>Alternatively, it could be implemented as follows:</p>

   <pre>function addContactsProvider(port) {
  port.addEventListener('message', function (event) {
    if (event.data.messageType == 'search-result')
      handleSearchResult(event.data.results);
  });
  port.addEventListener('message', function (event) {
    if (event.data.messageType == 'search-done')
      handleSearchDone();
  });
  port.addEventListener('message', function (event) {
    if (event.data.messageType == 'search-error')
      handleSearchError(event.data.message);
  });
  // ...
  port.start();
};</pre>

   <p>The key difference is that when using <code id=examples-5:dom-eventtarget-addeventlistener><a data-x-internal=dom-eventtarget-addeventlistener href=https://dom.spec.whatwg.org/#dom-eventtarget-addeventlistener>addEventListener()</a></code>, the <code id=examples-5:dom-messageport-start><a href=#dom-messageport-start>start()</a></code> method must also be invoked. When using <code id=examples-5:handler-messageport-onmessage><a href=#handler-messageport-onmessage>onmessage</a></code>, the call to <code id=examples-5:dom-messageport-start-2><a href=#dom-messageport-start>start()</a></code> is implied.</p>

   <p>The <code id=examples-5:dom-messageport-start-3><a href=#dom-messageport-start>start()</a></code> method, whether called explicitly or
   implicitly (by setting <code id=examples-5:handler-messageport-onmessage-2><a href=#handler-messageport-onmessage>onmessage</a></code>), starts the
   flow of messages: messages posted on message ports are initially paused, so that they don't get
   dropped on the floor before the script has had a chance to set up its handlers.</p>

  </div>


  <h5 id=ports-as-the-basis-of-an-object-capability-model-on-the-web>9.5.1.2 Ports as the basis of an object-capability model on the Web<a href=#ports-as-the-basis-of-an-object-capability-model-on-the-web class=self-link></a></h5>

  <p><i>This section is non-normative.</i></p>

  <p>Ports can be viewed as a way to expose limited capabilities (in the object-capability model
  sense) to other actors in the system. This can either be a weak capability system, where the ports
  are merely used as a convenient model within a particular origin, or as a strong capability model,
  where they are provided by one origin <var>provider</var> as the only mechanism by which
  another origin <var>consumer</var> can effect change in or obtain information from <var>provider</var>.</p>

  <p>For example, consider a situation in which a social Web site embeds in one <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element><a href=#the-iframe-element>iframe</a></code>
  the user's e-mail contacts provider (an address book site, from a second origin), and in a second
  <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element-2><a href=#the-iframe-element>iframe</a></code> a game (from a third origin). The outer social site and the game in the second
  <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element-3><a href=#the-iframe-element>iframe</a></code> cannot access anything inside the first <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element-4><a href=#the-iframe-element>iframe</a></code>; together they can
  only:</p>

  <ul class=brief><li><a href=#navigate id=ports-as-the-basis-of-an-object-capability-model-on-the-web:navigate>Navigate</a> the <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element-5><a href=#the-iframe-element>iframe</a></code> to a new <a id=ports-as-the-basis-of-an-object-capability-model-on-the-web:url href=https://url.spec.whatwg.org/#concept-url data-x-internal=url>URL</a>, such as the same
   <a id=ports-as-the-basis-of-an-object-capability-model-on-the-web:url-2 href=https://url.spec.whatwg.org/#concept-url data-x-internal=url>URL</a> but with a different <a href=https://url.spec.whatwg.org/#concept-url-fragment id=ports-as-the-basis-of-an-object-capability-model-on-the-web:concept-url-fragment data-x-internal=concept-url-fragment>fragment</a>,
   causing the <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:window><a href=#window>Window</a></code> in the <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element-6><a href=#the-iframe-element>iframe</a></code> to receive a <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:event-hashchange><a href=#event-hashchange>hashchange</a></code> event.<li>Resize the <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element-7><a href=#the-iframe-element>iframe</a></code>, causing the <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:window-2><a href=#window>Window</a></code> in the <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element-8><a href=#the-iframe-element>iframe</a></code> to
   receive a <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:event-resize><a data-x-internal=event-resize href=https://drafts.csswg.org/cssom-view/#eventdef-window-resize>resize</a></code> event.<li>Send a <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:event-message><a href=#event-message>message</a></code> event to the <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:window-3><a href=#window>Window</a></code> in the
   <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element-9><a href=#the-iframe-element>iframe</a></code> using the <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:dom-window-postmessage><a href=#dom-window-postmessage>window.postMessage()</a></code>
   API.</ul>

  <p>The contacts provider can use these methods, most particularly the third one, to provide an API
  that can be accessed by other origins to manipulate the user's address book. For example, it could
  respond to a message "<code>add-contact Guillaume Tell
  &lt;tell@pomme.example.net></code>" by adding the given person and e-mail address to the user's
  address book.</p>

  <p>To avoid any site on the Web being able to manipulate the user's contacts, the contacts
  provider might only allow certain trusted sites, such as the social site, to do this.</p>

  <p>Now suppose the game wanted to add a contact to the user's address book, and that the social
  site was willing to allow it to do so on its behalf, essentially "sharing" the trust that the
  contacts provider had with the social site. There are several ways it could do this; most simply,
  it could just proxy messages between the game site and the contacts site. However, this solution
  has a number of difficulties: it requires the social site to either completely trust the game site
  not to abuse the privilege, or it requires that the social site verify each request to make sure
  it's not a request that it doesn't want to allow (such as adding multiple contacts, reading the
  contacts, or deleting them); it also requires some additional complexity if there's ever the
  possibility of multiple games simultaneously trying to interact with the contacts provider.</p>

  <p>Using message channels and <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:messageport><a href=#messageport>MessagePort</a></code> objects, however, all of these problems can
  go away. When the game tells the social site that it wants to add a contact, the social site can
  ask the contacts provider not for it to add a contact, but for the <em>capability</em> to add a
  single contact. The contacts provider then creates a pair of <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:messageport-2><a href=#messageport>MessagePort</a></code> objects, and
  sends one of them back to the social site, who forwards it on to the game. The game and the
  contacts provider then have a direct connection, and the contacts provider knows to only honor a
  single "add contact" request, nothing else. In other words, the game has been granted the
  capability to add a single contact.</p>


  <h5 id=ports-as-the-basis-of-abstracting-out-service-implementations>9.5.1.3 Ports as the basis of abstracting out service implementations<a href=#ports-as-the-basis-of-abstracting-out-service-implementations class=self-link></a></h5>

  <p><i>This section is non-normative.</i></p>

  <p>Continuing the example from the previous section, consider the contacts provider in particular.
  While an initial implementation might have simply used <code id=ports-as-the-basis-of-abstracting-out-service-implementations:xmlhttprequest><a data-x-internal=xmlhttprequest href=https://xhr.spec.whatwg.org/#xmlhttprequest>XMLHttpRequest</a></code> objects in the
  service's <code id=ports-as-the-basis-of-abstracting-out-service-implementations:the-iframe-element><a href=#the-iframe-element>iframe</a></code>, an evolution of the service might instead want to use a <a href=#sharedworker id=ports-as-the-basis-of-abstracting-out-service-implementations:sharedworker>shared worker</a> with a single <code id=ports-as-the-basis-of-abstracting-out-service-implementations:websocket><a href=#websocket>WebSocket</a></code> connection.</p>

  <p>If the initial design used <code id=ports-as-the-basis-of-abstracting-out-service-implementations:messageport><a href=#messageport>MessagePort</a></code> objects to grant capabilities, or even just
  to allow multiple simultaneous independent sessions, the service implementation can switch from
  the <code id=ports-as-the-basis-of-abstracting-out-service-implementations:xmlhttprequest-2><a data-x-internal=xmlhttprequest href=https://xhr.spec.whatwg.org/#xmlhttprequest>XMLHttpRequest</a></code>s-in-each-<code id=ports-as-the-basis-of-abstracting-out-service-implementations:the-iframe-element-2><a href=#the-iframe-element>iframe</a></code> model to the
  shared-<code id=ports-as-the-basis-of-abstracting-out-service-implementations:websocket-2><a href=#websocket>WebSocket</a></code> model without changing the API at all: the ports on the service
  provider side can all be forwarded to the shared worker without it affecting the users of the API
  in the slightest.</p>



  <h4 id=message-channels>9.5.2 Message channels<a href=#message-channels class=self-link></a></h4>

  <pre class=idl>[<a href=#dom-messagechannel id=message-channels:dom-messagechannel>Constructor</a>, Exposed=(Window,Worker)]
interface <dfn id=messagechannel>MessageChannel</dfn> {
  readonly attribute <a href=#messageport id=message-channels:messageport>MessagePort</a> <a href=#dom-messagechannel-port1 id=message-channels:dom-messagechannel-port1>port1</a>;
  readonly attribute <a href=#messageport id=message-channels:messageport-2>MessagePort</a> <a href=#dom-messagechannel-port2 id=message-channels:dom-messagechannel-port2>port2</a>;
};</pre>

  <dl class=domintro><dt><var>channel</var> = new <code id=message-channels:dom-messagechannel-2><a href=#dom-messagechannel>MessageChannel</a></code>()<dd>

    <p>Returns a new <code id=message-channels:messagechannel><a href=#messagechannel>MessageChannel</a></code> object with two new <code id=message-channels:messageport-3><a href=#messageport>MessagePort</a></code> objects.</p>

   <dt><var>channel</var> . <code id=message-channels:dom-messagechannel-port1-2><a href=#dom-messagechannel-port1>port1</a></code><dd>

    <p>Returns the first <code id=message-channels:messageport-4><a href=#messageport>MessagePort</a></code> object.</p>

   <dt><var>channel</var> . <code id=message-channels:dom-messagechannel-port2-2><a href=#dom-messagechannel-port2>port2</a></code><dd>

    <p>Returns the second <code id=message-channels:messageport-5><a href=#messageport>MessagePort</a></code> object.</p>

   </dl>

  

  <p>When the <dfn id=dom-messagechannel><code>MessageChannel()</code></dfn> constructor is
  called, it must run the following algorithm:</p>

  <ol><li><p><a href=#create-a-new-messageport-object id=message-channels:create-a-new-messageport-object>Create a new <code>MessagePort</code> object</a> whose <a href=#concept-port-owner id=message-channels:concept-port-owner>owner</a> is the <a href=#incumbent-settings-object id=message-channels:incumbent-settings-object>incumbent settings object</a>, and let
   <var>port1</var> be that object.<li><p><a href=#create-a-new-messageport-object id=message-channels:create-a-new-messageport-object-2>Create a new <code>MessagePort</code> object</a> whose <a href=#concept-port-owner id=message-channels:concept-port-owner-2>owner</a> is the <a href=#incumbent-settings-object id=message-channels:incumbent-settings-object-2>incumbent settings object</a>, and let
   <var>port2</var> be that object.<li><p><a href=#entangle id=message-channels:entangle>Entangle</a> the <var>port1</var> and <var>port2</var> objects.<li><p>Instantiate a new <code id=message-channels:messagechannel-2><a href=#messagechannel>MessageChannel</a></code> object, and let <var>channel</var> be that
   object.<li><p>Let the <code id=message-channels:dom-messagechannel-port1-3><a href=#dom-messagechannel-port1>port1</a></code> attribute of the
   <var>channel</var> object be <var>port1</var>.</p>

   <li><p>Let the <code id=message-channels:dom-messagechannel-port2-3><a href=#dom-messagechannel-port2>port2</a></code> attribute of the
   <var>channel</var> object be <var>port2</var>.</p>

   <li><p>Return <var>channel</var>.</ol>

  <p>The <dfn id=dom-messagechannel-port1><code>port1</code></dfn> and <dfn id=dom-messagechannel-port2><code>port2</code></dfn> attributes must return the values they were
  assigned when the <code id=message-channels:messagechannel-3><a href=#messagechannel>MessageChannel</a></code> object was created.</p>

  



  <h4 id=message-ports>9.5.3 Message ports<a href=#message-ports class=self-link></a></h4>

  <p>Each channel has two message ports. Data sent through one port is received by the other port,
  and vice versa.</p>

  <pre class=idl>[Exposed=(Window,Worker)]
interface <dfn id=messageport>MessagePort</dfn> : <a id=message-ports:eventtarget href=https://dom.spec.whatwg.org/#interface-eventtarget data-x-internal=eventtarget>EventTarget</a> {
  void <a href=#dom-messageport-postmessage id=message-ports:dom-messageport-postmessage>postMessage</a>(any message, optional sequence&lt;<a href=https://heycam.github.io/webidl/#idl-object id=message-ports:idl-object data-x-internal=idl-object>object</a>> transfer = []);
  void <a href=#dom-messageport-start id=message-ports:dom-messageport-start>start</a>();
  void <a href=#dom-messageport-close id=message-ports:dom-messageport-close>close</a>();

  // event handlers
  attribute <a href=#eventhandler id=message-ports:eventhandler>EventHandler</a> <a href=#handler-messageport-onmessage id=message-ports:handler-messageport-onmessage>onmessage</a>;
};</pre>

  <dl class=domintro><dt><var>port</var> . <code id=message-ports:dom-messageport-postmessage-2><a href=#dom-messageport-postmessage>postMessage</a></code>(<var>message</var> [, <var>transfer</var>] )<dd>

    <p>Posts a message through the channel. Objects listed in <var>transfer</var> are
    transferred, not just cloned, meaning that they are no longer usable on the sending side.</p>

    <p>Throws a <a id=message-ports:datacloneerror href=https://heycam.github.io/webidl/#datacloneerror data-x-internal=datacloneerror>"<code>DataCloneError</code>"</a> <code id=message-ports:domexception><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> if
    <var>transfer</var> array contains duplicate objects or the source or target ports, or if
    <var>message</var> could not be cloned.</p>

   <dt><var>port</var> . <code id=message-ports:dom-messageport-start-2><a href=#dom-messageport-start>start</a></code>()<dd>

    <p>Begins dispatching messages received on the port.</p>

   <dt><var>port</var> . <code id=message-ports:dom-messageport-close-2><a href=#dom-messageport-close>close</a></code>()<dd>

    <p>Disconnects the port, so that it is no longer active.</p>

   </dl>

  

  <p>Each <code id=message-ports:messageport><a href=#messageport>MessagePort</a></code> object can be entangled with another (a symmetric relationship).
  Each <code id=message-ports:messageport-2><a href=#messageport>MessagePort</a></code> object also has a <a href=#task-source id=message-ports:task-source>task source</a> called the <dfn id=port-message-queue>port
  message queue</dfn>, initially empty. A <a href=#port-message-queue id=message-ports:port-message-queue>port message queue</a> can be enabled or
  disabled, and is initially disabled. Once enabled, a port can never be disabled again (though
  messages in the queue can get moved to another queue or removed altogether, which has much the
  same effect). A <code id=message-ports:messageport-3><a href=#messageport>MessagePort</a></code> also has a <dfn id=has-been-shipped>has been shipped</dfn> flag, which must
  initially be false, and an <dfn id=concept-port-owner>owner</dfn>, which is a <a href=#settings-object id=message-ports:settings-object>settings
  object</a> set when the object is created, as described below.</p>

  <p>When a port's <a href=#port-message-queue id=message-ports:port-message-queue-2>port message queue</a> is enabled, the <a href=#event-loop id=message-ports:event-loop>event loop</a> must use
  it as one of its <a href=#task-source id=message-ports:task-source-2>task sources</a>. When a port's <a href=#concept-port-owner id=message-ports:concept-port-owner>owner</a> specifies a <a href=#responsible-event-loop id=message-ports:responsible-event-loop>responsible event loop</a> that is a
  <a href=#browsing-context id=message-ports:browsing-context>browsing context</a> <a href=#event-loop id=message-ports:event-loop-2>event loop</a>, all <a href=#concept-task id=message-ports:concept-task>tasks</a> <a href=#queue-a-task id=message-ports:queue-a-task>queued</a> on its <a href=#port-message-queue id=message-ports:port-message-queue-3>port
  message queue</a> must be associated with the <a href=#responsible-document id=message-ports:responsible-document>responsible document</a> specified by
  the port's <a href=#concept-port-owner id=message-ports:concept-port-owner-2>owner</a>.</p>

  <p class=note>If the port's <a href=#concept-port-owner id=message-ports:concept-port-owner-3>owner</a> specifies a
  <a href=#responsible-document id=message-ports:responsible-document-2>responsible document</a> that is <a href=#fully-active id=message-ports:fully-active>fully active</a>, but the event listeners all
  have scripts whose <a href=#settings-object id=message-ports:settings-object-2>settings objects</a> specify <a href=#responsible-document id=message-ports:responsible-document-3>responsible documents</a> that are <em>not</em> <a href=#fully-active id=message-ports:fully-active-2>fully
  active</a>, then the messages will be lost.</p> 

  <p>Each <a href=#event-loop id=message-ports:event-loop-3>event loop</a> has a <a href=#task-source id=message-ports:task-source-3>task source</a> called the <dfn id=unshipped-port-message-queue>unshipped port
  message queue</dfn>. This is a virtual <a href=#task-source id=message-ports:task-source-4>task source</a>: it must act as if it contained
  the <a href=#concept-task id=message-ports:concept-task-2>tasks</a> of each <a href=#port-message-queue id=message-ports:port-message-queue-4>port message queue</a> of each
  <code id=message-ports:messageport-4><a href=#messageport>MessagePort</a></code> whose <a href=#has-been-shipped id=message-ports:has-been-shipped>has been shipped</a> flag is false, whose <a href=#port-message-queue id=message-ports:port-message-queue-5>port
  message queue</a> is enabled, and whose <a href=#concept-port-owner id=message-ports:concept-port-owner-4>owner</a>
  specifies that <a href=#event-loop id=message-ports:event-loop-4>event loop</a> as the <a href=#responsible-event-loop id=message-ports:responsible-event-loop-2>responsible event loop</a>, in the order in
  which they were added to their respective <a href=#task-source id=message-ports:task-source-5>task source</a>. When a <a href=#concept-task id=message-ports:concept-task-3>task</a> would be removed from the <a href=#unshipped-port-message-queue id=message-ports:unshipped-port-message-queue>unshipped port message
  queue</a>, it must instead be removed from its <a href=#port-message-queue id=message-ports:port-message-queue-6>port message queue</a>.</p>

  <p>When a <code id=message-ports:messageport-5><a href=#messageport>MessagePort</a></code>'s <a href=#has-been-shipped id=message-ports:has-been-shipped-2>has been shipped</a> flag is false, its <a href=#port-message-queue id=message-ports:port-message-queue-7>port
  message queue</a> must be ignored for the purposes of the <a href=#event-loop id=message-ports:event-loop-5>event loop</a>. (The
  <a href=#unshipped-port-message-queue id=message-ports:unshipped-port-message-queue-2>unshipped port message queue</a> is used instead.)</p>

  <p class=note>The <a href=#has-been-shipped id=message-ports:has-been-shipped-3>has been shipped</a> flag is set to true when a port, its twin, or
  the object it was cloned from, is or has been transferred. When a <code id=message-ports:messageport-6><a href=#messageport>MessagePort</a></code>'s
  <a href=#has-been-shipped id=message-ports:has-been-shipped-4>has been shipped</a> flag is true, its <a href=#port-message-queue id=message-ports:port-message-queue-8>port message queue</a> acts as a
  first-class <a href=#task-source id=message-ports:task-source-6>task source</a>, unaffected to any <a href=#unshipped-port-message-queue id=message-ports:unshipped-port-message-queue-3>unshipped port message
  queue</a>.</p>

  <p>When the user agent is to <dfn id=create-a-new-messageport-object>create a new <code>MessagePort</code> object</dfn> with a
  particular <a href=#environment-settings-object id=message-ports:environment-settings-object>environment settings object</a> as its <var>owner</var>, it must instantiate
  a new <code id=message-ports:messageport-7><a href=#messageport>MessagePort</a></code> object, and let its <a href=#concept-port-owner id=message-ports:concept-port-owner-5>owner</a>
  be <var>owner</var>.</p>

  <p>When the user agent is to <dfn id=entangle>entangle</dfn> two <code id=message-ports:messageport-8><a href=#messageport>MessagePort</a></code> objects, it must run
  the following steps:</p>

  <ol><li>

    <p>If one of the ports is already entangled, then disentangle it and the port that it was
    entangled with.</p>

    <p class=note>If those two previously entangled ports were the two ports of a
    <code id=message-ports:messagechannel><a href=#messagechannel>MessageChannel</a></code> object, then that <code id=message-ports:messagechannel-2><a href=#messagechannel>MessageChannel</a></code> object no longer
    represents an actual channel: the two ports in that object are no longer entangled.</p>

   <li>

    <p>Associate the two ports to be entangled, so that they form the two parts of a new channel.
    (There is no <code id=message-ports:messagechannel-3><a href=#messagechannel>MessageChannel</a></code> object that represents this channel.)</p>

    <p>Two ports <var>A</var> and <var>B</var> that have gone through this step
    are now said to be entangled; one is entangled to the other, and vice versa.</p>

    <p class=note>While this specification describes this process as instantaneous,
    implementations are more likely to implement it via message passing. As with all algorithms, the
    key is "merely" that the end result be indistinguishable, in a black-box sense, from the
    specification.</p>

   </ol>

  <p id=transferMessagePort><code id=message-ports:messageport-9><a href=#messageport>MessagePort</a></code> objects are <a href=#transferable-objects id=message-ports:transferable-objects>transferable
  objects</a>.</p>

  <p>Each <code id=message-ports:messageport-10><a href=#messageport>MessagePort</a></code> object's <a href=#transfer-() id=message-ports:transfer-()>[[Transfer]](<var>targetRealm</var>)</a> internal method must run these
  steps:</p>

  <ol><li><p>Set <b>this</b>'s <a href=#has-been-shipped id=message-ports:has-been-shipped-5>has been shipped</a> flag to true.<li><p>Let <var>new</var> be a <a href=#create-a-new-messageport-object id=message-ports:create-a-new-messageport-object>new
   <code>MessagePort</code> object</a> in <var>targetRealm</var> whose <a href=#concept-port-owner id=message-ports:concept-port-owner-6>owner</a> is <var>targetRealm</var>'s <a href=#concept-realm-settings-object id=message-ports:concept-realm-settings-object>settings object</a>.<li><p>Set <var>new</var>'s <a href=#has-been-shipped id=message-ports:has-been-shipped-6>has been shipped</a> flag to true.<li><p>Move all the <a href=#concept-task id=message-ports:concept-task-4>tasks</a> that are to fire <code id=message-ports:event-message><a href=#event-message>message</a></code> events in the <a href=#port-message-queue id=message-ports:port-message-queue-9>port message queue</a> of
   <b>this</b> to the <a href=#port-message-queue id=message-ports:port-message-queue-10>port message queue</a> of <var>new</var>, if any, leaving
   <var>new</var>'s <a href=#port-message-queue id=message-ports:port-message-queue-11>port message queue</a> in its initial disabled state, and, if
   <var>new</var>'s <a href=#concept-port-owner id=message-ports:concept-port-owner-7>owner</a> specifies a <a href=#responsible-event-loop id=message-ports:responsible-event-loop-3>responsible
   event loop</a> that is a <a href=#browsing-context id=message-ports:browsing-context-2>browsing context</a> <a href=#event-loop id=message-ports:event-loop-6>event loop</a>, associating
   the moved <a href=#concept-task id=message-ports:concept-task-5>tasks</a> with the <a href=#responsible-document id=message-ports:responsible-document-4>responsible document</a>
   specified by <var>new</var>'s <a href=#concept-port-owner id=message-ports:concept-port-owner-8>owner</a>.<li>
    <p>If <b>this</b> is entangled with another port, then run these substeps:</p>

    <ol><li><p>Let <var>remote port</var> be the port with which <b>this</b> is entangled.<li><p>Set <var>remote port</var>'s <a href=#has-been-shipped id=message-ports:has-been-shipped-7>has been shipped</a> flag to true.<li><p><a href=#entangle id=message-ports:entangle>Entangle</a> <var>remote port</var> and <var>new</var>. <b>this</b> will be
     disentangled by this process.</ol>
   <li><p>Set <b>this</b>'s <a href=#detached id=message-ports:detached>[[Detached]]</a> internal slot value to true.<li><p>Return <var>new</var>. It is the clone.</ol>

  <hr>

  <p>The <dfn id=dom-messageport-postmessage><code>postMessage(<var>message</var>,
  <var>transfer</var>)</code></dfn> method, when invoked on a <code id=message-ports:messageport-11><a href=#messageport>MessagePort</a></code> object, must
  run the following steps:</p>

  <ol><li><p>Let <var>targetPort</var> be the port with which this <code id=message-ports:messageport-12><a href=#messageport>MessagePort</a></code> is
   entangled, if any; otherwise let it be null.<li>
    <p>Let <var>doomed</var> be false.</p>

    <p class=note>It is set to true if a condition is detected that will make this message cause
    the port to be unusable; specifically, if the message contains <var>target port</var> as one of
    the objects being transferred. (This condition cannot necessarily be detected when the method is
    called.)</p>
   <li><p>If any of the objects in <var>transfer</var> are this <code id=message-ports:messageport-13><a href=#messageport>MessagePort</a></code>, then throw
   a <a id=message-ports:datacloneerror-2 href=https://heycam.github.io/webidl/#datacloneerror data-x-internal=datacloneerror>"<code>DataCloneError</code>"</a> <code id=message-ports:domexception-2><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code> and abort these
   steps.<li><p>If <var>targetPort</var> is not null and any of the objects in <var>transfer</var> are
   <var>targetPort</var>, then set <var>doomed</var> to true, and optionally report to a developer
   console that the target port was posted to itself, causing the communication channel to be
   lost.<li>
    <p>Let <var>targetRealm</var> be <var>targetPort</var>'s <a href=#concept-port-owner id=message-ports:concept-port-owner-9>owner</a>'s <a href="#environment-settings-object's-realm" id="message-ports:environment-settings-object's-realm">Realm</a>, if <var>targetPort</var> is non-null and <var>doomed</var> is false;
    otherwise let <var>targetRealm</var> be some arbitrary Realm.</p>

    <p class=note><var>targetRealm</var> is used when cloning and transferring objects below. If
    there is no target port, or if the <var>targetPort</var> is one of the objects being
    transferred, the transferable objects given in the second argument, if any, are still
    transferred, but since they are then discarded, it doesn't matter where they are transferred
    to.)</p>
   <li><p>Let <var>cloneRecord</var> be <a href=#structuredclonewithtransfer id=message-ports:structuredclonewithtransfer>StructuredCloneWithTransfer</a>(<var>message</var>,
   <var>transfer</var>, <var>targetRealm</var>). Rethrow any exceptions.<li><p>Let <var>messageClone</var> be <var>cloneRecord</var>.[[Clone]].<li><p>Let <var>newPorts</var> be a new <a id=message-ports:frozen-array href=https://heycam.github.io/webidl/#dfn-frozen-array-type data-x-internal=frozen-array>frozen array</a> consisting of all
   <code id=message-ports:messageport-14><a href=#messageport>MessagePort</a></code> objects in <var>cloneRecord</var>.[[TransferList]], if any, maintaining
   their relative order.<li><p>If there is no <var>targetPort</var> (i.e. if this <code id=message-ports:messageport-15><a href=#messageport>MessagePort</a></code> is not
   entangled), or if <var>doomed</var> is true, then abort these steps.<li><p>Let <var>e</var> be the result of <a id=message-ports:creating-an-event href=https://dom.spec.whatwg.org/#concept-event-create data-x-internal=creating-an-event>creating an event</a> using
   <code id=message-ports:messageevent><a href=#messageevent>MessageEvent</a></code>.<li><p>Initialize <var>e</var>'s <code id=message-ports:dom-event-type><a data-x-internal=dom-event-type href=https://dom.spec.whatwg.org/#dom-event-type>type</a></code> attribute to <code id=message-ports:event-message-2><a href=#event-message>message</a></code>, its <code id=message-ports:dom-messageevent-data><a href=#dom-messageevent-data>data</a></code>
   attribute to <var>messageClone</var>, and its <code id=message-ports:dom-messageevent-ports><a href=#dom-messageevent-ports>ports</a></code>
   attribute to <var>newPorts</var>.<li>
    <p>Add a <a href=#concept-task id=message-ports:concept-task-6>task</a> that runs the following steps to the <a href=#port-message-queue id=message-ports:port-message-queue-12>port
    message queue</a> of <var>targetPort</var>:</p>

    <ol><li><p>Let <var>target</var> be the <code id=message-ports:messageport-16><a href=#messageport>MessagePort</a></code> in whose <a href=#port-message-queue id=message-ports:port-message-queue-13>port message
     queue</a> the event <var>e</var> now finds itself.<li><p><a href=https://dom.spec.whatwg.org/#concept-event-dispatch id=message-ports:concept-event-dispatch data-x-internal=concept-event-dispatch>Dispatch</a> <var>e</var> at
     <var>target</var>.</ol>
   </ol>

  <hr>

  <p>The <dfn id=dom-messageport-start><code>start()</code></dfn> method must enable its port's
  <a href=#port-message-queue id=message-ports:port-message-queue-14>port message queue</a>, if it is not already enabled.</p>

  <hr>

  <p>The <dfn id=dom-messageport-close><code>close()</code></dfn> method, when called on a port
  <var>local port</var> that is entangled with another port, must cause the user agent to
  disentangle the two ports. If the method is called on a port that is not entangled, then the
  method must do nothing.</p>



  <hr>

  <p>The following are the <a href=#event-handlers id=message-ports:event-handlers>event handlers</a> (and their corresponding <a href=#event-handler-event-type id=message-ports:event-handler-event-type>event handler event types</a>) that must be supported, as <a href=#event-handler-idl-attributes id=message-ports:event-handler-idl-attributes>event
  handler IDL attributes</a>, by all objects implementing the <code id=message-ports:messageport-17><a href=#messageport>MessagePort</a></code>
  interface:</p>

  <table><thead><tr><th><a href=#event-handlers id=message-ports:event-handlers-2>Event handler</a> <th><a href=#event-handler-event-type id=message-ports:event-handler-event-type-2>Event handler event type</a>
   <tbody><tr><td><dfn id=handler-messageport-onmessage><code>onmessage</code></dfn> <td> <code id=message-ports:event-message-3><a href=#event-message>message</a></code>
  </table>

  <p>The first time a <code id=message-ports:messageport-18><a href=#messageport>MessagePort</a></code> object's <code id=message-ports:handler-messageport-onmessage-2><a href=#handler-messageport-onmessage>onmessage</a></code> IDL attribute is set, the port's <a href=#port-message-queue id=message-ports:port-message-queue-15>port
  message queue</a> must be enabled, as if the <code id=message-ports:dom-messageport-start-3><a href=#dom-messageport-start>start()</a></code>
  method had been called.</p>

  


  <h4 id=broadcasting-to-many-ports>9.5.4 Broadcasting to many ports<a href=#broadcasting-to-many-ports class=self-link></a></h4>

  <p><i>This section is non-normative.</i></p>

  <p>Broadcasting to many ports is in principle relatively simple: keep an array of
  <code id=broadcasting-to-many-ports:messageport><a href=#messageport>MessagePort</a></code> objects to send messages to, and iterate through the array to send a
  message. However, this has one rather unfortunate effect: it prevents the ports from being garbage
  collected, even if the other side has gone away. To avoid this problem, implement a simple
  protocol whereby the other side acknowledges it still exists. If it doesn't do so after a certain
  amount of time, assume it's gone, close the <code id=broadcasting-to-many-ports:messageport-2><a href=#messageport>MessagePort</a></code> object, and let it be garbage
  collected.</p>


  <h4 id=ports-and-garbage-collection>9.5.5 Ports and garbage collection<a href=#ports-and-garbage-collection class=self-link></a></h4>

  

  <p>When a <code id=ports-and-garbage-collection:messageport><a href=#messageport>MessagePort</a></code> object <var>o</var> is entangled, user agents must
  either act as if <var>o</var>'s entangled <code id=ports-and-garbage-collection:messageport-2><a href=#messageport>MessagePort</a></code> object has a strong
  reference to <var>o</var>, or as if the <a href=#concept-settings-object-global id=ports-and-garbage-collection:concept-settings-object-global>global
  object</a> specified by <var>o</var>'s <a href=#concept-port-owner id=ports-and-garbage-collection:concept-port-owner>owner</a> has a
  strong reference to <var>o</var>.</p>

  <div class=note>

   <p>Thus, a message port can be received, given an event listener, and then forgotten, and so long
   as that event listener could receive a message, the channel will be maintained.</p>

   <p>Of course, if this was to occur on both sides of the channel, then both ports could be garbage
   collected, since they would not be reachable from live code, despite having a strong reference to
   each other.</p>

  </div>

  <p>Furthermore, a <code id=ports-and-garbage-collection:messageport-3><a href=#messageport>MessagePort</a></code> object must not be garbage collected while there exists
  an event referenced by a <a href=#concept-task id=ports-and-garbage-collection:concept-task>task</a> in a <a href=#task-queue id=ports-and-garbage-collection:task-queue>task queue</a> that is to be dispatched on that <code id=ports-and-garbage-collection:messageport-4><a href=#messageport>MessagePort</a></code>
  object, or while the <code id=ports-and-garbage-collection:messageport-5><a href=#messageport>MessagePort</a></code> object's <a href=#port-message-queue id=ports-and-garbage-collection:port-message-queue>port message queue</a> is enabled
  and not empty.</p> 

  

  

  <p class=note>Authors are strongly encouraged to explicitly close <code id=ports-and-garbage-collection:messageport-6><a href=#messageport>MessagePort</a></code>
  objects to disentangle them, so that their resources can be recollected. Creating many
  <code id=ports-and-garbage-collection:messageport-7><a href=#messageport>MessagePort</a></code> objects and discarding them without closing them can lead to high
  transient memory usage since garbage collection is not necessarily performed promptly, especially
  for <code id=ports-and-garbage-collection:messageport-8><a href=#messageport>MessagePort</a></code>s where garbage collection can involve cross-process coordination.</p>



  <h3 id=broadcasting-to-other-browsing-contexts>9.6 <dfn>Broadcasting to other browsing contexts</dfn><a href=#broadcasting-to-other-browsing-contexts class=self-link></a></h3><div class=status><input onclick=toggleStatus(this) value= type=button><p class=support><strong>Support:</strong> broadcastchannel<span class="and_chr yes"><span>Chrome for Android</span> <span>55+</span></span><span class="chrome yes"><span>Chrome</span> <span>54+</span></span><span class="ios_saf no"><span>iOS Safari</span> <span>None</span></span><span class="and_uc no"><span>UC Browser for Android</span> <span>None</span></span><span class="firefox yes"><span>Firefox</span> <span>38+</span></span><span class="ie no"><span>IE</span> <span>None</span></span><span class="samsung no"><span>Samsung Internet</span> <span>None</span></span><span class="op_mini no"><span>Opera Mini</span> <span>None</span></span><span class="android no"><span>Android Browser</span> <span>None</span></span><span class="safari no"><span>Safari</span> <span>None</span></span><span class="edge no"><span>Edge</span> <span>None</span></span><span class="opera yes"><span>Opera</span> <span>41+</span></span><p class=caniuse>Source: <a href="http://caniuse.com/#feat=broadcastchannel">caniuse.com</a></div>

  <p>Pages on a single <a href=#concept-origin id=broadcasting-to-other-browsing-contexts:concept-origin>origin</a> opened by the same user in the same user agent but in
  different unrelated <a href=#browsing-context id=broadcasting-to-other-browsing-contexts:browsing-context>browsing contexts</a> sometimes need to
  send notifications to each other, for example "hey, the user logged in over here, check your
  credentials again".</p>

  <p>For elaborate cases, e.g. to manage locking of shared state, to manage synchronization of
  resources between a server and multiple local clients, to share a <code id=broadcasting-to-other-browsing-contexts:websocket><a href=#websocket>WebSocket</a></code>
  connection with a remote host, and so forth, <a href=#sharedworker id=broadcasting-to-other-browsing-contexts:sharedworker>shared workers</a> are
  the most appropriate solution.</p>

  <p>For simple cases, though, where a shared worker would be an unreasonable overhead, authors can
  use the simple channel-based broadcast mechanism described in this section.</p>

  <pre class=idl>[<a href=#dom-broadcastchannel id=broadcasting-to-other-browsing-contexts:dom-broadcastchannel>Constructor</a>(DOMString name), Exposed=(Window,Worker)]
interface <dfn id=broadcastchannel>BroadcastChannel</dfn> : <a id=broadcasting-to-other-browsing-contexts:eventtarget href=https://dom.spec.whatwg.org/#interface-eventtarget data-x-internal=eventtarget>EventTarget</a> {
  readonly attribute DOMString <a href=#dom-broadcastchannel-name id=broadcasting-to-other-browsing-contexts:dom-broadcastchannel-name>name</a>;
  void <a href=#dom-broadcastchannel-postmessage id=broadcasting-to-other-browsing-contexts:dom-broadcastchannel-postmessage>postMessage</a>(any message);
  void <a href=#dom-broadcastchannel-close id=broadcasting-to-other-browsing-contexts:dom-broadcastchannel-close>close</a>();
  attribute <a href=#eventhandler id=broadcasting-to-other-browsing-contexts:eventhandler>EventHandler</a> <a href=#handler-broadcastchannel-onmessage id=broadcasting-to-other-browsing-contexts:handler-broadcastchannel-onmessage>onmessage</a>;
};</pre>

  <dl class=domintro><dt><var>broadcastChannel</var> = new <code id=broadcasting-to-other-browsing-contexts:dom-broadcastchannel-2><a href=#dom-broadcastchannel>BroadcastChannel</a></code>(<var>name</var>)<dd>

    <p>Returns a new <code id=broadcasting-to-other-browsing-contexts:broadcastchannel><a href=#broadcastchannel>BroadcastChannel</a></code> object via which messages for the given channel
    name can be sent and received.</p>

   <dt><var>broadcastChannel</var> . <code id=broadcasting-to-other-browsing-contexts:dom-broadcastchannel-name-2><a href=#dom-broadcastchannel-name>name</a></code><dd>

    <p>Returns the channel name (as passed to the constructor).</p>

   <dt><var>broadcastChannel</var> . <code id=broadcasting-to-other-browsing-contexts:dom-broadcastchannel-postmessage-2><a href=#dom-broadcastchannel-postmessage>postMessage</a></code>(<var>message</var>)<dd>

    <p>Sends the given message to other <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-2><a href=#broadcastchannel>BroadcastChannel</a></code> objects set up for this channel. Messages can be structured objects, e.g. nested objects and arrays.</p>

   <dt><var>broadcastChannel</var> . <code id=broadcasting-to-other-browsing-contexts:dom-broadcastchannel-close-2><a href=#dom-broadcastchannel-close>close</a></code>()<dd>

    <p>Closes the <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-3><a href=#broadcastchannel>BroadcastChannel</a></code> object, opening it up to garbage collection.</p>

   </dl>

  

  <p>A <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-4><a href=#broadcastchannel>BroadcastChannel</a></code> object has a <dfn id=channel-name>channel name</dfn>, a
  <dfn id=broadcastchannel-settings-object><code>BroadcastChannel</code> settings object</dfn>, and a <dfn id=concept-broadcastchannel-closed>closed flag</dfn>.</p>

  <p>The <dfn id=dom-broadcastchannel><code>BroadcastChannel()</code></dfn> constructor, when
  invoked, must create and return a <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-5><a href=#broadcastchannel>BroadcastChannel</a></code> object whose <a href=#channel-name id=broadcasting-to-other-browsing-contexts:channel-name>channel
  name</a> is the constructor's first argument, whose <a href=#broadcastchannel-settings-object id=broadcasting-to-other-browsing-contexts:broadcastchannel-settings-object><code>BroadcastChannel</code>
  settings object</a> is the <a href=#incumbent-settings-object id=broadcasting-to-other-browsing-contexts:incumbent-settings-object>incumbent settings object</a>, and whose <a href=#concept-broadcastchannel-closed id=broadcasting-to-other-browsing-contexts:concept-broadcastchannel-closed>closed flag</a> is false.</p>

  <p>The <dfn id=dom-broadcastchannel-name><code>name</code></dfn> attribute must return the
  <a href=#channel-name id=broadcasting-to-other-browsing-contexts:channel-name-2>channel name</a>.</p>

  <p>The <dfn id=dom-broadcastchannel-postmessage><code>postMessage(<var>message</var>)</code></dfn> method,
  when invoked on a <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-6><a href=#broadcastchannel>BroadcastChannel</a></code> object, must run the following steps:</p>

  <ol><li><p>Let <var>source</var> be this <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-7><a href=#broadcastchannel>BroadcastChannel</a></code>.<li><p>Let <var>sourceSettings</var> be <var>source</var>'s <a href=#broadcastchannel-settings-object id=broadcasting-to-other-browsing-contexts:broadcastchannel-settings-object-2><code>BroadcastChannel</code>
   settings object</a>.<li><p>If <var>source</var>'s <a href=#concept-broadcastchannel-closed id=broadcasting-to-other-browsing-contexts:concept-broadcastchannel-closed-2>closed flag</a>
   is true, then throw an <a id=broadcasting-to-other-browsing-contexts:invalidstateerror href=https://heycam.github.io/webidl/#invalidstateerror data-x-internal=invalidstateerror>"<code>InvalidStateError</code>"</a> <code id=broadcasting-to-other-browsing-contexts:domexception><a data-x-internal=domexception href=https://heycam.github.io/webidl/#dfn-DOMException>DOMException</a></code>
   and abort these steps.<li><p>Let <var>sourceChannel</var> be <var>source</var>'s <a href=#channel-name id=broadcasting-to-other-browsing-contexts:channel-name-3>channel name</a>.<li><p>Let <var>targetRealm</var> be a user-agent defined Realm.<li><p>Let <var>clonedMessage</var> be <a href=#structuredclone id=broadcasting-to-other-browsing-contexts:structuredclone>StructuredClone</a>(<var>message</var>,
   <var>targetRealm</var>). Rethrow any exceptions.<li>
    <p>Let <var>destinations</var> be a list of <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-8><a href=#broadcastchannel>BroadcastChannel</a></code> objects that
    match the following criteria:</p>

    <ul><li>
      <p>Their <a href=#broadcastchannel-settings-object id=broadcasting-to-other-browsing-contexts:broadcastchannel-settings-object-3><code>BroadcastChannel</code> settings object</a> specifies either:</p>

      <ul><li><p>a <a href=#concept-settings-object-global id=broadcasting-to-other-browsing-contexts:concept-settings-object-global>global object</a> that is a
       <code id=broadcasting-to-other-browsing-contexts:window><a href=#window>Window</a></code> object and a <a href=#responsible-document id=broadcasting-to-other-browsing-contexts:responsible-document>responsible document</a> that is <a href=#fully-active id=broadcasting-to-other-browsing-contexts:fully-active>fully
       active</a>, or<li><p>a <a href=#concept-settings-object-global id=broadcasting-to-other-browsing-contexts:concept-settings-object-global-2>global object</a> that is a
       <code id=broadcasting-to-other-browsing-contexts:workerglobalscope><a href=#workerglobalscope>WorkerGlobalScope</a></code> object whose <a href=#dom-workerglobalscope-closing id=broadcasting-to-other-browsing-contexts:dom-workerglobalscope-closing>closing</a> flag is false and whose
       <a href=#worker id=broadcasting-to-other-browsing-contexts:worker>worker</a> is a <a href=#suspendable-worker id=broadcasting-to-other-browsing-contexts:suspendable-worker>suspendable worker</a>.</ul>
     <li><p>Their <a href=#broadcastchannel-settings-object id=broadcasting-to-other-browsing-contexts:broadcastchannel-settings-object-4><code>BroadcastChannel</code> settings object</a>'s <a href=#concept-settings-object-origin id=broadcasting-to-other-browsing-contexts:concept-settings-object-origin>origin</a> is <a href=#same-origin id=broadcasting-to-other-browsing-contexts:same-origin>same origin</a> with
     <var>sourceSettings</var>'s <a href=#concept-settings-object-origin id=broadcasting-to-other-browsing-contexts:concept-settings-object-origin-2>origin</a>.<li><p>Their <a href=#channel-name id=broadcasting-to-other-browsing-contexts:channel-name-4>channel name</a> is a <a href=#case-sensitive id=broadcasting-to-other-browsing-contexts:case-sensitive>case-sensitive</a> match for
     <var>sourceChannel</var>.<li><p>Their <a href=#concept-broadcastchannel-closed id=broadcasting-to-other-browsing-contexts:concept-broadcastchannel-closed-3>closed flag</a> is
     false.</ul>
   <li><p>Remove <var>source</var> from <var>destinations</var>.<li><p>Sort <var>destinations</var> such that all <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-9><a href=#broadcastchannel>BroadcastChannel</a></code> objects whose
   <a href=#broadcastchannel-settings-object id=broadcasting-to-other-browsing-contexts:broadcastchannel-settings-object-5><code>BroadcastChannel</code> settings
   objects</a> specify the same <a href=#responsible-event-loop id=broadcasting-to-other-browsing-contexts:responsible-event-loop>responsible event loop</a> are sorted in creation
   order, oldest first. (This does not define a complete ordering. Within this constraint, user
   agents may sort the list in any user-agent defined manner.)<li>
    <p>For each <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-10><a href=#broadcastchannel>BroadcastChannel</a></code> object <var>destination</var> in
    <var>destinations</var>, <a href=#queue-a-task id=broadcasting-to-other-browsing-contexts:queue-a-task>queue a task</a> that runs the following steps:</p>

    <ol><li><p>Let <var>targetRealm</var> be <var>destination</var>'s <a href=#relevant-settings-object id=broadcasting-to-other-browsing-contexts:relevant-settings-object>relevant settings
     object</a>'s <a href="#environment-settings-object's-realm" id="broadcasting-to-other-browsing-contexts:environment-settings-object's-realm">Realm</a>.<li><p><a href=https://dom.spec.whatwg.org/#concept-event-fire id=broadcasting-to-other-browsing-contexts:concept-event-fire data-x-internal=concept-event-fire>Fire an event</a> named <code id=broadcasting-to-other-browsing-contexts:event-message><a href=#event-message>message</a></code> at <var>destination</var>, using
     <code id=broadcasting-to-other-browsing-contexts:messageevent><a href=#messageevent>MessageEvent</a></code>, with the <code id=broadcasting-to-other-browsing-contexts:dom-messageevent-data><a href=#dom-messageevent-data>data</a></code> attribute
     initialized to <a href=#structuredclone id=broadcasting-to-other-browsing-contexts:structuredclone-2>StructuredClone</a>(<var>clonedMessage</var>, <var>targetRealm</var>)
     
     and the <code id=broadcasting-to-other-browsing-contexts:dom-messageevent-origin><a href=#dom-messageevent-origin>origin</a></code> attribute initialized to the <a href=#unicode-serialisation-of-an-origin id=broadcasting-to-other-browsing-contexts:unicode-serialisation-of-an-origin>Unicode serialization</a> of
     <var>sourceSettings</var>'s <a href=#concept-settings-object-origin id=broadcasting-to-other-browsing-contexts:concept-settings-object-origin-3>origin</a>.</ol>

    <p>The <a href=#concept-task id=broadcasting-to-other-browsing-contexts:concept-task>tasks</a> must use the <a href=#dom-manipulation-task-source id=broadcasting-to-other-browsing-contexts:dom-manipulation-task-source>DOM manipulation task
    source</a>, and, for those where the <a href=#event-loop id=broadcasting-to-other-browsing-contexts:event-loop>event loop</a> specified by the target
    <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-11><a href=#broadcastchannel>BroadcastChannel</a></code> object's <a href=#broadcastchannel-settings-object id=broadcasting-to-other-browsing-contexts:broadcastchannel-settings-object-6><code>BroadcastChannel</code> settings
    object</a> is a <a href=#browsing-context id=broadcasting-to-other-browsing-contexts:browsing-context-2>browsing context</a> <a href=#event-loop id=broadcasting-to-other-browsing-contexts:event-loop-2>event loop</a>, must be associated
    with the <a href=#responsible-document id=broadcasting-to-other-browsing-contexts:responsible-document-2>responsible document</a> specified by that target
    <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-12><a href=#broadcastchannel>BroadcastChannel</a></code> object's <a href=#broadcastchannel-settings-object id=broadcasting-to-other-browsing-contexts:broadcastchannel-settings-object-7><code>BroadcastChannel</code> settings
    object</a>.</p>
   </ol>

  <p>While a <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-13><a href=#broadcastchannel>BroadcastChannel</a></code> object whose <a href=#concept-broadcastchannel-closed id=broadcasting-to-other-browsing-contexts:concept-broadcastchannel-closed-4>closed flag</a> is false has an event listener
  registered for <code id=broadcasting-to-other-browsing-contexts:event-message-2><a href=#event-message>message</a></code> events, there must be a strong
  reference from <a href=#concept-settings-object-global id=broadcasting-to-other-browsing-contexts:concept-settings-object-global-3>global object</a> specified by
  the <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-14><a href=#broadcastchannel>BroadcastChannel</a></code> object's <a href=#broadcastchannel-settings-object id=broadcasting-to-other-browsing-contexts:broadcastchannel-settings-object-8><code>BroadcastChannel</code> settings
  object</a> to the <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-15><a href=#broadcastchannel>BroadcastChannel</a></code> object itself.</p>

  <p>The <dfn id=dom-broadcastchannel-close><code>close()</code></dfn> method must set the
  <a href=#concept-broadcastchannel-closed id=broadcasting-to-other-browsing-contexts:concept-broadcastchannel-closed-5>closed flag</a> of the
  <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-16><a href=#broadcastchannel>BroadcastChannel</a></code> object on which it was invoked to true.</p>

  <p class=note>Authors are strongly encouraged to explicitly close <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-17><a href=#broadcastchannel>BroadcastChannel</a></code>
  objects when they are no longer needed, so that they can be garbage collected. Creating many
  <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-18><a href=#broadcastchannel>BroadcastChannel</a></code> objects and discarding them while leaving them with an event
  listener and without closing them can lead to an apparent memory leak, since the objects will
  continue to live for as long as they have an event listener (or until their page or worker is
  closed).</p>

  <hr>

  <p>The following are the <a href=#event-handlers id=broadcasting-to-other-browsing-contexts:event-handlers>event handlers</a> (and their corresponding <a href=#event-handler-event-type id=broadcasting-to-other-browsing-contexts:event-handler-event-type>event handler event types</a>) that must be supported, as <a href=#event-handler-idl-attributes id=broadcasting-to-other-browsing-contexts:event-handler-idl-attributes>event
  handler IDL attributes</a>, by all objects implementing the <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-19><a href=#broadcastchannel>BroadcastChannel</a></code>
  interface:</p>

  <table><thead><tr><th><a href=#event-handlers id=broadcasting-to-other-browsing-contexts:event-handlers-2>Event handler</a> <th><a href=#event-handler-event-type id=broadcasting-to-other-browsing-contexts:event-handler-event-type-2>Event handler event type</a>
   <tbody><tr><td><dfn id=handler-broadcastchannel-onmessage><code>onmessage</code></dfn> <td> <code id=broadcasting-to-other-browsing-contexts:event-message-3><a href=#event-message>message</a></code>
  </table>

  

  <div class=example>

   <p>Suppose a page wants to know when the user logs out, even when the user does so from another
   tab at the same site:</p>

   <pre>var authChannel = new BroadcastChannel('auth');
authChannel.onmessage = function (event) {
  if (event.data == 'logout')
    showLogout();
}

function logoutRequested() {
  // called when the user asks us to log them out
  doLogout();
  showLogout();
  authChannel.postMessage('logout');
}

function doLogout() {
  // actually log the user out (e.g. clearing cookies)
  // ...
}

function showLogout() {
  // update the UI to indicate we're logged out
  // ...
}</pre>

  </div>





  <h2 id=workers data-dfn-type=dfn data-lt="web worker" data-export="">10 Web workers<a href=#workers class=self-link></a></h2>

  <h3 id=introduction-14>10.1 Introduction<a href=#introduction-14 class=self-link></a></h3>

  <h4 id=scope-2>10.1.1 Scope<a href=#scope-2 class=self-link></a></h4>

  <p><i>This section is non-normative.</i></p>

  <p>This specification defines an API for running scripts in the background independently of any
  user interface scripts.</p>

  <p>This allows for long-running scripts that are not interrupted by scripts that respond to clicks
  or other user interactions, and allows long tasks to be executed without yielding to keep the page
  responsive.</p>

  <p>Workers (as these background scripts are called herein) are relatively heavy-weight, and are
  not intended to be used in large numbers. For example, it would be inappropriate to launch one
  worker for each pixel of a four megapixel image. The examples below show some appropriate uses of
  workers.</p>

  <p>Generally, workers are expected to be long-lived, have a high start-up performance cost, and a
  high per-instance memory cost.</p>


  <h4 id=examples-6>10.1.2 Examples<a href=#examples-6 class=self-link></a></h4>

  <p><i>This section is non-normative.</i></p>

  <p>There are a variety of uses that workers can be put to. The following subsections show various
  examples of this use.</p>

  <h5 id=a-background-number-crunching-worker>10.1.2.1 A background number-crunching worker<a href=#a-background-number-crunching-worker class=self-link></a></h5>

  <p><i>This section is non-normative.</i></p>

  <p>The simplest use of workers is for performing a computationally
  expensive task without interrupting the user interface.</p>

  <p>In this example, the main document spawns a worker to (navely) compute prime numbers, and
  progressively displays the most recently found prime number.</p>

  <p>The main page is as follows:</p>

  <pre>&lt;!DOCTYPE HTML>
&lt;html>
 &lt;head>
  &lt;meta charset="utf-8">
  &lt;title>Worker example: One-core computation&lt;/title>
 &lt;/head>
 &lt;body>
  &lt;p>The highest prime number discovered so far is: &lt;output id="result">&lt;/output>&lt;/p>
  &lt;script>
   var worker = new Worker('worker.js');
   worker.onmessage = function (event) {
     document.getElementById('result').textContent = event.data;
   };
  &lt;/script>
 &lt;/body>
&lt;/html>
</pre>

  <p>The <code id=a-background-number-crunching-worker:dom-worker><a href=#dom-worker>Worker()</a></code> constructor call creates a worker and returns a
  <code id=a-background-number-crunching-worker:worker><a href=#worker>Worker</a></code> object representing that worker, which is used to communicate with the worker.
  That object's <code id=a-background-number-crunching-worker:handler-worker-onmessage><a href=#handler-worker-onmessage>onmessage</a></code> event handler allows the
  code to receive messages from the worker.</p>

  <p>The worker itself is as follows:</p>

  <pre>var n = 1;
search: while (true) {
  n += 1;
  for (var i = 2; i &lt;= Math.sqrt(n); i += 1)
    if (n % i == 0)
     continue search;
  // found a prime!
  postMessage(n);
}
</pre>

  <p>The bulk of this code is simply an unoptimized search for a prime number. The <code id=a-background-number-crunching-worker:dom-dedicatedworkerglobalscope-postmessage><a href=#dom-dedicatedworkerglobalscope-postmessage>postMessage()</a></code> method is used to send a
  message back to the page when a prime is found.</p>

  <p><a href=/demos/workers/primes/page.html>View this example online</a>.</p>




  <h5 id=worker-used-for-background-i/o>10.1.2.2 Worker used for background I/O<a href=#worker-used-for-background-i/o class=self-link></a></h5>

  <p><i>This section is non-normative.</i></p>

  <p>In this example, the main document uses two workers, one for fetching stock updates at regular
  intervals, and one for performing search queries that the user requests.</p>

  <p>The main page is as follows:</p>

  <pre>&lt;!DOCTYPE HTML>
&lt;html>
 &lt;head>
  &lt;meta charset="utf-8">
  &lt;title>Worker example: Stock ticker&lt;/title>
  &lt;script>
   // TICKER
   var symbol = 'GOOG'; // default symbol to watch
   var ticker = new Worker('ticker.js');

   // SEARCHER
   var searcher = new Worker('searcher.js');
   function search(query) {
     searcher.postMessage(query);
   }

   // SYMBOL SELECTION UI
   function select(newSymbol) {
     symbol = newSymbol;
     ticker.postMessage(symbol);
   }
  &lt;/script>
  &lt;meta http-equiv="Refresh" content="120; URL=../">
 &lt;/head>
 &lt;body onload="search('')">
  &lt;p>&lt;output id="symbol">&lt;/output> &lt;output id="value">&lt;/output>&lt;/p>
  &lt;script>
   ticker.onmessage = function (event) {
     var data = event.data.split(' ');
     document.getElementById('symbol').textContent = data[0];
     document.getElementById('value').textContent = data[1];
   };
   ticker.postMessage(symbol);
  &lt;/script>
  &lt;p>&lt;label>Search: &lt;input type="text" autofocus oninput="search(this.value)">&lt;/label>&lt;/p>
  &lt;ul id="results">&lt;/ul>
  &lt;script>
   searcher.onmessage = function (event) {
     var data = event.data.split(' ');
     var results = document.getElementById('results');
     while (results.hasChildNodes()) // clear previous results
       results.removeChild(results.firstChild);
     for (var i = 0; i &lt; data.length; i += 1) {
       // add a list item with a button for each result
       var li = document.createElement('li');
       var button = document.createElement('button');
       button.value = data[i];
       button.type = 'button';
       button.onclick = function () { select(this.value); };
       button.textContent = data[i];
       li.appendChild(button);
       results.appendChild(li);
     }
   };
  &lt;/script>
  &lt;p>(The data in this example is not real. Try searching for "Google" or "Apple".)&lt;/p>
 &lt;/body>
&lt;/html>
</pre>

  <p>The two workers use a common library for performing the actual network calls. This library is
  as follows:</p>

  <pre>function get(url) {
  try {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, false);
    xhr.send();
    return xhr.responseText;
  } catch (e) {
    return ''; // turn all errors into empty results
  }
}
</pre>

  <p>The stock updater worker is as follows:</p>

  <pre>importScripts('io.js');
var timer;
var symbol;
function update() {
  postMessage(symbol + ' ' + get('stock.cgi?' + symbol));
  timer = setTimeout(update, 10000);
}
onmessage = function (event) {
  if (timer)
    clearTimeout(timer);
  symbol = event.data;
  update();
};
</pre>

  <p>The search query worker is as follows:</p>

  <pre>importScripts('io.js');
onmessage = function (event) {
  postMessage(get('search.cgi?' + event.data));
