  <p>User agents may add content to the <code id=read-media:the-head-element-2><a href=#the-head-element>head</a></code> element of the <code id=read-media:document-6><a href=#document>Document</a></code>, or
  attributes to the element <var>host element</var>, e.g., to link to a style sheet, to provide a
  script, to give the document a <code id=read-media:the-title-element><a href=#the-title-element>title</a></code>, or to make the media <a href=#attr-media-autoplay id=read-media:attr-media-autoplay>autoplay</a>.</p>


  <h4 id=read-plugin>7.8.7 <dfn>Page load processing model for content that uses plugins</dfn><a href=#read-plugin class=self-link></a></h4>

  <p>When a resource that requires an external resource to be rendered is to be loaded in a
  <a href=#browsing-context id=read-plugin:browsing-context>browsing context</a>, the user agent should create a <code id=read-plugin:document><a href=#document>Document</a></code> object, mark
  it as being an <a href=https://dom.spec.whatwg.org/#html-document id=read-plugin:html-documents data-x-internal=html-documents>HTML document</a> and mark it as being a
  <dfn id=plugin-document>plugin document</dfn>, set its <a href=https://dom.spec.whatwg.org/#concept-document-content-type id=read-plugin:concept-document-content-type data-x-internal=concept-document-content-type>content
  type</a> to the <a href=https://mimesniff.spec.whatwg.org/#computed-mime-type id=read-plugin:content-type-sniffing-2 data-x-internal=content-type-sniffing-2>computed MIME type</a> of the
  resource (<var>type</var> in the <a href=#navigate id=read-plugin:navigate>navigate</a> algorithm), <a href=#initialise-the-document-object id=read-plugin:initialise-the-document-object>initialize the
  <code>Document</code> object</a>, append an <code id=read-plugin:the-html-element><a href=#the-html-element>html</a></code> element to the
  <code id=read-plugin:document-2><a href=#document>Document</a></code>, append a <code id=read-plugin:the-head-element><a href=#the-head-element>head</a></code> element and a <code id=read-plugin:the-body-element><a href=#the-body-element>body</a></code> element to the
  <code id=read-plugin:the-html-element-2><a href=#the-html-element>html</a></code> element, append an <code id=read-plugin:the-embed-element><a href=#the-embed-element>embed</a></code> to the <code id=read-plugin:the-body-element-2><a href=#the-body-element>body</a></code> element, and
  set the <code id=read-plugin:attr-embed-src><a href=#attr-embed-src>src</a></code> attribute of the <code id=read-plugin:the-embed-element-2><a href=#the-embed-element>embed</a></code> element to
  the address of the resource.</p>

  <p class=note>The term <a href=#plugin-document id=read-plugin:plugin-document>plugin document</a> is used by
  <cite>Content Security Policy</cite> as part of the mechanism that ensures <code id=read-plugin:the-iframe-element><a href=#the-iframe-element>iframe</a></code>s
  can't be used to evade <code>plugin-types</code> directives. <a href=#refsCSP>[CSP]</a></p>

  

  <p>Then, the user agent must act as if it had <a href=#stop-parsing id=read-plugin:stop-parsing>stopped
  parsing</a>.</p>

  <p>Upon creation of the <code id=read-plugin:document-3><a href=#document>Document</a></code> object, the user agent must run the <a href=#concept-appcache-init id=read-plugin:concept-appcache-init>application cache selection algorithm</a> with no manifest, and
  passing in the newly-created <code id=read-plugin:document-4><a href=#document>Document</a></code>.</p>

  <p>After creating the <code id=read-plugin:document-5><a href=#document>Document</a></code> object, but potentially before the page has finished
  fully loading, the user agent must <a href=#update-the-session-history-with-the-new-page id=read-plugin:update-the-session-history-with-the-new-page>update the session history with the new page</a>.</p>

  <p>User agents may add content to the <code id=read-plugin:the-head-element-2><a href=#the-head-element>head</a></code> element of the <code id=read-plugin:document-6><a href=#document>Document</a></code>, or
  attributes to the <code id=read-plugin:the-embed-element-3><a href=#the-embed-element>embed</a></code> element, e.g. to link to a style sheet or to give the
  document a <code id=read-plugin:the-title-element><a href=#the-title-element>title</a></code>.</p>

  <p id=sandboxPluginNavigate class=note>If the <code id=read-plugin:document-7><a href=#document>Document</a></code>'s <a href=#active-sandboxing-flag-set id=read-plugin:active-sandboxing-flag-set>active sandboxing
  flag set</a> has its <a href=#sandboxed-plugins-browsing-context-flag id=read-plugin:sandboxed-plugins-browsing-context-flag>sandboxed plugins browsing context flag</a> set, the synthesized
  <code id=read-plugin:the-embed-element-4><a href=#the-embed-element>embed</a></code> element will <a href=#sandboxPluginEmbed>fail to render the content</a> if
  the relevant <a href=#plugin id=read-plugin:plugin>plugin</a> cannot be <a href=#concept-plugin-secure id=read-plugin:concept-plugin-secure>secured</a>.</p>


  <h4 id=read-ua-inline>7.8.8 <dfn>Page load processing model for inline
  content that doesn't have a DOM</dfn><a href=#read-ua-inline class=self-link></a></h4>

  <p>When the user agent is to display a user agent page inline in a <a href=#browsing-context id=read-ua-inline:browsing-context>browsing context</a>,
  the user agent should create a <code id=read-ua-inline:document><a href=#document>Document</a></code> object, mark it as being an <a href=https://dom.spec.whatwg.org/#html-document id=read-ua-inline:html-documents data-x-internal=html-documents>HTML document</a>, set its <a href=https://dom.spec.whatwg.org/#concept-document-content-type id=read-ua-inline:concept-document-content-type data-x-internal=concept-document-content-type>content type</a> to "<code>text/html</code>",
  <a href=#initialise-the-document-object id=read-ua-inline:initialise-the-document-object>initialize the <code>Document</code> object</a>, and then either associate that
  <code id=read-ua-inline:document-2><a href=#document>Document</a></code> with a custom rendering that is not rendered using the normal
  <code id=read-ua-inline:document-3><a href=#document>Document</a></code> rendering rules, or mutate that <code id=read-ua-inline:document-4><a href=#document>Document</a></code> until it represents
  the content the user agent wants to render.</p>

  

  <p>Once the page has been set up, the user agent must act as if it had <a href=#stop-parsing id=read-ua-inline:stop-parsing>stopped parsing</a>.</p>

  <p>Upon creation of the <code id=read-ua-inline:document-5><a href=#document>Document</a></code> object, the user agent must run the <a href=#concept-appcache-init id=read-ua-inline:concept-appcache-init>application cache selection algorithm</a> with no manifest,
  passing in the newly-created <code id=read-ua-inline:document-6><a href=#document>Document</a></code>.</p>

  <p>After creating the <code id=read-ua-inline:document-7><a href=#document>Document</a></code> object, but potentially before the page has been
  completely set up, the user agent must <a href=#update-the-session-history-with-the-new-page id=read-ua-inline:update-the-session-history-with-the-new-page>update the session history with the new
  page</a>.</p>



  <h4 id=scroll-to-fragid>7.8.9 <dfn>Navigating to a fragment</dfn><a href=#scroll-to-fragid class=self-link></a></h4>

  <p>When a user agent is supposed to navigate to a <a href=https://url.spec.whatwg.org/#concept-url-fragment id=scroll-to-fragid:concept-url-fragment data-x-internal=concept-url-fragment>fragment</a>, then the user agent must
  run the following steps:</p>

  <ol><li>

    <p>Remove all the entries in the <a href=#browsing-context id=scroll-to-fragid:browsing-context>browsing context</a>'s <a href=#session-history id=scroll-to-fragid:session-history>session history</a>
    after the <a href=#current-entry id=scroll-to-fragid:current-entry>current entry</a>. If the <a href=#current-entry id=scroll-to-fragid:current-entry-2>current entry</a> is the last entry in the
    session history, then no entries are removed.</p>

    <p class=note>This <a href=#history-notes>doesn't necessarily have to affect</a> the user
    agent's user interface.</p>

   <li><p>Remove any <a href=#concept-task id=scroll-to-fragid:concept-task>tasks</a> queued by the <a href=#history-traversal-task-source id=scroll-to-fragid:history-traversal-task-source>history traversal
   task source</a> that are associated with any <code id=scroll-to-fragid:document><a href=#document>Document</a></code> objects in the
   <a href=#top-level-browsing-context id=scroll-to-fragid:top-level-browsing-context>top-level browsing context</a>'s <a href=#document-family id=scroll-to-fragid:document-family>document family</a>.<li><p>Append a new entry at the end of the <code id=scroll-to-fragid:history-3><a href=#history-3>History</a></code> object representing the new
   resource and its <code id=scroll-to-fragid:document-2><a href=#document>Document</a></code> object, related state, and <a href=#current-entry id=scroll-to-fragid:current-entry-3>current entry</a>'s
   <a href=#scroll-restoration-mode id=scroll-to-fragid:scroll-restoration-mode>scroll restoration mode</a>. Its <a id=scroll-to-fragid:url href=https://url.spec.whatwg.org/#concept-url data-x-internal=url>URL</a> must be set to the address to which
   the user agent was <a href=#navigate id=scroll-to-fragid:navigate>navigating</a>. The title must be left
   unset.<li><p><a href=#traverse-the-history id=scroll-to-fragid:traverse-the-history>Traverse the history</a> to the new entry, with the <i>non-blocking events</i> flag
   set. This will <a href=#scroll-to-the-fragment-identifier id=scroll-to-fragid:scroll-to-the-fragment-identifier>scroll to the fragment</a> given in what is now the document's <a href=https://dom.spec.whatwg.org/#concept-document-url id="scroll-to-fragid:the-document's-address" data-x-internal="the-document's-address">URL</a>.</ol>

  <p class=note>If the scrolling fails because the relevant <a href=https://dom.spec.whatwg.org/#concept-id id=scroll-to-fragid:concept-id data-x-internal=concept-id>ID</a> has
  not yet been parsed, then the original <a href=#navigate id=scroll-to-fragid:navigate-2>navigation</a> algorithm will
  take care of the scrolling instead, as the last few steps of its <a href=#update-the-session-history-with-the-new-page id=scroll-to-fragid:update-the-session-history-with-the-new-page>update the session history
  with the new page</a> algorithm.</p>

  <hr>

  <p>When the user agent is required to <dfn id=scroll-to-the-fragment-identifier>scroll to the fragment</dfn> and <a href=#the-indicated-part-of-the-document id=scroll-to-fragid:the-indicated-part-of-the-document>the indicated part
  of the document</a>, if any, is <a href=#being-rendered id=scroll-to-fragid:being-rendered>being rendered</a>, the user agent must either change
  the scrolling position of the document using the following algorithm, or perform some other action
  such that <a href=#the-indicated-part-of-the-document id=scroll-to-fragid:the-indicated-part-of-the-document-2>the indicated part of the document</a> is brought to the user's attention. If
  there is no indicated part, or if the indicated part is not <a href=#being-rendered id=scroll-to-fragid:being-rendered-2>being rendered</a>, then the
  user agent must do nothing. The aforementioned algorithm is as follows:</p>

  <ol><li><p>If there is no <a href=#the-indicated-part-of-the-document id=scroll-to-fragid:the-indicated-part-of-the-document-3>indicated part of the
   document</a>, set the <code id=scroll-to-fragid:document-3><a href=#document>Document</a></code>'s <a href=#target-element id=scroll-to-fragid:target-element>target element</a> to null.<li>
    <p>If the <a href=#the-indicated-part-of-the-document id=scroll-to-fragid:the-indicated-part-of-the-document-4>indicated part of the
    document</a> is the top of the document, then:</p>

    <ol><li><p>Set the <code id=scroll-to-fragid:document-4><a href=#document>Document</a></code>'s <a href=#target-element id=scroll-to-fragid:target-element-2>target element</a> to null.<li><p><a id=scroll-to-fragid:scroll-to-the-beginning-of-the-document href=https://drafts.csswg.org/cssom-view/#scroll-to-the-beginning-of-the-document data-x-internal=scroll-to-the-beginning-of-the-document>Scroll to the beginning of the document</a> for the <code id=scroll-to-fragid:document-5><a href=#document>Document</a></code>. <a href=#refsCSSOMVIEW>[CSSOMVIEW]</a></ol>
   <li>
    <p>Otherwise:</p>

    <ol><li><p>Let <var>target</var> be element that is <a href=#the-indicated-part-of-the-document id=scroll-to-fragid:the-indicated-part-of-the-document-5>the indicated part of the
     document</a>.<li><p>Set the <code id=scroll-to-fragid:document-6><a href=#document>Document</a></code>'s <a href=#target-element id=scroll-to-fragid:target-element-3>target element</a> to
     <var>target</var>.<li><p>Use the <a id=scroll-to-fragid:scroll-an-element-into-view href=https://drafts.csswg.org/cssom-view/#scroll-an-element-into-view data-x-internal=scroll-an-element-into-view>scroll an element into view</a> algorithm to scroll <var>target</var>
     into view, with the <var>align to top flag</var> set. <a href=#refsCSSOMVIEW>[CSSOMVIEW]</a><li><p>Run the <a href=#focusing-steps id=scroll-to-fragid:focusing-steps>focusing steps</a> for <var>target</var>, with the
     <code id=scroll-to-fragid:document-7><a href=#document>Document</a></code>'s <a id=scroll-to-fragid:viewport href=https://drafts.csswg.org/css2/visuren.html#viewport data-x-internal=viewport>viewport</a> as the <i>fallback target</i>.<li><p>Move the <a href=#sequential-focus-navigation-starting-point id=scroll-to-fragid:sequential-focus-navigation-starting-point>sequential focus navigation starting point</a> to
     <var>target</var>.</p>
    </ol>
   </ol>

  <p><dfn id=the-indicated-part-of-the-document>The indicated part of the document</dfn> is the one that the <a href=https://url.spec.whatwg.org/#concept-url-fragment id=scroll-to-fragid:concept-url-fragment-2 data-x-internal=concept-url-fragment>fragment</a>, if any, identifies. The semantics of the <a href=https://url.spec.whatwg.org/#concept-url-fragment id=scroll-to-fragid:concept-url-fragment-3 data-x-internal=concept-url-fragment>fragment</a> in terms of mapping it to a node is defined by the
  specification that defines the <a id=scroll-to-fragid:mime-type href=https://mimesniff.spec.whatwg.org/#mime-type data-x-internal=mime-type>MIME type</a> used by the <code id=scroll-to-fragid:document-8><a href=#document>Document</a></code> (for
  example, the processing of <a href=https://url.spec.whatwg.org/#concept-url-fragment id=scroll-to-fragid:concept-url-fragment-4 data-x-internal=concept-url-fragment>fragments</a> for <a href=https://mimesniff.spec.whatwg.org/#xml-mime-type id=scroll-to-fragid:xml-mime-type data-x-internal=xml-mime-type>XML MIME types</a> is the responsibility of RFC7303). <a href=#refsRFC7303>[RFC7303]</a></p>

  <p>There is also a <dfn id=target-element>target element</dfn> for each <code id=scroll-to-fragid:document-9><a href=#document>Document</a></code>, which is used in
  defining the <code id=scroll-to-fragid:selector-target><a href=#selector-target>:target</a></code> pseudo-class and is updated by the
  above algorithm. It is initially null.</p>

  <p>For HTML documents (and <a href=https://mimesniff.spec.whatwg.org/#html-mime-type id=scroll-to-fragid:html-mime-type data-x-internal=html-mime-type>HTML MIME types</a>), the following
  processing model must be followed to determine what <a href=#the-indicated-part-of-the-document id=scroll-to-fragid:the-indicated-part-of-the-document-6>the indicated part of the
  document</a> is.</p>

  <ol><li><p>Apply the <a id=scroll-to-fragid:url-parser href=https://url.spec.whatwg.org/#concept-url-parser data-x-internal=url-parser>URL parser</a> algorithm to the <a id=scroll-to-fragid:url-2 href=https://url.spec.whatwg.org/#concept-url data-x-internal=url>URL</a>, and let <var>fragid</var> be the <a href=https://url.spec.whatwg.org/#concept-url-fragment id=scroll-to-fragid:concept-url-fragment-5 data-x-internal=concept-url-fragment>fragment</a> component of the
   resulting <a id=scroll-to-fragid:url-record href=https://url.spec.whatwg.org/#concept-url data-x-internal=url-record>URL record</a>.<li><p>If <var>fragid</var> is the empty string, then <a href=#the-indicated-part-of-the-document id=scroll-to-fragid:the-indicated-part-of-the-document-7>the indicated part of the
   document</a> is the top of the document; stop the algorithm here.<li><p>Let <var>fragid bytes</var> be the result of <a href=https://url.spec.whatwg.org/#percent-decode id=scroll-to-fragid:percent-decode data-x-internal=percent-decode>percent-decoding</a> <var>fragid</var>.<li><p>Let <var>decoded fragid</var> be the result of running <a id=scroll-to-fragid:utf-8-decode-without-bom-or-fail href=https://encoding.spec.whatwg.org/#utf-8-decode-without-bom-or-fail data-x-internal=utf-8-decode-without-bom-or-fail>UTF-8 decode without BOM or
   fail</a> on <var>fragid bytes</var>. If <var>decoded fragid</var> is failure, jump to the step
   labeled <i>no decoded fragid</i>.<li><p>If there is an element <a href=https://dom.spec.whatwg.org/#in-a-document-tree id=scroll-to-fragid:in-a-document-tree data-x-internal=in-a-document-tree>in the document tree</a> that
   has an <a href=https://dom.spec.whatwg.org/#concept-id id=scroll-to-fragid:concept-id-2 data-x-internal=concept-id>ID</a> exactly equal to <var>decoded fragid</var>, then the
   first such element in <a id=scroll-to-fragid:tree-order href=https://dom.spec.whatwg.org/#concept-tree-order data-x-internal=tree-order>tree order</a> is <a href=#the-indicated-part-of-the-document id=scroll-to-fragid:the-indicated-part-of-the-document-8>the indicated part of the document</a>;
   stop the algorithm here.<li><p><i>No decoded fragid</i>: If there is an <code id=scroll-to-fragid:the-a-element><a href=#the-a-element>a</a></code> element <a href=https://dom.spec.whatwg.org/#in-a-document-tree id=scroll-to-fragid:in-a-document-tree-2 data-x-internal=in-a-document-tree>in the document tree</a> that has a <code id=scroll-to-fragid:attr-a-name><a href=#attr-a-name>name</a></code>
   attribute whose value is exactly equal to <var>fragid</var> (<em>not</em> <var>decoded
   fragid</var>), then the first such element in <a id=scroll-to-fragid:tree-order-2 href=https://dom.spec.whatwg.org/#concept-tree-order data-x-internal=tree-order>tree order</a> is <a href=#the-indicated-part-of-the-document id=scroll-to-fragid:the-indicated-part-of-the-document-9>the indicated part
   of the document</a>; stop the algorithm here.<li><p>If <var>fragid</var> is an <a id=scroll-to-fragid:ascii-case-insensitive href=https://infra.spec.whatwg.org/#ascii-case-insensitive data-x-internal=ascii-case-insensitive>ASCII case-insensitive</a> match for the
   string <code>top</code>, then <a href=#the-indicated-part-of-the-document id=scroll-to-fragid:the-indicated-part-of-the-document-10>the indicated part of the document</a> is the top
   of the document; stop the algorithm here.<li><p>Otherwise, there is no <a href=#the-indicated-part-of-the-document id=scroll-to-fragid:the-indicated-part-of-the-document-11>indicated part of
   the document</a>.</ol>

  <p>The <a href=#task-source id=scroll-to-fragid:task-source>task source</a> for the task mentioned in this section must be the <a href=#dom-manipulation-task-source id=scroll-to-fragid:dom-manipulation-task-source>DOM
  manipulation task source</a>.</p>

  



  <h4 id=history-traversal>7.8.10 History traversal<a href=#history-traversal class=self-link></a></h4> 

  

  <p>When a user agent is required to <dfn id=traverse-the-history>traverse the history</dfn> to a <a href=#session-history-entry id=history-traversal:session-history-entry>session history
  entry</a> <var>entry</var>, optionally with <a href=#replacement-enabled id=history-traversal:replacement-enabled>replacement enabled</a>, and optionally
  with the <i>non-blocking events</i> flag set, the user agent must act as follows.</p>

  <p class=note>This algorithm is not just invoked when <a href=#traverse-the-history-by-a-delta id=history-traversal:traverse-the-history-by-a-delta>explicitly going back or forwards in the session history</a> — it is also invoked
  in other situations, for example when <a href=#navigate id=history-traversal:navigate>navigating a browsing context</a>,
  as part of <a href=#update-the-session-history-with-the-new-page id=history-traversal:update-the-session-history-with-the-new-page>updating the session history
  with the new page</a>.</p>

  <ol><li>

    <p>If <var>entry</var> no longer holds a <code id=history-traversal:document><a href=#document>Document</a></code> object, then
    <a href=#navigate id=history-traversal:navigate-2>navigate</a> the <a href=#browsing-context id=history-traversal:browsing-context>browsing
    context</a> to <var>entry</var>'s <a id=history-traversal:url href=https://url.spec.whatwg.org/#concept-url data-x-internal=url>URL</a> to perform an <a href=#entry-update id=history-traversal:entry-update>entry update</a> of
    <var>entry</var>, and abort these steps. The "<a href=#navigate id=history-traversal:navigate-3>navigate</a>" algorithm reinvokes this
    "traverse" algorithm to complete the traversal, at which point there <em>is</em> a
    <code id=history-traversal:document-2><a href=#document>Document</a></code> object and so this step gets skipped. The navigation must be done using
    the same <a href=#source-browsing-context id=history-traversal:source-browsing-context>source browsing context</a> as was used the first time <var>entry</var> was
    created. (This can never happen with <a href=#replacement-enabled id=history-traversal:replacement-enabled-2>replacement enabled</a>.)</p>

    <p class=note>If the resource was obtained using a non-idempotent action, for example a POST
    form submission, or if the resource is no longer available, for example because the computer is
    now offline and the page wasn't cached, navigating to it again might not be possible. In this
    case, the navigation will result in a different page than previously; for example, it might be
    an error message explaining the problem or offering to resubmit the form.</p>

   <li><p>If the <a href=#current-entry id=history-traversal:current-entry>current entry</a>'s title was not set by the <code id=history-traversal:dom-history-pushstate><a href=#dom-history-pushstate>pushState()</a></code> or <code id=history-traversal:dom-history-replacestate><a href=#dom-history-replacestate>replaceState()</a></code> methods, then set its title to the value
   returned by the <code id=history-traversal:document.title><a href=#document.title>document.title</a></code> IDL attribute.<li><p>If appropriate, update the <a href=#current-entry id=history-traversal:current-entry-2>current entry</a> in the <a href=#browsing-context id=history-traversal:browsing-context-2>browsing
   context</a>'s <code id=history-traversal:document-3><a href=#document>Document</a></code> object's <code id=history-traversal:history-3><a href=#history-3>History</a></code> object to reflect any state
   that the user agent wishes to persist. The entry is then said to be <a href=#an-entry-with-persisted-user-state id=history-traversal:an-entry-with-persisted-user-state>an entry with persisted
   user state</a>.<li><p>If <var>entry</var> has a different <code id=history-traversal:document-4><a href=#document>Document</a></code> object than the <a href=#current-entry id=history-traversal:current-entry-3>current
   entry</a>, then run the following substeps:</p>

    <ol><li><p>Remove any <a href=#concept-task id=history-traversal:concept-task>tasks</a> queued by the <a href=#history-traversal-task-source id=history-traversal:history-traversal-task-source>history traversal
     task source</a> that are associated with any <code id=history-traversal:document-5><a href=#document>Document</a></code> objects in the
     <a href=#top-level-browsing-context id=history-traversal:top-level-browsing-context>top-level browsing context</a>'s <a href=#document-family id=history-traversal:document-family>document family</a>.<li>

      <p>If the <a href=#concept-origin id=history-traversal:concept-origin>origin</a> of <var>entry</var>'s <code id=history-traversal:document-6><a href=#document>Document</a></code> object is not the
      <a href=#same-origin id=history-traversal:same-origin>same</a> as the <a href=#concept-origin id=history-traversal:concept-origin-2>origin</a> of the <a href=#current-entry id=history-traversal:current-entry-4>current
      entry</a>'s <code id=history-traversal:document-7><a href=#document>Document</a></code> object, then run the following subsubsteps:</p>

      <ol><li><p>The current <a href=#browsing-context-name id=history-traversal:browsing-context-name>browsing context name</a> must be stored with all the entries in
       the history that are associated with <code id=history-traversal:document-8><a href=#document>Document</a></code> objects with the <a href=#same-origin id=history-traversal:same-origin-2>same
       origin</a> as the <a href=#active-document id=history-traversal:active-document>active document</a> <em>and</em> that are contiguous with the
       <a href=#current-entry id=history-traversal:current-entry-5>current entry</a>.<li id=resetBCName><p>If the browsing context is a <a href=#top-level-browsing-context id=history-traversal:top-level-browsing-context-2>top-level browsing context</a>,
       but not an <a href=#auxiliary-browsing-context id=history-traversal:auxiliary-browsing-context>auxiliary browsing context</a>, then set the browsing context's <a href=#browsing-context-name id=history-traversal:browsing-context-name-2>name</a> to the empty string.</ol>

     <li id=appcache-history-2><p>Make <var>entry</var>'s <code id=history-traversal:document-9><a href=#document>Document</a></code> object the
     <a href=#active-document id=history-traversal:active-document-2>active document</a> of the <a href=#browsing-context id=history-traversal:browsing-context-3>browsing context</a>.<li>

      <p>If <var>entry</var> has a <a href=#browsing-context-name id=history-traversal:browsing-context-name-3>browsing context name</a>, then run the following
      subsubsteps:</p>

      <ol><li><p>Set the browsing context's <a href=#browsing-context-name id=history-traversal:browsing-context-name-4>browsing context name</a> to <var>entry</var>'s
       <a href=#browsing-context-name id=history-traversal:browsing-context-name-5>browsing context name</a>.<li><p>Clear any <a href=#browsing-context-name id=history-traversal:browsing-context-name-6>browsing context names</a> of all
       entries in the history that are associated with <code id=history-traversal:document-10><a href=#document>Document</a></code> objects with the
       <a href=#same-origin id=history-traversal:same-origin-3>same origin</a> as the new <a href=#active-document id=history-traversal:active-document-3>active document</a> and that are contiguous with
       <var>entry</var>.</ol>

     <li id=history-autocomplete><p>If <var>entry</var>'s <code id=history-traversal:document-11><a href=#document>Document</a></code> object has any
     form controls whose <a href=#autofill-field-name id=history-traversal:autofill-field-name>autofill field name</a> is "<code id=history-traversal:attr-fe-autocomplete-off><a href=#attr-fe-autocomplete-off>off</a></code>", invoke the <a href=#concept-form-reset-control id=history-traversal:concept-form-reset-control>reset algorithm</a> of each of those elements.<li>

      <p>If the <a href=#current-document-readiness id=history-traversal:current-document-readiness>current document readiness</a> of <var>entry</var>'s <code id=history-traversal:document-12><a href=#document>Document</a></code>
      object is "<code>complete</code>", then <a href=#queue-a-task id=history-traversal:queue-a-task>queue a task</a> to run the
      following subsubsteps:</p>

      <ol><li><p>If the <code id=history-traversal:document-13><a href=#document>Document</a></code>'s <a href=#page-showing id=history-traversal:page-showing>page showing</a> flag is true, then abort this
       task (i.e. don't fire the event below).<li><p>Set the <code id=history-traversal:document-14><a href=#document>Document</a></code>'s <a href=#page-showing id=history-traversal:page-showing-2>page showing</a> flag to true.<li>

        <p>Run any <dfn id=session-history-document-visibility-change-steps>session history document visibility change steps</dfn> for <code id=history-traversal:document-15><a href=#document>Document</a></code> that
        are defined by <a href=#other-applicable-specifications id=history-traversal:other-applicable-specifications>other applicable specifications</a>.</p>

        <p class=note>This is specifically intended for use by the Page Visibility specification. <a href=#refsPAGEVIS>[PAGEVIS]</a></p>

       <li><p><a href=https://dom.spec.whatwg.org/#concept-event-fire id=history-traversal:concept-event-fire data-x-internal=concept-event-fire>Fire an event</a> named <code id=history-traversal:event-pageshow><a href=#event-pageshow>pageshow</a></code> at the <code id=history-traversal:document-16><a href=#document>Document</a></code> object's
       <code id=history-traversal:window><a href=#window>Window</a></code> object, using <code id=history-traversal:pagetransitionevent><a href=#pagetransitionevent>PageTransitionEvent</a></code>, with the <code id=history-traversal:dom-pagetransitionevent-persisted><a href=#dom-pagetransitionevent-persisted>persisted</a></code> attribute initialized to true,
       and <var>legacy target override flag</var> set.</ol>

      

     </ol>

   <li><p>Set the document's <a href=https://dom.spec.whatwg.org/#concept-document-url id="history-traversal:the-document's-address" data-x-internal="the-document's-address">URL</a> to <var>entry</var>'s
   <a id=history-traversal:url-2 href=https://url.spec.whatwg.org/#concept-url data-x-internal=url>URL</a>.<li><p>If <var>entry</var> has a <a id=history-traversal:url-3 href=https://url.spec.whatwg.org/#concept-url data-x-internal=url>URL</a> whose <a href=https://url.spec.whatwg.org/#concept-url-fragment id=history-traversal:concept-url-fragment data-x-internal=concept-url-fragment>fragment</a> differs from that of the
   <a href=#current-entry id=history-traversal:current-entry-6>current entry</a>'s when compared in a <a href=#case-sensitive id=history-traversal:case-sensitive>case-sensitive</a> manner, and the two
   share the same <code id=history-traversal:document-17><a href=#document>Document</a></code> object, then let <var>hash changed</var> be true, and let
   <var>old URL</var> be the <a href=#current-entry id=history-traversal:current-entry-7>current entry</a>'s <a id=history-traversal:url-4 href=https://url.spec.whatwg.org/#concept-url data-x-internal=url>URL</a> and <var>new URL</var> be
   <var>entry</var>'s <a id=history-traversal:url-5 href=https://url.spec.whatwg.org/#concept-url data-x-internal=url>URL</a>. Otherwise, let <var>hash changed</var> be false.<li><p>If the traversal was initiated with <dfn id=replacement-enabled data-export="">replacement enabled</dfn>, remove
   the entry immediately before the <var>specified entry</var> in the session history.<li><p>If <var>entry</var> is not <a href=#an-entry-with-persisted-user-state id=history-traversal:an-entry-with-persisted-user-state-2>an entry with persisted user state</a>, but its
   <a id=history-traversal:url-6 href=https://url.spec.whatwg.org/#concept-url data-x-internal=url>URL</a>'s <a href=https://url.spec.whatwg.org/#concept-url-fragment id=history-traversal:concept-url-fragment-2 data-x-internal=concept-url-fragment>fragment</a> is non-null, then
   <a href=#scroll-to-the-fragment-identifier id=history-traversal:scroll-to-the-fragment-identifier>scroll to the fragment</a>.<li><p>Set the <a href=#current-entry id=history-traversal:current-entry-8>current entry</a> to <var>entry</var>.<li><p>Let <var>targetRealm</var> be the <a id=history-traversal:current-realm-record href=https://tc39.github.io/ecma262/#current-realm data-x-internal=current-realm-record>current Realm Record</a>.<li><p>If <var>entry</var> has a <a href=#state-object id=history-traversal:state-object>state object</a>, then let <var>state</var> be
   <a href=#structuredclone id=history-traversal:structuredclone>StructuredClone</a>(<var>entry</var>'s <a href=#state-object id=history-traversal:state-object-2>state object</a>,
   <var>targetRealm</var>). Otherwise, let <var>state</var> be null.<li><p>Set <code id=history-traversal:dom-history-state><a href=#dom-history-state>history.state</a></code> to <var>state</var>.<li><p>Let <var>state changed</var> be true if <var>entry</var>'s <code id=history-traversal:document-18><a href=#document>Document</a></code> object
   has a <a href=#latest-entry id=history-traversal:latest-entry>latest entry</a>, and that entry is not <var>entry</var>; otherwise let it be
   false.</p>

   <li><p>Set <var>entry</var>'s <code id=history-traversal:document-19><a href=#document>Document</a></code> object's <a href=#latest-entry id=history-traversal:latest-entry-2>latest entry</a> to
   <var>entry</var>.<li>

    <p>If the <i>non-blocking events</i> flag is not set, then run the following substeps
    <a href=#immediately id=history-traversal:immediately>immediately</a>. Otherwise, the <i>non-blocking events</i> flag is set; <a href=#queue-a-task id=history-traversal:queue-a-task-2>queue a
    task</a> to run the following substeps instead.</p>

    <ol><li><p>If <var>state changed</var> is true, then <a href=https://dom.spec.whatwg.org/#concept-event-fire id=history-traversal:concept-event-fire-2 data-x-internal=concept-event-fire>fire an
     event</a> named <code id=history-traversal:event-popstate><a href=#event-popstate>popstate</a></code> at the <code id=history-traversal:document-20><a href=#document>Document</a></code>
     object's <code id=history-traversal:window-2><a href=#window>Window</a></code> object, using <code id=history-traversal:popstateevent><a href=#popstateevent>PopStateEvent</a></code>, with the <code id=history-traversal:dom-event-bubbles><a data-x-internal=dom-event-bubbles href=https://dom.spec.whatwg.org/#dom-event-bubbles>bubbles</a></code> attribute initialized to true and the <code id=history-traversal:dom-popstateevent-state><a href=#dom-popstateevent-state>state</a></code> attribute initialized <var>state</var>.<li><p>If <var>entry</var> is <a href=#an-entry-with-persisted-user-state id=history-traversal:an-entry-with-persisted-user-state-3>an entry with persisted user state</a>, then the user
     agent may <a href=#restore-persisted-user-state id=history-traversal:restore-persisted-user-state>restore persisted user state</a> and update aspects of the document and its
     rendering.<li><p>If <var>hash changed</var> is true, then <a href=https://dom.spec.whatwg.org/#concept-event-fire id=history-traversal:concept-event-fire-3 data-x-internal=concept-event-fire>fire an
     event</a> named <code id=history-traversal:event-hashchange><a href=#event-hashchange>hashchange</a></code> at the <a href=#browsing-context id=history-traversal:browsing-context-4>browsing
     context</a>'s <code id=history-traversal:window-3><a href=#window>Window</a></code> object, using <code id=history-traversal:hashchangeevent><a href=#hashchangeevent>HashChangeEvent</a></code>, with the <code id=history-traversal:dom-event-bubbles-2><a data-x-internal=dom-event-bubbles href=https://dom.spec.whatwg.org/#dom-event-bubbles>bubbles</a></code> attribute initialized to true, the <code id=history-traversal:dom-hashchangeevent-oldurl><a href=#dom-hashchangeevent-oldurl>oldURL</a></code> attribute initialized to <var>old URL</var>,
     and the <code id=history-traversal:dom-hashchangeevent-newurl><a href=#dom-hashchangeevent-newurl>newURL</a></code> attribute initialized to
     <var>new URL</var>.</ol>

   </ol>

  <p>The <a href=#task-source id=history-traversal:task-source>task source</a> for the tasks mentioned above is the <a href=#dom-manipulation-task-source id=history-traversal:dom-manipulation-task-source>DOM manipulation task
  source</a>.</p>

  

  <h5 id=persisted-user-state-restoration>7.8.10.1 Persisted user state restoration<a href=#persisted-user-state-restoration class=self-link></a></h5>
  

  <p>When the user agent is to <dfn id=restore-persisted-user-state>restore persisted user state</dfn> from a history entry, it must
  run the following steps immediately:</p>

  <ol><li><p>If the entry has a <a href=#scroll-restoration-mode id=persisted-user-state-restoration:scroll-restoration-mode>scroll restoration mode</a>, let <var>scrollRestoration</var>
   be that. Otherwise let <var>scrollRestoration</var> be "<code id=persisted-user-state-restoration:dom-scrollrestoration-auto><a href=#dom-scrollrestoration-auto>auto</a></code>"<li><p>If <var>scrollRestoration</var> is "<code id=persisted-user-state-restoration:dom-scrollrestoration-manual><a href=#dom-scrollrestoration-manual>manual</a></code>" the user agent should not restore the scroll
   position for the <code id=persisted-user-state-restoration:document><a href=#document>Document</a></code> or any of its scrollable regions, with the exception of
   any nested browsing contexts whose scroll restoration is controlled by their own history entry's
   <a href=#scroll-restoration-mode id=persisted-user-state-restoration:scroll-restoration-mode-2>scroll restoration mode</a>, otherwise, it may do so.<li><p>Optionally, update other aspects of the document and its rendering, for instance values of
   form fields, that the user agent had previously recorded.</ol>
  

  
  <p class=note>This can even include updating the <code id=persisted-user-state-restoration:the-dir-attribute><a href=#the-dir-attribute>dir</a></code> attribute
  of <code id=persisted-user-state-restoration:the-textarea-element><a href=#the-textarea-element>textarea</a></code> elements or <code id=persisted-user-state-restoration:the-input-element><a href=#the-input-element>input</a></code> elements whose <code id=persisted-user-state-restoration:attr-input-type><a href=#attr-input-type>type</a></code> attribute is in either the <a href="#text-(type=text)-state-and-search-state-(type=search)" id="persisted-user-state-restoration:text-(type=text)-state-and-search-state-(type=search)">Text</a> state or the <a href="#text-(type=text)-state-and-search-state-(type=search)" id="persisted-user-state-restoration:text-(type=text)-state-and-search-state-(type=search)-2">Search</a> state, if the persisted state includes the
  directionality of user input in such controls.</p>

  <p class=note>Not restoring the scroll position by user agent does not imply that the scroll
  position will be left at any particular value (e.g., (0,0)). The actual scroll position depends on
  the navigation type and the user agent's particular caching strategy. So web applications should
  not assume any particular scroll position but rather should set it to what they want it to be.</p>

  <h5 id=the-popstateevent-interface>7.8.10.2 The <code id=the-popstateevent-interface:popstateevent><a href=#popstateevent>PopStateEvent</a></code> interface<a href=#the-popstateevent-interface class=self-link></a></h5>

  <pre class=idl>[Constructor(DOMString type, optional <a href=#popstateeventinit id=the-popstateevent-interface:popstateeventinit>PopStateEventInit</a> eventInitDict)]
interface <dfn id=popstateevent>PopStateEvent</dfn> : <a id=the-popstateevent-interface:event href=https://dom.spec.whatwg.org/#interface-event data-x-internal=event>Event</a> {
  readonly attribute any <a href=#dom-popstateevent-state id=the-popstateevent-interface:dom-popstateevent-state>state</a>;
};

dictionary <dfn id=popstateeventinit>PopStateEventInit</dfn> : <a id=the-popstateevent-interface:eventinit href=https://dom.spec.whatwg.org/#dictdef-eventinit data-x-internal=eventinit>EventInit</a> {
  any state = null;
};</pre>

  <dl class=domintro><dt><var>event</var> . <code id=the-popstateevent-interface:dom-popstateevent-state-2><a href=#dom-popstateevent-state>state</a></code><dd>

    <p>Returns a copy of the information that was provided to <code id=the-popstateevent-interface:dom-history-pushstate><a href=#dom-history-pushstate>pushState()</a></code> or <code id=the-popstateevent-interface:dom-history-replacestate><a href=#dom-history-replacestate>replaceState()</a></code>.</p>

   </dl>

  

  <p>The <dfn id=dom-popstateevent-state><code>state</code></dfn> attribute must return the
  value it was initialized to. It represents the context information for the event, or null, if the
  state represented is the initial state of the <code id=the-popstateevent-interface:document><a href=#document>Document</a></code>.</p>

  


  <h5 id=the-hashchangeevent-interface>7.8.10.3 The <code id=the-hashchangeevent-interface:hashchangeevent><a href=#hashchangeevent>HashChangeEvent</a></code> interface<a href=#the-hashchangeevent-interface class=self-link></a></h5><div class=status><input onclick=toggleStatus(this) value=⋰ type=button><p class=support><strong>Support:</strong> hashchange<span class="and_chr yes"><span>Chrome for Android</span> <span>55+</span></span><span class="chrome yes"><span>Chrome</span> <span>5+</span></span><span class="ios_saf yes"><span>iOS Safari</span> <span>4.0+</span></span><span class="and_uc yes"><span>UC Browser for Android</span> <span>11+</span></span><span class="firefox yes"><span>Firefox</span> <span>3.6+</span></span><span class="ie yes"><span>IE</span> <span>8+</span></span><span class="samsung yes"><span>Samsung Internet</span> <span>4+</span></span><span class="op_mini no"><span>Opera Mini</span> <span>None</span></span><span class="android yes"><span>Android Browser</span> <span>2.2+</span></span><span class="safari yes"><span>Safari</span> <span>5+</span></span><span class="edge yes"><span>Edge</span> <span>12+</span></span><span class="opera yes"><span>Opera</span> <span>10.6+</span></span><p class=caniuse>Source: <a href="http://caniuse.com/#feat=hashchange">caniuse.com</a></div>

  <pre class=idl>[Constructor(DOMString type, optional <a href=#hashchangeeventinit id=the-hashchangeevent-interface:hashchangeeventinit>HashChangeEventInit</a> eventInitDict)]
interface <dfn id=hashchangeevent>HashChangeEvent</dfn> : <a id=the-hashchangeevent-interface:event href=https://dom.spec.whatwg.org/#interface-event data-x-internal=event>Event</a> {
  readonly attribute USVString <a href=#dom-hashchangeevent-oldurl id=the-hashchangeevent-interface:dom-hashchangeevent-oldurl>oldURL</a>;
  readonly attribute USVString <a href=#dom-hashchangeevent-newurl id=the-hashchangeevent-interface:dom-hashchangeevent-newurl>newURL</a>;
};

dictionary <dfn id=hashchangeeventinit>HashChangeEventInit</dfn> : <a id=the-hashchangeevent-interface:eventinit href=https://dom.spec.whatwg.org/#dictdef-eventinit data-x-internal=eventinit>EventInit</a> {
  USVString oldURL = "";
  USVString newURL = "";
};</pre>

  <dl class=domintro><dt><var>event</var> . <code id=the-hashchangeevent-interface:dom-hashchangeevent-oldurl-2><a href=#dom-hashchangeevent-oldurl>oldURL</a></code><dd>

    <p>Returns the <a id=the-hashchangeevent-interface:url href=https://url.spec.whatwg.org/#concept-url data-x-internal=url>URL</a> of the <a href=#session-history-entry id=the-hashchangeevent-interface:session-history-entry>session history entry</a> that was previously
    current.</p>

   <dt><var>event</var> . <code id=the-hashchangeevent-interface:dom-hashchangeevent-newurl-2><a href=#dom-hashchangeevent-newurl>newURL</a></code><dd>

    <p>Returns the <a id=the-hashchangeevent-interface:url-2 href=https://url.spec.whatwg.org/#concept-url data-x-internal=url>URL</a> of the <a href=#session-history-entry id=the-hashchangeevent-interface:session-history-entry-2>session history entry</a> that is now
    current.</p>

   </dl>

  

  <p>The <dfn id=dom-hashchangeevent-oldurl><code>oldURL</code></dfn> attribute must return
  the value it was initialized to. It represents context information for the event, specifically the
  URL of the <a href=#session-history-entry id=the-hashchangeevent-interface:session-history-entry-3>session history entry</a> that was traversed from.</p>

  <p>The <dfn id=dom-hashchangeevent-newurl><code>newURL</code></dfn> attribute must return
  the value it was initialized to. It represents context information for the event, specifically the
  URL of the <a href=#session-history-entry id=the-hashchangeevent-interface:session-history-entry-4>session history entry</a> that was traversed to.</p>

  


  <h5 id=the-pagetransitionevent-interface>7.8.10.4 The <code id=the-pagetransitionevent-interface:pagetransitionevent><a href=#pagetransitionevent>PageTransitionEvent</a></code> interface<a href=#the-pagetransitionevent-interface class=self-link></a></h5>

  <pre class=idl>[Constructor(DOMString type, optional <a href=#pagetransitioneventinit id=the-pagetransitionevent-interface:pagetransitioneventinit>PageTransitionEventInit</a> eventInitDict)]
interface <dfn id=pagetransitionevent>PageTransitionEvent</dfn> : <a id=the-pagetransitionevent-interface:event href=https://dom.spec.whatwg.org/#interface-event data-x-internal=event>Event</a> {
  readonly attribute boolean <a href=#dom-pagetransitionevent-persisted id=the-pagetransitionevent-interface:dom-pagetransitionevent-persisted>persisted</a>;
};

dictionary <dfn id=pagetransitioneventinit>PageTransitionEventInit</dfn> : <a id=the-pagetransitionevent-interface:eventinit href=https://dom.spec.whatwg.org/#dictdef-eventinit data-x-internal=eventinit>EventInit</a> {
  boolean persisted = false;
};</pre>

  <dl class=domintro><dt><var>event</var> . <code id=the-pagetransitionevent-interface:dom-pagetransitionevent-persisted-2><a href=#dom-pagetransitionevent-persisted>persisted</a></code><dd>

    <p>For the <code id=the-pagetransitionevent-interface:event-pageshow><a href=#event-pageshow>pageshow</a></code> event, returns false if the page is
    newly being loaded (and the <code id=the-pagetransitionevent-interface:event-load><a href=#event-load>load</a></code> event will fire). Otherwise,
    returns true.</p>

    <p>For the <code id=the-pagetransitionevent-interface:event-pagehide><a href=#event-pagehide>pagehide</a></code> event, returns false if the page is
    going away for the last time. Otherwise, returns true, meaning that (if nothing conspires to
    make the page unsalvageable) the page might be reused if the user navigates back to this
    page.</p>

    <p>Things that can cause the page to be unsalvageable include:</p>

    <ul class=brief><li><code id=the-pagetransitionevent-interface:dom-document-open><a href=#dom-document-open>document.open()</a></code>
     <li>Listening for <code id=the-pagetransitionevent-interface:event-beforeunload><a href=#event-beforeunload>beforeunload</a></code> events
     <li>Listening for <code id=the-pagetransitionevent-interface:event-unload><a href=#event-unload>unload</a></code> events
     <li>Having <code id=the-pagetransitionevent-interface:the-iframe-element><a href=#the-iframe-element>iframe</a></code>s that are not salvageable
     <li>Active <code id=the-pagetransitionevent-interface:websocket><a href=#websocket>WebSocket</a></code> objects
     <li><a href=#abort-a-document id=the-pagetransitionevent-interface:abort-a-document>Aborting a <code>Document</code></a>
    </ul>

   </dl>

  

  <p>The <dfn id=dom-pagetransitionevent-persisted><code>persisted</code></dfn> attribute must
  return the value it was initialized to. It represents the context information for the event.</p>

  



  <h4 id=unloading-documents>7.8.11 Unloading documents<a href=#unloading-documents class=self-link></a></h4>

  

  <p>A <code id=unloading-documents:document><a href=#document>Document</a></code> has a <dfn id=concept-document-salvageable><i>salvageable</i></dfn> state, which must initially be
  true, a <dfn id=fired-unload>fired unload</dfn> flag, which must initially be false, and a <dfn id=page-showing>page showing</dfn>
  flag, which must initially be false. The <a href=#page-showing id=unloading-documents:page-showing>page showing</a> flag is used to ensure that
  scripts receive <code id=unloading-documents:event-pageshow><a href=#event-pageshow>pageshow</a></code> and <code id=unloading-documents:event-pagehide><a href=#event-pagehide>pagehide</a></code> events in a consistent manner (e.g. that they never
  receive two <code id=unloading-documents:event-pagehide-2><a href=#event-pagehide>pagehide</a></code> events in a row without an intervening
  <code id=unloading-documents:event-pageshow-2><a href=#event-pageshow>pageshow</a></code>, or vice versa).</p>

  <p><a href=#event-loop id=unloading-documents:event-loop>Event loops</a> have a <dfn id=termination-nesting-level>termination nesting level</dfn>
  counter, which must initially be zero.</p>

  <p>When a user agent is to <dfn id=prompt-to-unload-a-document>prompt to unload a document</dfn>, it must run the following
  steps.</p>

  <ol><li><p>Increase the <a href=#event-loop id=unloading-documents:event-loop-2>event loop</a>'s <a href=#termination-nesting-level id=unloading-documents:termination-nesting-level>termination nesting level</a> by
   one.<li><p>Increase the <code id=unloading-documents:document-2><a href=#document>Document</a></code>'s <a href=#ignore-opens-during-unload-counter id=unloading-documents:ignore-opens-during-unload-counter>ignore-opens-during-unload counter</a> by
   one.<li><p>Let <var>event</var> be the result of <a id=unloading-documents:creating-an-event href=https://dom.spec.whatwg.org/#concept-event-create data-x-internal=creating-an-event>creating an event</a> using
   <code id=unloading-documents:beforeunloadevent><a href=#beforeunloadevent>BeforeUnloadEvent</a></code>.<li><p>Initialize <var>event</var>'s <code id=unloading-documents:dom-event-type><a data-x-internal=dom-event-type href=https://dom.spec.whatwg.org/#dom-event-type>type</a></code> attribute to <code id=unloading-documents:event-beforeunload><a href=#event-beforeunload>beforeunload</a></code> and its <code id=unloading-documents:dom-event-cancelable><a data-x-internal=dom-event-cancelable href=https://dom.spec.whatwg.org/#dom-event-cancelable>cancelable</a></code> attribute true.<li><p><i>Dispatch</i>: <a href=https://dom.spec.whatwg.org/#concept-event-dispatch id=unloading-documents:concept-event-dispatch data-x-internal=concept-event-dispatch>Dispatch</a> <var>event</var> at
   the <code id=unloading-documents:document-3><a href=#document>Document</a></code>'s <code id=unloading-documents:window><a href=#window>Window</a></code> object.<li><p>Decrease the <a href=#event-loop id=unloading-documents:event-loop-3>event loop</a>'s <a href=#termination-nesting-level id=unloading-documents:termination-nesting-level-2>termination nesting level</a> by
   one.<li><p>If any event listeners were triggered by the earlier <i>dispatch</i> step, then set the
   <code id=unloading-documents:document-4><a href=#document>Document</a></code>'s <i id=unloading-documents:concept-document-salvageable><a href=#concept-document-salvageable>salvageable</a></i> state to
   false.<li>

    <p>If the <code id=unloading-documents:document-5><a href=#document>Document</a></code>'s <a href=#active-sandboxing-flag-set id=unloading-documents:active-sandboxing-flag-set>active sandboxing flag set</a> does not have its
    <a href=#sandboxed-modals-flag id=unloading-documents:sandboxed-modals-flag>sandboxed modals flag</a> set, and the <code id=unloading-documents:dom-beforeunloadevent-returnvalue><a href=#dom-beforeunloadevent-returnvalue>returnValue</a></code> attribute of the <var>event</var>
    object is not the empty string, or if the event was canceled, then the user agent may ask the
    user to confirm that they wish to unload the document.</p>

    <p class=note>The message shown to the user is not customizable, but instead determined by
    the user agent. In particular, the actual value of the <code id=unloading-documents:dom-beforeunloadevent-returnvalue-2><a href=#dom-beforeunloadevent-returnvalue>returnValue</a></code> attribute is ignored.</p>

    <p>The user agent is encouraged to avoid asking the user for confirmation if it judges that
    doing so would be annoying, deceptive, or pointless. A simple heuristic might be that if the
    user has not interacted with the document, the user agent would not ask for confirmation before
    unloading it.</p>

    <p>If the user agent asks the user for confirmation, it must <a href=#pause id=unloading-documents:pause>pause</a> while waiting
    for the user's response.</p>

    <p>If the user did not confirm the page navigation, then the user agent <dfn id=refused-to-allow-the-document-to-be-unloaded>refused to allow
    the document to be unloaded</dfn>.</p>

   <li><p>If this algorithm was invoked by another instance of the "prompt to unload a document"
   algorithm (i.e. through the steps below that invoke this algorithm for all descendant browsing
   contexts), then jump to the step labeled <i>end</i>.<li><p>Let <var>descendants</var> be the <a href=#list-of-the-descendant-browsing-contexts id=unloading-documents:list-of-the-descendant-browsing-contexts>list of the descendant browsing
   contexts</a> of the <code id=unloading-documents:document-6><a href=#document>Document</a></code>.<li>

    <p>If <var>descendants</var> is not an empty list, then for each <a href=#browsing-context id=unloading-documents:browsing-context>browsing
    context</a> <var>b</var> in <var>descendants</var> run the following
    substeps:</p>

    <ol><li><p><a href=#prompt-to-unload-a-document id=unloading-documents:prompt-to-unload-a-document>Prompt to unload</a> the <a href=#active-document id=unloading-documents:active-document>active
     document</a> of the <a href=#browsing-context id=unloading-documents:browsing-context-2>browsing context</a> <var>b</var>. If the user
     <a href=#refused-to-allow-the-document-to-be-unloaded id=unloading-documents:refused-to-allow-the-document-to-be-unloaded>refused to allow the document to be unloaded</a>, then the user implicitly also <a href=#refused-to-allow-the-document-to-be-unloaded id=unloading-documents:refused-to-allow-the-document-to-be-unloaded-2>refused to allow <em>this</em> document to
     be unloaded</a>; jump to the step labeled <i>end</i>.</p>

     <li><p>If the <i id=unloading-documents:concept-document-salvageable-2><a href=#concept-document-salvageable>salvageable</a></i> state of the <a href=#active-document id=unloading-documents:active-document-2>active
     document</a> of the <a href=#browsing-context id=unloading-documents:browsing-context-3>browsing context</a> <var>b</var> is false, then set
     the <i id=unloading-documents:concept-document-salvageable-3><a href=#concept-document-salvageable>salvageable</a></i> state of <em>this</em> document to
     false also.</ol>

   <li><p><i>End</i>: Decrease the <code id=unloading-documents:document-7><a href=#document>Document</a></code>'s <a href=#ignore-opens-during-unload-counter id=unloading-documents:ignore-opens-during-unload-counter-2>ignore-opens-during-unload
   counter</a> by one.</ol>

  <p>When a user agent is to <dfn id=unload-a-document data-export="">unload a document</dfn>, it must run the following
  steps. These steps are passed an argument, <var>recycle</var>, which is either true or false,
  indicating whether the <code id=unloading-documents:document-8><a href=#document>Document</a></code> object is going to be re-used. (This is set by the
  <code id=unloading-documents:dom-document-open><a href=#dom-document-open>document.open()</a></code> method.)</p>

  <ol><li><p>Increase the <a href=#event-loop id=unloading-documents:event-loop-4>event loop</a>'s <a href=#termination-nesting-level id=unloading-documents:termination-nesting-level-3>termination nesting level</a> by
   one.<li><p>Increase the <code id=unloading-documents:document-9><a href=#document>Document</a></code>'s <a href=#ignore-opens-during-unload-counter id=unloading-documents:ignore-opens-during-unload-counter-3>ignore-opens-during-unload counter</a> by
   one.<li><p>If the <code id=unloading-documents:document-10><a href=#document>Document</a></code>'s <a href=#page-showing id=unloading-documents:page-showing-2>page showing</a> flag is false, then jump to the
   step labeled <i>unload event</i> below (i.e. skip firing the <code id=unloading-documents:event-pagehide-3><a href=#event-pagehide>pagehide</a></code> event and don't rerun the <a href=#unloading-document-visibility-change-steps id=unloading-documents:unloading-document-visibility-change-steps>unloading document
   visibility change steps</a>).<li><p>Set the <code id=unloading-documents:document-11><a href=#document>Document</a></code>'s <a href=#page-showing id=unloading-documents:page-showing-3>page showing</a> flag to false.<li><p><a href=https://dom.spec.whatwg.org/#concept-event-fire id=unloading-documents:concept-event-fire data-x-internal=concept-event-fire>Fire an event</a> named <code id=unloading-documents:event-pagehide-4><a href=#event-pagehide>pagehide</a></code> at the <code id=unloading-documents:document-12><a href=#document>Document</a></code> object's <code id=unloading-documents:window-2><a href=#window>Window</a></code>
   object, using <code id=unloading-documents:pagetransitionevent><a href=#pagetransitionevent>PageTransitionEvent</a></code>, with the <code id=unloading-documents:dom-pagetransitionevent-persisted><a href=#dom-pagetransitionevent-persisted>persisted</a></code> attribute initialized to true if the
   <code id=unloading-documents:document-13><a href=#document>Document</a></code> object's <i id=unloading-documents:concept-document-salvageable-4><a href=#concept-document-salvageable>salvageable</a></i> state is
   true, and false otherwise, and <var>legacy target override flag</var> set.<li>

    <p>Run any <dfn id=unloading-document-visibility-change-steps>unloading document visibility change steps</dfn> for <code id=unloading-documents:document-14><a href=#document>Document</a></code> that
    are defined by <a href=#other-applicable-specifications id=unloading-documents:other-applicable-specifications>other applicable specifications</a>.</p>

    <p class=note>This is specifically intended for use by the Page Visibility specification. <a href=#refsPAGEVIS>[PAGEVIS]</a></p>

   <li><p><i>Unload event</i>: If the <code id=unloading-documents:document-15><a href=#document>Document</a></code>'s <a href=#fired-unload id=unloading-documents:fired-unload>fired unload</a> flag is
   false, then <a href=https://dom.spec.whatwg.org/#concept-event-fire id=unloading-documents:concept-event-fire-2 data-x-internal=concept-event-fire>fire an event</a> named <code id=unloading-documents:event-unload><a href=#event-unload>unload</a></code> at the <code id=unloading-documents:document-16><a href=#document>Document</a></code>'s object <code id=unloading-documents:window-3><a href=#window>Window</a></code>
   object, with <var>legacy target override flag</var> set.<li><p>Decrease the <a href=#event-loop id=unloading-documents:event-loop-5>event loop</a>'s <a href=#termination-nesting-level id=unloading-documents:termination-nesting-level-4>termination nesting level</a> by
   one.<li><p>If any event listeners were triggered by the earlier <i>unload event</i> step, then set
   the <code id=unloading-documents:document-17><a href=#document>Document</a></code> object's <i id=unloading-documents:concept-document-salvageable-5><a href=#concept-document-salvageable>salvageable</a></i> state
   to false and set the <code id=unloading-documents:document-18><a href=#document>Document</a></code>'s <a href=#fired-unload id=unloading-documents:fired-unload-2>fired unload</a> flag to true.<li><p>Run any <a href=#unloading-document-cleanup-steps id=unloading-documents:unloading-document-cleanup-steps>unloading document cleanup steps</a> for <code id=unloading-documents:document-19><a href=#document>Document</a></code> that are
   defined by this specification and <a href=#other-applicable-specifications id=unloading-documents:other-applicable-specifications-2>other applicable specifications</a>.<li><p>If this algorithm was invoked by another instance of the "unload a document" algorithm
   (i.e. by the steps below that invoke this algorithm for all descendant browsing contexts), then
   jump to the step labeled <i>end</i>.<li><p>Let <var>descendants</var> be the <a href=#list-of-the-descendant-browsing-contexts id=unloading-documents:list-of-the-descendant-browsing-contexts-2>list of the descendant browsing
   contexts</a> of the <code id=unloading-documents:document-20><a href=#document>Document</a></code>.<li>

    <p>If <var>descendants</var> is not an empty list, then for each <a href=#browsing-context id=unloading-documents:browsing-context-4>browsing
    context</a> <var>b</var> in <var>descendants</var> run the following
    substeps:</p>

    <ol><li><p><a href=#unload-a-document id=unloading-documents:unload-a-document>Unload</a> the <a href=#active-document id=unloading-documents:active-document-3>active document</a> of the
     <a href=#browsing-context id=unloading-documents:browsing-context-5>browsing context</a> <var>b</var> with the <var>recycle</var>
     parameter set to false.<li><p>If the <i id=unloading-documents:concept-document-salvageable-6><a href=#concept-document-salvageable>salvageable</a></i> state of the <a href=#active-document id=unloading-documents:active-document-4>active
     document</a> of the <a href=#browsing-context id=unloading-documents:browsing-context-6>browsing context</a> <var>b</var> is false, then set
     the <i id=unloading-documents:concept-document-salvageable-7><a href=#concept-document-salvageable>salvageable</a></i> state of <em>this</em> document to
     false also.</ol>

   <li><p>If both the <code id=unloading-documents:document-21><a href=#document>Document</a></code>'s <i id=unloading-documents:concept-document-salvageable-8><a href=#concept-document-salvageable>salvageable</a></i> state and <var>recycle</var> are
   false, then the <code id=unloading-documents:document-22><a href=#document>Document</a></code>'s <a href=#concept-document-bc id=unloading-documents:concept-document-bc>browsing
   context</a> must <a href=#discard-a-document id=unloading-documents:discard-a-document>discard the
   <code>Document</code></a>.<li><p><i>End</i>: Decrease the <code id=unloading-documents:document-23><a href=#document>Document</a></code>'s <a href=#ignore-opens-during-unload-counter id=unloading-documents:ignore-opens-during-unload-counter-4>ignore-opens-during-unload
   counter</a> by one.</ol>

  <p>This specification defines the following <dfn id=unloading-document-cleanup-steps data-export="">unloading document cleanup
  steps</dfn>. Other specifications can define more.</p>

  <ol><li><p>Let <var>window</var> be the <code id=unloading-documents:document-24><a href=#document>Document</a></code>'s <code id=unloading-documents:window-4><a href=#window>Window</a></code> object.<li>

    <p>For each <code id=unloading-documents:websocket><a href=#websocket>WebSocket</a></code> object <var>webSocket</var> whose <a href=#concept-relevant-global id=unloading-documents:concept-relevant-global>relevant global object</a> is equal to <var>window</var>,
    <a href=#make-disappear id=unloading-documents:make-disappear>make disappear</a> <var>webSocket</var>.</p>

    <p>If this affected any <code id=unloading-documents:websocket-2><a href=#websocket>WebSocket</a></code> objects, then set the <code id=unloading-documents:document-25><a href=#document>Document</a></code>'s <i id=unloading-documents:concept-document-salvageable-9><a href=#concept-document-salvageable>salvageable</a></i> state to false.</p>

   <li>

    <p>If the <code id=unloading-documents:document-26><a href=#document>Document</a></code>'s <i id=unloading-documents:concept-document-salvageable-10><a href=#concept-document-salvageable>salvageable</a></i>
    state is false, run the following substeps:</p>

    <ol><li><p>For each <code id=unloading-documents:eventsource><a href=#eventsource>EventSource</a></code> object <var>eventSource</var> whose <a href=#concept-relevant-global id=unloading-documents:concept-relevant-global-2>relevant global object</a> is equal to <var>window</var>,
     <a href=#concept-eventsource-forcibly-close id=unloading-documents:concept-eventsource-forcibly-close>forcibly close</a>
     <var>eventSource</var>.<li><p>Empty <var>window</var>'s <a href=#list-of-active-timers id=unloading-documents:list-of-active-timers>list of active timers</a>.</ol>

   </ol>

  



  <h5 id=the-beforeunloadevent-interface>7.8.11.1 The <code id=the-beforeunloadevent-interface:beforeunloadevent><a href=#beforeunloadevent>BeforeUnloadEvent</a></code> interface<a href=#the-beforeunloadevent-interface class=self-link></a></h5>

  <pre class=idl>interface <dfn id=beforeunloadevent>BeforeUnloadEvent</dfn> : <a id=the-beforeunloadevent-interface:event href=https://dom.spec.whatwg.org/#interface-event data-x-internal=event>Event</a> {
  attribute DOMString <a href=#dom-beforeunloadevent-returnvalue id=the-beforeunloadevent-interface:dom-beforeunloadevent-returnvalue>returnValue</a>;
};</pre>

  <p class=note>There are no <code id=the-beforeunloadevent-interface:beforeunloadevent-2><a href=#beforeunloadevent>BeforeUnloadEvent</a></code>-specific initialization methods.</p>

  <p>The <code id=the-beforeunloadevent-interface:beforeunloadevent-3><a href=#beforeunloadevent>BeforeUnloadEvent</a></code> interface is a legacy interface which allows <a href=#prompt-to-unload-a-document id=the-beforeunloadevent-interface:prompt-to-unload-a-document>prompting to unload the document</a> to be controlled
  not only by canceling the event, but by setting the <code id=the-beforeunloadevent-interface:dom-beforeunloadevent-returnvalue-2><a href=#dom-beforeunloadevent-returnvalue>returnValue</a></code> attribute to a value besides the
  empty string. Authors should use the <code id=the-beforeunloadevent-interface:dom-event-preventdefault><a data-x-internal=dom-event-preventdefault href=https://dom.spec.whatwg.org/#dom-event-preventdefault>preventDefault()</a></code> method, or other means of canceling
  events, instead of using <code id=the-beforeunloadevent-interface:dom-beforeunloadevent-returnvalue-3><a href=#dom-beforeunloadevent-returnvalue>returnValue</a></code>.</p>

  

  <p>The <dfn id=dom-beforeunloadevent-returnvalue><code>returnValue</code></dfn> attribute
  controls the process of <a href=#prompt-to-unload-a-document id=the-beforeunloadevent-interface:prompt-to-unload-a-document-2>prompting to unload the
  document</a>. When the event is created, the attribute must be set to
  the empty string. On getting, it must return the last value it was set to. On setting, the
  attribute must be set to the new value.</p>

  <p class=note>This attribute is a <code>DOMString</code> only for historical reasons.
  Any value besides the empty string will be treated as a request to ask the user for
  confirmation.</p>

  


  

  <h4 id=aborting-a-document-load>7.8.12 Aborting a document load<a href=#aborting-a-document-load class=self-link></a></h4>

  <p>If a <code id=aborting-a-document-load:document><a href=#document>Document</a></code> is <dfn id=abort-a-document>aborted</dfn>, the user agent must
  run the following steps:</p>

  <ol><li><p><a href=#abort-a-document id=aborting-a-document-load:abort-a-document>Abort</a> the <a href=#active-document id=aborting-a-document-load:active-document>active
   documents</a> of every <a href=#child-browsing-context id=aborting-a-document-load:child-browsing-context>child browsing context</a>. If this results in any of those
   <code id=aborting-a-document-load:document-2><a href=#document>Document</a></code> objects having their <i id=aborting-a-document-load:concept-document-salvageable><a href=#concept-document-salvageable>salvageable</a></i> state set to false, then set this
   <code id=aborting-a-document-load:document-3><a href=#document>Document</a></code>'s <i id=aborting-a-document-load:concept-document-salvageable-2><a href=#concept-document-salvageable>salvageable</a></i> state to false
   also.<li><p>Cancel any instances of the <a href=https://fetch.spec.whatwg.org/#concept-fetch id=aborting-a-document-load:concept-fetch data-x-internal=concept-fetch>fetch</a> algorithm in the
   context of this <code id=aborting-a-document-load:document-4><a href=#document>Document</a></code>, discarding any <a href=#concept-task id=aborting-a-document-load:concept-task>tasks</a>
   <a href=#queue-a-task id=aborting-a-document-load:queue-a-task>queued</a> for them, and discarding any further data received from
   the network for them. If this resulted in any instances of the <a href=https://fetch.spec.whatwg.org/#concept-fetch id=aborting-a-document-load:concept-fetch-2 data-x-internal=concept-fetch>fetch</a> algorithm being canceled or any <a href=#queue-a-task id=aborting-a-document-load:queue-a-task-2>queued</a> <a href=#concept-task id=aborting-a-document-load:concept-task-2>tasks</a> or any network data getting
   discarded, then set the <code id=aborting-a-document-load:document-5><a href=#document>Document</a></code>'s <i id=aborting-a-document-load:concept-document-salvageable-3><a href=#concept-document-salvageable>salvageable</a></i> state to false.<li><p>If the <code id=aborting-a-document-load:document-6><a href=#document>Document</a></code> has an <a href=#active-parser id=aborting-a-document-load:active-parser>active parser</a>, then <a href=#abort-a-parser id=aborting-a-document-load:abort-a-parser>abort that parser</a> and set the <code id=aborting-a-document-load:document-7><a href=#document>Document</a></code>'s <i id=aborting-a-document-load:concept-document-salvageable-4><a href=#concept-document-salvageable>salvageable</a></i> state to false.</ol>

  <p>User agents may allow users to explicitly invoke the <a href=#abort-a-document id=aborting-a-document-load:abort-a-document-2>abort a
  document</a> algorithm for a <code id=aborting-a-document-load:document-8><a href=#document>Document</a></code>. If the user does so, then, if that
  <code id=aborting-a-document-load:document-9><a href=#document>Document</a></code> is an <a href=#active-document id=aborting-a-document-load:active-document-2>active document</a>, the user agent should <a href=#queue-a-task id=aborting-a-document-load:queue-a-task-3>queue a
  task</a> to <a href=https://dom.spec.whatwg.org/#concept-event-fire id=aborting-a-document-load:concept-event-fire data-x-internal=concept-event-fire>fire an event</a> named <code id=aborting-a-document-load:event-abort><a href=#event-abort>abort</a></code> at that <code id=aborting-a-document-load:document-10><a href=#document>Document</a></code>'s <code id=aborting-a-document-load:window><a href=#window>Window</a></code> object
  before invoking the <a href=#abort-a-document id=aborting-a-document-load:abort-a-document-3>abort</a> algorithm.</p>

  

  



  <h3 id=offline>7.9 Offline Web applications<a href=#offline class=self-link></a></h3><div class=status><input onclick=toggleStatus(this) value=⋰ type=button><p class=support><strong>Support:</strong> offline-apps<span class="and_chr yes"><span>Chrome for Android</span> <span>55+</span></span><span class="chrome yes"><span>Chrome</span> <span>4+</span></span><span class="ios_saf yes"><span>iOS Safari</span> <span>3.2+</span></span><span class="and_uc yes"><span>UC Browser for Android</span> <span>11+</span></span><span class="firefox yes"><span>Firefox</span> <span>3.5+</span></span><span class="ie yes"><span>IE</span> <span>10+</span></span><span class="samsung yes"><span>Samsung Internet</span> <span>4+</span></span><span class="op_mini no"><span>Opera Mini</span> <span>None</span></span><span class="android yes"><span>Android Browser</span> <span>2.1+</span></span><span class="safari yes"><span>Safari</span> <span>4+</span></span><span class="edge yes"><span>Edge</span> <span>12+</span></span><span class="opera yes"><span>Opera</span> <span>10.6+</span></span><p class=caniuse>Source: <a href="http://caniuse.com/#feat=offline-apps">caniuse.com</a></div> 

  <p class=critical>This feature is in the process of being removed from the Web platform. (This
  is a long process that takes many years.) Using any of the offline Web application features at
  this time is highly discouraged. Use service workers instead. <a href=#refsSW>[SW]</a></p>

  

  <h4 id=introduction-10>7.9.1 Introduction<a href=#introduction-10 class=self-link></a></h4>

  <p><i>This section is non-normative.</i></p>

  <p>In order to enable users to continue interacting with Web applications and documents even when
  their network connection is unavailable — for instance, because they are traveling outside
  of their ISP's coverage area — authors can provide a manifest which lists the files that are
  needed for the Web application to work offline and which causes the user's browser to keep a copy
  of the files for use offline.</p>

  <p>To illustrate this, consider a simple clock applet consisting of an HTML page "<code>clock1.html</code>", a CSS style sheet "<code>clock.css</code>", and a
  JavaScript script "<code>clock.js</code>".</p>

  <p>Before adding the manifest, these three files might look like this:</p>

  <pre>&lt;!-- clock1.html -->
&lt;!DOCTYPE HTML>
&lt;html>
 &lt;head>
  &lt;meta charset="utf-8">
  &lt;title>Clock&lt;/title>
  &lt;script src="clock.js">&lt;/script>
  &lt;link rel="stylesheet" href="clock.css">
 &lt;/head>
 &lt;body>
  &lt;p>The time is: &lt;output id="clock">&lt;/output>&lt;/p>
 &lt;/body>
&lt;/html>
</pre>
  <pre>/* clock.css */
output { font: 2em sans-serif; }
</pre>
  <pre>/* clock.js */
setInterval(function () {
    document.getElementById('clock').value = new Date();
}, 1000);
</pre>

  <p>If the user tries to open the "<code>clock1.html</code>" page while offline, though,
  the user agent (unless it happens to have it still in the local cache) will fail with an
  error.</p>

  <p>The author can instead provide a manifest of the three files, say "<code>clock.appcache</code>":</p>

  <pre>CACHE MANIFEST
clock2.html
clock.css
clock.js
</pre>

  <p>With a small change to the HTML file, the manifest (served as <code id=introduction-10:text/cache-manifest><a href=#text/cache-manifest>text/cache-manifest</a></code>)
  is linked to the application:</p>

  <pre>&lt;!-- clock2.html -->
&lt;!DOCTYPE HTML>
&lt;html manifest="clock.appcache">
 &lt;head>
  &lt;meta charset="utf-8">
  &lt;title>Clock&lt;/title>
  &lt;script src="clock.js">&lt;/script>
  &lt;link rel="stylesheet" href="clock.css">
 &lt;/head>
 &lt;body>
  &lt;p>The time is: &lt;output id="clock">&lt;/output>&lt;/p>
 &lt;/body>
&lt;/html>
</pre>

  <p>Now, if the user goes to the page, the browser will cache the files and make them available
  even when the user is offline.</p>

  <p class=note>Authors are encouraged to include the main page in the manifest also, but in
  practice the page that referenced the manifest is automatically cached even if it isn't explicitly
  mentioned.</p>

  <p class=note>With the exception of "no-store" directive, HTTP cache headers and restrictions on
  caching pages served over TLS (encrypted, using <code id=introduction-10:https-protocol><a data-x-internal=https-protocol href=https://tools.ietf.org/html/rfc7230#section-2.7.2>https:</a></code>) are
  overridden by manifests. Thus, pages will not expire from an application cache before the user
  agent has updated it, and even applications served over TLS can be made to work offline.</p>

  <p><a href=/demos/offline/clock/clock2.html>View this example online</a>.</p>



  <h5 id=supporting-offline-caching-for-legacy-applications>7.9.1.1 Supporting offline caching for legacy applications<a href=#supporting-offline-caching-for-legacy-applications class=self-link></a></h5>

  <p><i>This section is non-normative.</i></p>

  <p>The application cache feature works best if the application logic is separate from the
  application and user data, with the logic (markup, scripts, style sheets, images, etc) listed in
  the manifest and stored in the application cache, with a finite number of static HTML pages for
  the application, and with the application and user data stored in Web Storage or a client-side
  Indexed Database, updated dynamically using Web Sockets, <code id=supporting-offline-caching-for-legacy-applications:xmlhttprequest><a data-x-internal=xmlhttprequest href=https://xhr.spec.whatwg.org/#xmlhttprequest>XMLHttpRequest</a></code>, server-sent
  events, or some other similar mechanism.</p>

  <p>This model results in a fast experience for the user: the application immediately loads, and
  fresh data is obtained as fast as the network will allow it (possibly while stale data shows).</p>

  <p>Legacy applications, however, tend to be designed so that the user data and the logic are mixed
  together in the HTML, with each operation resulting in a new HTML page from the server.</p>

  <div class=example>

   <p>For example, consider a news application. The typical architecture of such an application,
   when not using the application cache feature, is that the user fetches the main page, and the
   server returns a dynamically-generated page with the current headlines and the user interface
   logic mixed together.</p>

   <p>A news application designed for the application cache feature, however, would instead have the
   main page just consist of the logic, and would then have the main page fetch the data separately
   from the server, e.g. using <code id=supporting-offline-caching-for-legacy-applications:xmlhttprequest-2><a data-x-internal=xmlhttprequest href=https://xhr.spec.whatwg.org/#xmlhttprequest>XMLHttpRequest</a></code>.</p>

  </div>

  <p>The mixed-content model does not work well with the application cache feature: since the
  content is cached, it would result in the user always seeing the stale data from the previous time
  the cache was updated.</p>

  <p>While there is no way to make the legacy model work as fast as the separated model, it
  <em>can</em> at least be retrofitted for offline use using the <a href=#concept-appcache-mode-prefer-online id=supporting-offline-caching-for-legacy-applications:concept-appcache-mode-prefer-online>prefer-online</a> <a href=#concept-appcache-mode id=supporting-offline-caching-for-legacy-applications:concept-appcache-mode>application cache mode</a>. To do so, list all the static
  resources used by the HTML page you want to have work offline in an <a href=#concept-appcache-manifest id=supporting-offline-caching-for-legacy-applications:concept-appcache-manifest>application cache manifest</a>, use the <code id=supporting-offline-caching-for-legacy-applications:attr-html-manifest><a href=#attr-html-manifest>manifest</a></code> attribute to select that manifest from the HTML file,
  and then add the following line at the bottom of the manifest:</p>

  <pre>SETTINGS:
prefer-online
NETWORK:
*</pre>

  <p>This causes the <a href=#application-cache id=supporting-offline-caching-for-legacy-applications:application-cache>application cache</a> to only be used for <a href=#concept-appcache-master id=supporting-offline-caching-for-legacy-applications:concept-appcache-master>master entries</a> when the user is offline, and causes the
  application cache to be used as an atomic HTTP cache (essentially pinning resources listed in the
  manifest), while allowing all resources not listed in the manifest to be accessed normally when
  the user is online.</p>



  <h5 id=appcacheevents>7.9.1.2 Event summary<a href=#appcacheevents class=self-link></a></h5>

  <p><i>This section is non-normative.</i></p>

  <p>When the user visits a page that declares a manifest, the browser will try to update the cache.
  It does this by fetching a copy of the manifest and, if the manifest has changed since the user
  agent last saw it, redownloading all the resources it mentions and caching them anew.</p>

  <p>As this is going on, a number of events get fired on the <code id=appcacheevents:applicationcache><a href=#applicationcache>ApplicationCache</a></code> object
  to keep the script updated as to the state of the cache update, so that the user can be notified
  appropriately. The events are as follows:</p>

  <table><thead><tr><th> Event name
     <th> Interface
     <th> Fired when...
     <th> Next events
   <tbody><tr><td> <dfn id=event-appcache-checking><code>checking</code></dfn>
     <td> <code id=appcacheevents:event><a data-x-internal=event href=https://dom.spec.whatwg.org/#interface-event>Event</a></code>
     <td> The user agent is checking for an update, or attempting to download the manifest for the
          first time. <strong>This is always the first event in the sequence.</strong>
     <td> <code id=appcacheevents:event-appcache-noupdate><a href=#event-appcache-noupdate>noupdate</a></code>, <code id=appcacheevents:event-appcache-downloading><a href=#event-appcache-downloading>downloading</a></code>, <code id=appcacheevents:event-appcache-obsolete><a href=#event-appcache-obsolete>obsolete</a></code>, <code id=appcacheevents:event-appcache-error><a href=#event-appcache-error>error</a></code>

    <tr><td> <dfn id=event-appcache-noupdate><code>noupdate</code></dfn>
     <td> <code id=appcacheevents:event-2><a data-x-internal=event href=https://dom.spec.whatwg.org/#interface-event>Event</a></code>
     <td> The manifest hadn't changed.
     <td> Last event in sequence.

    <tr><td> <dfn id=event-appcache-downloading><code>downloading</code></dfn>
     <td> <code id=appcacheevents:event-3><a data-x-internal=event href=https://dom.spec.whatwg.org/#interface-event>Event</a></code>
     <td> The user agent has found an update and is fetching it, or is downloading the resources
          listed by the manifest for the first time.
     <td> <code id=appcacheevents:event-appcache-progress><a href=#event-appcache-progress>progress</a></code>, <code id=appcacheevents:event-appcache-error-2><a href=#event-appcache-error>error</a></code>, <code id=appcacheevents:event-appcache-cached><a href=#event-appcache-cached>cached</a></code>, <code id=appcacheevents:event-appcache-updateready><a href=#event-appcache-updateready>updateready</a></code>

    <tr><td> <dfn id=event-appcache-progress><code>progress</code></dfn>
     <td> <code id=appcacheevents:progressevent><a data-x-internal=progressevent href=https://xhr.spec.whatwg.org/#interface-progressevent>ProgressEvent</a></code>
     <td> The user agent is downloading resources listed by the manifest.
          The event object's <code id=appcacheevents:dom-progressevent-total><a data-x-internal=dom-progressevent-total href=https://xhr.spec.whatwg.org/#dom-progressevent-total>total</a></code> attribute returns the total number of files to be downloaded.
          The event object's <code id=appcacheevents:dom-progressevent-loaded><a data-x-internal=dom-progressevent-loaded href=https://xhr.spec.whatwg.org/#dom-progressevent-loaded>loaded</a></code> attribute returns the number of files processed so far.
     <td> <code id=appcacheevents:event-appcache-progress-2><a href=#event-appcache-progress>progress</a></code>, <code id=appcacheevents:event-appcache-error-3><a href=#event-appcache-error>error</a></code>, <code id=appcacheevents:event-appcache-cached-2><a href=#event-appcache-cached>cached</a></code>, <code id=appcacheevents:event-appcache-updateready-2><a href=#event-appcache-updateready>updateready</a></code>

    <tr><td> <dfn id=event-appcache-cached><code>cached</code></dfn>
     <td> <code id=appcacheevents:event-4><a data-x-internal=event href=https://dom.spec.whatwg.org/#interface-event>Event</a></code>
     <td> The resources listed in the manifest have been downloaded, and the application is now cached.
     <td> Last event in sequence.

    <tr><td> <dfn id=event-appcache-updateready><code>updateready</code></dfn>
     <td> <code id=appcacheevents:event-5><a data-x-internal=event href=https://dom.spec.whatwg.org/#interface-event>Event</a></code>
     <td> The resources listed in the manifest have been newly redownloaded, and the script can use
          <code id=appcacheevents:dom-appcache-swapcache><a href=#dom-appcache-swapcache>swapCache()</a></code> to switch to the new cache.
     <td> Last event in sequence.

    <tr><td> <dfn id=event-appcache-obsolete><code>obsolete</code></dfn>
     <td> <code id=appcacheevents:event-6><a data-x-internal=event href=https://dom.spec.whatwg.org/#interface-event>Event</a></code>
     <td> The manifest was found to have become a 404 or 410 page, so the application cache is being deleted.
     <td> Last event in sequence.

    <tr><td rowspan=4> <dfn id=event-appcache-error><code>error</code></dfn>
     <td rowspan=4> <code id=appcacheevents:event-7><a data-x-internal=event href=https://dom.spec.whatwg.org/#interface-event>Event</a></code>
     <td> The manifest was a 404 or 410 page, so the attempt to cache the application has been aborted.
     <td rowspan=3> Last event in sequence.

    <tr><td> The manifest hadn't changed, but the page referencing the manifest failed to download properly.

    <tr><td> A fatal error occurred while fetching the resources listed in the manifest.

    <tr><td> The manifest changed while the update was being run.
     <td> The user agent will try fetching the files again momentarily.

  </table>

  <p>These events are cancelable; their default action is for the user agent to show download
  progress information. If the page shows its own update UI, canceling the events will prevent the
  user agent from showing redundant progress information.</p>



  

  <h4 id=appcache>7.9.2 Application caches<a href=#appcache class=self-link></a></h4> 

  <p>An <dfn id=application-cache data-export="">application cache</dfn> is a set of cached resources consisting of:</p>

  <ul><li>

    <p>One or more resources (including their out-of-band metadata, such as HTTP headers, if any),
    identified by URLs, each falling into one (or more) of the following categories:</p>

    <dl><dt><dfn id=concept-appcache-master>Master entries</dfn>

     <dd><p class=note>These are documents that were added to the cache because a <a href=#browsing-context id=appcache:browsing-context>browsing
     context</a> was <a href=#navigate id=appcache:navigate>navigated</a> to that document and the document
     indicated that this was its cache, using the <code id=appcache:attr-html-manifest><a href=#attr-html-manifest>manifest</a></code>
     attribute.</p>


     <dt><dfn id=concept-appcache-manifest>The manifest</dfn>

     <dd><p class=note>This is the resource corresponding to the URL that was given in a master
     entry's <code id=appcache:the-html-element><a href=#the-html-element>html</a></code> element's <code id=appcache:attr-html-manifest-2><a href=#attr-html-manifest>manifest</a></code> attribute.
     The manifest is fetched and processed during the <a href=#application-cache-download-process id=appcache:application-cache-download-process>application cache download
