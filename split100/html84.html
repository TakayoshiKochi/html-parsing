
      <tr><td>ku
       <td>Kurdish
       <td><a id=determining-the-character-encoding:windows-1254 href=https://encoding.spec.whatwg.org/#windows-1254 data-x-internal=windows-1254>windows-1254</a> 

      
      
      <tr><td>ky
       <td>Kyrgyz
       <td><a id=determining-the-character-encoding:windows-1251-5 href=https://encoding.spec.whatwg.org/#windows-1251 data-x-internal=windows-1251>windows-1251</a> 

      

      <tr><td>lt
       <td>Lithuanian
       <td><a id=determining-the-character-encoding:windows-1257-2 href=https://encoding.spec.whatwg.org/#windows-1257 data-x-internal=windows-1257>windows-1257</a> 

      <tr><td>lv
       <td>Latvian
       <td><a id=determining-the-character-encoding:windows-1257-3 href=https://encoding.spec.whatwg.org/#windows-1257 data-x-internal=windows-1257>windows-1257</a> 

      
      
      <tr><td>mk
       <td>Macedonian
       <td><a id=determining-the-character-encoding:windows-1251-6 href=https://encoding.spec.whatwg.org/#windows-1251 data-x-internal=windows-1251>windows-1251</a> 

      

      

      

      

      

      

      

      

      

      

      

      <tr><td>pl
       <td>Polish
       <td><a id=determining-the-character-encoding:iso-8859-2-2 href=https://encoding.spec.whatwg.org/#iso-8859-2 data-x-internal=iso-8859-2>ISO-8859-2</a> 

      

      

      

      

      

      

      

      

      

      

      <tr><td>ru
       <td>Russian
       <td><a id=determining-the-character-encoding:windows-1251-7 href=https://encoding.spec.whatwg.org/#windows-1251 data-x-internal=windows-1251>windows-1251</a> 

      

      
      
      <tr><td>sah
       <td>Yakut
       <td><a id=determining-the-character-encoding:windows-1251-8 href=https://encoding.spec.whatwg.org/#windows-1251 data-x-internal=windows-1251>windows-1251</a> 

      

      

      

      <tr><td>sk
       <td>Slovak
       <td><a id=determining-the-character-encoding:windows-1250-3 href=https://encoding.spec.whatwg.org/#windows-1250 data-x-internal=windows-1250>windows-1250</a> 

      <tr><td>sl
       <td>Slovenian
       <td><a id=determining-the-character-encoding:iso-8859-2-3 href=https://encoding.spec.whatwg.org/#iso-8859-2 data-x-internal=iso-8859-2>ISO-8859-2</a> 

      

      

      

      

      

      

      

      

      <tr><td>sr
       <td>Serbian
       <td><a id=determining-the-character-encoding:windows-1251-9 href=https://encoding.spec.whatwg.org/#windows-1251 data-x-internal=windows-1251>windows-1251</a> 

      

      

      

      

      

      

      
      
      <tr><td>tg
       <td>Tajik
       <td><a id=determining-the-character-encoding:windows-1251-10 href=https://encoding.spec.whatwg.org/#windows-1251 data-x-internal=windows-1251>windows-1251</a> 

      <tr><td>th
       <td>Thai
       <td><a id=determining-the-character-encoding:windows-874 href=https://encoding.spec.whatwg.org/#windows-874 data-x-internal=windows-874>windows-874</a> 

      

      

      <tr><td>tr
       <td>Turkish
       <td><a id=determining-the-character-encoding:windows-1254-2 href=https://encoding.spec.whatwg.org/#windows-1254 data-x-internal=windows-1254>windows-1254</a> 

      
      
      <tr><td>tt
       <td>Tatar
       <td><a id=determining-the-character-encoding:windows-1251-11 href=https://encoding.spec.whatwg.org/#windows-1251 data-x-internal=windows-1251>windows-1251</a> 

      

      

      <tr><td>uk
       <td>Ukrainian
       <td><a id=determining-the-character-encoding:windows-1251-12 href=https://encoding.spec.whatwg.org/#windows-1251 data-x-internal=windows-1251>windows-1251</a> 

      

      

      

      <tr><td>vi
       <td>Vietnamese
       <td><a id=determining-the-character-encoding:windows-1258 href=https://encoding.spec.whatwg.org/#windows-1258 data-x-internal=windows-1258>windows-1258</a> 

      

      

      

      

      

      <tr><td>zh-CN
       <td>Chinese (People's Republic of China)
       <td><a id=determining-the-character-encoding:gb18030 href=https://encoding.spec.whatwg.org/#gb18030 data-x-internal=gb18030>gb18030</a> 

      

      

      

      

      

      <tr><td>zh-TW
       <td>Chinese (Taiwan)
       <td><a id=determining-the-character-encoding:big5 href=https://encoding.spec.whatwg.org/#big5 data-x-internal=big5>Big5</a> 

      

      <tr><td colspan=2>All other locales
       <td><a id=determining-the-character-encoding:windows-1252 href=https://encoding.spec.whatwg.org/#windows-1252 data-x-internal=windows-1252>windows-1252</a>

    </table>

    <p class=tablenote><small>The contents of this table are derived from the intersection of
    Windows, Chrome, and Firefox defaults.</small></p>

   </ol>

  <p>The <a id="determining-the-character-encoding:document's-character-encoding-3" href=https://dom.spec.whatwg.org/#concept-document-encoding data-x-internal="document's-character-encoding">document's character encoding</a> must immediately be set to the value returned
  from this algorithm, at the same time as the user agent uses the returned value to select the
  decoder to use for the input byte stream.</p>

  <hr>

  <p>When an algorithm requires a user agent to <dfn id=prescan-a-byte-stream-to-determine-its-encoding data-export="">prescan a byte stream to
  determine its encoding</dfn>, given some defined <var>end condition</var>, then it must run the
  following steps. These steps either abort unsuccessfully or return a character encoding. If at any
  point during these steps (including during instances of the <a href=#concept-get-attributes-when-sniffing id=determining-the-character-encoding:concept-get-attributes-when-sniffing>get an attribute</a> algorithm invoked by this
  one) the user agent either runs out of bytes (meaning the <var>position</var> pointer
  created in the first step below goes beyond the end of the byte stream obtained so far) or reaches
  its <var>end condition</var>, then abort the <a href=#prescan-a-byte-stream-to-determine-its-encoding id=determining-the-character-encoding:prescan-a-byte-stream-to-determine-its-encoding-2>prescan a byte stream to determine its
  encoding</a> algorithm unsuccessfully.</p>

  <ol><li>

    <p>Let <var>position</var> be a pointer to a byte in the input byte stream, initially
    pointing at the first byte.</p>

   <li>

    <p><i>Loop</i>: If <var>position</var> points to:</p>

    <dl class=switch><dt>A sequence of bytes starting with: 0x3C 0x21 0x2D 0x2D (ASCII '&lt;!--')<dd>

      <p>Advance the <var>position</var> pointer so that it points at the first 0x3E byte
      which is preceded by two 0x2D bytes (i.e. at the end of an ASCII '-->' sequence) and comes
      after the 0x3C byte that was found. (The two 0x2D bytes can be the same as those in the
      '&lt;!--' sequence.)</p>

     <dt>A sequence of bytes starting with: 0x3C, 0x4D or 0x6D, 0x45 or 0x65, 0x54 or 0x74, 0x41 or 0x61, and one of 0x09, 0x0A, 0x0C, 0x0D, 0x20, 0x2F (case-insensitive ASCII '&lt;meta' followed by a space or slash)<dd>

      <ol><li><p>Advance the <var>position</var> pointer so that it points at the next 0x09,
       0x0A, 0x0C, 0x0D, 0x20, or 0x2F byte (the one in sequence of characters matched
       above).<li><p>Let <var>attribute list</var> be an empty list of strings.<li><p>Let <var>got pragma</var> be false.<li><p>Let <var>need pragma</var> be null.<li><p>Let <var>charset</var> be the null value (which, for the purposes of this
       algorithm, is distinct from an unrecognized encoding or the empty string).<li><p><i>Attributes</i>: <a href=#concept-get-attributes-when-sniffing id=determining-the-character-encoding:concept-get-attributes-when-sniffing-2>Get an
       attribute</a> and its value. If no attribute was sniffed, then jump to the
       <i>processing</i> step below.<li><p>If the attribute's name is already in <var>attribute list</var>, then return
       to the step labeled <i>attributes</i>.</p>

       <li><p>Add the attribute's name to <var>attribute list</var>.</p>

       <li>

        <p>Run the appropriate step from the following list, if one applies:</p>

        <dl class=switch><dt>If the attribute's name is "<code>http-equiv</code>"<dd><p>If the attribute's value is "<code>content-type</code>", then set <var>got pragma</var> to true.<dt>If the attribute's name is "<code>content</code>"<dd><p>Apply the <a href=#algorithm-for-extracting-a-character-encoding-from-a-meta-element id=determining-the-character-encoding:algorithm-for-extracting-a-character-encoding-from-a-meta-element>algorithm for extracting a character encoding from a
         <code>meta</code> element</a>, giving the attribute's value as the string to parse. If a
         character encoding is returned, and if <var>charset</var> is still set to null,
         let <var>charset</var> be the encoding returned, and set <var>need
         pragma</var> to true.<dt>If the attribute's name is "<code>charset</code>"<dd><p>Let <var>charset</var> be the result of <a id=determining-the-character-encoding:getting-an-encoding href=https://encoding.spec.whatwg.org/#concept-encoding-get data-x-internal=getting-an-encoding>getting an encoding</a>
         from the attribute's value, and set <var>need pragma</var> to false.</dl>

       <li><p>Return to the step labeled <i>attributes</i>.<li><p><i>Processing</i>: If <var>need pragma</var> is null, then jump to the step
       below labeled <i>next byte</i>.<li><p>If <var>need pragma</var> is true but <var>got pragma</var> is
       false, then jump to the step below labeled <i>next byte</i>.<li><p>If <var>charset</var> is failure, then jump to the step below labeled <i>next
       byte</i>.<li><p>If <var>charset</var> is a <a href=#utf-16-encoding id=determining-the-character-encoding:utf-16-encoding>UTF-16 encoding</a>, then set <var>charset</var>
       to <a id=determining-the-character-encoding:utf-8 href=https://encoding.spec.whatwg.org/#utf-8 data-x-internal=utf-8>UTF-8</a>.

       <li><p>If <var>charset</var> is <a id=determining-the-character-encoding:x-user-defined href=https://encoding.spec.whatwg.org/#x-user-defined data-x-internal=x-user-defined>x-user-defined</a>, then set <var>charset</var> to
       <a id=determining-the-character-encoding:windows-1252-2 href=https://encoding.spec.whatwg.org/#windows-1252 data-x-internal=windows-1252>windows-1252</a>.<li><p>Abort the <a href=#prescan-a-byte-stream-to-determine-its-encoding id=determining-the-character-encoding:prescan-a-byte-stream-to-determine-its-encoding-3>prescan a byte stream to determine its encoding</a> algorithm,
       returning the encoding given by <var>charset</var>.</ol>

     <dt>A sequence of bytes starting with a 0x3C byte (ASCII &lt;), optionally a 0x2F byte (ASCII /), and finally a byte in the range 0x41-0x5A or 0x61-0x7A (an ASCII letter)<dd>

      <ol><li><p>Advance the <var>position</var> pointer so that it points at the next 0x09
       (ASCII TAB), 0x0A (ASCII LF), 0x0C (ASCII FF), 0x0D (ASCII CR), 0x20 (ASCII space), or 0x3E
       (ASCII >) byte.<li><p>Repeatedly <a href=#concept-get-attributes-when-sniffing id=determining-the-character-encoding:concept-get-attributes-when-sniffing-3>get an attribute</a>
       until no further attributes can be found, then jump to the step below labeled <i>next
       byte</i>.</ol>

     <dt>A sequence of bytes starting with: 0x3C 0x21 (ASCII '&lt;!')<dt>A sequence of bytes starting with: 0x3C 0x2F (ASCII '&lt;/')<dt>A sequence of bytes starting with: 0x3C 0x3F (ASCII '&lt;?')<dd>

      <p>Advance the <var>position</var> pointer so that it points at the first 0x3E byte
      (ASCII >) that comes after the 0x3C byte that was found.</p>

     <dt>Any other byte<dd>

      <p>Do nothing with that byte.</p>

     </dl>

   <li><i>Next byte</i>: Move <var>position</var> so it points at the next byte in the
   input byte stream, and return to the step above labeled <i>loop</i>.</ol>

  <p>When the <a href=#prescan-a-byte-stream-to-determine-its-encoding id=determining-the-character-encoding:prescan-a-byte-stream-to-determine-its-encoding-4>prescan a byte stream to determine its encoding</a> algorithm says to <dfn id=concept-get-attributes-when-sniffing>get an attribute</dfn>, it means doing this:</p>

  <ol><li><p>If the byte at <var>position</var> is one of 0x09 (ASCII TAB), 0x0A (ASCII LF),
   0x0C (ASCII FF), 0x0D (ASCII CR), 0x20 (ASCII space), or 0x2F (ASCII /) then advance <var>position</var> to the next byte and redo this step.<li><p>If the byte at <var>position</var> is 0x3E (ASCII >), then abort the <a href=#concept-get-attributes-when-sniffing id=determining-the-character-encoding:concept-get-attributes-when-sniffing-4>get an attribute</a> algorithm. There isn't
   one.<li><p>Otherwise, the byte at <var>position</var> is the start of the attribute name.
   Let <var>attribute name</var> and <var>attribute value</var> be the empty
   string.<li><p>Process the byte at <var>position</var> as follows:</p>

    <dl class=switch><dt>If it is 0x3D (ASCII =), and the <var>attribute name</var> is longer than the
     empty string<dd>Advance <var>position</var> to the next byte and jump to the step below labeled
     <i>value</i>.<dt>If it is 0x09 (ASCII TAB), 0x0A (ASCII LF), 0x0C (ASCII FF), 0x0D (ASCII CR), or 0x20
     (ASCII space)<dd>Jump to the step below labeled <i>spaces</i>.<dt>If it is 0x2F (ASCII /) or 0x3E (ASCII >)<dd>Abort the <a href=#concept-get-attributes-when-sniffing id=determining-the-character-encoding:concept-get-attributes-when-sniffing-5>get an attribute</a>
     algorithm. The attribute's name is the value of <var>attribute name</var>, its value
     is the empty string.<dt>If it is in the range 0x41 (ASCII A) to 0x5A (ASCII Z)<dd>Append the Unicode character with code point <span><var>b</var>+0x20</span> to <var>attribute name</var> (where <var>b</var>
     is the value of the byte at <var>position</var>). (This converts the input to
     lowercase.)<dt>Anything else<dd>Append the Unicode character with the same code point as the value of the byte at <var>position</var> to <var>attribute name</var>. (It doesn't actually matter how
     bytes outside the ASCII range are handled here, since only ASCII characters can contribute to
     the detection of a character encoding.)</dl>

   <li><p>Advance <var>position</var> to the next byte and return to the previous
   step.<li><p><i>Spaces</i>: If the byte at <var>position</var> is one of 0x09 (ASCII TAB),
   0x0A (ASCII LF), 0x0C (ASCII FF), 0x0D (ASCII CR), or 0x20 (ASCII space) then advance <var>position</var> to the next byte, then, repeat this step.<li><p>If the byte at <var>position</var> is <em>not</em> 0x3D (ASCII =), abort the
   <a href=#concept-get-attributes-when-sniffing id=determining-the-character-encoding:concept-get-attributes-when-sniffing-6>get an attribute</a> algorithm. The
   attribute's name is the value of <var>attribute name</var>, its value is the empty
   string.<li><p>Advance <var>position</var> past the 0x3D (ASCII =) byte.<li><p><i>Value</i>: If the byte at <var>position</var> is one of 0x09 (ASCII TAB), 0x0A
   (ASCII LF), 0x0C (ASCII FF), 0x0D (ASCII CR), or 0x20 (ASCII space) then advance <var>position</var> to the next byte, then, repeat this step.<li><p>Process the byte at <var>position</var> as follows:</p>

    <dl class=switch><dt>If it is 0x22 (ASCII ") or 0x27 (ASCII ')<dd>

      <ol><li>Let <var>b</var> be the value of the byte at <var>position</var>.<li><i>Quote loop</i>: Advance <var>position</var> to the next byte.<li>If the value of the byte at <var>position</var> is the value of <var>b</var>, then advance <var>position</var> to the next byte and abort the
       "get an attribute" algorithm. The attribute's name is the value of <var>attribute
       name</var>, and its value is the value of <var>attribute value</var>.<li>Otherwise, if the value of the byte at <var>position</var> is in the range 0x41
       (ASCII A) to 0x5A (ASCII Z), then append a Unicode character to <var>attribute
       value</var> whose code point is 0x20 more than the value of the byte at <var>position</var>.<li>Otherwise, append a Unicode character to <var>attribute value</var> whose code
       point is the same as the value of the byte at <var>position</var>.<li>Return to the step above labeled <i>quote loop</i>.</ol>

     <dt>If it is 0x3E (ASCII >)<dd>Abort the <a href=#concept-get-attributes-when-sniffing id=determining-the-character-encoding:concept-get-attributes-when-sniffing-7>get an attribute</a>
     algorithm. The attribute's name is the value of <var>attribute name</var>, its value
     is the empty string.<dt>If it is in the range 0x41 (ASCII A) to 0x5A (ASCII Z)<dd>Append the Unicode character with code point <span><var>b</var>+0x20</span> to <var>attribute value</var> (where <var>b</var> is the value of the byte at <var>position</var>). Advance <var>position</var> to the next byte.<dt>Anything else<dd>Append the Unicode character with the same code point as the value of the byte at <var>position</var> to <var>attribute value</var>. Advance <var>position</var> to the next byte.</dl>

   <li><p>Process the byte at <var>position</var> as
   follows:</p>

    <dl class=switch><dt>If it is 0x09 (ASCII TAB), 0x0A (ASCII LF), 0x0C (ASCII FF), 0x0D (ASCII CR), 0x20 (ASCII
     space), or 0x3E (ASCII >)<dd>Abort the <a href=#concept-get-attributes-when-sniffing id=determining-the-character-encoding:concept-get-attributes-when-sniffing-8>get an attribute</a>
     algorithm. The attribute's name is the value of <var>attribute name</var> and its
     value is the value of <var>attribute value</var>.<dt>If it is in the range 0x41 (ASCII A) to 0x5A (ASCII Z)<dd>Append the Unicode character with code point <span><var>b</var>+0x20</span> to <var>attribute value</var> (where <var>b</var> is the value of the byte at <var>position</var>).<dt>Anything else<dd>Append the Unicode character with the same code point as the value of the byte at <var>position</var> to <var>attribute value</var>.</dl>

   <li><p>Advance <var>position</var> to the next byte and return to the previous
   step.</ol>

  <p>For the sake of interoperability, user agents should not use a pre-scan algorithm that returns
  different results than the one described above. (But, if you do, please at least let us know, so
  that we can improve this algorithm and benefit everyone...)</p>





  <h5 id=character-encodings>12.2.2.3 Character encodings<a href=#character-encodings class=self-link></a></h5>

  <p>User agents must support the encodings defined in the WHATWG Encoding standard, including, but
  not limited to,
  <dfn id=utf-8><a href=https://encoding.spec.whatwg.org/#utf-8>UTF-8</a></dfn>,
  <dfn id=iso-8859-2><a href=https://encoding.spec.whatwg.org/#iso-8859-2>ISO-8859-2</a></dfn>,
  <dfn id=iso-8859-7><a href=https://encoding.spec.whatwg.org/#iso-8859-7>ISO-8859-7</a></dfn>,
  <dfn id=iso-8859-8><a href=https://encoding.spec.whatwg.org/#iso-8859-8>ISO-8859-8</a></dfn>,
  <dfn id=windows-874><a href=https://encoding.spec.whatwg.org/#windows-874>windows-874</a></dfn>,
  <dfn id=windows-1250><a href=https://encoding.spec.whatwg.org/#windows-1250>windows-1250</a></dfn>,
  <dfn id=windows-1251><a href=https://encoding.spec.whatwg.org/#windows-1251>windows-1251</a></dfn>,
  <dfn id=windows-1252><a href=https://encoding.spec.whatwg.org/#windows-1252>windows-1252</a></dfn>,
  <dfn id=windows-1254><a href=https://encoding.spec.whatwg.org/#windows-1254>windows-1254</a></dfn>,
  <dfn id=windows-1255><a href=https://encoding.spec.whatwg.org/#windows-1255>windows-1255</a></dfn>,
  <dfn id=windows-1256><a href=https://encoding.spec.whatwg.org/#windows-1256>windows-1256</a></dfn>,
  <dfn id=windows-1257><a href=https://encoding.spec.whatwg.org/#windows-1257>windows-1257</a></dfn>,
  <dfn id=windows-1258><a href=https://encoding.spec.whatwg.org/#windows-1258>windows-1258</a></dfn>,
  <dfn id=gb18030><a href=https://encoding.spec.whatwg.org/#gb18030>gb18030</a></dfn>,
  <dfn id=big5><a href=https://encoding.spec.whatwg.org/#big5>Big5</a></dfn>,
  <dfn id=iso-2022-jp><a href=https://encoding.spec.whatwg.org/#iso-2022-jp>ISO-2022-JP</a></dfn>,
  <dfn id=shift_jis><a href=https://encoding.spec.whatwg.org/#shift_jis>Shift_JIS</a></dfn>,
  <dfn id=euc-kr><a href=https://encoding.spec.whatwg.org/#euc-kr>EUC-KR</a></dfn>,
  <dfn id=utf-16be><a href=https://encoding.spec.whatwg.org/#utf-16be>UTF-16BE</a></dfn>,
  <dfn id=utf-16le><a href=https://encoding.spec.whatwg.org/#utf-16le>UTF-16LE</a></dfn>, and
  <dfn id=x-user-defined><a href=https://encoding.spec.whatwg.org/#x-user-defined>x-user-defined</a></dfn>.
  User agents must not support other encodings.</p>

  <p class=note>The above prohibits supporting, for example, CESU-8, UTF-7, BOCU-1, SCSU, EBCDIC,
  and UTF-32. This specification does not make any attempt to support prohibited encodings in its
  algorithms; support and use of prohibited encodings would thus lead to unexpected behavior. <a href=#refsCESU8>[CESU8]</a> <a href=#refsUTF7>[UTF7]</a> <a href=#refsBOCU1>[BOCU1]</a> <a href=#refsSCSU>[SCSU]</a></p>


  <h5 id=changing-the-encoding-while-parsing>12.2.2.4 Changing the encoding while parsing<a href=#changing-the-encoding-while-parsing class=self-link></a></h5>

  <p>When the parser requires the user agent to <dfn id=change-the-encoding>change the encoding</dfn>, it must run the
  following steps. This might happen if the <a href=#encoding-sniffing-algorithm id=changing-the-encoding-while-parsing:encoding-sniffing-algorithm>encoding sniffing algorithm</a> described above
  failed to find a character encoding, or if it found a character encoding that was not the actual
  encoding of the file.</p>

  <ol><li><p>If the encoding that is already being used to interpret the input stream is a <a href=#utf-16-encoding id=changing-the-encoding-while-parsing:utf-16-encoding>UTF-16
   encoding</a>, then set the <a href=#concept-encoding-confidence id=changing-the-encoding-while-parsing:concept-encoding-confidence>confidence</a> to
   <i>certain</i> and abort these steps. The new encoding is ignored; if it was anything but the
   same encoding, then it would be clearly incorrect.<li><p>If the new encoding is a <a href=#utf-16-encoding id=changing-the-encoding-while-parsing:utf-16-encoding-2>UTF-16 encoding</a>, then change it to
   <a id=changing-the-encoding-while-parsing:utf-8 href=https://encoding.spec.whatwg.org/#utf-8 data-x-internal=utf-8>UTF-8</a>.<li><p>If the new encoding is <a id=changing-the-encoding-while-parsing:x-user-defined href=https://encoding.spec.whatwg.org/#x-user-defined data-x-internal=x-user-defined>x-user-defined</a>, then change it to
   <a id=changing-the-encoding-while-parsing:windows-1252 href=https://encoding.spec.whatwg.org/#windows-1252 data-x-internal=windows-1252>windows-1252</a>.<li><p>If the new encoding is identical or equivalent to the encoding that is already being used
   to interpret the input stream, then set the <a href=#concept-encoding-confidence id=changing-the-encoding-while-parsing:concept-encoding-confidence-2>confidence</a> to <i>certain</i> and abort these steps.
   This happens when the encoding information found in the file matches what the <a href=#encoding-sniffing-algorithm id=changing-the-encoding-while-parsing:encoding-sniffing-algorithm-2>encoding
   sniffing algorithm</a> determined to be the encoding, and in the second pass through the
   parser if the first pass found that the encoding sniffing algorithm described in the earlier
   section failed to find the right encoding.<li><p>If all the bytes up to the last byte converted by the current decoder have the same
   Unicode interpretations in both the current encoding and the new encoding, and if the user agent
   supports changing the converter on the fly, then the user agent may change to the new converter
   for the encoding on the fly. Set the <a id="changing-the-encoding-while-parsing:document's-character-encoding" href=https://dom.spec.whatwg.org/#concept-document-encoding data-x-internal="document's-character-encoding">document's character encoding</a> and the encoding
   used to convert the input stream to the new encoding, set the <a href=#concept-encoding-confidence id=changing-the-encoding-while-parsing:concept-encoding-confidence-3>confidence</a> to <i>certain</i>, and abort these
   steps.<li><p>Otherwise, <a href=#navigate id=changing-the-encoding-while-parsing:navigate>navigate</a> to the document again, with
   <a href=#replacement-enabled id=changing-the-encoding-while-parsing:replacement-enabled>replacement enabled</a>, and using the same <a href=#source-browsing-context id=changing-the-encoding-while-parsing:source-browsing-context>source browsing context</a>, but
   this time skip the <a href=#encoding-sniffing-algorithm id=changing-the-encoding-while-parsing:encoding-sniffing-algorithm-3>encoding sniffing algorithm</a> and instead just set the encoding to
   the new encoding and the <a href=#concept-encoding-confidence id=changing-the-encoding-while-parsing:concept-encoding-confidence-4>confidence</a> to
   <i>certain</i>. Whenever possible, this should be done without actually contacting the network
   layer (the bytes should be re-parsed from memory), even if, e.g., the document is marked as not
   being cacheable. If this is not possible and contacting the network layer would involve repeating
   a request that uses a method other than `<code>GET</code>`), then instead set the <a href=#concept-encoding-confidence id=changing-the-encoding-while-parsing:concept-encoding-confidence-5>confidence</a> to <i>certain</i> and ignore the new
   encoding. The resource will be misinterpreted. User agents may notify the user of the situation,
   to aid in application development.</ol>

  <p class=note>This algorithm is only invoked when a new encoding is found declared on a
  <code id=changing-the-encoding-while-parsing:the-meta-element><a href=#the-meta-element>meta</a></code> element.</p> 


  <h5 id=preprocessing-the-input-stream>12.2.2.5 Preprocessing the input stream<a href=#preprocessing-the-input-stream class=self-link></a></h5>

  <p>The <dfn id=input-stream>input stream</dfn> consists of the characters pushed into it as the <a href=#the-input-byte-stream id=preprocessing-the-input-stream:the-input-byte-stream>input byte
  stream</a> is decoded or from the various APIs that directly manipulate the input stream.</p>

  <p>Any occurrences of any characters in the ranges U+0001 to U+0008,    U+000E to U+001F, 
  U+007F  to U+009F, U+FDD0 to U+FDEF, and
  characters U+000B, U+FFFE, U+FFFF, U+1FFFE, U+1FFFF, U+2FFFE, U+2FFFF, U+3FFFE, U+3FFFF, U+4FFFE,
  U+4FFFF, U+5FFFE, U+5FFFF, U+6FFFE, U+6FFFF, U+7FFFE, U+7FFFF, U+8FFFE, U+8FFFF, U+9FFFE, U+9FFFF,
  U+AFFFE, U+AFFFF, U+BFFFE, U+BFFFF, U+CFFFE, U+CFFFF, U+DFFFE, U+DFFFF, U+EFFFE, U+EFFFF, U+FFFFE,
  U+FFFFF, U+10FFFE, and U+10FFFF are <a href=#parse-error id=preprocessing-the-input-stream:parse-error>parse errors</a>. These are all
  <a href=#control-characters id=preprocessing-the-input-stream:control-characters>control characters</a> or permanently undefined Unicode characters (noncharacters).</p>

  <p>Any <a href=#character id=preprocessing-the-input-stream:character>character</a> that is a not a <a href=#unicode-character id=preprocessing-the-input-stream:unicode-character>Unicode character</a>, i.e. any isolated
  surrogate, is a <a href=#parse-error id=preprocessing-the-input-stream:parse-error-2>parse error</a>. (These can only find their way into the input stream via
  script APIs such as <code id=preprocessing-the-input-stream:dom-document-write><a href=#dom-document-write>document.write()</a></code>.)</p>

  <p>U+000D CARRIAGE RETURN (CR) characters and U+000A LINE FEED (LF) characters are treated
  specially. Any LF character that immediately follows a CR character must be ignored, and all CR
  characters must then be converted to LF characters. Thus, newlines in HTML DOMs are represented by
  LF characters, and there are never any CR characters in the input to the <a href=#tokenization id=preprocessing-the-input-stream:tokenization>tokenization</a>
  stage.</p>

  <p>The <dfn id=next-input-character>next input character</dfn> is the first character in the <a href=#input-stream id=preprocessing-the-input-stream:input-stream>input stream</a>
  that has not yet been <dfn>consumed</dfn> or explicitly ignored by the requirements in
  this section. Initially, the <i id=preprocessing-the-input-stream:next-input-character><a href=#next-input-character>next input character</a></i> is the
  first character in the input. The <dfn id=current-input-character>current input character</dfn> is the last character to have
  been <i>consumed</i>.</p>

  <p>The <dfn id=insertion-point>insertion point</dfn> is the position (just before a character or just before the end
  of the input stream) where content inserted using <code id=preprocessing-the-input-stream:dom-document-write-2><a href=#dom-document-write>document.write()</a></code> is actually inserted. The insertion point is
  relative to the position of the character immediately after it, it is not an absolute offset into
  the input stream. Initially, the insertion point is undefined.</p>

  <p>The "EOF" character in the tables below is a conceptual character representing the end of the
  <a href=#input-stream id=preprocessing-the-input-stream:input-stream-2>input stream</a>. If the parser is a <a href=#script-created-parser id=preprocessing-the-input-stream:script-created-parser>script-created parser</a>, then the end of
  the <a href=#input-stream id=preprocessing-the-input-stream:input-stream-3>input stream</a> is reached when an <dfn id=explicit-eof-character>explicit "EOF" character</dfn> (inserted by
  the <code id=preprocessing-the-input-stream:dom-document-close><a href=#dom-document-close>document.close()</a></code> method) is consumed. Otherwise, the
  "EOF" character is not a real character in the stream, but rather the lack of any further
  characters.</p>

  <p class=note>The handling of U+0000 NULL characters varies based on where the characters are
  found. In general, they are ignored except where doing so could plausibly introduce an attack
  vector. This handling is, by necessity, spread across both the tokenization stage and the tree
  construction stage.</p>

  


  

  <h4 id=parse-state>12.2.3 Parse state<a href=#parse-state class=self-link></a></h4>

  <h5 id=the-insertion-mode>12.2.3.1 The insertion mode<a href=#the-insertion-mode class=self-link></a></h5>

  <p>The <dfn id=insertion-mode>insertion mode</dfn> is a state variable that controls the primary operation of the
  tree construction stage.</p>

  <p>Initially, the <a href=#insertion-mode id=the-insertion-mode:insertion-mode>insertion mode</a> is "<a href=#the-initial-insertion-mode id=the-insertion-mode:the-initial-insertion-mode>initial</a>". It can change to "<a href=#the-before-html-insertion-mode id=the-insertion-mode:the-before-html-insertion-mode>before
  html</a>", "<a href=#the-before-head-insertion-mode id=the-insertion-mode:the-before-head-insertion-mode>before head</a>", "<a href=#parsing-main-inhead id=the-insertion-mode:parsing-main-inhead>in head</a>", "<a href=#parsing-main-inheadnoscript id=the-insertion-mode:parsing-main-inheadnoscript>in head noscript</a>", "<a href=#the-after-head-insertion-mode id=the-insertion-mode:the-after-head-insertion-mode>after head</a>",
  "<a href=#parsing-main-inbody id=the-insertion-mode:parsing-main-inbody>in body</a>", "<a href=#parsing-main-incdata id=the-insertion-mode:parsing-main-incdata>text</a>", "<a href=#parsing-main-intable id=the-insertion-mode:parsing-main-intable>in table</a>", "<a href=#parsing-main-intabletext id=the-insertion-mode:parsing-main-intabletext>in table text</a>", "<a href=#parsing-main-incaption id=the-insertion-mode:parsing-main-incaption>in caption</a>", "<a href=#parsing-main-incolgroup id=the-insertion-mode:parsing-main-incolgroup>in column
  group</a>", "<a href=#parsing-main-intbody id=the-insertion-mode:parsing-main-intbody>in table body</a>", "<a href=#parsing-main-intr id=the-insertion-mode:parsing-main-intr>in row</a>", "<a href=#parsing-main-intd id=the-insertion-mode:parsing-main-intd>in
  cell</a>", "<a href=#parsing-main-inselect id=the-insertion-mode:parsing-main-inselect>in select</a>", "<a href=#parsing-main-inselectintable id=the-insertion-mode:parsing-main-inselectintable>in select in table</a>", "<a href=#parsing-main-intemplate id=the-insertion-mode:parsing-main-intemplate>in template</a>", "<a href=#parsing-main-afterbody id=the-insertion-mode:parsing-main-afterbody>after body</a>",
  "<a href=#parsing-main-inframeset id=the-insertion-mode:parsing-main-inframeset>in frameset</a>", "<a href=#parsing-main-afterframeset id=the-insertion-mode:parsing-main-afterframeset>after frameset</a>", "<a href=#the-after-after-body-insertion-mode id=the-insertion-mode:the-after-after-body-insertion-mode>after
  after body</a>", and "<a href=#the-after-after-frameset-insertion-mode id=the-insertion-mode:the-after-after-frameset-insertion-mode>after after
  frameset</a>" during the course of the parsing, as described in the <a href=#tree-construction id=the-insertion-mode:tree-construction>tree
  construction</a> stage. The insertion mode affects how tokens are processed and whether CDATA
  sections are supported.</p>

  <p>Several of these modes, namely "<a href=#parsing-main-inhead id=the-insertion-mode:parsing-main-inhead-2>in head</a>", "<a href=#parsing-main-inbody id=the-insertion-mode:parsing-main-inbody-2>in body</a>", "<a href=#parsing-main-intable id=the-insertion-mode:parsing-main-intable-2>in
  table</a>", and "<a href=#parsing-main-inselect id=the-insertion-mode:parsing-main-inselect-2>in select</a>", are special, in
  that the other modes defer to them at various times. When the algorithm below says that the user
  agent is to do something "<dfn id=using-the-rules-for>using the rules for</dfn> the <var>m</var> insertion
  mode", where <var>m</var> is one of these modes, the user agent must use the rules
  described under the <var>m</var> <a href=#insertion-mode id=the-insertion-mode:insertion-mode-2>insertion mode</a>'s section, but must leave
  the <a href=#insertion-mode id=the-insertion-mode:insertion-mode-3>insertion mode</a> unchanged unless the rules in <var>m</var> themselves
  switch the <a href=#insertion-mode id=the-insertion-mode:insertion-mode-4>insertion mode</a> to a new value.</p>

  <p>When the insertion mode is switched to "<a href=#parsing-main-incdata id=the-insertion-mode:parsing-main-incdata-2>text</a>" or
  "<a href=#parsing-main-intabletext id=the-insertion-mode:parsing-main-intabletext-2>in table text</a>", the <dfn id=original-insertion-mode>original insertion
  mode</dfn> is also set. This is the insertion mode to which the tree construction stage will
  return.</p>

  <p>Similarly, to parse nested <code id=the-insertion-mode:the-template-element><a href=#the-template-element>template</a></code> elements, a <dfn id=stack-of-template-insertion-modes>stack of template insertion
  modes</dfn> is used. It is initially empty. The <dfn id=current-template-insertion-mode>current template insertion mode</dfn> is the
  insertion mode that was most recently added to the <a href=#stack-of-template-insertion-modes id=the-insertion-mode:stack-of-template-insertion-modes>stack of template insertion modes</a>.
  The algorithms in the sections below will <i>push</i> insertion modes onto this stack, meaning
  that the specified insertion mode is to be added to the stack, and <i>pop</i> insertion modes from
  the stack, which means that the most recently added insertion mode must be removed from the
  stack.</p>

  <hr>

  <p>When the steps below require the UA to <dfn id=reset-the-insertion-mode-appropriately>reset the insertion mode appropriately</dfn>, it
  means the UA must follow these steps:</p>

  <ol><li><p>Let <var>last</var> be false.<li><p>Let <var>node</var> be the last node in the <a href=#stack-of-open-elements id=the-insertion-mode:stack-of-open-elements>stack of open
   elements</a>.<li><p><i>Loop</i>: If <var>node</var> is the first node in the stack of open elements,
   then set <var>last</var> to true, and, if the parser was originally created as part of
   the <a href=#html-fragment-parsing-algorithm id=the-insertion-mode:html-fragment-parsing-algorithm>HTML fragment parsing algorithm</a> (<a href=#fragment-case id=the-insertion-mode:fragment-case>fragment case</a>), set <var>node</var> to the <var id=the-insertion-mode:concept-frag-parse-context><a href=#concept-frag-parse-context>context</a></var>
   element passed to that algorithm.<li>

    <p>If <var>node</var> is a <code id=the-insertion-mode:the-select-element><a href=#the-select-element>select</a></code> element, run these substeps:</p>

    <ol><li><p>If <var>last</var> is true, jump to the step below labeled
     <i>done</i>.<li><p>Let <var>ancestor</var> be <var>node</var>.<li><p><i>Loop</i>: If <var>ancestor</var> is the first node in the <a href=#stack-of-open-elements id=the-insertion-mode:stack-of-open-elements-2>stack of
     open elements</a>, jump to the step below labeled <i>done</i>.<li><p>Let <var>ancestor</var> be the node before <var>ancestor</var> in the
     <a href=#stack-of-open-elements id=the-insertion-mode:stack-of-open-elements-3>stack of open elements</a>.<li><p>If <var>ancestor</var> is a <code id=the-insertion-mode:the-template-element-2><a href=#the-template-element>template</a></code> node, jump to the step below
     labeled <i>done</i>.<li><p>If <var>ancestor</var> is a <code id=the-insertion-mode:the-table-element><a href=#the-table-element>table</a></code> node, switch the <a href=#insertion-mode id=the-insertion-mode:insertion-mode-5>insertion
     mode</a> to "<a href=#parsing-main-inselectintable id=the-insertion-mode:parsing-main-inselectintable-2>in select in table</a>" and
     abort these steps.<li><p>Jump back to the step labeled <i>loop</i>.<li><p><i>Done</i>: Switch the <a href=#insertion-mode id=the-insertion-mode:insertion-mode-6>insertion mode</a> to "<a href=#parsing-main-inselect id=the-insertion-mode:parsing-main-inselect-3>in select</a>" and abort these steps.</ol>

   <li><p>If <var>node</var> is a <code id=the-insertion-mode:the-td-element><a href=#the-td-element>td</a></code> or <code id=the-insertion-mode:the-th-element><a href=#the-th-element>th</a></code> element and <var>last</var> is false, then switch the <a href=#insertion-mode id=the-insertion-mode:insertion-mode-7>insertion mode</a> to "<a href=#parsing-main-intd id=the-insertion-mode:parsing-main-intd-2>in cell</a>" and abort these steps.<li><p>If <var>node</var> is a <code id=the-insertion-mode:the-tr-element><a href=#the-tr-element>tr</a></code> element, then switch the <a href=#insertion-mode id=the-insertion-mode:insertion-mode-8>insertion
   mode</a> to "<a href=#parsing-main-intr id=the-insertion-mode:parsing-main-intr-2>in row</a>" and abort these
   steps.<li><p>If <var>node</var> is a <code id=the-insertion-mode:the-tbody-element><a href=#the-tbody-element>tbody</a></code>, <code id=the-insertion-mode:the-thead-element><a href=#the-thead-element>thead</a></code>, or
   <code id=the-insertion-mode:the-tfoot-element><a href=#the-tfoot-element>tfoot</a></code> element, then switch the <a href=#insertion-mode id=the-insertion-mode:insertion-mode-9>insertion mode</a> to "<a href=#parsing-main-intbody id=the-insertion-mode:parsing-main-intbody-2>in table body</a>" and abort these steps.<li><p>If <var>node</var> is a <code id=the-insertion-mode:the-caption-element><a href=#the-caption-element>caption</a></code> element, then switch the
   <a href=#insertion-mode id=the-insertion-mode:insertion-mode-10>insertion mode</a> to "<a href=#parsing-main-incaption id=the-insertion-mode:parsing-main-incaption-2>in caption</a>" and
   abort these steps.<li><p>If <var>node</var> is a <code id=the-insertion-mode:the-colgroup-element><a href=#the-colgroup-element>colgroup</a></code> element, then switch the
   <a href=#insertion-mode id=the-insertion-mode:insertion-mode-11>insertion mode</a> to "<a href=#parsing-main-incolgroup id=the-insertion-mode:parsing-main-incolgroup-2>in column
   group</a>" and abort these steps.<li><p>If <var>node</var> is a <code id=the-insertion-mode:the-table-element-2><a href=#the-table-element>table</a></code> element, then switch the
   <a href=#insertion-mode id=the-insertion-mode:insertion-mode-12>insertion mode</a> to "<a href=#parsing-main-intable id=the-insertion-mode:parsing-main-intable-3>in table</a>" and abort
   these steps.<li><p>If <var>node</var> is a <code id=the-insertion-mode:the-template-element-3><a href=#the-template-element>template</a></code> element, then switch the
   <a href=#insertion-mode id=the-insertion-mode:insertion-mode-13>insertion mode</a> to the <a href=#current-template-insertion-mode id=the-insertion-mode:current-template-insertion-mode>current template insertion mode</a> and abort these
   steps.<li><p>If <var>node</var> is a <code id=the-insertion-mode:the-head-element><a href=#the-head-element>head</a></code> element and <var>last</var> is
   false, then switch the <a href=#insertion-mode id=the-insertion-mode:insertion-mode-14>insertion mode</a> to "<a href=#parsing-main-inhead id=the-insertion-mode:parsing-main-inhead-3>in
   head</a>" and abort these steps.<li><p>If <var>node</var> is a <code id=the-insertion-mode:the-body-element><a href=#the-body-element>body</a></code> element, then switch the
   <a href=#insertion-mode id=the-insertion-mode:insertion-mode-15>insertion mode</a> to "<a href=#parsing-main-inbody id=the-insertion-mode:parsing-main-inbody-3>in body</a>" and abort
   these steps.<li><p>If <var>node</var> is a <code id=the-insertion-mode:frameset><a href=#frameset>frameset</a></code> element, then switch the
   <a href=#insertion-mode id=the-insertion-mode:insertion-mode-16>insertion mode</a> to "<a href=#parsing-main-inframeset id=the-insertion-mode:parsing-main-inframeset-2>in frameset</a>" and
   abort these steps. (<a href=#fragment-case id=the-insertion-mode:fragment-case-2>fragment case</a>)<li>

    <p>If <var>node</var> is an <code id=the-insertion-mode:the-html-element><a href=#the-html-element>html</a></code> element, run these substeps:</p>

    <ol><li><p>If the <a href=#head-element-pointer id=the-insertion-mode:head-element-pointer><code>head</code> element pointer</a> is null, switch the
     <a href=#insertion-mode id=the-insertion-mode:insertion-mode-17>insertion mode</a> to "<a href=#the-before-head-insertion-mode id=the-insertion-mode:the-before-head-insertion-mode-2>before head</a>"
     and abort these steps. (<a href=#fragment-case id=the-insertion-mode:fragment-case-3>fragment case</a>)<li><p>Otherwise, the <a href=#head-element-pointer id=the-insertion-mode:head-element-pointer-2><code>head</code> element pointer</a> is not null, switch the
     <a href=#insertion-mode id=the-insertion-mode:insertion-mode-18>insertion mode</a> to "<a href=#the-after-head-insertion-mode id=the-insertion-mode:the-after-head-insertion-mode-2>after head</a>" and
     abort these steps.</ol>

   <li><p>If <var>last</var> is true, then switch the <a href=#insertion-mode id=the-insertion-mode:insertion-mode-19>insertion mode</a> to "<a href=#parsing-main-inbody id=the-insertion-mode:parsing-main-inbody-4>in body</a>" and abort these steps. (<a href=#fragment-case id=the-insertion-mode:fragment-case-4>fragment
   case</a>)<li><p>Let <var>node</var> now be the node before <var>node</var> in the
   <a href=#stack-of-open-elements id=the-insertion-mode:stack-of-open-elements-4>stack of open elements</a>.<li><p>Return to the step labeled <i>loop</i>.</ol>


  <h5 id=the-stack-of-open-elements>12.2.3.2 The stack of open elements<a href=#the-stack-of-open-elements class=self-link></a></h5>

  <p>Initially, the <dfn id=stack-of-open-elements>stack of open elements</dfn> is empty. The stack grows downwards; the
  topmost node on the stack is the first one added to the stack, and the bottommost node of the
  stack is the most recently added node in the stack (notwithstanding when the stack is manipulated
  in a random access fashion as part of <a href=#adoptionAgency>the handling for misnested
  tags</a>).</p>

  <p class=note>The "<a href=#the-before-html-insertion-mode id=the-stack-of-open-elements:the-before-html-insertion-mode>before html</a>"
  <a href=#insertion-mode id=the-stack-of-open-elements:insertion-mode>insertion mode</a> creates the <code id=the-stack-of-open-elements:the-html-element><a href=#the-html-element>html</a></code> <a id=the-stack-of-open-elements:document-element href=https://dom.spec.whatwg.org/#document-element data-x-internal=document-element>document element</a>, which is
  then added to the stack.</p>

  <p class=note>In the <a href=#fragment-case id=the-stack-of-open-elements:fragment-case>fragment case</a>, the <a href=#stack-of-open-elements id=the-stack-of-open-elements:stack-of-open-elements>stack of open elements</a> is
  initialized to contain an <code id=the-stack-of-open-elements:the-html-element-2><a href=#the-html-element>html</a></code> element that is created as part of <a href=#html-fragment-parsing-algorithm id=the-stack-of-open-elements:html-fragment-parsing-algorithm>that algorithm</a>. (The <a href=#fragment-case id=the-stack-of-open-elements:fragment-case-2>fragment case</a> skips the
  "<a href=#the-before-html-insertion-mode id=the-stack-of-open-elements:the-before-html-insertion-mode-2>before html</a>" <a href=#insertion-mode id=the-stack-of-open-elements:insertion-mode-2>insertion mode</a>.)</p>

  <p>The <code id=the-stack-of-open-elements:the-html-element-3><a href=#the-html-element>html</a></code> node, however it is created, is the topmost node of the stack. It only
  gets popped off the stack when the parser <a href=#stop-parsing id=the-stack-of-open-elements:stop-parsing>finishes</a>.</p>

  <p>The <dfn id=current-node>current node</dfn> is the bottommost node in this <a href=#stack-of-open-elements id=the-stack-of-open-elements:stack-of-open-elements-2>stack of open
  elements</a>.</p>

  <p>The <dfn id=adjusted-current-node>adjusted current node</dfn> is the <i id=the-stack-of-open-elements:concept-frag-parse-context><a href=#concept-frag-parse-context>context</a></i>
  element if the parser was created by the <a href=#html-fragment-parsing-algorithm id=the-stack-of-open-elements:html-fragment-parsing-algorithm-2>HTML fragment parsing algorithm</a> and the
  <a href=#stack-of-open-elements id=the-stack-of-open-elements:stack-of-open-elements-3>stack of open elements</a> has only one element in it (<a href=#fragment-case id=the-stack-of-open-elements:fragment-case-3>fragment case</a>);
  otherwise, the <a href=#adjusted-current-node id=the-stack-of-open-elements:adjusted-current-node>adjusted current node</a> is the <a href=#current-node id=the-stack-of-open-elements:current-node>current node</a>.<div class=status><input onclick=toggleStatus(this) value=⋰ type=button><p class=bugs><strong>Spec bugs:</strong> <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=27314" title="Parser: &quot;adjusted current node&quot; not clear enough">27314</a></div>

  <p>Elements in the <a href=#stack-of-open-elements id=the-stack-of-open-elements:stack-of-open-elements-4>stack of open elements</a> fall into the following categories:</p>

  <dl><dt><dfn id=special>Special</dfn><dd>
    <p>The following elements have varying levels of special parsing rules: HTML's
    <code id=the-stack-of-open-elements:the-address-element><a href=#the-address-element>address</a></code>, <code id=the-stack-of-open-elements:the-applet-element><a href=#the-applet-element>applet</a></code>, <code id=the-stack-of-open-elements:the-area-element><a href=#the-area-element>area</a></code>, <code id=the-stack-of-open-elements:the-article-element><a href=#the-article-element>article</a></code>,
    <code id=the-stack-of-open-elements:the-aside-element><a href=#the-aside-element>aside</a></code>, <code id=the-stack-of-open-elements:the-base-element><a href=#the-base-element>base</a></code>, <code id=the-stack-of-open-elements:basefont><a href=#basefont>basefont</a></code>, <code id=the-stack-of-open-elements:bgsound><a href=#bgsound>bgsound</a></code>,
    <code id=the-stack-of-open-elements:the-blockquote-element><a href=#the-blockquote-element>blockquote</a></code>, <code id=the-stack-of-open-elements:the-body-element><a href=#the-body-element>body</a></code>, <code id=the-stack-of-open-elements:the-br-element><a href=#the-br-element>br</a></code>, <code id=the-stack-of-open-elements:the-button-element><a href=#the-button-element>button</a></code>,
    <code id=the-stack-of-open-elements:the-caption-element><a href=#the-caption-element>caption</a></code>, <code id=the-stack-of-open-elements:center><a href=#center>center</a></code>, <code id=the-stack-of-open-elements:the-col-element><a href=#the-col-element>col</a></code>, <code id=the-stack-of-open-elements:the-colgroup-element><a href=#the-colgroup-element>colgroup</a></code>,
    <code id=the-stack-of-open-elements:the-dd-element><a href=#the-dd-element>dd</a></code>, <code id=the-stack-of-open-elements:the-details-element><a href=#the-details-element>details</a></code>, <code id=the-stack-of-open-elements:dir><a href=#dir>dir</a></code>, <code id=the-stack-of-open-elements:the-div-element><a href=#the-div-element>div</a></code>, <code id=the-stack-of-open-elements:the-dl-element><a href=#the-dl-element>dl</a></code>,
    <code id=the-stack-of-open-elements:the-dt-element><a href=#the-dt-element>dt</a></code>, <code id=the-stack-of-open-elements:the-embed-element><a href=#the-embed-element>embed</a></code>, <code id=the-stack-of-open-elements:the-fieldset-element><a href=#the-fieldset-element>fieldset</a></code>, <code id=the-stack-of-open-elements:the-figcaption-element><a href=#the-figcaption-element>figcaption</a></code>,
    <code id=the-stack-of-open-elements:the-figure-element><a href=#the-figure-element>figure</a></code>, <code id=the-stack-of-open-elements:the-footer-element><a href=#the-footer-element>footer</a></code>, <code id=the-stack-of-open-elements:the-form-element><a href=#the-form-element>form</a></code>, <code id=the-stack-of-open-elements:frame><a href=#frame>frame</a></code>,
    <code id=the-stack-of-open-elements:frameset><a href=#frameset>frameset</a></code>, <code id=the-stack-of-open-elements:the-h1,-h2,-h3,-h4,-h5,-and-h6-elements><a href=#the-h1,-h2,-h3,-h4,-h5,-and-h6-elements>h1</a></code>, <code id=the-stack-of-open-elements:the-h1,-h2,-h3,-h4,-h5,-and-h6-elements-2><a href=#the-h1,-h2,-h3,-h4,-h5,-and-h6-elements>h2</a></code>, <code id=the-stack-of-open-elements:the-h1,-h2,-h3,-h4,-h5,-and-h6-elements-3><a href=#the-h1,-h2,-h3,-h4,-h5,-and-h6-elements>h3</a></code>, <code id=the-stack-of-open-elements:the-h1,-h2,-h3,-h4,-h5,-and-h6-elements-4><a href=#the-h1,-h2,-h3,-h4,-h5,-and-h6-elements>h4</a></code>,
    <code id=the-stack-of-open-elements:the-h1,-h2,-h3,-h4,-h5,-and-h6-elements-5><a href=#the-h1,-h2,-h3,-h4,-h5,-and-h6-elements>h5</a></code>, <code id=the-stack-of-open-elements:the-h1,-h2,-h3,-h4,-h5,-and-h6-elements-6><a href=#the-h1,-h2,-h3,-h4,-h5,-and-h6-elements>h6</a></code>, <code id=the-stack-of-open-elements:the-head-element><a href=#the-head-element>head</a></code>, <code id=the-stack-of-open-elements:the-header-element><a href=#the-header-element>header</a></code>, <code id=the-stack-of-open-elements:the-hgroup-element><a href=#the-hgroup-element>hgroup</a></code>,
    <code id=the-stack-of-open-elements:the-hr-element><a href=#the-hr-element>hr</a></code>, <code id=the-stack-of-open-elements:the-html-element-4><a href=#the-html-element>html</a></code>, <code id=the-stack-of-open-elements:the-iframe-element><a href=#the-iframe-element>iframe</a></code>, 
    <code id=the-stack-of-open-elements:the-img-element><a href=#the-img-element>img</a></code>, <code id=the-stack-of-open-elements:the-input-element><a href=#the-input-element>input</a></code>, <code id=the-stack-of-open-elements:keygen><a href=#keygen>keygen</a></code>, <code id=the-stack-of-open-elements:the-li-element><a href=#the-li-element>li</a></code>, <code id=the-stack-of-open-elements:the-link-element><a href=#the-link-element>link</a></code>,
    <code id=the-stack-of-open-elements:listing><a href=#listing>listing</a></code>, <code id=the-stack-of-open-elements:the-main-element><a href=#the-main-element>main</a></code>, <code id=the-stack-of-open-elements:the-marquee-element><a href=#the-marquee-element>marquee</a></code>, <code id=the-stack-of-open-elements:the-menu-element><a href=#the-menu-element>menu</a></code>,
    <code id=the-stack-of-open-elements:the-meta-element><a href=#the-meta-element>meta</a></code>, <code id=the-stack-of-open-elements:the-nav-element><a href=#the-nav-element>nav</a></code>, <code id=the-stack-of-open-elements:noembed><a href=#noembed>noembed</a></code>, <code id=the-stack-of-open-elements:noframes><a href=#noframes>noframes</a></code>,
    <code id=the-stack-of-open-elements:the-noscript-element><a href=#the-noscript-element>noscript</a></code>, <code id=the-stack-of-open-elements:the-object-element><a href=#the-object-element>object</a></code>, <code id=the-stack-of-open-elements:the-ol-element><a href=#the-ol-element>ol</a></code>, <code id=the-stack-of-open-elements:the-p-element><a href=#the-p-element>p</a></code>, <code id=the-stack-of-open-elements:the-param-element><a href=#the-param-element>param</a></code>,
    <code id=the-stack-of-open-elements:plaintext><a href=#plaintext>plaintext</a></code>, <code id=the-stack-of-open-elements:the-pre-element><a href=#the-pre-element>pre</a></code>, <code id=the-stack-of-open-elements:the-script-element><a href=#the-script-element>script</a></code>, <code id=the-stack-of-open-elements:the-section-element><a href=#the-section-element>section</a></code>,
    <code id=the-stack-of-open-elements:the-select-element><a href=#the-select-element>select</a></code>, <code id=the-stack-of-open-elements:the-source-element><a href=#the-source-element>source</a></code>, <code id=the-stack-of-open-elements:the-style-element><a href=#the-style-element>style</a></code>, <code id=the-stack-of-open-elements:the-summary-element><a href=#the-summary-element>summary</a></code>,
    <code id=the-stack-of-open-elements:the-table-element><a href=#the-table-element>table</a></code>, <code id=the-stack-of-open-elements:the-tbody-element><a href=#the-tbody-element>tbody</a></code>, <code id=the-stack-of-open-elements:the-td-element><a href=#the-td-element>td</a></code>, <code id=the-stack-of-open-elements:the-template-element><a href=#the-template-element>template</a></code>,
    <code id=the-stack-of-open-elements:the-textarea-element><a href=#the-textarea-element>textarea</a></code>, <code id=the-stack-of-open-elements:the-tfoot-element><a href=#the-tfoot-element>tfoot</a></code>, <code id=the-stack-of-open-elements:the-th-element><a href=#the-th-element>th</a></code>, <code id=the-stack-of-open-elements:the-thead-element><a href=#the-thead-element>thead</a></code>,
    <code id=the-stack-of-open-elements:the-title-element><a href=#the-title-element>title</a></code>, <code id=the-stack-of-open-elements:the-tr-element><a href=#the-tr-element>tr</a></code>, <code id=the-stack-of-open-elements:the-track-element><a href=#the-track-element>track</a></code>, <code id=the-stack-of-open-elements:the-ul-element><a href=#the-ul-element>ul</a></code>, <code id=the-stack-of-open-elements:the-wbr-element><a href=#the-wbr-element>wbr</a></code>,
    <code id=the-stack-of-open-elements:xmp><a href=#xmp>xmp</a></code>; <a id=the-stack-of-open-elements:mathml-mi href=https://www.w3.org/Math/draft-spec/chapter3.html#presm.mi data-x-internal=mathml-mi>MathML <code>mi</code></a>, <a id=the-stack-of-open-elements:mathml-mo href=https://www.w3.org/Math/draft-spec/chapter3.html#presm.mo data-x-internal=mathml-mo>MathML <code>mo</code></a>,
    <a id=the-stack-of-open-elements:mathml-mn href=https://www.w3.org/Math/draft-spec/chapter3.html#presm.mn data-x-internal=mathml-mn>MathML <code>mn</code></a>, <a id=the-stack-of-open-elements:mathml-ms href=https://www.w3.org/Math/draft-spec/chapter3.html#presm.ms data-x-internal=mathml-ms>MathML <code>ms</code></a>, <a id=the-stack-of-open-elements:mathml-mtext href=https://www.w3.org/Math/draft-spec/chapter3.html#presm.mtext data-x-internal=mathml-mtext>MathML
    <code>mtext</code></a>, and <a id=the-stack-of-open-elements:mathml-annotation-xml href=https://www.w3.org/Math/draft-spec/chapter5.html#mixing.elements.annotation.xml data-x-internal=mathml-annotation-xml>MathML <code>annotation-xml</code></a>; and <a id=the-stack-of-open-elements:svg-foreignobject href=https://www.w3.org/TR/SVG11/extend.html#ForeignObjectElement data-x-internal=svg-foreignobject>SVG
    <code>foreignObject</code></a>, <a id=the-stack-of-open-elements:svg-desc href=https://www.w3.org/TR/SVG11/struct.html#DescElement data-x-internal=svg-desc>SVG <code>desc</code></a>, and <a id=the-stack-of-open-elements:svg-title href=https://www.w3.org/TR/SVG11/struct.html#TitleElement data-x-internal=svg-title>SVG
    <code>title</code></a>.</p> 

    <p class=note>An <code>image</code> start tag token is handled by the tree builder,
    but it is not in this list because it is not an element; it gets turned into an <code id=the-stack-of-open-elements:the-img-element-2><a href=#the-img-element>img</a></code>
    element.</p>
   <dt><dfn id=formatting>Formatting</dfn><dd><p>The following HTML elements are those that end up in the <a href=#list-of-active-formatting-elements id=the-stack-of-open-elements:list-of-active-formatting-elements>list of active formatting
   elements</a>: <code id=the-stack-of-open-elements:the-a-element><a href=#the-a-element>a</a></code>, <code id=the-stack-of-open-elements:the-b-element><a href=#the-b-element>b</a></code>, <code id=the-stack-of-open-elements:big><a href=#big>big</a></code>, <code id=the-stack-of-open-elements:the-code-element><a href=#the-code-element>code</a></code>,
   <code id=the-stack-of-open-elements:the-em-element><a href=#the-em-element>em</a></code>, <code id=the-stack-of-open-elements:font><a href=#font>font</a></code>, <code id=the-stack-of-open-elements:the-i-element><a href=#the-i-element>i</a></code>, <code id=the-stack-of-open-elements:nobr><a href=#nobr>nobr</a></code>, <code id=the-stack-of-open-elements:the-s-element><a href=#the-s-element>s</a></code>,
   <code id=the-stack-of-open-elements:the-small-element><a href=#the-small-element>small</a></code>, <code id=the-stack-of-open-elements:strike><a href=#strike>strike</a></code>, <code id=the-stack-of-open-elements:the-strong-element><a href=#the-strong-element>strong</a></code>, <code id=the-stack-of-open-elements:tt><a href=#tt>tt</a></code>, and
   <code id=the-stack-of-open-elements:the-u-element><a href=#the-u-element>u</a></code>.<dt><dfn id=ordinary>Ordinary</dfn><dd><p>All other elements found while parsing an HTML document.</dl>

  <p class=note>Typically, the <a href=#special id=the-stack-of-open-elements:special>special</a> elements have the start and end tag tokens
  handled specifically, while <a href=#ordinary id=the-stack-of-open-elements:ordinary>ordinary</a> elements' tokens fall into "any other start tag"
  and "any other end tag" clauses, and some parts of the tree builder check if a particular element
  in the <a href=#stack-of-open-elements id=the-stack-of-open-elements:stack-of-open-elements-5>stack of open elements</a> is in the <a href=#special id=the-stack-of-open-elements:special-2>special</a> category. However, some
  elements (e.g., the <code id=the-stack-of-open-elements:the-option-element><a href=#the-option-element>option</a></code> element) have their start or end tag tokens handled
  specifically, but are still not in the <a href=#special id=the-stack-of-open-elements:special-3>special</a> category, so that they get the
  <a href=#ordinary id=the-stack-of-open-elements:ordinary-2>ordinary</a> handling elsewhere.</p>

  <p>The <a href=#stack-of-open-elements id=the-stack-of-open-elements:stack-of-open-elements-6>stack of open elements</a> is said to <dfn id=has-an-element-in-the-specific-scope>have an element <var>target node</var> in a specific scope</dfn> consisting of a
  list of element types <var>list</var> when the following algorithm terminates in a match
  state:</p>

  <ol><li><p>Initialize <var>node</var> to be the <a href=#current-node id=the-stack-of-open-elements:current-node-2>current node</a> (the bottommost
   node of the stack).<li><p>If <var>node</var> is the target node, terminate in a match state.<li><p>Otherwise, if <var>node</var> is one of the element types in <var>list</var>, terminate in a failure state.<li><p>Otherwise, set <var>node</var> to the previous entry in the <a href=#stack-of-open-elements id=the-stack-of-open-elements:stack-of-open-elements-7>stack of open
   elements</a> and return to step 2. (This will never fail, since the loop will always terminate
   in the previous step if the top of the stack — an <code id=the-stack-of-open-elements:the-html-element-5><a href=#the-html-element>html</a></code> element — is
   reached.)</ol>

  <p>The <a href=#stack-of-open-elements id=the-stack-of-open-elements:stack-of-open-elements-8>stack of open elements</a> is said to <dfn id=has-an-element-in-scope>have a
  particular element in scope</dfn> when it <a href=#has-an-element-in-the-specific-scope id=the-stack-of-open-elements:has-an-element-in-the-specific-scope>has
  that element in the specific scope</a> consisting of the following element types:</p>

  <ul class=brief><li><code id=the-stack-of-open-elements:the-applet-element-2><a href=#the-applet-element>applet</a></code><li><code id=the-stack-of-open-elements:the-caption-element-2><a href=#the-caption-element>caption</a></code><li><code id=the-stack-of-open-elements:the-html-element-6><a href=#the-html-element>html</a></code><li><code id=the-stack-of-open-elements:the-table-element-2><a href=#the-table-element>table</a></code><li><code id=the-stack-of-open-elements:the-td-element-2><a href=#the-td-element>td</a></code><li><code id=the-stack-of-open-elements:the-th-element-2><a href=#the-th-element>th</a></code><li><code id=the-stack-of-open-elements:the-marquee-element-2><a href=#the-marquee-element>marquee</a></code><li><code id=the-stack-of-open-elements:the-object-element-2><a href=#the-object-element>object</a></code><li><code id=the-stack-of-open-elements:the-template-element-2><a href=#the-template-element>template</a></code><li><a id=the-stack-of-open-elements:mathml-mi-2 href=https://www.w3.org/Math/draft-spec/chapter3.html#presm.mi data-x-internal=mathml-mi>MathML <code>mi</code></a><li><a id=the-stack-of-open-elements:mathml-mo-2 href=https://www.w3.org/Math/draft-spec/chapter3.html#presm.mo data-x-internal=mathml-mo>MathML <code>mo</code></a><li><a id=the-stack-of-open-elements:mathml-mn-2 href=https://www.w3.org/Math/draft-spec/chapter3.html#presm.mn data-x-internal=mathml-mn>MathML <code>mn</code></a><li><a id=the-stack-of-open-elements:mathml-ms-2 href=https://www.w3.org/Math/draft-spec/chapter3.html#presm.ms data-x-internal=mathml-ms>MathML <code>ms</code></a><li><a id=the-stack-of-open-elements:mathml-mtext-2 href=https://www.w3.org/Math/draft-spec/chapter3.html#presm.mtext data-x-internal=mathml-mtext>MathML <code>mtext</code></a><li><a id=the-stack-of-open-elements:mathml-annotation-xml-2 href=https://www.w3.org/Math/draft-spec/chapter5.html#mixing.elements.annotation.xml data-x-internal=mathml-annotation-xml>MathML <code>annotation-xml</code></a><li><a id=the-stack-of-open-elements:svg-foreignobject-2 href=https://www.w3.org/TR/SVG11/extend.html#ForeignObjectElement data-x-internal=svg-foreignobject>SVG <code>foreignObject</code></a><li><a id=the-stack-of-open-elements:svg-desc-2 href=https://www.w3.org/TR/SVG11/struct.html#DescElement data-x-internal=svg-desc>SVG <code>desc</code></a><li><a id=the-stack-of-open-elements:svg-title-2 href=https://www.w3.org/TR/SVG11/struct.html#TitleElement data-x-internal=svg-title>SVG <code>title</code></a></ul>

  <p>The <a href=#stack-of-open-elements id=the-stack-of-open-elements:stack-of-open-elements-9>stack of open elements</a> is said to <dfn id=has-an-element-in-list-item-scope>have a particular element in list item scope</dfn> when it <a href=#has-an-element-in-the-specific-scope id=the-stack-of-open-elements:has-an-element-in-the-specific-scope-2>has that element in the specific scope</a> consisting of the following
  element types:</p>

  <ul class=brief><li>All the element types listed above for the <i id=the-stack-of-open-elements:has-an-element-in-scope><a href=#has-an-element-in-scope>has an element in scope</a></i> algorithm.<li><code id=the-stack-of-open-elements:the-ol-element-2><a href=#the-ol-element>ol</a></code> in the <a id=the-stack-of-open-elements:html-namespace-2 href=https://infra.spec.whatwg.org/#html-namespace data-x-internal=html-namespace-2>HTML namespace</a><li><code id=the-stack-of-open-elements:the-ul-element-2><a href=#the-ul-element>ul</a></code> in the <a id=the-stack-of-open-elements:html-namespace-2-2 href=https://infra.spec.whatwg.org/#html-namespace data-x-internal=html-namespace-2>HTML namespace</a></ul>

  <p>The <a href=#stack-of-open-elements id=the-stack-of-open-elements:stack-of-open-elements-10>stack of open elements</a> is said to <dfn id=has-an-element-in-button-scope>have a particular element in button scope</dfn> when it <a href=#has-an-element-in-the-specific-scope id=the-stack-of-open-elements:has-an-element-in-the-specific-scope-3>has that element in the specific scope</a> consisting of the following element
  types:</p>

  <ul class=brief><li>All the element types listed above for the <i id=the-stack-of-open-elements:has-an-element-in-scope-2><a href=#has-an-element-in-scope>has an element in scope</a></i> algorithm.<li><code id=the-stack-of-open-elements:the-button-element-2><a href=#the-button-element>button</a></code> in the <a id=the-stack-of-open-elements:html-namespace-2-3 href=https://infra.spec.whatwg.org/#html-namespace data-x-internal=html-namespace-2>HTML namespace</a></ul>

  <p>The <a href=#stack-of-open-elements id=the-stack-of-open-elements:stack-of-open-elements-11>stack of open elements</a> is said to <dfn id=has-an-element-in-table-scope>have a particular element in table scope</dfn> when it <a href=#has-an-element-in-the-specific-scope id=the-stack-of-open-elements:has-an-element-in-the-specific-scope-4>has that element in the specific scope</a> consisting of the following element
  types:</p>

  <ul class=brief><li><code id=the-stack-of-open-elements:the-html-element-7><a href=#the-html-element>html</a></code> in the <a id=the-stack-of-open-elements:html-namespace-2-4 href=https://infra.spec.whatwg.org/#html-namespace data-x-internal=html-namespace-2>HTML namespace</a><li><code id=the-stack-of-open-elements:the-table-element-3><a href=#the-table-element>table</a></code> in the <a id=the-stack-of-open-elements:html-namespace-2-5 href=https://infra.spec.whatwg.org/#html-namespace data-x-internal=html-namespace-2>HTML namespace</a><li><code id=the-stack-of-open-elements:the-template-element-3><a href=#the-template-element>template</a></code> in the <a id=the-stack-of-open-elements:html-namespace-2-6 href=https://infra.spec.whatwg.org/#html-namespace data-x-internal=html-namespace-2>HTML namespace</a></ul>

  <p>The <a href=#stack-of-open-elements id=the-stack-of-open-elements:stack-of-open-elements-12>stack of open elements</a> is said to <dfn id=has-an-element-in-select-scope>have a particular element in select scope</dfn> when it <a href=#has-an-element-in-the-specific-scope id=the-stack-of-open-elements:has-an-element-in-the-specific-scope-5>has that element in the specific scope</a> consisting of all element types
  <em>except</em> the following:</p>

  <ul class=brief><li><code id=the-stack-of-open-elements:the-optgroup-element><a href=#the-optgroup-element>optgroup</a></code> in the <a id=the-stack-of-open-elements:html-namespace-2-7 href=https://infra.spec.whatwg.org/#html-namespace data-x-internal=html-namespace-2>HTML namespace</a><li><code id=the-stack-of-open-elements:the-option-element-2><a href=#the-option-element>option</a></code> in the <a id=the-stack-of-open-elements:html-namespace-2-8 href=https://infra.spec.whatwg.org/#html-namespace data-x-internal=html-namespace-2>HTML namespace</a></ul>

  <p>Nothing happens if at any time any of the elements in the <a href=#stack-of-open-elements id=the-stack-of-open-elements:stack-of-open-elements-13>stack of open elements</a>
  are moved to a new location in, or removed from, the <code id=the-stack-of-open-elements:document><a href=#document>Document</a></code> tree. In particular,
  the stack is not changed in this situation. This can cause, amongst other strange effects, content
  to be appended to nodes that are no longer in the DOM.</p>

  <p class=note>In some cases (namely, when <a href=#adoptionAgency>closing misnested formatting
  elements</a>), the stack is manipulated in a random-access fashion.</p>


  <h5 id=the-list-of-active-formatting-elements>12.2.3.3 The list of active formatting elements<a href=#the-list-of-active-formatting-elements class=self-link></a></h5>

  <p>Initially, the <dfn id=list-of-active-formatting-elements>list of active formatting elements</dfn> is empty. It is used to handle
  mis-nested <a href=#formatting id=the-list-of-active-formatting-elements:formatting>formatting element tags</a>.</p>

  <p>The list contains elements in the <a href=#formatting id=the-list-of-active-formatting-elements:formatting-2>formatting</a> category, and <a href=#concept-parser-marker id=the-list-of-active-formatting-elements:concept-parser-marker>markers</a>. The <dfn id=concept-parser-marker>markers</dfn> are inserted when entering <code id=the-list-of-active-formatting-elements:the-applet-element><a href=#the-applet-element>applet</a></code>,
  <code id=the-list-of-active-formatting-elements:the-object-element><a href=#the-object-element>object</a></code>, <code id=the-list-of-active-formatting-elements:the-marquee-element><a href=#the-marquee-element>marquee</a></code>, <code id=the-list-of-active-formatting-elements:the-template-element><a href=#the-template-element>template</a></code>, <code id=the-list-of-active-formatting-elements:the-td-element><a href=#the-td-element>td</a></code>,
  <code id=the-list-of-active-formatting-elements:the-th-element><a href=#the-th-element>th</a></code>, and <code id=the-list-of-active-formatting-elements:the-caption-element><a href=#the-caption-element>caption</a></code> elements, and are used to prevent formatting from
  "leaking" <em>into</em> <code id=the-list-of-active-formatting-elements:the-applet-element-2><a href=#the-applet-element>applet</a></code>, <code id=the-list-of-active-formatting-elements:the-object-element-2><a href=#the-object-element>object</a></code>, <code id=the-list-of-active-formatting-elements:the-marquee-element-2><a href=#the-marquee-element>marquee</a></code>,
  <code id=the-list-of-active-formatting-elements:the-template-element-2><a href=#the-template-element>template</a></code>, <code id=the-list-of-active-formatting-elements:the-td-element-2><a href=#the-td-element>td</a></code>, <code id=the-list-of-active-formatting-elements:the-th-element-2><a href=#the-th-element>th</a></code>, and <code id=the-list-of-active-formatting-elements:the-caption-element-2><a href=#the-caption-element>caption</a></code> elements.</p>

  <p>In addition, each element in the <a href=#list-of-active-formatting-elements id=the-list-of-active-formatting-elements:list-of-active-formatting-elements>list of active formatting elements</a> is associated
  with the token for which it was created, so that further elements can be created for that token if
  necessary.</p>

  <p>When the steps below require the UA to <dfn id=push-onto-the-list-of-active-formatting-elements>push onto the list of active formatting
  elements</dfn> an element <var>element</var>, the UA must perform the following
  steps:</p>

  <ol id=noah><li><p>If there are already three elements in the <a href=#list-of-active-formatting-elements id=the-list-of-active-formatting-elements:list-of-active-formatting-elements-2>list of active formatting elements</a>
   after the last <a href=#concept-parser-marker id=the-list-of-active-formatting-elements:concept-parser-marker-2>marker</a>, if any, or anywhere in the
   list if there are no <a href=#concept-parser-marker id=the-list-of-active-formatting-elements:concept-parser-marker-3>markers</a>, that have the same tag
   name, namespace, and attributes as <var>element</var>, then remove the earliest such
   element from the <a href=#list-of-active-formatting-elements id=the-list-of-active-formatting-elements:list-of-active-formatting-elements-3>list of active formatting elements</a>. For these purposes, the
   attributes must be compared as they were when the elements were created by the parser; two
   elements have the same attributes if all their parsed attributes can be paired such that the two
   attributes in each pair have identical names, namespaces, and values (the order of the attributes
   does not matter).</p>

   <p class=note>This is the Noah's Ark clause. But with three per family instead of two.<li><p>Add <var>element</var> to the <a href=#list-of-active-formatting-elements id=the-list-of-active-formatting-elements:list-of-active-formatting-elements-4>list of active formatting
   elements</a>.</ol>

  <p>When the steps below require the UA to <dfn id=reconstruct-the-active-formatting-elements>reconstruct the active formatting elements</dfn>,
  the UA must perform the following steps:</p>

  <ol><li><p>If there are no entries in the <a href=#list-of-active-formatting-elements id=the-list-of-active-formatting-elements:list-of-active-formatting-elements-5>list of active formatting elements</a>, then there
   is nothing to reconstruct; stop this algorithm.<li><p>If the last (most recently added) entry in the <a href=#list-of-active-formatting-elements id=the-list-of-active-formatting-elements:list-of-active-formatting-elements-6>list of active formatting
   elements</a> is a <a href=#concept-parser-marker id=the-list-of-active-formatting-elements:concept-parser-marker-4>marker</a>, or if it is an element
   that is in the <a href=#stack-of-open-elements id=the-list-of-active-formatting-elements:stack-of-open-elements>stack of open elements</a>, then there is nothing to reconstruct; stop
   this algorithm.<li><p>Let <var>entry</var> be the last (most recently added) element in the <a href=#list-of-active-formatting-elements id=the-list-of-active-formatting-elements:list-of-active-formatting-elements-7>list
   of active formatting elements</a>.<li><p><i>Rewind</i>: If there are no entries before <var>entry</var> in the <a href=#list-of-active-formatting-elements id=the-list-of-active-formatting-elements:list-of-active-formatting-elements-8>list
   of active formatting elements</a>, then jump to the step labeled <i>create</i>.<li><p>Let <var>entry</var> be the entry one earlier than <var>entry</var> in
   the <a href=#list-of-active-formatting-elements id=the-list-of-active-formatting-elements:list-of-active-formatting-elements-9>list of active formatting elements</a>.<li><p>If <var>entry</var> is neither a <a href=#concept-parser-marker id=the-list-of-active-formatting-elements:concept-parser-marker-5>marker</a> nor an element that is also in the <a href=#stack-of-open-elements id=the-list-of-active-formatting-elements:stack-of-open-elements-2>stack of
   open elements</a>, go to the step labeled <i>rewind</i>.<li><p><i>Advance</i>: Let <var>entry</var> be the element one later than <var>entry</var> in the <a href=#list-of-active-formatting-elements id=the-list-of-active-formatting-elements:list-of-active-formatting-elements-10>list of active formatting elements</a>.<li><p><i>Create</i>: <a href=#insert-an-html-element id=the-list-of-active-formatting-elements:insert-an-html-element>Insert an HTML element</a> for the token for which the element
   <var>entry</var> was created, to obtain <var>new element</var>.<li><p>Replace the entry for <var>entry</var> in the list with an entry for <var>new element</var>.<li><p>If the entry for <var>new element</var> in the <a href=#list-of-active-formatting-elements id=the-list-of-active-formatting-elements:list-of-active-formatting-elements-11>list of active formatting
   elements</a> is not the last entry in the list, return to the step labeled
   <i>advance</i>.</ol>

  <p>This has the effect of reopening all the formatting elements that were opened in the current
  body, cell, or caption (whichever is youngest) that haven't been explicitly closed.</p>

  <p class=note>The way this specification is written, the <a href=#list-of-active-formatting-elements id=the-list-of-active-formatting-elements:list-of-active-formatting-elements-12>list of active formatting
  elements</a> always consists of elements in chronological order with the least recently added
  element first and the most recently added element last (except for while steps 7 to 10 of the
  above algorithm are being executed, of course).</p>

  <p>When the steps below require the UA to <dfn id=clear-the-list-of-active-formatting-elements-up-to-the-last-marker>clear the list of active formatting elements up to
  the last marker</dfn>, the UA must perform the following steps:</p>

  <ol><li><p>Let <var>entry</var> be the last (most recently added) entry in the <a href=#list-of-active-formatting-elements id=the-list-of-active-formatting-elements:list-of-active-formatting-elements-13>list of
   active formatting elements</a>.<li><p>Remove <var>entry</var> from the <a href=#list-of-active-formatting-elements id=the-list-of-active-formatting-elements:list-of-active-formatting-elements-14>list of active formatting
   elements</a>.<li><p>If <var>entry</var> was a <a href=#concept-parser-marker id=the-list-of-active-formatting-elements:concept-parser-marker-6>marker</a>,
   then stop the algorithm at this point. The list has been cleared up to the last <a href=#concept-parser-marker id=the-list-of-active-formatting-elements:concept-parser-marker-7>marker</a>.<li><p>Go to step 1.</ol>


  <h5 id=the-element-pointers>12.2.3.4 The element pointers<a href=#the-element-pointers class=self-link></a></h5>

  <p>Initially, the <dfn id=head-element-pointer><code>head</code> element pointer</dfn> and the <dfn id=form-element-pointer><code>form</code> element pointer</dfn> are both null.</p>

  <p>Once a <code id=the-element-pointers:the-head-element><a href=#the-head-element>head</a></code> element has been parsed (whether implicitly or explicitly) the
  <a href=#head-element-pointer id=the-element-pointers:head-element-pointer><code>head</code> element pointer</a> gets set to point to this node.</p>

  <p>The <a href=#form-element-pointer id=the-element-pointers:form-element-pointer><code>form</code> element pointer</a> points to the last
  <code id=the-element-pointers:the-form-element><a href=#the-form-element>form</a></code> element that was opened and whose end tag has not yet been seen. It is used to
  make form controls associate with forms in the face of dramatically bad markup, for historical
  reasons. It is ignored inside <code id=the-element-pointers:the-template-element><a href=#the-template-element>template</a></code> elements.</p>


  <h5 id=other-parsing-state-flags>12.2.3.5 Other parsing state flags<a href=#other-parsing-state-flags class=self-link></a></h5>

  <p>The <dfn id=scripting-flag>scripting flag</dfn> is set to "enabled" if <a href=#concept-n-script id=other-parsing-state-flags:concept-n-script>scripting
  was enabled</a> for the <code id=other-parsing-state-flags:document><a href=#document>Document</a></code> with which the parser is associated when the
  parser was created, and "disabled" otherwise.</p>

  <p class=note>The <a href=#scripting-flag id=other-parsing-state-flags:scripting-flag>scripting flag</a> can be enabled even when the parser was originally
  created for the <a href=#html-fragment-parsing-algorithm id=other-parsing-state-flags:html-fragment-parsing-algorithm>HTML fragment parsing algorithm</a>, even though <code id=other-parsing-state-flags:the-script-element><a href=#the-script-element>script</a></code>
  elements don't execute in that case.</p>

  <p>The <dfn id=frameset-ok-flag>frameset-ok flag</dfn> is set to "ok" when the parser is created. It is set to "not
  ok" after certain tokens are seen.</p>

  


  

  <h4 id=tokenization>12.2.4 <dfn>Tokenization</dfn><a href=#tokenization class=self-link></a></h4>

  <p>Implementations must act as if they used the following state machine to tokenize HTML. The
  state machine must start in the <a href=#data-state id=tokenization:data-state>data state</a>. Most states consume a single character,
  which may have various side-effects, and either switches the state machine to a new state to
  <a href=#reconsume id=tokenization:reconsume>reconsume</a> the <a href=#current-input-character id=tokenization:current-input-character>current input character</a>, or switches it to a new state to
  consume the <a href=#next-input-character id=tokenization:next-input-character>next character</a>, or stays in the same state
  to consume the next character. Some states have more complicated behavior and can consume several
  characters before switching to another state. In some cases, the tokenizer state is also changed
  by the tree construction stage.</p>

  <p>When a state says to <dfn id=reconsume>reconsume</dfn> a matched character in a specified state, that means
  to switch to that state, but when it attempts to consume the <a href=#next-input-character id=tokenization:next-input-character-2>next input character</a>,
  provide it with the <a href=#current-input-character id=tokenization:current-input-character-2>current input character</a> instead.</p>

  <p>The exact behavior of certain states depends on the <a href=#insertion-mode id=tokenization:insertion-mode>insertion mode</a> and the
  <a href=#stack-of-open-elements id=tokenization:stack-of-open-elements>stack of open elements</a>. Certain states also use a <dfn id=temporary-buffer><var>temporary buffer</var></dfn> to track progress, and the <a href=#character-reference-state id=tokenization:character-reference-state>character reference
  state</a> uses a <dfn id=return-state><var>return state</var></dfn> to return to the
  state it was invoked from.</p>

  <p>The output of the tokenization step is a series of zero or more of the following tokens:
  DOCTYPE, start tag, end tag, comment, character, end-of-file. DOCTYPE tokens have a name, a public
  identifier, a system identifier, and a <dfn id=force-quirks-flag><i>force-quirks flag</i></dfn>. When a DOCTYPE token
  is created, its name, public identifier, and system identifier must be marked as missing (which is
  a distinct state from the empty string), and the <i id=tokenization:force-quirks-flag><a href=#force-quirks-flag>force-quirks flag</a></i> must be set to
  <i>off</i> (its other state is <i>on</i>). Start and end tag tokens have a tag name, a <dfn id=self-closing-flag>self-closing flag</dfn>, and a list of attributes, each of which has a
  name and a value. When a start or end tag token is created, its <i id=tokenization:self-closing-flag><a href=#self-closing-flag>self-closing flag</a></i> must be unset (its other state is that it be set), and its attributes
  list must be empty. Comment and character tokens have data.</p>

  <p>When a token is emitted, it must immediately be handled by the <a href=#tree-construction id=tokenization:tree-construction>tree construction</a>
  stage. The tree construction stage can affect the state of the tokenization stage, and can insert
  additional characters into the stream. (For example, the <code id=tokenization:the-script-element><a href=#the-script-element>script</a></code> element can result in
  scripts executing and using the <a href=#dynamic-markup-insertion id=tokenization:dynamic-markup-insertion>dynamic markup insertion</a> APIs to insert characters
  into the stream being tokenized.)</p>

  <p class=note>Creating a token and emitting it are distinct actions. It is possible for a token
  to be created but implicitly abandoned (never emitted), e.g. if the file ends unexpectedly while
  processing the characters that are being parsed into a start tag token.</p>

  <p>When a start tag token is emitted with its <i id=tokenization:self-closing-flag-2><a href=#self-closing-flag>self-closing flag</a></i> set, if the flag is not
  <dfn id=acknowledge-self-closing-flag>acknowledged</dfn> when it is processed by the tree
  construction stage, that is a <a href=#parse-error id=tokenization:parse-error>parse error</a>.</p>

  <p>When an end tag token is emitted with attributes, that is a <a href=#parse-error id=tokenization:parse-error-2>parse error</a>.</p>

  <p>When an end tag token is emitted with its <i id=tokenization:self-closing-flag-3><a href=#self-closing-flag>self-closing flag</a></i> set, that is a <a href=#parse-error id=tokenization:parse-error-3>parse
  error</a>.</p>

  <p>An <dfn id=appropriate-end-tag-token>appropriate end tag token</dfn> is an end tag token whose tag name matches the tag name
  of the last start tag to have been emitted from this tokenizer, if any. If no start tag has been
  emitted from this tokenizer, then no end tag token is appropriate.</p>

  <p id=check-parser-pause-flag>Before each step of the tokenizer, the user agent must first check
  the <a href=#parser-pause-flag id=tokenization:parser-pause-flag>parser pause flag</a>. If it is true, then the tokenizer must abort the processing of
  any nested invocations of the tokenizer, yielding control back to the caller.</p>

  <p>The tokenizer state machine consists of the states defined in the following subsections.</p>


  


  <h5 id=data-state>12.2.4.1 <dfn>Data state</dfn><a href=#data-state class=self-link></a></h5>

  <p>Consume the <a href=#next-input-character id=data-state:next-input-character>next input character</a>:</p>
